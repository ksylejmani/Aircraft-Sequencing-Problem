define("dropbox",["modules/clean/undo","modules/clean/pagination_manager","modules/clean/react/modal","modules/clean/react/previews/preview_blank","modules/core/controller_registry","modules/clean/contacts/list","modules/clean/job_progress","modules/clean/search/search_helpers","modules/clean/browse_interface","modules/clean/notserver","modules/clean/gandalf_util","modules/clean/contacts/cache","modules/clean/multiaccount_login","modules/clean/previews/pdf_loader","modules/clean/top_notif","modules/clean/datetime","modules/constants/viewer","modules/core/i18n","modules/clean/uirequest","modules/clean/em_string","modules/clean/base64","modules/core/dom","modules/clean/web_timing_logger","modules/clean/video_util","modules/clean/react/previews/preview_flippable","modules/clean/account/email","modules/clean/dbmodal","modules/clean/teams/team_folder_modal","modules/clean/sharing/share_inband","modules/clean/db_bubble","modules/clean/payments/credit_card_util","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/previews/preview_image","modules/clean/react/activity/comment_count_bubble","modules/core/uri","modules/clean/page_role_observer","modules/core/cookies","modules/clean/react/previews/preview_image_zoom","modules/clean/dbmodal_loading","modules/clean/display_format","modules/clean/payments/cash","modules/clean/event_load","modules/clean/browse/browse_drag_utils","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/react/previews/preview_video","external/purify","modules/clean/account/email_verify_reasons","modules/clean/image_size","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/components/ajax_form","modules/clean/viewer","modules/core/ordered_dictionary","modules/clean/events/rollback","modules/clean/profile_services/profile_services_link","libs","modules/clean/frame_messenger","modules/constants/env","jquery","modules/constants/python","modules/core/exception","modules/clean/components/bubble_picker","modules/clean/history","external/underscore","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/analytics","modules/clean/ajax","modules/clean/react/previews/preview_linkfile","modules/clean/sso_login_checks","modules/clean/sprite","modules/clean/filepath","modules/core/notify","modules/clean/clipboard","modules/core/html","modules/clean/react/invite/invite_form_react","modules/clean/static_urls"],function(S,e6,ci,D,bR,l,w,ai,e4,cJ,at,eh,bI,aq,cn,bY,a4,be,bs,bO,ae,y,d9,bn,J,cO,cZ,dO,dG,aw,eT,R,ds,cT,cq,aZ,C,a1,bq,c9,cu,az,dJ,ag,cE,d5,ej,a2,cR,ek,ab,aR,cU,b9,cD,aU,al,c1,cd,em,e5,by,aQ,d3,bu,eu,br,bm,bV,a5,cv,bB,b0,cp,au,aa,p,e2,W,aF){var A={};var dE=ci.SimpleModal;var db=w.Job;var es=w.ModalProgress;var bJ=cJ.NotServer;var d0=cJ.NotClients;var cA=eh.ContactsCache;var bU=eh.DefaultContactsCache;var eU=cn.TopNotificationBar;var eF=cn.EUCookieNotificationBar;var n=cn.ExpiredIOSNotificationBar;var d7=cn.PackratUnlimitedOptInNotificationBar;var ca=cn.DfBAdminEarlyAccessSharingControlsBar;var b6=cn.DfBAdminEarlyAccessFtsBar;var aJ=cn.LocaleSwitchBar;var a6=be.ungettext;var er=be._;var dA=be.N_;var B=be.E_;var eV=be.render_sentences;var dW=J.PreviewFlippable;var an=cO.ChangeEmail;var dV=cO.EmailVerification;var dZ=cZ.DBModal;var dS=cZ.DBModalStack;var dc=cZ.DBUserModal;var t=cq.PreviewImage;var cY=aZ.CommentCountBubbleFactory;var aO=c9.PreviewImageZoom;var bc=dJ.Cash;var e0=dJ.CashUtil;var ec=a2.PreviewVideo;var aA=ab.image_best_fit_size;var dB=aR.HierarchicalNavBar;var e1=cU.DfBTransitionInfoFetcher;var bd=c1.LinkedProfileServices;var d2=c1.ProfileServicesLinkingHandler;var b2=d3.alertd;var cC=d3.assert;var eC=d3.reportException;var eD=d3.stackTrace;var O=bB.PreviewLinkfile;var ea,eR,c5;INLINE_JS.$=$;INLINE_JS.$u=br;Function.prototype.defer=Function.prototype.defer.wrap(function(e7){var T;T=$A(arguments).slice(1);this.__tb__=eD();return e7.apply(this,T)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(e7){var T,e8;T=$A(arguments).slice(1);try{return e7.apply(this,T)}catch(e9){e8=e9;return cC(0,e8.toString())}});ea=A.Jcached={cache:{},set:function(e7,e8,T){var e9;e9=ea.cache[e7];if(e9==null){e9=ea.cache[e7]={}}e9.value=e8;return e9.expires=T?new Date().getTime()+T:0},get:function(T){var e7;e7=ea.cache[T];if((e7==null)||new Date().getTime()>e7.expires){delete ea.cache[T];return false}return e7.value}};Function.prototype.cached=function(T){var e8,e7;e7=Math.random();e8=this;return function(){var e9;e9=ea.get(e7);if(e9!==false){return e9}e9=e8();ea.set(e7,e9,T);return e9}};Array.prototype.sort_by_key=function(e7,e8){var T;if(e8==null){e8=false}T=e8?-1:1;return this.sort(function(e9,fa){e9=e7(e9);fa=e7(fa);if(e9<fa){return T*-1}else{if(e9>fa){return T*1}else{return 0}}})};Array.prototype.contains=function(T){return this.indexOf(T)!==-1};Array.prototype.remove=function(e7,T){T=T||e7+1;return this.splice(e7,T-e7)};Array.prototype.removeItem=function(e7){var T;T=this.indexOf(e7);if(T>=0){return this.remove(T)}else{return false}};Array.prototype.dict_by=function(T){var e9,fa,e8,fb,e7;e8={};for(e9=fb=0,e7=this.length;fb<e7;e9=++fb){fa=this[e9];e8[this[e9][T]]=this[e9]}return e8};Array.prototype.unique=function(){var fa,e8,e9,e7,T;fa={};for(e9=0,e7=this.length;e9<e7;e9++){e8=this[e9];if(typeof e8!=="string"){return this}fa[e8]=0}T=[];for(e8 in fa){T.push(e8)}return T};String.prototype.widthSplit=function(e9){var T,e8,e7,fa;if(e9==null){e9=15}T=[];e8=this;fa=0;e7=e8.substring(fa,fa+e9);while(e7!==""){T.push(e7);fa+=e9;e7=e8.substring(fa,fa+e9)}return T};Object.extend(Effect.Transitions,{EaseIn:function(T){return Math.pow(T,2)},EaseOut:function(T){return Math.pow(T,0.5)}});(function(e8){var e7,T;e7=function(fd){var fa,fh,fg,fe,fi,fc,fb,ff,e9;if(fd){if(Object.isArray(fd)){fa=[];for(fc=0,ff=fd.length;fc<ff;fc++){fh=fd[fc];fa.push(e2.escape(fh).toHTML())}fd=new e2(fa.join(""))}else{if(fd.top||fd.bottom||fd.before||fd.after){fe=["top","bottom","before","after"];for(fb=0,e9=fe.length;fb<e9;fb++){fg=fe[fb];fi=fd[fg];if(fi){fd[fg]=arguments.callee(fi)}}}else{if(dX.isElm(fd)||fd.toElement||fd.toHTML){}else{fd=e2.escape(fd)}}}}return fd};return Element.addMethods({db_observe:function(fa,e9,fb){return fa.observe(e9,function(fc){return fb(fc,fa)})},smoothScrollIntoView:function(fc,fb){var fg,fa,e9,ff,fe,fd;if(fb==null){fb={}}fg={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};fb=Object.extend(fg,fb);e9=fc.viewportOffset(fc);fa=fc.getDimensions();fd=document.viewport.getDimensions();fe=fb.padding||0;if(e9.top>fe&&(e9.top+fa.height)<(fd.height-fe)){return}ff=e9.top<fe?-1*Math.floor(fd.height/4):-1*Math.floor(3*fd.height/4);fb.offset=fb.offset||ff;return new Effect.ScrollTo(fc,fb)},__sert:function(e9,fa){return Element.insert(e9,e7(fa))},__date:function(e9,fa){return Element.update(e9,e7(fa))},replace:T=function(e9,fa){return e8(e9,e7(fa))}})})(Element.replace);eR=function(T){if(T!=null?T.target:void 0){try{return document.activeElement=T.target===document?null:T.target}catch(e7){}}};c5=function(T){try{return document.activeElement=null}catch(e7){}};if(document.addEventListener){document.addEventListener("focus",eR,true);document.addEventListener("blur",c5,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(e7,T){var e8;if(T==null){T="0"}e8=this;while(e8.length<e7){e8=T+e8}return e8.toString()};String.prototype.reverse=function(){var e8,e7,T;T=this.split("");e7=T.reverse();e8=e7.join("");return e8};String.prototype.count=function(T){return(this.length-this.gsub(T,"").length)/T.length};String.prototype.repeat=function(T){return(new Array(T+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,fe,fc){var fi,fh,fm,e8,T,fj,ff,fd,e9,e7,fk,fl,fg,fb,fa;if(fc==null){fc={}}this.orig_req={url:fe,options:fc};this.start_time=bY.time();fc.method=fc.method||"post";fc.evalJS=false;fc.suppress_nonstandard_headers=true;fc.parameters=fc.parameters||{};fc.parameters.t=bq.read(Constants.JS_CSRF_COOKIE);fc.parameters.is_xhr=true;if(fc.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){fc.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){fc.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){fc.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){fc.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&fe.indexOf("/")===0){fc.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){fc.parameters.restrict=Ajax.DBRequest.restrict}fh=fc.cleanUp||(function(){});this.subject_user=fc.subject_user||fc.job_user;if(fc.job){this.job_id=dX.nonce();fc.parameters.job_id=this.job_id;d4.watch(this,fc.dont_hide_progress_on_complete)}if(!fc.no_watch){ak.watch(this,!!fc.job)}fj=fc.onFailure;ff=fc.onSuccess;T=fc.onComplete;e8=(function(fn){return function(fo){var fq,fp;if(fc.parameters.xhr_retry||!fc.allow_retries){return false}if((fp=fo.status)===0||fp===500||fp===502||fp===503){fn.orig_req.options.parameters.xhr_retry=true;fn.orig_req.options.onFailure=fj;fn.orig_req.options.onSuccess=ff;fq=new Ajax.DBRequest(fn.orig_req.url,fn.orig_req.options);return true}return false}})(this);fc.onFailure=function(fo){var fq,fn,fp;if(db.handled(fo.request.job_id)){return}if(e8(fo)){return}if(!fc.noAutonotify){if(!Constants.IS_PROD&&fo.status===500&&fo.getHeader("X-Debug-Url")){fe=fo.getHeader("X-Debug-Url");fq=er("There was a problem completing this request.")+(' <a href="'+fe+'" target="_blank">View debug</a>');aa.error(new e2(fq))}else{aa.error()}}fh(false);if(fj){fj(fo)}if(fo.status===403){fn=dX.session_storage_get("reload-timestamp");if(!fn||bY.time()-fn>30*1000){dX.session_storage_set("reload-timestamp",bY.time());location.reload(true)}}return cC(fc.noAutonotify||((fp=fo.status)===403||fp===404||fp===502),"Ajax "+fo.status+" on "+fo.request.url)};fc.onComplete=(function(fn){return function(fo){if(fo.responseText.length&&T){if(fo.responseText.indexOf("async_task_started:")!==0){return T(fo)}}}})(this);fc.onSuccess=(function(fn){return function(fo){var fA,fG,fy,fD,fw,fs,fz,fB,ft,fr,fC,fE,fv,fu,fp,fF,fx,fq;fu=bY.time()-fo.request.start_time;if(db.handled(fo.request.job_id)){return}if(!fo.responseText.length){if(!fc.job){if(e8(fo)){return}if(!fc.noAutonotify){if(!fo||fo.status!==0){aa.error()}}if(fj){fj(fo)}}}else{if(fo.responseText.indexOf("err:")===0){if(!fc.noAutonotify){fs=fo.responseText.substr(4);if(fc.html_in_error_msg){fs=new e2(fs)}aa.error(fs)}if(fj){fj(fo)}}else{if(fo.responseText.indexOf("async_task_started:")===0){fn.async_task_id=fo.responseText.split(":")[1];d4.watch(fn)}else{if(ff){if(fo.responseText.indexOf("ok:")===0){aa.success(fo.responseText.substr(3))}ff(fo)}}fv=fo.getHeader("X-Server-Response-Time")||"-1";if(fc.log_timing){d9.log_ajax_transition.defer(fu,void 0,void 0,void 0,fv,fe=a7.absolutize(fn.url))}fA=by("#cprofile");if(!fc.no_watch&&fA.length){ft=""+Constants.REQUEST_ID+"-"+(fo.getHeader("X-Dropbox-Request-Id"));fe=fo.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");fw="Ajax: "+fe+" ("+fv+"ms)";fz="/profile/cprofile?request_id="+ft;fB=fo.request.url;if(fB.indexOf(Constants.BLOCK_CLUSTER)!==-1){fz+="&block=1"}else{fx=Constants.BATCH_THUMB_ENDPOINTS;for(fp=0,fF=fx.length;fp<fF;fp++){fy=fx[fp];if(fB.indexOf(fy)!==-1){fz+="&block=1";break}}}fD=fz.replace("/cprofile?","/ioprofile?");fr=by('<a target="_new" />').attr("href",fz).text("CG ");fE=by('<a target="_new" />').attr("href",fD).text("IO ");fC=by('<div class="ajax">').text("Ajax: "+fe+" ("+fv+"ms)").prepend(fr,fE);fG=fA.find(".ajax");if(fG.length>=10){fG.last().remove()}fA.prepend(fC)}if(by("#gandalf_panel").length&&fo.request.url.substring(0,14)!=="/gandalf_panel"){if((fq=window.gandalf_panel)!=null){fq.add(fo.request.url,fo.getHeader("X-Dropbox-Request-Id"))}}}}return fh(true)}})(this);fc.onException=function(fo,fp){var fq,fn;if(window.console){throw fp}fq=("Error with AJAX callback for: "+fe+" :::: ")+fp.toString();fn=eD();fn.pop();return eC(fq,bV.get_href(),"",fn.join("\n"))};if(fc.job){fe+=(fe.indexOf("?")===-1?"?":"&")+"long_running=1"}if(fc.subject_user&&!((fg=fc.parameters)!=null?fg[Constants.UID_PARAM_NAME]:void 0)){fe=C.parse(fe).updateQuery(Constants.UID_PARAM_NAME,fc.subject_user).toString()}fi=$H({url:fe});if(fc.parameters){fi.update(fc.parameters);fb=fi.keys();for(e9=0,fk=fb.length;e9<fk;e9++){fm=fb[e9];fa=["passwd","password","oauth","ccn","host_id"];for(e7=0,fl=fa.length;e7<fl;e7++){fd=fa[e7];if(fm.indexOf(fd)!==-1){fi.unset(fm)}}}fi.unset("t")}fc.onSuccess.__tb_ajax_info__=fc.onFailure.__tb_ajax_info__=Object.toJSON(fi);return $super(fe,fc)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(dX.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cV=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=by;if(!Function.prototype.bind){Function.prototype.bind=function(T){var fa,e9,e7,e8;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}fa=Array.prototype.slice.call(arguments,1);e8=this;e7=function(){};e9=function(){return e8.apply((this instanceof e7&&T?this:T),fa.concat(Array.prototype.slice.call(arguments)))};e7.prototype=this.prototype;e9.prototype=new e7();return e9}}jQuery.fn.curry=function(){var T,e8,e7;e8=arguments[0],e7=arguments[1],T=3<=arguments.length?cV.call(arguments,2):[];if(e7==null){e7=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var e9;e9=1<=arguments.length?cV.call(arguments,0):[];return e8.apply(e7,cV.call(T).concat(cV.call(e9)))}};jQuery.fn.stripTags=function(T){if(typeof monkey_check==="function"){monkey_check()}return T.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return y.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(e7,T){if(typeof monkey_check==="function"){monkey_check()}y.clone_position(this,e7,T);return this};jQuery.format=function(e7,T){if(typeof monkey_check==="function"){monkey_check()}return e7.replace(/\{([^}]+)\}/g,function(e9,e8){if(e8 in T){return T[e8]}else{return e9}})};jQuery.cachedScript=function(e7,T){if(typeof monkey_check==="function"){monkey_check()}T=by.extend(T||{},{dataType:"script",cache:true,url:e7});return jQuery.ajax(T)};jQuery.browser=bV;jQuery.addSubjectParam=function(e8,T){var e7;if(typeof monkey_check==="function"){monkey_check()}if(e8.subject_user&&!((e7=e8.data)!=null?e7[Constants.UID_PARAM_NAME]:void 0)){return T[Constants.UID_PARAM_NAME]=String(e8.subject_user)}};jQuery.ajaxPrefilter(function(T,e9,e8){var e7;if(!e9.noDropboxDefaults){e7={t:bq.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(e9,e7);if(jQuery.ajaxSettings.restrict!=null){e7.restrict=jQuery.ajaxSettings.restrict}T.data=by.param(by.extend(e9.data,e7),true);return false}});jQuery.ajax.retryOnce=function(e9,T,e7){var e8;if(typeof monkey_check==="function"){monkey_check()}if(T!=="abort"&&((e8=e9.status)===0||e8===500||e8===502||e8===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var ey,da,dN,a7,dX,dq,dl=function(T,e7){return function(){return T.apply(e7,arguments)}};dX=INLINE_JS.Util=A.Util={scroll_to_thumb:function(T){var fa,e9,e8,e7;e9=T.cumulativeOffset().top;fa=T.getHeight();e7=y.scroll_offsets().top;e8=y.viewport_dimensions().height;if(e9<e7||e9+fa>e7+e8){return y.scroll_to(0,e9-e8/2)}},decode_sort_key:function(e8){var fa,e9,e7,T;T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];if(typeof fa==="string"){T.push(ae.decode(fa))}else{T.push(fa)}}return T},sort_by_rank_or_key:function(T,e7){if((T.sort_rank!=null)&&(e7.sort_rank!=null)){return T.sort_rank-e7.sort_rank}cC((T.sort_key!=null)&&(e7.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(T,e7)},sort_by_key:function(T,e7){return this._sort_by_key(T,e7)},_sort_by_key:function(e7,fc){var e9,T,e8,fb,fa;T=e7.sort_key;e8=fc.sort_key;for(e9=fb=0,fa=T.length;0<=fa?fb<fa:fb>fa;e9=0<=fa?++fb:--fb){if(e8[e9]==null){return 1}if(typeof T[e9]!==typeof e8[e9]){if(typeof T[e9]==="string"){return 1}else{return -1}}else{if(T[e9]!==e8[e9]){if(T[e9]>e8[e9]){return 1}else{return -1}}}}if(e8.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(T,fa,e8,e7){var fd,fb,fe,fc,e9;fc=$$(e8);e9=[];for(fb=0,fe=fc.length;fb<fe;fb++){fd=fc[fb];e9.push((function(ff){var fg;if(T!==ff){cp.src(ff.down("img"),"web","downtick-spacer");return ff.removeClassName("bolded")}else{ff.addClassName("bolded");if(ff.hasClassName("noarrow")){return}fg=fa?"arrow-up-gray":"arrow-down-gray";return cp.src(ff.down("img"),"web",fg)}})(fd))}return e9},add_sort_arrow_mouseover_j:function(T,fa,e8,e7){var fd,fb,fe,fc,e9;fc=by(e8);e9=[];for(fb=0,fe=fc.length;fb<fe;fb++){fd=fc[fb];e9.push((function(ff){var fg;if(T.attr("data-sort")!==by(ff).attr("data-sort")){cp.src(by(ff).find("img")[0],"web","downtick-spacer");return by(ff).removeClass("bolded")}else{by(ff).addClass("bolded");if(by(ff).hasClass("noarrow")){return}fg=fa?"arrow-up-gray":"arrow-down-gray";return cp.src(by(ff).find("img")[0],"web",fg)}})(fd))}return e9},one_line_fit:function(T){var e8,e7;e8=$$(T);if(e8.length<2){return}e7=(function(e9){return function(){var fi,ff,fe,fc,fh,fd,fa,fb,fg;fe=e8[0];fh=e8[e8.length-1];fc=fe.cumulativeOffset().top;fd=fh.cumulativeOffset().top;if(fc!==fd){fi=parseInt(fe.getStyle("font-size"),10);fa=fi-1;if(fa<8){return}for(fb=0,fg=e8.length;fb<fg;fb++){ff=e8[fb];ff.style.fontSize=fa+"px"}return e7()}}})(this);return e7()},nice_list:function(e7){var fb,fa,e9,T,e8;if(!e7){return""}else{if(e7.length===1){return e7[0]}else{if(e7.length===2){return er("%(x)s and %(y)s").format({x:e7[0],y:e7[1]})}}}e8=er("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cC(e8.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");fa=e8[0];e9=e8[1];T=e8[2];fb=e8[3];return[fa,e7.slice(0,-1).join(e9),T,e7[e7.length-1],fb].join("")},list_em_snippet:function(e7,T){var fb,e9,e8,fa,fd,fc;e8="";T-=new bO("...").length;for(e9=fd=0,fc=e7.length;0<=fc?fd<fc:fd>fc;e9=0<=fc?++fd:--fd){fa=e7[e9];if(e9!==0){fa=", "+fa}fb=new bO(fa).length;if(fb>T){break}T-=fb;e8+=fa}return{str:e8,snipped:e7.length-e9}},start_of_day:function(T){var e7;e7=new Date();e7.setTime(T.getTime());e7.setHours(0);e7.setMinutes(0);e7.setSeconds(0);e7.setMilliseconds(0);return e7},to_iso8601_date:function(e9,e7,e8){var T;if(e7==null){e7=false}if(e8==null){e8=false}if(e7){T=e9.getUTCFullYear().toString()+"-"+(e9.getUTCMonth()+1).toString().lpad(2)+"-"+e9.getUTCDate().toString().lpad(2);if(e8){T+=" "+e9.getUTCHours().toString().lpad(2)+":"+e9.getUTCMinutes().toString().lpad(2)+":"+e9.getUTCSeconds().toString().lpad(2)}}else{T=e9.getFullYear().toString()+"-"+(e9.getMonth()+1).toString().lpad(2)+"-"+e9.getDate().toString().lpad(2);if(e8){T+=" "+e9.getHours().toString().lpad(2)+":"+e9.getMinutes().toString().lpad(2)+":"+e9.getSeconds().toString().lpad(2)}}return T},to_mysql_date:function(fa,T,e8){var e7,fb,e9;e7=fa.getFullYear().toString()+"-"+(fa.getMonth()+1).toString().lpad(2)+"-"+fa.getDate().toString().lpad(2);e9=fa.getHours().toString().lpad(2)+":"+fa.getMinutes().toString().lpad(2)+":"+fa.getSeconds().toString().lpad(2);fb="."+fa.getMilliseconds().toString().lpad(3);if(!T){return e7}if(!e8){return e7+" "+e9}return e7+" "+e9+fb},from_mysql_date:function(e7){var e9,fb,e8,fd,T,fc,fa;fd=e7.split(" ");e9=fd[0];fc=fd.length>1?fd[1]:false;fb=e9.split("-");cC(fb.length===3,"weird date format on "+this+", expected yyyy-mm-dd");e8=new Date(fb[0],parseInt(fb[1],10)-1,fb[2]);if(fc){fa=fc.split(":");cC(fa.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");e8.setHours(fa[0]);e8.setMinutes(fa[1]);T=fa[2].split(".");e8.setSeconds(T[0]);if(T.length>1){e8.setMilliseconds(T[1])}}return e8},make_table:function(T,fd){var e8,fc,fe,e7,fa,e9,fb;fe=new Element("table",fd);e7=new Element("tbody");fe.__sert(e7);for(fc in T){fb=T[fc];e9=new Element("tr");fa=new Element("td").insert(fc);e8=new Element("td").insert(fb);e9.__sert(fa);e9.__sert(e8);e7.__sert(e9)}return fe},validate_email:function(T){var e7;e7=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return e7.test(T)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(e8){var e7,T;T=this.scried;e7=T[e8];if(!e7){e7=$(e8);T[e8]=e7}return e7},urlquote:function(T){return T.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var e7,T;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(e7=$("ieconsole"))!=null?e7.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(T=console.log)!=null?T.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(e8,e7){var T;T=this.childElementWithIndex(e8,e7);return T[0]},childElementWithIndex:function(fd,e8){var fa,fc,e9,e7,fb,T;fa=0;e7=fd.childNodes;for(e9=fb=0,T=e7.length;fb<T;e9=++fb){fc=e7[e9];if(fc.nodeType===1&&fa++===e8){return[fc,e9]}}return[false,false]},disableSelection:function(T){T.onselectstart=function(){return false};T.unselectable="on";T.style.MozUserSelect="none";return T.style.cursor="default"},enableSelection:function(T){T.onselectstart=function(){return true};T.unselectable="off";T.style.MozUserSelect="";return T.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(T,fd,fb,fa){var e8,e9,e7,fc;if(!fb){fb=function(fe,ff){return fe-ff}}e8=T.length;e9=0;while(e8>e9){e7=Math.floor(e8/2+e9/2);fc=fb(T[e7],fd);if(fc>0){e8=e7}else{if(fc<0){e9=e7+1}else{return e7}}}if(fa){return e9}else{return -1}},nonce:function(){var e8,T,e7;e8=new Date();e7=e8.getTime().toString();T=Math.floor(Math.random()*1000000).toString().lpad(6);return e7+T},focus:function(e7){if(e7){e7=$(e7);try{return e7.focus()}catch(T){}}},sumStyles:function(e9,fa){var T,e8,fb,e7;e8=0;if(e9){for(fb=0,e7=fa.length;fb<e7;fb++){T=fa[fb];e8+=parseInt(e9.getStyle(T),10)||0}}return e8},async_load_script:function(e7){var T;T=function(){var e9,e8;e8=document.createElement("script");e8.src=e7;e8.type="text/javascript";e8.async=true;e9=document.getElementsByTagName("script")[0];return e9.parentNode.insertBefore(e8,e9)};if(document.readyState==="complete"){return T()}else{if(window.attachEvent!=null){return window.attachEvent("onload",T)}else{return window.addEventListener("load",T,false)}}},smart_window_load:function(T){if(document.readyState==="complete"){return T.defer()}else{return Event.observe(window,"load",T)}},isNumber:function(T){return !isNaN(Number(T,10))},shorten_url:function(T,e7){return new Ajax.DBRequest("/shorten_url",{parameters:{url:T},onSuccess:function(e8){return e7(e8.responseText)}})},falsy_to_empty:function(T){return T||""},preloaded_images:{},preload_image:function(e9,e8,e7){var T;if(this.preloaded_images[e9]){return}T=new Image();if(e8!=null){Element.extend(T).observe("error",e8)}if(e7!=null){Element.extend(T).observe("load",e7)}T.src=e9;return this.preloaded_images[e9]=T},get_preloaded_image:function(T){if(this.preloaded_images[T]){return this.preloaded_images[T].clone()}else{return new Element("img",{src:T})}},clear_selected:function(){var T;if(window.getSelection){T=window.getSelection();if(T.removeAllRanges){return T.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(T){var e8,e7;e8=20;e7=y.viewport_dimensions();return T>e7.width-e8},freshbutton_overlay:function(e7,T){var e9,e8;e8=e7 instanceof jQuery&&e7||by(e7);e9=T instanceof jQuery&&T||by(T);e8.on("mouseover",(function(fa){return function(){return e9.addClass("hovered")}})(this));e8.on("mouseout",(function(fa){return function(){e9.removeClass("hovered");return e9.removeClass("pressed")}})(this));e8.on("mousedown",(function(fa){return function(){e9.removeClass("hovered");return e9.addClass("pressed")}})(this));return e8.on("mouseup",(function(fa){return function(){return e9.removeClass("pressed")}})(this))},isElm:function(T){if(typeof HTMLElement==="object"){return T instanceof HTMLElement}else{return T&&typeof T==="object"&&T.nodeType===1&&typeof T.nodeName==="string"}},_track_twitter_chars_left:function(e7,e8){var T;clearInterval(this.chars_left_interval);T=(function(e9){return function(){var fa,fb;fa=$("twitter-chars");fb=e8-$F(e7).strip().length;if(fb<0){fa.addClassName("too-long")}else{fa.removeClassName("too-long")}return fa.__date(fb)}})(this);return this.chars_left_interval=setInterval(T,250)},session_storage_set:function(T,e7){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(T,JSON.stringify(e7))},session_storage_get:function(T){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(T))}},pdf_plugins:function(){var e8,e7,T;T=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return e8=(function(){var fc,fa,fb,e9;fb=window.navigator.plugins;e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e7=fb[fc];if(T.test(e7.name)){e9.push(e7)}}return e9})()},get_window_location:function(){return window.location}};dX.scrollLeft=dX.scrollLeft.cached(50);dX.scrollTop=dX.scrollTop.cached(50);dN=A.UIButton=(function(){T.prototype.selector=function(){return".ui-button"};T.prototype.over=function(e7,e8){return e8.addClassName("over")};T.prototype.out=function(e7,e8){return e8.removeClassName("over")};T.prototype.down=function(e7,e8){return e8.addClassName("down")};T.prototype.up=function(e7){return $$(this.selector()+".down").invoke("removeClassName","down")};function T(){this.clear=dl(this.clear,this);this.up=dl(this.up,this);this.listen()}T.prototype.active=function(e8,e9){var e7;e7=by(e9);if(e7.hasClass("ui-button-dropdown")){if(e7.hasClass("active")){by(document).trigger("dropdownClosed",[1])}else{by(document).trigger("dropdownOpened",[1])}}return e7.toggleClass("active")};T.prototype.clear=function(fd){var e8,e7,fc,ff,fe,fb,e9,fg,fa;fe=$(fd.target);e7=this.selector()+".active";fb=fe.match(e7)&&fe||fe.up(e7);fc=0;fa=$$(e7);for(e9=0,fg=fa.length;e9<fg;e9++){ff=fa[e9];e8=by(ff);if(fb!==ff){if(e8.hasClass("active")&&e8.hasClass("ui-button-dropdown")){fc+=1}e8.removeClass("active")}}return by(document).trigger("dropdownClosed",[fc])};T.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return T})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var e8,fa,e7,e9,T;new dN();if(dX.ie8){e9=$$("#page-header a, #page-footer a");T=[];for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];if(e8.target==="_blank"){T.push(e8.target="")}else{T.push(void 0)}}return T}});da=__CONDITIONAL_JS__.Trace=A.Trace=(function(){var T;T=[];return{log:function(){var e7;e7=bY.time()+": "+$A(arguments).join(" ");return T.push(e7)},get:function(){return T.join("\n")}}})();ey=A.T=function(){return da.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var T;ey("dom:loaded");T=function(){var e9,e7,e8,fa;e8=$("page-content");if(e8){fa=y.viewport_dimensions();e7=$(document.body);e9="absolutize";if(fa.width<e8.getWidth()){return e7.addClassName(e9)}else{return e7.removeClassName(e9)}}};Event.observe(window,"resize",br.debounce(T,150));return T()});Event.observe(window,"load",function(){return ey("window:load")});a7=A.URLUtil={absolutize:function(T){if(T.startsWith("https://")||T.startsWith("http://")){return T}else{if(T.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+T}else{return cC(0,"absolutize is confused by "+T)}}}};dq=A.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var T,e7;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:y.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}e7=this.scroll_container!=null?this.scroll_container.scrollTop:y.scroll_offsets().top;T=Math.abs(this.max_delta_y)<Math.abs(e7-this.old_y);if(T){this.max_delta_y=e7-this.old_y;return this.old_y=e7}},start_capture:function(T){this.scroll_container=T;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(T){if(T==null){T=false}cC(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(T){return this.last_nonzero_velocity}return this.velocity}};var dj;dj=A.DomUtil={fromElm:function(T){return $(T).innerHTML},updateFromElm:function(e7,T){e7=$(e7);T=$(T);return e7.update(this.fromElm(T))},fillVal:function(fd,fa){var e7,fc,e9,fb,T,e8;fb=$$("."+fa);e8=[];for(fc=0,e9=fb.length;fc<e9;fc++){e7=fb[fc];e7=$(e7);if(e7.tagName==="INPUT"){e7.value=fd;e8.push(e7.defaultValue=fd)}else{if(e7.innerHTML===""&&((T=e7.tagName)==="A"||T==="B"||T==="INPUT"||T==="I"||T==="LABEL"||T==="SELECT"||T==="SPAN"||T==="TEXTAREA")){dX.log("Filling an empty value; this may look broken in IE7",e7)}e8.push(e7.innerHTML=fd)}}return e8},copy_to_clipboard:function(fe,fb,ff){var e9,e8,T,e7,fc,fa;e9=$("hold_clipboard");e9.value=fe;if(e9.createTextRange){fa=e9.createTextRange();if(fa&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return fa.execCommand("Copy")}catch(fd){fc=fd;ff=ff||er("Please copy the text below:");fb=fb||er("Copy text");this.fillVal(fe,"text-to-copy");this.fillVal(ff,"copy-modal-body");eY.show(fb,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){T=document.createElement("div");T.id="flashcb";document.body.appendChild(T)}$("flashcb").innerHTML="";e8=encodeURIComponent(e9.value);e7='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=e7}}};var ak;ak=A.RequestWatcher={reqs:[],working_msg:er("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(e7,e8){var T;T=this.reqs;if(!T.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(e8){e7.skip_message=true}return T.push([e7,bY.time()])},check_up:function(){return this.scan(false)},remove:function(T){return this.scan(T)},scan:function(fb){var ff,e7,e9,T,fd,fc,e8,fe,fa;e7=bY.time();e9=[];fa=this.reqs;for(e8=0,fe=fa.length;e8<fe;e8++){T=fa[e8];fd=T[0];fc=T[1];ff=e7-fc;if(fd.transport.readyState===4){this.clearWorkingMessage();continue}if(ff>4000&&!fd.skip_message){fd.skip_message=true;if(aa.isShown()&&aa.current()===!S.undo_notification){this.last_notification=aa.success(this.working_msg)}}if(ff>this.TIMEOUT*1000&&fd.job){fd.transport.abort()}if(fd!==fb){e9.push([fd,fc])}else{fd.transport.abort()}}this.reqs=e9;if(!e9.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(aa.isShown()&&aa.current()===this.last_notification){return aa.clear()}}};by(function(){var e8,e7,e9,T;e9=Prototype.Browser;T=[];for(e8 in e9){e7=e9[e8];if(e7===true){T.push(by(document.body).addClass(e8.toLowerCase()))}}return T});var dD,aX,cV=[].slice;dD=A.HTML5_HISTORY=Modernizr.history;by((function(T){return function(){return eu.init()}})(this));aX=A.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(T){return window.location.href=T},_replace_location:function(T){return window.location.replace(T)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(T,e7){this.callback_map[T]=e7;if(!this.watch_timer){return this.init()}},check_hash:function(){var e7,e8,e9,fb,fa,T;fb=this._get_location().split("#")[1];if(fb!=null){fb=fb.replace(/%27/g,"'")}if(this.last_hash===fb){return}this.last_hash=fb;if(this.last_prefix&&fb===""){fb=this.last_prefix+":"}else{if(!fb){return}}T=fb.split(":");fa=T.first();this.last_prefix=fa;e9=this.callback_map[fa];if(e9!=null){e8=(function(){var ff,fd,fe,fc;fe=T.slice(1);fc=[];for(ff=0,fd=fe.length;ff<fd;ff++){e7=fe[ff];fc.push(decodeURIComponent(e7))}return fc})();e9.apply(null,e8)}return $(document).fire("db:hash_change",{hash:fb})},_prepare_hash:function(e8){var e7,T;T=$A(e8).map(dX.falsy_to_empty);e7=T.map(encodeURIComponent);return e7.join(":")},set_hash:function(){var T,e7;T=1<=arguments.length?cV.call(arguments,0):[];e7=this._prepare_hash(T);return this._set_hash(e7)},replace_hash:function(){var T,e7;T=1<=arguments.length?cV.call(arguments,0):[];e7=this._prepare_hash(T);return this._set_hash(e7,true)},_set_hash:function(e7,T){if(e7===""){e7="/"}this.last_hash=e7;if(!T){return this._set_location("#"+e7)}else{return this._replace_location("#"+e7)}}};var dw;dw=A.SharingState=(function(){function T(){}T.set_role=function(e7){by(".shared-folder-role-param").val(e7);return this.role=e7};T.set_is_merged=function(e7){return this.is_merged=e7};T.set_team_name=function(e7){return this.team_name=e7};T.set_team_permissions=function(e8,e7){if(e8==null){e8=false}if(e7==null){e7=false}this.team_only=e8;return this.show_groups=e7};T.set_not_logged_in_role_and_email=function(e8,e7){this.not_logged_in_role=e8;return this.not_logged_in_email=e7};T.set_show_inbox=function(e7){return this.show_inbox=e7};return T})();var aS;aS=A.SharingUtil=(function(){function T(){}T.success_string_for_recipients=function(e7){var e8;if(e7.length===1){if(e7[0].indexOf("@")===-1){e8=er("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:e7[0]})}else{e8=er("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:e7[0]})}}else{if(e7.length===2){if(e7[0].indexOf("@")===-1){if(e7[1].indexOf("@")===-1){e8=er("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:e7[0],recipient_second:e7[1]})}else{e8=er("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:e7[0],recipient_second:e7[1]})}}else{if(e7[1].indexOf("@")===-1){e8=er("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:e7[0],recipient_second:e7[1]})}else{e8=er("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:e7[0],recipient_second:e7[1]})}}}else{if(e7[0].indexOf("@")===-1){e8=er("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:e7[0],num_others:e7.length-1})}else{e8=er("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:e7[0],num_others:e7.length-1})}}}return e8};return T})();var bf,cj;bf=A.SharingApi=(function(){T.REQUEST_SUCCEEDED_EVENT="db:sharing_api:request_succeeded";function T(e7){this.user=e7}T.prototype.invite_more_to_folder=function(e8,e7,fa,fc,e9,fb){var fd;fd={ns_id:e8,emails:e7.emails||[],fb_ids:e7.fb_ids||[],group_ids:e7.group_ids||[],new_style_group_ids:e7.new_style_group_ids||[],custom_message:fa||"",access_type:fc};return this._make_request("/share_ajax/invite_more",fd,e9,fb,true)};T.prototype.update_member_access_type=function(e7,fc,fa,e8,e9){var fb;fb={ns_id:e7,member_uid:fc,access_type:fa};return this._make_request("/share_ajax/update_member_access_type",fb,e8,e9)};T.prototype.update_team_folder_access_type=function(e8,e7,e9,fa){var fb;fb={ns_id:e8,can_edit:e7};return this._make_request("/team/admin/team_folder/update_access_type",fb,e9,fa,true,false)};T.prototype.update_invite_access_type=function(fb,e9,e7,e8){var fa;fa={invite_id:fb,access_type:e9};return this._make_request("/share_ajax/update_invite_access_type",fa,e7,e8)};T.prototype.share_folder=function(fg,fa,e9,ff,fe,e8,fh,e7,fc,fi,fb){var fd,fj;fd={emails:e9.emails||[],fb_ids:e9.fb_ids||[],group_ids:e9.group_ids||[],new_style_group_ids:e9.new_style_group_ids||[],custom_message:ff||"",audience:fe,inviter:e8,shared_link_policy:fh,access_type:e7,folder_settings:1};if(fg){fd.folder_name=fa;fj="/share_ajax/new"}else{fd.path=fa;fj=fc?"/share_ajax/existing_no_recipient":"/share_ajax/existing"}if(fe||e8){fd.custom_folder_settings=1}return this._make_request(fj,fd,fi,fb,true)};T.prototype.share_path=function(fi,e9,fe,fd,e8,ff,e7,fb,fg,fa){var fc,fh;fc={emails:e9.emails||[],fb_ids:e9.fb_ids||[],group_ids:e9.group_ids||[],new_style_group_ids:e9.new_style_group_ids||[],custom_message:fe||"",audience:fd,inviter:e8,shared_link_policy:ff,access_type:e7,folder_settings:1,path:fi};fh="/share_ajax/new_path";if(fd||e8){fc.custom_folder_settings=1}return this._make_request(fh,fc,fg,fa,true)};T.prototype.share_file=function(fb,ff,e9,fe,fd,e8,fg,e7,fh,fa){var fc,fi;fc={emails:e9.emails||[],fb_ids:e9.fb_ids||[],group_ids:e9.group_ids||[],new_style_group_ids:e9.new_style_group_ids||[],custom_message:fe||"",audience:fd,inviter:e8,shared_link_policy:fg,access_type:e7,folder_settings:1,path:fb,file_path:ff};fi="/share_ajax/share_file";if(fd||e8){fc.custom_folder_settings=1}return this._make_request(fi,fc,fh,fa,true)};T.prototype.unshare_folder=function(e8,e7,e9){var fa;fa={ns_id:e8,async:true};if(e7){fa.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",fa,e9)};T.prototype.leave_folder=function(e8,e7,e9){var fa;fa={ns_id:e8};if(e7){fa.keep_files=true}return this._make_request("/share_ajax/leave?long_running",fa,e9)};T.prototype.transfer_ownership=function(e7,e9,e8){var fa;fa={ns_id:e7,user_id:e9};return this._make_request("/share_ajax/change_sf_owner",fa,e8)};T.prototype.cancel_invite=function(e7,fa,e8){var e9;e9={ns_id:e7,invite_id:fa};return this._make_request("/share_ajax/cancel_invite",e9,e8)};T.prototype.kick=function(e8,fa,e7,e9){var fb;fb={ns_id:e8,user_id:fa};if(e7){fb.keep_files=true}return this._make_request("/share_ajax/kick_user",fb,e9)};T.prototype.kick_group=function(e7,e9,e8){return aa.error("This feature has been removed.")};T.prototype.reinvite_user=function(e7,fa,e8){var e9;e9={ns_id:e7,invite_id:fa};return this._make_request("/share_ajax/reinvite_user",e9,e8)};T.prototype.update_sf_permissions=function(e7,fa,e8,e9){var fb;fb={ns_id:e7,new_permissions:fa};return this._make_request("/share_ajax/change_sf_perm",fb,e8,e9)};T.prototype.update_sf_team_permissions=function(e7,fa,fb,e9,fd,e8){var fc;fc={ns_id:e7,audience:fa,inviter:fb,shared_link_policy:e9};if(!(fd===void 0)){fc.activity_feed_enabled=fd}return this._make_request("/share_ajax/save_folder_settings",fc,e8)};T.prototype.validate_new_sf_path=function(fa,e7,e8){var e9;e9={share_type:"new",folder_name:fa};return this._make_request("/share_ajax/validate_folder",e9,e7,e8,true)};T.prototype.validate_existing_sf_path=function(fa,e7,e8){var e9;e9={share_type:"existing",path:fa};return this._make_request("/share_ajax/validate_folder",e9,e7,e8,true)};T.prototype._make_request=function(e9,fd,e7,fa,fc,e8){var fb;if(fc==null){fc=false}if(e8==null){e8=true}if(e8){fd[Constants.UID_PARAM_NAME]=this.user.id}if((fb=this.loading_elem)!=null){fb.addClass("ajax-loading")}return new Ajax.DBRequest(e9,{parameters:fd,onSuccess:function(fe){if(typeof e7==="function"){e7(fe)}return by(document).trigger(T.REQUEST_SUCCEEDED_EVENT,{request_url:e9,ns_id:fd.ns_id||null})},onFailure:fa,onComplete:(function(fe){return function(){var ff;return(ff=fe.loading_elem)!=null?ff.removeClass("ajax-loading"):void 0}})(this),noAutonotify:fc})};return T})();cj=A.UserlessSharingApi=(function(){function T(){}T.prototype.get_inbox_counts=function(e7){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(e8){return function(fa){var e9;e9=JSON.parse(fa.responseText);cC(typeof e9==="object","bad inbox_count");return e7(e9)}})(this)})};T.prototype.get_folder_info=function(e7,e8){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:e7,onFailure:e8})};return T})();var o;o=INLINE_JS.SharingModals=A.SharingModals=(function(){function T(){}T.show_shared_folder_options_modal=function(fa,e7,e8,e9){if(e8==null){e8=true}if(e9==null){e9=true}return dS.push(new c7(e7,fa,e8,e9))};T.show_share_inband_modal=function(e9,e8,e7,fa){return ew.createAndShowInbandModal(e8,e9,true,e7,true,false,fa)};T.show_shared_folder_wizard=function(e7){return new ei(e7,{element_id:"share-a-folder-wizard-modal"}).show()};T.get_select_role_modal=function(){return new cy({element_id:"select-role-modal"})};T.start_wizard_without_user=function(){if(cD.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=T.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cD.get_viewer().get_users()[0])}};T.start_wizard_for_user=function(e7){if(dV.get_for_user(e7).verified_or_show(ek.SHARE_FOLDER)){return T.show_shared_folder_wizard(e7)}};T.show_share_existing_modal=function(e9,e7){var e8;if(dV.get_for_user(e7).verified_or_show()){e8=new ch(e7,{folder_name:e9,element_id:"invite-to-new-sf-wizard-modal-"+e7.id});return e8.show()}};T.show_shmodel_or_invite_modal=function(e8,fa,e7,e9){if(dV.get_for_user(e7).verified_or_show()){return new dQ(e7,{path:e8,existing_sf:fa,element_id:"create-link-or-invite-wizard-modal",target_item:e9}).show()}};T.show_unshare_team_sf_modal=function(e8,e7,fa){var e9;e9=new bX(e8,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:e7,folder_path:fa});return e9.show()};T.show_ignore_modal=function(e8,fb,e7){var fa,e9,fc;cC(e7,"Share ignore did not get an ns_id");fc=er("Permanently remove '%(folder_name)s'").format({folder_name:bO.em_snippet(au.filename(fb),15)});fa={path:fb,ns_id:e7};e9=new dc(e8,{element_id:"ignore-confirm",title:fc});e9.on_confirm_button_click=function(ff){var fe,fd,fg;ff.preventDefault();fe=by(ff.target);fd=fe.closest("form");fg=function(fh){aa.success(er("Removed shared folder successfully."));document.fire(aB.SF_IGNORE,{target_ns_id:e7,user_id:e8.id});return e9.hide()};return bN.ajax_submit(fd[0],false,fg,void 0,fe[0],fa)};return e9.show()};T.show_rejoin_modal=function(e8,fb,e7){var fa,e9,fc;cC(e7,"Rejoin didn't get an ns_id");fc=er("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bO.em_snippet(au.filename(fb),13)});fa={path:fb,ns_id:e7};e9=new dc(e8,{element_id:"rejoin-confirm",title:fc});e9.on_confirm_button_click=function(ff){var fe,fd,fg;ff.preventDefault();fe=by(ff.target);fd=fe.closest("form");fg=function(fj){var fh,fi;fi=fj.responseText;fh=au.filename(fi);aa.success(er("Rejoined shared folder successfully."));document.fire(aB.SF_REJOIN,{target_ns_id:e7,user_id:e8.id,filename:fh,mount_point:fi});return e9.hide()};return bN.ajax_submit(fd[0],false,fg,void 0,fe[0],fa)};return e9.show()};T.show_invites=function(){return dS.push(new cu({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};T.show_shared_subfolder_modal=function(e8,fa){var fd,fb,fc,e7,e9;fc=bO.em_snippet(au.filename(e8),14);fb=er("Can't share folder");e7="'%(parent_shared_folder)s' ".format({parent_shared_folder:fc});dj.fillVal(e7.escapeHTML(),"parent_shared_folder_name");fd=er("Share '%(parent_shared_folder)s' folder");e9=fd.format({parent_shared_folder:fc});($("share_parent_folder_button")).value=e9;eY.show(er("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");by("#share_parent_folder_button").on("click",(function(fe){return function(ff){eY.hide();return fe.show_shared_folder_options_modal(e8,fa)}})(this));return eY.show(fb,$("share_subfolder"))};return T})();var c6;c6=A.InviteFormController=(function(){function T(e9,e8,e7,fe,fd,fc){var fb,fa;this.user=e9;this.$form=e8;this.members=e7;this.invitees=fe;this.new_style_groups=fd;this.team_only=this.$form.data("team-only");fa={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){fb=Autocompleter.TeamTokenizer;fa.team_only=this.team_only}else{fb=Autocompleter.ContactsTokenizer;fa.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){fa.include_new_style_groups=true}this.sharing_options_auto_completer=new fb(this.user,fc+"-new-collab-input",fc+"-new-whobulk",fc+"-hidden-input",fa);cb._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new h(this.$form)}}T.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};T.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};T.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};T.prototype.reset_options=function(){return by(this.sharing_options_auto_completer.get_entry_container()).hide()};T.prototype.set_team_only=function(e7){this.team_only=e7;return this.sharing_options_auto_completer.setTeamOnly(e7)};T.prototype.extract_invitees=function(){var fa,e9,e8,fd,fc,e7,fb;fd={};fb=["emails","fb_ids","group_ids","new_style_group_ids"];for(fc=0,e7=fb.length;fc<e7;fc++){e9=fb[fc];e8=this.$form.find("input[name="+e9+"]");fd[e9]=[(function(){var fg,ff,fe;fe=[];for(fg=0,ff=e8.length;fg<ff;fg++){fa=e8[fg];fe.push(by(fa).val())}return fe})()]}return fd};T.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};T.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return T})();var aH,c7,N,ep,bp,eZ,cX,dr,aN,eH,dk,co,dI,bG,aC,bX,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9},dl=function(T,e7){return function(){return T.apply(e7,arguments)}};dI=A.SharedFolderBaseModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;T.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new bf(this.user)}T.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return T})(dZ);c7=A.ExistingSharedFolderOptionsModal=(function(e7){cG(T,e7);function T(e9,fb,fa,fc,e8){var fe,fd;this.user=e9;if(fa==null){fa=true}if(fc==null){fc=true}this.restore_modal=e8;this.__show_modal=dl(this.__show_modal,this);this.__x_click_handler=dl(this.__x_click_handler,this);cC(fb!=null,"Missing folder path");this.path=au.normalize(fb);fd=er("Shared folder options for '%(folder)s'");fd=fd.format({folder:bO.em_snippet(au.filename(fb),13)});fe={};fe[Constants.UID_PARAM_NAME]=this.user.id;fe.max_results=20;fe.show_invite_form=fa;fe.show_folder_settings=fc;dS.register(aH.MODAL_DONE_VIEWING_EVENT,(function(ff){return function(){return typeof ff.restore_modal==="function"?ff.restore_modal():void 0}})(this));T.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:fd,endpoint_url:C({path:"/share_options"+this.path}).toString(),parameters:fe})}T.prototype.__x_click_handler=function(e9){var e8;T.__super__.__x_click_handler.apply(this,arguments);e8={path:this.path};a5.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,e8);return typeof this.restore_modal==="function"?this.restore_modal():void 0};T.prototype.__show_modal=function(e9){var e8;T.__super__.__show_modal.apply(this,arguments);e8={path:this.path};return a5.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,e8)};return T})(cu);aH=A.ExistingSharedFolderOptionsContent=(function(){T.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";T.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function T(fb,e9,fa,e7,e8){this.$root=fb;this.options=e7;this.show_invite_form=e8;this.show_email_verification=dl(this.show_email_verification,this);this.show_golden_gate_warning=dl(this.show_golden_gate_warning,this);this.show_folder_settings=dl(this.show_folder_settings,this);this.toggle_from_invite_mode=dl(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=dl(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=dl(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=dl(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=dl(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=dl(this.show_unshare_folder_modal,this);this.show_uninvite_modal=dl(this.show_uninvite_modal,this);this.show_transfer_user_modal=dl(this.show_transfer_user_modal,this);this.show_kick_group_modal=dl(this.show_kick_group_modal,this);this.show_kick_user_modal=dl(this.show_kick_user_modal,this);this.update_tf_access=dl(this.update_tf_access,this);this.update_sf_perms=dl(this.update_sf_perms,this);this.reinvite_user=dl(this.reinvite_user,this);this.submit_invitations=dl(this.submit_invitations,this);this.maybe_load_more=dl(this.maybe_load_more,this);this.extract_user_data_and_call=dl(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=dl(this.extract_invitee_data_and_call,this);this._disable_token_for_sf=dl(this._disable_token_for_sf,this);this.user=cD.get_viewer().get_user_by_id(e9);this.path=au.normalize(fa);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(fc){y.controller(by(fc.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=100;this.maybe_load_more();this.sharing_api=new bf(this.user);this.sharing_api.loading_elem=this.$root;a8.register_all();cW.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();dS.trigger(T.CONTENT_LOADED_EVENT)}T.prototype.listen=function(){var fa,e9,e8,fc,e7,fb;this.$root.find(".confirm-button").click((function(fd){return function(fe){fe.preventDefault();return fd.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(fd){return function(fe){fe.preventDefault();return fd.toggle_from_invite_mode()}})(this));if(this.show_invite_form){fa=this.$root.find("#sharing-options-new-collab-input");fb=["focus","keypress","contextmenu"];for(fc=0,e7=fb.length;fc<e7;fc++){e8=fb[fc];fa.off(e8);fa.on(e8,this.toggle_to_invite_mode)}e9=this.$root.find("#custom-message-wizard");e9.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);this.$root.find(".golden-gate-upgrade-link").on("click",this.show_golden_gate_warning);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new c6(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(fd){return function(fe){fe.preventDefault();a5.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fd.user,fd.log_extras);return fd.show_leave_folder_modal()}})(this));this.$root.on("click","a.owner-leave-folder",(function(fd){return function(fe){fe.preventDefault();a5.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",fd.user,fd.log_extras);return fd.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(fd){return function(fe){return fd.extract_user_data_and_call(fe,fd.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(fd){return function(fg){var fe,ff,fh;fg.preventDefault();fe=by(fg.currentTarget);fh=fe.data("group-name");ff=fe.data("group-gid");return fd.show_kick_group_modal(fh,ff)}})(this));this.$root.on("click","a.make-owner",(function(fd){return function(fe){return fd.extract_user_data_and_call(fe,fd.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(fd){return function(ff){var fe,fg;ff.preventDefault();fe=by(ff.currentTarget);fg=fe.data("email");return window.location=C({scheme:"mailto",path:fg}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(fd){return function(fe){return fd.extract_invitee_data_and_call(fe,fd.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(fd){return function(fe){return fd.extract_invitee_data_and_call(fe,fd.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(fd){return function(fe){fe.preventDefault();a5.SharedFolderActivityLogger.log("web","invite_modal_leave_button",fd.user,fd.log_extras);return fd.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(fd){return function(fe){fe.preventDefault();a5.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",fd.user,fd.log_extras);return fd.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(fd){return function(fe){fe.preventDefault();return fd._disable_token_for_sf(function(){return dS.pop()})}})(this));this.$root.on("click","a.remove-link",(function(fd){return function(fe){var ff;fe.preventDefault();ff=function(){var fg;fg=dZ.get_containing_modal(fd.$root);if(fg&&fg instanceof cu){return fg.fetch()}};return fd._disable_token_for_sf(ff)}})(this));this.$root.on("click","input.sf-action-get-link",(function(fd){return function(fe){fe.preventDefault();return fd.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(fd){return function(fe){fe.preventDefault();a5.SharedFolderActivityLogger.log("web","invite_modal_done_button",fd.user,fd.log_extras);dS.trigger(T.MODAL_DONE_VIEWING_EVENT);return dS.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(fd){return function(ff){var fe;fe=by(ff.currentTarget);return fd.update_sf_perms(fe.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(fd){return function(ff){var fe;fe=by(ff.currentTarget);return fd.update_tf_access(!fe.prop("checked"))}})(this))};T.prototype._disable_token_for_sf=function(e7){return cv.WebRequest({url:C({path:"/sm/disable_token_at_path"+au.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(e8){return function(){by(document).trigger("db:browse:update");aa.success(er("Link removed"));a5.SimpleSharingLogger.log(e8.user.id,25);return typeof e7==="function"?e7():void 0}})(this),error:(function(e8){return function(){return aa.error(er("An error occurred when removing link"))}})(this)})};T.prototype.extract_invitee_data_and_call=function(fa,e9){var e7,fb,e8;fa.preventDefault();e7=by(fa.currentTarget);e8=e7.data("email-or-fbname");fb=e7.data("invite-id");return e9(e8,this.ns_id,fb)};T.prototype.extract_user_data_and_call=function(fc,fb){var e8,fa,e9,e7;fc.preventDefault();e8=by(fc.currentTarget);e9=e8.data("display-name");fa=e8.data("email");e7=e8.data("user-id");return fb(e9,fa,e7)};T.prototype.maybe_load_more=function(){var e8,e7,e9;e7=this.$root.closest("body").length;if(!e7){return}if((this.num_total==null)||(this.start>=this.num_total)){by("#more-members-spinner").hide();return}by("#more-members-spinner").show();e9={};e9[Constants.UID_PARAM_NAME]=this.user.id;e9.start=this.start;e9.max_results=this.max_results;e8=C({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new bs(this.$root,e8,{data:e9,success:(function(fa){return function(fe,fb,ff){var fc,fd;if(((fd=fe.data)!=null?fd.options:void 0)!=null){fc=fe.data.options;if((fa.members!=null)&&(fc.folder_members!=null)){Array.prototype.push.apply(fa.members,fc.folder_members)}if((fa.invitees!=null)&&(fc.folder_invitees!=null)){Array.prototype.push.apply(fa.invitees,fc.folder_invitees)}if((fa.new_style_groups!=null)&&(fc.new_style_groups!=null)){Array.prototype.push.apply(fa.new_style_groups,fc.new_style_groups)}}return fa.maybe_load_more()}})(this),error:(function(fa){return function(fd,fb,fc){return aa.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};T.prototype.submit_invitations=function(){var fa,e9,fc,e8,fb,e7;this.invite_form_controller.tokenize();fc=this.invite_form_controller.extract_invitees();fb=this.invite_form_controller.get_custom_message();fa=this.invite_form_controller.get_access_type();e8=br.clone(this.log_extras);e8.access_type=fa;a5.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,e8);e7=(function(fd){return function(ff){var fe;fe=dZ.get_containing_modal(fd.$root);if(fe&&fe instanceof cu){fe.fetch()}else{dS.pop()}aa.success(ff.responseText);return document.fire(aB.SF_INVITE,{target_ns_id:fd.ns_id,user_id:fd.user.id})}})(this);e9=(function(fd){return function(fe){return eA.show_validation_error(fe,fd.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,fc,fb,fa,e7,e9)};T.prototype.reinvite_user=function(e9,e7,e8){return this.sharing_api.reinvite_user(e7,e8,(function(fa){return function(fh){var fe,ff,fg,fd,fb,fc;fd=JSON.parse(fh.responseText);fb=fd.status;if(fb==="OK"){fc=er("%(email_or_fbname)s was reinvited successfully");fc=fc.format({email_or_fbname:e9});return aa.success(fc)}else{fg=fd.reason;if(fg==="ACCEPTED"){fe=er("That invitation has already been accepted.")}else{if(fg==="DECLINED"){fe=er("That invitation has already been declined.")}else{fe=er("You no longer have permission to perform this action.")}}aa.error(fe);if(fd.reload){ff=dZ.get_containing_modal(fa.$root);if(ff&&ff instanceof cu){return ff.fetch()}}}}})(this))};T.prototype.update_sf_perms=function(e8){var e9,fa,e7;this.$root.find("#change-sf-perm-saving").show();e9=(e8?1:0);e7=(function(fb){return function(fc){if(e8){aa.success(er("Editors can now manage membership of this folder."))}else{aa.success(er("Editors can no longer manage membership of this folder."))}return fb.$root.find("#change-sf-perm-saving").hide()}})(this);fa=(function(fb){return function(fc){if(fc.responseText.indexOf("err:")===0){aa.error(fc.responseText.substr(4))}else{aa.error(er("Error updating your preference! Please try again."))}return fb.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,e9,e7,fa)};T.prototype.update_tf_access=function(e8){var e9,e7;e7=(function(fa){return function(fb){if(e8){return aa.success(er("Team members can now change folder contents."))}else{return aa.success(er("Team members can no longer change folder contents."))}}})(this);e9=(function(fa){return function(fb){return aa.error(er("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,e8,e7,e9)};T.prototype.show_kick_user_modal=function(e9,e8,e7){return dS.push(new eH(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:e9,folder_path:this.path,user_id:e7}))};T.prototype.show_kick_group_modal=function(e7,e8){return dS.push(new aN(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:e7,folder_path:this.path,group_id:e8}))};T.prototype.show_transfer_user_modal=function(e9,e8,e7){return dS.push(new bG(this.user,{element_id:"transfer-confirm-modal",user_id:e7,user_name:e9,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_uninvite_modal=function(e9,e7,e8){return dS.push(new aC(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:e9,ns_id:e7,invite_id:e8,folder_path:this.path}))};T.prototype.show_unshare_folder_modal=function(){return dS.push(new bX(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_access_request_link_modal=function(){return dS.push(new c8(this.user.id,this.path,void 0,true))};T.prototype.show_owner_leave_folder_warning=function(){return aa.error(er("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};T.prototype.show_leave_folder_modal=function(){return dS.push(new dk(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.toggle_to_invite_mode=function(){var e7;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");return(e7=this.sf_access_type)!=null?e7.show():void 0};T.prototype.toggle_from_invite_mode=function(){var e8,e7;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((e8=this.sf_access_type)!=null){e8.hide()}return(e7=this.invite_form_controller)!=null?e7.reset_autocompleter():void 0};T.prototype.show_folder_settings=function(e7){a5.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);e7.preventDefault();dS.register(ep.SAVED_PERMISSIONS,(function(e8){return function(fa,e9){if(e9!=null){return e8.set_team_only(e9)}}})(this));return dS.push(new ep(this.user,this.path,this.ns_id))};T.prototype.show_golden_gate_warning=function(e7){e7.preventDefault();return dS.push(new cX(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};T.prototype.show_email_verification=function(e7){dS.pop();return dV.get_for_user(this.user).show()};T.prototype.set_team_only=function(e7){var e8;this.invite_form_controller.set_team_only(e7);e8=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(e7){return e8.addClass("team-only")}else{return e8.removeClass("team-only")}};return T})();dk=A.LeaveFolderModal=(function(T){cG(e7,T);function e7(){this.before_show=dl(this.before_show,this);this.on_show=dl(this.on_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_confirm_button_click=function(e9){var e8;e9.preventDefault();e8=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,e8,(function(fa){return function(){var fb;fb=er("You removed yourself from '%(msg)s'.").format({msg:bO.em_snippet(au.filename(fa.path),25)});aa.success(fb);document.fire(aB.SF_LEAVE,{target_ns_id:fa.ns_id,folder_deleted:!e8,user_id:fa.user.id});return dS.clear()}})(this))};e7.prototype.on_show=function(){e7.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};e7.prototype.before_show=function(){var e8;e8=er("Leave the shared folder '%(folder_name)s'");e8=e8.format({folder_name:bO.em_snippet(au.filename(this.path),14)});return this.format({".db-modal-title-text":e8})};return e7})(dI);bX=A.UnshareFolderModal=(function(e7){cG(T,e7);function T(){this.before_show=dl(this.before_show,this);this.on_show=dl(this.on_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);return T.__super__.constructor.apply(this,arguments)}T.prototype.on_confirm_button_click=function(e9){var e8;e9.preventDefault();e8=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,e8,(function(fa){return function(){var fb;fb=er("Unshared folder '%(folder_name)s'");fb=fb.format({folder_name:bO.em_snippet(au.filename(fa.path),25)});aa.success(fb);document.fire(aB.SF_UNSHARE,{target_ns_id:fa.ns_id,user_id:fa.user.id});return dS.clear()}})(this))};T.prototype.on_show=function(){T.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};T.prototype.before_show=function(){var e8;e8=er("Unshare '%(folder_name)s'");e8=e8.format({folder_name:bO.em_snippet(au.filename(this.path),21)});return this.format({".db-modal-title-text":e8})};return T})(dI);aC=A.UninviteModal=(function(e7){cG(T,e7);function T(e8,e9){this.before_show=dl(this.before_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.email_or_fbname=e9.email_or_fbname;this.ns_id=e9.ns_id;this.invite_id=e9.invite_id;T.__super__.constructor.call(this,e8,e9)}T.prototype.on_confirm_button_click=function(e8){e8.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(e9){return function(ff){var fd,fe,fc,fa,fb;fc=JSON.parse(ff.responseText);fa=fc.status;if(fa==="OK"){fb=er("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:e9.email_or_fbname});aa.success(fb)}else{fe=fc.reason;if(fe==="ACCEPTED"){fd=er("That invitation has already been accepted.")}else{if(fe==="DECLINED"){fd=er("That invitation has already been declined.")}}aa.error(fd)}return dS.pop()}})(this))};T.prototype.before_show=function(e8){var e9;e9=er("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bO.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":au.filename(this.path),".db-modal-title-text":e9})};return T})(dI);eH=A.KickUserModal=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;this.before_show=dl(this.before_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.user_id=e9.user_id;this.user_name=e9.user_name;e7.__super__.constructor.call(this,e8,e9)}e7.prototype.on_confirm_button_click=function(fa){var e8,e9;fa.preventDefault();e8=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,e8,(function(fb){return function(){aa.success(er("User removed successfully."));bT.reload_folder_info_if_two_account();return dS.pop()}})(this));e9={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:e8};return a5.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,e9)};e7.prototype.before_show=function(e8){var e9;e9=er("Remove %(person_name)s from this folder?");e9=e9.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":e9})};return e7})(dI);aN=A.KickGroupModal=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;this.before_show=dl(this.before_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.group_id=e9.group_id;this.group_name=e9.group_name;e7.__super__.constructor.call(this,e8,e9)}e7.prototype.on_confirm_button_click=function(e8){e8.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(e9){return function(){aa.success(er("Group removed successfully."));bT.reload_folder_info_if_two_account();return dS.pop()}})(this))};e7.prototype.before_show=function(){var e8;e8=er("Remove %(group_name)s from this folder?");e8=e8.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":e8})};return e7})(dI);co=A.MakeOwnerModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.before_show=dl(this.before_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.member_uid=e9.member_uid;this.member_name=e9.member_name;this.ns_id=e9.ns_id;this.access_type=e9.access_type;T.__super__.constructor.call(this,e8,e9)}T.prototype.on_confirm_button_click=function(e8){e8.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(e9){return function(){aa.success(er("%(name)s now is the owner.").format({name:e9.member_name}));return dS.pop()}})(this))};T.prototype.before_show=function(){var e8;e8=er("Make %(name)s the owner of this folder?");e8=e8.format({name:bO.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":e8})};return T})(dI);bG=A.TransferOwnershipModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.before_show=dl(this.before_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.user_id=e9.user_id;this.user_name=e9.user_name;T.__super__.constructor.call(this,e8,e9)}T.prototype.on_confirm_button_click=function(e8){e8.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(e9){return function(fa){aa.success(er("Ownership changed successfully"));return dS.pop()}})(this))};T.prototype.before_show=function(){var e8;e8=er("Make %(person_name)s the owner of this folder?");e8=e8.format({person_name:bO.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":e8})};return T})(dI);ep=A.ExistingSharedFolderPermissionsModal=(function(e7){cG(T,e7);T.SAVED_PERMISSIONS="existing_sf_permissions:saved";function T(e9,fa,e8,fd){var fc,fb;this.user=e9;this.path=fa;this.ns_id=e8;this.on_hide=fd;fc={ns_id:this.ns_id,folder_name:this.path};fc[Constants.UID_PARAM_NAME]=this.user.id;fb=er("'%(folder_name)s' settings");fb=fb.format({folder_name:bO.em_snippet(au.filename(this.path),13)});T.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:fb,endpoint_url:"/share_ajax/folder_settings",parameters:fc})}return T})(cu);cX=cX=(function(T){cG(e7,T);function e7(e9,e8){var fb,fa;this.user=e9;this.ns_id=e8;fb={ns_id:this.ns_id};fb[Constants.UID_PARAM_NAME]=this.user.id;fa=er("Confirm converting to Golden Gate folder");e7.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fa,endpoint_url:"/share_ajax/golden_gate_warning",parameters:fb})}return e7})(cu);dr=A.GoldenGateWarningModalContents=(function(){function T(e8,e9,e7){this.$form=e8;this.ns_id=e7;this._submit=dl(this._submit,this);this.user=cD.get_viewer().get_user_by_id(e9);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._submit=function(e7){return dS.push(new bp(this.user,this.ns_id,{element_id:"golden-gate-warning-modal",ns_id:this.ns_id}))};T.prototype._cancel=function(e7){return dS.pop()};return T})();bp=bp=(function(e7){cG(T,e7);function T(e9,e8){var fb,fa;this.user=e9;this.ns_id=e8;fb={ns_id:this.ns_id};fb[Constants.UID_PARAM_NAME]=this.user.id;fa=er("Confirm converting to Golden Gate folder");T.__super__.constructor.call(this,{element_id:"golden-gate-warning-modal",title:fa,endpoint_url:"/share_ajax/golden_gate_confirm",parameters:fb})}return T})(cu);eZ=A.GoldenGateConfirmModalContents=(function(e7){cG(T,e7);function T(e9,fa,e8){this.$form=e9;this.ns_id=e8;this._submit=dl(this._submit,this);this.user=cD.get_viewer().get_user_by_id(fa);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._submit=function(e8){return cv.WebRequest({url:"/share_ajax/enable_golden_gate",subject_user:this.user.id,type:"POST",data:{ns_id:this.ns_id,group_name:this.$form.find("#group_name").val()},success:function(){aa.success("Golden Gate enabled for this folder");return location.reload()},error:function(e9){return aa.error(er(e9.responseText.substring(4)))}})};T.prototype._cancel=function(e8){return dS.pop()};return T})(cu);N=A.ExistingSharedFolderPermissionsContent=(function(){function T(e8,e9,e7){this.$form=e8;this.ns_id=e7;this._submit=dl(this._submit,this);this.user=cD.get_viewer().get_user_by_id(e9);this.sharing_api=new bf(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dS.pop()};T.prototype._submit=function(fc){var fd,e7,fa,e9,e8,fb;fc.preventDefault();e7=this.$form.find("input[name=audience]:checked").val();fa=this.$form.find("input[name=inviter]:checked").val();e8=this.$form.find("input[name=shared_link_policy]:checked").val();fd=(fb=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?fb.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,e7,fa,e8,fd,(function(fe){return function(fg){var ff,fh;ff=JSON.parse(fg.responseText);fh=ff.team_only_invite;aa.success(ff.message);dS.trigger(ep.SAVED_PERMISSIONS,fh);return dS.pop()}})(this));false;e9={ns_id:this.ns_id,audience:e7,inviter:fa};return a5.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,e9)};return T})();var aV,dY,eK,dQ,aW,eA,ch,cs,ei,c2,b7,bM,cQ,cP,cN,cL,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9},dl=function(T,e7){return function(){return T.apply(e7,arguments)}};aV=A.BaseShareAFolderWizardModal=(function(T){cG(e7,T);e7.prototype.base_title=null;e7.prototype.personal_title=null;e7.prototype.work_title=null;function e7(e8,e9){this.user=e8;this.options=e9;e7.__super__.constructor.call(this,this.options);this.sharing_api=new bf(this.user)}e7.prototype.before_show=function(){var e8;this.sharing_api.loading_elem=this.$modal_window;e8=this.base_title;if(cD.get_viewer().is_paired){if(this.user.role==="personal"){e8=this.personal_title}else{e8=this.work_title.format({team_name:cD.get_viewer().team_name})}}return this.format({".db-modal-title-text":e8})};return e7})(dZ);ei=A.ShareAFolderWizardModal=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;e7.__super__.constructor.call(this,this.user,this.options);this.base_title=er("Share a folder");this.personal_title=er("Share a folder from your personal Dropbox");this.work_title=er("Share a folder from your %(team_name)s Dropbox")}e7.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(e8){return function(e9){e9.preventDefault();o.start_wizard_without_user();return e8.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(e8){return function(e9){by(e9.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(e8.$modal_window.find("input#create-new-sf").is(":checked")){return a5.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",e8.user)}else{return a5.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",e8.user)}}})(this))};e7.prototype.on_confirm_button_click=function(fe){var fb,fd,e8,fa,fc,e9;fe.preventDefault();fd=this.$modal_window.find("input#create-new-sf").is(":checked");if(fd){fa=null;if(this.user.role==="work"){fc="shared-folder-type-wizard-modal";e9=dZ.get_template(fc);if(e9.length){fa=new bM(this.user,{element_id:fc})}}if(fa===null){fa=new b7(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();e8={selection:"new_folder"};a5.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,e8);return fa.show()}fb=this.$modal_window.find(".ajax-loading-indicator").show();return by.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(ff){return function(fg){var fh;fg=JSON.parse(fg);if(fg===true){fa=new c2(ff.user,{element_id:"share-existing-folder-wizard-modal"});e8.has_existing_folder=true}else{fh=er("You don't have any existing folders. Please create and share a new folder.");fa=new b7(ff.user,{element_id:"share-new-folder-wizard-modal",error_msg:fh});e8.has_existing_folder=false}ff.hide();return fa.show()}})(this),error:(function(ff){return function(){return aa.error()}})(this),complete:(function(ff){return function(){return fb.hide()}})(this)},e8={selection:"existing_folder"},a5.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,e8))};return e7})(aV);bM=A.SharedFolderTypeWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;T.__super__.constructor.call(this,this.user,this.options);this.work_title=er("Share a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(e8){return function(e9){e9.preventDefault();o.start_wizard_for_user(e8.user);return e8.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(e8){return function(e9){by(e9.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(e8.$modal_window.find("input#team-folder-option").is(":checked")){return a5.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",e8.user)}else{return a5.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",e8.user)}}})(this))};T.prototype.on_confirm_button_click=function(fc){var e8,fa,fb,e9;fc.preventDefault();e8=(function(fd){return function(fg,fe){var ff;fg.preventDefault();fe.hide();ff=new fd.constructor(fd.user,fd.options);return ff.show()}})(this);fa=this.$modal_window.find("input#team-folder-option").is(":checked");if(fa){fb=new dO({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:e8});e9="team_folder"}else{fb=new b7(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:e8});e9="shared_folder"}a5.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:e9});this.hide();return fb.show()};return T})(aV);eA=A.InlineModalValidationError=(function(){function T(){}T.show_validation_error=function(fe,fa){var fb,fc,e9,e8,fd,e7;if(fe.responseText.indexOf("err:{")===0){e7=fe.responseText.substr(4);fd=JSON.parse(e7);for(fc in fd){fb=fd[fc];if("message_text" in fb){e8=fa.find("span.error-message");if(e8.length===0){e8=by("<span/>").addClass("error-message");fa.prepend(e8)}e8.text(fb.message_text);return}}fa.find("span.error-message").remove();return aa.error()}else{fa.find("span.error-message").remove();if(fe.responseText.indexOf("err:")===0){e9=fe.responseText.substr(4);return aa.error(e9)}else{return aa.error()}}};return T})();cQ=A.TeamSharedFolderWizardModalPage1=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;this.__fix_position=dl(this.__fix_position,this);e7.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=er("Now, let's set up your team");this.options.vertical_offset=5}e7.prototype.on_show=function(){var e9,fb,e8,fa;fa=this.$modal_window.find(".suggestion-input");for(fb=0,e8=fa.length;fb<e8;fb++){e9=fa[fb];cW.register($(e9))}this.$modal_window.find("#validate-team-name").submit((function(fc){return function(fd){fd.preventDefault();return fc.on_confirm_button_click(fd)}})(this));if(this.options.error_msg){aa.error(this.options.error_msg)}return a5.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};e7.prototype.on_confirm_button_click=function(fb){var e9,e8,fa;fb.preventDefault();fa=this.$modal_window.find("#new-team-shared-folder-name-input").val();e8=(function(fc){return function(){var fd;fd=new cP(fc.user,{team_name:fa,element_id:"team-shared-folder-wizard-modal-page2"});fc.hide();return fd.show()}})(this);e9=(function(fc){return function(fd){a5.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",fc.user);return eA.show_validation_error(fd,fc.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(fa,e8,e9)};e7.prototype.__fix_position=function(e9){var e8;e8=this.$modal_window.find(".db-modal");return e8.css({margin:"0",position:"fixed"})};return e7})(aV);cP=A.TeamSharedFolderWizardModalPage2=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;this.__fix_position=dl(this.__fix_position,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);e7.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=er("Invite teammates");this.folder_name=this.options.team_name}e7.prototype.before_show=function(){var e8;e8=er("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":e8})};e7.prototype.on_show=function(){a5.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(e8){return function(e9){e9.preventDefault();return e8.on_confirm_button_click(e9)}})(this))};e7.prototype.on_confirm_button_click=function(fc){var fa,e9,fe,e8,fd,fb;fc.preventDefault();fe={emails:[]};a5.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(e8=fb=1;fb<=10;e8=++fb){fa=this.$modal_window.find("#new-team-shared-folder-email"+e8).val();if(fa){fe.emails.push(fa)}}e9=dV.getForRole(cl.active_user.role);if(!e9.verified_or_show()){a5.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return e9.send_email("share_folder",(function(ff){return function(){var fg;fg=new cN(ff.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:ff.folder_name,invitees:fe,from_email_verification:true});ff.hide();return fg.show()}})(this))}else{a5.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);fd=new cN(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:fe,from_email_verification:true});this.hide();return fd.show()}};e7.prototype.__fix_position=function(e9){var e8;e8=this.$modal_window.find(".db-modal");e8.css;return{margin:"0",position:"fixed"}};return e7})(aV);cN=A.TeamSharedFolderWizardModalPage3=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.__fix_position=dl(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=er("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}T.prototype.on_show=function(){var fd,fb,fa,e9,ff,fe,fc,e8;a5.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(fg){return function(fh){fh.preventDefault();return fg.on_close_button_click(fh)}})(this));ff="";fe=true;fb=false;e9="all";fc=false;fd=null;e8=(function(fg){return function(fj){var fh,fi;fh=JSON.parse(fj.responseText);aa.success(fh.success_msg);fi=new cL(fg.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:fg.options.folder_name,invitees:fg.options.invitees,from_email_verification:true});fg.hide();return fi.show()}})(this);fa=(function(fg){return function(fh){return fg.hide()}})(this);return this.sharing_api.share_folder(fe,this.options.folder_name,this.options.invitees,ff,fb,e9,fc,fd,false,e8,fa)};T.prototype.on_confirm_button_click=function(e8){e8.preventDefault();return this.hide()};T.prototype.__fix_position=function(e9){var e8;e8=this.$modal_window.find(".db-modal");return e8.css({margin:"0",position:"fixed"})};return T})(aV);cL=A.TeamSharedFolderWizardModalPage4=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.__fix_position=dl(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=er("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}T.prototype.before_show=function(){var e8;e8=this.$modal_window.find("#back_to_home");e8.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};T.prototype.on_show=function(){return a5.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};T.prototype.__fix_position=function(e9){var e8;e8=this.$modal_window.find(".db-modal");return e8.css({margin:"0",position:"fixed"})};return T})(aV);b7=A.ShareNewFolderWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.options.focus="#new-shared-folder-wizard input[type=text]";T.__super__.constructor.call(this,this.user,this.options);this.base_title=er("Create a new shared folder");this.personal_title=er("Create a shared folder in your personal Dropbox");this.work_title=er("Create a shared folder in your %(team_name)s Dropbox")}T.prototype.on_show=function(){var e9,fb,e8,fa;fa=this.$modal_window.find(".suggestion-input");for(fb=0,e8=fa.length;fb<e8;fb++){e9=fa[fb];cW.register($(e9))}this.$modal_window.find("#validate-folder-name").submit((function(fc){return function(fd){fd.preventDefault();return fc.on_confirm_button_click(fd)}})(this));if(this.options.error_msg){aa.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(fc){return function(fd){if(fc.options.back_fn){return fc.options.back_fn(fd,fc)}else{fd.preventDefault();fc.hide();return o.start_wizard_for_user(fc.user)}}})(this))};T.prototype.on_confirm_button_click=function(fb){var fa,fc,e9,e8;fb.preventDefault();fc=this.$modal_window.find("#new-shared-folder-name-input").val();e9={folder_name:fc};a5.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,e9);by(document).trigger("db:share_new_folder:next");e8=(function(fd){return function(){var fe;fe=new ch(fd.user,{folder_name:fc,element_id:"invite-to-new-sf-wizard-modal-"+fd.user.id});fd.hide();fe.new_folder=true;fe.show();return a5.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",fd.user,e9)}})(this);fa=(function(fd){return function(fe){var ff;ff=b9.extract_errors(fe.responseText);a5.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",fd.user,e9);if(ff===false){}else{if(typeof ff==="string"){return aa.error(ff)}else{by("#new-shared-folder-name-input .error-message").remove();return b9.fill_errors(by("#validate-folder-name"),ff)}}}})(this);return this.sharing_api.validate_new_sf_path(fc,e8,fa)};return T})(aV);c2=A.ShareExistingFolderWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this._hide=dl(this._hide,this);this.on_show=dl(this.on_show,this);T.__super__.constructor.call(this,this.user,this.options);this.base_title=er("Choose folder to share");this.personal_title=er("Choose a folder from your personal Dropbox");this.work_title=er("Choose a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=by("#"+this.treeview_id).parent().attr("id");bW.schedule_reset();bW.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(e8){return function(){var e9;by(document).on("db:treeview_selected",function(fb,fa){return e8.folder_name=fa});e9=by(".first-treeview-link");if(!dX.ie){return e9.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(e8){return function(e9){e9.preventDefault();e8.hide();return o.start_wizard_for_user(e8.user)}})(this))};T.prototype._hide=function(){bW.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return T.__super__._hide.apply(this,arguments)};T.prototype.on_hide=function(){return by(document).off("db:treeview_selected")};T.prototype.on_confirm_button_click=function(fb){var fa,e9,e8;e9={folder_name:this.folder_name};fb.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();a5.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,e9);return o.show_shared_folder_options_modal(this.folder_name,this.user)}else{e8=(function(fc){return function(){var fd;fd=new ch(fc.user,{folder_name:fc.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+fc.user.id});fc.hide();a5.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",fc.user,e9);fd.new_folder=false;return fd.show()}})(this);fa=(function(fc){return function(fd){return eA.show_validation_error(fd,fc.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,e8,fa)}};return T})(aV);aW=A.CreateOrShareNewFolderWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this._extract_invitees=dl(this._extract_invitees,this);this._toggle_send_button_state=dl(this._toggle_send_button_state,this);T.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new bf(this.user);this.state="Create"}T.prototype.on_show=function(){var e9,fa,fc,fb,e8;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");fc="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();fa=fc+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+fa);e9={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,fa,fc+"-new-whobulk",fc+"-hidden-input",e9);if((fb=this.file_name_input)!=null){fb.keyup(this._toggle_send_button_state)}if((e8=this.collab_input)!=null){e8.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};T.prototype._toggle_send_button_state=function(){var fa,e9,e8,fb;e8=((fb=this.autocompleter)!=null?fb.token_manager.tokens.length:void 0)===0;e8=e8&&this.collab_input.val()==="";fa=this.file_name_input.val();e9=fa==="";this.$send_button.prop("disabled",e9);if(e8){this.$send_button.text(er("Create folder"));return this.state="Create"}else{this.$send_button.text(er("Share folder"));return this.state="Share"}};T.prototype._extract_invitees=function(){var fc,fa,fb,e9,ff,fe,e8,fd;fb=this.$modal_window.find(".tokenized_autocompleter_container");ff={};fd=["emails","fb_ids","group_ids","new_style_group_ids"];for(fe=0,e8=fd.length;fe<e8;fe++){fa=fd[fe];e9=fb.find("input[name="+fa+"]");ff[fa]=(function(){var fi,fh,fg;fg=[];for(fi=0,fh=e9.length;fi<fh;fi++){fc=e9[fi];fg.push(by(fc).val())}return fg})()}return ff};T.prototype.on_confirm_button_click=function(fj){var fa,fg,fd,fl,fe,fh,fb,fc,e8,ff,fi,fk,e9;fj.preventDefault();e8=this.file_name_input.val();fl=er("We can\u2019t create folder '%(folder_name)s'");fl=fl.format({folder_name:e8});fd=function(){return aa.error(fl)};if(this.state==="Create"){e9="/cmd/new"+dX.urlquote(this.destination_dir);ff={to_path:e8};ff[Constants.UID_PARAM_NAME]=this.user.id;fk=function(){var fm;fm=er("Created new folder '%(folder_name)s'");fm=fm.format({folder_name:e8});return aa.success(fm)};new cv.WebRequest({url:e9,data:ff,success:fk,error:fd})}else{this.autocompleter.tokenize_emails_input(true);fh=this._extract_invitees();fk=function(){var fm;fm=er("Shared new folder '%(folder_name)s'");fm=fm.format({folder_name:e8});return aa.success(fm)};fc="";fg=false;fb="all";fi=false;fa=null;fe=this.destination_dir+"/"+e8;this.sharing_api.share_path(fe,fh,fc,fg,fb,fi,fa,false,fk,fd)}return this.hide()};return T})(dZ);dQ=A.CreateLinkOrInviteToFolderWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;T.__super__.constructor.call(this,this.options);this.sharing_api=new bf(this.user)}T.prototype.before_show=function(){var e8;this.sharing_api.loading_elem=this.$modal_window;e8=er("Share '%(folder_name)s' with others");e8=e8.format({folder_name:bO.em_snippet(au.filename(this.options.path),16)});return this.format({".db-modal-title-text":e8})};T.prototype.on_show=function(){var e8,fa,e9;e8="edu_modal";fa=(e9=this.options.target_item)!=null?e9:null;a5.ShmodelUILogger.log("view",e8,fa);this.$modal_window.find(".option-to-share-folder").on("click",(function(fb){return function(fd){var fc;if(fb.options.existing_sf){a5.ShmodelUILogger.log("sf_options",e8,fa);fc=new c7(cl.active_user,fb.options.path)}else{a5.ShmodelUILogger.log("sf_invite",e8,fa);fc=new ch(fb.user,{folder_name:fb.options.path,element_id:"invite-to-new-sf-wizard-modal-"+fb.user.id})}fb.hide();return fc.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(fb){return function(fc){a5.ShmodelUILogger.log("token_share",e8,fa);dm.shmodel(fb.options.path,"create_link_or_invite_to_folder_modal");return fb.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(fb){return function(fc){fc.preventDefault();a5.ShmodelUILogger.log("clicked_learn_more",e8,fa);return window.open("/help/274","_blank")}})(this))};return T})(dZ);ch=A.InviteToNewSharedFolderWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;this.insert_folder_settings=dl(this.insert_folder_settings,this);this.share_folder=dl(this.share_folder,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.show_settings_modal=dl(this.show_settings_modal,this);this.options.focus=".new-collab-input";T.__super__.constructor.call(this,this.options);this.sharing_api=new bf(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false}T.prototype.before_show=function(){var e8;this.sharing_api.loading_elem=this.$modal_window;e8=er("Share '%(folder_name)s' with others");e8=e8.format({folder_name:bO.em_snippet(au.filename(this.folder_name),16)});return this.format({".db-modal-title-text":e8})};T.prototype.on_show=function(){var e9,fa,fd,fc,e8,fb;fb=this.$modal_window.find(".suggestion-input");for(fc=0,e8=fb.length;fc<e8;fc++){fa=fb[fc];cW.register($(fa))}e9=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){fd="invite-wizard-"+this.user.id;this.invite_form_controller=new c6(this.user,e9,[],[],[],fd);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();this.$modal_window.find(".change-new-folder-settings").on("click",(function(fe){return function(ff){ff.preventDefault();return fe.show_settings_modal()}})(this));this.log_extras={path:this.folder_name};a5.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return a5.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};T.prototype.show_settings_modal=function(){var e9,e8;e8=er("'%(folder_name)s' settings");e8=e8.format({folder_name:bO.em_snippet(au.filename(this.folder_name),13)});e9={folder_name:this.folder_name};if(this.audience_restriction){e9.audience=this.audience_restriction}if(this.inviter_restriction){e9.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){e9.shared_link_policy=this.shared_link_policy_restriction}e9[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){e9.is_file=this.is_file}dS.register(cs.SAVED_PERMISSIONS,(function(fa){return function(fc,fb){fa.insert_folder_settings(fb.audience,fb.inviter,fb.shared_link_policy);return fa.invite_form_controller.reset_options()}})(this));return dS.push(new cu({element_id:"folder-permissions-modal",title:e8,endpoint_url:"/share_ajax/default_folder_settings",parameters:e9}))};T.prototype.on_confirm_button_click=function(fb){var fa,e9,fd,e8,fc;fb.preventDefault();this.invite_form_controller.tokenize();fd=this.invite_form_controller.extract_invitees();fc=this.invite_form_controller.get_custom_message();fa=this.invite_form_controller.get_access_type();e8=this.$modal_window.find("input#allow_other_members_to_share");if(e8.length>0){this.inviter_restriction=e8.is(":checked")?"all":"me"}if(this.is_file){e9=new eK(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:fd,msg:fc,access_type:fa,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();e9.show();return a5.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(fd,fc,fa,true,false)}};T.prototype.share_folder=function(fd,fa,e8,fe,fc,e9){var fi,fb,ff,fh,fg;if(fe==null){fe=true}if(fc==null){fc=false}if(e9==null){e9=false}fb=(function(fj){return function(fk){return eA.show_validation_error(fk,fj.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fh=(function(fj){return function(fm){var fl,fk;fk=JSON.parse(fm.responseText);aa.success(fk.success_msg);if(fj.progress_ever_blocked_by_verify){a5.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fj.user,ff)}document.fire(aB.SF_NEW,{sf_info:bT.decode_sort_key(fk.sf_info)});if(fe){fj.hide()}if(e9){fl=new c7(fj.user,au.normalize(fj.folder_name));return fl.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;a5.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,ff);this.$modal_window.find(".confirm-button").prop("disabled",true);fg=er("Verification email sent to %(email)s").format({email:this.user.email});fi=dV.get_for_user(this.user);fi.send_email("share_folder",function(){return aa.success(fg)});by("#resend-email-verification-link").click(function(){return fi.send_email("share_folder",function(){return aa.success(fg)})});this.$modal_window.find(".email-verify-message").show();return fi.ensure_polling((function(fj){return function(){a5.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fj.user,ff);aa.success(er("Email verified. Try sharing your folder again."));fj.$modal_window.find(".confirm-button").prop("disabled",false);return fj.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,fd,fa,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,e8,fc,fh,fb);ff={path:this.folder_name,access_type:e8};a5.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,ff);return by(document).trigger("db:invite_to_new_folder:share")}};T.prototype.insert_folder_settings=function(e9,e8,fb){var fa;this.audience_restriction=e9;this.inviter_restriction=e8;this.shared_link_policy_restriction=fb;fa=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return fa.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return fa.removeClass("team-only")}};return T})(dZ);eK=A.ConfirmShareNewFileWizardModal=(function(T){cG(e7,T);function e7(e8,e9){this.user=e8;this.options=e9;e7.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=au.filename(this.file_path);this.folder_name=au.filename_without_extension(this.file_name);this.folder_path=au.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new bf(this.user);this.log_extras={path:this.file_path}}e7.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return a5.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};e7.prototype.on_confirm_button_click=function(fa){var e9,e8;e9=(function(fb){return function(fe){var fc,fd,ff;a5.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",fb.user,fb.log_extras);ff=b9.extract_errors(fe.responseText);if(ff===false){return}else{if(typeof ff==="string"){aa.error(ff)}else{if(typeof ff==="object"){for(fd in ff){fc=ff[fd];if("message_text" in fc){aa.error(fc.message_text);break}}}}}return fb.hide()}})(this);e8=(function(fb){return function(){var fc;a5.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",fb.user,fb.log_extras);fc=er("%(folder_name)s was shared successfully.").format({folder_name:fb.folder_name});aa.success(fc);return fb.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,e8,e9);return a5.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};e7.prototype.format_invitees=function(){var fd,fc,fa,e9,e8,fb;if(!this.invitees){return er("others")}fd=this.invitees.emails[0];fc=this.invitees.fb_ids[0];fa=this.invitees.group_ids[0];e9=this.invitees.new_style_group_ids[0];if(!fd.length){return er("others")}e8=fd[0];fb=fd.length+fc.length+fa.length+e9.length;if(fb>1){e8=e8+er(" and others")}return e8};return e7})(dZ);dY=A.ConfirmShareExistingFileWizardModal=(function(e7){cG(T,e7);function T(e8,e9){this.user=e8;this.options=e9;T.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}T.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return a5.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};T.prototype.on_confirm_button_click=function(e9){var e8;a5.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);e8=new c7(this.user,this.folder_path);this.hide();return e8.show()};return T})(dZ);cs=A.NewSharedFolderPermissionsContent=(function(){T.SAVED_PERMISSIONS="new_sf_permissions:saved";function T(e7){this.$form=e7;this._submit=dl(this._submit,this);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dS.pop()};T.prototype._submit=function(fa){var e8,e9,e7;fa.preventDefault();e8=this.$form.find("input[name=audience]:checked").val();e9=this.$form.find("input[name=inviter]:checked").val();e7=this.$form.find("input[name=shared_link_policy]:checked").val();dS.trigger(T.SAVED_PERMISSIONS,{audience:e8,inviter:e9,shared_link_policy:e7});return dS.pop()};return T})();var dm;dm=A.SharingShmodel=(function(){function T(){}T.shmodel=function(e8,e7){return new c8(cl.active_user.id,e8,e7).show()};return T})();var bT;bT=INLINE_JS.Sharing=A.Sharing={init:function(fd,e7,fc,e9,fb,fa,e8,T){this.is_merged=fc;this.simple_sharing_enabled=T;if(!e7){this._decode_sort_keys(fd)}this._state={sf_info:fd,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:e7,delay_reload_folder:false,pending_new_folders:[]};if(fc){this.role_picker=y.controller(by("#role-selector"));this.role_picker.on_state_change=this._render.bind(this);bI.set_during_login_callback((function(fe){return function(fg,ff){dw.set_not_logged_in_role_and_email(null,null);return fe._reload_folder_info(function(){return ff()},function(fh){ff(er("Error displaying shared folders"));return window.location.reload()})}})(this))}dw.set_is_merged(fc);dw.set_not_logged_in_role_and_email(e9,fb);dw.set_team_name(fa);dw.set_show_inbox(e8);this._listen();this._tmpl=e2.tmpl("sf_list_item_tmpl");if(!e7){this._render()}else{this._display_spinner();cv.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(fe){return function(ff){return fe._load_and_render_sf_list(ff)}})(this),error:(function(fe){return function(ff){return fe._sf_list_error()}})(this)})}this.refresh_inbox_counts(true);return this._display_view()},_load_and_render_sf_list:function(T){this._decode_sort_keys(T);this._state.sf_info=T;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return aa.error(er("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(T){return[T.current,T.past].each((function(e7){return function(e8){return e8.each(function(e9){return e7.decode_sort_key(e9)})}})(this))},decode_sort_key:function(T){cC((T.encoded_sort_key!=null)&&(T.sort_key==null),"expected encoded sort keys on each elm");T.sort_key=dX.decode_sort_key(T.encoded_sort_key);delete T.encoded_sort_key;return T},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(e8,T){var e7;if(!this.is_share_page()){return}e7=(function(e9){return function(fa){var fb;fb=JSON.parse(fa.responseText);e9._decode_sort_keys(fb);e9._state.sf_info=fb;e9._render();return typeof e8==="function"?e8():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cj().get_folder_info(e7,T)}},refresh_inbox_counts:function(T){return new cj().get_inbox_counts((function(e7){return function(e8){return e7._update_inbox_counts(e8,T)}})(this))},_update_inbox_counts:function(e7,fa){var fd,e8,T,fc,fb,e9;e9=0;for(fc in e7){fd=e7[fc];e9+=fd}by("#inbox-count").text(e9);by("#inbox-count").toggleClass("show",e9>0);if(!this.is_share_page()){return}e8=function(ff,fe){var fg;for(fc in ff){fg=ff[fc];if(fe[fc]!==ff[fc]){return false}}return true};if((!fa)&&this._state&&e8(this._state.inbox_counts,e7)){return}this._state.inbox_counts=e7;if(e9){T=new Element("a",{id:"new-invites-link",href:"#"});T.__sert(cp.make("web","email_32",{"class":"link-img"}));fb=a6("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",e9);fb+=" \n";fb=fb.format({total_count:e9});T.__sert(fb);T.observe("click",(function(fe){return function(ff){Event.stop(ff);return fe.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(T)}else{$("invites-box").hide()}if(e9>0&&dw.show_inbox){dw.set_show_inbox(false);return this.show_invites()}},register_accept:function(T){by(T).closest(".sf-invite-action").addClass("loading");new bs(by(T),T.action,{data:bN.collect_form_vars(T),complete:(function(e7){return function(e9,e8){by(T).closest(".sf-invite-action").removeClass("loading");e7.refresh_inbox_counts();return e7._reload_folder_info()}})(this),success:(function(e7){return function(fc,e8,fe){var e9,fb,fd,fa;fc=(fa=JSON.parse(fe.responseText))!=null?fa.data:void 0;e9=by(T).closest(".sf-invite-action");e9.addClass("sf-accepted");if(fc!=null?fc.redirect:void 0){if(e7._state&&e7._state.current_total_count>1){fb=e9.find(".view-folder-button");return fb.click(function(){return window.location.href=fc!=null?fc.redirect:void 0})}else{return window.location.href=fc!=null?fc.redirect:void 0}}else{fd=by(T).closest(".invitation-row").attr("data-invite-id");return e7._remove_invite_row(fd)}}})(this)});return false},register_decline:function(e7,e9,fa){var T,e8;T=by(e7).closest("form");if((e8=T.closest(".sf-invite-action"))!=null){e8.addClass("loading")}if(T.length){new bs(T,T[0].action,{data:bN.collect_form_vars(T[0]),complete:(function(fb){return function(fe,fd){var fc;if((fc=T.closest(".sf-invite-action"))!=null){fc.removeClass("loading")}fb._remove_invite_row(e9);fb.refresh_inbox_counts();fb._reload_folder_info();if(fa){return fa()}}})(this)})}return false},_remove_invite_row:function(fa){var T,e9,e8,e7;T=by("#invites-container");e9=T.find('[data-invite-id="'+fa+'"]');if(e9){e7=e9.parent("tbody");e9.remove();if(e7.children().length===0){T.find(".invitation-table-container").hide();T.find(".message-bottom").removeClass("message-bottom");T.find(".message-top").removeClass("message-top");if(T.find(".invites-message").length===0){e8=dZ.get_containing_modal(T);return e8!=null?e8.hide():void 0}}}},_listen:function(){var e8,e7,T;this.listen_modals();e8=(function(e9){return function(fb,fj,fe){var ff,fa,fi,fh,fg,fl,fc,fk,fd;fd=e9._get_current_sf_list_info(fe),fh=fd[0],fi=fd[1];cC(fj,"SF _transfer w/o target_ns_id");for(ff=fc=0,fk=fh.length;fc<fk;ff=++fc){fa=fh[ff];if(fa.target_ns_id===fj&&fa.user_id===fb){fg=fa;fl=ff;break}}cC(fl!=null,"SF _transfer w/o js obj");return[fg,fl]}})(this);T=(function(e9){return function(ff,fk,fh){var fi,fg,fl,fj,fe,fb,fd,fc,fa;fd=e9._get_current_sf_list_info(fk),fi=fd[0],fb=fd[1];fc=e9._get_current_sf_list_info(fh),fj=fc[0],fe=fc[1];fa=e8(ff.memo.user_id,ff.memo.target_ns_id,fk),fg=fa[0],fl=fa[1];fi.splice(fl,1);e9._empty_check(fk);if(ff.memo.filename!=null){fg.filename=ff.memo.filename}if(ff.memo.mount_point!=null){fg.mount_point=ff.memo.mount_point}fj.push(fg);return e9._render()}})(this);e7=(function(e9){return function(ff,fc){var fh,fe,fg,fb,fd,fa;fd=e9._get_current_sf_list_info(fc),fh=fd[0],fb=fd[1];fa=e8(ff.memo.user_id,ff.memo.target_ns_id,fc),fe=fa[0],fg=fa[1];fh.splice(fg,1);return e9._render()}})(this);document.observe(aB.SF_UNSHARE,(function(e9){return function(fa){return e7(fa,"#sf-current")}})(this));document.observe(aB.SF_LEAVE,(function(e9){return function(fa){return T(fa,"#sf-current","#sf-past")}})(this));document.observe(aB.SF_REJOIN,(function(e9){return function(fa){return T(fa,"#sf-past","#sf-current")}})(this));document.observe(aB.SF_IGNORE,(function(e9){return function(fa){return e7(fa,"#sf-past")}})(this));document.observe(aB.SF_NEW,(function(e9){return function(fb){var fa;fa=fb.memo.sf_info;cC(fa,"SF_NEW without info");if(e9._state.sf_loading){return e9._state.pending_new_folders.push(fa)}else{e9._state.sf_info.current.push(fa);return e9._render()}}})(this));$("create-share").observe("click",(function(e9){return function(fa){a5.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(fa);return o.start_wizard_without_user()}}})(this));by("#learn-more-link").click((function(e9){return function(fa){return a5.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(e9){return function(fa){Event.stop(fa);return e9.show_invites()}})(this))}by("#sf-current, #sf-past").each((function(e9){return function(fa,fb){var fc;fc=["#sf-current","#sf-past"][fa];by(".sf-list",fb).on("click","a.options-link",function(fe){var fi,fg,fk,ff,fl,fj,fh,fd;fe.preventDefault();fi=by(fe.target).closest("a.options-link");ff=fi.attr("data-type");fk=fi.attr("data-mount");fh=parseInt(fi.attr("data-nsid"),10);fd=cD.get_viewer().get_user_by_id(fi.attr("data-user_id"));fj=by(fe.target).closest("li.sf-folder").data("role");fl=fi.attr("data-sf-perm-role");if(fj!=null){dw.set_role(fj)}if(ff==="normal"){if(e9.simple_sharing_enabled){if(dV.get_for_user(fd).verified_or_show()){ew.createAndShowInbandModal(fd,fk,true,fh,true,false,fl)}}else{o.show_shared_folder_options_modal(fk,fd)}}else{if(ff==="remove"){o.show_ignore_modal(fd,fk,fh)}else{if(ff==="rejoin"){o.show_rejoin_modal(fd,fk,fh)}}}fg={option_type:ff};if(fh){fg.ns_id=fh}if(fk){fg.path=fk}return a5.SharedFolderActivityLogger.log("web","sharing_view_share_existing",fd.id,fg,true)});by(".sf-sort",fb).on("click","a.sort-option",function(ff){var fe,fd,fg;ff.preventDefault();fe=by(ff.target).closest("a.sort-option");fg={SF_BY_NAME:e9._name_cmp,SF_BY_MODIFIED:e9._modified_cmp};fd=fg[fe.attr("data-sort")];if(e9._state.cmp[fc]===fd){e9._state.is_ascending[fc]=!e9._state.is_ascending[fc]}else{e9._state.cmp[fc]=fd;e9._state.is_ascending[fc]=true}dX.add_sort_arrow_mouseover_j(fe,e9._state.is_ascending[fc],fc+" .sf-sort a.sort-option",true);return e9._render_list_id(fc)});return dX.add_sort_arrow_mouseover_j(by(".modified-sorter",fb),e9._state.is_ascending[fc],fc+" .sf-sort a.sort-option",false)}})(this));return by(".empty-share-button").click((function(e9){return function(fa){fa.preventDefault();a5.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return o.start_wizard_without_user()}})(this))},listen_modals:function(){return by("#new-or-existing-sf li").click((function(T){return function(e8){var e7;by("#new-or-existing-sf li").removeClass("active");e7=by(e8.target).closest("li");e7.find("input").prop("checked",true);return e7.addClass("active")}})(this))},_showing_two_accounts:function(){var T;return this.is_merged&&((T=this.role_picker)!=null?T.get_state():void 0)===dT.ALL},_render:function(){cC(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(by("#sf-current").hasClass("empty-list")&&by("#sf-past").hasClass("empty-list")){by("#page-content").addClass("no-shares");return by("#empty-content").show()}else{by("#page-content").removeClass("no-shares");return by("#empty-content").hide()}},_render_list_id:function(e8){var ff,fc,fd,fa,fb,e9,fe,T,fg,e7;e7=this._get_current_sf_list_info(e8),fa=e7[0],fd=e7[1];fe=this._showing_two_accounts();ff=(function(fh){return function(fi,fk){var fj;fj=fh._state.is_ascending[e8]?1:-1;return fj*fh._state.cmp[e8](fi,fk,fe)}})(this);fa.sort(ff);fb=by(".sf-list",e8);fb.empty();for(T=0,fg=fa.length;T<fg;T++){e9=fa[T];if(this._should_render(e9)){fc=this._tmpl({options_str:er("Options"),remove_str:er("Remove"),rejoin_str:er("Rejoin"),is_past:fd,sf:e9,Sprite:cp,Emstring:bO,Util:dX,_:er});fb.append(fc.toHTML())}}return this._empty_check(e8)},_should_render:function(T){if(this.role_picker!=null){return this.role_picker.is_role_visible(T.role)}else{return true}},_empty_check:function(e9){var e8,T,e7;e7=this._get_current_sf_list_info(e9),e8=e7[0],T=e7[1];if(by(".sf-list",e9).children().length){return by(e9).removeClass("empty-list")}else{return by(e9).addClass("empty-list")}},_get_current_sf_list_info:function(T){switch(T){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cC(false,"invalid sf list id")}},_name_cmp:function(e7,e8,T){if(T){return dX.sort_by_key(e7,e8)}else{return dX.sort_by_rank_or_key(e7,e8)}},_modified_cmp:function(e7,e8,T){return e7.modified_ts-e8.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var e8,T,e7;this._state.current_total_count=0;e7=this._state.inbox_counts;for(T in e7){e8=e7[T];this._state.current_total_count+=e8}if(this._state.current_total_count>0){return o.show_invites()}},_display_view:(function(T){return function(){return by("#sf-view").show()}})(this),_hide_view:(function(T){return function(){return by("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return by(".sf-spinner").show()},_hide_spinner:function(){return by(".sf-spinner").hide()}};var bl;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(fa,fb,e9,fg){var ff,e8,fd,fe,T,e7,fc;this.user=fa;this.baseInitialize(fb,e9,fg);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;e8=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}fc=this.options.include_team===true;fd=this.options.include_groups===true;T=this.options.include_new_style_groups===true;fe=this.options.include_me===true;e7=this.options.include_rooms===true;this.profile_services=bd.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new d2();this._autocompleter_profile_services_item_tmpl=e2.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;ff=(function(fh){return function(fi){if(fh.options.include_from_linked_accounts&&fh.options.viewer){fi=fi.includeForViewer(fh.options.viewer)}else{fi=fi.includeForUser(fh.user.id)}if(fh.options.contact_filter){fi=fh.options.contact_filter(fi)}else{if(!e8){fi=fi.excludeFacebook()}if(!fd){fi=fi.excludeGroups()}if(!T){fi=fi.excludeNewStyleGroups()}if(!fc){fi=fi.excludeTeamMembers()}if(!fe){fi=fi.excludeMe()}if(!e7){fi=fi.excludeRooms()}}return fh.setContacts(fi)}})(this);(function(){var fh;return bU.load_contacts(fh=false,e7=e7,(function(fi){ff(fi);return bU.register_for_updates("autocompleter_contacts",ff)}))}).defer();return this.options.onShow=function(fh,fi){if(!fi.style.position||fi.style.position==="absolute"){fi.style.position="absolute";by(fi).clonePosition(by(fh),{setHeight:false,setTop:false,setLeft:false})}return by(fi).fadeTo(150,1)}},link_callback:function(T){return d2.show_import_notifications(T)},getToken:function(){var T;T=this.getTokenBounds();return this.element.value.substring(T[0],T[1])},listen:function(){var T;this.install_profile_services_link_listener();T=(function(e7){return function(e8){if(e7.profile_services.has_connected_services()){return}if(by(e7.element).val()){return}e7.activate();setTimeout(function(){var e9;return(e9=e7.get_entry_container())!=null?e9.show():void 0},300);return true}})(this);return by(this.element).click(T)},install_profile_services_link_listener:function(){var T;Event.stopObserving(this.element,"blur");T=(function(e7){return function(e8){var e9;if(!by(e8.target).closest("li").hasClass("profile-services-link-handler")){return(e9=e7.get_entry_container())!=null?e9.hide():void 0}}})(this);by(this.element).closest(".db-modal-box").click(T);return by(this.element).closest("#modal-box").click(T)},get_entry_container:function(){var T;return(T=this.element.up(".tokenized_autocompleter_container"))!=null?T.down(".autocomplete"):void 0},profile_services_show:function(){var e8,e7,T,e9;e8=this.get_entry_container();if(((e7=e8.firstChild)!=null?(T=e7.firstChild)!=null?T.value:void 0:void 0)>0){this.old_display=e8.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((e9=$("flash_copy_container"))!=null){e9.hide()}return this.element.focus()},profile_services_render_buttons:function(){var T;T=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(T.join(""))+"</ul>")},get_profile_services_button_list:function(){var e7,fb,e8,fa,T,e9;e8=[];e9=cT.contact_services();for(fa=0,T=e9.length;fa<T;fa++){fb=e9[fa];cC(this.profile_services.is_updated,"profile_services has not been updated");e7="";if(this.profile_services.service_is_connected(fb)){e7=er("Connected")}else{if(this.profile_services.service_was_connected(fb)){e7=er("Reconnect")}}e8.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:fb,email_provider_img:cT.to_img(fb),email_provider_name:cT.to_name(fb),bottom_text:e7}).toHTML())}return e8},update_import_contacts_link:(function(T){return function(e7){T.profile_services=e7;if(T.profile_services.has_unconnected_services(true)){return by(T.element).closest("form").find(".import-contacts-link").show()}else{return by(T.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=by(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=by("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(T){this.options.array=T.contacts;this.options.larray=T.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var e8,e7,T;e7=this.getCurrentEntry();e8=this.options.array[e7.value];if(e8.type===R.FB||e8.type===R.NEW_STYLE_GROUP){e7.innerHTML=e8.name}else{e7.innerHTML=e8.email}if(this.options.tokens.length>1){T=this.options.tokens[0]+" "}else{T=""}e7.innerHTML+=T;this.active=false;this.updateElement(e7);return by(this.element).trigger("db:autocompleted")}},bl=function(T,e7){var e8;e8=by("<div>");e8.addClass(T);if(typeof e7==="string"||e7 instanceof String){e8.text(e7)}else{e8.append(e7)}return e8},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(e7){var T;if(e7==null){e7={}}T={choices:5,selector:(function(e8){return function(){var fc,ft,fs,fl,fn,fF,fe,fW,fX,fh,fD,fS,fx,fp,fm,fE,fC,fk,fO,fd,fB,fV,fy,fH,fz,fG,fM,e9,fL,fT,fj,fq,fA,fa,fJ,fu,fw,fK,fb,fr,fU,fv,fR,fQ,fP,fN,fo,fi,fg,ff,fI;fu=[];fD=e8.getToken().toLowerCase();fO=e8.options.array.length;fn=e8.options.array;fH=e8.options.larray;fJ=[];if(fD.indexOf(" ")===-1){fJ.push("\\s+")}if(fD.indexOf("+")===-1){fJ.push("\\+")}if(fD.indexOf("@")===-1){fJ.push("@")}if(fD.indexOf(".")===-1){fJ.push("\\.")}if(fD.indexOf("&lt;")===-1){fJ.push("&lt;")}fa=RegExp("("+fJ.join("|")+")");fE=0;while(fD.length>0&&fE<fO){fl=fn[fE];fy=fH[fE];fS=-1;fh=[];fG=[];fm="";switch(fl.type){case R.EMAIL:fh.push(fl.name,fl.email_snippet);fG.push(fy.name,fy.email);fm="/static/images/icons/mail28-vflHfHPJ0.png";break;case R.FB:fh.push(fl.name);fG.push(fy.name);if(bT.use_fb_profile_pics){fm="https://graph.facebook.com/"+fy.fb_id+"/picture"}else{fm="/static/images/icons/fb24-vflGnjfAv.png"}break;case R.USER_GROUP:fh.push(fl.name,fl.members);fG.push(fy.name,"");fm="";fx=fl.group_avatar;break;case R.NEW_STYLE_GROUP:fh.push(fl.name,fl.members);fG.push(fy.name,"");fm="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){ft=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fl.name);fs=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fl.name);fx=by("<span class='group-icon'>").css("border-color",ft).css("color",ft).text(fs)}break;case R.CAROUSEL_ROOM:fh.push("",fl.name);fr=fy.name;fI=fl.members;for(fR=0,fo=fI.length;fR<fo;fR++){fM=fI[fR];fr+="."+fM.contact_vector_data.toLowerCase();fr+="."+fM.display_name.toLowerCase()}fG.push("",fr);fm=fl.avatar_url||"/static/images/carousel/icon-57px-vfluuaZ5j.png";break;default:cC(false,"should never get here due to type: "+(""+fl.type+", "+fl.name+", "+fl.email+", "+fl))}for(fk=fQ=0,fi=fG.length;fQ<fi;fk=++fQ){fz=fG[fk];fT=fJ.length?fz.split(fa):[fz];fe=0;for(fP=0,fg=fT.length;fP<fg;fP++){fL=fT[fP];if(!fL){continue}if(fL.indexOf(fD)===0){fS=fe;break}fe+=fL.length}if(fS!==-1){fA=((fD.length/fL.length)*9.4).toFixed(0);if(fl.sort_key!=null){fA+=fl.sort_key}fd=document.createTextNode(fh[fk].substr(0,fS));e9=by("<strong>").text(fh[fk].substr(fS,fD.length));fK=document.createTextNode(fh[fk].substr(fS+fD.length));fh[fk]=[fd,e9,fK];break}}if(fl.type===R.FB){fh.push(er("Facebook message"))}if(fS!==-1){if(fm){fp=by('<img width="28px" height="28px">').attr("src",fm)}else{if(fx){fp=fx}}fj=bl("autocomplete-line",fh[0]);fv=bl("autocomplete-line autocomplete-secondary",fh[1]);fB=bl("autocomplete-left",fp);fb=bl(null,[fj,fv]);fV=by("<li>").attr("value",fE).append(fB,fb);fu.push([fA,fV])}fE++}fu.sort(function(fZ,fY){if(fZ[0]<fY[0]){return 1}else{if(fZ[0]>fY[0]){return -1}else{return 0}}});e8._num_query_results=fu.length;fu=fu.slice(0,e8.options.choices);fw=by("<ul>");for(fN=0,ff=fu.length;fN<ff;fN++){fU=fu[fN];fw.append(fU[1])}e8._num_contacts_shown=fu.length;if(!by(e8.element).hasClass("no-profile-services-link-handler")){if(e8.profile_services.has_unconnected_services(true)){fF=by(e8.element).closest(".tokenized_autocompleter_container");fq=fF.attr("data-provider");fC=fq===cT.GOOGLE?er("Select from your Gmail contacts"):fq===cT.YAHOO?er("Select from your Yahoo contacts"):er("Select from your contacts");fW=false;if((fq===cT.GOOGLE||fq===cT.YAHOO)&&!e8.profile_services.service_is_connected(fq)){fW=true}else{if(e8.profile_services.has_connected_services()){fW=false;fC=er("Import Contacts")}}if(fW){fX=e8._autocompleter_profile_services_item_tmpl({email_provider_num:fq,email_provider_img:cT.to_img(fq),email_provider_name:fC,bottom_text:""}).toHTML();fw.append(fX)}else{fp=cp.make("web","user_add");fj=bl("autocomplete-line autocomplete-line-center",fC);fB=bl("autocomplete-left",fp);fb=bl(null,[fj]);fV=by("<li>").addClass("profile-services-link-handler").append(fB,fb);fw.append(fV)}}}fc=fw.wrap("<span>").parent().html();e8.old_contents=fc;return fc}})(this)};return this.options=Object.extend(T,e7)}});var cF;cF=A.Token=Class.create({initialize:function(e7,T,e8,e9){this.element=$(e7);this.token_manager=e8;this.hidden_input=T;this.element.token=this;this.selected=false;this.info=e9;return by(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var T;this.token_manager.token=this;if((T=this.hidden_input)!=null){T.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(T){if(T&&T.preventDefault){T.preventDefault()}if(this.detect(T)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(T){return this.token_manager.remove(this)},detect:function(e9){var e7,e8,T;e8=e9.target?e9.target:e9.srcElement;T=e8.token;e7=e8;while((T==null)&&e7.parentNode){e7=e7.parentNode;T=e7.token}return(T!=null)&&T.element===this.element}});var M;M=A.TokenManager=Class.create({initialize:function(e8,e9,e7,T){this.contact_search_logger=T;this.shift_boundary_right_func=e9;this.shift_boundary_left_func=e7;this.element=e8;this.tokens=[];return this.token=null},add:function(T){this.tokens.push(T);return this.element.fire("token:add",T.info)},populate:function(){var fc,e8,fa,e9,fb,e7,T;e9=this.element.select(".token");T=[];for(fb=0,e7=e9.length;fb<e7;fb++){fa=e9[fb];fc=fa.hasClassName("token-warn");e8=new cF(fa,null,this,{external:fc});T.push(this.add(e8))}return T},remove:function(e7){var T;if(e7==null){e7=this.token}if(e7!=null){this.contact_search_logger.flag_record_as_removed(e7.info.value);T=this.tokens.indexOf(e7);this.tokens.splice(T,1);e7.element.remove();if(this.token===e7&&T<this.tokens.length){this.tokens[T].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",e7.info)}},removeAll:function(){var e7,e9,T,e8;e8=this.tokens;for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];e7.element.remove();this.element.fire("token:remove",e7.info)}return this.tokens.clear()},shift_left:function(){var T;T=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(T>0){if(this.token){this.token.deselect()}return this.tokens[T-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var T;T=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(T+1<this.tokens.length){return this.tokens[T+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var d1;d1=A.HiddenInput=Class.create({initialize:function(T,e8,e7){this.element=$(T);this.auto_complete_element=e8;this.token_manager=e7;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(T){switch(T.keyCode){case Event.KEY_LEFT:T.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,T,e9,fb,e8,e7){var fa;this.user=T;$super(T,e9,fb,e7);this.contact_search_logger=new a5.ContactSearchLogger;this.token_manager=new M(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new d1(e8,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){by(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(fc,fd){by(fd).clonePosition(by(fc.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return fd.show()};this.options.onHide=function(fc,fd){return fd.hide()};this.max_textbox_height=270;if(e7.max_textbox_height!=null){this.max_textbox_height=e7.max_textbox_height}this.members=[];if(e7.members!=null){this.members=e7.members}this.invitees=[];if(e7.invitees!=null){this.invitees=e7.invitees}this.new_style_groups=[];if(e7.new_style_groups!=null){this.new_style_groups=e7.new_style_groups}this.contacts_only=false;if(e7.contacts_only!=null){this.contacts_only=e7.contacts_only}if(eu.get_url().indexOf("/referrals")!==-1){fa=by("#retrieve-contacts-button")}else{fa=by(this.element).closest("form").find(".tokenizer-submit-button")[0]}by(fa).on("mousedown",this.beforeSubmit.bindAsEventListener(this));by(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!e7.hide_import_contacts){this.import_links=by(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(e7){var T,e8;T=e7.findElement("li");this.index=T.autocompleteIndex;e8=this.selectEntry();if(!e8){return this.hide()}},onBlur:function($super,T){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(T)},onFocus:function(T){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(T){return this.tokenize_emails_input(true)},clearTokens:function(T){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var e7,T;e7=by(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var fa,e9,e8;e8=[];for(fa=0,e9=e7.length;fa<e9;fa++){T=e7[fa];e8.push(by(T).val())}return e8})()).join(", ")},check_populated:function(){var e7,T;e7=$(this.element.parentNode);T=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(e7.hasClassName("populated")&&T){return e7.removeClassName("populated")}else{if(!e7.hasClassName("populated")&&!T){return e7.addClassName("populated")}}},clean_email_addr:function(fa,e8){var e7,e9,T;for(e9=0,T=fa.length;e9<T;e9++){e7=fa[e9];e8=e8.sub(e7,"")}return e8.strip()},get_regexp_from_delimiters:function(fa){var e7,e9,e8,T;e9="";for(e8=0,T=fa.length;e8<T;e8++){e7=fa[e8];e9+=e7+"|"}return new RegExp("["+e9+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(e9,e8,T){var fa,e7;e7=true;fa=e8;if(T===R.FB){fa=e9}if(T===R.EMAIL&&!dX.validate_email(e8)){e7=false}else{if(bE.call(this.members,e8)>=0){e7=false;fa=er("Already member")}else{if(bE.call(this.invitees,e8)>=0){e7=false;fa=er("Already invited")}else{if(T===R.NEW_STYLE_GROUP){if(bE.call(this.new_style_groups,e8)>=0){e7=false;fa=er("Already member group")}else{e7=true;fa=er("Group")}}}}}if(e8===this.user.email||e8===this.user.id){fa=er("You");e7=!this.contacts_only}if(!e9&&e8){e9=e8.toString()}return{display:e9,value:e8,type:T,valid:e7,bubble_title:fa}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(e7){var T,e8;T=e7.match(this.COMPOUND_EMAIL_REGEX);if(T){e8=this.createTokenInfo(T[0],T[2],R.EMAIL);return e8}return null},tokenize_emails_input:function(ff,fa){var fk,fe,fb,fj,e8,fo,fl,fi,fh,fc,fq,fd,e9,e7,T,fm,fp,fn,fg;fe=this.options.tokens;fh=this.get_regexp_from_delimiters(fe);if(this.options.single_token){fj=[this.element.value]}else{fj=this.element.value.split(fh)}fq="";if(!ff){fq=fj[fj.length-1];fi=this.clean_email_addr(fe,fq);fj=fj.slice(0,fj.length-1);if((fg=fq[fq.length-1])===" "||fg===">"){if(fi.match(this.COMPOUND_EMAIL_REGEX)||dX.validate_email(fi)){fj.push(fi);fq=""}}}fk=false;fd=[];if(fj.length>0){for(e9=0,fm=fj.length;e9<fm;e9++){fb=fj[e9];fc=this.parse_compound_email(fb);if(fc!=null?fc.valid:void 0){fk=true;this.set_input_size(1);if(this.addContact(fc)){fo={sort_variant:bU.sort_variant,context:"legacy_tokenizer",contact_type:R.EMAIL,contact_id:fc.value,contact_name:fc.display,did_select_suggestion:false};this.contact_search_logger.add_record(fo)}}else{fd.push(fb)}}}fj=fd;if(!this.options.single_token){fl=[];for(e7=0,fp=fj.length;e7<fp;e7++){fb=fj[e7];fl.push.apply(fl,fb.split(" "))}fj=fl}if(fj.length>0){for(T=0,fn=fj.length;T<fn;T++){fb=fj[T];fb=this.clean_email_addr(fe,fb);if(fb){fc=this.createTokenInfo(fb,fb,R.EMAIL);if(fc.valid){fk=true}else{if(fa){continue}}this.set_input_size(1);if(this.addContact(fc)){fo={sort_variant:bU.sort_variant,context:"legacy_tokenizer",contact_type:R.EMAIL,contact_id:fb,did_select_suggestion:false};this.contact_search_logger.add_record(fo)}}}}if(this.element.value!==fq){this.element.value=fq}e8=this.element.up("form");if(fk){bN.clear_errors(e8)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var e7,T;e7=this.element;T=function(){return e7.focus()};return T},set_input_size:function(T){if((T==null)||T<0){T=20}return this.element.setStyle({width:""+T+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fi,fm,fc,fa,fp,fd,fj,fl,fh,e9,ff,fb,fg,fk,e8,T,fn,fo,fe,e7;fh=$(this.element.parentNode.parentNode);ff=parseInt(fh.getStyle("width"),10)-15;e9=parseInt(fh.getStyle("height"),10);if(e9!==this.textbox_height){this.textbox_height=e9;if(e9>=this.max_textbox_height){fh.setStyle({"overflow-y":"auto"})}else{fh.setStyle({"overflow-y":"hidden"})}}fp=ff;fi=by(".tokenizer-link",fh.parentNode);if(fi.length>0){fp-=fi.width()}fg=this.token_manager.tokens;fd=false;fk=0;for(e8=0,fn=fg.length;e8<fn;e8++){fb=fg[e8];fa=fb.element;fc=parseInt(fa.getStyle("width"),10)+parseInt(fa.getStyle("margin-right"),10);fl=fk+fc;if(fl>ff){fk=fc;fd=true}else{if(fc>ff){fk=0;fd=true}else{fk=fl}}}fj=fp-fk;fm=this.element.value.length*7;if(fm>fj){fj=ff}this.set_input_size(fj);if(this.import_links.length&&this.import_links_visible){if(fd||ff-fk-fm<1.25*this.import_links_width){this.import_links_visible=false;fe=this.import_links;e7=[];for(T=0,fo=fe.length;T<fo;T++){fa=fe[T];e7.push(by(fa).fadeOut(100))}return e7}}},onKeyPress:function(e7){var e8,T;this.dynamically_resize_input();if(this.active){switch(e7.keyCode){case 44:case 188:case 59:case 186:if(!e7.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(e7);return}this.selectEntry();this.hide();this.active=false;Event.stop(e7);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(e7);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(e7);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(e7);return}}else{this.tokenize_emails_input(false);if(e7.keyCode===Event.KEY_TAB||e7.keyCode===Event.KEY_RETURN){if(this.element.value&&e7.preventDefault){e7.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((e8=e7.keyCode)===Event.KEY_LEFT||e8===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((T=e7.keyCode)===Event.KEY_LEFT||T===Event.KEY_RIGHT||T===Event.KEY_UP||T===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var e7,e8,fb,fa,T,e9;if(this.active){fb=this.element.value;e9=this.options.tokens;for(fa=0,T=e9.length;fa<T;fa++){e7=e9[fa];e8=fb.indexOf(e7);if(e8!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=fb.substr(0,e8);this.selectEntry();this.hide();this.active=false;this.element.value=fb.substr(e8+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(T){if(T==null){T=this.getCurrentEntry()}return by(T).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(T){var e7;if(T==null){T=this.getCurrentEntry()}return T.value===0&&((e7=T.id)!=null?e7.length:void 0)!==0},selectEntry:function(){var fa,e9,fd,e7,e8,T,fb,fc;e9=this.getCurrentEntry();if(this.has_selected_profile_services(e9)){a5.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(e9)){fd=e9.id.split("_")[0];cC((bE.call(cT.contact_services(),fd)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");fb=cT.to_name(fd);if(this.profile_services.service_is_connected(fd)){aa.success(er("You're already connected to %(service_name)s").format({service_name:fb}));return}if(bE.call(cT.contact_services(),fd)>=0){return this.link_handler.auth_service_with_user(fd,this.user.id,((function(fe){return function(ff){return fe.link_callback(ff)}})(this)),"suggestion")}else{return cC(false,"Should never get here. entry_value: "+fd)}}else{fa=this.options.array[e9.value];e7=fa.type===R.FB?fa.fb_id:fa.type===R.USER_GROUP?fa.group_id:fa.type===R.NEW_STYLE_GROUP?fa.group_id:fa.type===R.CAROUSEL_ROOM?fa.members:fa.email;this.set_input_size(1);T=this.element.value;fc=this.createTokenInfo(fa.name.strip(),e7,fa.type);if(this.addContact(fc)){e8={sort_variant:bU.sort_variant,context:"legacy_tokenizer",search_expr:T,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:fa.type,contact_id:e7,contact_name:fa.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(e8)}bN.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(fg){var fr,fq,fl,fs,fh,fu,fd,fo,e7,fi,fm,ft,fx,e8,fe,fk,fn,ff,fp,fa,e9,T,fv,fy,fw,fj,fc,fb;if(fg.type===R.CAROUSEL_ROOM&&!fg.processed){fr=false;fj=fg.value;for(fa=0,fv=fj.length;fa<fv;fa++){fq=fj[fa];e7=this.createTokenInfo(fs=fq.display_name,fp=JSON.stringify([fq.contact_vector_type,fq.contact_vector_data]),ff=R.CAROUSEL_ROOM);e7.processed=true;e7.bubble_title=fq.contact_vector_data;fr=fr||this.addContact(e7)}return fr}fn=this.token_manager.tokens;for(e9=0,fy=fn.length;e9<fy;e9++){fi=fn[e9];if(fg.value===fi.info.value){return false}}this.element.value="";switch(fg.type){case R.FB:fo="fb_ids";fu=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case R.EMAIL:fo="emails";fu=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case R.USER_GROUP:fo="group_ids";fu=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case R.NEW_STYLE_GROUP:fo="new_style_group_ids";fu=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case R.CAROUSEL_ROOM:fo="carousel_rooms";fu=new Element("img",{src:"/static/images/carousel/icon-57px-vfluuaZ5j.png"});break;case R.INVALID:fo="invalids";fu=new Element("span",{"class":"hidden"});break;default:cC(false,"should never get here due to type: "+fg.type)}fm=this.getTokenClass(fg);fk=by("<span class='x'>").addClass(fm);fk.on("click",function(fz){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(fz);return false});fx=new Element("input",{type:"hidden",name:fo,value:fg.value.toString()});fi=new Element("a",{"class":"title_bubble token "+fm,href:"#",tabindex:"-1",title:fg.bubble_title});fd=new Element("span");if(this.options.wrap_name){e8=new Element("div",{"class":"token-display-text"});e8.__sert(fg.display);ft=e8;fl=1}else{ft=fg.display;fl=0}fc=[fx,fu,ft];for(T=0,fw=fc.length;T<fw;T++){fh=fc[T];fd.__sert(fh)}by(fd).append(fk);fi.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(fd))));if((fb=$(fi).down(5).next(fl))!=null){fb.innerHTML="&nbsp;"}fe=new cF(fi,this.hidden_input,this.token_manager,fg);this.token_manager.add(fe);this.element.up().__sert({before:fi});return true},getTokenClass:function(T){if(!T.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,T,e9,fa,e8,e7){$super(T,e9,fa,e8,e7);this.warn_only=!e7.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};return this.suspended_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(T){this.warn_only=!T;return this.reloadContacts()},reloadContacts:function(){var e7,T;return bU.load_contacts(e7=false,T=false,(function(e8){return function(e9){return e8.setContacts(e9)}})(this))},setContacts:function($super,fa){var T,e9,e7,e8;this.team_contacts={};this.team_contacts[cD.get_viewer().work_email]=1;fa=fa.sortByTeamFirst();e8=fa.contacts;for(e9=0,e7=e8.length;e9<e7;e9++){T=e8[e9];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(fa))}else{return $super(fa)}},createTokenInfo:function(fa,e8,T){var fc,fb,e9,e7;e7=true;fb=false;fc=e8;if(T===R.FB){fc=fa}if(T===R.EMAIL&&!dX.validate_email(e8)){e7=false}else{if(bE.call(this.members,e8)>=0){e7=false;fc=er("Already member")}else{if(bE.call(this.invitees,e8)>=0){e7=false;fc=er("Already invited")}else{if(T===R.EMAIL&&!this.team_contacts[e8]){e7=this.warn_only;fb=true}else{if(T===R.FB){e7=this.warn_only;fb=true}else{if(T===R.NEW_STYLE_GROUP){if(bE.call(this.new_style_groups,e8)>=0){e7=false;fc=er("Already member group")}else{e7=true;fc=er("Group")}}}}}}}if(e8===this.user.email||e8===this.user.id){fc=er("You");e7=!this.contacts_only}if(!fa&&e8){fa=e8.toString()}return e9={display:fa,value:e8,type:T,valid:e7,external:fb,bubble_title:fc}},getTokenClass:function(T){if(!T.valid){return"token-error"}if(T.external){return"token-warn"}return"token-valid"},notifyExternal:function(e7){var T,e8,e9;e9=e7.memo;if(e9.external){e8=this.token_manager.tokens.filter(function(fa){return fa.info.external});T=e8?e8.length:0;return this.element.fire("sf:token:external",{count:T})}}});var h;h=A.TeamSharedFolderInviteController=(function(){function T(e7){var e8;this.element=$(e7[0]);e8=this.element.down(".new-collab-input");e8.observe("sf:token:external",this.handle_external.bind(this))}T.prototype.handle_external=function(e8){var e7,e9;e7=e8.memo.count;e9=this.element.down(".external-invite-message");if(e7>1){dj.fillVal(e7,"external-invite-num");if(e9!=null){e9.removeClassName("single")}return e9!=null?e9.show():void 0}else{if(e7===1){if(e9!=null){e9.addClassName("single")}return e9!=null?e9.show():void 0}else{return e9!=null?e9.hide():void 0}}};return T})();var af;af=INLINE_JS.SharingModel=A.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,file_viewer_files:[],send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(e7,T,e8){this.filename=e7;this.c2d_vars=T;this.c2d_url=e8!=null?e8:"/sm/c2d";this.init_logger();by(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(e9){return function(){var fc,fb,fa;fb=$("login-create-an-account");if(fb){fb.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);by("#download_button_link[data-dl-link]").on("click",e9.download_zip);e9.set_viewport_size();fc=function(fe,fd){return e9.do_c2d(fd.id)};by("#c2d-modal .login-form").on("db:login:success",fc);by("#c2d-modal .register-form").on("db:register:success",fc);fa=C.parse(window.location.href);if(fa.getQuery()["force_dl"]){fa.updateQuery({force_dl:0,dl:1});return window.location=fa.toString()}}})(this))},init_folder:function(e7,e9,e8,T){this.is_folder=true;this.gallery_enabled=e7;this.gallery_showing=e9;this.file_viewer_files=e8;this.file_view_mode=T;return on_script_loaded((function(fa){return function(){fa.load_thumbs();by("#gallery-toggle").click(function(){return fa.switch_mode("gallery")});by("#list-toggle").click(function(){return fa.switch_mode("list")});by(".file-link").click(function(fb){return fa.open_file_viewer(by(fb.currentTarget).data("mediaIndex"))});return by(document).on(aB.FILE_ACTIVITY_UPDATE,function(fc,fb,fd){return by("[data-file-activity-key='"+fd.activity_key+"']").find(".comment-count-bubble-wrapper").each(function(){var fe;return(fe=this.reactComponent)!=null?fe.setProps({unresolvedCommentCount:fd.unresolvedCommentCount(),unseenCommentCount:fd.unseenCommentCount()}):void 0})})}})(this))},open_file_viewer:function(T){if(!br.isNumber(T)||T<0){return}k.show(this.file_viewer_files[T],cD.get_viewer(),{files:this.file_viewer_files,file_view_mode:this.file_view_mode});k.set_preview_url();return false},init_album:function(){this.is_album=true;this._resize_album_view();Event.observe(window,"resize",this._resize_album_view.bind(this));return on_script_loaded((function(T){return function(){return by("#add_to_my_dropbox_link").on("click",function(){return T.show_c2d_modal()})}})(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(e7){var e8,T;T=e7.icon.split("_");T.pop();e8=T.join("_");return"/static/images/icons128/"+e8+".png"},init_logger:function(){on_script_loaded((function(T){return function(){var e7;e7=$("login-hover-link");if(e7){e7.observe("click",function(){return aI.log(aI.CLICK_SIGN_IN)});e7.observe("click",function(){return dC.log("click_sign_in")})}if($("download_button_link")){aI.attachLogListener(aI.CLICK_DOWNLOAD,$("download_button_link"))}e7=$("add_to_my_dropbox_link");if(e7){aI.attachLogListener(aI.CLICK_ADD_TO_MY_DROPBOX,e7);dC.attachLogListener("click_add_to_my_dropbox",e7)}if($$(".remove-link").length){aI.attachLogListener(aI.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aI.attachLogListener(aI.CLICK_FILENAME,$$(".shmodel-filename")[0])}e7=$("default_content_download_button");if(e7){aI.attachLogListener(aI.CLICK_DOWNLOAD,e7)}e7=$("default_content_a2md");if(e7){aI.attachLogListener(aI.CLICK_ADD_TO_MY_DROPBOX,e7)}e7=by("#login-create-an-account")[0];aI.attachLogListener(aI.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,e7);e7=by("#login-hover-cont .login-form")[0];aI.attachLogListener(aI.LOGIN_THRU_DEFAULT_DROPDOWN,e7);return by("#share-button").click(function(e8){return aI.log(aI.CLICK_SHARE)})}})(this));return document.observe(aE.ACTIONS_ADDED,(function(T){return function(){var fa,e9,e7,e8;e8=$("view_original");if(e8){aI.attachLogListener("shmodel_lightbox_click_vieworiginal",e8)}e9=$("lightbox_share_link");if(e9){aI.attachLogListener("shmodel_lightbox_click_getlink",e9)}e7=by("lightbox-share-link");if(e7[0]){aI.attachLogListener("shmodel_lightbox_click_getlink",e7[0])}fa=$("lightbox_download_link");if(fa){return aI.attachLogListener("shmodel_lightbox_click_download",fa)}}})(this))},set_team_only_shmodel:function(e7,T){this.team_only_shmodel=e7;return this.owner_name=T},_resize_album_view:function(){var T;T=Math.floor((y.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+T+"px"})},load_thumbs:function(){var e7,T;T=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");e7=function(e8){if(!e8.src.endsWith(cp.SPACER)){return e8.addClassName("thumbnail")}};return bm.batch_load_thumbs(T,this.THUMBS_BATCH_SIZE,e7)},switch_mode:function(fc){var e8,fd,fb,T,fa,e7,e9;e9=$A(["gallery","list"]);for(fa=0,e7=e9.length;fa<e7;fa++){T=e9[fa];fd=$(T+"-view-container");e8=$(T+"-toggle");if(fc===T){fd.show();e8.addClassName("selected")}else{fd.hide();e8.removeClassName("selected")}}if(history.replaceState){fb=window.location.pathname;if(fc==="list"){fb+="?lst"}history.replaceState({},"",fb)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var T;if($(document.body).hasClassName("mobile")){T=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(T)}},toggle_dropdown:function(e9,fa,e8){var T,e7;if(e9){Event.extend(e9).preventDefault()}if(!fa.visible()){if(this.is_album){return eJ.show(fa,e8,null,true)}else{e7=$$(".nav-header").first().getHeight();T=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(T<0&&dX.ie8){T=4}return eJ.show(fa,e8,e7-T,true)}}},prepare_confirm_remove_modal:function(e7,e9,T,fb,fg,fc,ff,fd){var e8,fa,fe;if(T){fe=fb?er("Unshare?"):er("Unshare album?");e8=by("#album-disable-token-modal")[0];dj.fillVal(e7.escapeHTML(),"album_unshare_name")}else{if(fc){fe=er("Remove link created by %(name)s").format({name:ff});if(e9){fa=er('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{fa=er('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}fa=fa.format({fname:bO.em_snippet(e7,17),owner:ff,owner_email:fd})}else{fe=er("Remove link to '%(name)s'").format({name:bO.em_snippet(e7,17)});if(e9){fa=er("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{fa=er("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}e8=by("#disable-token-modal")[0];dj.fillVal(fa,"disable-token-desc")}return{title:fe,contents:e8}},confirm_remove:function(e7,fb,e8,T,e9,ff,fc,fe,fd){var fa;if(e8==null){e8=false}if(T==null){T=false}if(e9==null){e9=false}if(ff==null){ff=null}if(fc==null){fc=false}if(fe==null){fe=null}if(fd==null){fd=null}cC(fb,"confirm_remove missing tkey");cC(e7,"confirm_remove missing name");cC(ff,"confirm_remove missing user_id");cC(!fc||!T,"admin removal of collections not supported");cC(!fc||fe,"missing link owner name for admin removal");cC(!fc||fd,"missing link owner email for admin removal");if(!cD.get_viewer().is_uid_signed_in(ff)){bI.show_modal({user_id:ff,on_success:(function(fg){return function(){return fg.confirm_remove(e7,fb,e8,T,e9,ff,fc,fe,fd)}})(this)});return}fa=af.prepare_confirm_remove_modal(e7,e8,T,e9,ff,fc,fe,fd);return eY.show(fa.title,fa.contents,{token:fb,name:e7,is_album:T,user_id:ff})},confirm_remove_from_event_gid:function(T,fe,e8,fd,fa,fc,fb,e7){var e9;if(fa==null){fa=false}if(fc==null){fc=null}if(fb==null){fb=null}if(e7==null){e7=null}cC(fe,"confirm_remove missing event gid");cC(T,"confirm_remove missing name");cC(fd,"confirm_remove missing user_id");cC(cD.get_viewer().is_uid_signed_in(fd),"user not logged in");cC(!fa||fc,"missing link owner name for admin removal");cC(!fa||fb,"missing link owner email for admin removal");e9=af.prepare_confirm_remove_modal(T,e8,false,false,fd,fa,fc,fb);return eY.show(e9.title,e9.contents,{name:T,user_id:fd,activity_log_event_gid_dbase64:fe,redirect_to_member_id:e7})},do_remove:function(e9){var T,e8,e7;cC(e9.token||e9.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");T=by("#modal-content input").first();T.attr("disabled",true);by("#modal-content").addClass("ajax-loading");e7=window.location.pathname;if((e7==="/links"||e7==="/links/your_links"||e7==="/recents")||e7.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+e9.token,{subject_user:e9.user_id,onSuccess:(function(fa){return function(){var fb;eY.hide();if(e9.is_album){fb=er("Unshared '%(name)s'")}else{fb=er("Removed link for '%(name)s'")}fb=fb.format({name:e9.name});aa.success(fb);return document.fire(aB.LINKS_REMOVE,{token:e9.token})}})(this),onComplete:(function(fa){return function(){T.attr("disabled",false);return by("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(e9.token){e8=C({path:"/sm/disable/"+e9.token})}else{e8=C({path:"/sm/disable_by_event_gid/"+e9.activity_log_event_gid_dbase64});e8.updateQuery("redirect_to_member_id",e9.redirect_to_member_id).toString()}return bN.postRequest(e8.updateQuery(Constants.UID_PARAM_NAME,e9.user_id).toString())}},show_shmodal_onload:function(e8,e9,e7,T){if(T==null){T=null}return by((function(fa){return function(){eu.remove_query_param("m");if(!cD.get_viewer().is_uid_signed_in(T)){bI.show_modal({user_id:T,on_success:function(){return fa.show_shmodal_onload(e8,e9,e7,T)}});return}if((T!=null)&&dV.get_for_user(cD.get_viewer().get_user_by_id(T)).verified_or_show()){return fa.show_shmodal(e8,e9,e7,T)}else{if(T==null){cC(cD.get_viewer().is_paired,"Expected viewer to be paired.");return fa.show_share_shmodel_role_chooser(e8,e9,e7)}}}})(this))},show_shmodal:function(e7,fd,T,fj){var fi,ff,fh,fe,fb,fc,e9,e8,fg,fa;this.url=e7;this.short_url=fd;if(!cD.get_viewer().is_uid_signed_in(fj)){bI.show_modal({user_id:fj,on_success:(function(fk){return function(){return fk.show_shmodal(e7,fd,T,fj)}})(this)});return}e9=cD.get_viewer().get_user_by_id(fj);if(dV.get_for_user(e9).verified_or_show()){fc="shmodal-user-"+fj;eY.show(this._get_shmodal_title(e9.is_team),dj.fromElm($(fc)));fb={};fb[Constants.UID_PARAM_NAME]=fj;bN.add_vars("shmodal-send-form",fb);if(this._get_thumbnail_type()){fa=$$(".shmodal-image");for(e8=0,fg=fa.length;e8<fg;e8++){fe=fa[e8];fe.addClassName("thumbnail")}}if(T==="contacts"){fh=Autocompleter.ContactsTokenizer}else{fh=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fh(e9,fc+"-new-collab-input",fc+"-new-whobulk",fc+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:T==="team_only",user_id:fj});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fi=p.clipboard_overlay(e7,by("#"+fc+"-copy-link"),af.copied_to_clipboard);fi.css({position:"fixed",zIndex:1001});fi.children().height(fi.height());clearInterval(this.follow_freshbutton);ff=(function(fk){return function(){return fi.clonePosition(by("#"+fc+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(ff,500)}else{$(fc+"-copy-link").hide()}}cb._create($("modal").down(".custom-message-container"));cb._create($("modal").down(".fb-post-sickinput"));cb._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(fd,fj);$(fc+"-new-collab-input").focus();return aI.log("shmodal_show")}},configure_dropdown:function(){var fa,e7,e9,T,e8;e8=$$(".dropdown-menu-container");for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];e7=fa.down(".dropdown-menu-trigger");if(e7!=null){e7.observe("click",(function(fb){return function(fd){var fc;fc=fd.target.up(".dropdown-menu-container");return fc.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(fb){return function(fh){var ff,fg,fe,fc,fd;if(fh.target.hasClassName("dropdown-menu-trigger")||fh.target.up(".dropdown-menu-trigger")){return}fc=$$(".dropdown-shown");fd=[];for(fg=0,fe=fc.length;fg<fe;fg++){ff=fc[fg];fd.push(ff.removeClassName("dropdown-shown"))}return fd}})(this))},copied_to_clipboard:function(){aa.success(er("Link copied to clipboard"));eY.hide();aI.log("shmodal_copy_link");return a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:af.is_album?"collection":af.is_folder?"folder":af.filename.indexOf(".")===-1?"file":cK.EXTENSION_TO_CATEGORY[au.file_extension(af.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(e8){var e9,fh,fe,fi,fj,fc,ff,T,fb,fa,fg,e7,fd;cC(e8,"Must pass the shmodal send form into get_shmodel_send_recipients");e9=e8.select('input[name="emails"]');fh=e8.select('input[name="fb_ids"]');fe=e8.select('input[name="group_ids"]');fc=e8.select('input[name="new_style_group_ids"]');T=[];fd=[e9,fh,fe,fc];for(fb=0,fg=fd.length;fb<fg;fb++){fj=fd[fb];for(fa=0,e7=fj.length;fa<e7;fa++){fi=fj[fa];ff=fi.up().innerHTML.stripTags().escapeHTML();T.push(ff.substring(0,ff.indexOf("&")))}}return T},close_embedded_fileviewer:function(e7){var T;e7.preventDefault();T=new em();T.configureParentMessaging(function(){},["parent-ready"]);T.startListening();return T.postMessageToParent("close-fileviewer")},send_shmodel_link:function(e9){var e8,e7,fa,T;e8=$("shmodal-send-form");cC(e8,"Couldn't find the shmodal send form.");T=this.get_shmodel_send_recipients(e8);fa=(function(fb){return function(fc){var fd;fd=aS.success_string_for_recipients(T);aa.success(fd);eY.hide();return aI.log("shmodal_send")}})(this);e7=(function(fb){return function(fc){return bN.remove_loading()}})(this);return bN.ajax_submit(e8,"/sm/share",fa,e7,e8.down(".tokenizer-submit-button"))},show_content:function(e7){var fa,e9,T,e8;$("shmodal-title-text").__date(df.to_title_str(e7));e8=df.list;for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];if(fa!==e7){$(df.to_toggle_str(fa)).removeClassName("toggled");$(df.to_content_str(fa)).hide()}}$(df.to_content_str(e7)).show();$(df.to_toggle_str(e7)).addClassName("toggled");return by("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(df.SEND)},show_fb_content:function(){return this.show_content(df.FB)},show_twitter_content:function(){return this.show_content(df.TWITTER)},start_fb_post:function(fa,e7){var fb,e8,T,e9;e8=(function(fc){return function(){return ej.do_auth(fc.do_fb_post.curry(fa,e7),e7)}})(this);fb=by("#modal:visible, #modal-overlay:visible");T=function(){return fb.show()};if(ej.authed_user_id===e7){return this.do_fb_post(fa,e7)}else{if(cD.get_viewer().is_uid_associated(ej.authed_user_id)){fb.hide();e9=new d5(cD.get_viewer().get_user_by_id(e7),T,e8.bind(this));return e9.show()}else{return e8()}}},start_twitter_post:function(T){if(cw.is_authed(T)){return this.do_twitter_post(T)}else{return cw.do_auth(this.do_twitter_post,T)}},do_fb_post:function(e7,T){ej.custom_show_posting=function(){return bN.add_loading($("shmodal-fb-post-submit"))};ej.custom_show_complete=function(){eY.hide();aa.success(er("Successfully posted to Facebook"));aI.log("shmodal_fb_post");return a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:af.is_album?"collection":af.is_folder?"folder":af.filename.indexOf(".")===-1?"file":cK.EXTENSION_TO_CATEGORY[au.file_extension(af.filename).toLowerCase()]||"file"})};return ej.post($F("shmodal-fb-post-input"),e7,null,null,null,function(){return eY.hide()},T)},do_twitter_post:function(T){var e7;e7=$F("shmodal-twitter-post-input");if(!e7){aa.error(er("Please enter a Twitter post"));return}else{if(e7.length>140){aa.error(er("Your post must be 140 characters or less"));return}}cw.custom_show_posting=function(){$("twitter-chars").hide();return bN.add_loading($("shmodal-twitter-post-submit"))};return cw.custom_post(e7,(function(e8){return function(){eY.hide();aa.success(er("Successfully posted to Twitter"));aI.log("shmodal_tweet");return a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:af.is_album?"collection":af.is_folder?"folder":af.filename.indexOf(".")===-1?"file":cK.EXTENSION_TO_CATEGORY[au.file_extension(af.filename).toLowerCase()]||"file"})}})(this),T)},_get_shmodal_title:function(T){if(T==null){T=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(e7){return function(){return e7.show_send_content()}})(this)),((function(e7){return function(){return e7.show_fb_content()}})(this)),((function(e7){return function(){return e7.show_twitter_content()}})(this)),T)},generate_title_content:function(e7,fe,fb,fg,e9){var fa,fc,T,ff,e8,fd;if(e9==null){e9=false}ff=by("<div/>",{id:"shmodal-title"});e8=by("<div/>",{id:"shmodal-title-text",text:e7});ff.append(e8);if(!e9){T=by("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});T.html(cp.make("web","email_20"));T.on("click",fe);fc=by("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});fc.html(cp.make("web","fb_20"));fc.on("click",fb);fd=by("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});fd.html(cp.make("web","twitter_20"));fd.on("click",fg);ff.append([T,fc,fd])}fa=by("<div/>",{"class":"clear"});ff.append(fa);return ff[0]},_get_shmodal_title_text:function(){var e7,T;if(this.is_folder){e7=er("Share link to \u2018%(folder_name)s\u2019");return e7=e7.format({folder_name:bO.em_snippet(this.filename,15)})}else{T=this._get_thumbnail_type();if(T===cK.CATEGORY_TO_TRANSLATION.IMAGE){return er("Share this image")}else{if(T===cK.CATEGORY_TO_TRANSLATION.VIDEO){return er("Share this video")}else{return er("Share '%(filename)s'").format({filename:bO.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var e7,T;if(this.filename.indexOf(".")===-1){return false}T=au.file_extension(this.filename).toLowerCase();e7=cK.EXTENSION_TO_CATEGORY[T];if(e7&&(e7==="IMAGE"||e7==="VIDEO")){return cK.CATEGORY_TO_TRANSLATION[e7]}return false},_populate_twitter_info:function(e8,T){var e9,e7;e9=this.is_folder?er("Just shared some files using @Dropbox"):(e7=this._get_thumbnail_type(),e7&&e7===cK.CATEGORY_TO_TRANSLATION.IMAGE?er("Just shared an image using @Dropbox"):er("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(e9+" "+e8);dX._track_twitter_chars_left("shmodal-twitter-post-input",140);if(cw.is_authed(T)){return cw.get_user_info(function(fa){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:fa.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(fa.name);$("shmodal-twitter-profile").down(".username").__date("@"+fa.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},T)}},download_zip:function(e9){var e7,e8,fa,T,fb;e7=by("#download_button_link").attr("data-dl-link");fb=by("#download_button_link").attr("data-test-link");T=by("#download_button_link").attr("data-owner")==="true";fa=(function(fc){return function(fd){var fe;if(fd==="OK"){window.location=e7}else{if(fd.indexOf("err:")===0){if(T){fe=er("The zip file is too large.")}else{fe=er("The zip file is too large. Please add it to your Dropbox.")}aa.error(fe)}else{aa.error(er("Failed to download zip file."))}}return false}})(this);e8=(function(fc){return function(fd){aa.error(er("Failed to download zip file."));return false}})(this);if(fb&&by.support.cors===true){by.ajax({url:fb,type:"POST",success:fa,error:e8})}else{window.location=e7}return false},show_share_shmodel_role_chooser:function(e7,e8,T){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dp({element_id:"share-shmodel-select-role-modal",link_url:e7,short_url:e8,tokenizer_type:T})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(e7,e8,T,fa){var e9;e9=(function(fb){return function(){var fc;eY.hide();by("#role-selector option").removeClass("disabled");fc=cD.get_viewer().get_uid_by_role(fa);cD.get_viewer().sign_in_user_by_id(fc);a5.ShmodelUILogger.log("via-shmodel-viewer");return af.show_shmodal(e7,e8,T,fc)}})(this);if(!cD.get_viewer().is_role_signed_in(fa)){dw.not_logged_in_role=fa;return bI.show_modal({role:fa,on_success:e9})}else{return e9()}},show_c2d_modal:function(fc,e7){var fb,T,fa,e8,e9;if(fc==null){fc=""}if(e7==null){e7=false}if(fc){if(fc===Constants.ROLE_PERSONAL){cC(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cD.get_viewer().is_role_signed_in(fc)){bI.show_modal({role:fc,on_success:(function(fd){return function(){return fd.show_c2d_modal(fc)}})(this)});return}}else{if(cD.get_viewer().is_paired){new aL({element_id:"select-role-modal"}).show();return}}if(fc){e8="#c2d-modal-"+fc}else{e8="#c2d-modal"}e9=this._c2d_modal_msg(fc,cD.get_viewer().team_name);fb=this._c2d_modal_button_msg(fc,cD.get_viewer().team_name);T=this._c2d_modal_desc(fc,cD.get_viewer().team_name);if(e7){T=this._c2d_modal_team_only_desc(cD.get_viewer().team_name)+"<br/><br/>"+T}fa=this._c2d_modal_login_desc(fc,cD.get_viewer().team_name);dj.fillVal(T,"c2d-desc");dj.fillVal(fa,"c2d-login-desc");by(".c2d-submit-button").val(fb);by(".c2d-login-register-desc").hide();if(this.is_album){by(".c2d-login-register-album-desc").show()}else{if(this.is_folder){by(".c2d-login-register-folder-desc").show()}else{by(".c2d-login-register-file-desc").show()}}return eY.show(e9,by(e8)[0],false,false,false,false)},_c2d_modal_msg:function(e9,e7){var T,e8;if(e9==null){e9=""}if(e7==null){e7=""}if(this.c2d_vars.title){return e8=this.c2d_vars.title}else{if(e9===Constants.ROLE_PERSONAL){e8=er("Save '%(filename)s' to my personal Dropbox");return e8.format({filename:bO.em_snippet(this.filename,10)})}else{if(e9===Constants.ROLE_WORK){e8=er("Save '%(filename)s' to my %(team_name)s Dropbox");T=Math.max(10,15-new bO(e7).length);return e8.format({filename:bO.em_snippet(this.filename,T),team_name:e7})}else{e8=er("Save '%(filename)s' to my Dropbox");return e8.format({filename:bO.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(e8,T){var e7;if(e8==null){e8=""}if(T==null){T=""}if(e8===Constants.ROLE_PERSONAL){return e7=er("Save to my personal Dropbox")}else{if(e8===Constants.ROLE_WORK){e7=er("Save to my %(team_name)s Dropbox");return e7.format({team_name:T})}else{return er("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(T){var e7;if(this.is_album){e7=er("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){e7=er("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{e7=er("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return e7.format({owner_name:this.owner_name,team_name:T})},_c2d_modal_desc:function(e8,T){var e7;if(e8==null){e8=""}if(T==null){T=""}if(e8===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){e7=er("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return e7.format({owner_name:this.owner_name,team_name:T})}else{return e7=er("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){e7=er("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return e7.format({owner_name:this.owner_name,team_name:T})}else{return e7=er("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){e7=er("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return e7.format({owner_name:this.owner_name,team_name:T})}else{return e7=er("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(e8===Constants.ROLE_WORK){if(this.is_album){e7=er("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){e7=er("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{e7=er("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return e7.format({team_name:T})}else{if(this.is_album){return er("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return er("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return er("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(e8,T){var e7;if(e8==null){e8=""}if(T==null){T=""}if(e8===Constants.ROLE_PERSONAL){if(this.is_album){return e7=er("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return e7=er("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return e7=er("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(e8===Constants.ROLE_WORK){if(this.is_album){e7=er("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){e7=er("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{e7=er("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return e7.format({team_name:T})}}},do_c2d:function(T){var e7;cC(T,"Must specify a user_id for saving to Dropbox.");e7=er("Saving to your Dropbox...");if(cD.get_viewer().is_paired){if(cD.get_viewer().get_user_by_id(T).is_team){e7=er("Saving to your %(team_name)s Dropbox...");e7=e7.format({team_name:cD.get_viewer().team_name})}else{e7=er("Saving to your personal Dropbox...")}}aa.success(e7);eY.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:e7,subject_user:T,onSuccess:(function(e8){return function(e9){if(e9.responseText){return bV.redirect(e9.responseText)}}})(this)})},c2d_show_twofactor_error:function(e7){var T;T=$("c2d-twofactor-error");T.__date(e7);return T.show()},c2d_hide_twofactor_error:function(T){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(er("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(er("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(er("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(er("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(er("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(er("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var df;df=A.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",er("Share on Facebook"),er("Share on Twitter")],to_content_str:function(T){return this._content_str[T]},to_toggle_str:function(T){return this._toggle_str[T]},to_title_str:function(T){if(T===0){return af._get_shmodal_title_text()}return this._title_str[T]},to_focus_str:function(T){return this._focus_str[T]}};var V,c8,bF,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};c8=INLINE_JS.ShareLinkModal=A.ShareLinkModal=(function(T){cG(e7,T);function e7(e8,fb,e9,fd,fc){var fa,fe;this.user_id=e8;if(fd==null){fd=false}if(fc==null){fc=void 0}this.before_show=dl(this.before_show,this);this.show=dl(this.show,this);this.prompt_login_then_show=dl(this.prompt_login_then_show,this);fe={origin:e9};fe[Constants.UID_PARAM_NAME]=this.user_id;if(fc){fa=C({path:"/sm/get_link_modal_content/"+fc}).toString()}else{fa=C({path:"/sm/share_link"+fb}).toString()}e7.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:fa,parameters:fe})}e7.prototype.prompt_login_then_show=function(){var e8;e8=(function(e9){return function(){eY.hide();by("#role-selector option").removeClass("disabled");cD.get_viewer().sign_in_user_by_id(e9.user_id);a5.ShmodelUILogger.log("via-shmodel-viewer");return e9.show()}})(this);if(!cD.get_viewer().is_uid_signed_in(this.user_id)){return bI.show_modal({user_id:this.user_id,on_success:e8})}else{return e8()}};e7.prototype.show=function(){var e8;e8=cD.get_viewer().get_user_by_id(this.user_id);if(dV.get_for_user(e8).verified_or_show(ek.SHMODAL)){return e7.__super__.show.call(this)}};e7.prototype.before_show=function(){var fb,fa,e8,e9;e9=this.$modal_window.find(".share-link-modal-content").length;if(e9){fb={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};e8=by("<img />",fb);fa=by("<div />",{"class":"loading-spinner"}).append(e8);return this.$modal_window.find(".dynamic-content").html(fa)}};return e7})(cu);bF=A.ShareLinkModalContent=(function(){function T(fb,fc,fd,fe,e7,e8,fh,fa,ff){var fg,e9;this.owner_id=fb;this.tkey=fc;this.fq_path=fd;this.link=fe;this.filename=e7;this.tokenizer_type=e8;this.tokenizer_ctx_str=fh;this.fq_path_of_restricting_sf=ff;this._send_link=dl(this._send_link,this);this._show_shared_link_settings_modal=dl(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=dl(this._show_shared_folder_settings_modal,this);this._select_all_text=dl(this._select_all_text,this);this._toggle_send_link_button=dl(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=dl(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=dl(this._toggle_close_button_text,this);this._listen=dl(this._listen,this);this._init_autocompleter=dl(this._init_autocompleter,this);this.$content=by(".share-link-modal-content");this.modal=dZ.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=l.create_contacts_list(fa)}fg={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aB.LINKS_ADD,fg);this.modal.set_title(er("Share link to \u2018%(filename)s\u2019").format({filename:bO.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((e9=this.$share_link_url_input[0])!=null){e9.select()}}T.prototype._init_autocompleter=function(){var e7,e8;e7={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cD.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e7,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cD.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e7)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cD.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e7)}}e8=(function(e9){return function(fa){return function(){return e9.autocompleter.contact_search_logger.log_records(e9.owner_id,fa)}}})(this);this.modal.logger_keydown_close_handler=e8(true);this.modal.$overlay.on("click",e8(true));this.modal.$db_modal_x.on("click",e8(true));this.$send_link_button.on("click",e8(false));this.$cancel_button.on("click",e8(true));cb.init();return this.$collab_input.focus()};T.prototype._listen=function(){var e9,e7,fc,fb,fa,e8;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(fd){return function(fe){return dS.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((e9=this.$collab_input)!=null){e9.keyup(this._toggle_send_link_button)}if((e7=this.$collab_input)!=null){e7.on("input",this._toggle_send_link_button)}if((fc=this.$collab_input[0])!=null){fc.observe("token:remove",this._toggle_send_link_button)}if((fb=this.$collab_input[0])!=null){fb.observe("token:add",this._toggle_close_button_text)}if((fa=this.$collab_input[0])!=null){fa.observe("token:remove",this._toggle_close_button_text)}return(e8=this.$collab_input[0])!=null?e8.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};T.prototype._toggle_close_button_text=function(e9){var e7,e8;e7=((e8=this.autocompleter)!=null?e8.token_manager.tokens.length:void 0)===0;if(e7){return this.$cancel_button.text(er("Close"))}else{return this.$cancel_button.text(er("Cancel"))}};T.prototype._toggle_recipients_outside_team_warning=function(e9){var e7,e8;e7=by(".external-recipient-warning-message");if(e7.length){e8=e9.memo.count;if(e9.memo.shared_folder_warning){if(e8>0){return e7.show()}else{return e7.hide()}}else{if(e8>1){e7.find(".external-recpient-num").text(e8);return e7.removeClass("single").show()}else{if(e8===1){return e7.addClass("single").show()}else{return e7.hide()}}}}};T.prototype._toggle_send_link_button=function(e9){var e7,e8;e7=((e8=this.autocompleter)!=null?e8.token_manager.tokens.length:void 0)===0;e7=e7&&by.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",e7)};T.prototype._select_all_text=function(e7){return by(e7.currentTarget)[0].select()};T.prototype._show_shared_folder_settings_modal=function(e8){var e7;e8.preventDefault();e7=cD.get_viewer().get_user_by_id(this.owner_id);return o.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,e7)};T.prototype._show_shared_link_settings_modal=function(e8){var e7;e8.preventDefault();e7=new dP(this.owner_id,this.tkey);return dS.push(e7)};T.prototype._send_link=function(fb){var e9,e8,fa,e7,fc;fa=this.$content.find(".share-link-modal-send-form")[0];e7=this.get_shmodel_send_recipients(fa);fc=(function(fd){return function(fe){var ff;ff=aS.success_string_for_recipients(e7);aa.success(ff);dS.pop();return aI.log("shmodal_send")}})(this);e8=(function(fd){return function(fe){return bN.remove_loading()}})(this);e9=this.$content.find(".tokenizer-submit-button")[0];return bN.ajax_submit(fa,"/sm/share",fc,e8,e9)};T.prototype.get_shmodel_send_recipients=function(e9){var fa,fi,ff,fj,fk,fd,fg,e7,fc,fb,fh,e8,fe;cC(e9,"Must pass the shmodal send form into get_shmodel_send_recipients");fa=e9.select('input[name="emails"]');fi=e9.select('input[name="fb_ids"]');ff=e9.select('input[name="group_ids"]');fd=e9.select('input[name="new_style_group_ids"]');e7=[];fe=[fa,fi,ff,fd];for(fc=0,fh=fe.length;fc<fh;fc++){fk=fe[fc];for(fb=0,e8=fk.length;fb<e8;fb++){fj=fk[fb];fg=fj.up().innerHTML.stripTags().escapeHTML();e7.push(fg.substring(0,fg.indexOf("&")))}}return e7};return T})();V=INLINE_JS.QuickSend=A.QuickSend={_files:{},_uploading_fileids:{},init:function(T,e7,e9){var e8;this.owner_id=T;this.tokenizer_ctx_str=e7;this.keep_visible=e9;this.$content=by("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((e8=this.$collab_input)!=null){e8.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");by("#browse-files").addClass("quicksend-collapsed");V._update_location();this.has_autocompleter_inited=false;a5.SharedFolderActivityLogger.log("web","quick_send_displayed",cl.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var fa;return(fa=V.$import_services)!=null?fa.hide():void 0},100)});by("#quick-send-top-choose-button-send").click(function(){return by("#quick-send-file-box").click()});by("#quick-send-choose-button").click(function(){return by("#quick-send-file-box").click()});by(".quick-send-choose-file-link").click(function(){return by("#quick-send-file-box").click()});by("#quick-send-file-box").on("change",function(){var fb,fa;fa=by("#quick-send-file-box")[0].files;fb=function(){if(!cl.active_user){cl.active_user=cD.get_viewer().get_user_by_id(V.owner_id)}return bj.upload(V.DEST_FOLDER+"/",fa)};return V.get_folder_name(fb)});document.on(ct.COMPLETE_EVT,V._file_upload_completed);document.on(ct.ERROR_EVT,V._file_upload_errored);return document.on(cl.UPDATE_EVT,V._update_location)},_cancel_button_clicked:function(T){a5.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",cl.active_user,{});return V._reset()},_init_autocompleter:function(){var T;if(V.has_autocompleter_inited){return}V.has_autocompleter_inited=true;T={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:V.owner_id,max_textbox_height:30,viewer:cD.get_viewer(),include_from_linked_accounts:true};return V.autocompleter=new Autocompleter.ContactsTokenizer(cD.get_viewer().get_user_by_id(V.owner_id),V.collab_input_id,V.tokenizer_ctx_str+"-new-whobulk",V.tokenizer_ctx_str+"-hidden-input",T)},_send_link:function(fd){var fa,e9,fb,e8,e7,fe,ff,T,fc;a5.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",cl.active_user,{});V.autocompleter.tokenize_emails_input(true);T=V.autocompleter.getTokenCount();e8=by(".quick-send-left-form")[0];e7=[];ff=0;for(fb in V._files){ff+=1;e9=V._files[fb];e7.push(e9.fq_path)}fe={num_recipients:T,num_files:ff};a5.SharedFolderActivityLogger.log("web","quick_send_send_attempted",cl.active_user,fe);fc=(function(fg){return function(fh){V._reset();V._toggle_top_area_view();return a5.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",cl.active_user,{})}})(this);fa=(function(fg){return function(fh){return a5.SharedFolderActivityLogger.log("web","quick_send_send_failed",cl.active_user,{})}})(this);return bN.ajax_submit(e8,"/sm/quick_send",fc,fa,null,{fq_paths:e7.join(",")})},_update_file_area_view:function(){if(Object.keys(V._files).length){by("#quick-send-drop-area").hide();by("#quick-send-files-area").show()}else{by("#quick-send-drop-area").show();by("#quick-send-files-area").hide()}return V._toggle_send_button_state()},_toggle_top_area_view:function(){by("#quick-send-top-part-send").hide();by("#quick-send-top-part-confirm").show();return setTimeout(function(){by("#quick-send-top-part-send").show();return by("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var T;T=V.keep_visible||!!cl.inside_root_folder;return V._toggle_quick_send_module(T)},_toggle_quick_send_module:function(e8){var T,e7;if(V._visible===e8){return}e7=V.$content;if(e8){V._visible=true;e7.show();return V._update_collapsed_state()}else{V._visible=false;e7.hide();e7.removeClass("collapsed expanded");T=by("#browse-files");return T.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(fa){var e7,e9,T,e8;e9=V.$content;e8=fa?"collapsed":"expanded";if(e9.hasClass(e8)){return}T=fa?"expanded":"collapsed";e9.removeClass(T);e9.addClass(e8);e7=by("#browse-files");e8=fa?"quicksend-collapsed":"quicksend-expanded";T=fa?"quicksend-expanded":"quicksend-collpased";e7.removeClass(T);e7.addClass(e8);if(!fa){return V._init_autocompleter()}},_update_collapsed_state:function(){var T;T=Object.keys(V._files).length;return V._update_collapsed_view(T===0)},_remove_file:function(e7,T){var e8;e8=false;if(e7 in V._uploading_fileids){e8=true;document.fire(ct.CANCEL_EVT,{file:T});by(document).trigger(ct.CANCEL_EVT,{file:T});delete V._uploading_fileids[e7]}if(e7 in V._files){$(e7).remove();delete V._files[e7];V._update_upload_list_scroll();V._update_file_area_view();return V._update_collapsed_state()}},_reset:function(){var e7,e9,e8,T;V.autocompleter.clearTokens();e8=by(".quick-send-left-form")[0];e8.reset();T=[];for(e9 in V._files){e7=V._files[e9];T.push(V._remove_file(e9,e7.file_obj))}return T},_has_added_fq_path:function(e8){var T,e7;for(e7 in V._files){T=V._files[e7];if(T.fq_path===e8){return true}}return false},_update_upload_list_scroll:function(){var e7,T;e7=Object.keys(V._files).length;T=by("#quick-send-upload-files-list");if(e7<3){return T.removeClass("scroll")}else{T.addClass("scroll");return T.scrollTop=T.scrollHeight}},_add_file:function(e9,T){var fg,e8,ff,fd,fe,fa,e7,fh,fc,fb;fe={size:e9.bytes,source:T};a5.SharedFolderActivityLogger.log("web","quick_send_file_added",cl.active_user,fe);fg=e9.dest||V.DEST_FOLDER;fh=az.format_bytes(e9.bytes||0);fb=e2.tmpl("upload_list_item_tmpl");e8=fb({file:e9,icon:au.file_icon(e9.name),filename_snippet:bO.em_snippet(e9.name,dU.FILENAME_SNIPPET_LENGTH),size:fh,dest:fg,dest_snippet:bO.em_snippet(er("Dropbox")+fg,dU.DEST_SNIPPET_LENGTH,0),Sprite:cp});e7=cR.sanitize(e8.toHTML());by("#quick-send-upload-files-list").append(e7);ff=by("#"+e9.id);V._update_upload_list_scroll();ff.find(".dest-col").hide();ff.find(".time-col").hide();fc=ff.find(".status-col").find("a.small-x-button");fd=e9.id;fc.on("click",function(fi){return V._remove_file(fd,e9)});fa=ff.find(".remove-link");fa.on("click",function(fi){return V._remove_file(fd,e9)});ff.on("mouseenter",(function(fi){return function(fj){ff.find(".status-col").hide();return fa.show()}})(this));ff.on("mouseleave",(function(fi){return function(fj){ff.find(".status-col").show();return fa.hide()}})(this));V._files[e9.id]={file_div:e8,fq_path:e9.fq_path,bytes:e9.size,file_obj:e9};V._update_file_area_view();return V._update_collapsed_state()},_toggle_send_button_state:function(){var e8,T,e7;T=((e7=V.autocompleter)!=null?e7.token_manager.tokens.length:void 0)===0;T=T&&V.$collab_input.val()==="";e8=Object.keys(V._files).length===0||Object.keys(V._uploading_fileids).length>0;return V.$send_button.prop("disabled",T||e8)},_file_upload_errored:function(e8){var e7,T;e7=e8.memo.file;if(e7.id in V._uploading_fileids){T={message:e8.memo.message};a5.SharedFolderActivityLogger.log("web","quick_send_file_errored",cl.active_user,T);return delete V._uploading_fileids[e7.id]}},_file_upload_completed:function(e7){var T;T=e7.memo.file;if(T.id in V._uploading_fileids){a5.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",cl.active_user,{});delete V._uploading_fileids[T.id];return V._toggle_send_button_state()}},get_folder_name:function(e9){var e7,e8,T;if(V.DEST_FOLDER){e9();return}T=function(fb){var fa;fa=JSON.parse(fb);V.DEST_FOLDER=fa.folder_name;return e9()};e7=function(){return aa.error(er("We couldn\u2019t upload your file. Please try again."))};e8={};e8[Constants.UID_PARAM_NAME]=V.owner_id;return new cv.WebRequest({url:"/share/quick_send_folder_name",data:e8,success:T,error:e7})},is_quicksend_dest:function(T){var e7;e7=au.normalize(T);return e7===V.DEST_FOLDER},add_external_file:function(T){var e8,e7;e7=T.dest+T.name;if(V._has_added_fq_path(e7)){aa.success(er("You\u2019ve already added this file."));document.fire(ct.CANCEL_EVT,{file:T});by(document).trigger(ct.CANCEL_EVT,{file:T});return}T.fq_path=e7;T.bytes=T.size;V._uploading_fileids[T.id]=true;V._add_file(T,"external");e8=by("#"+T.id);return e8.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(T){var e7;if(T.dir){aa.error(er("Please select files instead of folders."));return}if(V._has_added_fq_path(T.fq_path)){aa.success(er("You\u2019ve already added this file."));return}T.name=T.filename;V._add_file(T,"dropbox");e7=by("#"+T.id);e7.find(".upload-progress-bar").css({width:"100%"});e7.addClass("complete");return setTimeout(function(){var e8;e8=e7.find(".status-col");e8.empty();return e8.append(cp.make("web","s_check"))},0)}};var dP,cm,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9},dl=function(T,e7){return function(){return T.apply(e7,arguments)}};dP=A.SharedLinkSettingsModal=(function(e7){cG(T,e7);function T(e8,e9){var fa;this.owner_id=e8;this.tkey=e9;fa={tkey:this.tkey};fa[Constants.UID_PARAM_NAME]=this.owner_id;T.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:fa})}return T})(cu);cm=A.SharedLinkSettingsModalContent=(function(){function T(e8,e9,e7,fb){var fc,fa;this.owner_id=e8;this.tkey=e9;this.filename=e7;this.saved_password_placeholder_value=fb;this._save_settings=dl(this._save_settings,this);this._toggle_password_input=dl(this._toggle_password_input,this);this._enable_password_input_for_editing=dl(this._enable_password_input_for_editing,this);this._date_change_callback=dl(this._date_change_callback,this);this._show_calendar=dl(this._show_calendar,this);this._hide_calendar=dl(this._hide_calendar,this);this._future_date=dl(this._future_date,this);this._enable_save_button=dl(this._enable_save_button,this);this._custom_expiry_click_handler=dl(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=dl(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=dl(this._show_custom_expiry_label,this);this._toggle_expiration=dl(this._toggle_expiration,this);this._expiry_picker_callback=dl(this._expiry_picker_callback,this);this._listen=dl(this._listen,this);this._detect_and_handle_blur_when_password_empty=dl(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=dl(this._is_clicked,this);this._change_password_click=dl(this._change_password_click,this);this._init_expiration_section=dl(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=by(".sharing-settings-modal-content");this.modal=dZ.get_containing_modal(this.$content);if(!this.modal){return}fa=er("'%(filename)s' permissions").format({filename:bO.em_snippet(this.filename,18)});this.modal.set_title(fa);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(fc=true)}this._init_expiration_section();this._listen()}T.prototype._init_expiration_section=function(){var e7;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){by("#expiration-yes").prop("checked",true);e7=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(e7);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};T.prototype._change_password_click=function(e7){e7.preventDefault();return this._enable_password_input_for_editing()};T.prototype._is_clicked=function(e7,e8){return e7.is(e8.target)||e7.has(e8.target).length};T.prototype._detect_and_handle_blur_when_password_empty=function(e7){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,e7)){return}return this._show_password_input(true)};T.prototype._listen=function(){if(this.loaded_with_saved_password){by(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(e7){return function(e8){return dS.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return by(window).on(bu.CHANGED,this._expiry_picker_callback)};T.prototype._expiry_picker_callback=function(fa,e9){var e7,e8;if(e9.clicked_val===e9.old_val){return}e7=e9.clicked_val;if(e7!=="custom"){e8=this._future_date(parseInt(e7));return this._set_expiration(e8)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};T.prototype._toggle_expiration=function(e9){var e8,e7;if(by(e9.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();y.controller(by(".expiration-picker")).set_value(30);e7=30;e8=this._future_date(e7);this._set_expiration(e8);return this._set_selected_date_text(e8)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};T.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return by(window).on("click",this._custom_expiry_click_handler)};T.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return by(window).off("click",this._custom_expiry_click_handler)};T.prototype._custom_expiry_click_handler=function(e7){if(this._is_clicked(this.$calendar,e7)){return}if(this.$selected_date_box.is(e7.target)||this.$selected_date_box.has(e7.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};T.prototype._enable_save_button=function(e7){return this.$save_button.removeAttr("disabled")};T.prototype._future_date=function(e7){var e8;e8=dX.start_of_day(new Date());e8.setDate(e8.getDate()+e7);return e8};T.prototype._hide_calendar=function(){return this.$calendar.hide()};T.prototype._show_calendar=function(){var e9,e8,e7;by(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){e7=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{e7=this._future_date(30)}e8={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:e7,onDateChange:by.proxy(this._date_change_callback,this)};this.calendar=new E("expiration-calendar-container",e8)}else{this.$calendar.show()}e9=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:e9})};T.prototype._posix_time_to_date=function(e7){return new Date(e7*1000)};T.prototype._set_selected_date_text=function(e7){return this.$selected_date.text(K.localize(e7))};T.prototype._set_expiration=function(e8){var e7,e9;cC(e8.getMilliseconds()===0);cC(e8.getSeconds()===0);cC(e8.getMinutes()===0);cC(e8.getHours()===0);e9=(e8.getTime()+this.MS_PER_DAY)/1000;e7=e9-1;return this.$expiry_posix.val(e7)};T.prototype._date_change_callback=function(e7){this._set_selected_date_text(e7);this._set_expiration(e7);this._enable_save_button();return this._hide_calendar()};T.prototype._show_password_input=function(fc){var fb,e9,e8,fa,e7;if(fc==null){fc=false}fb=this.$content.find("label[for=audience-password]").position().left;fa=this.$content.find("#audience-password").position().left;e9=fb-fa+10;this.$password.show().css({left:e9});this.$password_input.val("");if(fc){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");e7="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(e7).show();e8=this.$password.position();return this.$change_password.css({left:e8.left,top:e8.top}).show()}else{return this._enable_password_input_for_editing()}};T.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(er("Set password")).show();this.$password_input.focus();return this._enable_save_button()};T.prototype._toggle_password_input=function(e7){var e8;if(by(e7.currentTarget).attr("id")==="audience-password"){return this._show_password_input(e8=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};T.prototype._save_settings=function(fa){var e8,e7,e9,fb;if(this.$password_input.data("is-saved-password")==="yes"){e9={type:"hidden",name:"password",value:this.saved_password_placeholder_value};e8=by("<input />",e9);this.$form.append(e8);this.$password_input.attr("name","inoperative_password")}fb=(function(fc){return function(fd){dS.pop();return aa.success(er("Settings saved."))}})(this);e7=(function(fc){return function(fd){if(fc.$password.length&&fc.$password.is(":visible")){fc.$password_input.focus()}return bN.remove_loading()}})(this);return bN.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",fb,e7,this.$save_button[0])};return T})();var ew;ew=A.SimpleSharing=(function(){function T(){}T.createAndShowInbandModalFromBrowseFile=function(e7,e8){return T.createAndShowInbandModal(e7,e8.fq_path,e8.dir,e8.target_ns,e8.is_shared_folder(),e8.could_be_shared_folder(),parseInt(e8.sf_perm_role))};T.createAndShowInbandModal=function(fa,ff,fe,fg,fd,fi,fj){var e9,fh,e8,fc,fb,e7;e9=function(fl,fm,fk){return window.INLINE_JS.DBModalStack.push(new c7(fl,fm,false,false,fk))};e7=function(fl,fm,fk){return window.INLINE_JS.DBModalStack.push(new bX(fl,{element_id:"unshare-confirm-modal",team_shared_folder:false,ns_id:fk,folder_path:fm}))};e8=function(fl,fm,fk,fo,fn){return window.INLINE_JS.DBModalStack.push(new eH(fl,{element_id:"kick-confirm-modal",ns_id:fk,user_name:fn,folder_path:fm,user_id:fo}))};fh=function(fl,fn,fk,fm,fo){return window.INLINE_JS.DBModalStack.push(new aN(fl,{element_id:"kick-group-confirm-modal",ns_id:fk,group_name:fo,folder_path:fn,group_id:fm}))};fb=function(fl,fm,fk,fo,fn){return window.INLINE_JS.DBModalStack.push(new aC(fl,{element_id:"uninvite-confirm-modal",email_or_fbname:fn,ns_id:fk,invite_id:fo,folder_path:fm}))};fc=function(fl,fm,fk){return dS.push(new dk(fl,{element_id:"leave-confirm-modal",ns_id:fk,folder_path:fm}))};return dG.createAndShowModal(fa,ff,e9,e7,e8,fh,fb,fc,Boolean(fe),fg,fd,fi,parseInt(fj),cl.simple_sharing_react_memeber_list_enabled)};return T})();var eq,en;en=A.FoshmodalPanes=Object.clone(df);en.to_title_str=function(){var T,e7,fb,e9,fa,e8;if(eq.sharing_collection){e9=bO.em_snippet(eq.collection_to_share.name,18,1);return er("Share '%(snippeted_name)s'").format({snippeted_name:e9})}else{T=eq._selection;e8=c0.categorize_files(T),e7=e8[0],fb=e8[1];if(e7&&fb){fa=a6("Share %(file_count)s item","Share %(file_count)s items",T.length)}else{if(e7){fa=a6("Share %(file_count)s photo","Share %(file_count)s photos",T.length)}else{fa=a6("Share %(file_count)s video","Share %(file_count)s videos",T.length)}}fa=fa.format({file_count:T.length});return fa}};eq=INLINE_JS.Foshmodal=A.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:en.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=en.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eL.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();by(".link-image").attr("src","static/images/empty_album_big.png");bN.remove_loading(by("#modal").find(".tokenizer-submit-button")[0]);bN.remove_loading(by("#modal").find(".foshmodal-copy-link")[0]);bN.remove_loading(by("#shmodal-twitter-post-submit")[0]);return bN.remove_loading(by("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(T){var e7;cC(this._selection.length,"This should never be called with an empty selection");cC(this.current_tkey!=null,"Missing tkey");cC(this.current_shmodel_url!=null,"Missing shmodel url");cC(this.current_short_url!=null,"Missing short url");cC(T!=null,"Missing collection info");T.is_anonymous=this.creating_anonymous_collection();T.share_tkey=this.current_tkey;T.shmodel_url=this.current_shmodel_url;T.short_url=this.current_short_url;return e7=new Y(T)},set_shmodel_url:function(e7,T){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof e7==="function"?e7():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(e8){return function(fa){var e9;e9=JSON.parse(fa.responseText);e8.current_shmodel_url=e9.token_link;e8.current_short_url=e9.short_link;e8.current_tkey=e9.tkey;if(typeof e7==="function"){e7()}return typeof e8.callback_for_when_we_have_shmodel_url==="function"?e8.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof T==="function"?T():void 0}})}},attach_collection_to_token:function(e7,T){cC(this.collection_to_share!=null,"Should get called only when there is an existing collection");cC(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof e7==="function"){e7(this.collection_to_share.gid)}return}cC(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,e7,T)},create_collection_and_attach_to_token:function(fb,T){var e8,fa,e9,e7;cC(this.sharing_collection===false,"Should not get called when we already have a collection");cC(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");fa=(function(fc){return function(fd){var fe;fe=JSON.parse(fd.responseText);fc.create_album_from_selected_photos(fe);return typeof fb==="function"?fb(fe.gid):void 0}})(this);e8=function(fc){return typeof T==="function"?T(fc):void 0};e9={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var ff,fd,fe,fc;fe=this._selection;fc=[];for(ff=0,fd=fe.length;ff<fd;ff++){e7=fe[ff];fc.push(e7.item_counter)}return fc}).call(this)),source_collection_gid:bK.get_current_collection_gid()};return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:fa,onFailure:e8,parameters:e9})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){aa.error(er("Please enter a name for this album"));this.unlock();return true}if(cz.collection_name_in_use(this.current_album_name)){aa.error(er("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(e8){var e7,T;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}e7=$("shmodal-send-form");cC(e7,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}T=(function(e9){return function(fa){e9.unlock();if(!fa.responseText.startsWith("err:")){aa.error(er("We couldn't send this album. Please try again."));eY.hide();return e9.refresh()}}})(this);if(this.sharing_collection){this.send_collection(e7,T)}else{this.send_selection(e7,T)}return g.log_interaction(ee.SEND,c3.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var e9,e7,e8,T,fa;e9=this.get_current_display_name();T=af.get_shmodel_send_recipients($("shmodal-send-form"));e7=T[0].split(" ")[0];if(T.length===1){fa=er("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:e9,first_name_of_recipient:e7})}else{if(T.length===2){e8=T[1].split(" ")[0];fa=er("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:e9,first_name_of_recipient:e7,first_name_of_second_recipient:e8})}else{fa=er("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:e9,first_name_of_recipient:e7,num_other_recipients:T.length-1})}}return fa},send_selection:function(e8,e7){var fa,e9,T;fa=(function(fb){return function(fc){var fd;fd=JSON.parse(fc.responseText);fb.create_album_from_selected_photos(fd);aa.success(fb.get_send_success_text());fb.refresh();return eY.hide()}})(this);e9={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var fe,fc,fd,fb;fd=this._selection;fb=[];for(fe=0,fc=fd.length;fe<fc;fe++){T=fd[fe];fb.push(T.item_counter)}return fb}).call(this)),source_collection_gid:bK.get_current_collection_gid()};if(this.creating_anonymous_collection()){e9.collection_name=""}else{if(this.current_album_name.trim().length===0){e9.collection_name=cz.get_default_album_name()}}return bN.ajax_submit(e8,"/collection_create_and_send_link",fa,e7,e8.down(".tokenizer-submit-button"),e9)},send_collection:function(e7,T){var e8;cC(this.current_tkey!=null,"tkey should be set");cC(this.current_shmodel_url!=null,"shmodel url should be set");e8=(function(e9){return function(){aa.success(e9.get_send_success_text());eY.hide();return e9.refresh()}})(this);return this.collection_to_share.send_link(e7,this.current_tkey,this.current_shmodel_url,this.current_short_url,e8,T)},get_link_button_onclick:function(){var T,e8,e7;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}e7=$("modal").down(".tokenizer-submit-button");e8=(function(e9){return function(fb){var fa;fa=e9.get_current_display_name();if(FlashDetect.installed){aa.success(er("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:fa}))}e9.show_get_link_modal(e9.current_shmodel_url,fa,fb);a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(e9.collection_to_share!=null){cr.log_share("share_link",fb,e9.num_photos_to_share,e9.creating_anonymous_collection(),!e9.sharing_collection)}return e9.refresh()}})(this);T=(function(e9){return function(fa){e9.unlock();bN.remove_loading(e7);if(!fa.responseText.startsWith("err")){aa.error(er("We couldn't create a link to this album. Please try again."));eY.hide();return e9.refresh()}}})(this);if(this.sharing_collection){bN.add_loading(e7);this.attach_collection_to_token(e8,T)}else{if(this.alert_if_album_name_invalid()){return}bN.add_loading(e7);this.create_collection_and_attach_to_token(e8,T)}return g.log_interaction(ee.GET_LINK,c3.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var T,e7;if(FlashDetect.installed){T=p.clipboard_overlay(this.current_shmodel_url,by("#foshmodal-copy-link"),eq.get_link_button_onclick.bind(this));T.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);e7=(function(e8){return function(){return T.clonePosition(by("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(e7,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(fb,e7){var fa,e8,T,e9;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(fb,e7);return}fa=by("#modal:visible, #modal-overlay:visible");T=function(){return fa.show()};e8=(function(fc){return function(){fc.lock();setTimeout(fc.unlock.bind(fc),750);return ej.do_auth((function(){return fc.do_fb_post(e7)}),e7)}})(this);if(ej.authed_user_id===e7){this.do_fb_post(e7)}else{if(cD.get_viewer().is_uid_associated(ej.authed_user_id)){this.unlock();fa.hide();e9=new d5(cD.get_viewer().get_user_by_id(e7),T,e8.bind(this));e9.show()}else{e8()}}return g.log_interaction(ee.FB_SHARE,c3.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(e7,T){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(e7,T);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(cw.is_authed(T)){this.do_twitter_post(T)}else{setTimeout(this.unlock.bind(this),750);cw.do_auth(((function(e8){return function(){return e8.do_twitter_post(T)}})(this)),T)}return g.log_interaction(ee.TWITTER_SHARE,c3.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(T){var e7,e8;e7=(function(e9){return function(){aa.error(er("We couldn't share this album on Facebook. Please try again."));eY.hide();return e9.refresh()}})(this);e8=(function(e9){return function(fb){var fa;ej.custom_show_posting=function(){return bN.add_loading($("shmodal-fb-post-submit"))};ej.progress_container=$("modal").down(".modal-buttons");fa=e9.get_current_display_name();ej.custom_show_complete=function(){eY.hide();aa.success(er("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:fa}));return e9.refresh()};ej.post($F("shmodal-fb-post-input"),e9.current_shmodel_url,null,null,null,e7,T);a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return cr.log_share("share_facebook",fb,e9.num_photos_to_share,e9.creating_anonymous_collection(),!e9.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(e8,e7)}else{return this.create_collection_and_attach_to_token(e8,e7)}},do_twitter_post:function(T){var e9,e7,e8;e9=$F("shmodal-twitter-post-input");if(!e9){aa.error(er("Please enter a tweet"));this.unlock();return}if(e9.length>140){aa.error(er("Your tweet must be 140 characters or less"));this.unlock();return}e8=(function(fa){return function(fb){cw.custom_show_posting=function(){$("twitter-chars").hide();return bN.add_loading($("shmodal-twitter-post-submit"))};cw.custom_post(e9,function(){eY.hide();aa.success(er("Your tweet has been posted!"));return fa.refresh()},T);a5.ViralLogger.log(cD.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return cr.log_share("share_twitter",fb,fa.num_photos_to_share,fa.creating_anonymous_collection(),!fa.sharing_collection)}})(this);e7=(function(fa){return function(){aa.error(er("We couldn't share this album on Twitter. Please try again."));eY.hide();return fa.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(e8,e7)}else{return this.create_collection_and_attach_to_token(e8,e7)}},show_get_link_modal:function(e7,T,e8){var e9;eY.show(er("Link to %(album_name)s").format({album_name:T.escapeHTML()}),$("get-link-modal"));e9=$("get-link-modal").down(".link-input");e9.setValue(e7);e9.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(e7,"_blank");return eY.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(e8!=null){cz.flash_sidebar_album(e8)}return eY.hide()}},update_current_album_name_text:function(T){this.current_album_name=$(en.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===en.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(fa){var e7,e9,e8,T;T=this.sharing_collection?bK.get_timeline().get_photos():this._selection;if(fa){if(this.num_photos_to_share===1){e7=fa}else{e7=er("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:fa,album_desc:c0.file_desc(T)})}}else{if(T.length===1){e8=T[0];if(e8.preview_type==="photo"){e9=er("Photo from %(date_taken)s")}else{e9=er("Video from %(date_taken)s")}e7=e9.format({date_taken:bY.nice_date_with_month_name(new Date(e8.time_taken),true,true,true)})}else{e7=c0.file_desc(T)}}return $(en.to_content_str(en.FB)).down(".link-name").__date(e7)},set_current_album_name_text:function(e7,T){$(en.to_content_str(e7)).down(".album-name-input").value=T;if(e7===en.FB){return this.set_fb_post_title(T)}},show_content:function(fa){var e7,e9,T,e8;if(this.working){return}$("shmodal-title-text").__date(en.to_title_str());e8=en.list;for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];if(e7!==fa){$(en.to_toggle_str(e7)).removeClassName("toggled");$(en.to_content_str(e7)).hide()}}$(en.to_content_str(fa)).show();$(en.to_toggle_str(fa)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(fa,this.current_album_name)}switch(fa){case en.FB:$("shmodal-fb-post-input").focus();break;case en.TWITTER:$("shmodal-twitter-post-input").focus();break;case en.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=fa},_get_foshmodal_title:function(){return af.generate_title_content(en.to_title_str(),((function(T){return function(){return T.show_content(en.SEND)}})(this)),((function(T){return function(){return T.show_content(en.FB)}})(this)),((function(T){return function(){return T.show_content(en.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return c0.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var T,e8,e7,fa,e9;T=this.sharing_collection?bK.get_timeline().get_photos():this._selection;if(T.length===1){e9=c0.categorize_files(T),e7=e9[0],fa=e9[1];if(e7){e8=er("Just shared a photo using @Dropbox")}else{if(fa){e8=er("Just shared a video using @Dropbox")}else{cC(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{e8=er("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+e8+" "+this.current_short_url)},update_shmodal_image_text:function(){var fd,fg,ff,fb,fa,fe,T,fc,e9,e8,e7;if(this.sharing_collection){fg=this.collection_to_share.num_items;ff=c0.album_desc(this.collection_to_share,false,true)}else{fg=this._selection.length;ff=c0.file_desc(this._selection,false,true)}if(fg>1){fc=$$(".shmodal-image");e8=[];for(fb=0,fe=fc.length;fb<fe;fb++){fd=fc[fb];fd.down("span").__date(ff);e8.push(fd.down(".share-file-count").show())}return e8}else{e9=$$(".shmodal-image");e7=[];for(fa=0,T=e9.length;fa<T;fa++){fd=e9[fa];e7.push(fd.down(".share-file-count").hide())}return e7}},show:function(fe,fl){var ff,fi,fj,fg,fk,fc,fb,e9,fh,e7,T,fd,fa,e8;this.unlock();eY.onHide=(function(fm){return function(){var fo,fn;if((fo=$("flash_copy_container"))!=null){fo.remove()}if((fn=fm.send_link_autocompleter)!=null){fn.hide()}by("#modal").find(".new-collab-input").val("");clearInterval(fm.follow_freshbutton);bK.disable_selection();delete eY.onHide;return eY.hide()}})(this);this.sharing_collection=fl;fk=this.sharing_collection?fe.thumbnail_url_256:fe[0].thumbnail_url;fd=$$(".link_image");for(fc=0,fh=fd.length;fc<fh;fc++){fi=fd[fc];if(fk!=null){fi.src=fk}else{fi.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=en.SEND;this.have_real_tkey=this.sharing_collection&&(fe.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=fe;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=fe.sort(function(fn,fm){return fn.time_taken-fm.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");fa=$$(".save-as-album-checkbox");for(fb=0,e7=fa.length;fb<e7;fb++){ff=fa[fb];ff.checked=false;fg=(function(fm){return function(fv){var fw,fs,fq,fo,fn,fr,fp,fu,ft;if(fv.target.checked){$("shmodal").addClassName("saving-as-album");fm.current_album_name=fm.previous_album_name||cz.get_default_album_name();fm.set_current_album_name_text(fm.current_foshmodal_pane,fm.current_album_name);fw=$(en.to_content_str(fm.current_foshmodal_pane)).down(".album-name-input");fw.focus();fw.select();fr=$$(".save-as-album-checkbox");fu=[];for(fs=0,fo=fr.length;fs<fo;fs++){ff=fr[fs];fu.push(ff.checked=true)}return fu}else{$("shmodal").removeClassName("saving-as-album");fm.previous_album_name=fm.current_album_name;fm.current_album_name="";fm.set_current_album_name_text(fm.current_foshmodal_pane,fm.current_album_name);fp=$$(".save-as-album-checkbox");ft=[];for(fq=0,fn=fp.length;fq<fn;fq++){ff=fp[fq];ft.push(ff.checked=false)}return ft}}})(this);ff.observe("change",fg);if(bV.msie_version_at_most(8)){ff.observe("click",fg)}}e8=$$(".album-name-input");for(e9=0,T=e8.length;e9<T;e9++){fj=e8[e9];fj.observe("keyup",this.update_current_album_name_text.bind(this))}}bK.enable_selection();eY.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(fm){return function(){fm.initialize_get_link_button();return fm.set_twitter_message()}})(this)),(function(){aa.error(er("This request could not be completed.  Please try again."));return eY.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cD.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();Q.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return dX._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(e7,fc){var e9={};function e8(fh,fi){var fg,fe=[];for(var ff=0;ff<fh.length;++ff){fg=e9[fh[ff]]||fa(fh[ff]);if(!fg){throw"module definition dependecy not found: "+fh[ff]}fe.push(fg)}fi.apply(null,fe)}function fd(fg,ff,fe){if(typeof fg!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(ff===fc){throw"invalid module definition, dependencies must be specified"}if(fe===fc){throw"invalid module definition, definition function must be specified"}e8(ff,function(){e9[fg]=fe.apply(null,arguments)})}function fb(fe){return !!e9[fe]}function fa(fh){var ff=e7;var fe=fh.split(/[.\/]/);for(var fg=0;fg<fe.length;++fg){if(!ff[fe[fg]]){return}ff=ff[fe[fg]]}return ff}function T(fg){for(var ff=0;ff<fg.length;ff++){var fh=e7;var fk=fg[ff];var fe=fk.split(/[.\/]/);for(var fj=0;fj<fe.length-1;++fj){if(fh[fe[fj]]===fc){fh[fe[fj]]={}}fh=fh[fe[fj]]}fh[fe[fe.length-1]]=e9[fk]}}fd("moxie/core/utils/Basic",[],function(){var fm=function(fr){var fq;if(fr===fq){return"undefined"}else{if(fr===null){return"null"}else{if(fr.nodeType){return"node"}}}return({}).toString.call(fr).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var fi=function(fr){var fq;fk(arguments,function(fs,ft){if(ft>0){fk(fs,function(fv,fu){if(fv!==fq){if(fm(fr[fu])===fm(fv)&&!!~fo(fm(fv),["array","object"])){fi(fr[fu],fv)}else{fr[fu]=fv}}})}});return fr};var fk=function(fv,fw){var fu,fs,fr,ft;if(fv){try{fu=fv.length}catch(fq){fu=ft}if(fu===ft){for(fs in fv){if(fv.hasOwnProperty(fs)){if(fw(fv[fs],fs)===false){return}}}}else{for(fr=0;fr<fu;fr++){if(fw(fv[fr],fr)===false){return}}}}};var fn=function(fq){var fr;if(!fq||fm(fq)!=="object"){return true}for(fr in fq){return false}return true};var fg=function(fr,fq){var fs=0,ft=fr.length;if(fm(fq)!=="function"){fq=function(){}}if(!fr||!fr.length){fq()}function fu(fv){if(fm(fr[fv])==="function"){fr[fv](function(fw){++fv<ft&&!fw?fu(fv):fq(fw)})}}fu(fs)};var fo=function(fs,ft){if(ft){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(ft,fs)}for(var fq=0,fr=ft.length;fq<fr;fq++){if(ft[fq]===fs){return fq}}}return -1};var fl=function(fr,ft){var fs=[];if(fm(fr)!=="array"){fr=[fr]}if(fm(ft)!=="array"){ft=[ft]}for(var fq in fr){if(fo(fr[fq],ft)===-1){fs.push(fr[fq])}}return fs.length?fs:false};var fp=function(fs,fr){var fq=[];fk(fs,function(ft){if(fo(ft,fr)!==-1){fq.push(ft)}});return fq.length?fq:null};var fh=function(fs){var fr,fq=[];for(fr=0;fr<fs.length;fr++){fq[fr]=fs[fr]}return fq};var fj=(function(){var fq=0;return function(ft){var fr=new Date().getTime().toString(32),fs;for(fs=0;fs<5;fs++){fr+=Math.floor(Math.random()*65535).toString(32)}return(ft||"o_")+fr+(fq++).toString(32)}}());var fe=function(fq){if(!fq){return fq}return String.prototype.trim?String.prototype.trim.call(fq):fq.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var ff=function(fq){if(typeof(fq)!=="string"){return fq}var fs={t:1099511627776,g:1073741824,m:1048576,k:1024},fr;fq=/^([0-9]+)([mgk]?)$/.exec(fq.toLowerCase().replace(/[^0-9mkg]/g,""));fr=fq[2];fq=+fq[1];if(fs.hasOwnProperty(fr)){fq*=fs[fr]}return fq};return{guid:fj,typeOf:fm,extend:fi,each:fk,isEmptyObj:fn,inSeries:fg,inArray:fo,arrayDiff:fl,arrayIntersect:fp,toArray:fh,trim:fe,parseSizeStr:ff}});fd("moxie/core/I18n",["moxie/core/utils/Basic"],function(ff){var fe={};return{addI18n:function(fg){return ff.extend(fe,fg)},translate:function(fg){return fe[fg]||fg},_:function(fg){return this.translate(fg)},sprintf:function(fi){var fh=[].slice.call(arguments,1),fg="";ff.each(fi.split(/%[a-z]/),function(fj){fg+=fj;if(fh.length){fg+=fh.shift()}});return fg}}});fd("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(fh,fg){var fe="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var ff={mimes:{},extensions:{},addMimeType:function(fi){var fj=fi.split(/,/),fk,fm,fl;for(fk=0;fk<fj.length;fk+=2){fl=fj[fk+1].split(/ /);for(fm=0;fm<fl.length;fm++){this.mimes[fl[fm]]=fj[fk]}this.extensions[fj[fk]]=fl}},extList2mimes:function(fo,fp){var fj=this,fn,fk,fm,fl,fi=[];for(fk=0;fk<fo.length;fk++){fn=fo[fk].extensions.split(/\s*,\s*/);for(fm=0;fm<fn.length;fm++){if(fn[fm]==="*"){return[]}fl=fj.mimes[fn[fm]];if(!fl){if(fp&&/^\w+$/.test(fn[fm])){fi.push("."+fn[fm])}else{return[]}}else{if(fh.inArray(fl,fi)===-1){fi.push(fl)}}}}return fi},mimes2exts:function(fi){var fj=this,fk=[];fh.each(fi,function(fm){if(fm==="*"){fk=[];return false}var fl=fm.match(/^(\w+)\/(\*|\w+)$/);if(fl){if(fl[2]==="*"){fh.each(fj.extensions,function(fn,fo){if((new RegExp("^"+fl[1]+"/")).test(fo)){[].push.apply(fk,fj.extensions[fo])}})}else{if(fj.extensions[fm]){[].push.apply(fk,fj.extensions[fm])}}}});return fk},mimes2extList:function(fi){var fk=[],fj=[];if(fh.typeOf(fi)==="string"){fi=fh.trim(fi).split(/\s*,\s*/)}fj=this.mimes2exts(fi);fk.push({title:fg.translate("Files"),extensions:fj.length?fj.join(","):"*"});fk.mimes=fi;return fk},getFileExtension:function(fj){var fi=fj&&fj.match(/\.([^.]+)$/);if(fi){return fi[1].toLowerCase()}return""},getFileMime:function(fi){return this.mimes[this.getFileExtension(fi)]||""}};ff.addMimeType(fe);return ff});fd("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(fk){var fg=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],fi=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],ff;function fj(fn){var fo,fp;for(var fm=0;fm<fn.length;fm++){fo=fn[fm].s1;fp=fn[fm].prop;ff=fn[fm].sv||fn[fm].id;if(fo){if(fo.indexOf(fn[fm].s2)!=-1){return fn[fm].id}}else{if(fp){return fn[fm].id}}}}function fl(fn){var fm=fn.indexOf(ff);if(fm==-1){return}return parseFloat(fn.substring(fm+ff.length+1))}var fh=(function(){var fm={define_property:(function(){return false}()),create_canvas:(function(){var fn=document.createElement("canvas");return !!(fn.getContext&&fn.getContext("2d"))}()),return_response_type:function(fn){try{if(fk.inArray(fn,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var fp=new XMLHttpRequest();fp.open("get","/");if("responseType" in fp){fp.responseType=fn;if(fp.responseType!==fn){return false}return true}}}}catch(fo){}return false},use_data_uri:(function(){var fn=new Image();fn.onload=function(){fm.use_data_uri=(fn.width===1&&fn.height===1)};setTimeout(function(){fn.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return fm.use_data_uri&&(fe.browser!=="IE"||fe.version>=9)},use_data_uri_of:function(fn){return(fm.use_data_uri&&fn<33000||fm.use_data_uri_over32kb())},use_fileinput:function(){var fn=document.createElement("input");fn.setAttribute("type","file");return !fn.disabled}};return function(fo){var fn=[].slice.call(arguments);fn.shift();return fk.typeOf(fm[fo])==="function"?fm[fo].apply(this,fn):!!fm[fo]}}());var fe={can:fh,browser:fj(fg),version:fl(navigator.userAgent)||fl(navigator.appVersion),OS:fj(fi),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return fe});fd("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(ff){var fg=function(fm){if(typeof fm!=="string"){return fm}return document.getElementById(fm)};var fh=function(fo,fn){var fm;if(fo.className===""){return false}fm=new RegExp("(^|\\s+)"+fn+"(\\s+|$)");return fm.test(fo.className)};var fi=function(fn,fm){if(!fh(fn,fm)){fn.className=fn.className===""?fm:fn.className.replace(/\s+$/,"")+" "+fm}};var fl=function(fo,fn){var fm=new RegExp("(^|\\s+)"+fn+"(\\s+|$)");fo.className=fo.className.replace(fm,function(fq,fp,fr){return fp===" "&&fr===" "?" ":""})};var fe=function(fn,fm){if(fn.currentStyle){return fn.currentStyle[fm]}else{if(window.getComputedStyle){return window.getComputedStyle(fn,null)[fm]}}};var fk=function(fn,fr){var fs=0,fq=0,fu,ft=document,fo,fp;fn=fn;fr=fr||ft.body;function fm(fy){var fw,fx,fv=0,fz=0;if(fy){fx=fy.getBoundingClientRect();fw=ft.compatMode==="CSS1Compat"?ft.documentElement:ft.body;fv=fx.left+fw.scrollLeft;fz=fx.top+fw.scrollTop}return{x:fv,y:fz}}if(fn&&fn.getBoundingClientRect&&ff.browser==="IE"&&(!ft.documentMode||ft.documentMode<8)){fo=fm(fn);fp=fm(fr);return{x:fo.x-fp.x,y:fo.y-fp.y}}fu=fn;while(fu&&fu!=fr&&fu.nodeType){fs+=fu.offsetLeft||0;fq+=fu.offsetTop||0;fu=fu.offsetParent}fu=fn.parentNode;while(fu&&fu!=fr&&fu.nodeType){fs-=fu.scrollLeft||0;fq-=fu.scrollTop||0;fu=fu.parentNode}return{x:fs,y:fq}};var fj=function(fm){return{w:fm.offsetWidth||fm.clientWidth,h:fm.offsetHeight||fm.clientHeight}};return{get:fg,hasClass:fh,addClass:fi,removeClass:fl,getStyle:fe,getPos:fk,getSize:fj}});fd("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(ff){function fe(fi,fh){var fg;for(fg in fi){if(fi[fg]===fh){return fg}}return null}return{RuntimeError:(function(){var fg={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function fh(fi){this.code=fi;this.name=fe(fg,fi);this.message=this.name+": RuntimeError "+this.code}ff.extend(fh,fg);fh.prototype=Error.prototype;return fh}()),OperationNotAllowedException:(function(){function fg(fh){this.code=fh;this.name="OperationNotAllowedException"}ff.extend(fg,{NOT_ALLOWED_ERR:1});fg.prototype=Error.prototype;return fg}()),ImageError:(function(){var fg={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function fh(fi){this.code=fi;this.name=fe(fg,fi);this.message=this.name+": ImageError "+this.code}ff.extend(fh,fg);fh.prototype=Error.prototype;return fh}()),FileException:(function(){var fg={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function fh(fi){this.code=fi;this.name=fe(fg,fi);this.message=this.name+": FileException "+this.code}ff.extend(fh,fg);fh.prototype=Error.prototype;return fh}()),DOMException:(function(){var fg={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function fh(fi){this.code=fi;this.name=fe(fg,fi);this.message=this.name+": DOMException "+this.code}ff.extend(fh,fg);fh.prototype=Error.prototype;return fh}()),EventException:(function(){function fg(fh){this.code=fh;this.name="EventException"}ff.extend(fg,{UNSPECIFIED_EVENT_TYPE_ERR:0});fg.prototype=Error.prototype;return fg}())}});fd("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(fe,ff){function fg(){var fh={};ff.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=ff.guid("uid_")}},addEventListener:function(fm,fl,fj,fk){var fi=this,fo;fm=ff.trim(fm);if(/\s/.test(fm)){ff.each(fm.split(/\s+/),function(fn){fi.addEventListener(fn,fl,fj,fk)});return}fm=fm.toLowerCase();fj=parseInt(fj,10)||0;fo=fh[this.uid]&&fh[this.uid][fm]||[];fo.push({fn:fl,priority:fj,scope:fk||this});if(!fh[this.uid]){fh[this.uid]={}}fh[this.uid][fm]=fo},hasEventListener:function(fi){return fi?!!(fh[this.uid]&&fh[this.uid][fi]):!!fh[this.uid]},removeEventListener:function(fk,fj){fk=fk.toLowerCase();var fl=fh[this.uid]&&fh[this.uid][fk],fi;if(fl){if(fj){for(fi=fl.length-1;fi>=0;fi--){if(fl[fi].fn===fj){fl.splice(fi,1);break}}}else{fl=[]}if(!fl.length){delete fh[this.uid][fk];if(ff.isEmptyObj(fh[this.uid])){delete fh[this.uid]}}}},removeAllEventListeners:function(){if(fh[this.uid]){delete fh[this.uid]}},dispatchEvent:function(fo){var fn,fp,fm,fl,fk={},fj=true;if(ff.typeOf(fo)!=="string"){fl=fo;if(ff.typeOf(fl.type)==="string"){fo=fl.type;if(fl.total&&fl.loaded){fk.total=fl.total;fk.loaded=fl.loaded}fk.async=fl.async||false}else{throw new fe.EventException(fe.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(fo.indexOf("::")!==-1){(function(fq){fn=fq[0];fo=fq[1]}(fo.split("::")))}else{fn=this.uid}fo=fo.toLowerCase();fp=fh[fn]&&fh[fn][fo];if(fp){fp.sort(function(fr,fq){return fq.priority-fr.priority});fm=[].slice.call(arguments);fm.shift();fk.type=fo;fm.unshift(fk);var fi=[];ff.each(fp,function(fq){fm[0].target=fq.scope;if(fk.async){fi.push(function(fr){setTimeout(function(){fr(fq.fn.apply(fq.scope,fm)===false)},1)})}else{fi.push(function(fr){fr(fq.fn.apply(fq.scope,fm)===false)})}});if(fi.length){ff.inSeries(fi,function(fq){fj=!fq})}}return fj},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(fi){var fk;if(ff.typeOf(fi)!=="array"){fi=[fi]}for(var fj=0;fj<fi.length;fj++){fk="on"+fi[fj];if(ff.typeOf(this[fk])==="function"){this.addEventListener(fi[fj],this[fk])}else{if(ff.typeOf(this[fk])==="undefined"){this[fk]=null}}}}})}fg.instance=new fg();return fg});fd("moxie/core/utils/Encode",[],function(){var fg=function(fi){return unescape(encodeURIComponent(fi))};var fh=function(fi){return decodeURIComponent(escape(fi))};var ff=function(fp,fu){if(typeof(window.atob)==="function"){return fu?fh(window.atob(fp)):window.atob(fp)}var fl="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var fk,fj,fi,ft,fs,fr,fq,fv,fo=0,fw=0,fm="",fn=[];if(!fp){return fp}fp+="";do{ft=fl.indexOf(fp.charAt(fo++));fs=fl.indexOf(fp.charAt(fo++));fr=fl.indexOf(fp.charAt(fo++));fq=fl.indexOf(fp.charAt(fo++));fv=ft<<18|fs<<12|fr<<6|fq;fk=fv>>16&255;fj=fv>>8&255;fi=fv&255;if(fr==64){fn[fw++]=String.fromCharCode(fk)}else{if(fq==64){fn[fw++]=String.fromCharCode(fk,fj)}else{fn[fw++]=String.fromCharCode(fk,fj,fi)}}}while(fo<fp.length);fm=fn.join("");return fu?fh(fm):fm};var fe=function(fq,fv){if(fv){fg(fq)}if(typeof(window.btoa)==="function"){return window.btoa(fq)}var fm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var fl,fk,fj,fu,ft,fs,fr,fw,fp=0,fx=0,fo="",fn=[];if(!fq){return fq}do{fl=fq.charCodeAt(fp++);fk=fq.charCodeAt(fp++);fj=fq.charCodeAt(fp++);fw=fl<<16|fk<<8|fj;fu=fw>>18&63;ft=fw>>12&63;fs=fw>>6&63;fr=fw&63;fn[fx++]=fm.charAt(fu)+fm.charAt(ft)+fm.charAt(fs)+fm.charAt(fr)}while(fp<fq.length);fo=fn.join("");var fi=fq.length%3;return(fi?fo.slice(0,fi-3):fo)+"===".slice(fi||3)};return{utf8_encode:fg,utf8_decode:fh,atob:ff,btoa:fe}});fd("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(fi,fh,fj){var fe={},ff={};function fg(fs,fp,fn,fl,fo){var fr=this,fk,fq=fi.guid(fp+"_");function fm(ft,fu){var fw=null,fv=fs&&fs.required_caps;fu=fu||"browser";if(this.mode!==null){return this.mode}if(fv&&!fi.isEmptyObj(ft)){fi.each(fv,function(fz,fx){if(ft.hasOwnProperty(fx)){var fy=ft[fx](fz);if(typeof(fy)==="string"){fy=[fy]}if(!fw){fw=fy}else{if(!(fw=fi.arrayIntersect(fw,fy))){return(fw=false)}}}});if(fw){this.mode=fi.inArray(fu,fw)!==-1?fu:fw[0]}else{if(fw===false){this.mode=false}}}if(this.mode===null){this.mode=fu}if(this.mode&&fv&&!this.can(fv)){this.mode=false}}ff[fq]=this;fn=fi.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},fn);fk=(function(){var ft={};return{exec:function(fw,fu,fx,fv){if(fk[fu]){if(!ft[fw]){ft[fw]={context:this,instance:new fk[fu]()}}if(ft[fw].instance[fx]){return ft[fw].instance[fx].apply(this,fv)}}},removeInstance:function(fu){delete ft[fu]},removeAllInstances:function(){var fu=this;fi.each(ft,function(fw,fv){if(fi.typeOf(fw.instance.destroy)==="function"){fw.instance.destroy.call(fw.context)}fu.removeInstance(fv)})}}}());fi.extend(this,{initialized:false,uid:fq,type:fp,mode:null,shimid:fq+"_container",clients:0,options:fs,can:function(fv,fw){var ft=arguments[2]||fn;if(fi.typeOf(fv)==="string"&&fi.typeOf(fw)==="undefined"){fv=fg.parseCaps(fv)}if(fi.typeOf(fv)==="object"){for(var fu in fv){if(!this.can(fu,fv[fu],ft)){return false}}return true}if(fi.typeOf(ft[fv])==="function"){return ft[fv].call(this,fw)}else{return(fw===ft[fv])}},getShimContainer:function(){var ft,fu=fh.get(this.shimid);if(!fu){ft=this.options.container?fh.get(this.options.container):document.body;fu=document.createElement("div");fu.id=this.shimid;fu.className="moxie-shim moxie-shim-"+this.type;fi.extend(fu.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});ft.appendChild(fu);ft=null}return fu},getShim:function(){return fk},shimExec:function(fu,fv){var ft=[].slice.call(arguments,2);return fr.getShim().exec.call(this,this.uid,fu,fv,ft)},exec:function(fu,fv){var ft=[].slice.call(arguments,2);if(fr[fu]&&fr[fu][fv]){return fr[fu][fv].apply(this,ft)}return fr.shimExec.apply(this,arguments)},destroy:function(){if(!fr){return}var ft=fh.get(this.shimid);if(ft){ft.parentNode.removeChild(ft)}if(fk){fk.removeAllInstances()}this.unbindAll();delete ff[this.uid];this.uid=null;fq=fr=fk=ft=null}});fm.call(this,fl,fo)}fg.order="html5,flash,silverlight,html4";fg.getRuntime=function(fk){return ff[fk]?ff[fk]:false};fg.addConstructor=function(fl,fk){fk.prototype=fj.instance;fe[fl]=fk};fg.getConstructor=function(fk){return fe[fk]||null};fg.getInfo=function(fk){var fl=fg.getRuntime(fk);if(fl){return{uid:fl.uid,type:fl.type,can:function(){return fl.can.apply(fl,arguments)}}}return null};fg.parseCaps=function(fk){var fl={};if(fi.typeOf(fk)!=="string"){return fk||{}}fi.each(fk.split(","),function(fm){fl[fm]=true});return fl};fg.can=function(fl,fn){var fm,fk=fg.getConstructor(fl),fo;if(fk){fm=new fk({required_caps:fn});fo=fm.mode;fm.destroy();return !!fo}return false};fg.thatCan=function(fm,fn){var fl=(fn||fg.order).split(/\s*,\s*/);for(var fk in fl){if(fg.can(fl[fk],fm)){return fl[fk]}}return null};fg.capTrue=function(){return true};fg.capFalse=function(){return false};fg.capTest=function(fk){return function(){return !!fk}};return fg});fd("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(fe,fh,fg){return function ff(){var fi;fh.extend(this,{connectRuntime:function(fm){var fk=this,fl;function fj(fn){var fp,fo;if(!fn.length){fk.trigger("RuntimeError",new fe.RuntimeError(fe.RuntimeError.NOT_INIT_ERR));fi=null;return}fp=fn.shift();fo=fg.getConstructor(fp);if(!fo){fj(fn);return}fi=new fo(fm);fi.bind("Init",function(){fi.initialized=true;setTimeout(function(){fi.clients++;fk.trigger("RuntimeInit",fi)},1)});fi.bind("Error",function(){fi.destroy();fj(fn)});if(!fi.mode){fi.trigger("Error");return}fi.init()}if(fh.typeOf(fm)==="string"){fl=fm}else{if(fh.typeOf(fm.ruid)==="string"){fl=fm.ruid}}if(fl){fi=fg.getRuntime(fl);if(fi){fi.clients++;return fi}else{throw new fe.RuntimeError(fe.RuntimeError.NOT_INIT_ERR)}}fj((fm.runtime_order||fg.order).split(/\s*,\s*/))},getRuntime:function(){if(fi&&fi.uid){return fi}fi=null;return null},disconnectRuntime:function(){if(fi&&--fi.clients<=0){fi.destroy();fi=null}}})}});fd("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(fh,ff,fg){var fe={};function fi(fl,fk){function fj(fq,fm,fo){var fn,fp=fe[this.uid];if(fh.typeOf(fp)!=="string"||!fp.length){return null}fn=new fi(null,{type:fo,size:fm-fq});fn.detach(fp.substr(fq,fn.size));return fn}fg.call(this);if(fl){this.connectRuntime(fl)}if(!fk){fk={}}else{if(fh.typeOf(fk)==="string"){fk={data:fk}}}fh.extend(this,{uid:fk.uid||fh.guid("uid_"),ruid:fl,size:fk.size||0,type:fk.type||"",slice:function(fo,fm,fn){if(this.isDetached()){return fj.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),fo,fm,fn)},getSource:function(){if(!fe[this.uid]){return null}return fe[this.uid]},detach:function(fn){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",fe[this.uid]);this.disconnectRuntime();this.ruid=null}fn=fn||"";var fm=fn.match(/^data:([^;]*);base64,/);if(fm){this.type=fm[1];fn=ff.atob(fn.substring(fn.indexOf("base64,")+7))}this.size=fn.length;fe[this.uid]=fn},isDetached:function(){return !this.ruid&&fh.typeOf(fe[this.uid])==="string"},destroy:function(){this.detach();delete fe[this.uid]}});if(fk.data){this.detach(fk.data)}else{fe[this.uid]=fk}}return fi});fd("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(fg,ff,fh){function fe(fj,fk){var fi,fl;if(!fk){fk={}}if(fk.type&&fk.type!==""){fl=fk.type}else{fl=ff.getFileMime(fk.name)}if(fk.name){fi=fk.name.replace(/\\/g,"/");fi=fi.substr(fi.lastIndexOf("/")+1)}else{var fm=fl.split("/")[0];fi=fg.guid((fm!==""?fm:"file")+"_");if(ff.extensions[fl]){fi+="."+ff.extensions[fl][0]}}fh.apply(this,arguments);fg.extend(this,{type:fl||"",name:fi||fg.guid("file_"),lastModifiedDate:fk.lastModifiedDate||(new Date()).toLocaleString()})}fe.prototype=fh.prototype;return fe});fd("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(ff,fi,fh,fm,fo,fg,fk,fe,fl){var fn=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function fj(fs){var fq=this,fp,fr,ft;if(ff.inArray(ff.typeOf(fs),["string","node"])!==-1){fs={browse_button:fs}}fr=fh.get(fs.browse_button);if(!fr){throw new fm.DOMException(fm.DOMException.NOT_FOUND_ERR)}ft={accept:[{title:fg.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:fr.parentNode||document.body};fs=ff.extend({},ft,fs);if(typeof(fs.required_caps)==="string"){fs.required_caps=fe.parseCaps(fs.required_caps)}if(typeof(fs.accept)==="string"){fs.accept=fi.mimes2extList(fs.accept)}fp=fh.get(fs.container);if(!fp){fp=document.body}if(fh.getStyle(fp,"position")==="static"){fp.style.position="relative"}fp=fr=null;fl.call(fq);ff.extend(fq,{uid:ff.guid("uid_"),ruid:null,files:null,init:function(){fq.convertEventPropsToHandlers(fn);fq.bind("RuntimeInit",function(fv,fu){fq.ruid=fu.uid;fq.bind("Ready",function(){fq.trigger("Refresh")},999);fq.bind("Change",function(){var fw=fu.exec.call(fq,"FileInput","getFiles");fq.files=[];ff.each(fw,function(fx){if(fx.size===0){return true}fq.files.push(new fk(fq.ruid,fx))})},999);fq.bind("Refresh",function(){var fz,fy,fx,fw;fx=fh.get(fs.browse_button);fw=fh.get(fu.shimid);if(fx){fz=fh.getPos(fx,fh.get(fs.container));fy=fh.getSize(fx);if(fw){ff.extend(fw.style,{top:fz.y+"px",left:fz.x+"px",width:fy.w+"px",height:fy.h+"px"})}}fw=fx=null});fu.exec.call(fq,"FileInput","init",fs)});fq.connectRuntime(ff.extend({},fs,{required_caps:{select_file:true}}))},disable:function(fv){var fu=this.getRuntime();if(fu){fu.exec.call(this,"FileInput","disable",ff.typeOf(fv)==="undefined"?true:fv)}},refresh:function(){fq.trigger("Refresh")},destroy:function(){var fu=this.getRuntime();if(fu){fu.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(ff.typeOf(this.files)==="array"){ff.each(this.files,function(fv){fv.destroy()})}this.files=null}})}fj.prototype=fo.instance;return fj});fd("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(fg,fh,fl,fe,fj,fk,fn,fi){var fm=["ready","dragenter","dragleave","drop","error"];function ff(fp){var fo=this,fq;if(typeof(fp)==="string"){fp={drop_zone:fp}}fq={accept:[{title:fg.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};fp=typeof(fp)==="object"?fe.extend({},fq,fp):fq;fp.container=fh.get(fp.drop_zone)||document.body;if(fh.getStyle(fp.container,"position")==="static"){fp.container.style.position="relative"}if(typeof(fp.accept)==="string"){fp.accept=fi.mimes2extList(fp.accept)}fk.call(fo);fe.extend(fo,{uid:fe.guid("uid_"),ruid:null,files:null,init:function(){fo.convertEventPropsToHandlers(fm);fo.bind("RuntimeInit",function(fs,fr){fo.ruid=fr.uid;fo.bind("Drop",function(){var ft=fr.exec.call(fo,"FileDrop","getFiles");fo.files=[];fe.each(ft,function(fu){fo.files.push(new fj(fo.ruid,fu))})},999);fr.exec.call(fo,"FileDrop","init",fp);fo.dispatchEvent("ready")});fo.connectRuntime(fp)},destroy:function(){var fr=this.getRuntime();if(fr){fr.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}ff.prototype=fn.instance;return ff});fd("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(fg,ff,fh){function fe(){this.uid=fg.guid("uid_");ff.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}fe.prototype=fh.instance;return fe});fd("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(fe,fi,fk,fm,fh,fj,fg){var fl=["loadstart","progress","load","abort","error","loadend"];function ff(){var fn=this,fp;fe.extend(this,{uid:fe.guid("uid_"),readyState:ff.EMPTY,result:null,error:null,readAsBinaryString:function(fq){fo.call(this,"readAsBinaryString",fq)},readAsDataURL:function(fq){fo.call(this,"readAsDataURL",fq)},readAsText:function(fq){fo.call(this,"readAsText",fq)},abort:function(){this.result=null;if(fe.inArray(this.readyState,[ff.EMPTY,ff.DONE])!==-1){return}else{if(this.readyState===ff.LOADING){this.readyState=ff.DONE}}if(fp){fp.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(fp){fp.getRuntime().exec.call(this,"FileReader","destroy");fp.disconnectRuntime()}fn=fp=null}});function fo(fv,fr){fp=new fg();function ft(fw){fn.readyState=ff.DONE;fn.error=fw;fn.trigger("error");fs()}function fs(){fp.destroy();fp=null;fn.trigger("loadend")}function fq(fw){fp.bind("Error",function(fy,fx){ft(fx)});fp.bind("Progress",function(fx){fn.result=fw.exec.call(fp,"FileReader","getResult");fn.trigger(fx)});fp.bind("Load",function(fx){fn.readyState=ff.DONE;fn.result=fw.exec.call(fp,"FileReader","getResult");fn.trigger(fx);fs()});fw.exec.call(fp,"FileReader","read",fv,fr)}this.convertEventPropsToHandlers(fl);if(this.readyState===ff.LOADING){return ft(new fk.DOMException(fk.DOMException.INVALID_STATE_ERR))}this.readyState=ff.LOADING;this.trigger("loadstart");if(fr instanceof fh){if(fr.isDetached()){var fu=fr.getSource();switch(fv){case"readAsText":case"readAsBinaryString":this.result=fu;break;case"readAsDataURL":this.result="data:"+fr.type+";base64,"+fi.btoa(fu);break}this.readyState=ff.DONE;this.trigger("load");fs()}else{fq(fp.connectRuntime(fr.ruid))}}else{ft(new fk.DOMException(fk.DOMException.NOT_FOUND_ERR))}}}ff.EMPTY=0;ff.LOADING=1;ff.DONE=2;ff.prototype=fm.instance;return ff});fd("moxie/core/utils/Url",[],function(){var fe=function(fn){var fj=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],fi=fj.length,fo={http:80,https:443},fl={},fk=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,fh=fk.exec(fn||"");while(fi--){if(fh[fi]){fl[fj[fi]]=fh[fi]}}if(/^[^\/]/.test(fl.path)&&!fl.scheme){var fm=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(fm)){fm=fm.replace(/[^\/]+$/,"")}fl.host=document.location.hostname;fl.path=fm+(fl.path||"")}if(!fl.scheme){fl.scheme=document.location.protocol.replace(/:$/,"")}if(!fl.host){fl.host=document.location.hostname}if(!fl.port){fl.port=document.location.port||fo[fl.scheme]||80}fl.port=parseInt(fl.port,10);if(!fl.path){fl.path="/"}delete fl.source;return fl};var fg=function(fi){var fj={http:80,https:443},fh=fe(fi);return fh.scheme+"://"+fh.host+(fh.port!==fj[fh.scheme]?":"+fh.port:"")+fh.path+(fh.query?fh.query:"")};var ff=function(fi){function fh(fj){return[fj.scheme,fj.host,fj.port].join("/")}if(typeof fi==="string"){fi=fe(fi)}return fh(fe())===fh(fi)};return{parseUrl:fe,resolveUrl:fg,hasSameOrigin:ff}});fd("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(fg,ff,fe){return function(){ff.call(this);fg.extend(this,{uid:fg.guid("uid_"),readAsBinaryString:function(fi){return fh.call(this,"readAsBinaryString",fi)},readAsDataURL:function(fi){return fh.call(this,"readAsDataURL",fi)},readAsText:function(fi){return fh.call(this,"readAsText",fi)}});function fh(fo,fk){if(fk.isDetached()){var fn=fk.getSource();switch(fo){case"readAsBinaryString":return fn;case"readAsDataURL":return"data:"+fk.type+";base64,"+fe.btoa(fn);case"readAsText":var fj="";for(var fl=0,fm=fn.length;fl<fm;fl++){fj+=String.fromCharCode(fn[fl])}return fj}}else{var fi=this.connectRuntime(fk.ruid).exec.call(this,"FileReaderSync","read",fo,fk);this.disconnectRuntime();return fi}}}});fd("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(fe,ff,fh){function fg(){var fj,fk={},fi="";ff.extend(this,{append:function(fm,fn){var fl=this,fo=ff.typeOf(fn);if(fn instanceof fh){if(fj){delete fk[fj]}fj=fm;fk[fm]=[fn]}else{if("array"===fo){fm+="[]";ff.each(fn,function(fp){fl.append.call(fl,fm,fp)})}else{if("object"===fo){ff.each(fn,function(fq,fp){fl.append.call(fl,fm+"["+fp+"]",fq)})}else{fn=fn.toString();if(!fk[fm]){fk[fm]=[]}fk[fm].push(fn)}}}},hasBlob:function(){return !!fj},getBlob:function(){return fk[fj]&&fk[fj][0]||null},getBlobName:function(){return fj||null},each:function(fl){ff.each(fk,function(fn,fm){ff.each(fn,function(fo){fl(fo,fm)})})},destroy:function(){fj=null;fi="";fk={}}})}return fg});fd("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(fm,fn,fl,ft,fq,fk,fo,fj,fs,fu,fe,fp){var ff={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function fi(){this.uid=fm.guid("uid_")}fi.prototype=fl.instance;var fh=["loadstart","progress","abort","error","load","timeout","loadend"];var fg=1,fv=2;function fr(){var fN=this,fA={timeout:0,readyState:fr.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},fT=true,fF,fL,fM={},fO,fC,fE=null,fG=null,fW=false,fx=false,fw=false,fH=false,fz=false,fD=false,fJ,fS,fR=null,fU=null,fP={},fK,fQ="",fy;fm.extend(this,fA,{uid:fm.guid("uid_"),upload:new fi(),open:function(f2,f0,f1,fY,fZ){var fX;if(!f2||!f0){throw new fn.DOMException(fn.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(f2)||ft.utf8_encode(f2)!==f2){throw new fn.DOMException(fn.DOMException.SYNTAX_ERR)}if(!!~fm.inArray(f2.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){fL=f2.toUpperCase()}if(!!~fm.inArray(fL,["CONNECT","TRACE","TRACK"])){throw new fn.DOMException(fn.DOMException.SECURITY_ERR)}f0=ft.utf8_encode(f0);fX=fq.parseUrl(f0);fD=fq.hasSameOrigin(fX);fF=fq.resolveUrl(f0);if((fY||fZ)&&!fD){throw new fn.DOMException(fn.DOMException.INVALID_ACCESS_ERR)}fO=fY||fX.user;fC=fZ||fX.pass;fT=f1||true;if(fT===false&&(fV("timeout")||fV("withCredentials")||fV("responseType")!=="")){throw new fn.DOMException(fn.DOMException.INVALID_ACCESS_ERR)}fW=!fT;fx=false;fM={};fI.call(this);fV("readyState",fr.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(fZ,fY){var fX=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(fV("readyState")!==fr.OPENED||fx){throw new fn.DOMException(fn.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(fZ)||ft.utf8_encode(fZ)!==fZ){throw new fn.DOMException(fn.DOMException.SYNTAX_ERR)}fZ=fm.trim(fZ).toLowerCase();if(!!~fm.inArray(fZ,fX)||/^(proxy\-|sec\-)/.test(fZ)){return false}if(!fM[fZ]){fM[fZ]=fY}else{fM[fZ]+=", "+fY}return true},getAllResponseHeaders:function(){return fQ||""},getResponseHeader:function(fX){fX=fX.toLowerCase();if(fz||!!~fm.inArray(fX,["set-cookie","set-cookie2"])){return null}if(fQ&&fQ!==""){if(!fy){fy={};fm.each(fQ.split(/\r\n/),function(fY){var fZ=fY.split(/:\s+/);if(fZ.length===2){fZ[0]=fm.trim(fZ[0]);fy[fZ[0].toLowerCase()]={header:fZ[0],value:fm.trim(fZ[1])}}})}if(fy.hasOwnProperty(fX)){return fy[fX].header+": "+fy[fX].value}}return null},overrideMimeType:function(fY){var fX,fZ;if(!!~fm.inArray(fV("readyState"),[fr.LOADING,fr.DONE])){throw new fn.DOMException(fn.DOMException.INVALID_STATE_ERR)}fY=fm.trim(fY.toLowerCase());if(/;/.test(fY)&&(fX=fY.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){fY=fX[1];if(fX[2]){fZ=fX[2]}}if(!fp.mimes[fY]){throw new fn.DOMException(fn.DOMException.SYNTAX_ERR)}fR=fY;fU=fZ},send:function(fZ,fY){if(fm.typeOf(fY)==="string"){fP={ruid:fY}}else{if(!fY){fP={}}else{fP=fY}}this.convertEventPropsToHandlers(fh);this.upload.convertEventPropsToHandlers(fh);if(this.readyState!==fr.OPENED||fx){throw new fn.DOMException(fn.DOMException.INVALID_STATE_ERR)}if(fZ instanceof fj){fP.ruid=fZ.ruid;fG=fZ.type||"application/octet-stream"}else{if(fZ instanceof fu){if(fZ.hasBlob()){var fX=fZ.getBlob();fP.ruid=fX.ruid;fG=fX.type||"application/octet-stream"}}else{if(typeof fZ==="string"){fE="UTF-8";fG="text/plain;charset=UTF-8";fZ=ft.utf8_encode(fZ)}}}if(!this.withCredentials){this.withCredentials=(fP.required_caps&&fP.required_caps.send_browser_cookies)&&!fD}fw=(!fW&&this.upload.hasEventListener());fz=false;fH=!fZ;if(!fW){fx=true;if(!fH){}}fB.call(this,fZ)},abort:function(){fz=true;fW=false;if(!~fm.inArray(fV("readyState"),[fr.UNSENT,fr.OPENED,fr.DONE])){fV("readyState",fr.DONE);fx=false;if(fK){fK.getRuntime().exec.call(fK,"XMLHttpRequest","abort",fH)}else{throw new fn.DOMException(fn.DOMException.INVALID_STATE_ERR)}fH=true}else{fV("readyState",fr.UNSENT)}},destroy:function(){if(fK){if(fm.typeOf(fK.destroy)==="function"){fK.destroy()}fK=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function fV(fY,fX){if(!fA.hasOwnProperty(fY)){return}if(arguments.length===1){return fe.can("define_property")?fA[fY]:fN[fY]}else{if(fe.can("define_property")){fA[fY]=fX}else{fN[fY]=fX}}}function fB(f0){var fY=this;fJ=new Date().getTime();fK=new fo();function fZ(){fK.destroy();fK=null;fY.dispatchEvent("loadend");fY=null}function fX(f1){fK.bind("LoadStart",function(f2){fV("readyState",fr.LOADING);fY.dispatchEvent("readystatechange");fY.dispatchEvent(f2);if(fw){fY.upload.dispatchEvent(f2)}});fK.bind("Progress",function(f2){if(fV("readyState")!==fr.LOADING){fV("readyState",fr.LOADING);fY.dispatchEvent("readystatechange")}fY.dispatchEvent(f2)});fK.bind("UploadProgress",function(f2){if(fw){fY.upload.dispatchEvent({type:"progress",lengthComputable:false,total:f2.total,loaded:f2.loaded})}});fK.bind("Load",function(f2){fV("readyState",fr.DONE);fV("status",Number(f1.exec.call(fK,"XMLHttpRequest","getStatus")||0));fV("statusText",ff[fV("status")]||"");fV("response",f1.exec.call(fK,"XMLHttpRequest","getResponse",fV("responseType")));if(!!~fm.inArray(fV("responseType"),["text",""])){fV("responseText",fV("response"))}else{if(fV("responseType")==="document"){fV("responseXML",fV("response"))}}fQ=f1.exec.call(fK,"XMLHttpRequest","getAllResponseHeaders");fY.dispatchEvent("readystatechange");if(fV("status")>0){if(fw){fY.upload.dispatchEvent(f2)}fY.dispatchEvent(f2)}else{fz=true;fY.dispatchEvent("error")}fZ()});fK.bind("Abort",function(f2){fY.dispatchEvent(f2);fZ()});fK.bind("Error",function(f2){fz=true;fV("readyState",fr.DONE);fY.dispatchEvent("readystatechange");fH=true;fY.dispatchEvent(f2);fZ()});f1.exec.call(fK,"XMLHttpRequest","send",{url:fF,method:fL,async:fT,user:fO,password:fC,headers:fM,mimeType:fG,encoding:fE,responseType:fY.responseType,withCredentials:fY.withCredentials,options:fP},f0)}if(typeof(fP.required_caps)==="string"){fP.required_caps=fk.parseCaps(fP.required_caps)}fP.required_caps=fm.extend({},fP.required_caps,{return_response_type:fY.responseType});if(f0 instanceof fu){fP.required_caps.send_multipart=true}if(!fD){fP.required_caps.do_cors=true}if(fP.ruid){fX(fK.connectRuntime(fP))}else{fK.bind("RuntimeInit",function(f2,f1){fX(f1)});fK.bind("RuntimeError",function(f2,f1){fY.dispatchEvent("RuntimeError",f1)});fK.connectRuntime(fP)}}function fI(){fV("responseText","");fV("responseXML",null);fV("response",null);fV("status",0);fV("statusText","");fJ=fS=null}}fr.UNSENT=0;fr.OPENED=1;fr.HEADERS_RECEIVED=2;fr.LOADING=3;fr.DONE=4;fr.prototype=fl.instance;return fr});fd("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(fh,fe,ff,fi){function fg(){var fn,fl,fj,fo,fr,fq;ff.call(this);fh.extend(this,{uid:fh.guid("uid_"),state:fg.IDLE,result:null,transport:function(fw,fv,fu){var ft=this;fu=fh.extend({chunk_size:204798},fu);if((fn=fu.chunk_size%3)){fu.chunk_size+=3-fn}fq=fu.chunk_size;fp.call(this);fj=fw;fo=fw.length;if(fh.typeOf(fu)==="string"||fu.ruid){fm.call(ft,fv,this.connectRuntime(fu))}else{var fs=function(fy,fx){ft.unbind("RuntimeInit",fs);fm.call(ft,fv,fx)};this.bind("RuntimeInit",fs);this.connectRuntime(fu)}},abort:function(){var fs=this;fs.state=fg.IDLE;if(fl){fl.exec.call(fs,"Transporter","clear");fs.trigger("TransportingAborted")}fp.call(fs)},destroy:function(){this.unbindAll();fl=null;this.disconnectRuntime();fp.call(this)}});function fp(){fo=fr=0;fj=this.result=null}function fm(ft,fu){var fs=this;fl=fu;fs.bind("TransportingProgress",function(fv){fr=fv.loaded;if(fr<fo&&fh.inArray(fs.state,[fg.IDLE,fg.DONE])===-1){fk.call(fs)}},999);fs.bind("TransportingComplete",function(){fr=fo;fs.state=fg.DONE;fj=null;fs.result=fl.exec.call(fs,"Transporter","getAsBlob",ft||"")},999);fs.state=fg.BUSY;fs.trigger("TransportingStarted");fk.call(fs)}function fk(){var fs=this,ft,fu=fo-fr;if(fq>fu){fq=fu}ft=fe.btoa(fj.substr(fr,fq));fl.exec.call(fs,"Transporter","receive",ft,fo)}}fg.IDLE=0;fg.BUSY=1;fg.DONE=2;fg.prototype=fi.instance;return fg});fd("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var fh,ff,fe={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},fq,fo=function(fr){throw {name:"SyntaxError",message:fr,at:fh,text:fq}},fk=function(fr){if(fr&&fr!==ff){fo("Expected '"+fr+"' instead of '"+ff+"'")}ff=fq.charAt(fh);fh+=1;return ff},fj=function(){var fs,fr="";if(ff==="-"){fr="-";fk("-")}while(ff>="0"&&ff<="9"){fr+=ff;fk()}if(ff==="."){fr+=".";while(fk()&&ff>="0"&&ff<="9"){fr+=ff}}if(ff==="e"||ff==="E"){fr+=ff;fk();if(ff==="-"||ff==="+"){fr+=ff;fk()}while(ff>="0"&&ff<="9"){fr+=ff;fk()}}fs=+fr;if(!isFinite(fs)){fo("Bad number")}else{return fs}},fl=function(){var fu,ft,fs="",fr;if(ff==='"'){while(fk()){if(ff==='"'){fk();return fs}else{if(ff==="\\"){fk();if(ff==="u"){fr=0;for(ft=0;ft<4;ft+=1){fu=parseInt(fk(),16);if(!isFinite(fu)){break}fr=fr*16+fu}fs+=String.fromCharCode(fr)}else{if(typeof fe[ff]==="string"){fs+=fe[ff]}else{break}}}else{fs+=ff}}}}fo("Bad string")},fn=function(){while(ff&&ff<=" "){fk()}},fg=function(){switch(ff){case"t":fk("t");fk("r");fk("u");fk("e");return true;case"f":fk("f");fk("a");fk("l");fk("s");fk("e");return false;case"n":fk("n");fk("u");fk("l");fk("l");return null}fo("Unexpected '"+ff+"'")},fp,fm=function(){var fr=[];if(ff==="["){fk("[");fn();if(ff==="]"){fk("]");return fr}while(ff){fr.push(fp());fn();if(ff==="]"){fk("]");return fr}fk(",");fn()}}fo("Bad array")},fi=function(){var fs,fr={};if(ff==="{"){fk("{");fn();if(ff==="}"){fk("}");return fr}while(ff){fs=fl();fn();fk(":");if(Object.hasOwnProperty.call(fr,fs)){fo('Duplicate key "'+fs+'"')}fr[fs]=fp();fn();if(ff==="}"){fk("}");return fr}fk(",");fn()}}fo("Bad object")};fp=function(){fn();switch(ff){case"{":return fi();case"[":return fm();case'"':return fl();case"-":return fj();default:return ff>="0"&&ff<="9"?fj():fg()}};return function(fu,fs){var fr;fq=fu;fh=0;ff=" ";fr=fp();fn();if(ff){fo("Syntax error")}return typeof fs==="function"?(function ft(fy,fx){var fw,fv,fz=fy[fx];if(fz&&typeof fz==="object"){for(fw in fz){if(Object.prototype.hasOwnProperty.call(fz,fw)){fv=ft(fz,fw);if(fv!==fc){fz[fw]=fv}else{delete fz[fw]}}}}return fs.call(fy,fx,fz)}({"":fr},"")):fr}}())});fd("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(fg,fk,fq,fo,fr,ff,fp,fj,fn,ft,fi,fm,fl,fh){var fs=["progress","load","error","resize","embedded"];function fe(){fp.call(this);fg.extend(this,{uid:fg.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){fv.call(this)},999);this.convertEventPropsToHandlers(fs);fw.apply(this,arguments)},downsize:function(fD,fz,fC,fA){try{if(!this.size){throw new fq.DOMException(fq.DOMException.INVALID_STATE_ERR)}if(this.width>fe.MAX_RESIZE_WIDTH||this.height>fe.MAX_RESIZE_HEIGHT){throw new fq.ImageError(fq.ImageError.MAX_RESOLUTION_ERR)}if(!fD&&!fz||fg.typeOf(fC)==="undefined"){fC=false}fD=fD||this.width;fz=fz||this.height;fA=(fg.typeOf(fA)==="undefined"?true:!!fA);this.getRuntime().exec.call(this,"Image","downsize",fD,fz,fC,fA)}catch(fB){this.trigger("error",fB)}},crop:function(fB,fz,fA){this.downsize(fB,fz,true,fA)},getAsCanvas:function(){if(!fn.can("create_canvas")){throw new fq.RuntimeError(fq.RuntimeError.NOT_SUPPORTED_ERR)}var fz=this.connectRuntime(this.ruid);return fz.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(fz,fA){if(!this.size){throw new fq.DOMException(fq.DOMException.INVALID_STATE_ERR)}if(!fz){fz="image/jpeg"}if(fz==="image/jpeg"&&!fA){fA=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",fz,fA)},getAsDataURL:function(fz,fA){if(!this.size){throw new fq.DOMException(fq.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",fz,fA)},getAsBinaryString:function(fz,fB){var fA=this.getAsDataURL(fz,fB);return fl.atob(fA.substring(fA.indexOf("base64,")+7))},embed:function(fC){var fK=this,fH,fG,fI,fE,fL=arguments[1]||{},fB=this.width,fJ=this.height,fD;function fA(){if(fn.can("create_canvas")){var fM=fH.getAsCanvas();if(fM){fC.appendChild(fM);fM=null;fH.destroy();fK.trigger("embedded");return}}var fO=fH.getAsDataURL(fG,fI);if(!fO){throw new fq.ImageError(fq.ImageError.WRONG_FORMAT)}if(fn.can("use_data_uri_of",fO.length)){fC.innerHTML='<img src="'+fO+'" width="'+fH.width+'" height="'+fH.height+'" />';fH.destroy();fK.trigger("embedded")}else{var fN=new fj();fN.bind("TransportingComplete",function(){fD=fK.connectRuntime(this.result.ruid);fK.bind("Embedded",function(){fg.extend(fD.getShimContainer().style,{top:"0px",left:"0px",width:fH.width+"px",height:fH.height+"px"});fD=null},999);fD.exec.call(fK,"ImageView","display",this.result.uid,fB,fJ);fH.destroy()});fN.transport(fl.atob(fO.substring(fO.indexOf("base64,")+7)),fG,fg.extend({},fL,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:fC}))}}try{if(!(fC=fk.get(fC))){throw new fq.DOMException(fq.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new fq.DOMException(fq.DOMException.INVALID_STATE_ERR)}if(this.width>fe.MAX_RESIZE_WIDTH||this.height>fe.MAX_RESIZE_HEIGHT){throw new fq.ImageError(fq.ImageError.MAX_RESOLUTION_ERR)}fG=fL.type||this.type||"image/jpeg";fI=fL.quality||90;fE=fg.typeOf(fL.crop)!=="undefined"?fL.crop:false;if(fL.width){fB=fL.width;fJ=fL.height||fB}else{var fz=fk.getSize(fC);if(fz.w&&fz.h){fB=fz.w;fJ=fz.h}}fH=new fe();fH.bind("Resize",function(){fA.call(fK)});fH.bind("Load",function(){fH.downsize(fB,fJ,fE,false)});fH.clone(this,false);return fH}catch(fF){this.trigger("error",fF)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function fv(fA){if(!fA){fA=this.getRuntime().exec.call(this,"Image","getInfo")}if(fA){if(fg.typeOf(fA.meta)==="string"){try{this.meta=fh(fA.meta)}catch(fz){}}else{this.meta=fA.meta}}fg.extend(this,{size:parseInt(fA.size,10),width:parseInt(fA.width,10),height:parseInt(fA.height,10),type:fA.type});if(this.name===""){this.name=fA.name}}function fw(fB){var fA=fg.typeOf(fB);try{if(fB instanceof fe){if(!fB.size){throw new fq.DOMException(fq.DOMException.INVALID_STATE_ERR)}fu.apply(this,arguments)}else{if(fB instanceof fi){if(!~fg.inArray(fB.type,["image/jpeg","image/png"])){throw new fq.ImageError(fq.ImageError.WRONG_FORMAT)}fx.apply(this,arguments)}else{if(fg.inArray(fA,["blob","file"])!==-1){fw.call(this,new fm(null,fB),arguments[1])}else{if(fA==="string"){if(/^data:[^;]*;base64,/.test(fB)){fw.call(this,new fi(null,{data:fB}),arguments[1])}else{fy.apply(this,arguments)}}else{if(fA==="node"&&fB.nodeName.toLowerCase()==="img"){fw.call(this,fB.src,arguments[1])}else{throw new fq.DOMException(fq.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(fz){this.trigger("error",fz)}}function fu(fz,fA){var fB=this.connectRuntime(fz.ruid);this.ruid=fB.uid;fB.exec.call(this,"Image","loadFromImage",fz,(fg.typeOf(fA)==="undefined"?true:fA))}function fx(fB,fC){var fA=this;fA.name=fB.name||"";function fz(fD){fA.ruid=fD.uid;fD.exec.call(fA,"Image","loadFromBlob",fB)}if(fB.isDetached()){this.bind("RuntimeInit",function(fE,fD){fz(fD)});if(fC&&typeof(fC.required_caps)==="string"){fC.required_caps=ff.parseCaps(fC.required_caps)}this.connectRuntime(fg.extend({required_caps:{access_image_binary:true,resize_image:true}},fC))}else{fz(this.connectRuntime(fB.ruid))}}function fy(fB,fA){var fz=this,fC;fC=new fr();fC.open("get",fB);fC.responseType="blob";fC.onprogress=function(fD){fz.trigger(fD)};fC.onload=function(){fx.call(fz,fC.response,true)};fC.onerror=function(fD){fz.trigger(fD)};fC.onloadend=function(){fC.destroy()};fC.bind("RuntimeError",function(fE,fD){fz.trigger("RuntimeError",fD)});fC.send(null,fA)}}fe.MAX_RESIZE_WIDTH=6500;fe.MAX_RESIZE_HEIGHT=6500;fe.prototype=ft.instance;return fe});fd("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(fj,fe,fg,ff){var fi="html5",fh={};function fk(fm){var fl=this,fp=fg.capTest,fo=fg.capTrue;var fn=fj.extend({access_binary:fp(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return fl.can("access_binary")&&!!fh.Image},display_media:fp(ff.can("create_canvas")||ff.can("use_data_uri_over32kb")),do_cors:fp(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:fp(function(){var fq=document.createElement("div");return(("draggable" in fq)||("ondragstart" in fq&&"ondrop" in fq))&&(ff.browser!=="IE"||ff.version>9)}()),filter_by_extension:fp(function(){return(ff.browser==="Chrome"&&ff.version>=28)||(ff.browser==="IE"&&ff.version>=10)}()),return_response_headers:fo,return_response_type:function(fq){if(fq==="json"){return true}else{return ff.can("return_response_type",fq)}},return_status_code:fo,report_upload_progress:fp(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return fl.can("access_binary")&&ff.can("create_canvas")},select_file:function(){return ff.can("use_fileinput")&&window.File},select_folder:function(){return fl.can("select_file")&&ff.browser==="Chrome"&&ff.version>=21},select_multiple:function(){return fl.can("select_file")&&!(ff.browser==="Safari"&&ff.OS==="Windows")},send_binary_string:fp(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:fp(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||fl.can("send_binary_string")},slice_blob:fp(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return fl.can("slice_blob")&&fl.can("send_multipart")},summon_file_dialog:fp(function(){return(ff.browser==="Firefox"&&ff.version>=4)||(ff.browser==="Opera"&&ff.version>=12)||(ff.browser==="IE"&&ff.version>=10)||!!~fj.inArray(ff.browser,["Chrome","Safari"])}()),upload_filesize:fo},arguments[2]);fg.call(this,fm,(arguments[1]||fi),fn);fj.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fq){return function(){fq.call(fl);fq=fl=null}}(this.destroy))});fj.extend(this.getShim(),fh)}fg.addConstructor(fi,fk);return fh});fd("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(ff,fg){function fe(){function fh(fj,fm,fi){var fk;if(window.File.prototype.slice){try{fj.slice();return fj.slice(fm,fi)}catch(fl){return fj.slice(fm,fi-fm)}}else{if((fk=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return fk.call(fj,fm,fi)}else{return null}}}this.slice=function(){return new fg(this.getRuntime().uid,fh.apply(this,arguments))}}return(ff.Blob=fe)});fd("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(fk){var fl={},fh="moxie_"+fk.guid();function fg(){this.returnValue=false}function ff(){this.cancelBubble=true}var fi=function(fq,fm,fr,fo){var fp,fn;fm=fm.toLowerCase();if(fq.addEventListener){fp=fr;fq.addEventListener(fm,fp,false)}else{if(fq.attachEvent){fp=function(){var fs=window.event;if(!fs.target){fs.target=fs.srcElement}fs.preventDefault=fg;fs.stopPropagation=ff;fr(fs)};fq.attachEvent("on"+fm,fp)}}if(!fq[fh]){fq[fh]=fk.guid()}if(!fl.hasOwnProperty(fq[fh])){fl[fq[fh]]={}}fn=fl[fq[fh]];if(!fn.hasOwnProperty(fm)){fn[fm]=[]}fn[fm].push({func:fp,orig:fr,key:fo})};var fj=function(fr,fm,fs){var fp,fo;fm=fm.toLowerCase();if(fr[fh]&&fl[fr[fh]]&&fl[fr[fh]][fm]){fp=fl[fr[fh]][fm]}else{return}for(var fn=fp.length-1;fn>=0;fn--){if(fp[fn].orig===fs||fp[fn].key===fs){if(fr.removeEventListener){fr.removeEventListener(fm,fp[fn].func,false)}else{if(fr.detachEvent){fr.detachEvent("on"+fm,fp[fn].func)}}fp[fn].orig=null;fp[fn].func=null;fp.splice(fn,1);if(fs!==fo){break}}}if(!fp.length){delete fl[fr[fh]][fm]}if(fk.isEmptyObj(fl[fr[fh]])){delete fl[fr[fh]];try{delete fr[fh]}catch(fq){fr[fh]=fo}}};var fe=function(fn,fm){if(!fn||!fn[fh]){return}fk.each(fl[fn[fh]],function(fp,fo){fj(fn,fo,fm)})};return{addEvent:fi,removeEvent:fj,removeAllEvents:fe}});fd("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fi,fk,fh,ff,fg,fe){function fj(){var fm=[],fl;fk.extend(this,{init:function(fw){var fn=this,fu=fn.getRuntime(),ft,fp,fq,fv,fs,fr;fl=fw;fm=[];fq=fl.accept.mimes||fg.extList2mimes(fl.accept,fu.can("filter_by_extension"));fp=fu.getShimContainer();fp.innerHTML='<input id="'+fu.uid+'" type="file" style="font-size:999px;opacity:0;"'+(fl.multiple&&fu.can("select_multiple")?"multiple":"")+(fl.directory&&fu.can("select_folder")?"webkitdirectory directory":"")+(fq?' accept="'+fq.join(",")+'"':"")+" />";ft=fh.get(fu.uid);fk.extend(ft.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});fv=fh.get(fl.browse_button);if(fu.can("summon_file_dialog")){if(fh.getStyle(fv,"position")==="static"){fv.style.position="relative"}fs=parseInt(fh.getStyle(fv,"z-index"),10)||1;fv.style.zIndex=fs;fp.style.zIndex=fs-1;ff.addEvent(fv,"click",function(fy){var fx=fh.get(fu.uid);if(fx&&!fx.disabled){fx.click()}fy.preventDefault()},fn.uid)}fr=fu.can("summon_file_dialog")?fv:fp;ff.addEvent(fr,"mouseover",function(){fn.trigger("mouseenter")},fn.uid);ff.addEvent(fr,"mouseout",function(){fn.trigger("mouseleave")},fn.uid);ff.addEvent(fr,"mousedown",function(){fn.trigger("mousedown")},fn.uid);ff.addEvent(fh.get(fl.container),"mouseup",function(){fn.trigger("mouseup")},fn.uid);ft.onchange=function fo(){fm=[];if(fl.directory){fk.each(this.files,function(fy){if(fy.name!=="."){fm.push(fy)}})}else{fm=[].slice.call(this.files)}if(fe.browser!=="IE"){this.value=""}else{var fx=this.cloneNode(true);this.parentNode.replaceChild(fx,this);fx.onchange=fo}fn.trigger("change")};fn.trigger({type:"ready",async:true});fp=null},getFiles:function(){return fm},disable:function(fp){var fo=this.getRuntime(),fn;if((fn=fh.get(fo.uid))){fn.disabled=!!fp}},destroy:function(){var fo=this.getRuntime(),fn=fo.getShimContainer();ff.removeAllEvents(fn,this.uid);ff.removeAllEvents(fl&&fh.get(fl.container),this.uid);ff.removeAllEvents(fl&&fh.get(fl.browse_button),this.uid);if(fn){fn.innerHTML=""}fm=fl=null}})}return(fi.FileInput=fj)});fd("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(fh,fi,fg,fe,ff){function fj(){var fm=[],fp=[],fl;fi.extend(this,{init:function(ft){var fs=this,fu;fl=ft;fp=fn(fl.accept);fu=fl.container;fe.addEvent(fu,"dragover",function(fv){fv.preventDefault();fv.stopPropagation();fv.dataTransfer.dropEffect="copy"},fs.uid);fe.addEvent(fu,"drop",function(fw){fw.preventDefault();fw.stopPropagation();fm=[];if(fw.dataTransfer.items&&fw.dataTransfer.items[0].webkitGetAsEntry){var fv=[];fi.each(fw.dataTransfer.items,function(fx){fv.push(fx.webkitGetAsEntry())});fq(fv,function(){fs.trigger("drop")})}else{fi.each(fw.dataTransfer.files,function(fx){if(fk(fx)){fm.push(fx)}});fs.trigger("drop")}},fs.uid);fe.addEvent(fu,"dragenter",function(fv){fv.preventDefault();fv.stopPropagation();fs.trigger("dragenter")},fs.uid);fe.addEvent(fu,"dragleave",function(fv){fv.preventDefault();fv.stopPropagation();fs.trigger("dragleave")},fs.uid)},getFiles:function(){return fm},destroy:function(){fe.removeAllEvents(fl&&fg.get(fl.container),this.uid);fm=fp=fl=null}});function fn(fu){var ft=[];for(var fs=0;fs<fu.length;fs++){[].push.apply(ft,fu[fs].extensions.split(/\s*,\s*/))}return fi.inArray("*",ft)===-1?ft:[]}function fk(fs){var ft=ff.getFileExtension(fs.name);return !ft||!fp.length||fi.inArray(ft,fp)!==-1}function fq(fu,ft){var fs=[];fi.each(fu,function(fv){fs.push(function(fw){fo(fv,fw)})});fi.inSeries(fs,function(){ft()})}function fo(ft,fs){if(ft.isFile){ft.file(function(fu){if(fk(fu)){fm.push(fu)}fs()},function(){fs()})}else{if(ft.isDirectory){fr(ft,fs)}else{fs()}}}function fr(fw,ft){var fs=[],fv=fw.createReader();function fu(fx){fv.readEntries(function(fy){if(fy.length){[].push.apply(fs,fy);fu(fx)}else{fx()}},fx)}fu(function(){fq(fs,ft)})}}return(fh.FileDrop=fj)});fd("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(ff,fe,fh){function fg(){var fj,fk=false;fh.extend(this,{read:function(fn,fl){var fm=this;fj=new window.FileReader();fj.addEventListener("progress",function(fo){fm.trigger(fo)});fj.addEventListener("load",function(fo){fm.trigger(fo)});fj.addEventListener("error",function(fo){fm.trigger(fo,fj.error)});fj.addEventListener("loadend",function(){fj=null});if(fh.typeOf(fj[fn])==="function"){fk=false;fj[fn](fl.getSource())}else{if(fn==="readAsBinaryString"){fk=true;fj.readAsDataURL(fl.getSource())}}},getResult:function(){return fj&&fj.result?(fk?fi(fj.result):fj.result):null},abort:function(){if(fj){fj.abort()}},destroy:function(){fj=null}});function fi(fl){return fe.atob(fl.substring(fl.indexOf("base64,")+7))}}return(ff.FileReader=fg)});fd("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(fl,ff,fi,fe,fk,fh,fo,fm,fj,fg){function fn(){var fu,fs;ff.extend(this,{send:function(fC,fz){var fB=this,fy=(fj.browser==="Mozilla"&&fj.version>=4&&fj.version<7),fv=fj.browser==="Android Browser",fA=false;fs=fC.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();fu=ft();fu.open(fC.method,fC.url,fC.async,fC.user,fC.password);if(fz instanceof fh){if(fz.isDetached()){fA=true}fz=fz.getSource()}else{if(fz instanceof fo){if(fz.hasBlob()){if(fz.getBlob().isDetached()){fz=fr.call(fB,fz);fA=true}else{if((fy||fv)&&ff.typeOf(fz.getBlob().getSource())==="blob"&&window.FileReader){fp.call(fB,fC,fz);return}}}if(fz instanceof fo){var fx=new window.FormData();fz.each(function(fE,fD){if(fE instanceof fh){fx.append(fD,fE.getSource())}else{fx.append(fD,fE)}});fz=fx}}}if(fu.upload){if(fC.withCredentials){fu.withCredentials=true}fu.addEventListener("load",function(fD){fB.trigger(fD)});fu.addEventListener("error",function(fD){fB.trigger(fD)});fu.addEventListener("progress",function(fD){fB.trigger(fD)});fu.upload.addEventListener("progress",function(fD){fB.trigger({type:"UploadProgress",loaded:fD.loaded,total:fD.total})})}else{fu.onreadystatechange=function fw(){switch(fu.readyState){case 1:break;case 2:break;case 3:var fF,fD;try{if(fe.hasSameOrigin(fC.url)){fF=fu.getResponseHeader("Content-Length")||0}if(fu.responseText){fD=fu.responseText.length}}catch(fE){fF=fD=0}fB.trigger({type:"progress",lengthComputable:!!fF,total:parseInt(fF,10),loaded:fD});break;case 4:fu.onreadystatechange=function(){};if(fu.status===0){fB.trigger("error")}else{fB.trigger("load")}break}}}if(!ff.isEmptyObj(fC.headers)){ff.each(fC.headers,function(fD,fE){fu.setRequestHeader(fE,fD)})}if(""!==fC.responseType&&"responseType" in fu){if("json"===fC.responseType&&!fj.can("return_response_type","json")){fu.responseType="text"}else{fu.responseType=fC.responseType}}if(!fA){fu.send(fz)}else{if(fu.sendAsBinary){fu.sendAsBinary(fz)}else{(function(){var fD=new Uint8Array(fz.length);for(var fE=0;fE<fz.length;fE++){fD[fE]=(fz.charCodeAt(fE)&255)}fu.send(fD.buffer)}())}}fB.trigger("loadstart")},getStatus:function(){try{if(fu){return fu.status}}catch(fv){}return 0},getResponse:function(fx){var fw=this.getRuntime();try{switch(fx){case"blob":var fz=new fk(fw.uid,fu.response);var fA=fu.getResponseHeader("Content-Disposition");if(fA){var fv=fA.match(/filename=([\'\"'])([^\1]+)\1/);if(fv){fs=fv[2]}}fz.name=fs;if(!fz.type){fz.type=fi.getFileMime(fs)}return fz;case"json":if(!fj.can("return_response_type","json")){return fu.status===200?fg(fu.responseText):null}return fu.response;case"document":return fq(fu);default:return fu.responseText!==""?fu.responseText:null}}catch(fy){return null}},getAllResponseHeaders:function(){try{return fu.getAllResponseHeaders()}catch(fv){}return""},abort:function(){if(fu){fu.abort()}},destroy:function(){self=fs=null}});function fp(fz,fx){var fy=this,fw,fv;fw=fx.getBlob().getSource();fv=new window.FileReader();fv.onload=function(){fx.append(fx.getBlobName(),new fh(null,{type:fw.type,data:fv.result}));self.send.call(fy,fz,fx)};fv.readAsBinaryString(fw)}function ft(){if(window.XMLHttpRequest&&!(fj.browser==="IE"&&fj.version<8)){return new window.XMLHttpRequest()}else{return(function(){var fv=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var fx=0;fx<fv.length;fx++){try{return new ActiveXObject(fv[fx])}catch(fw){}}})()}}function fq(fw){var fx=fw.responseXML;var fv=fw.responseText;if(fj.browser==="IE"&&fv&&fx&&!fx.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(fw.getResponseHeader("Content-Type"))){fx=new window.ActiveXObject("Microsoft.XMLDOM");fx.async=false;fx.validateOnParse=false;fx.loadXML(fv)}if(fx){if((fj.browser==="IE"&&fx.parseError!==0)||!fx.documentElement||fx.documentElement.tagName==="parsererror"){return null}}return fx}function fr(fx){var fA="----moxieboundary"+new Date().getTime(),fy="--",fz="\r\n",fv="",fw=this.getRuntime();if(!fw.can("send_binary_string")){throw new fm.RuntimeError(fm.RuntimeError.NOT_SUPPORTED_ERR)}fu.setRequestHeader("Content-Type","multipart/form-data; boundary="+fA);fx.each(function(fC,fB){if(fC instanceof fh){fv+=fy+fA+fz+'Content-Disposition: form-data; name="'+fB+'"; filename="'+unescape(encodeURIComponent(fC.name||"blob"))+'"'+fz+"Content-Type: "+fC.type+fz+fz+fC.getSource()+fz}else{fv+=fy+fA+fz+'Content-Disposition: form-data; name="'+fB+'"'+fz+fz+unescape(encodeURIComponent(fC))+fz}});fv+=fy+fA+fy+fz;return fv}}return(fl.XMLHttpRequest=fn)});fd("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var fh=false,ff;function fi(fk,fm){var fj=fh?0:-8*(fm-1),fn=0,fl;for(fl=0;fl<fm;fl++){fn|=(ff.charCodeAt(fk+fl)<<Math.abs(fj+fl*8))}return fn}function fe(fl,fj,fk){fk=arguments.length===3?fk:ff.length-fj-1;ff=ff.substr(0,fj)+fl+ff.substr(fk+fj)}function fg(fk,fl,fn){var fo="",fj=fh?0:-8*(fn-1),fm;for(fm=0;fm<fn;fm++){fo+=String.fromCharCode((fl>>Math.abs(fj+fm*8))&255)}fe(fo,fk,fn)}return{II:function(fj){if(fj===fc){return fh}else{fh=fj}},init:function(fj){fh=false;ff=fj},SEGMENT:function(fj,fl,fk){switch(arguments.length){case 1:return ff.substr(fj,ff.length-fj-1);case 2:return ff.substr(fj,fl);case 3:fe(fk,fj,fl);break;default:return ff}},BYTE:function(fj){return fi(fj,1)},SHORT:function(fj){return fi(fj,2)},LONG:function(fj,fk){if(fk===fc){return fi(fj,4)}else{fg(fj,fk,4)}},SLONG:function(fj){var fk=fi(fj,4);return(fk>2147483647?fk-4294967296:fk)},STRING:function(fj,fk){var fl="";for(fk+=fj;fj<fk;fj++){fl+=String.fromCharCode(fi(fj,1))}return fl}}}});fd("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(ff){return function fe(fk){var fl=[],fj,fg,fh,fi=0;fj=new ff();fj.init(fk);if(fj.SHORT(0)!==65496){return}fg=2;while(fg<=fk.length){fh=fj.SHORT(fg);if(fh>=65488&&fh<=65495){fg+=2;continue}if(fh===65498||fh===65497){break}fi=fj.SHORT(fg+2)+2;if(fh>=65505&&fh<=65519){fl.push({hex:fh,name:"APP"+(fh&15),start:fg,length:fi,segment:fj.SEGMENT(fg,fi)})}fg+=fi}fj.init(null);return{headers:fl,restore:function(fo){var fm,fn;fj.init(fo);fg=fj.SHORT(2)==65504?4+fj.SHORT(4):2;for(fn=0,fm=fl.length;fn<fm;fn++){fj.SEGMENT(fg,0,fl[fn].segment);fg+=fl[fn].length}fo=fj.SEGMENT();fj.init(null);return fo},strip:function(fo){var fp,fm,fn;fm=new fe(fo);fp=fm.headers;fm.purge();fj.init(fo);fn=fp.length;while(fn--){fj.SEGMENT(fp[fn].start,fp[fn].length,"")}fo=fj.SEGMENT();fj.init(null);return fo},get:function(fn){var fp=[];for(var fo=0,fm=fl.length;fo<fm;fo++){if(fl[fo].name===fn.toUpperCase()){fp.push(fl[fo].segment)}}return fp},set:function(fn,fq){var fr=[],fo,fp,fm;if(typeof(fq)==="string"){fr.push(fq)}else{fr=fq}for(fo=fp=0,fm=fl.length;fo<fm;fo++){if(fl[fo].name===fn.toUpperCase()){fl[fo].segment=fr[fp];fl[fo].length=fr[fp].length;fp++}if(fp>=fr.length){break}}},purge:function(){fl=[];fj.init(null);fj=null}}}});fd("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(fg,ff){return function fe(){var fl,fi,fh,fj={},fo;fl=new ff();fi={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};fo={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function fk(fp,fx){var fr=fl.SHORT(fp),fu,fA,fB,fw,fv,fq,fs,fy,fz=[],ft={};for(fu=0;fu<fr;fu++){fs=fq=fp+12*fu+2;fB=fx[fl.SHORT(fs)];if(fB===fc){continue}fw=fl.SHORT(fs+=2);fv=fl.LONG(fs+=2);fs+=4;fz=[];switch(fw){case 1:case 7:if(fv>4){fs=fl.LONG(fs)+fj.tiffHeader}for(fA=0;fA<fv;fA++){fz[fA]=fl.BYTE(fs+fA)}break;case 2:if(fv>4){fs=fl.LONG(fs)+fj.tiffHeader}ft[fB]=fl.STRING(fs,fv-1);continue;case 3:if(fv>2){fs=fl.LONG(fs)+fj.tiffHeader}for(fA=0;fA<fv;fA++){fz[fA]=fl.SHORT(fs+fA*2)}break;case 4:if(fv>1){fs=fl.LONG(fs)+fj.tiffHeader}for(fA=0;fA<fv;fA++){fz[fA]=fl.LONG(fs+fA*4)}break;case 5:fs=fl.LONG(fs)+fj.tiffHeader;for(fA=0;fA<fv;fA++){fz[fA]=fl.LONG(fs+fA*4)/fl.LONG(fs+fA*4+4)}break;case 9:fs=fl.LONG(fs)+fj.tiffHeader;for(fA=0;fA<fv;fA++){fz[fA]=fl.SLONG(fs+fA*4)}break;case 10:fs=fl.LONG(fs)+fj.tiffHeader;for(fA=0;fA<fv;fA++){fz[fA]=fl.SLONG(fs+fA*4)/fl.SLONG(fs+fA*4+4)}break;default:continue}fy=(fv==1?fz[0]:fz);if(fo.hasOwnProperty(fB)&&typeof fy!="object"){ft[fB]=fo[fB][fy]}else{ft[fB]=fy}}return ft}function fn(){var fp=fj.tiffHeader;fl.II(fl.SHORT(fp)==18761);if(fl.SHORT(fp+=2)!==42){return false}fj.IFD0=fj.tiffHeader+fl.LONG(fp+=2);fh=fk(fj.IFD0,fi.tiff);if("ExifIFDPointer" in fh){fj.exifIFD=fj.tiffHeader+fh.ExifIFDPointer;delete fh.ExifIFDPointer}if("GPSInfoIFDPointer" in fh){fj.gpsIFD=fj.tiffHeader+fh.GPSInfoIFDPointer;delete fh.GPSInfoIFDPointer}return true}function fm(fw,fy,fv){var ft,fr,fq,fp=0;if(typeof(fy)==="string"){var fx=fi[fw.toLowerCase()];for(var fs in fx){if(fx[fs]===fy){fy=fs;break}}}ft=fj[fw.toLowerCase()+"IFD"];fr=fl.SHORT(ft);for(var fu=0;fu<fr;fu++){fq=ft+12*fu+2;if(fl.SHORT(fq)==fy){fp=fq+8;break}}if(!fp){return false}fl.LONG(fp,fv);return true}return{init:function(fp){fj={tiffHeader:10};if(fp===fc||!fp.length){return false}fl.init(fp);if(fl.SHORT(0)===65505&&fl.STRING(4,5).toUpperCase()==="EXIF\0"){return fn()}return false},TIFF:function(){return fh},EXIF:function(){var fq;fq=fk(fj.exifIFD,fi.exif);if(fq.ExifVersion&&fg.typeOf(fq.ExifVersion)==="array"){for(var fr=0,fp="";fr<fq.ExifVersion.length;fr++){fp+=String.fromCharCode(fq.ExifVersion[fr])}fq.ExifVersion=fp}return fq},GPS:function(){var fp;fp=fk(fj.gpsIFD,fi.gps);if(fp.GPSVersionID&&fg.typeOf(fp.GPSVersionID)==="array"){fp.GPSVersionID=fp.GPSVersionID.join(".")}return fp},setExif:function(fp,fq){if(fp!=="PixelXDimension"&&fp!=="PixelYDimension"){return false}return fm("exif",fp,fq)},getBinary:function(){return fl.SEGMENT()},purge:function(){fl.init(null);fl=fh=null;fj={}}}}});fd("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(fj,fe,fg,fi,ff){function fh(fs){var fl,fn,fp,fo,fr,fk;function fq(){var ft=0,fu,fv;while(ft<=fl.length){fu=fn.SHORT(ft+=2);if(fu>=65472&&fu<=65475){ft+=5;return{height:fn.SHORT(ft),width:fn.SHORT(ft+=2)}}fv=fn.SHORT(ft+=2);ft+=fv-2}return null}fl=fs;fn=new fi();fn.init(fl);if(fn.SHORT(0)!==65496){throw new fe.ImageError(fe.ImageError.WRONG_FORMAT)}fp=new fg(fs);fo=new ff();fk=!!fo.init(fp.get("app1")[0]);fr=fq.call(this);fj.extend(this,{type:"image/jpeg",size:fl.length,width:fr&&fr.width||0,height:fr&&fr.height||0,setExif:function(ft,fu){if(!fk){return false}if(fj.typeOf(ft)==="object"){fj.each(ft,function(fw,fv){fo.setExif(fv,fw)})}else{fo.setExif(ft,fu)}fp.set("app1",fo.getBinary())},writeHeaders:function(){if(!arguments.length){return(fl=fp.restore(fl))}return fp.restore(arguments[0])},stripHeaders:function(ft){return fp.strip(ft)},purge:function(){fm.call(this)}});if(fk){this.meta={tiff:fo.TIFF(),exif:fo.EXIF(),gps:fo.GPS()}}function fm(){if(!fo||!fp||!fn){return}fo.purge();fp.purge();fn.init(null);fl=fr=fp=fo=fn=null}}return fh});fd("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(fe,fh,fg){function ff(fq){var fj,fl,fn,fm,fp;fj=fq;fl=new fg();fl.init(fj);(function(){var fr=0,ft=0,fs=[35152,20039,3338,6666];for(ft=0;ft<fs.length;ft++,fr+=2){if(fs[ft]!=fl.SHORT(fr)){throw new fe.ImageError(fe.ImageError.WRONG_FORMAT)}}}());function fo(){var fs,fr;fs=fi.call(this,8);if(fs.type=="IHDR"){fr=fs.start;return{width:fl.LONG(fr),height:fl.LONG(fr+=4)}}return null}function fk(){if(!fl){return}fl.init(null);fj=fp=fn=fm=fl=null}fp=fo.call(this);fh.extend(this,{type:"image/png",size:fj.length,width:fp.width,height:fp.height,purge:function(){fk.call(this)}});fk.call(this);function fi(fr){var fu,ft,fv,fs;fu=fl.LONG(fr);ft=fl.STRING(fr+=4,4);fv=fr+=4;fs=fl.LONG(fr+fu);return{length:fu,type:ft,start:fv,CRC:fs}}}return ff});fd("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(fh,fe,fg,ff){return function(fj){var fk=[fg,ff],fi;fi=(function(){for(var fm=0;fm<fk.length;fm++){try{return new fk[fm](fj)}catch(fl){}}throw new fe.ImageError(fe.ImageError.WRONG_FORMAT)}());fh.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(fl){return fl},stripHeaders:function(fl){return fl},purge:function(){}});fh.extend(this,fi);this.purge=function(){fi.purge();fi=null}}});fd("moxie/runtime/html5/image/MegaPixel",[],function(){function fe(fC,fi,fj){var fl=fC.naturalWidth,fr=fC.naturalHeight;var fw=fj.width,ft=fj.height;var fn=fj.x||0,fm=fj.y||0;var fx=fi.getContext("2d");if(ff(fC)){fl/=2;fr/=2}var fA=1024;var fh=document.createElement("canvas");fh.width=fh.height=fA;var fk=fh.getContext("2d");var fy=fg(fC,fl,fr);var fs=0;while(fs<fr){var fB=fs+fA>fr?fr-fs:fA;var fu=0;while(fu<fl){var fv=fu+fA>fl?fl-fu:fA;fk.clearRect(0,0,fA,fA);fk.drawImage(fC,-fu,-fs);var fp=(fu*fw/fl+fn)<<0;var fq=Math.ceil(fv*fw/fl);var fo=(fs*ft/fr/fy+fm)<<0;var fz=Math.ceil(fB*ft/fr/fy);fx.drawImage(fh,0,0,fv,fB,fp,fo,fq,fz);fu+=fA}fs+=fA}fh=fk=null}function ff(fj){var fi=fj.naturalWidth,fl=fj.naturalHeight;if(fi*fl>1024*1024){var fk=document.createElement("canvas");fk.width=fk.height=1;var fh=fk.getContext("2d");fh.drawImage(fj,-fi+1,0);return fh.getImageData(0,0,1,1).data[3]===0}else{return false}}function fg(fl,fi,fq){var fh=document.createElement("canvas");fh.width=1;fh.height=fq;var fr=fh.getContext("2d");fr.drawImage(fl,0,0);var fk=fr.getImageData(0,0,1,fq).data;var fo=0;var fm=fq;var fp=fq;while(fp>fo){var fj=fk[(fp-1)*4+3];if(fj===0){fm=fp}else{fo=fp}fp=(fm+fo)>>1}fh=null;var fn=(fp/fq);return(fn===0)?1:fn}return{isSubsampled:ff,renderTo:fe}});fd("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fk,fe,fl,fh,ff,fn,fm,fg,fi){function fj(){var fy=this,fx,fC,fw,fs,fA,fE=false,fp=true;fe.extend(this,{loadFromBlob:function(fH){var fG=this,fI=fG.getRuntime(),fF=arguments.length>1?arguments[1]:true;if(!fI.can("access_binary")){throw new fl.RuntimeError(fl.RuntimeError.NOT_SUPPORTED_ERR)}fA=fH;if(fH.isDetached()){fs=fH.getSource();fv.call(this,fs);return}else{fB.call(this,fH.getSource(),function(fJ){if(fF){fs=fD(fJ)}fv.call(fG,fJ)})}},loadFromImage:function(fF,fG){this.meta=fF.meta;fA=new ff(null,{name:fF.name,size:fF.size,type:fF.type});fv.call(this,fG?(fs=fF.getAsBinaryString()):fF.getAsDataURL())},getInfo:function(){var fF=this.getRuntime(),fG;if(!fC&&fs&&fF.can("access_image_binary")){fC=new fn(fs)}fG={width:ft().width||0,height:ft().height||0,type:fA.type||fg.getFileMime(fA.name),size:fs&&fs.length||fA.size||0,name:fA.name||"",meta:fC&&fC.meta||this.meta||{}};return fG},downsize:function(){fo.apply(this,arguments)},getAsCanvas:function(){if(fw){fw.id=this.uid+"_canvas"}return fw},getAsBlob:function(fF,fG){if(fF!==this.type){fo.call(this,this.width,this.height,false)}return new ff(null,{type:fF,data:fy.getAsBinaryString.call(this,fF,fG)})},getAsDataURL:function(fG){var fH=arguments[1]||90;if(!fE){return fx.src}if("image/jpeg"!==fG){return fw.toDataURL("image/png")}else{try{return fw.toDataURL("image/jpeg",fH/100)}catch(fF){return fw.toDataURL("image/jpeg")}}},getAsBinaryString:function(fG,fI){if(!fE){if(!fs){fs=fD(fy.getAsDataURL(fG,fI))}return fs}if("image/jpeg"!==fG){fs=fD(fy.getAsDataURL(fG,fI))}else{var fH;if(!fI){fI=90}try{fH=fw.toDataURL("image/jpeg",fI/100)}catch(fF){fH=fw.toDataURL("image/jpeg")}fs=fD(fH);if(fC){fs=fC.stripHeaders(fs);if(fp){if(fC.meta&&fC.meta.exif){fC.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}fs=fC.writeHeaders(fs)}fC.purge();fC=null}}fE=false;return fs},destroy:function(){fy=null;fq.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function ft(){if(!fw&&!fx){throw new fl.ImageError(fl.DOMException.INVALID_STATE_ERR)}return fw||fx}function fD(fF){return fh.atob(fF.substring(fF.indexOf("base64,")+7))}function fz(fG,fF){return"data:"+(fF||"")+";base64,"+fh.btoa(fG)}function fv(fG){var fF=this;fx=new Image();fx.onerror=function(){fq.call(this);fF.trigger("error",new fl.ImageError(fl.ImageError.WRONG_FORMAT))};fx.onload=function(){fF.trigger("load")};fx.src=/^data:[^;]*;base64,/.test(fG)?fG:fz(fG,fA.type)}function fB(fH,fI){var fG=this,fF;if(window.FileReader){fF=new FileReader();fF.onload=function(){fI(this.result)};fF.onerror=function(){fG.trigger("error",new fl.FileException(fl.FileException.NOT_READABLE_ERR))};fF.readAsDataURL(fH)}else{return fI(fH.getAsDataURL())}}function fo(fG,fR,fK,fP){var fS=this,fT,fI,fH,fO,fN,fJ,fM,fL,fF;fp=fP;fF=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(fe.inArray(fF,[5,6,7,8])!==-1){var fQ=fG;fG=fR;fR=fQ}fJ=ft();fH=!fK?Math.min:Math.max;fI=fH(fG/fJ.width,fR/fJ.height);if(fI>1&&(!fK||fP)){this.trigger("Resize");return}fM=Math.round(fJ.width*fI);fL=Math.round(fJ.height*fI);if(!fw){fw=document.createElement("canvas")}fT=fw.getContext("2d");if(fK){fw.width=fG;fw.height=fR}else{fw.width=fM;fw.height=fL}fO=fM>fw.width?Math.round((fM-fw.width)/2):0;fN=fL>fw.height?Math.round((fL-fw.height)/2):0;if(!fp){fu(fw.width,fw.height,fF)}fr.call(this,fJ,fw,-fO,-fN,fM,fL);this.width=fw.width;this.height=fw.height;fE=true;fS.trigger("Resize")}function fr(fI,fJ,fF,fL,fH,fK){if(fi.OS==="iOS"){fm.renderTo(fI,fJ,{width:fH,height:fK,x:fF,y:fL})}else{var fG=fJ.getContext("2d");fG.drawImage(fI,fF,fL,fH,fK)}}function fu(fI,fF,fH){switch(fH){case 5:case 6:case 7:case 8:fw.width=fF;fw.height=fI;break;default:fw.width=fI;fw.height=fF}var fG=fw.getContext("2d");switch(fH){case 2:fG.translate(fI,0);fG.scale(-1,1);break;case 3:fG.translate(fI,fF);fG.rotate(Math.PI);break;case 4:fG.translate(0,fF);fG.scale(1,-1);break;case 5:fG.rotate(0.5*Math.PI);fG.scale(1,-1);break;case 6:fG.rotate(0.5*Math.PI);fG.translate(0,-fF);break;case 7:fG.rotate(0.5*Math.PI);fG.translate(fI,-fF);fG.scale(-1,1);break;case 8:fG.rotate(-0.5*Math.PI);fG.translate(-fI,0);break}}function fq(){if(fC){fC.purge();fC=null}fs=fx=fw=fA=null;fE=false}}return(fk.Image=fj)});fd("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(ff,fi,fg,fl,fe){var fj="flash",fk={};function fh(){var fn;try{fn=navigator.plugins["Shockwave Flash"];fn=fn.description}catch(fp){try{fn=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(fo){fn="0.0"}}fn=fn.match(/\d+/g);return parseFloat(fn[0]+"."+fn[1])}function fm(fo){var fn=this,fp;fo=ff.extend({swf_url:fi.swf_url},fo);fe.call(this,fo,fj,{access_binary:function(fq){return fq&&fn.mode==="browser"},access_image_binary:function(fq){return fq&&fn.mode==="browser"},display_media:fe.capTrue,do_cors:fe.capTrue,drag_and_drop:false,report_upload_progress:function(){return fn.mode==="client"},resize_image:fe.capTrue,return_response_headers:false,return_response_type:function(fq){return !ff.arrayDiff(fq,["","text","json","document"])||fn.mode==="browser"},return_status_code:function(fq){return fn.mode==="browser"||!ff.arrayDiff(fq,[200,404])},select_file:fe.capTrue,select_multiple:fe.capTrue,send_binary_string:function(fq){return fq&&fn.mode==="browser"},send_browser_cookies:function(fq){return fq&&fn.mode==="browser"},send_custom_headers:function(fq){return fq&&fn.mode==="browser"},send_multipart:fe.capTrue,slice_blob:fe.capTrue,stream_upload:function(fq){return fq&&fn.mode==="browser"},summon_file_dialog:false,upload_filesize:function(fq){return ff.parseSizeStr(fq)<=2097152||fn.mode==="client"},use_http_method:function(fq){return !ff.arrayDiff(fq,["GET","POST"])}},{access_binary:function(fq){return fq?"browser":"client"},access_image_binary:function(fq){return fq?"browser":"client"},report_upload_progress:function(fq){return fq?"browser":"client"},return_response_type:function(fq){return ff.arrayDiff(fq,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(fq){return ff.arrayDiff(fq,[200,404])?"browser":["client","browser"]},send_binary_string:function(fq){return fq?"browser":"client"},send_browser_cookies:function(fq){return fq?"browser":"client"},send_custom_headers:function(fq){return fq?"browser":"client"},stream_upload:function(fq){return fq?"client":"browser"},upload_filesize:function(fq){return ff.parseSizeStr(fq)>=2097152?"client":"browser"}},"client");if(fh()<10){this.mode=false}ff.extend(this,{getShim:function(){return fg.get(this.uid)},shimExec:function(fr,fs){var fq=[].slice.call(arguments,2);return fn.getShim().exec(this.uid,fr,fs,fq)},init:function(){var fr,fs,fq;fq=this.getShimContainer();ff.extend(fq.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});fr='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+fo.swf_url+'" ';if(fi.browser==="IE"){fr+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}fr+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+fo.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+fi.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(fi.browser==="IE"){fs=document.createElement("div");fq.appendChild(fs);fs.outerHTML=fr;fs=fq=null}else{fq.innerHTML=fr}fp=setTimeout(function(){if(fn&&!fn.initialized){fn.trigger("Error",new fl.RuntimeError(fl.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(fq){return function(){fq.call(fn);clearTimeout(fp);fo=fp=fq=fn=null}}(this.destroy))},fk)}fe.addConstructor(fj,fm);return fk});fd("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(ff,fg){var fe={slice:function(fj,fl,fh,fk){var fi=this.getRuntime();if(fl<0){fl=Math.max(fj.size+fl,0)}else{if(fl>0){fl=Math.min(fl,fj.size)}}if(fh<0){fh=Math.max(fj.size+fh,0)}else{if(fh>0){fh=Math.min(fh,fj.size)}}fj=fi.shimExec.call(this,"Blob","slice",fl,fh,fk||"");if(fj){fj=new fg(fi.uid,fj)}return fj}};return(ff.Blob=fe)});fd("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(fe){var ff={init:function(fg){this.getRuntime().shimExec.call(this,"FileInput","init",{name:fg.name,accept:fg.accept,multiple:fg.multiple});this.trigger("ready")}};return(fe.FileInput=ff)});fd("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(fh,fe){var ff="";function fg(fj,fk){switch(fk){case"readAsText":return fe.atob(fj,"utf8");case"readAsBinaryString":return fe.atob(fj);case"readAsDataURL":return fj}return null}var fi={read:function(fm,fk){var fl=this,fj=fl.getRuntime();if(fm==="readAsDataURL"){ff="data:"+(fk.type||"")+";base64,"}fl.bind("Progress",function(fo,fn){if(fn){ff+=fg(fn,fm)}});return fj.shimExec.call(this,"FileReader","readAsBase64",fk.uid)},getResult:function(){return ff},destroy:function(){ff=null}};return(fh.FileReader=fi)});fd("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(fg,fe){function ff(fi,fj){switch(fj){case"readAsText":return fe.atob(fi,"utf8");case"readAsBinaryString":return fe.atob(fi);case"readAsDataURL":return fi}return null}var fh={read:function(fl,fk){var fi,fj=this.getRuntime();fi=fj.shimExec.call(this,"FileReaderSync","readAsBase64",fk.uid);if(!fi){return null}if(fl==="readAsDataURL"){fi="data:"+(fk.type||"")+";base64,"+fi}return ff(fi,fl,fk.type)}};return(fg.FileReaderSync=fh)});fd("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(fk,fe,fg,fj,fi,fm,fh,ff){var fl={send:function(fu,fp){var fr=this,fv=fr.getRuntime();function fo(){fu.transport=fv.mode;fv.shimExec.call(fr,"XMLHttpRequest","send",fu,fp)}function fq(fx,fw){fv.shimExec.call(fr,"XMLHttpRequest","appendBlob",fx,fw.uid);fp=null;fo()}function fs(fx,fw){var fy=new fh();fy.bind("TransportingComplete",function(){fw(this.result)});fy.transport(fx.getSource(),fx.type,{ruid:fv.uid})}if(!fe.isEmptyObj(fu.headers)){fe.each(fu.headers,function(fw,fx){fv.shimExec.call(fr,"XMLHttpRequest","setRequestHeader",fx,fw.toString())})}if(fp instanceof fm){var ft;fp.each(function(fx,fw){if(fx instanceof fg){ft=fw}else{fv.shimExec.call(fr,"XMLHttpRequest","append",fw,fx)}});if(!fp.hasBlob()){fp=null;fo()}else{var fn=fp.getBlob();if(fn.isDetached()){fs(fn,function(fw){fn.destroy();fq(ft,fw)})}else{fq(ft,fn)}}}else{if(fp instanceof fg){if(fp.isDetached()){fs(fp,function(fw){fp.destroy();fp=fw.uid;fo()})}else{fp=fp.uid;fo()}}else{fo()}}},getResponse:function(fq){var fn,fp,fo=this.getRuntime();fp=fo.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(fp){fp=new fj(fo.uid,fp);if("blob"===fq){return fp}else{if(!!~fe.inArray(fq,["","text"])){fn=new fi();return fn.readAsText(fp)}else{if("arraybuffer"===fq){}else{if("json"===fq){fn=new fi();try{return ff(fn.readAsText(fp))}catch(fr){return null}}}}}}return null},abort:function(fo){var fn=this.getRuntime();fn.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!fo){}}};return(fk.XMLHttpRequest=fl)});fd("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(fe,fg){var ff={getAsBlob:function(fj){var fi=this.getRuntime(),fh=fi.shimExec.call(this,"Transporter","getAsBlob",fj);if(fh){return new fg(fi.uid,fh)}return null}};return(fe.Transporter=ff)});fd("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(ff,fh,fg,fj,fi){var fe={loadFromBlob:function(fn){var fm=this,fl=fm.getRuntime();function fk(fp){fl.shimExec.call(fm,"Image","loadFromBlob",fp.uid);fm=fl=null}if(fn.isDetached()){var fo=new fg();fo.bind("TransportingComplete",function(){fk(fo.result.getSource())});fo.transport(fn.getSource(),fn.type,{ruid:fl.uid})}else{fk(fn.getSource())}},loadFromImage:function(fl){var fk=this.getRuntime();return fk.shimExec.call(this,"Image","loadFromImage",fl.uid)},getAsBlob:function(fm,fn){var fl=this.getRuntime(),fk=fl.shimExec.call(this,"Image","getAsBlob",fm,fn);if(fk){return new fj(fl.uid,fk)}return null},getAsDataURL:function(){var fm=this.getRuntime(),fl=fm.Image.getAsBlob.apply(this,arguments),fk;if(!fl){return null}fk=new fi();return fk.readAsDataURL(fl)}};return(ff.Image=fe)});fd("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(ff,fi,fh,fl,fe){var fj="silverlight",fk={};function fm(fv){var fy=false,fr=null,fn,fo,fp,fx,fq,ft=0;try{try{fr=new ActiveXObject("AgControl.AgControl");if(fr.IsVersionSupported(fv)){fy=true}fr=null}catch(fu){var fs=navigator.plugins["Silverlight Plug-In"];if(fs){fn=fs.description;if(fn==="1.0.30226.2"){fn="2.0.30226.2"}fo=fn.split(".");while(fo.length>3){fo.pop()}while(fo.length<4){fo.push(0)}fp=fv.split(".");while(fp.length>4){fp.pop()}do{fx=parseInt(fp[ft],10);fq=parseInt(fo[ft],10);ft++}while(ft<fp.length&&fx===fq);if(fx<=fq&&!isNaN(fx)){fy=true}}}}catch(fw){fy=false}return fy}function fg(fo){var fn=this,fp;fo=ff.extend({xap_url:fi.xap_url},fo);fe.call(this,fo,fj,{access_binary:fe.capTrue,access_image_binary:fe.capTrue,display_media:fe.capTrue,do_cors:fe.capTrue,drag_and_drop:false,report_upload_progress:fe.capTrue,resize_image:fe.capTrue,return_response_headers:function(fq){return fq&&fn.mode==="client"},return_response_type:fe.capTrue,return_status_code:function(fq){return fn.mode==="client"||!ff.arrayDiff(fq,[200,404])},select_file:fe.capTrue,select_multiple:fe.capTrue,send_binary_string:fe.capTrue,send_browser_cookies:function(fq){return fq&&fn.mode==="browser"},send_custom_headers:function(fq){return fq&&fn.mode==="client"},send_multipart:fe.capTrue,slice_blob:fe.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:fe.capTrue,use_http_method:function(fq){return fn.mode==="client"||!ff.arrayDiff(fq,["GET","POST"])}},{return_response_headers:function(fq){return fq?"client":"browser"},return_status_code:function(fq){return ff.arrayDiff(fq,[200,404])?"client":["client","browser"]},send_browser_cookies:function(fq){return fq?"browser":"client"},send_custom_headers:function(fq){return fq?"client":"browser"},use_http_method:function(fq){return ff.arrayDiff(fq,["GET","POST"])?"client":["client","browser"]}});if(!fm("2.0.31005.0")||fi.browser==="Opera"){this.mode=false}ff.extend(this,{getShim:function(){return fh.get(this.uid).content.Moxie},shimExec:function(fr,fs){var fq=[].slice.call(arguments,2);return fn.getShim().exec(this.uid,fr,fs,fq)},init:function(){var fq;fq=this.getShimContainer();fq.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+fo.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+fi.global_event_dispatcher+'"/></object>';fp=setTimeout(function(){if(fn&&!fn.initialized){fn.trigger("Error",new fl.RuntimeError(fl.RuntimeError.NOT_INIT_ERR))}},fi.OS!=="Windows"?10000:5000)},destroy:(function(fq){return function(){fq.call(fn);clearTimeout(fp);fo=fp=fq=fn=null}}(this.destroy))},fk)}fe.addConstructor(fj,fg);return fk});fd("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(fe,ff,fg){return(fe.Blob=ff.extend({},fg))});fd("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(fe){var ff={init:function(fh){function fg(fj){var fk="";for(var fi=0;fi<fj.length;fi++){fk+=(fk!==""?"|":"")+fj[fi].title+" | *."+fj[fi].extensions.replace(/,/g,";*.")}return fk}this.getRuntime().shimExec.call(this,"FileInput","init",fg(fh.accept),fh.name,fh.multiple);this.trigger("ready")}};return(fe.FileInput=ff)});fd("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(fg,ff,fe){var fh={init:function(){var fj=this,fi=fj.getRuntime(),fk;fk=fi.getShimContainer();fe.addEvent(fk,"dragover",function(fl){fl.preventDefault();fl.stopPropagation();fl.dataTransfer.dropEffect="copy"},fj.uid);fe.addEvent(fk,"dragenter",function(fm){fm.preventDefault();var fl=ff.get(fi.uid).dragEnter(fm);if(fl){fm.stopPropagation()}},fj.uid);fe.addEvent(fk,"drop",function(fm){fm.preventDefault();var fl=ff.get(fi.uid).dragDrop(fm);if(fl){fm.stopPropagation()}},fj.uid);return fi.shimExec.call(this,"FileDrop","init")}};return(fg.FileDrop=fh)});fd("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(fe,fg,ff){return(fe.FileReader=fg.extend({},ff))});fd("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(fe,ff,fg){return(fe.FileReaderSync=ff.extend({},fg))});fd("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(fe,fg,ff){return(fe.XMLHttpRequest=fg.extend({},ff))});fd("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(fe,fg,ff){return(fe.Transporter=fg.extend({},ff))});fd("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(ff,fg,fe){return(ff.Image=fg.extend({},fe))});fd("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(fk,fe,fh,fg){var fj="html4",fi={};function ff(fm){var fl=this,fo=fh.capTest,fn=fh.capTrue;fh.call(this,fm,fj,{access_binary:fo(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:fo(fi.Image&&(fg.can("create_canvas")||fg.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:fo(function(){return(fg.browser==="Chrome"&&fg.version>=28)||(fg.browser==="IE"&&fg.version>=10)}()),resize_image:function(){return fi.Image&&fl.can("access_binary")&&fg.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(fp){return !!~fk.inArray(fp,["json","text","document",""])},return_status_code:function(fp){return !fk.arrayDiff(fp,[200,404])},select_file:function(){return fg.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return fl.can("select_file")},summon_file_dialog:fo(function(){return(fg.browser==="Firefox"&&fg.version>=4)||(fg.browser==="Opera"&&fg.version>=12)||(fg.browser==="IE"&&fg.version>=10)||!!~fk.inArray(fg.browser,["Chrome","Safari"])}()),upload_filesize:fn,use_http_method:function(fp){return !fk.arrayDiff(fp,["GET","POST"])}});fk.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fp){return function(){fp.call(fl);fp=fl=null}}(this.destroy))});fk.extend(this.getShim(),fi)}fh.addConstructor(fj,ff);return fi});fd("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fi,fk,fh,ff,fg,fe){function fj(){var fo,fm=[],fp=[],fl;function fn(){var fs=this,fv=fs.getRuntime(),fu,ft,fq,fx,fr,fw;fw=fk.guid("uid_");fu=fv.getShimContainer();if(fo){fq=fh.get(fo+"_form");if(fq){fk.extend(fq.style,{top:"100%"})}}fx=document.createElement("form");fx.setAttribute("id",fw+"_form");fx.setAttribute("method","post");fx.setAttribute("enctype","multipart/form-data");fx.setAttribute("encoding","multipart/form-data");fk.extend(fx.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});fr=document.createElement("input");fr.setAttribute("id",fw);fr.setAttribute("type","file");fr.setAttribute("name","Filedata");fr.setAttribute("accept",fp.join(","));fk.extend(fr.style,{fontSize:"999px",opacity:0});fx.appendChild(fr);fu.appendChild(fx);fk.extend(fr.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(fe.browser==="IE"&&fe.version<10){fk.extend(fr.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}fr.onchange=function(){var fy;if(!this.value){return}if(this.files){fy=this.files[0]}else{fy={name:this.value}}fm=[fy];this.onchange=function(){};fn.call(fs);fs.bind("change",function(){var fz=fh.get(fw),fB=fh.get(fw+"_form"),fA;if(fs.files.length&&fz&&fB){fA=fs.files[0];fz.setAttribute("id",fA.uid);fB.setAttribute("id",fA.uid+"_form");fB.setAttribute("target",fA.uid+"_iframe")}fz=fB=null},998);fr=fx=null;fs.trigger("change")};if(fv.can("summon_file_dialog")){ft=fh.get(fl.browse_button);ff.removeEvent(ft,"click",fs.uid);ff.addEvent(ft,"click",function(fy){if(fr&&!fr.disabled){fr.click()}fy.preventDefault()},fs.uid)}fo=fw;fu=fq=ft=null;fs.trigger({type:"ready",async:true})}fk.extend(this,{init:function(ft){var fq=this,fs=fq.getRuntime(),fr;fl=ft;fp=ft.accept.mimes||fg.extList2mimes(ft.accept,fs.can("filter_by_extension"));fr=fs.getShimContainer();(function(){var fu,fw,fv;fu=fh.get(ft.browse_button);if(fs.can("summon_file_dialog")){if(fh.getStyle(fu,"position")==="static"){fu.style.position="relative"}fw=parseInt(fh.getStyle(fu,"z-index"),10)||1;fu.style.zIndex=fw;fr.style.zIndex=fw-1}fv=fs.can("summon_file_dialog")?fu:fr;ff.addEvent(fv,"mouseover",function(){fq.trigger("mouseenter")},fq.uid);ff.addEvent(fv,"mouseout",function(){fq.trigger("mouseleave")},fq.uid);ff.addEvent(fv,"mousedown",function(){fq.trigger("mousedown")},fq.uid);ff.addEvent(fh.get(ft.container),"mouseup",function(){fq.trigger("mouseup")},fq.uid);fu=null}());fn.call(this);fr=null},getFiles:function(){return fm},disable:function(fr){var fq;if((fq=fh.get(fo))){fq.disabled=!!fr}},destroy:function(){var fr=this.getRuntime(),fq=fr.getShimContainer();ff.removeAllEvents(fq,this.uid);ff.removeAllEvents(fl&&fh.get(fl.container),this.uid);ff.removeAllEvents(fl&&fh.get(fl.browse_button),this.uid);if(fq){fq.innerHTML=""}fo=fm=fp=fl=null}})}return(fi.FileInput=fj)});fd("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(fe,ff){return(fe.FileReader=ff)});fd("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(fj,ff,fi,fe,fk,fm,fh,fn,fg){function fl(){var fq,fo,fr;function fp(fs){var fx=this,fv,fw,ft,fu,fy=false;if(!fr){return}fv=fr.id.replace(/_iframe$/,"");fw=fi.get(fv+"_form");if(fw){ft=fw.getElementsByTagName("input");fu=ft.length;while(fu--){switch(ft[fu].getAttribute("type")){case"hidden":ft[fu].parentNode.removeChild(ft[fu]);break;case"file":fy=true;break}}ft=[];if(!fy){fw.parentNode.removeChild(fw)}fw=null}setTimeout(function(){fm.removeEvent(fr,"load",fx.uid);if(fr.parentNode){fr.parentNode.removeChild(fr)}var fz=fx.getRuntime().getShimContainer();if(!fz.children.length){fz.parentNode.removeChild(fz)}fz=fr=null;fs()},1)}ff.extend(this,{send:function(fA,fu){var fw=this,fz=fw.getRuntime(),fv,ft,fy,fs;fq=fo=null;function fx(){var fB=fz.getShimContainer()||document.body,fC=document.createElement("div");fC.innerHTML='<iframe id="'+fv+'_iframe" name="'+fv+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';fr=fC.firstChild;fB.appendChild(fr);fm.addEvent(fr,"load",function(){var fE;try{fE=fr.contentWindow.document||fr.contentDocument||window.frames[fr.id].document;if(/^4\d{2}\s/.test(fE.title)&&fE.getElementsByTagName("address").length){fq=fE.title.replace(/^(\d+).*$/,"$1")}else{fq=200;fo=ff.trim(fE.body.innerHTML);fw.trigger({type:"progress",loaded:fo.length,total:fo.length});if(fs){fw.trigger({type:"uploadprogress",loaded:fs.size||1025,total:fs.size||1025})}}}catch(fD){if(fe.hasSameOrigin(fA.url)){fq=404}else{fp.call(fw,function(){fw.trigger("error")});return}}fp.call(fw,function(){fw.trigger("load")})},fw.uid)}if(fu instanceof fn&&fu.hasBlob()){fs=fu.getBlob();fv=fs.uid;fy=fi.get(fv);ft=fi.get(fv+"_form");if(!ft){throw new fk.DOMException(fk.DOMException.NOT_FOUND_ERR)}}else{fv=ff.guid("uid_");ft=document.createElement("form");ft.setAttribute("id",fv+"_form");ft.setAttribute("method",fA.method);ft.setAttribute("enctype","multipart/form-data");ft.setAttribute("encoding","multipart/form-data");ft.setAttribute("target",fv+"_iframe");fz.getShimContainer().appendChild(ft)}if(fu instanceof fn){fu.each(function(fD,fB){if(fD instanceof fh){if(fy){fy.setAttribute("name",fB)}}else{var fC=document.createElement("input");ff.extend(fC,{type:"hidden",name:fB,value:fD});ft.appendChild(fC)}})}ft.setAttribute("action",fA.url);fx();ft.submit();fw.trigger("loadstart")},getStatus:function(){return fq},getResponse:function(fs){if("json"===fs){if(ff.typeOf(fo)==="string"){try{return fg(fo.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(ft){return null}}}else{if("document"===fs){}}return fo},abort:function(){var fs=this;if(fr&&fr.contentWindow){if(fr.contentWindow.stop){fr.contentWindow.stop()}else{if(fr.contentWindow.document.execCommand){fr.contentWindow.document.execCommand("Stop")}else{fr.src="about:blank"}}}fp.call(this,function(){fs.dispatchEvent("abort")})}})}return(fj.XMLHttpRequest=fl)});fd("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(ff,fe){return(ff.Image=fe)});T(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var e8={},e7=moxie.core.utils.Basic.inArray;(function T(fa){var e9,fb;for(e9 in fa){fb=typeof(fa[e9]);if(fb==="object"&&!~e7(e9,["Exceptions","Env","Mime"])){T(fa[e9])}else{if(fb==="function"){e8[e9]=fa[e9]}}}})(window.moxie);e8.Env=window.moxie.core.utils.Env;e8.Mime=window.moxie.core.utils.Mime;e8.Exceptions=window.moxie.core.Exceptions;window.mOxie=e8;if(!window.o){window.o=e8}return e8})();(function(fa,fc,e9){var e8=fa.setTimeout,fb={};function T(fe){var fd=fe.required_features,ff={};function fg(fi,fj,fh){var fk={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(fk[fi]){ff[fk[fi]]=fj}else{if(!fh){ff[fi]=fj}}}if(typeof(fd)==="string"){e7.each(fd.split(/\s*,\s*/),function(fh){fg(fh,true)})}else{if(typeof(fd)==="object"){e7.each(fd,function(fi,fh){fg(fh,fi)})}else{if(fd===true){if(!fe.multipart){ff.send_binary_string=true}if(fe.chunk_size>0){ff.slice_blob=true}e7.each(fe,function(fi,fh){fg(fh,!!fi,true)})}}}return ff}var e7={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:fc.mimes,ua:fc.ua,typeOf:fc.typeOf,extend:fc.extend,guid:fc.guid,each:fc.each,getPos:fc.getPos,getSize:fc.getSize,xmlEncode:function(fe){var ff={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},fd=/[<>&\"\']/g;return fe?(""+fe).replace(fd,function(fg){return ff[fg]?"&"+ff[fg]+";":fg}):fe},toArray:fc.toArray,inArray:fc.inArray,addI18n:fc.addI18n,translate:fc.translate,isEmptyObj:fc.isEmptyObj,hasClass:fc.hasClass,addClass:fc.addClass,removeClass:fc.removeClass,getStyle:fc.getStyle,addEvent:fc.addEvent,removeEvent:fc.removeEvent,removeAllEvents:fc.removeAllEvents,cleanName:function(fd){var fe,ff;ff=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(fe=0;fe<ff.length;fe+=2){fd=fd.replace(ff[fe],ff[fe+1])}fd=fd.replace(/\s+/g,"_");fd=fd.replace(/[^a-z0-9_\-\.]+/gi,"");return fd},buildUrl:function(fe,fd){var ff="";e7.each(fd,function(fh,fg){ff+=(ff?"&":"")+encodeURIComponent(fg)+"="+encodeURIComponent(fh)});if(ff){fe+=(fe.indexOf("?")>0?"&":"?")+ff}return fe},formatSize:function(fd){if(fd===e9||/\D/.test(fd)){return e7.translate("N/A")}if(fd>1099511627776){return Math.round(fd/1099511627776,1)+" "+e7.translate("tb")}if(fd>1073741824){return Math.round(fd/1073741824,1)+" "+e7.translate("gb")}if(fd>1048576){return Math.round(fd/1048576,1)+" "+e7.translate("mb")}if(fd>1024){return Math.round(fd/1024,1)+" "+e7.translate("kb")}return fd+" "+e7.translate("b")},parseSize:fc.parseSizeStr,predictRuntime:function(ff,fe){var fd,fg;if(fe){ff.runtimes=fe}fd=new e7.Uploader(ff);fg=fd.runtime;fd.destroy();return fg},addFileFilter:function(fe,fd){fb[fe]=fd}};e7.addFileFilter("mime_types",(function(){var fe,ff;function fd(fg){var fh=[];e7.each(fg,function(fi){e7.each(fi.extensions.split(/,/),function(fj){if(/^\s*\*\s*$/.test(fj)){fh.push("\\.*")}else{fh.push("\\."+fj.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+fh.join("|")+")$","i")}return function(fi,fh,fg){if(!ff||fi!=fe){ff=fd(fi);fe=[].slice.call(fi)}if(!ff.test(fh.name)){this.trigger("Error",{code:e7.FILE_EXTENSION_ERROR,message:e7.translate("File extension error."),file:fh});fg(false)}else{fg(true)}}}()));e7.addFileFilter("max_file_size",function(fg,fe,fd){var ff;if(fe.size!==ff&&fg&&fe.size>fg){this.trigger("Error",{code:e7.FILE_SIZE_ERROR,message:e7.translate("File size error."),file:fe});fd(false)}else{fd(true)}});e7.addFileFilter("prevent_duplicates",function(fg,fe,fd){if(fg){var ff=this.files.length;while(ff--){if(fe.name===this.files[ff].name&&fe.size===this.files[ff].size){this.trigger("Error",{code:e7.FILE_DUPLICATE_ERROR,message:e7.translate("Duplicate file error."),file:fe});fd(false);return}}}fd(true)});e7.Uploader=function(fh){var fe=[],fr={},fo={},fg,fm,fj=false,fk,fl,fq;function ff(){var fu,fv=0,ft;if(this.state==e7.STARTED){for(ft=0;ft<fe.length;ft++){if(!fu&&fe[ft].status==e7.QUEUED){fu=fe[ft];if(this.trigger("BeforeUpload",fu)){fu.status=e7.UPLOADING;this.trigger("UploadFile",fu)}}else{fv++}}if(fv==fe.length){if(this.state!==e7.STOPPED){this.state=e7.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",fe)}}}function fp(ft){ft.percent=ft.size>0?Math.ceil(ft.loaded/ft.size*100):100;fi()}function fi(){var fu,ft;fm.reset();for(fu=0;fu<fe.length;fu++){ft=fe[fu];if(ft.size!==e9){fm.size+=ft.origSize;fm.loaded+=ft.loaded*ft.origSize/ft.size}else{fm.size=e9}if(ft.status==e7.DONE){fm.uploaded++}else{if(ft.status==e7.FAILED){fm.failed++}else{fm.queued++}}}if(fm.size===e9){fm.percent=fe.length>0?Math.ceil(fm.uploaded/fe.length*100):0}else{fm.bytesPerSec=Math.ceil(fm.loaded/((+new Date()-fg||1)/1000));fm.percent=fm.size>0?Math.ceil(fm.loaded/fm.size*100):0}}function fd(){var ft=this,fv=0;var fu={accept:fh.filters.mime_types,runtime_order:fh.runtimes,required_caps:fo,swf_url:fh.flash_swf_url,xap_url:fh.silverlight_xap_url};e7.each(fh.runtimes.split(/\s*,\s*/),function(fw){if(fh[fw]){fu[fw]=fh[fw]}});fc.inSeries([function(fw){if(fh.browse_button){fk=new fc.FileInput(e7.extend({},fu,{name:fh.file_data_name,multiple:fh.multi_selection,container:fh.container,browse_button:fh.browse_button}));fk.onready=function(){var fx=fc.Runtime.getInfo(this.ruid);fc.extend(ft.features,{chunks:fx.can("slice_blob"),multipart:fx.can("send_multipart"),multi_selection:fx.can("select_multiple")});fv++;fw()};fk.onchange=function(){ft.addFile(this.files)};fk.bind("mouseenter mouseleave mousedown mouseup",function(fy){if(!fj){var fx=fc.get(fh.browse_button);if(fx){if(fh.browse_button_hover){if("mouseenter"===fy.type){fc.addClass(fx,fh.browse_button_hover)}else{if("mouseleave"===fy.type){fc.removeClass(fx,fh.browse_button_hover)}}}if(fh.browse_button_active){if("mousedown"===fy.type){fc.addClass(fx,fh.browse_button_active)}else{if("mouseup"===fy.type){fc.removeClass(fx,fh.browse_button_active)}}}fx=null}}});fk.bind("error runtimeerror",function(){fk=null;fw()});fk.init()}else{fw()}},function(fw){if(fh.drop_element){fl=new fc.FileDrop(e7.extend({},fu,{drop_zone:fh.drop_element}));fl.onready=function(){var fx=fc.Runtime.getInfo(this.ruid);ft.features.dragdrop=fx.can("drag_and_drop");fv++;fw()};fl.ondrop=function(){ft.addFile(this.files)};fl.bind("error runtimeerror",function(){fl=null;fw()});fl.init()}else{fw()}}],function(){if(typeof(fh.init)=="function"){fh.init(ft)}else{e7.each(fh.init,function(fx,fw){ft.bind(fw,fx)})}if(fv){ft.trigger("PostInit")}else{ft.trigger("Error",{code:e7.INIT_ERROR,message:e7.translate("Init error.")})}})}function fs(fu,ft){if(fu.ruid){var fv=fc.Runtime.getInfo(fu.ruid);if(fv){return fv.can(ft)}}return false}function fn(fv,fx,ft){var fu=new fc.Image();try{fu.onload=function(){fu.downsize(fx.width,fx.height,fx.crop,fx.preserve_headers)};fu.onresize=function(){ft(this.getAsBlob(fv.type,fx.quality));this.destroy()};fu.onerror=function(){ft(fv)};fu.load(fv)}catch(fw){ft(fv)}}fm=new e7.QueueProgress();fh=e7.extend({runtimes:fc.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},fh);if(fh.resize){fh.resize=e7.extend({preserve_headers:true,crop:false},fh.resize)}if(e7.typeOf(fh.filters)==="array"){fh.filters={mime_types:fh.filters}}fh.filters=e7.extend({mime_types:[],prevent_duplicates:!!fh.prevent_duplicates,max_file_size:fh.max_file_size},fh.filters);fh.filters.max_file_size=e7.parseSize(fh.filters.max_file_size)||0;fh.chunk_size=e7.parseSize(fh.chunk_size)||0;fh.required_features=fo=T(e7.extend({},fh));e7.extend(this,{id:e7.guid(),state:e7.STOPPED,features:{},runtime:fc.Runtime.thatCan(fo,fh.runtimes),files:fe,settings:fh,total:fm,init:function(){var ft=this;fh.browse_button=fc.get(fh.browse_button);fh.drop_element=fc.get(fh.drop_element);if(typeof(fh.preinit)=="function"){fh.preinit(ft)}else{e7.each(fh.preinit,function(fv,fu){ft.bind(fu,fv)})}if(!fh.browse_button||!fh.url){this.trigger("Error",{code:e7.INIT_ERROR,message:e7.translate("Init error.")});return}ft.bind("FilesAdded",function(fv,fu){[].push.apply(fe,fu);e8(function(){ft.trigger("QueueChanged");ft.refresh()},1)});ft.bind("CancelUpload",function(){if(fq){fq.abort()}});if(fh.unique_names){ft.bind("BeforeUpload",function(fu,fv){var fx=fv.name.match(/\.([^.]+)$/),fw="part";if(fx){fw=fx[1]}fv.target_name=fv.id+"."+fw})}ft.bind("UploadFile",function(fC,fz){var fw=fC.settings.url,fx=fC.features,fA=fh.chunk_size,fD=fh.max_retries,fu,fB=0;if(fz.loaded){fB=fz.loaded=fA*Math.floor(fz.loaded/fA)}function fy(){if(fD-->0){e8(fv,1)}else{fz.loaded=fB;fC.trigger("Error",{code:e7.HTTP_ERROR,message:e7.translate("HTTP Error."),file:fz,response:fq.responseText,status:fq.status,responseHeaders:fq.getAllResponseHeaders()})}}function fv(){var fG,fF,fE,fH;if(fz.status==e7.DONE||fz.status==e7.FAILED||fC.state==e7.STOPPED){return}fE={name:fz.target_name||fz.name};if(fA&&fx.chunks&&fu.size>fA){fH=Math.min(fA,fu.size-fB);fG=fu.slice(fB,fB+fH)}else{fH=fu.size;fG=fu}if(fA&&fx.chunks){if(fh.send_chunk_number){fE.chunk=Math.ceil(fB/fA);fE.chunks=Math.ceil(fu.size/fA)}else{fE.offset=fB;fE.total=fu.size}}else{fE.chunk=0;fE.chunks=1}fq=new fc.XMLHttpRequest();fq.withCredentials=true;if(fq.upload){fq.upload.onprogress=function(fI){fz.loaded=Math.min(fz.size,fB+fI.loaded);fC.trigger("UploadProgress",fz)}}fq.onload=function(){if(fq.status>=400){fy();return}if(fH<fu.size){fG.destroy();fB+=fH;fz.loaded=Math.min(fB,fu.size);fC.trigger("ChunkUploaded",fz,{offset:fz.loaded,total:fu.size,response:fq.responseText,status:fq.status,responseHeaders:fq.getAllResponseHeaders()});if(fc.Env.browser==="Android Browser"){fC.trigger("UploadProgress",fz)}}else{fz.loaded=fz.size}fG=fF=null;if(!fB||fB>=fu.size){if(fz.size!=fz.origSize){fu.destroy();fu=null}fC.trigger("UploadProgress",fz);fz.status=e7.DONE;fC.trigger("FileUploaded",fz,{response:fq.responseText,status:fq.status,responseHeaders:fq.getAllResponseHeaders()})}else{fD=fh.max_retries;e8(fv,1)}};fq.onerror=function(){fy()};fq.onloadend=function(){this.destroy();fq=null};if(fC.settings.multipart&&fx.multipart){fE.name=fz.target_name||fz.name;fq.open("post",fw,true);e7.each(fC.settings.headers,function(fJ,fI){fq.setRequestHeader(fI,fJ)});fF=new fc.FormData();e7.each(e7.extend(fE,fC.settings.multipart_params),function(fJ,fI){fF.append(fI,fJ)});fF.append(fC.settings.file_data_name,fG);fq.send(fF,{runtime_order:fC.settings.runtimes,required_caps:fo,swf_url:fC.settings.flash_swf_url,xap_url:fC.settings.silverlight_xap_url})}else{fw=e7.buildUrl(fC.settings.url,e7.extend(fE,fC.settings.multipart_params));fq.open("post",fw,true);fq.setRequestHeader("Content-Type","application/octet-stream");e7.each(fC.settings.headers,function(fJ,fI){fq.setRequestHeader(fI,fJ)});fq.send(fG,{runtime_order:fC.settings.runtimes,required_caps:fo,swf_url:fC.settings.flash_swf_url,xap_url:fC.settings.silverlight_xap_url})}}fu=fz.getSource();if(!fc.isEmptyObj(fC.settings.resize)&&fs(fu,"send_binary_string")&&!!~fc.inArray(fu.type,["image/jpeg","image/png"])){fn.call(this,fu,fC.settings.resize,function(fE){fu=fE;fz.size=fE.size;fv()})}else{fv()}});ft.bind("UploadProgress",function(fu,fv){fp(fv)});ft.bind("StateChanged",function(fu){if(fu.state==e7.STARTED){fg=(+new Date())}else{if(fu.state==e7.STOPPED){for(var fv=fu.files.length-1;fv>=0;fv--){if(fu.files[fv].status==e7.UPLOADING){fu.files[fv].status=e7.QUEUED;fi()}}}}});ft.bind("QueueChanged",fi);ft.bind("Error",function(fu,fv){if(fv.file){fv.file.status=e7.FAILED;fp(fv.file);if(fu.state==e7.STARTED){e8(function(){ff.call(ft)},1)}}});ft.bind("FileUploaded",function(){fi();e8(function(){ff.call(ft)},1)});ft.trigger("Init",{runtime:this.runtime});fd.call(this)},refresh:function(){if(fk){fk.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=e7.STARTED){this.state=e7.STARTED;this.trigger("StateChanged");ff.call(this)}},stop:function(){if(this.state!=e7.STOPPED){this.state=e7.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){fj=arguments[0]!==e9?arguments[0]:true;if(fk){fk.disable(fj)}this.trigger("DisableBrowse",fj)},getFile:function(fu){var ft;for(ft=fe.length-1;ft>=0;ft--){if(fe[ft].id===fu){return fe[ft]}}},addFile:function(fu,fv){var fA=this,fx=[],ft=[],fz;function fw(){var fC=fl||fk;if(fC){return fC.getRuntime().uid}return false}function fy(fE,fD){var fC=[];fc.each(fA.settings.filters,function(fG,fF){if(fb[fF]){fC.push(function(fH){fb[fF].call(fA,fG,fE,function(fI){fH(!fI)})})}});fc.inSeries(fC,fD)}function fB(fC){var fD=fc.typeOf(fC);if(fC instanceof fc.File){if(!fC.ruid&&!fC.isDetached()){if(!fz){return false}fC.ruid=fz;fC.connectRuntime(fz)}fB(new e7.File(fC))}else{if(fC instanceof fc.Blob){fB(fC.getSource());fC.destroy()}else{if(fC instanceof e7.File){if(fv){fC.name=fv}fx.push(function(fE){fy(fC,function(fF){if(!fF){ft.push(fC)}fE()})})}else{if(fc.inArray(fD,["file","blob"])!==-1){fB(new fc.File(null,fC))}else{if(fD==="node"&&fc.typeOf(fC.files)==="filelist"){fc.each(fC.files,fB)}else{if(fD==="array"){fv=null;fc.each(fC,fB)}}}}}}}fz=fw();fB(fu);if(fx.length){fc.inSeries(fx,function(){if(ft.length){fA.trigger("FilesAdded",ft)}})}},removeFile:function(fu){var fv=typeof(fu)==="string"?fu:fu.id;for(var ft=fe.length-1;ft>=0;ft--){if(fe[ft].id===fv){return this.splice(ft,1)[0]}}},splice:function(fv,ft){var fu=fe.splice(fv===e9?0:fv,ft===e9?fe.length:ft);this.trigger("FilesRemoved",fu);this.trigger("QueueChanged");e7.each(fu,function(fw){fw.destroy()});return fu},trigger:function(fu){var fw=fr[fu.toLowerCase()],fv,ft;if(fw){ft=Array.prototype.slice.call(arguments);ft[0]=this;for(fv=0;fv<fw.length;fv++){if(fw[fv].func.apply(fw[fv].scope,ft)===false){return false}}}return true},hasEventListener:function(ft){return !!fr[ft.toLowerCase()]},bind:function(ft,fv,fu){var fw;ft=ft.toLowerCase();fw=fr[ft]||[];fw.push({func:fv,scope:fu||this});fr[ft]=fw},unbind:function(ft){ft=ft.toLowerCase();var fw=fr[ft],fu,fv=arguments[1];if(fw){if(fv!==e9){for(fu=fw.length-1;fu>=0;fu--){if(fw[fu].func===fv){fw.splice(fu,1);break}}}else{fw=[]}if(!fw.length){delete fr[ft]}}},unbindAll:function(){var ft=this;e7.each(fr,function(fv,fu){ft.unbind(fu)})},destroy:function(){this.stop();e7.each(fe,function(ft){ft.destroy()});fe=[];if(fk){fk.destroy();fk=null}if(fl){fl.destroy();fl=null}fo={};fg=fm=fj=fq=null;this.trigger("Destroy");this.unbindAll();fr={}}})};e7.File=(function(){var fe={};function fd(ff){e7.extend(this,{id:e7.guid(),name:ff.name||ff.fileName,type:ff.type||"",size:ff.size||ff.fileSize,origSize:ff.size||ff.fileSize,loaded:0,percent:0,status:e7.QUEUED,lastModifiedDate:ff.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var fg=this.getSource().getSource();return fc.inArray(fc.typeOf(fg),["blob","file"])!==-1?fg:null},getSource:function(){if(!fe[this.id]){return null}return fe[this.id]},destroy:function(){var fg=this.getSource();if(fg){fg.destroy();delete fe[this.id]}}});fe[this.id]=ff}return fd}());e7.QueueProgress=function(){var fd=this;fd.size=0;fd.loaded=0;fd.uploaded=0;fd.failed=0;fd.queued=0;fd.percent=0;fd.bytesPerSec=0;fd.reset=function(){fd.size=fd.loaded=fd.uploaded=fd.failed=fd.queued=fd.percent=fd.bytesPerSec=0}};fa.plupload=e7}(window,mOxie));var ev,aj,cS,dK,ct,dU,bj,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};ct=INLINE_JS.Upload=A.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var e8,e7,e9,T;e9={"MSIE 8.0":"flash","MSIE 9.0":"flash"};e7="html5";for(e8 in e9){T=e9[e8];if(navigator.userAgent.indexOf(e8)!==-1){e7=T}}return e7})(),choose_button_id:"choose-button",set_dest:function(T){dj.fillVal(T,"dest-folder");return this.current_dest=T},init:function(e8,e9,fa,e7){var T;this.set_dest(e8);T=this.initPLU(fa,e7);if(!e9){ag.window_load(T)}else{T()}by("#flash-upload-container > .moxie-shim").each(function(fb){if(fb.observe){dX.freshbutton_overlay(fb,$("choose-button"));return dX.freshbutton_overlay(fb,$("add-button"))}});return aj.clear()},init_basic:function(){dX.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(T){return document.fire(ct.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(e8){var e7,T,e9;e7=$("modal").cumulativeOffset();e9=e8.clientY-e7.top-3;T=e8.clientX-e7.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:e9+"px",left:T+"px"})});return $("file-box").observe("change",function(){var fa,e8,fb,e9,T,e7;eY.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();e8=$("file-box").getValue().split("\\").pop();e9=cp.make("web",au.file_icon(e8));$("basic-upload-status").down(".icon").__date(e9);fa=er("Uploading %(filename)s").format({filename:bO.em_snippet(e8,25)});$("basic-upload-status").down(".file-desc").__date(fa);$("basic-upload-status").show();$("basic-uploading-message").show();fb=$("file-box").files;e7=0;if(fb){T=fb[0].lastModifiedDate;if(T){e7=Math.round(Date.parse(T)/1000)||0}}if(!e7){e7=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=e7;return $("basic-upload-form").submit()})},initPLU:function(e7,T){return(function(e8){return function(){var fa,e9;fa={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:e8.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:e8.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(e7){e7()}return e8.uploaderLoaded()},Error:e8.uploadError.bind(e8)},init:{FilesAdded:e8.fileQueued.bind(e8),UploadProgress:e8.uploadProgress.bind(e8),FileUploaded:e8.uploadSuccess.bind(e8),BeforeUpload:e8.prepareFileForUploading.bind(e8),ChunkUploaded:e8.chunkUploaded.bind(e8),UploadComplete:aj.finished.bind(aj),Refresh:function(){if(e8.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){by("#flash-upload-container").clonePosition(by("#add-button"));by("#flash-upload-container > .moxie-shim")[0].style.width="100%";return by("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aF.UrlConstants.MOXIE_SWF_URL};if(T!=null){by.extend(fa,T)}e9=new plupload.Uploader(fa);e8.PLU=e9;return e8.PLU.init()}})(this)},reset:function(){if(aj.uploading&&aj.current_file){this.PLU.removeFile(aj.current_file)}return cS.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cS.show()}},updatePostParams:function(e8){var e7,T;T=this.PLU.settings.multipart_params;for(e7 in e8){if(e8.hasOwnProperty(e7)){T[e7]=e8[e7]}}return this.PLU.settings.multipart_params=T},fileQueued:function(e7,fb){var fa,e9,T,e8;for(e9=0,T=fb.length;e9<T;e9++){fa=fb[e9];if((typeof fa.getNative==="function"?(e8=fa.getNative())!=null?e8.dest:void 0:void 0)===void 0){fa.dest=ct.current_dest}else{fa.dest=fa.getNative().dest}}document.fire(this.QUEUE_EVT,{files:fb});by(document).trigger(this.QUEUE_EVT,{files:fb});if(V.is_quicksend_dest(fa.dest)){return}return this.show_upload()},uploadNext:function(){var fa,e8,T,e7,fb,e9;e7=aj.next();T=(br.contains(ct.APPLE_PACKAGE_EXTENSIONS,au.file_extension_for_logging(e7.name))&&e7.size%34===0)||(au.file_extension_for_logging(e7.name)===""&&e7.size%34===0&&e7.size<=3400);if(T){e7.status=plupload.FAILED;e8={file:e7,code:ct.APPLE_PACKAGE_ERROR,message:er("Can\u2019t Upload"),tooltip_text:er('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,e8);return false}fb={dest:aj.next().dest,t:bq.read(Constants.JS_CSRF_COOKIE)};fb[Constants.UID_PARAM_NAME]=cl.active_user;if((e9=au.file_extension(e7.name,fa=true))==="url"||e9==="webloc"||e9==="website"){fb.overwrite=0}ct.updatePostParams(fb);this.PLU.start();aj.last_update_time=0;aj.last_update_size=0;return true},pause:function(){return ct.PLU.stop()},uploadProgress:function(e7,T){if(!aj.cancelled_files[T.id]){document.fire(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size});return by(document).trigger(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size})}},generateUploadId:function(){var T,e7,e9,e8;T="";for(e7=e8=0;e8<=15;e7=++e8){T+=String.fromCharCode(Math.floor(Math.random()*256))}e9=ae.encode(T);e9=e9.replace(/\+/g,"-");e9=e9.replace(/\//g,"_");e9=e9.replace(/\=*$/,"");return e9},chunkUploaded:function(e7,e8,e9){var T;T=JSON.parse(e9.response||"");return this.updatePostParams({offset:T.offset})},prepareFileForUploading:function(){var T;T=aj.next();return this.updatePostParams({reported_total_size:T.size,dest:T.dest,t:bq.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(fa,e9,e8){var e7,T;try{T=JSON.parse(e8.response)}catch(fb){e7=fb;T=null}if(e8.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:e9,message:er("Quota exceeded"),tooltip_text:er("Your upload failed because you are over quota.")});return by(document).trigger(this.ERROR_EVT,{file:e9,message:er("Quota exceeded"),tooltip_text:er("Your upload failed because you are over quota.")})}else{if(e8.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:e9,message:er("Empty File")});return by(document).trigger(this.CANCEL_EVT,{file:e9,message:er("Empty File")})}else{if(e8.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:e9,message:er("File Ignored")});return by(document).trigger(this.CANCEL_EVT,{file:e9,message:er("File Ignored")})}else{if((T!=null?T.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:e9});return by(document).trigger(this.COMPLETE_EVT,{file:e9})}else{document.fire(this.ERROR_EVT,{file:e9});return by(document).trigger(this.ERROR_EVT,{file:e9})}}}}},uploadComplete:function(e7,T){document.fire(this.COMPLETE_EVT,{file:T});return by(document).trigger(this.COMPLETE_EVT,{file:T})},uploadError:function(fa,T){var e9,e7,e8;if((e8=T.file.id,bE.call(aj.file_ids(),e8)<0)&&T.code!==ct.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[T.file]});by(document).trigger(this.QUEUE_EVT,{files:[T.file]})}e7=(function(){switch(T.code){case plupload.FILE_SIZE_ERROR:return er("File too large");default:return er("Upload Error")}})();this.show_upload();e9={file:T.file,error_code:T.code,message:e7};if(T!=null?T.tooltip_text:void 0){e9.tooltip_text=T.tooltip_text}document.fire(this.ERROR_EVT,e9);return by(document).trigger(this.ERROR_EVT,e9)},grabURL:function(){var T;T=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(T)){$("url").value=T}return true},treeview_handler:function(e7,T){var e8;dj.fillVal(e7,"dest-folder");e8=$("basic-uploader-url");if(e8){e8.href=e8.href.replace(/(\/upload)(.*)(\?basic=1)/,function(fb,fa,fc,e9){return fa+dX.urlquote(e7)+e9})}return aj.clear()},new_folder:function(){bW.hide();eY.show(er("Create new folder..."),dj.fromElm("create-folder"),{action:this.do_new_folder.bind(this,cl.active_user),wit_group:"new-folder-confirm"});if(!dX.ie){return by("#first-treeview-link").trigger("click")}},do_new_folder:function(T){var e8,e7;if(!eY.vars.selected_path){aa.error(er("Please select a parent folder."));return}e7=$F("entered-name");e8=eY.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+dX.urlquote(e8)+"?to_path="+dX.urlquote(e7),{subject_user:T,onSuccess:(function(e9){return function(fa){e9.treeview_handler(au.normalize(e8)+"/"+e7);return bW.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(ct.PLU.runtime==="flash"){by("#flash-upload-container").clonePosition(by("#choose-button"));by("#flash-upload-container > .moxie-shim")[0].style.top="0px";by("#flash-upload-container > .moxie-shim")[0].style.left="0px";by("#flash-upload-container > .moxie-shim")[0].style.width="100%";return by("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{by("#"+this.choose_button_id).click((function(T){return function(e7){return by("#"+T.PLU.id+"_html5").click()}})(this));return by("#add-button").click((function(T){return function(e7){return by("#choose-button").click()}})(this))}}};aj=A.FileQueue={init:function(){return aj._listen()},_listen:function(){document.observe(ct.QUEUE_EVT,aj._file_queued.bind(this));document.observe(ct.QUEUE_ERROR_EVT,aj._file_queue_errored.bind(this));document.observe(ct.UPDATE_EVT,aj._file_updated.bind(this));document.observe(ct.COMPLETE_EVT,aj._file_completed.bind(this));document.observe(ct.ERROR_EVT,aj._file_errored.bind(this));return document.observe(ct.CANCEL_EVT,aj._file_cancelled.bind(this))},_file_queued:function(fb){var e8,fa,e7,e9,T;e9=fb.memo.files;T=[];for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];this.files[e8.id]=e8;if(!aj.uploading){this._start_uploading()}this.current_file=e8;T.push(ey("File queued:",e8.name))}return T},_file_queue_errored:function(T){this._file_queued(T);return setTimeout(((function(e7){return function(){return e7._file_errored(T)}})(this)),250)},_file_updated:function(fe){var e9,T,e7,e8,fc,fb,fa,fd,ff;e8=fe.memo.file;fb=fe.memo.percent_complete;fc=fb*e8.size;ff=fc+this.completed_size();e7=new Date().getTime();if(this.last_update_time){fa=(e7-this.last_update_time)/1000;if(ct.PLU.total.bytesPerSec){this.average_bps=ct.PLU.total.bytesPerSec}else{T=fc-this.last_update_size;e9=T/fa;this.average_bps=((ff-T)*this.average_bps+T*e9)/ff}fd=(this.queue_size()-ff)/this.average_bps;this.formatted_time=bY.format_time(fd+this.num_left())}this.current_file=e8;this.last_update_time=new Date().getTime();return this.last_update_size=fc},_file_completed:function(e7){var T;T=e7.memo.file;this.completed_files[T.id]=true;ey("File completed:",T.name);return this._check_if_finished(T)},_file_errored:function(e7){var T;T=e7.memo.file;this.errored_files[T.id]=true;ev.update_errors();cS.update_errors();ey("File errored:",T.name);return this._check_if_finished(T)},_file_cancelled:function(e7){var T;T=e7.memo.file;this.cancelled_files[T.id]=true;if(T.status===plupload.UPLOADING){ct.PLU.stop();ct.PLU.removeFile(T);ct.PLU.start()}else{ct.PLU.removeFile(T)}ey("File cancelled:",T.name);return this._check_if_finished(T)},_start_uploading:function(){var T;this.uploading=ct.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=T=(function(e7){return function(){return er("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(T){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return ct.uploadNext()}},_finished_uploading:function(){var e7,e8,e9,T;this.uploading=false;if(!this.num_files()){ev.cancelled()}else{if(this.errors()){ev.errored();cS.errored()}else{ev.completed();cS.completed()}}T=$("inline-upload-status").visible();cl.select_fq_paths=[];if(cl.inside_dir){for(e9 in this.completed_files){e8=this.files[e9];e7=au.normalize(e8.dest);cl.select_fq_paths.push(""+e7+"/"+e8.name)}cl.force_reload()}else{if(cl.in_search_mode()){b3.force_reload()}}if(T){cS.show()}eY.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return br(this.files).filter((function(T){return function(e7){return !(T.cancelled_files[e7.id]||T.errored_files[e7.id]||T.completed_files[e7.id])}})(this))[0]},cancels:function(){return br(this.cancelled_files).keys().length},errors:function(){return br(this.errored_files).keys().length},queue_size:function(){var e7,fb,e8,fa,T,e9;e8=0;e9=this.file_ids();for(fa=0,T=e9.length;fa<T;fa++){fb=e9[fa];e7=this.files[fb];if(!this.errored_files[fb]&&!this.cancelled_files[fb]&&typeof e7.size!=="undefined"){e8+=e7.size}}return e8},completed_size:function(){var fa,e7,e9,T,e8;e7=0;e8=br(this.completed_files).keys();for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];if(typeof this.files[fa].size!=="undefined"){e7+=this.files[fa].size}}return e7},file_ids:function(){return br(this.files).map((function(T){return function(e7,e8){return e8}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return br(this.file_ids()).filter((function(T){return function(e7){return !(T.cancelled_files[e7]||T.errored_files[e7]||T.completed_files[e7])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof eY!=="undefined"&&eY!==null){return eY.onHide=null}}};aj.clear();dU=A.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){dU._tmpl=e2.tmpl("upload_list_item_tmpl");return dU._listen()},_listen:function(){document.observe(ct.QUEUE_EVT,dU._file_queued);document.observe(ct.QUEUE_ERROR_EVT,dU._file_queue_errored);document.observe(ct.UPDATE_EVT,dU._file_updated);document.observe(ct.COMPLETE_EVT,dU._file_completed);document.observe(ct.ERROR_EVT,dU._file_errored);return document.observe(ct.CANCEL_EVT,dU._file_cancelled)},_file_queued:function(fb){var e8,fa,e7,e9,T;e9=fb.memo.files;T=[];for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];T.push((function(fd){var fj,fc,fg,fi,fh,fk,fe,ff;fj=fd.dest;if(V.is_quicksend_dest(fj)){V.add_external_file(fd);return}fk=az.format_bytes(fd.size||0);fc=dU._tmpl({file:fd,icon:au.file_icon(fd.name),filename_snippet:bO.em_snippet(fd.name,dU.FILENAME_SNIPPET_LENGTH),size:fk,dest:fj,dest_snippet:bO.em_snippet(er("Dropbox")+fj,dU.DEST_SNIPPET_LENGTH,0),Sprite:cp});$("upload-files-list").__sert(fc);fi=$(fd.id);fh=aj.num_files();if(dm.show_share_button_in_file_uploader){fg=by("#"+fd.id);fg.find(".dest-col").hide()}fe=$("upload-files-list");if(fh<=6){fe.removeClassName("scroll")}else{fe.addClassName("scroll")}fe.scrollTop=fe.scrollHeight;fi.down(".dest").observe("click",function(){cl.reload_fqpath(fi.readAttribute("data-dest"),true);return eY.hide()});ff=fi.down(".status-col").down("a.small-x-button");ff.stopObserving("click");ff.observe("click",function(fl){document.fire(ct.CANCEL_EVT,{file:fd});return by(document).trigger(ct.CANCEL_EVT,{file:fd})});return fi.down(".upload-progress-bar").setStyle({width:"0"})})(e8))}return T},_file_queue_errored:function(T){dU._file_queued(T);return dU._file_errored(T)},_file_updated:function(e9){var e8,fa,e7,T;e8=e9.memo.file;fa=$(e8.id);if(aj.num_files()===1){T=er("%(time_left)s left").format({time_left:aj.formatted_time});fa.down(".time-col").__date(T)}e7=parseInt(e8.percent,10)+"%";if(e7==="100%"){fa.down(".time-col").__date();fa.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return fa.down(".upload-progress-bar").setStyle({width:e7})},_file_completed:function(e7){var T,e8,e9;T=e7.memo.file;T.completed=true;e9=$(T.id);e9.addClassName("complete");if(dm.show_share_button_in_file_uploader&&!V.is_quicksend_dest(T.dest)){e8=by("#"+T.id);e8.find(".share-link").show();a5.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",cl.active_user,{});e8.on("click",function(fc){var fb,fa;eY.hide();a5.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",cl.active_user,{});fb=T.dest+"/"+T.name;fa="file_uploader";return dm.shmodel(fb,fa)})}setTimeout(function(){return e9.down(".status-col").__date(cp.make("web","s_check"))},0);return e9.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(e7){var T,e8;T=e7.memo.file;e8=$(T.id);if(e8){return dU._actual_file_errored(e7)}else{return setTimeout((function(e9){return function(){return dU._actual_file_errored(e7)}})(this),0)}},_actual_file_errored:function(fa){var T,e8,e7,fb,e9;e7=fa.memo.file;fb=$(e7.id);fb.addClassName("error");fb.down(".dest-col").hide();fb.down(".time-col").__date();fb.down(".status-col").__date(cp.make("web","nosync"));fb.down(".upload-progress-bar").setStyle({width:"100%"});if(V.is_quicksend_dest(e7.dest)){return}e8=fa.memo.message||er("Upload Error");T=void 0;if(fa.memo.tooltip_text){T=fa.memo.tooltip_text}else{T=er('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');by(document).on("click","a#basic_link",function(){du.show_basic_upload();return false})}fb.down(".error-msg").__date(e8);e9=fb.down(".error-details");e9.observe("mouseover",function(){return eb.show(e9,T)});return fb.down(".error-col").show()},_file_cancelled:function(e7){var T,e8;T=e7.memo.file;e8=$(T.id);e8.addClassName("cancelled");e8.down(".dest-col").__date(er(e7.memo.message||"Canceled"));e8.down(".time-col").__date();e8.down(".status-col").__date(cp.make("web","cancelsync"));return e8.down(".upload-progress-bar").setStyle({width:"100%"})}};ev=A.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return ev._listen()},_listen:function(){document.observe(ct.QUEUE_EVT,ev._file_queued.bind(this));return document.observe(ct.UPDATE_EVT,ev._file_updated.bind(this))},_file_queued:function(e7){var T;T=new Element("a",{"class":"small-x-button"});T.observe("click",function(){var fa,fc,fb,e9,e8;aj.all_cancelled=true;fa=aj.file_ids().slice(0);e8=[];for(fb=0,e9=fa.length;fb<e9;fb++){fc=fa[fb];if(!aj.completed_files[fc]&&!aj.errored_files[fc]){document.fire(ct.CANCEL_EVT,{file:aj.files[fc]});e8.push(by(document).trigger(ct.CANCEL_EVT,{file:aj.files[fc]}))}else{e8.push(void 0)}}return e8});return this.elem.down(".status").__date(T)},_file_updated:function(e9){var e8,e7,T;if(aj.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");e8=a6("%d file","%d files",aj.num_non_cancelled_files()).format(aj.num_non_cancelled_files());this.elem.down(".num-files").__date(e8);e7=er("- %(size)s").format({size:az.format_bytes(ct.PLU.total.size)});this.elem.down(".size").__date(e7);if(aj.formatted_time){T=er("%(time_left)s left").format({time_left:aj.formatted_time});this.elem.down(".time-left").__date(T)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(aj.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(ct.PLU.runtime==="flash"){return by("#flash-upload-container").clonePosition(by("#add-button"))}}},update_errors:function(){var T;T=a6("- %d error","- %d errors",aj.errors()).format(aj.errors());return $("bulk-upload-status").down(".num-errors").__date(T)},completed:function(){var e7,T;$("hide-button").hide();$("done-button").show();if(aj.num_files()>1){this.elem.addClassName("complete");e7=a6("Uploaded %d file","Uploaded %d files",aj.num_non_cancelled_files()).format(aj.num_non_cancelled_files());this.elem.down(".num-files").__date(e7);T=er("- %(size)s").format({size:az.format_bytes(aj.completed_size())});this.elem.down(".size").__date(T);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cp.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var T;$("hide-button").hide();$("done-button").show();this.completed();T=a6("- %d error","- %d errors",aj.errors()).format(aj.errors());return this.elem.down(".num-errors").__date(T)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(aj.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(er("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cp.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cS=A.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(ct.QUEUE_EVT,cS._file_queued.bind(this));return document.observe(ct.UPDATE_EVT,cS._file_updated.bind(this))},_file_queued:function(e8){var e7,T;e7=$("inline-upload-status");e7.removeClassName("error");e7.removeClassName("complete");e7.down(".icon").__date(cp.make("web","s_sync"));e7.down(".file-desc").__date(er("Starting upload..."));e7.down(".num-errors").__date();T=a6("%d file","%d files",aj.num_left()).format(aj.num_left());e7.down(".view-details").__date(T);e7.down(".status").__date();return e7.down(".inline-upload-progress").style.width="0%"},_file_updated:function(fc){var fb,e8,e9,fa,e7,T;fb=$("inline-upload-status");e8=fc.memo.file;fb.down(".icon").__date(cp.make("web","s_sync"));e9=er("Uploading %(filename)s").format({filename:bO.em_snippet(e8.name,this.FILENAME_SNIPPET_LENGTH)});fb.down(".file-desc").__date(e9);if(aj.num_left()>1){T=a6("%d file left","%d files left",aj.num_left()-1).format(aj.num_left()-1);fb.down(".view-details").__date(T)}else{fb.down(".view-details").__date(er("View details"))}if(aj.formatted_time){e7=er("%(time_left)s left").format({time_left:aj.formatted_time});fb.down(".status").__date(e7)}fa=e8.percent+"%";return fb.down(".inline-upload-progress").style.width=fa},update_errors:function(){var T,e7;T=$("inline-upload-status");e7=a6("- %d error","- %d errors",aj.errors()).format(aj.errors());return T.down(".num-errors").__date(e7)},add_x_button:function(){var T,e7;e7=new Element("a",{"class":"small-x-button"});e7.observe("click",function(){cS.hide();return ct.reset()});T=$("inline-upload-status");return T.down(".status").__date(e7)},completed:function(){var e7,T;e7=$("inline-upload-status");e7.addClassName("complete");e7.removeClassName("error");e7.down(".icon").__date(cp.make("web","s_check"));if(aj.num_files()>1){T=er("Uploaded %(num_files)d files").format({num_files:aj.num_non_cancelled_files()})}else{T=er("Uploaded %(filename)s").format({filename:bO.em_snippet(aj.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}e7.down(".file-desc").__date(T);e7.down(".num-errors").__date();e7.down(".view-details").__date(er("View details"));this.add_x_button();return e7.down(".inline-upload-progress").style.width="100%"},errored:function(){var e8,e7,T,e9;e8=$("inline-upload-status");e8.addClassName("error");e8.removeClassName("complete");e8.down(".icon").__date(cp.make("web","nosync"));e7=void 0;if(aj.num_files()>1){e7=er("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:aj.num_non_cancelled_files()-aj.errors(),num_files:aj.num_non_cancelled_files()});e8.down(".file-desc").__date(e7);e9=a6("- %d error","- %d errors",aj.errors()).format(aj.errors());e8.down(".num-errors").__date(e9)}else{if(aj.current_file!=null){T=bO.em_snippet(aj.current_file.name,this.FILENAME_SNIPPET_LENGTH)}e7=T?er("Unable to upload %(filename)s").format({filename:T}):er("Unable to upload file");e8.down(".file-desc").__date(e7);e8.down(".num-errors").__date()}e8.down(".view-details").__date(er("View details"));this.add_x_button();return e8.down(".inline-upload-progress").style.width="100%"},show:function(T){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bj=A.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bj.supported()&&cl.inside_dir&&!(cl.in_search_mode()&&b3.fulltext_search_enabled)},browse_indicators_enabled:function(){var e9,e7,e8,T;if(!bj.enabled()){return false}e7=["modal-overlay"];if(ct.choose_button_id.startsWith("wizard-")){e7.push("wizard-overlay")}for(e8=0,T=e7.length;e8<T;e8++){e9=e7[e8];if($(e9).visible()){return false}}return true},modal_indicators_enabled:function(){var T;return bj.enabled()&&by("#modal #upload-modal-dropzone").length&&by("#modal").visible()&&((T=by("#modal").offset())!=null?T.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(T){return by(T).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(e7){var T;if(!bj._drop_indicators){if(bj.modal_indicators_enabled()){T=$("upload-modal-dropzone");by(T).clonePosition(by("#modal"),{setLeft:false,setTop:false});by(T).fadeIn(500);bj._show_border_drop_indicators()}else{if(bj.browse_indicators_enabled()){bL._add_drop_indicators(e7)}else{return}}$("drag-status").removeClassName("active");return bj._drop_indicators=true}},hide_drop_indicators:function(){if(bj._drop_indicators){bj._hide_border_drop_indicators();bL._remove_drop_indicators();if(!bj._notifications_cleared){aa.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bj._drop_indicators=false;bj._drop_dest_folder=null;return bj._notifications_cleared=false}),500)}return bj._notifications_cleared=true},folder_dragover:function(T){var e7;if(bj.browse_indicators_enabled()&&bj._drop_indicators){if(dK.disabled){if(bj._drop_dest_folder==null){e7=er("You can't upload files because you're out of space.");aa.error(e7,60);bj._notifications_cleared=false;bj._show_border_drop_indicators()}}else{if(T!==bj._drop_dest_folder){if(T===cl.containing_fq_path()){if(cl.inside_read_only_shared_folder){e7=er("You don't have permission to add to this folder.");aa.error(e7,60)}else{e7=er("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:du.upload_plain_snippet()});aa.success(new e2(e7),60);bj._show_border_drop_indicators()}bj._notifications_cleared=false}else{aa.clear();bj._hide_border_drop_indicators()}}}return bj._drop_dest_folder=T}},supports_recursive_upload:function(T){var e7;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(T!=null?(e7=T[0])!=null?e7.webkitGetAsEntry:void 0:void 0)},upload:function(e8,fa,e7){var e9,fc,fb,T;if(e7==null){e7=null}if(cl.inside_read_only_shared_folder){return}if(dK.disabled){fc=er("You can't upload files because you're out of space.");return aa.error(fc)}else{if(bj.supports_recursive_upload(e7)){return bj._recursive_upload(e8,e7)}else{for(fb=0,T=fa.length;fb<T;fb++){e9=fa[fb];e9.dest=e8}return bj._upload(fa,e7)}}},_recursive_upload:function(fh,fe){var fj,e8,e9,fg,fc,fk,e7,fi,fb,fd,T,fa,ff;e7=[];fb=[];fd=function(fl,fm){fl.dest=fh+au.parent_dir(fm.fullPath);return e7.push(fl)};for(fa=0,ff=fe.length;fa<ff;fa++){fi=fe[fa];fg=fi.webkitGetAsEntry();if(fg!==null){if(fg.isDirectory){if(V.is_quicksend_dest(fh)){aa.error(er("Please select files instead of folders."))}else{fb.push(fg)}}else{fd(fi.getAsFile(),fg)}}}e9=0;fk=0;T=function(fl,fn){var fm;fm=er('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fn.name});aa.error(new e2(fm));return by("#use-advanced-uploader").on("click",function(fo){fo.preventDefault();return du.show_upload()})};fj=3000;fc=0;e8=function(){var fl;while(fb.length){fg=fb.pop();if(fg!==null){if(fg.isDirectory){(function(fn){var fm;fm=fn.createReader();e9+=1;return fm.readEntries(function(fo){var fr,fq,fp;if(fo.length!==0){for(fq=0,fp=fo.length;fq<fp;fq++){fr=fo[fq];fb.push(fr)}return fm.readEntries(arguments.callee)}else{return e9-=1}},function(fo){e9-=1;return T(fo,fn)})})(fg)}else{fk+=1;fl=function(fm){return function(fn){fd(fn,fm);return fk-=1}};fg.file(fl(fg),function(fm){fk-=1;return T(fm,fg)})}}}if(e7.length>fj&&!fc){fc=1;aa.error(er("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fj}));return}if(e9||fk){return e8.defer()}else{if(e7.length){return bj._upload(e7)}}};return e8()},_upload:function(e9,e7){var T,e8;if(e7==null){e7=null}if(e7){T=this._parse_upload_items(e7)}e8=function(){var fc,fe,fb,fd,fa;fa=[];for(fe=0,fb=e9.length;fe<fb;fe++){fc=e9[fe];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T!=null?(fd=T[fc.name])!=null?fd.isDirectory:void 0:void 0)){fc.is_directory=true}fc.id=plupload.guid();fa.push(ct.PLU.addFile(fc))}return fa};if($("modal").visible()){return e8()}else{du.show_upload(e8);return eY.hide(null,true)}},_parse_upload_items:function(e7){var e8,e9,fa,T;e8={};for(fa=0,T=e7.length;fa<T;fa++){e9=e7[fa];if(e9.getAsEntry){e9=e9.getAsEntry()}else{if(e9.webkitGetAsEntry){e9=e9.webkitGetAsEntry()}}e8[e9.name]=e9}return e8}};dK=A.OverQuotaUploads={disabled:false,init:function(T){this.disabled=T;if(this.disabled){return by("body").addClass("uploads-disabled")}}};var du;du=INLINE_JS.FileOps=A.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(e7){var fa,e9,T,e8;e8=eY.vars.apps;for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];if(fa.app_id!==e7){continue}return fa}return null},create_album_from_folder:function(e7,T){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:e7,album_name:T},job:true,job_user:cD.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:er("Creating album..."),onSuccess:function(e8){var e9;e9=JSON.parse(e8.responseText);return window.location.href=e9.url}})},dir_handler:function(e9,e8){var e7,T;if(typeof e8==="string"){e8=$(e8)}e7=$$(".treeview .highlight")[0];if(e7){e7.removeClassName("highlight")}T=e8.up("div");T.addClassName("highlight");eY.selected_div=T;if(eY.shown()){e8.blur()}document.fire("db:dir_click",{path:e9});return eY.vars.selected_path=e9},show_folder_pick:function(fb,e9,e8,fa,T){var e7;dj.fillVal(au.filename(e9).escapeHTML(),"folder-pick-file");bW.move("copy-move-treeview","folder-pick-treeview",{user:cl.active_user});e7=(T?er("Move"):er("Copy"));dj.fillVal(e7,"folder-pick-action-text");eY.show(fb,$("folder-pick"),{fq_path:e9,action:e8,folder:fa});return by("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(fc,fb,e9,fa){var e7,T,e8;e8=a0.profile_files(e9);T=a0.profile_summary(e8);dj.fillVal(T,"bulk-folder-pick-file");bW.move("copy-move-treeview","bulk-folder-pick-treeview",{user:cl.active_user});if(fb==="move"){e7=er("Move")}else{if(fb==="copy"){e7=er("Copy")}else{e7=er("Restore")}}dj.fillVal(e7,"bulk-folder-pick-action-text");eY.show(fc,$("bulk-folder-pick"),{files:e9,action:fa});return by("#first-treeview-link").trigger("click")},show_copy:function(T,e7){var e8;e8=(e7?er("Copy folder to..."):er("Copy file to..."));bW.set_params({disable_read_only:true});return du.show_folder_pick(e8,T,du.do_copy,e7,false)},show_copy_bulk:function(T){var e7;e7=a6("Copy %(item_count)s item to...","Copy %(item_count)s items to...",T.length).format({item_count:T.length});bW.set_params({disable_read_only:true});return du.show_bulk_folder_pick(e7,"copy",T,du.do_bulk_copy)},show_compress_bulk:function(T,e7){bW.set_params({disable_read_only:true});return dE.show({title_text:a6("Compress file?","Compress files?",e7.length),body_html:a6("Do you want to compress <strong>%(filename)s</strong>?<br/>This might take a while.","Do you want to compress %(file_count)s files?<br/>This might take a while.",e7.length).format({file_count:e7.length,filename:br.escape(e7.first().filename)}),confirm_text:er("Compress"),cancel_text:er("Cancel"),confirm_callback:function(){return du.do_bulk_compress(T,e7)}})},do_bulk_compress:function(T,e8){var e7;aa.clear();e7=e8.pluck("fq_path");return cv.WebProgressRequest({url:"/cmd/compress",data:{files:e7},subject_user:T,progress_text:er("Compressing..."),success:function(fc){var fb,fa,e9;e9=JSON.parse(fc);fb=e9.compressed_files;cC(fb.length>0,"Must have at least 1 compressed file");fa=br.escape(au.filename(fb.first().fq_path));aa.success(a6("Compressed successfully to %(filename)s","Compressed %(file_count)s files successfully.",fb.length).format({file_count:fb.length,filename:fa}));return by(document).trigger(aB.COMPRESS,{original_files:e8,compressed_files:fb})}})},show_move_bulk:function(T){var e7;e7=a6("Move %(item_count)s item to...","Move %(item_count)s items to...",T.length).format({item_count:T.length});bW.set_params({disable_read_only:true});return du.show_bulk_folder_pick(e7,"move",T,du.do_bulk_move)},show_move:function(T,e7){var e8;e8=(e7?er("Move folder to..."):er("Move file to..."));bW.set_params({disable_read_only:true});return du.show_folder_pick(e8,T,du.do_move,e7,true)},show_delete:function(T,e8,e9,e7){var fa;fa=er("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:au.filename(e8).escapeHTML()});return dE.show({title_text:e9?er("Delete folder?"):er("Delete file?"),body_html:'<div class="simple-modal-word-wrap-content">'+fa+"</div>",confirm_text:er("Delete"),cancel_text:er("Cancel"),confirm_callback:function(){if(e7){return du.do_nonbrowse_delete(T,[e8])}else{return du.do_delete(T,e8)}}})},show_bulk_delete:function(T,e7){return dE.show({title_text:a6("Delete %(item_count)s item?","Delete %(item_count)s items?",e7.length).format({item_count:e7.length}),body_html:a6("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",e7.length).format({item_count:e7.length}),confirm_text:er("Delete"),cancel_text:er("Cancel"),confirm_callback:function(){return du.do_bulk_delete(T,e7)}})},show_purge:function(T,e7){return dE.show({title_text:e7?er("Permanently delete folder?"):er("Permanently delete file?"),body_html:er("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:au.filename(T).escapeHTML()}),confirm_text:er("Permanently delete"),cancel_text:er("Cancel"),confirm_callback:function(){return du.do_purge(cl.find_file(T))}})},show_bulk_purge:function(T){return dE.show({title_text:a6("Permanently delete %d item?","Permanently delete %d items?",T.length).format(T.length),body_html:a6("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",T.length).format({item_count:T.length}),confirm_text:er("Permanently delete"),cancel_text:er("Cancel"),confirm_callback:function(){return du.do_bulk_purge(T)}})},show_bulk_restore:function(e7,T){return dE.show({title_text:a6("Restore %d item...","Restore %d items...",e7.length).format(e7.length),body_html:a6("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",e7.length).format({item_count:e7.length}),confirm_text:er("Restore"),cancel_text:er("Cancel"),confirm_callback:function(){return du.do_bulk_restore(e7)}})},wrap_strong:function(T){if(cl.containing_fq_path()===""){return T.escapeHTML()}else{return"<strong>"+T.escapeHTML()+"</strong>"}},upload_snippet:function(e8){var T,e7;if(e8==null){e8=1000}if(cD.get_viewer().is_paired&&cl.active_user.is_team){e7=bO.em_snippet(cD.get_viewer().team_name,e8).escapeHTML()}if(cl.containing_fq_path()===""){if(cD.get_viewer().is_paired){if(cl.active_user.is_team){return er(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:e7})}else{return er(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return er(" upload to your Dropbox")}}else{T=bO.em_snippet(au.filename(cl.containing_fq_path()),e8).escapeHTML();if(cD.get_viewer().is_paired){if(cl.active_user.is_team){return er(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T,team_name:e7})}else{return er(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}else{return er(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}},upload_short_snippet:function(e8){var e7,T;if(e8==null){e8=1000}T=cl.containing_fq_path();if(!T){return er("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}e7=bO.em_snippet(au.filename(T),e8);return er("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:e7})},upload_plain_snippet:function(T){if(T==null){T=1000}return this.upload_snippet(T).replace("<strong>","'").replace("</strong>","'")},show_upload:function(fe,T,fb){var e8,fc,e7,e9,fd,fa;e8=cl.containing_fq_path();if(dK.disabled){dj.fillVal(this.wrap_strong(au.filename(e8)),"disabled-upload-foldername");e7=this.upload_short_snippet(20);eY.show(e7,$("disabled-upload-modal"),{},false);return}by(document).trigger(this.SHOW_UPLOAD_EVT,{source:T,has_callback:fe!=null});if((!FlashDetect.versionAtLeast(9))&&ct.runtimes==="flash"){du.show_basic_upload();$("enhanced-upload-toggle").hide();return}dj.fillVal(this.upload_snippet(20),"upload-foldername");dj.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bj.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}e7=this.upload_short_snippet(20);eY.show(e7,dj.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,aj.num_files());fa=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(e9=0,fd=fa.length;e9<fd;e9++){fc=fa[e9];if(fc!=null){fc.observe("click",function(){du.show_basic_upload();return false})}}if(!aj.num_files()){ct.init(au.normalize(e8),true,fe,fb)}else{ct.set_dest(au.normalize(e8))}return cS.hide()},show_basic_upload:function(){dj.fillVal(this.upload_snippet(20),"basic-upload-foldername");eY.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){du.show_upload();return false});ct.set_dest(au.normalize(cl.containing_fq_path()));return ct.init_basic()},show_undelete:function(T){var e7,e8,e9;dj.fillVal(T.filename.escapeHTML(),"undelete_filename");e7=cp.make("web",T.icon,{});e7.addClassName("link-img");e7.style.backgroundColor="transparent";e8=du.build_revisions_uri(T.fq_path,cl.active_user,{undelete:1});$$(".undelete-icon").invoke("update",e7);$$(".undelete-other-versions")[0].href=e8;$$(".undelete-link")[0].href=e8;e9=er("Restore file?");return eY.show(e9,$("undelete-modal"),{file:T})},do_undelete:function(e7){var T,e8;T=eY.vars.file;e8=er("Restored '%(file_name)s'").format({file_name:T.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[T.fq_path]},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Restoring..."),onSuccess:function(e9){eY.hide();aa.success(e8);return document.fire(aB.RESTORE,{files:[T]})}});return false},do_copy:function(e8,e7){var T;e8=e8||eY.vars.fq_path;e7=e7||eY.vars.selected_path;T=cl.find_file(e8);cC(T,"Trying to copy a file we couldn't find.");return du.do_bulk_copy([T],e7)},do_bulk_copy:function(fb,e7){var e9,fa,e8,fc,T;cl.pre_action_selection=eM.get_selected_fq_paths();fb=fb||eY.vars.files;cC(fb.length>0,"Tried to copy 0 files");if(typeof e7==="undefined"){if(typeof eY.vars.selected_path==="undefined"){aa.error(er("You need to select a destination for the file."));return}else{e7=eY.vars.selected_path}}e7=au.normalize(e7);e8=0;for(fc=0,T=fb.length;fc<T;fc++){e9=fb[fc];if(e9.dir){if((e7+"/").indexOf(e9.fq_path+"/")===0){aa.error(er("You cannot copy a folder into itself."));return}}}fa=fb.pluck("fq_path");aa.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:fa,to_path:e7},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Copying..."),onSuccess:function(fk){var fg,fj,fd,fl,ff,fh,fe,fi;fg=fk.responseText.evalJSON().changesets;fj=fa.length;fl=bO.em_snippet(au.filename(e7),du.NOTIFICATION_SNIPPET_LEN).escapeHTML();ff=a6("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fj);ff=ff.format({count:fj,location:fl});S.notifyWithUndo(new e2(ff),fg,du.do_rollback);fd=[];fi=fk.responseText.evalJSON().new_browse_files;for(fh=0,fe=fi.length;fh<fe;fh++){e9=fi[fh];fd.push(e9.fq_path)}cl.select_fq_paths=fd;$("reload-link").observe("click",function(){return aY.set_path_url(null,e7)});bW.schedule_reset();return document.fire(aB.COPY,{files:fb,to_fq_path:e7})}})},bulk_move_error:function(T,fe){var fc,e9,ff,fa,fg,fb,e7,e8,fd;ff=cl.find_file(fe);fa=a0.profile_files(T);e8=void 0;fb=void 0;fd=void 0;if(ff){fb=ff.dir;e8=ff.fq_path;fd=ff.target_ns||ff.ns_id}else{if(cl.inside_dir&&cl.can_get_details_from_fq_path(fe)){e9=cl.details_from_fq_path(fe);fb=true;e8=e9.fq_path;fd=e9.ns_id}else{fb=true;e8=fe;fd=void 0}}fg=T.pluck("fq_path").collect(au.normalize);if(-1!==fg.indexOf(au.normalize(e8))){return er("You cannot copy a folder into itself.")}fc=e7=function(fh){var fi;fi=au.parent_dir(fh.fq_path);return fi===(e8||"/")};if(T.all(fc)){return a6("That file already exists in that folder.","Those files already exist in that folder.",T.length)}if(!fb){return er("You cannot put files inside one another.")}if(fa.target_namespaces>0&&fd&&fd!==Constants.root_ns){if(fa.sandboxes>0){if(ff.is_sandbox()){return er("You're not allowed to put an application folder inside another application folder.")}else{if(ff.is_shared_folder()){return er("You're not allowed to put an application folder inside a shared folder.")}}}else{if(fa.shared_folders>0){if(ff.is_sandbox()){return er("You're not allowed to put a shared folder inside an application folder.")}else{if(ff.is_shared_folder()){return er("You're not allowed to put a shared folder inside another shared folder.")}}}}return er("You're not allowed to nest special folders.")}if(cl.public_folder_enabled){if(e8==="/Public"&&fa.target_namespaces>0){return er("You're not allowed to move shared folders to your Public folder.")}}if(fa.public_folder>0){return er("You're not allowed to move your Public folder.")}if(fa.deleted>0){return er("Moving deleted folders or files is not allowed.")}},do_move:function(e8,e7){var T;e8=e8||eY.vars.fq_path;e7=e7||eY.vars.selected_path;T=cl.find_file(e8);cC(T,"Trying to move a file we couldn't find.");return du.do_bulk_move([T],e7)},do_bulk_move:function(fa,fb){var e8,e9,T,e7;cl.pre_action_selection=eM.get_selected_fq_paths();fa=fa||eY.vars.files;if(!fa){return}cC(fa.length>0,"Tried to move 0 files");T=fb||eY.vars.selected_path||"";T=au.normalize(T);e8=du.bulk_move_error(fa,T);if(e8){aa.error(e8);return}e9=fa.pluck("fq_path");aa.clear();e7="/cmd/move";return new Ajax.DBRequest(e7,{parameters:{files:e9,to_path:T},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Moving..."),onSuccess:function(ff){var fe,fd,fc,fg;fe=ff.responseText.evalJSON().changesets;fd=e9.length;fc=bO.em_snippet(au.filename(T),du.NOTIFICATION_SNIPPET_LEN).escapeHTML();fg=a6("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fd);fg=fg.format({count:fd,location:fc});S.notifyWithUndo(new e2(fg),fe,du.do_rollback);$("reload-link").observe("click",function(){return aY.set_path_url(null,T)});bW.schedule_reset();return document.fire(aB.MOVE,{files:fa,to_fq_path:T})}})},do_rollback:function(T){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(T)},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Undoing..."),onSuccess:function(e7){var e8;e8=er("Undo complete.");aa.success(e8);cC(cl.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(cl.in_search_mode()){b3.select_fq_paths=cl.pre_action_selection;b3.force_reload()}else{cl.select_fq_paths=cl.pre_action_selection;cl.force_reload()}return cl.pre_action_selection=false}})},do_bulk_delete:function(T,e9){var e7,e8;cl.pre_action_selection=eM.get_selected_fq_paths();e9=e9||eY.vars.files;cC(e9.length>0,"Tried to delete 0 files");e8=(function(){var fc,fb,fa;fa=[];for(fc=0,fb=e9.length;fc<fb;fc++){e7=e9[fc];fa.push(e7.fq_path)}return fa})();aa.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:e8},subject_user:T,job:true,html_in_error_msg:true,progress_text:er("Deleting..."),onSuccess:function(fa){var fc,fb;fb=fa.responseText.evalJSON();fc=a6("Deleted %d item.","Deleted %d items.",e8.length).format(e8.length);S.notifyWithUndo(fc,fb.changesets,du.do_rollback);bW.schedule_reset();return document.fire(aB.DELETE,{files:e9})}})},do_delete:function(T,e8){var e7;e7=cl.find_file(e8||eY.vars.fq_path);cC(e7,"Trying to delete a file we couldn't find.");return du.do_bulk_delete(T,[e7])},do_nonbrowse_delete:function(e7,e8){var T;T=by.Deferred();new Ajax.DBRequest("/cmd/delete",{parameters:{files:e8},subject_user:e7,html_in_error_msg:true,onSuccess:function(e9){var fa;fa=a6("Deleted %(file_count)s item","Deleted %(file_count)s items",e8.length);fa=fa.format({file_count:e8.length});aa.success(fa);document.fire(aB.DELETE,{fq_paths:e8});return T.resolve(e9)},onFailure:function(e9){return T.reject(e9)}});return T.promise()},do_purge:function(T){cC(T,"Trying to purge a file we couldn't find.");return du.do_bulk_purge([T])},do_bulk_purge:function(e7){var T,e8;cC(e7.length>0,"Tried to purge 0 files");T=e7.collect(function(e9){return e9.fq_path});e8=a6("Permanently deleted %d item","Permanently deleted %d items",T.length).format(T.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:T},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Deleting..."),onSuccess:function(e9){aa.success(e8);bW.schedule_reset();return document.fire(aB.PURGE,{files:e7})}})},do_bulk_restore:function(e8){var e7,e9,T;e8=e8||eY.vars.files;T=eY.vars.user;cC(e8.length>0,"Tried to restore 0 files");e7=e8.collect(function(fa){return fa.fq_path});e9=a6("Restored %d item","Restored %d items",e7.length,{comment:"meaning, successfully restored x files and folders"}).format(e7.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:e7},subject_user:cl.active_user,job:true,html_in_error_msg:true,progress_text:er("Restoring..."),onSuccess:function(fa){aa.success(e9);bW.schedule_reset();return document.fire(aB.RESTORE,{files:e8})}})},do_folder_restore:function(e7,T){var e8;e8=function(e9){var fb,fa;fb=er("Restoring '%(folder_name)s'").format({folder_name:au.filename(e7)});fa=e9.responseText;if(fa.startsWith("err:")){fa=fa.substring(4);by("#async-result").html(fa);aa.error(new e2(fa),60)}else{fb=er("Restored '%(folder_name)s'").format({folder_name:au.filename(e7)});by("#status-of-files").text(er("Restored files"));aa.success(fb,60)}by("#restore-done-heading").text(fb);by(".pre-restore").hide();return by(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[e7]},job:true,html_in_error_msg:true,progress_text:er("Restoring..."),onSuccess:e8,onFailure:e8,subject_user:T})},do_bulk_download:function(e8){var fa,e7,e9,T;fa=new Element("form",{action:C({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,cl.active_user.id).toString(),method:"post"});for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];bN.add_vars(fa,{files:e7.fq_path})}bN.add_vars(fa,{parent_path:cl.block_hash_param||"/",w:cl.block_hash});$(document.body).__sert(fa);return fa.submit()},do_bulk_photo_view:function(e8,T){var fb,fa,e7,e9;if(T==="carousel"||T==="carousel_as_dropbox_photos"){e9={};e9[a4.UID_PARAM_NAME]=cD.get_viewer().personal_user.id;fb=String(C({scheme:"https",authority:e5.WEBSERVER,path:"/app/view_in_timeline",query:e9}))}else{fb=String(C({scheme:"https",authority:e5.WEBSERVER,path:"/photos"}))}fa=new Element("form",{action:fb,method:"post"});bN.add_vars(fa,{t:bq.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var fe,fd,fc;fc=[];for(fe=0,fd=e8.length;fe<fd;fe++){e7=e8[fe];fc.push(e7.ns_id)}return fc})()),ns_paths:JSON.stringify((function(){var fe,fd,fc;fc=[];for(fe=0,fd=e8.length;fe<fd;fe++){e7=e8[fe];fc.push(e7.ns_path)}return fc})())});$(document.body).__sert(fa);return fa.submit()},build_revisions_uri:function(e8,T,e7){if(e7==null){e7={}}e7[Constants.UID_PARAM_NAME]=String(T);return C({path:"/revisions"+e8}).updateQuery(e7)}};var bN,ap={}.hasOwnProperty;bN=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=A.Forms={submitOnlyOnce:function(){var T;T=bN.submitted!==true;bN.submitted=true;return T},disable:function(T){if(T){return setTimeout((function(){return T.disabled=true}),0)}},enable:function(T){if(T){return setTimeout((function(){return T.disabled=false}),0)}},show_button_on_change:function(T,e9){var e8,fa,fb,e7;e8=by(T);e8.hide();if(e9==null){e9=e8.closest("form")}fa=e9[0];if(this.next_id==null){this.next_id=0}fb=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[fb]=this.collect_form_vars(fa);e8.attr("data-id",fb);e9.data("button-id",fb);e7=(function(fc){return function(){var ff,fe,fd;e8.hide();fe=fc.collect_form_vars(fa);if(Object.keys(fe).length!==Object.keys(fc.initial_vars[fb]).length){e8.show()}fd=[];for(ff in fe){if(fe[ff]!==fc.initial_vars[fb][ff]){fd.push(e8.show())}else{fd.push(void 0)}}return fd}})(this);e9.change(e7);e9.find("input").filter(":text").on("input",e7);return e9.find("textarea").on("input",e7)},add_vars:function(e8,e9){var fa,e7,T;e8=$(e8);T=[];for(e7 in e9){if(!ap.call(e9,e7)){continue}fa=new Element("input",{type:"hidden",name:e7});fa.setValue(e9[e7]);T.push(e8.__sert(fa))}return T},collect_form_vars:function(fa,e9){var fd,e8,e7,fc,fb,T;if(e9==null){e9=false}fa=fa||$(document.body);e8=fa.select("input").concat(fa.select("textarea")).concat(fa.select("select"));e7={};for(fb=0,T=e8.length;fb<T;fb++){fd=e8[fb];if(fd.name&&fd.name!=="t"){fc=fd.getValue();if(fc||e9){if(typeof fc!=="string"){fc=fc.join(",")}if(e7[fd.name]!=null){if(typeof e7[fd.name]==="string"){e7[fd.name]=[e7[fd.name],fc]}else{e7[fd.name].push(fc)}}else{e7[fd.name]=fc}}}}return e7},add_loading:function(e8,T){var e7;if(e8){e8=$(e8);e7=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});e7.addClassName("text-img ajax_submit_loading");if(T==="after"){return by(e8).after(e7)}else{return by(e8).before(e7)}}},remove_loading:function(T){return by(".ajax_submit_loading").remove()},ui_form_submit:function(e7,T){T=T||e7.action;if(e7.ajax_submitted){return false}e7.ajax_submitted=true;return new bs(by(e7),T,{data:bN.collect_form_vars(e7),success:(function(e8){return function(fc,e9,fd){var fb,fa;fa=by(e7).data("button-id");if(fa!=null){fb=by(e7).find("*[type='submit'][data-id='"+fa+"']");e8.initial_vars[fa]=e8.collect_form_vars(e7);return fb.hide()}}})(this),complete:(function(e8){return function(fa,e9){return e7.ajax_submitted=false}})(this)})},ajax_submit_obj:function(fb){var ff,fh,e8,e9,e7,fa,fd,fe,fc,fg,T;e9=fb.form,T=fb.url,fg=fb.success_callback,e8=fb.fail_callback,ff=fb.button,fd=fb.more_vars,fe=fb.position,fa=fb.job,e7=fb.html_response,fh=fb.complete_callback,fc=fb.progress_text;return bN.ajax_submit(e9,T,fg,e8,ff,fd,fe,fa,e7,fh,fc)},ajax_submit:function(e9,e7,fi,e8,fg,fd,fh,fa,T,fl,fb){var fj,fc,fe,fk,ff;if(T==null){T=false}if(e9.ajax_submitted){return false}e9.ajax_submitted=true;ff=by(e9).find(".suggestion-input");for(fe=0,fk=ff.length;fe<fk;fe++){fj=ff[fe];cW.blank(fj.identify())()}if(fg){bN.add_loading(fg,fh)}fc=bN.collect_form_vars(e9);if(fd){Object.extend(fc,fd)}new Ajax.DBRequest(e7||e9.action,{noAutonotify:true,parameters:fc,job:fa,progress_text:fb,evalJSON:false,onSuccess:function(fm){bN.remove_loading();if(fi&&typeof fi==="function"){return fi(fm)}},onFailure:function(fo){var fm,fn;if(fo){if(fo.responseText.indexOf("err:")===0){fm=fo.responseText.substr(4);if(fm.indexOf("{")===0){fn=fm.evalJSON(true);bN.fill_errors(e9,fn)}else{if(T){fm=new e2(fm)}aa.error(fm)}}else{aa.error()}bN.remove_loading();if(e8&&typeof e8==="function"){return e8(fo)}}},onComplete:function(fp){var fo,fn,fm;fm=e9.select(".suggestion-input");for(fo=0,fn=fm.length;fo<fn;fo++){fj=fm[fo];cW.blur_elm(fj)}e9.ajax_submitted=false;if(fl&&typeof fl==="function"){return fl(fp)}}});return false},clear_errors:function(T){T=T||$(document.body);this.hide_errors(T);return T.select(".error-removable").invoke("remove")},fill_errors:function(fb,fa){var e8,fd,e7,e9,fc,T;fa=fa||{};fb=fb||$(document.body);bN.clear_errors(fb);for(fc in fa){if(!ap.call(fa,fc)){continue}fd=fb.down("[data-error-field-name='"+fc+"']")||fb.down("[name='"+fc+"']");if(fd){e8=new Element("br",{"class":"error-removable"});e7=new Element("span",{"class":"error-message error-removable"});e9=fa[fc];cC(e9.message_html||e9.message_text,"Error message must have a message_html or message_text property");if(e9.message_html){e7.update(e9.message_html)}else{e7.__date(e9.message_text)}by(fd).before(e7);by(fd).before(e8);T=by(fb).find("input[name='"+fc+"'], textarea[name='"+fc+"']");if(T){T.addClass("input-error")}}}return this.show_errors(fb)},value:function(e9){var e8,e7,fb,fa,T;e7=$$('input[name="'+e9+'"]');fb=null;for(fa=0,T=e7.length;fa<T;fa++){e8=e7[fa];fb=$(e8).getValue()||fb}return fb},postRequest:function(e8,e9,T){var e7;if(e9==null){e9={}}if(T==null){T={}}cC(e8!=null,"postRequest missing action");e9.t=bq.read(Constants.JS_CSRF_COOKIE);e7=new Element("form",{action:e8,method:"POST"});if(T.target){e7.target=T.target}document.body.appendChild(e7);bN.add_vars(e7,e9);return e7.submit()},hide_errors:function(e8){var fb,fa,e9,e7,T;fb=this.get_errors(e8);T=[];for(e9=0,e7=fb.length;e9<e7;e9++){fa=fb[e9];if(fa.down("span.error-message")){T.push(fa.hide())}else{T.push(void 0)}}return T},show_errors:function(e7){var fa,e9,e8,T;fa=this.get_errors(e7);for(e8=0,T=fa.length;e8<T;e8++){e9=fa[e8];if(e9.down("span.error-message")){e9.show()}}return by(".sick-input").find("label").css("top","")},get_errors:function(e7){var e8,T;T=".error-bubble, .error-plain-text";e8=e7?e7.select(T):$$(T);return e8}};by(function(){return bN.show_errors()});var Q;Q=A.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(fa,fb){var e9,e7,e8,T;if(fb==null){fb=document.body}e8=$(fb).getElementsByClassName("act_as_block");T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];T.push(this.resize(fa))}return T},resize:function(fa){var T,e8,e9,e7;fa=$(fa);e8=fa.up();T=dX.sumStyles(fa,this.elm_list);e9=dX.sumStyles(e8,this.parent_list);fa.style.width="1px";e7=e8.getWidth()-T-e9;if(e7>0){return fa.style.width=e7+"px"}}};var a8;a8=A.BrowseStyleRows={register_all:function(){var e9,e8,T,e7;e7=$$(".bs-row");for(e8=0,T=e7.length;e8<T;e8++){e9=e7[e8];this.register(e9)}Event.observe(document,"click",this.kill_current.bind(this));return by(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(e7){var T;e7=$(e7);e7.db_observe("mouseover",this.mouseover.bind(this));e7.db_observe("mouseout",this.mouseout.bind(this));T=e7.down(".action-button");if(T){return T.db_observe("click",this.click.bind(this))}},mouseover:function(e7,T){if(!T.hasClassName("no-hover")){return T.addClassName("hover")}},mouseout:function(e7,T){return T.removeClassName("hover")},click:function(e9,e7){var T,fa,e8;if(e9.target.tagName==="A"){return}fa=e7.up(".bs-row");Event.stop(e9);if(fa.hasClassName("selected")){this.kill_current(false);return}by(document).trigger("dropdown-opened");this.kill_current(false);e8=$(e9.target);if(!e8.match(".bs-actions-list *")){fa.addClassName("selected")}T=(e8.hasClassName("bs-row")?e8:e8.up(".bs-row"));return T.style.zIndex=9},kill_current:function(fa){var fb,e9,e7,e8,T;e8=$$(".bs-row.selected");T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fb=e8[e9];fb.removeClassName("selected");T.push(fb.style.zIndex="")}return T}};var ef;ef=A.Bubble={make:function(fj,fu,fm,fh,fd){var fa,fk,fr,e9,e8,ft,fo,fi,fg,fb,ff,fl,fq,fe,T,fc,e7,fs,fp,fn;if(fu==null){fu="left"}fd=fd!=null?fd:{};if(["left","right"].contains(fu)){fm=fm||"middle";cC(["top","middle","bottom"].contains(fm),"expected tail position ['top', 'middle', 'bottom'], got "+fm)}else{if(["bottom","top"].contains(fu)){fm=fm||"center";cC(["left","center","right"].contains(fm),"expected tail position ['left', 'center', 'right'], got "+fm)}else{if(!["none"].contains(fu)){cC(false,"unexpected tail side, got "+fu)}}}fl=new Element("table");if(fd.style==="titled"){fl.addClassName("bluebubble");fq="bluebubble"}else{fl.addClassName("bubble");fq="bubble"}if(fh){fl.style.width=fh+"px"}T=new Element("tbody");fs=new Element("tr");fc=new Element("td");fc.addClassName("tl");ff=new Element("td");ff.addClassName("t");if(fd.style==="titled"){if(fh){ff.style.width=(fh-42)+"px"}}e7=new Element("td");e7.addClassName("tr");if(fu==="top"){fe=new Element("img",{src:"/static/images/"+fq+"_arrow_top.png"});fe.addClassName("tarrow");if(fd.style==="titled"){fe.addClassName("arrow-"+fm);fk=new Element("div");fk.addClassName("arrow-container");if(fh){fk.style.width=(fh-42)+"px"}fk.__sert(fe);ff.__sert(fk)}else{ff.style.textAlign=fm;ff.__sert(fe)}}fs.__sert(fc);fs.__sert(ff);fs.__sert(e7);T.__sert(fs);fp=new Element("tr");fi=new Element("td");fi.addClassName("l");if(fu==="left"){if(fd.style==="titled"){fa=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{fa=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}fa.addClassName("arrow");fi.__sert(fa);fi.vAlign=fm}fo=new Element("td");fo.addClassName("c");fo.update(fj);fg=new Element("td");fg.addClassName("r");if(fu==="right"){fb=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});fb.addClassName("rarrow");fg.__sert(fb);fg.vAlign=fm}fp.__sert(fi);fp.__sert(fo);fp.__sert(fg);T.__sert(fp);fn=new Element("tr");e8=new Element("td");e8.addClassName("bl");fr=new Element("td");fr.addClassName("b");if(fu==="bottom"){e9=new Element("img",{src:"/static/images/"+fq+"_arrow_bottom.png"});e9.addClassName("barrow");if(fd.style==="titled"){e9.addClassName("arrow-"+fm);fk=new Element("div");fk.addClassName("arrow-container");if(fh){fk.style.width=(fh-42)+"px"}fk.__sert(e9);fr.__sert(fk)}else{fr.style.textAlign=fm;fr.__sert(e9)}}ft=new Element("td");ft.addClassName("br");fn.__sert(e8);fn.__sert(fr);fn.__sert(ft);T.__sert(fn);fl.__sert(T);return fl}};var eJ;eJ=INLINE_JS.FreshDropdown=A.FreshDropdown={show:function(fc,e9,e8,e7){var fb,fa,fd,T;if(e7==null){e7=false}by(document).trigger("dropdownOpened",[1]);fb=by(e9);if(!e8){e8=fb[0].offsetHeight+10}this.hide_all();fa=by(fc).show();T=fa[0].offsetWidth;fd=fb[0].offsetWidth;fa.clonePosition(fb,{setHeight:false,setWidth:false,offsetLeft:-1*(T-fd)+22,offsetTop:e8});if(e7){fa.width(T)}fb.addClass("pressed");return((function(fe){return function(){return document.observe("click",eJ.hide_all)}})(this)).defer()},hide_all:function(e8){var e7,T;T=by(".freshdropdown-menu");e7=0;T.each(function(){if(by(this).is(":visible")){return e7+=1}});T.hide();by(document).trigger("dropdownClosed",[e7]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eJ.hide_all)}};var X;X=A.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&X.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=C.parse(window.location.href).fragment}},report:function(){clearInterval(X.interval);return cC(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var eS,bg,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};eS=A.LocaleSelectorModal=(function(e7){cG(T,e7);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";T.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(e8){return function(e9){e9.preventDefault();e8.hide();return e8.set_locale(by(e9.target).attr("data-locale"))}})(this))};T.prototype.on_hide=function(){return this.$modal_window.off("click")};T.prototype.set_locale=function(e8,fa){var e9;if(fa==null){fa=false}e9=by("<form />",{action:this.action,method:"post"});bN.add_vars(e9[0],{locale:e8,locale_cont:fa||window.location.href,t:bq.read(Constants.JS_CSRF_COOKIE)});by(document.body).append(e9);return e9.submit()};return T})(dZ);bg=A.TeamLocaleSelectorModal=(function(T){cG(e7,T);function e7(){return e7.__super__.constructor.apply(this,arguments)}e7.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return e7})(eS);var dF;dF=A.LoginDropdown={init:function(){var T;T=by("#login-hover-link");if(!(T.length>0)){return}this.login_link=T;return this.register()},register:function(T){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(T){return this.clicking=true},click:function(T){T.preventDefault();if(this.clicking&&T.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}by(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return by("input[name='login_email']").focus()},unclick:function(e7){var T;if(e7){T=by(e7.target);if(T[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){by(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var eY;eY=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=A.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fi,fe,ff,fk,e8,fg,fc,fd,fj){var e7,fa,fh,T,e9,fb;if(ff==null){ff=false}if(fk==null){fk=false}if(e8==null){e8=false}if(fg==null){fg=false}if(fc==null){fc=""}if(fd==null){fd=true}if(fj==null){fj=false}if(eY.shown()){eY._cleanup()}e8=e8||this.width;fa="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(fa).invoke("hide");if(aj.uploading&&!fg){b2(er("You can't do this while uploading."));return false}cC(fe,"Missing modal content!");e9=this.vars._prev_scope;this.vars=ff||{};this.vars._prev_scope=e9;$("modal").setStyle({width:""+e8+"px",margin:"0 0 0 "+(Math.floor(-e8/2).toString())+"px"});this.vars.extra_class="";if(fc){$("modal").addClassName(fc);this.vars.extra_class=fc}if(!fg){if(aj.num_files()){ct.reset();aj.clear()}T=dX.childElement($("modal-content"),0);if(T&&T!==fe){$("grave-yard").__sert(T)}e7=new Element("div");e7.update(fe);$("modal-content").__sert(e7);if(fe.show){fe.show()}Element.show("modal")}by("#modal-overlay").off("click");if(fd){by("#modal-overlay").on("click",function(fl){eY.hide(null,false,true);fl.preventDefault();return fl.stopPropagation()})}else{by("#modal-overlay").on("click",function(fl){fl.preventDefault();return fl.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(e8+20)+"px",margin:"0 0 0 "+(Math.floor(-e8/2-10).toString())+"px"});by("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fk){$("modal-content").select("#"+fk.id).first().focus()}else{if(!dX.ie){fh=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fh){fh.focus()}}}if(!this.track_id){this.track_resizes()}if(fi){if(dX.isElm(fi)){by("#modal-title").html(fi)}else{by("#modal-title").text(fi)}by("#modal-title").show();fb=by("#modal-title").text();ey("Modal.show:",fb)}else{by("#modal-title").hide();ey("Modal.show")}Q.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fj;by("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;y.scroll_lock_document()}by(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var e8,T,e7,fa,e9;e8=by("#modal");T=e8.height();e9=e8.width();e7=y.viewport_dimensions();fa=y.viewport_offset(e8);return fa.left>0&&fa.top>0&&fa.left+e9<e7.width&&fa.top+T<e7.height},fix_position:function(e8){var e7,T;T=document.viewport.getScrollOffsets().top+this.vertical_offset;e7=parseInt($("modal").getStyle("height"),10);if(e7+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(e7+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:T+"px"});return $("modal-behind").setStyle({position:"absolute",height:(e7+20)+"px",top:(T-10)+"px"})}},keydown:function(e9){var fa,T,e8,e7;e8=e9.keyCode||e9.which||e9.charCode;if(e8===27||(e8===8&&!y.focus_in_input())){e9.preventDefault();this.hide(null,false,true)}if(e8===9&&!y.focus_in_input()){T=$("modal").down("input[type=text], input[type=email]");e7=$("modal").down(".modal-tabs");fa=e7;while(fa&&fa.next()){fa=fa.next();if(fa.visible()){T=fa.down("input[type=text], input[type=email]");break}}if(T){e9.preventDefault();return T.focus()}}},shown:function(){return $("modal").visible()},hide:function(e8,T,e7){if(e8){Event.stop(e8)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(e7);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!T&&!aj.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(aj.uploading){cS.show()}}eY._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return ey("Modal.hide")},_cleanup:function(){by(document).trigger("modalClosed",[1]);if(this.scroll_locked){return y.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&br.some(by("#modal form"),function(T){return T.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var T;T=$("modal").getHeight();if(this.old_height!==T||$("modal-behind").getHeight()<T){this.old_height=T;return this.fix_position()}},vars:{}};var eQ,eO,dT,d8,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};dT=A.RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};eO=A.RolePicker=(function(){function T(fa){var fb,e7,e9,e8,fd,fc;if(fa==null){fa={}}this._actually_set_state=dl(this._actually_set_state,this);this._do_login=dl(this._do_login,this);this.is_user_visible=dl(this.is_user_visible,this);this.is_role_visible=dl(this.is_role_visible,this);this.ensure_role_is_visible=dl(this.ensure_role_is_visible,this);this.update_picker_ui=dl(this.update_picker_ui,this);this.set_state=dl(this.set_state,this);this.get_state=dl(this.get_state,this);this._allow_merged_state=fa.allow_merged_state!=null?fa.allow_merged_state:true;this._limit_to_role=fa.limit_to_role!=null?fa.limit_to_role:null;fd=cD.get_viewer();e7=fd.is_role_signed_in(dT.PERSONAL)&&fd.is_role_signed_in(dT.WORK);if(fa.initial_state){e9=br.values(dT);cC((fc=fa.initial_state,bE.call(e9,fc)>=0),"RolePicker requires initial_state to be one of: "+e9);this.set_state(fa.initial_state)}else{if(this._allow_merged_state&&e7){this.set_state(dT.ALL)}else{fb=fd.get_users();cC(fb.length,"tried to use RolePicker on a page with no users");e8=fb[0];this.set_state(e8.role)}}}T.prototype.get_state=function(){return this._state};T.prototype.set_state=function(e8){var fb,fa,e7,e9;cC(this._allow_merged_state||(e8!==dT.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){cC((e8===dT.ALL)||(e8===this._limit_to_role))}if(e8===dT.ALL){e9=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(fa=0,e7=e9.length;fa<e7;fa++){fb=e9[fa];if(!cD.get_viewer().is_role_signed_in(fb)){this._do_login(fb,e8);return}}}else{fb=e8;if(!cD.get_viewer().is_role_signed_in(fb)){this._do_login(fb,e8);return}}return this._actually_set_state(e8)};T.prototype.update_picker_ui=function(){};T.prototype.ensure_role_is_visible=function(e7){if(!this.is_role_visible(e7)){if(this._allow_merged_state){return this.set_state(dT.ALL)}else{return this.set_state(e7)}}};T.prototype.is_role_visible=function(e7){return this._state===dT.ALL||this._state===e7};T.prototype.is_user_visible=function(e7){return this.is_role_visible(e7.role)};T.prototype._do_login=function(e7,e8){return bI.show_modal({role:e7,on_success:(function(e9){return function(){return e9._actually_set_state(e8)}})(this)})};T.prototype._actually_set_state=function(e7){if(e7===this._state){return}this._state=e7;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(e7):void 0};return T})();d8=A.RoleSelect=(function(e7){cG(T,e7);function T(e9,e8){if(e8==null){e8={}}this.limit_to_role=dl(this.limit_to_role,this);this.update_picker_ui=dl(this.update_picker_ui,this);this.on_ui_change=dl(this.on_ui_change,this);this.$container=e9;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(bu.CHANGED,this.on_ui_change);T.__super__.constructor.call(this,e8)}T.prototype.on_ui_change=function(e8,fa){var e9;e9=fa.clicked_val;if(e9!==this._state){y.controller(this.$bubble_picker).set_value(this._state);return this.set_state(e9)}};T.prototype.update_picker_ui=function(){y.controller(this.$bubble_picker).set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};T.prototype.limit_to_role=function(fb,e9){var e8,fa;if(fb!=null){this.ensure_role_is_visible(fb);for(e8 in dT){fa=dT[e8];if(fa===fb||fa===dT.ALL){continue}y.controller(this.$bubble_picker).disable_option(fa,e9)}}else{for(e8 in dT){fa=dT[e8];y.controller(this.$bubble_picker).enable_option(fa)}}return this._limit_to_role=fb};return T})(eO);eQ=A.PageRoleSelect=(function(e7){cG(T,e7);function T(e9,e8){if(e8==null){e8={}}e8.allow_merged_state=false;T.__super__.constructor.call(this,e9,e8)}T.prototype.on_state_change=function(e9){var e8;e8=(function(){switch(e9){case dT.PERSONAL:return Constants.ROLE_PERSONAL;case dT.WORK:return Constants.ROLE_WORK}})();return a1.emit(e8)};return T})(d8);var cb;cb=A.SickInput={init:function(){var fa,e9,e7,e8,T;e8=$$(".sick-input");T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];if(!fa.hasClassName("sickified")){T.push(this._create(fa))}}return T},_create:function(e9){var e8,T,e7;if(e9==null){return}e8=e9.identify();T=e9.down("input")||e9.down("textarea")||e9.down("select");T.observe("focus",function(){return e9.addClassName("focused")});T.observe("blur",function(){return e9.removeClassName("focused")});e7=function(){if(e9.hasClassName("populated")&&T.getValue()===""){e9.removeClassName("populated")}else{if(!e9.hasClassName("populated")&&T.getValue()!==""){e9.addClassName("populated")}}if(e8 in cb._handler_map){return cb._handler_map[e8]()}};bN.show_errors();e7();return setInterval(e7,100)},_handler_map:{},add_interval_handler:function(e7,T){var e8;e8=e7.identify();return this._handler_map[e8]=T},remove_interval_handler:function(e7,T){var e8;e8=e7.identify();if(this._handler_map[e8]===T){return delete this._handler_map[e8]}}};var cW;cW=A.SuggestionInput={register:function(e7){var T;e7=$(e7);T=e7.up("form");if(cW.defaulted(e7)||e7.getValue()===""){e7.setValue(e7.title)}else{e7.addClassName("suggestion-input-unfaded")}e7.observe("blur",this.blur.bind(this));e7.observe("focus",this.focus.bind(this));e7.observe("db:value_change",this.focus.bind(this));if(T){if(!e7.id){e7.id="r_elm_id_"+(Math.random().toString())}return T.observe("submit",cW.blank(e7.id).bind(this))}},register_all:function(){var e8,fa,e7,e9,T;e9=$$(".suggestion-input");T=[];for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];T.push(this.register(e8))}return T},blank:function(T){return(function(e7){return function(){var e8;e8=$(T);if(!e8){return}if(e7.defaulted(e8)){return e8.setValue("")}}})(this)},defaulted:function(T){T=$(T);return T.getValue()===T.title},do_blank:function(T){return this.blank(T)()},clear:function(T){var e7;e7={target:T};return this.focus(e7)},focus:function(T){var e7;e7=$(T.target);if(!e7){return}if(this.defaulted(e7)){e7.addClassName("suggestion-input-unfaded");return e7.setValue("")}},blur_elm:function(T){if(T.getValue()===""){T.removeClassName("suggestion-input-unfaded");T.setValue(T.title)}return T.blur()},blur:function(T){var e7;e7=$(T.target);if(!e7){return}return this.blur_elm(e7)},reset:function(e7){var T;T=$(e7);if(!T){return}T.removeClassName("suggestion-input-unfaded");T.setValue(T.title);T.defaulted=true;return T.blur()},setValue:function(T,e7){var e8;e8=$(T);if(!e8){return}e8.addClassName("suggestion-input-unfaded");e8.setValue(e7);return e8.defaulted=false}};var bi;bi=A.TitleBubble=(function(){var e8,e7,fc,e9,fa,T,fb;fb=0;e8=0;T=function(fd){return fb=fd};fa=function(fj){var fo,fm,fg,fk,ff,fd,fl,fi,fe,fh,fn;fk=by(fj.currentTarget);fn=fk.attr("title");if(fn!=null?fn.length:void 0){fk.attr("data-title",fn);fk.removeAttr("title")}fg=parseInt(fk.data("title-delay"));fm="title-bubble-"+(e8++);fk.data("bubble-id",fm);fo=by("<div/>",{id:fm,"class":"title_bubble_container"});if(!fg){fo.css({opacity:0});fo.addClass("has-transition")}if(fk.hasClass("white")){fo.addClass("white")}if(fk.hasClass("black")){fo.addClass("black")}fo.text(fk.attr("data-title"));fl=fk.attr("data-title-html");fo.html(fl);fe=fk.attr("data-title-hide-tail")!=="yes";if(fe){fh=by("<div/>",{"class":"tail"});fo.append(fh)}by(document.body).append(fo);fd=fc(fk[0],fo[0]);ff=e7(fd,fo[0],fk[0]);fo.clonePosition(fk,{setWidth:false,setHeight:false,offsetTop:ff.top-fb,offsetLeft:ff.left});fo.addClass("position-"+fd);if(fe){fh.clonePosition(fk,{setWidth:false,setHeight:false,setTop:false,offsetLeft:ff.left+ff.tail_offset_left+(by(fo).outerWidth()/2)})}fi=function(){var fp;if(!((fo.data("pending-delay"))&&(fk.data("bubble-id")===fm))){return}fp=(parseInt(fk.data("title-fade-time")))||400;return fo.fadeIn(fp)};if(fg){fo.hide();fo.data("pending-delay",true);return setTimeout(fi,fg)}else{return fo.css({opacity:""})}};fc=function(fh,fd){var fg,ff,fe;fh=$(fh);fe=fh.getAttribute("data-title-position");fg=document.viewport.getDimensions();ff=fh.viewportOffset();if(!(fe==="above"||fe==="below"||fe==="right"||fe==="left")){fe="above"}if(fe==="left"){if(ff.left<fd.width){return"right"}}else{if(fe==="right"){if(fg.width-(ff.left+fh.getWidth())<fd.width){return"left"}}else{if(fe==="below"){if(fg.height-(ff.top+fh.getHeight())<fd.height){return"above"}}else{if(fe==="above"){if(ff.top<fd.height){return"below"}}}}}return fe};e7=function(ff,fm,fi){var fk,fg,fn,fj,fl,fh,fd,fp,fo,fe;fm=$(fm);fi=$(fi);fn=document.viewport.getDimensions();fk=fm.getDimensions();fj=fi.viewportOffset();fg=6;fl=0;fh=0;fo=0;fe=0;if(ff==="below"||ff==="above"){if(ff==="below"){fh=fi.getHeight()+fg}else{fh=(-1*fk.height)-fg}fd=fi.getWidth()/2-fk.width/2;if(fj.left+fd+fk.width>fn.width){fl=fn.width-fj.left-fk.width;fo=fd-fl-5}else{fl=fd;fo=-5}}if(ff==="left"||ff==="right"){if(ff==="right"){fl=fi.getWidth()+fg}else{fl=(-1*fk.width)-fg}fp=fi.getHeight()/2-fk.height/2;if(fj.top+fp+fk.height>fn.height){fh=fn.height-fj.top-fk.height;fe=fp-fh-5}else{fh=fp;fe=-5}}return{left:fl,top:fh,tail_offset_left:fo,tail_offset_top:fe}};e9=function(fe){var fd,ff,fg;fg=by(fe!=null?fe.currentTarget:void 0);fd=by("#"+fg.data("bubble-id"));if(fd.data("pending-delay")){fd.removeData("pending-delay");ff=(parseInt(fg.data("title-fade-time")))||400;return fd.fadeOut(ff,function(){return fd.remove()})}else{return fd.remove()}};return{init:function(){by(document).on("mouseenter",".title_bubble",fa);by(document).on("mouseleave",".title_bubble",e9).on("mouseup",".title_bubble",e9);by(document).on("mouseenter",".title_bubble_sticky",fa);return by(document).on("mouseleave",".title_bubble_sticky",e9)},set_vertical_space:T,hide_all:function(){return by(".title_bubble_container").remove()}}})();var eb;eb=INLINE_JS.Tooltip=A.Tooltip={attach:function(fb,e8,T,e7){var fa,e9;if(e7==null){e7={}}fb=$(fb);T=(T?$(T):null);fa=ef.make(e8,fb.tail_position,e7.tail_position,e7.width,e7);fa.setStyle({display:"none",position:"absolute"});$("floaters").__sert(fa);if(fb.match("#modal-content *")||fb.match(".db-modal-content *")){fa.style.zIndex="13001"}else{fa.style.zIndex=""}if(fb.tail_position==="right"){e9=(dX.ie?32:12);fa.style.marginLeft=-(fa.getWidth()+fb.getWidth()+e9)+"px"}fb.tooltip=fa;fb.out_target=(T?true:false);fb.observe("mouseout",this.mouseout("target",fb));fb.observe("mouseover",this.mouseover("target",fb));fb.out_trigger=(T?false:true);if(T){T.observe("mouseout",this.mouseout("trigger",fb));T.observe("mouseover",this.mouseover("trigger",fb))}fb.out_tooltip=true;fa.observe("mouseout",this.mouseout("tooltip",fb));return fa.observe("mouseover",this.mouseover("tooltip",fb))},update:function(e7,T){if(e7.tooltip){return $(e7.tooltip).update(T)}},mouseover:function(T,e7){return function(){return e7["out_"+T]=false}},mouseout:function(T,e7){return function(){e7["out_"+T]=true;return eb.hide_if_out.defer(e7)}},show_by:function(e7){var e8,T;e8=by(e7.tooltip);e7=by(e7);e8.show();T=Math.floor(e8[0].offsetHeight/2);return e8.clonePosition(e7,{setWidth:false,setHeight:false,offsetTop:Math.floor(e7[0].offsetHeight/2)-T,offsetLeft:e7[0].offsetWidth+1})},hide_if_out:function(T){var e7;if(!T.out_target||!T.out_trigger||!T.out_tooltip){return}e7=$(T.tooltip);return e7.hide()},show:function(fa,e9,e7,T,e8){if(T==null){T="left"}fa=$(fa);if(!fa.tail_position){fa.tail_position=T}e7=(e7?$(e7):null);if(!fa.tooltip){this.attach(fa,e9,e7,e8)}return this.show_by(fa)}};var bW;bW=INLINE_JS.TreeView=A.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(T){return this.ajax_params=T},init:function(e8,T,e9){var e7;if(e9==null){e9="treeview"}this.tv[e9]={};e7=this.tv[e9];e7.autohide=(T===null?true:T);e7.handler=e8;e7.viewdiv=$(e9);e7.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bx.ADD,(function(fa){return function(fb){return fa.schedule_reset()}})(this));document.observe(bx.REMOVE,(function(fa){return function(fb){return fa.schedule_reset()}})(this));return document.observe(bx.MOVE,(function(fa){return function(fb){return fa.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(fb){var e8,e9,e7,fd,T,fa,fc;e8={url:"/ajax_subtreeview",type:"post",data:by.extend({},this.ajax_params),success:(function(fe){return function(fg){var fh,ff;ff=[];for(fh in fe.tv){if(fe.tv.hasOwnProperty(fh)){fe.tv[fh].viewdiv.down(".treeview-folders").update(fg);if(fb&&fb.onSuccess){ff.push(fb.onSuccess(fg))}else{ff.push(void 0)}}else{ff.push(void 0)}}return ff}})(this)};if(fb!=null?fb.user:void 0){if(fb.user.id!==((fc=this.user)!=null?fc.id:void 0)){fd=by("<p />",{id:"treeview-loading"});T=by("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});fd.append(T);fa=" "+er("Loading your folders");fd.append(fa);by("#dest-treeview .treeview-folders").html(fd);this.user=fb.user}e8.subject_user=fb.user;e7=cD.get_role_title(fb.user);if(cD.get_viewer().is_paired){if(fb.user.is_team){e9="s_briefcase"}else{e9="s_house"}}else{e9="dropbox"}if(!e7){e7=er("Dropbox")}by("#first-treeview-link span").text(e7);cp.replace(by("#root-img")[0],"web",this.role_icon,e9);this.role_icon=e9}else{by("#first-treeview-link span").text(er("Dropbox"))}return by.ajax(e8)},toggle:function(e8,e7){var T;Event.stop(e8);T=this.tv[e7||"treeview"];if(T.shown){T.shown=false;this.hide(e8,e7)}else{T.shown=true;this.show(e8.target,e7)}return false},hide:function(e8,e7){var T;T=this.tv[e7||"treeview"];if(!e8||!$(e8.target).descendantOf(T.viewdiv)){T.viewdiv.hide();Event.stopObserving(window,"click",T.hidefunc);return T.shown=false}},show:function(e8,e7){var e9,T;T=this.tv[e7||"treeview"];e8=$(e8);e8.blur();e9=e8.cumulativeOffset();T.viewdiv.setStyle({top:(e9.top+e8.getHeight())+"px",left:(e9.left-4)+"px"});T.viewdiv.show();return Event.observe(window,"click",T.hidefunc)},toggleNode:function(e7){var T;e7=$(e7);T=e7.down("img");if(T.className.match("bullet_plus")){cp.replace(T,"web","bullet_plus","bullet_minus")}else{cp.replace(T,"web","bullet_minus","bullet_plus")}e7.up().next("div").toggle();e7.blur();return false},toggleNodeAjax:function(e9,T,e7){var e8,fa;if(e9.fetched_children){return this.toggleNode(e9)}e9=$(e9);e8=e9.down("img");fa=cp._get(e8);e8.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";by.ajax({url:"/ajax_subtreeview"+T,type:"post",data:by.extend({},this.ajax_params),subject_user:e7,success:(function(fb){return function(fc){var fd;fd=new Element("div",{style:"display: none;"}).update(fc);e9.up().__sert({after:fd});e9.fetched_children=true;cp._set(e8,fa);return fb.toggleNode(e9)}})(this),complete:function(){if(/loading/.match(e8.src)){return cp._set(e8,fa)}}});return false},handle:function(e8,e7){var e9,T;e9=$H(this.tv).keys();T=$(e7).ancestors().find(function(fa){return e9.include(fa.id)});if(!T){return}T=this.tv[T.id];by(document).trigger("db:treeview_selected",[e8]);if(T.handler){T.handler(e8,e7)}if(T.autohide){this.hide(T.id)}return false},move:function(e8,e9,e7){var T;T=$(e8);if(!this.loaded){this.reset({onSuccess:(function(fa){return function(){fa.loaded=1;return fa.move(e8,e9,e7)}})(this),user:e7!=null?e7.user:void 0})}else{if(e7&&e7.onSuccess){e7.onSuccess()}}cC(T,"Couldn't find tree_id");cC($(e9),"Couldn't find location_id");$(e9).appendChild(T);return T.show()}};var aK;aK=A.ULSelectMenu=(function(){var e9,fd,e8,fe,ff,fa,fc,T,fb,e7,fg;e9=function(fh){return fh.removeClassName("shown")};fg=function(fh){return fh.toggleClassName("shown")};fc=function(){return this.removeClassName("hover")};fa=function(){return this.addClassName("hover")};T=function(fl,fk){var fh,fm,fj,fi;fi=[];for(fm=0,fj=fk.length;fm<fj;fm++){fh=fk[fm];fi.push(fl.insert(fh))}return fi};fe=function(fj,fh,fi){T(fj,fi);if(fj.firstChild!==fh){return fj.__sert({top:fh})}};fb=function(fi,fj){var fh;fh="selected";by(fi).find("."+fh).removeClass(fh);return by(fj).addClass(fh)};e7=function(fj,fm){var fn,fl,fi,fk,fh;fk=fj.select("li");fh=[];for(fl=0,fi=fk.length;fl<fi;fl++){fn=fk[fl];if(fn.getAttribute("data-value")===fm){fh.push(fb(fj,fn))}else{fh.push(void 0)}}return fh};ff=function(fh,fj,fi){return function(fk){if(!fh.hasClassName("selected")){fb(fj,fh);fj.fire("db:change",fh.getAttribute("data-value"));return e9(fj)}else{fe(fj,fh,fi);return fg(fj)}}};fd=function(fj){var fm,fp,fl,fi,fo,fh,fk,fn;fp=fj.select("li");cC(fp.length,"Empty list of options "+fj.identify());fl=void 0;if(fp.length===1){fj.addClassName("one")}else{for(fk=0,fn=fp.length;fk<fn;fk++){fm=fp[fk];fo=fm.getAttribute("data-value");cC(fo,fm.identify()+" missing data value");fm.observe("click",ff(fm,fj,fp));fm.observe("mouseenter",fa);fm.observe("mouseleave",fc);if(fm.hasClassName("selected")){fl=fm}}$(document.body).observe("click",function(fq){if($(fq.target).up(".ul_select_menu")===fj){return}return e9(fj)})}if(!fl){fl=fp[0]}fl.addClassName("selected");fh=new Element("span");fi=fl.getDimensions();fh.setStyle({width:fi.width+"px",height:fi.height+"px",position:"relative",display:"inline-block"});return fj.wrap(fh)};e8=function(){var fl,fk,fi,fj,fh;fj=$$(".ul_select_menu");fh=[];for(fk=0,fi=fj.length;fk<fi;fk++){fl=fj[fk];fh.push(fd(fl))}return fh};by(e8);return{init:function(fh){return fd(fh)},set_selected_by_value:e7}})();var E;E=A.DBCalendar=Class.create({initialize:function(e7,T){this.options=T||{};this.container=$(e7);cC(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=dX.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=dX.start_of_day(this.options.first_day||this.today)}this.view_date=dX.start_of_day(this.options.selected_date||this.today);this.selected_date=dX.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(e7,T){Event.stop(e7);this.view_date.setMonth(T);return this.render()},is_valid_date:function(e9,fb,fa,e8,T){var e7;e9=parseInt(e9,10);fb=parseInt(fb,10);fa=parseInt(fa,10);e8=parseInt(e8,10);T=parseInt(T,10);e8=e8||1970;T=T||(new Date()).getFullYear()+1;fb+=1;if(fa<e8){return false}if(fa>T){return false}if(fb<1||fb>12){return false}if(e9<=0){return false}if(fb===2){e7=((fa%4)===0)&&(((fa%100)!==0)||((fa%400)===0));if(e7){return e9<=29}else{return e9<=28}}else{if(fb===4||fb===6||fb===9||fb===11){return e9<=30}else{return e9<=31}}},change_date:function(T,e9,e7){var e8;if(!this.is_valid_date(T,e9,e7)){return}e8=e7!==this.view_date.getFullYear()||e9!==this.view_date.getMonth();this.selected_date=new Date(e7,e9,T);if(e8){this.view_date.setMonth(e9);this.view_date.setFullYear(e7);this.render()}else{by(this.container).find(".selected").removeClass("selected");by(this.container).find("a#day"+T+"-"+e9).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var e9,ff,fd,fb,fa,e7,fc,e8,fe,T;ff=this.render_days();fb=by(".current-month",ff);fc=fb.first().data("date");e7=fb.last().data("date");T=fc<=this.options.first_day;fe=e7>=this.options.last_day;e9=new Element("div");e9.addClassName("calendar clearfix");if(!fe){this._next_month=(function(fg){return this._change_month(fg,this.view_date.getMonth()+1)}).bind(this);fa=new Element("a");fa.addClassName("changemonth next");fa.update(cp.make("web","arrowright",{}));Event.observe(fa,"click",this._next_month);e9.__sert(fa)}if(!T){this._prev_month=(function(fg){return this._change_month(fg,this.view_date.getMonth()-1)}).bind(this);e8=new Element("a");e8.addClassName("changemonth prev");e8.update(cp.make("web","arrowleft",{}));Event.observe(e8,"click",this._prev_month);e9.__sert(e8)}fd=new Element("h5");fd.update(er("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:bY.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));e9.__sert(fd);e9.__sert(ff);return this.container.__date(e9)},render_days:function(){var fd,fc,T,fb,e7,fa,e9,e8;fc=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);e9=fc.getDay();fd=new Element("div");fd.addClassName("days");for(T=e8=e9;e9<=0?e8<0:e8>0;T=e9<=0?++e8:--e8){fa=new Date(fc.getFullYear(),fc.getMonth(),fc.getDate());fa.setDate(fa.getDate()-T);fd.__sert(this.render_day(fa,true))}fb=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(fb.getMonth()===this.view_date.getMonth()){fd.__sert(this.render_day(fb));fb=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),fb.getDate()+1)}e7=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(e7.getDay()!==6){e7=new Date(e7.getFullYear(),e7.getMonth(),e7.getDate()+1);fd.__sert(this.render_day(e7,true))}return fd},render_day:function(e7,e9){var T,e8;e8=!e9;if(this.options.last_day){e9=e9||e7>this.options.last_day}if(this.options.first_day){e9=e9||e7<this.options.first_day}T=new Element(e9?"span":"a");by(T).data("date",e7);if(e8){T.addClassName("current-month")}T.update(e7.getDate());T.addClassName("date");T.writeAttribute("id","day"+e7.getDate()+"-"+e7.getMonth());if(this.selected_date.getDate()===e7.getDate()&&this.selected_date.getMonth()===e7.getMonth()&&this.selected_date.getFullYear()===e7.getFullYear()){T.addClassName("selected")}if(e9){T.addClassName("inactive")}else{this._handler=(function(fb){var fa;fa=fb.target.identify().substr(3).split("-");return this.change_date(fa[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(T,"click",this._handler)}return T}});var aM;aM=A.DatePickerInput=Class.create({initialize:function(T,e8){var fb,e9,fa,e7;this.container=T;this.options={};Object.extend(this.options,e8||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");e7=(this.input.value?dX.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){fa=dX.from_mysql_date(this.container.getAttribute("data-first"))}fb=this.options.disable_future!=null?this.options.disable_future:true;e9=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new E(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:fa,disable_future:fb,disable_past:e9,selected_date:e7});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(e7)},show_cal:function(e7){var T;if(e7){Event.stop(e7)}T=$(e7.target);if(T.match(".cal-container")||T.up(".cal-container")){return}by(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(T){this.input.value=dX.to_mysql_date(T,false);this.display.update(K.localize(T));return this.hide_cal()}});var e3;e3=A.TextInputDatePicker=Class.create({initialize:function(e9,e8){var fb,fa,e7,T;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,e8||{});this.input=$(e9);cC(this.input,"Couldn't find the element "+e9.toString());e7=new Date();T=(this.input.value?dX.from_mysql_date(this.input.value):false);fa=new Date(e7.getUTCFullYear(),e7.getUTCMonth(),e7.getUTCDate());this.cal_icon=cp.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+e9,style:"display: none; position: absolute; z-index: 1"});this.calendar=new E(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:fa,selected_date:T});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));fb=by(this.input);by(this.cal_container).clonePosition(fb,{setWidth:false,setHeight:false,offsetTop:fb[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(T){if(T){Event.stop(T)}return this.cal_container.toggle()},hide_cal:function(T){if(T){Event.stop(T)}return this.cal_container.hide()},onDateChange:function(T){if(this.options.choose_eod){T.setTime(dX.start_of_day(T).getTime()+86399999)}this.input.value=dX.to_mysql_date(T,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});ag.window_load(Q.register.bind(Q));by(cb.init.bind(cb));by(cW.register_all.bind(cW));Event.observe(window,"scroll",function(){return bi.hide_all()});by(function(){X.interval=setInterval(X.check.bind(X),500);dF.init();return bi.init()});var aP;aP=A.LocaleSelector={init:function(){by(document).on("click",".modal-locale-link",(function(T){return function(e7){e7.preventDefault();return T.show()}})(this));return by(document).on("click",".modal-team-locale-link",(function(T){return function(e7){e7.preventDefault();return T.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new eS({element_id:"locale-selector-modal"})}return this.modal.show()},show_team_modal:function(){if(!this.team_modal){this.team_modal=new bg({element_id:"locale-selector-modal"})}return this.team_modal.show()}};by(function(){return aP.init()});var a9,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};a9=INLINE_JS.ChangeNameModal=A.ChangeNameModal=(function(T){cG(e7,T);function e7(){e7.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(e8){return function(fc){var fb,e9,fa;fc.preventDefault();fb=by(fc.target);e9=fb.closest("form");fa=function(){e8.hide();return location.reload()};return bN.ajax_submit(e9[0],false,fa,null,fb[0])}})(this)}return e7})(dZ);var bQ,el,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};el=A.ManageAliasModal=(function(e7){cG(T,e7);function T(e8){this.options=e8;this._poll_until_verified=dl(this._poll_until_verified,this);this._get_params_from_target=dl(this._get_params_from_target,this);this._on_load=dl(this._on_load,this);this._show_action_panel=dl(this._show_action_panel,this);this._input_enter_handler=dl(this._input_enter_handler,this);this.resend_verify=dl(this.resend_verify,this);this.remove_alias=dl(this.remove_alias,this);this.add_alias=dl(this.add_alias,this);this.refresh_alias=dl(this.refresh_alias,this);this.on_show=dl(this.on_show,this);T.__super__.constructor.call(this,this.options)}T.prototype.before_show=function(e8){T.__super__.before_show.call(this,e8);this.polling=0;e8.find(".alias-action").on("click",this._show_action_panel);e8.find(".alias-action-submit").on("click",this.add_alias);e8.find("form").submit(function(){return false});return e8.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};T.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};T.prototype.refresh_alias=function(e9,e8){if(e9==null){e9=true}if(e9){bN.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(fa){return function(fb){fa.$modal_window.find(".dynamic-content").html(fb.responseText);fa._on_load(fb);if(typeof e8==="function"){return e8()}}})(this),onFailure:(function(fa){return function(fb){return fa.hide()}})(this)})};T.prototype.add_alias=function(fb){var fa,e8,e9,fc;fb.preventDefault();e8=by(fb.currentTarget).closest("form");fa=e8.find(".alias-action-submit");fc={};fc[Constants.UID_PARAM_NAME]=this.options.subject_user.id;e9=(function(fd){return function(){var fe;fd.$modal_window.find(".alias-action-inputs input").val("");fd.polling=0;fe=fd.polling?null:fd._poll_until_verified;return fd.refresh_alias(true,fe)}})(this);return bN.ajax_submit(e8[0],false,e9,false,fa[0],fc,"before")};T.prototype.remove_alias=function(e8){var e9;e8.preventDefault();e9=this._get_params_from_target(e8.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:e9,onSuccess:(function(fa){return function(fb){return fa.refresh_alias()}})(this)})};T.prototype.resend_verify=function(e8){var e9;e8.preventDefault();e9=this._get_params_from_target(e8.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:e9,onSuccess:(function(fa){return function(fb){return fa.refresh_alias()}})(this)})};T.prototype._input_enter_handler=function(e8){e8.preventDefault();e8.stopPropagation();if(e8.which===13){return this.add_alias(e8)}};T.prototype._show_action_panel=function(fa){var e9,e8;fa.preventDefault();e8=by(fa.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();e9=this.$modal_window.find("#"+e8).show();return e9.find("input:visible:enabled:first").focus()};T.prototype._on_load=function(e8){a8.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(e9){return function(fa){return e9.remove_alias(fa)}})(this));return this.$dynamic.on("click",".alias-verify",(function(e9){return function(fa){return e9.resend_verify(fa)}})(this))};T.prototype._get_params_from_target=function(fa){var e8,e9,fb;e8=by(fa);fb=e8.data("alias-type");e9=e8.closest(".alias-row").find(".alias-text").text();return{alias:e9,alias_type:fb}};T.prototype._poll_until_verified=function(){var fa,fb,e9,e8;fb=5;fa=60;e9=(function(fc){return function(){return fc.refresh_alias(false,fc._poll_until_verified)}})(this);e8=this.$dynamic.find(".alias-verify").length;if(e8&&this.polling<fa){this.polling++;return setTimeout(e9,fb*1000)}else{return this.polling=0}};return T})(dZ);bQ=INLINE_JS.AliasManager=A.AliasManager={show:function(fa){var e8,e9,e7,T;T=cD.get_viewer().get_user_by_role(fa);if(T==null){return}if(!T.is_email_verified){if(fa===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}e7=cD.get_viewer().is_paired?fa:"";e9=er("Manage your %(role_show)s contact methods").format({role_show:e7});e8=new el({element_id:"manage-alias",title:e9,subject_user:T,role:T.role});e8.show()}};var dn;dn=INLINE_JS.BonusTable=A.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(T){this.user_id=T;if(dn._inited){return}dn._inited=true;$("bonus-loading").show();dn._tmpl=e2.tmpl("bonus_row_tmpl");dn.listen();return dn.get_next_page()},_render:function(e9){var e7,fa,e8,T;e7=[];for(e8=0,T=e9.length;e8<T;e8++){fa=e9[e8];e7.push(dn._tmpl({row:fa,Sprite:cp}))}return $("bonus-table").__sert(e7)},get_next_page:function(){if(dn._fetching_page){return}dn._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+dn._next_page,{onSuccess:function(e7){var e9,T,e8;e9=e7.responseText.evalJSON();e8=e9.rows;T=e9.has_more;dn._render(e8);$("bonus-loading").hide();if(T){dn._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return dn._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(e7){var T,e9,e8;e9=by(e7.currentTarget);e8=er("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");T=by(ef.make(e8,"right","middle"));Element.absolutize(T[0]);e9.append(T);T.clonePosition(e9,{setWidth:false,setHeight:false});return T.css({width:"200px",left:(parseInt(T.css("left"),10)-210)+"px",top:(parseInt(T.css("top"),10)-55)+"px"})},_max_referral_out:function(fb){var T,fa,e8,e9,e7;e9=by(".reached-max-referral-bonus .bubble");e7=[];for(fa=0,e8=e9.length;fa<e8;fa++){T=e9[fa];e7.push(T.remove())}return e7},listen:function(){by("#load-more-bonus").on("click",dn.get_next_page.bind(dn));by(document).on("mouseenter",".reached-max-referral-bonus",dn._max_referral_over);return by(document).on("mouseleave",".reached-max-referral-bonus",dn._max_referral_out)},toggle:function(){if(by("#bonus-list").is(":visible")){this.hide();return by("#space-earned-link").text(er("View all space earned"))}else{this.show();return by("#space-earned-link").text(er("Hide space earned"))}},show:function(){return by("#bonus-list").slideDown(150)},hide:function(){return by("#bonus-list").slideUp(150)}};var z,r,b;z=INLINE_JS.DowngradeReasons=A.DowngradeReasons={reasons:{},addReason:function(T){return this.reasons[T]=true},addReasons:function(T){var e9,fa,e8,e7;e7=[];for(fa=0,e8=T.length;fa<e8;fa++){e9=T[fa];e7.push(this.addReason(e9))}return e7},change:function(fb,e8,T){var fc,fe,fd,e9,e7,fa;fb=parseInt(fb,10);fe=$(e8);cC(fe,"Couldn't find container for DowngradeReason");fc=false;fa=this.reasons;for(e9 in fa){fd=fa[e9];e7=$(T+e9);cC(e7,"Couldn't find container for ",T+e9);if(fd&&parseInt(e9,10)===fb){e7.show();fc=true}else{e7.hide()}}if(fc){return fe.show()}else{return fe.hide()}}};r=A.DowngradeReasons2={init:function(){var e7,e9,T,e8;e8=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];by(e7).change(function(fb){var fa;fa=fb.target.id.indexOf("other")>=0;return r.change(fa,fb.target.getValue())})}return by(".shared-additional-info").attr("name","shared_additional_info")},change:function(e8,T){var e7;by(".downgrade-other-reason .error-message").hide();if(e8){return}e7="#downgrade-info-"+T;by(".downgrade-info").hide();by(e7).show();by(".downgrade-info textarea").removeAttr("name");by(e7+" textarea").attr("name","additional_info");return by("input[name=other_reason_id]").removeAttr("checked")}};b=A.DowngradeSurvey={init:function(){var T;T="#downgrade-survey-form";return by(""+T).on("submit",(function(e7){return function(fa){var e9,e8;e8=by(""+T+" input[name=other_reason_id]:checked").length;e9=by(""+T+" input[id=downgrade-radio-8]");if(e9.is(":checked")&&e8===0){by(".downgrade-other-reason .error-message").show();return fa.preventDefault()}}})(this))}};var b4;b4=INLINE_JS.GetSpace=A.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(e8,e7,e9){var T;b4._current_space=e8;b4._why_msg=e7;b4._twitter_url=e9;$("space-actions").on("click",".space-action",b4.perform_action);T=C.parse(window.location.href).fragment;if(T){return b4.highlight_offer(T)}},highlight_offer:function(e7){var T,e8;T=by("#"+e7);e8=T.css("background-color");return T.css("background-color",b4.offer_highlight_color).delay(2000).animate({"background-color":e8}).queue(function(){return T.css("background-color","")})},perform_action:function(e7){var e8,T;T={contact_sales:b4._contact_sales,contact_support:b4._contact_support,teams:b4._teams,upgrade:b4._upgrade,plans:b4._plans,refer:b4._refer,get_started:b4._get_started,fb_link:b4._fb_link,twitter_link:b4._twitter_link,twitter_follow:b4._twitter_follow,why_like:b4._why_like,mailbox_link:b4._mailbox_link};e8=$(e7.target);if(!e8.hasClassName("space-action")){e8=e8.up(".space-action")}return T[e8.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return ej.do_auth(function(){b4._refresh_link_bonuses();return b4._completed($("fb_link"))},cD.get_viewer().personal_user.id)},_twitter_link:function(){return cw.do_auth(function(){b4._refresh_link_bonuses();cw.set_is_authed(cD.get_viewer().personal_user.id,true);return b4._completed($("twitter_link"))},cD.get_viewer().personal_user.id)},_twitter_follow:function(){if(cw.is_authed(cD.get_viewer().personal_user.id)){return b4.follow_dropbox()}else{return cw.do_auth(b4.follow_dropbox,cD.get_viewer().personal_user.id)}},_why_like:function(){eY.show(er("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return dX._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!cw.is_authed(cD.get_viewer().personal_user.id)){b4._refresh_link_bonuses();cw.set_is_authed(cD.get_viewer().personal_user.id,true)}return cw.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(er("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(er("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){b4._completed($("twitter_link"))}return b4._completed($("twitter_follow"))}},cD.get_viewer().personal_user.id)},submit_why:function(){b4._why_msg=$F("why-i-like-input");return bN.ajax_submit($("why-i-like-form"),false,(function(){eY.hide();return b4._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(e7){var T;e7.addClassName("completed");e7.down(".icon-col").__date(cp.make("web","check_36"));by(e7).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return by(e7).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);T=parseInt(e7.down(".space").readAttribute("data-space"),10);b4._current_space+=T;$("current-space").__date(az.format_bytes(b4._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bt;bt=A.Help={toggle_more_help:false,show_os:function(e7,e8,T){e8=$(e8);$$(".os-filter").invoke("removeClassName","selected");e8.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+T).invoke("show");return Event.stop(e7)},vote:function(T,e7){new Ajax.DBRequest("/help/"+T+"/vote/"+e7);by("#help-vote-cont").fadeOut();return aa.success(er("Thanks for your feedback!"))}};var eo,dM,Z,q,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};dM=INLINE_JS.Hosts=A.Hosts={attach_host_listener:function(fa,e8){var e7,e9,fb,T;e7=by("#"+fa);fb=e7.data("host-ids");e9=e7.data("display-name");T=function(){return new Z(fb,e9,e8,null,null).show()};return by(".unlink-host-link",e7).on("click",T)},edit:function(fb,e8){var e7,fc,fd,fa,e9,T;fd=by("#host-device-row-"+e8+" .host-item .sprite-text");if(fd.data("editing")==="true"){return false}fd.data("editing","true");fc=fd.text();fd.data("previous",fc);fb=br.values(fb);fa=by('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(fc);T=by('<input type="button" class="button">').val(er("Save"));T.on("click",function(){return dM.doneEditing(fb,e8)});e7=by('<input type="button" class="button grayed">').val(er("Cancel"));e7.on("click",function(){return dM.cancelEditing(e8)});fd.empty();fd.append(fa,"&nbsp;",T,"&nbsp;",e7);e9=by("input",fd);e9.on("keydown",function(){return dM.checkKey(fb,e8)});return e9.focus()},doneEditing:function(e8,e7){var e9,T;e9=by("#host-device-row-"+e7+" .host-item .sprite-text");T=by("input",e9).val();return by.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(e8),name:T},type:"POST"}).success(function(fa){return dM.unedit(e9,JSON.parse(fa).display_name)})},cancelEditing:function(T){var e7;e7=by("#host-device-row-"+T+" .host-item .sprite-text");return dM.unedit(e7,e7.data("previous"))},unedit:function(e7,T){e7.data("editing","false");return e7.text(T)},dismiss:function(e8,e7,e9,T,fa){new by.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:e8,user_id:e7,team_id:e9},subject_user:fa,success:function(fb){return T.remove()}});return false},checkKey:function(e7,T){return function(e8){e8=e8||window.event;if(e8.keyCode===Event.KEY_RETURN){dM.doneEditing(e7,T)}if(e8.keyCode===Event.KEY_ESC){return dM.cancelEditing(T)}}},show_device_unlink_modal:function(e7,e8,T,fd,fa,e9){var fc,fb;fc=by("#unlink-device-modal-"+fa);fb={both:br.values(fd),personal:[fd[Constants.ROLE_PERSONAL]],work:[fd[Constants.ROLE_WORK]]};eY.show(T,fc[0]);if(br.values(fd).length>1){fc.addClass("show-selector")}return by("form input[type=submit]",fc).on("click",function(fe){fe.preventDefault();fd=fb[by(".unlink-select select",fc).val()];bN.add_vars(by("form",fc)[0],{user_ids:JSON.stringify(fd),app_id:e8,device_id:JSON.stringify(e7),device_name:e9});return by("form",fc).submit()})}};eo=A.DeleteFailuresModal=(function(T){cG(e7,T);function e7(){this.on_show=dl(this.on_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_confirm_button_click=function(e8){e8.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};e7.prototype.on_show=function(e9){var e8;e8=a6("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(e8)};return e7})(dZ);q=INLINE_JS.show_delete_failures_modal=A.show_delete_failures_modal=function(e8,e7,T){var e9;e9=new eo({element_id:"delete-failures-modal"});e9.host_id=e8;e9.name=e7;e9.num_failures=T;e9.show();return false};Z=INLINE_JS.UnlinkHostModal=A.UnlinkHostModal=(function(e7){cG(T,e7);function T(fc,fa,e8,e9,fb){this.host_ids=fc;this.name=fa;this.delete_support_type=e8;this.owner_id=e9;this.team_id=fb;this.on_show=dl(this.on_show,this);this._set_delete_text=dl(this._set_delete_text,this);this.fail_callback=dl(this.fail_callback,this);this.success_callback=dl(this.success_callback,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=br(this.host_ids).values().length>1}T.prototype.on_confirm_button_click=function(fb){var e9,fa,e8;fb.preventDefault();fa=this.$modal_window.find(".unlink_host_form")[0];e9=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");e8={host_ids:JSON.stringify(this.get_selected_hosts())};return bN.ajax_submit(fa,false,this.success_callback,this.fail_callback,e9,e8)};T.prototype.success_callback=function(){return window.location.reload()};T.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};T.prototype._set_delete_text=function(e8){return this.$modal_window.find(".delete_data_label").text(e8)};T.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};T.prototype._set_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",true)};T.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};T.prototype.on_show=function(e9){var e8;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(fa){return function(fb){if(fa._get_unlink_select()===Constants.ROLE_PERSONAL){fa._clear_delete_checkbox();return fa.$modal_window.find(".new_client").hide()}else{fa._set_delete_checkbox();return fa.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(er("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cD.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(fa){return function(fb){if(fa._get_unlink_select()===Constants.ROLE_WORK){fa._clear_delete_checkbox();return fa.$modal_window.find(".new_client").hide()}else{fa._set_delete_checkbox();return fa.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(er("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_checkbox();this._set_delete_text(er("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(fa){return function(fb){if(fa._get_unlink_select()===Constants.ROLE_PERSONAL){return fa._set_delete_text(er("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(fa._get_unlink_select()===Constants.ROLE_WORK){return fa._set_delete_text(er("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cD.get_viewer().team_name}))}else{return fa._set_delete_text(er("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){e8="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(er("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:e8}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};T.prototype.get_selected_hosts=function(){var e8;if(br.values(this.host_ids).length===1){return br.values(this.host_ids)}e8=by(".unlink-choice").val();if(e8==="both"){return br.values(this.host_ids)}else{return[this.host_ids[e8]]}};return T})(dZ);var eB;eB=A.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(e7,e8){var T;if(e8.hasAttribute("data-div")){e7.preventDefault();T=e8.readAttribute("data-div");return eu.push_state("/news/"+T)}});return eu.add_callback("/news",eB.history_change)},change_tab:function(T){var e7;e7=$$("#nav a[data-div="+T+"]").first();if($(e7)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(e7).addClassName("selected");return $(T).addClassName("selected")}},history_change:function(T){T=T||eB.DEFAULT_TAB;return eB.change_tab(T)}};var dz;dz=A.Recover={init:function(){var T;T=$("recover-form");return T.observe("submit",this.form_submit.bind(this))},form_submit:function(T){this.clear_error();T.preventDefault();return bN.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(e7){var T;T=JSON.parse(e7.responseText);if(T.status==="error"){this.show_error(T.msg)}if(T.status==="ok"){this.show_hosts(T)}if(T.status==="redirect"){return window.location.href=T.url}},show_hosts:function(fd){var fa,e8,e9,T,fc,e7,fb;bN.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(fd.filename);e8=$("trusted-hosts");e8.update();fb=fd.hosts;for(fc=0,e7=fb.length;fc<e7;fc++){fa=fb[fc];T=new Element("li");e9="lnx";if(fa.platform==="mac"){e9="osx"}if(fa.platform==="win"){e9="win"}T.__sert(cp.make("web",e9));T.__sert(new e2(fa.display_name.escapeHTML()));e8.appendChild(T)}$("login-step").hide();return $("hosts-step").show()},show_error:function(T){$("error-messages").update(T);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var de;de=A.Restore={next:function(T,e9){var e8,e7;e7=by("ul.selected");e8=e7.next("ul");e8.addClass("selected");e7.removeClass("selected");if(e8.next("ul").length){by("#next-page").show()}else{by("#next-page").hide()}by("#prev-page").show();return de.inc_page(1)},prev:function(T,e9){var e8,e7;e7=by("ul.selected");e8=e7.prev("ul");e8.addClass("selected");e7.removeClass("selected");if(e8.prev("ul").length){by("#prev-page").show()}else{by("#prev-page").hide()}by("#next-page").show();return de.inc_page(-1)},inc_page:function(e8){var e7,T;e7=parseInt(by("#page_num").text(),10);T=e7+e8;return by("#page_num").text(T)},init:function(e9,T,e7){var e8;e8=cD.get_viewer().get_user_by_id(e7);by("#next-page").on("click",function(fa){de.next(fa);return false});by("#prev-page").on("click",function(fa){de.prev(fa);return false});by("#restore-submit-button").on("click",function(fa){du.do_folder_restore(e9,e8);return false});by("#restore-cancel-button").on("click",function(fa){return bV.redirect(T)});return by("#restore-back-button").on("click",function(fa){return bV.redirect(T)})}};var b8,dp,cy,aL,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};b8=A.SelectRoleModal=(function(T){cG(e7,T);function e7(){this.on_show=dl(this.on_show,this);return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_select_role=null;e7.prototype.on_show=function(){return by(".role-options li").click((function(e8){return function(fa){var e9,fb;e9=by(fa.target).closest("li");fb=e9.data("role");cC(e8.on_select_role,"missing on_select_role implementation");e8.on_select_role(fb);return e8.hide()}})(this))};return e7})(dZ);cy=A.SharedFolderSelectRoleModal=(function(T){cG(e7,T);function e7(){return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_select_role=function(e9){var e8;e8=function(){bT.role_picker.ensure_role_is_visible(e9);dw.set_role(e9);return o.start_wizard_for_user(cD.get_viewer().get_user_by_role(e9))};if(e9===bI.logged_out_role){return bI.show_modal({role:e9,on_success:e8})}else{return e8()}};return e7})(b8);aL=A.ShmodelC2DSelectRoleModal=(function(T){cG(e7,T);function e7(){return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_select_role=function(e9){var e8;e8=function(){return af.show_c2d_modal(e9)};if(!cD.get_viewer().is_role_signed_in(e9)){return bI.show_modal({role:e9,on_success:e8})}else{return e8()}};return e7})(b8);dp=A.ShareShmodelSelectRoleModal=(function(T){cG(e7,T);function e7(){this.on_select_role=dl(this.on_select_role,this);return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_select_role=function(e8){return af.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,e8)};return e7})(b8);var cI;cI=A.TabController=Class.create({initialize:function(e8,e7){var T;T=$(e8);cC(T,e8+" is missing.");this.container=T;this.options={killEvent:true};Object.extend(this.options,e7);return this.listen()},listen:function(){var fb,e8,fa,e7,e9,T;e8=this;e9=this.container.select("a");T=[];for(fa=0,e7=e9.length;fa<e7;fa++){fb=e9[fa];cC(fb.id&&fb.id.length>0,"Element is missing an id");T.push(fb.observe("click",(function(fc){return this.click(fc)}).bindAsEventListener(e8)))}return T},click:function(T){if(this.options.killEvent){Event.stop(T)}return this.toggle($(T.target))},toggle:function(e7){var fa,T,e9,fb,e8;e8=this.container.down("a.selected");if(e8){fb=$(e8.id+"-content");if(fb){fb.hide()}}this.container.select(".selected").invoke("removeClassName","selected");T=false;if(!e7){e7=this.container.down("a");T=true}e7.addClassName("selected");fa=$(e7.id+"-content");if(fa){fa.show()}if(this.options.onTabChange){this.options.onTabChange(e7,e8)}if(this.options.url_prefix){e9=this.options.url_prefix;if(!T){e9+="/"+e7.id}return eu.push_state(e9)}}});var dH;dH=A.InviteForm={initialized:false,init:function(){if(this.initialized){return}return by((function(T){return function(){T.add_auto_completer=new Autocompleter.ContactsTokenizer(cD.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(e7){return e7.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});T.add_auto_completer.clearTokens();T.tokenAdd=by.proxy(T._tokenAdd,T);T.tokenRemove=by.proxy(T._tokenRemove,T);by("#team-invite-new-collab-input")[0].on("token:add",T.tokenAdd);by("#team-invite-new-collab-input")[0].on("token:remove",T.tokenRemove);T.reset_licenses();T.update_free_licenses_message();T.initialized=true;T.setup_tab_support(by);return cb.init()}})(this))},set_emails:function(T){if(T==null){return}return by((function(e7){return function(){var fa,fc,fb,e9,e8;e7.init();e8=[];for(fb=0,e9=T.length;fb<e9;fb++){fa=T[fb];fc=e7.add_auto_completer.createTokenInfo(null,fa,R.EMAIL);e8.push(e7.add_auto_completer.addContact(fc))}return e8}})(this))},rebind_modal_submit_autocompleter:function(){var T,e7;T=this.invite_modal.$modal_window;e7=T.find(".tokenizer-submit-button");e7.on("mousedown",(function(e8){return function(){return e8.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(T)},setup_tab_support:function(T){return T.find("#team-invite-new-collab-input").first().on("keyup change",function(){var e7;e7=T.find(".new-collab-input").first();if(e7.val()!==""){return e7.attr("tabindex",-1)}else{return e7.removeAttr("tabindex")}})},reset_modal_licenses:function(){var e7,e8,T;e7=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.total_licenses=(e8=(T=__CIRCULAR_DEPENDENCY__.MembersReact)!=null?typeof T.get_total_licenses==="function"?T.get_total_licenses():void 0:void 0)!=null?e8:this.total_licenses;this.update_used_licenses(e7);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(T){this.available_licenses--;by(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(T){this.available_licenses++;by(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(e7){var e8,T,e9;if(window.active_team_member_table){e9=window.active_team_member_table.data.users;for(T in e9){e8=e9[T];if(e8.email===e7){return true}}}},update_license_count:function(){var T,e7;T=by("#license-count-message");if(this.available_licenses<0){e7=er("You need more licenses for this invitation.");T.addClass("over")}else{if(this.available_licenses===0){e7=er("You have no remaining licenses.");T.removeClass("over")}else{if(this.available_licenses>0){e7=a6("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});T.removeClass("over")}else{e7="You have \u00a0 remaining licenses."}}}return T.text(e7)},init_modal_licenses:function(e8,e7,T){if(!this.invite_modal){this.invite_modal=new s(T)}this.total_licenses=e8;this.is_trial=e7;return by("body").trigger("invite-modal-initialized")},update_used_licenses:function(T){this.used_licenses=T;return this.reset_licenses()},init_form_licenses:function(e8,T,e7){this.total_licenses=e8;this.used_licenses=T;this.is_trial=e7;return dH.reset_licenses()},add_total_licenses:function(T){T=T||0;if(T>0){this.total_licenses+=T;this.available_licenses+=T;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(T)}}},on_add_licenses_exit:function(e7,T){var e8;if((e8=this.invite_modal)!=null?e8.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(T)},reset_modal:function(){var T;T=this.invite_modal.$modal_window;cW.reset(T.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return T.find(".new-collab-input").val("")},on_add_licenses_click:function(e7){var T;e7.preventDefault();if(this.is_trial){if((T=this.invite_modal)!=null){T.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){dS.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=by.proxy(this.on_add_licenses_exit,this);dS.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return dS.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}},update_free_licenses_message:function(){var T;T=this.invite_as_limited();by(".team-invite-add-licenses").toggle(!T);by("#license-count-message").toggle(!T);return by("#license-free-message").toggle(T)},invite_as_limited:function(){var T;T=by('input[name="membership_type"]');return T&&T.is(":checked")}};var s,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};s=A.InviteModal=(function(e7){cG(T,e7);function T(e8){this.transition_view_model=e8;this._reset=dl(this._reset,this);this._update_form_pricing_information=dl(this._update_form_pricing_information,this);this._update_remaining_licenses_message=dl(this._update_remaining_licenses_message,this);this._make_transition_info_request=dl(this._make_transition_info_request,this);this._handle_token_change=dl(this._handle_token_change,this);this._licenses_total=dl(this._licenses_total,this);this.on_hide=dl(this.on_hide,this);this.on_show=dl(this.on_show,this);T.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new e1([e8]);this.probability=Math.random()}this.skip_reset=false}T.prototype.on_confirm_button_click=function(e9){var e8;if(dH.invite_as_limited()){e8=0}else{e8=this.add_qty}return dL.add_users(e9,e8)};T.prototype.on_show=function(){var e9,e8;this._reset();e8=by('input[name="membership_type"]');if(e8!=null){e8.attr("checked",false)}if(e8!=null){e8.click((function(fa){return function(){dH.update_free_licenses_message();return fa._updated_charges_messages(dH.invite_as_limited())}})(this))}e9=by("#team-invite-wizard .team-invite-add-licenses");e9.on("click",by.proxy(dH.on_add_licenses_click,dH));by(window).on("token:changed",this._handle_token_change);if(dH.initialized){dH.update_license_count();dH.update_free_licenses_message()}return dS.register(dS.CLEAR,function(){return dH.reset_modal()})};T.prototype.on_hide=function(){return by(window).off("token:changed",this._handle_token_change)};T.prototype._licenses_to_add=function(){return -1*dH.available_licenses};T.prototype._licenses_total=function(){return dH.total_licenses+this._licenses_to_add()};T.prototype._handle_token_change=function(e9,e8){this._update_remaining_licenses_message(e8.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(fa){return function(){fa._make_transition_info_request();return fa.fetch_transition_timeout_id=null}})(this),100)}};T.prototype._make_transition_info_request=function(){var fa,e9,e8,fb;e9=Math.floor(Math.random()*1000000);this.current_callback_token=e9;fa=this._licenses_to_add();e8=this._licenses_total();fb=(function(fc){return function(fd){return fc._update_form_pricing_information(e9,fa,e8,fd!=null?fd[0]:void 0)}})(this);if(fa>0){return this.transition_info_fetcher.get(fb,{total_users:this._licenses_total()})}else{return fb(null)}};T.prototype._update_remaining_licenses_message=function(e8){var e9;this.remaining_licenses=e8;e9=this._get_remaining_licenses_message(e8);return this.$modal_window.find("#license-count-message").text(e9)};T.prototype._get_remaining_licenses_message=function(e8){var e9;if(e8<0){e9=er("You need more licenses for this invitation.")}else{if(e8===0){e9=er("After this invitation, you'll have no remaining licenses.")}else{e9=a6("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",e8).format({count:e8})}}return e9};T.prototype._update_form_pricing_information=function(fb,fc,e8,ff){var e9,fe,fd,fa;if(fb!==this.current_callback_token){return}if(ff&&fc>0){this.add_qty=fc;e9=this.transition_view_model.state.currency;fd=ff.current_total.amount;fe=e0.formatCurrency(fd,e9);fa=e0.formatCurrency(ff.recurring_total.amount,e9);by(".new-amount").text(fe);by(".add-qty").text(fc);by(".recurring-amount").text(fa);by(".total-qty").text(e8);by("#expected_price").val(fd);return this._updated_charges_messages(dH.invite_as_limited())}else{return this._reset()}};T.prototype._reset=function(){this.add_qty=0;by(".charges-section").hide();by("#expected_price").val(0);return by(".team-invite-buttons .confirm-button").val(er("Invite to team"))};T.prototype._updated_charges_messages=function(e8){if(this.inline_add_license&&this.add_qty>0&&!e8){by(".charges-section").show();return by(".team-invite-buttons .confirm-button").val(er("Invite and buy"))}else{by(".charges-section").hide();return by(".team-invite-buttons .confirm-button").val(er("Invite to team"))}};return T})(dZ);var bC,ao,av,P,d6,eN,bo,ez,dL,eX,ba,ck,m,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};dL=INLINE_JS.Team=A.Team={_use_async_reset:false,team_id:cD.get_viewer().team_id,set_team_id:function(T){this.team_id=T},setup_beta_modal_listeners:function(){var fb,fe,fc,T,fa,e9,fd,e7,e8;fe=by(".feature-list .enroll-button");T=by(".feature-list .feedback-button");for(fa=0,fd=fe.length;fa<fd;fa++){fb=fe[fa];fc=by(fb).data("feature");by(fb).click((function(ff){return function(){return new ao(ff).show()}})(fc));fb.disabled=false}e8=[];for(e9=0,e7=T.length;e9<e7;e9++){fb=T[e9];fc=by(fb).data("feature");e8.push(by(fb).click((function(ff){return function(){return new av(ff).show()}})(fc)))}return e8},invite_modal_show:function(T){if(!dH.invite_modal){return by("body").one("invite-modal-initialized",(function(e7){return function(){return e7.invite_modal_show(T)}})(this))}if(!this.invite_modal_already_initialized){dH.invite_modal.show();dH.init();this.invite_modal_already_initialized=true}else{dH.invite_modal.show();dH.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dH.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dH.set_emails(T)},init_admin:function(){bi.set_vertical_space(2);return by("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return by(".team_name_change_notice .hide_link").click((function(T){return function(e7){return T.hide_team_name_change_banner()}})(this))},add_users:function(e8,T){var fa,e7,e9;Event.stop(e8);e7=$("team-invite-form");cC(e7,"Couldn't find the team invite form.");fa=by(e7).find("input[name='emails']");if(fa.length===0){aa.error(er("You haven't included anyone to invite! Please invite at least one person."));return}e9=bN.collect_form_vars(e7);by.extend(e9,{team_id:this.team_id});bN.add_loading(e8.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:e9,subject_user:cD.get_viewer().work_user,progress_text:er("Inviting members..."),noAutonotify:true,onSuccess:function(fg){var fe,fd,fc,ff,fb;bN.remove_loading();dH.reset_modal();dH.add_total_licenses(T);dH.invite_modal.hide();ff=by(".team_admin_members_table");fc=JSON.parse(fg.responseText);if(fc){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(fc!=null?fc.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(fc!=null?fc.num_invited:void 0)}}}fe=(function(){var fi,fh;fi=fc!=null?fc.users:void 0;fh=[];for(fd in fi){fb=fi[fd];fh.push(fb)}return fh})();if(fe.length===1){return aa.success(er("Invited %(user_email)s.").format({user_email:fe[0].email}))}else{if(fe.length>1){return aa.success(er("Invited %(user_count)d people.").format({user_count:fe.length}))}else{return aa.error(a6("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",fa.length).format({num_skipped:fa.length}))}}}else{return aa.error()}},onFailure:function(fd){var fb,fc;if(fd){if(fd.responseText.indexOf("err:")===0){fb=fd.responseText.substr(4);if(fb.indexOf("{")===0){fc=fb.evalJSON(true);bN.fill_errors(e7,fc)}else{fb=new e2(fb);aa.error(fb)}}else{aa.error()}}bN.remove_loading();return by("input[type='submit']").prop("disabled",false)},cleanUp:function(){bN.remove_loading();dH.reset_modal();return dH.invite_modal.hide()}})},show_demo_signup_modal:function(e8,e9,fa,e7,fb){var T,fe,fd,fc;this.webinar_key=e8;this.webinar_iso_datetime=e9;this.webinar_date=fa;this.webinar_title=e7;this.tab_url=fb;fc=er("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});fe=new P({element_id:"demo-signup-modal",title:fc});fe.show();fe.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);fe.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);fe.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);fe.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);fd=fe.$modal_window.find("input[name=retURL]");fd.attr("value",fd.val()+"#"+this.tab_url);T=fe.$modal_window.find("#demo-signup-form")[0];return T.on("submit",fe.on_confirm_button_click)},show_unsuspend_modal:function(e8,T,e7){var e9;e9=new bo({element_id:"dfe-unsuspend-modal",focus:"confirm"});e9.user_name=e8||e7;e9.email=e7;e9.user_id=T;e9.team_id=this.team_id;e9.show();return false},show_remove_or_deactivate_modal:function(e8,fb,T,e7,fc,fa){var e9;e9=new d6({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});e9.user_name=fb||e7;e9.email=e7;e9.user_id=T;e9.team_id=this.team_id;e9.invited=fc;e9.hide_transfer_wipe=fa;e9.show();return false},show_remove_modal:function(e9,fc,T,e7,fd,e8,fb){var fa;fa=new eN({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});fa.user_name=fc||e7;fa.email=e7;fa.user_id=T;fa.team_id=this.team_id;fa.invited=fd;fa.num_api_apps=e8;fa.hide_transfer_wipe=fb;fa.show();return false},remove_user:function(e9,fa){var e8,e7,T;alert("in remove_user");Event.stop(e9);e7=by("input[type=submit]","#remove-user-modal");e7.attr("disabled",1);T=eY.vars.user_id;if(fa){e8=true}else{e8=by("input[name=should_disable]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:T,should_disable:e8},onSuccess:(function(fb){return function(fe){var fd,ff,fc;fd=JSON.parse(fe.responseText);if((ff=window.active_team_member_table)!=null){ff.remove_user(eY.vars.user_id)}if((fc=window.removed_team_member_table)!=null){fc.add_users(fd)}fb.decrement_used_licenses();return aa.success(er("User removed."))}})(this),cleanUp:function(){eY.hide();return e7.removeAttr("disabled")}})},show_reinvite_modal:function(e8,e9,T,e7){var fa;dj.fillVal(e7,"reinvite-user-email");dj.fillVal(e9,"reinvite-user-team");fa=er("Resend invite to '%(email_address)s'").format({email_address:bO.em_snippet(e7,18)});return eY.show(fa,$("reinvite-user-modal"),{user_id:T,button:e8})},reinvite_user:function(e7){var T;Event.stop(e7);T=eY.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(fb){var e9,fa,e8,fc;aa.success(er("Invite sent."));if((fc=$("team-member-info"))!=null){fc.update(fb.responseText)}e9=window.active_team_member_table;if(e9){e8=e9.data.users[T];e8.invite_expired=false;fa={};fa[T]=e8;return e9.update_user_data(fa)}},cleanUp:function(){return eY.hide()}})},show_request_license_modal:function(e7,T){var e8;e8=er("Request a license?");return eY.show(e8,$("request-license-modal"),{user_id:T,button:e7})},request_license:function(e7){var T;Event.stop(e7);T=eY.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(e8){by("#request_license_text").hide();by("#request-license-section").hide();return aa.success(er("License Requested."))},cleanUp:function(){return eY.hide()}})},show_user_activity_log_modal:function(T,e8,e9){var e7;e7=by("#activity-log-modal");e7.find(".activity-log-email").text(e8);e7.find(".activity-log-name").text(e9);e7.find("#activity-log-user-message").show();return eY.show(er("Create activity report"),e7[0],{user_id:T})},show_team_activity_log_modal:function(e7,e8){var T;T=by("#activity-log-modal");T.find(".activity-log-email").text(e7);T.find(".activity-log-name").text(e8);T.find("#activity-log-team-message").show();return eY.show(er("Create full activity report"),T[0])},generate_activity_log:function(fd){var fb,e9,fc,fa,T,e8,e7;Event.stop(fd);e9=by("#activity-log-modal");fc=e9.find("input[name='from_date']").val();T=e9.find("input[name='to_date']").val();if(fc>T){aa.error(er("Your start date is after your end date."));return}fa=this.team_id;e7=eY.vars.user_id;e8=new Date().getTimezoneOffset().toString();fb=by(".activity-report-generator .freshbutton-blue");fb.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:fc,to_date:T,team_id:fa,user_id:e7,tzoffset:e8},onSuccess:function(fe){return aa.success(er("Report started. We'll email you when it's ready."))},cleanUp:function(){eY.hide();return fb.prop("disabled",false)}})},show_reset_password_modal:function(e7,e8,T){var e9;by("#reset-password-modal .member-name").text(e8);e9=er("Reset password for '%(user_name)s'").format({user_name:e8});return eY.show(e9,$("reset-password-modal"),{user_id:T,button:e7})},reset_password:function(e7){var T;Event.stop(e7);T=eY.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(e8){return aa.success(er("User's password reset."))},cleanUp:function(){return eY.hide()}})},show_reset_all_passwords_modal:function(){return eY.show(er("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(T){return this._use_async_reset=T},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cD.get_viewer().work_user,progress_text:er("Resetting all passwords..."),onSuccess:function(T){return aa.success(er("All passwords reset."))},cleanUp:function(){return eY.hide()}})},show_admin_status_modal:function(e8,fd,ff,fa,fe,fb){var e7,T,e9,fc;T=fe.strip()||fa;e9=void 0;e7=void 0;fc=void 0;if(fb){fc=er("Add admin permissions for '%(person_name)s'").format({person_name:T.escapeHTML()});e9=er("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});e7=er("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"})}else{fc=er("Remove admin privileges from '%(person_name)s'").format({person_name:T.escapeHTML()});e9=er("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});e7=er("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"})}dj.fillVal(fa,"admin-status-email");dj.fillVal(e9,"admin-status-action");dj.fillVal(e7,"admin-status-button-action");eY.show(fc,$("admin-status-modal"),{user_id:ff,button:e8,admin_on:fb});return false},set_admin_status:function(e7){var T;Event.stop(e7);T=eY.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:T,on:(eY.vars.admin_on?"yes":"no")},onSuccess:function(e9){var fa,e8;fa=(eY.vars.admin_on?er("User's admin status granted."):er("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){e8=JSON.parse(e9.responseText);window.active_team_member_table.update_user_data(e8);return aa.success(fa)}else{if(eY.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(eY.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(eY.vars.user_id)}}}},cleanUp:function(){return eY.hide()}})},show_disable_2fa_modal:function(e8,T,e7){by("#disable-2fa-modal .member-name").text(e7);return eY.show(er("Disable two-step verification"),$("disable-2fa-modal"),{user_id:T,elm:e8})},show_reset_2fa_modal:function(e8,T,e7){by("#reset-2fa-modal .member-name").text(e7);return eY.show(er("Reset two-step verification"),$("reset-2fa-modal"),{user_id:T,user_name:e7,elm:e8})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:eY.vars.user_id},onSuccess:function(e7){var T;by(".tfa_enabled").replaceWith(er("Disabled"));T=JSON.parse(e7.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}aa.success(er("Two-step verification reset for %(user_name)s").format({user_name:eY.vars.user_name}));return eY.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:eY.vars.user_id},onSuccess:function(e7){var T;by(".tfa_enabled").replaceWith(er("Disabled"));T=JSON.parse(e7.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}aa.success(er("Two-step verification disabled."));return eY.hide()}})},show_sso_preview_email:function(T){return eY.show(er("Email preview"),$(T))},show_sso_sample_email:function(T){return eY.show(er("Sample email"),$(T))},show_user_message_modal:function(e8,e7,T){var e9;dj.fillVal(T,"user-message-email");e9=er("Send email to '%(user_name)s'").format({user_name:e8});$("user-message").value="";eY.show(e9,$("user-message-modal"),{user_name:e8,user_id:e7});return dX.focus.defer("user-message")},send_user_message:function(){var e7,T;T=eY.vars.user_id;e7=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:T,team_id:this.team_id,message:e7},onSuccess:function(){var e8;e8=eY.vars.user_name;aa.success(er("Message successfully sent to %(user_name)s.").format({user_name:e8}));return eY.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});by(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return by(".pin_notice").hide()},hide_pin_banner_with_user_id:function(T,e7){var e8;e8=function(e9){return by(e7).closest("span").removeClass("on").addClass("off")};if(T===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:e8})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:T},onSuccess:e8})}},get_pin_with_user_id:function(T,e8,e7){var e9;if(e7==null){e7=null}if(e7===null){e7=function(fb,fa){by(fa).closest("span").find(".pin-value").text(fb.pin+" -");return by(fa).closest("span").removeClass("off").addClass("on")}}e9=function(fb){var fa;fa=JSON.parse(fb.responseText);return e7(fa,e8)};if(T===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:e9})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:T},onSuccess:e9})}},send_team_message:function(e7){var T;Event.stop(e7);T=$F("team-message").strip();if(T){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:T},onSuccess:function(e8){aa.success(er("Message successfully sent to team."));return eY.hide()}})}},show_security_message_modal:function(){return new eX().show()},send_team_security_message:function(e8){var e7,T;Event.stop(e8);T=$F("team-security-message").strip();e7=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:e7.serialize(true),onSuccess:function(e9){aa.success(er("Message successfully sent."));return eY.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(T,e7){this.used_licenses=T;return this.total_licenses=e7},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(T,e7){$("migration-url").value=e7;eY.show(er("Migration link for '%(email)s'").format({email:bO.em_snippet(T,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(e7,T,e8){bi.hide_all();by("#end-session-modal .member-name").text(by("#member-name").text());return eY.show(er("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:e7,user_id:T,elm:e8})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:eY.vars.login_id,team_id:this.team_id,user_id:eY.vars.user_id},onSuccess:function(){eY.hide();dL.remove_closest_row(eY.vars.elm);return aa.success(er("Web session closed."))}})},unlink_device:function(T,e9,fd,e7,fe,e8,fa){var fc,fb;bi.hide_all();fc=$("unlink-device-modal-"+e8);fb=er("Unlink %(device_name)s").format({device_name:fd});return eY.show(fb,fc,{app_id:e9,user_id:fe,elm:fa,device_id:T,display_name:fd})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:eY.vars.app_id,team_id:this.team_id,user_id:eY.vars.user_id,device_id:JSON.stringify(eY.vars.device_id)},subject_user:cD.get_viewer().work_user,onSuccess:function(){eY.hide();dL.remove_closest_row(eY.vars.elm);return aa.success(er("%(device_name)s unlinked.").format({device_name:eY.vars.display_name}))}})},disable_app:function(e7,e8,T,e9){bi.hide_all();by("#disable-app-modal .app-name").text(e8);by("#disable-app-modal .member-name").text(by("#member-name").text());return eY.show(er("Disable '%(app_name)s'?").format({app_name:e8}),$("disable-app-modal"),{app_id:e7,user_id:T,elm:e9})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eY.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:eY.vars.user_id},subject_user:cD.get_viewer().work_user,onSuccess:function(T){eY.hide();dL.remove_closest_row(eY.vars.elm);return aa.success(T.responseText)}})},remove_closest_row:function(e9){var e8,e7,T;e8=by(e9).closest(".team_admin_table_row");e7=by(e8).closest(".team_admin_table");if(e7.find(".team_admin_table_row").length===1){T=e7.prev(".team_admin_table_title");if(!T.length){T=by(".team_apps_table_panel")}T.remove();return e7.remove()}else{return e8.remove()}},submit_report_form:function(T){by(T.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true}};ao=A.BetaEnrollConfirmationModal=(function(e7){cG(T,e7);function T(e8){this.feature_name=e8;this.on_confirm_button_click=dl(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}T.prototype.on_confirm_button_click=function(e8){by("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return T})(dZ);av=A.BetaFeedbackModal=(function(e7){cG(T,e7);function T(e8){this.feature_name=e8;this.success=dl(this.success,this);T.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(e9){return function(fd){var fc,fb,fa;fd.preventDefault();fc=by(fd.target);fb=fc.closest("form");fa={feature_name:e9.feature_name};return bN.ajax_submit(fb[0],false,e9.success,e9.error,fc[0],fa)}})(this)}T.prototype.success=function(e8){aa.success(er("Thank you for your feedback."));return this.$modal_window.hide()};T.prototype.error=function(e8){if(e8.status!==200){return aa.error(er("Failed to submit feedback. Please try again."))}};return T})(dZ);P=A.DemoSignupModal=(function(T){cG(e7,T);function e7(){this.on_show=dl(this.on_show,this);this.on_confirm_button_click=dl(this.on_confirm_button_click,this);return e7.__super__.constructor.apply(this,arguments)}e7.prototype.on_confirm_button_click=function(fc){var fk,fh,fd,e8,ff,fa,fj,fi,e9,fg,fe,fb;fc.preventDefault();fe=$("demo-signup-form");fi=$("1210");fa=by(fe).find("input[name='first_name']").val();by(fi).find("input[name='FirstName']").attr("value",fa);fj=by(fe).find("input[name='last_name']").val();by(fi).find("input[name='LastName']").attr("value",fj);ff=by(fe).find("input[name='email']").val();by(fi).find("input[name='Email']").attr("value",ff);fg=by(fe).find("input[name='phone_number']").val();by(fi).find("input[name='Phone']").attr("value",fg);fk=by(fe).find("input[name='company_name']").val();by(fi).find("input[name='Company']").attr("value",fk);fd=by(fe).find("select[name='company_size']");fh=fd.find("option:selected").val();by(fi).find("input[name='Company_size__c']").attr("value",fh);e8=$(this.$modal_window.find(".confirm-button")[0]);fb=(function(fl){return function(fm){fl.$modal_window.hide();return fi.submit()}})(this);e9=bN.collect_form_vars(fe,true);return bN.ajax_submit(fe,false,fb,false,e8,e9,true)};e7.prototype.on_show=function(e8){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return cb.init()};return e7})(dZ);bC=A.AccountTransferBaseModal=(function(e7){cG(T,e7);function T(e8,fa,e9){this.file_action_selector=fa;this.transfer_choice_selector=e9;this._clearInput=dl(this._clearInput,this);this._markInputInvalid=dl(this._markInputInvalid,this);this._markInputValid=dl(this._markInputValid,this);this._tokenRemove=dl(this._tokenRemove,this);this._tokenAdd=dl(this._tokenAdd,this);this._selectChange=dl(this._selectChange,this);this._isTransferSelected=dl(this._isTransferSelected,this);this.handleAjaxFailure=dl(this.handleAjaxFailure,this);T.__super__.constructor.call(this,e8,this.file_action_selector,this.transfer_choice_selector)}T.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cD.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(e8){return function(e9){return e9.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(e8.email?[e8.email.toLowerCase()]:[])}})(this)});this.tokenAdd=by.proxy(this._tokenAdd,this);this.tokenRemove=by.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=by.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};T.prototype.handleAjaxFailure=function(e8){if(e8.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};T.prototype._isTransferSelected=function(){return by(this.transfer_choice_selector).prop("checked")};T.prototype._selectChange=function(e8){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};T.prototype._tokenAdd=function(e8){this.$collab_input.hide();if(e8.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};T.prototype._tokenRemove=function(e8){this.$collab_input.show();return this._clearInput()};T.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};T.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};T.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return T})(dZ);eX=A.TwoFactorMessageModal=(function(e7){cG(T,e7);function T(){T.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}T.prototype.on_confirm_button_click=function(e8){dL.send_team_security_message(e8);return this.hide()};return T})(dZ);bo=A.DfeUnsuspendUserModal=(function(T){cG(e7,T);function e7(e8){this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.success_callback=dl(this.success_callback,this);e7.__super__.constructor.call(this,e8)}e7.prototype.before_show=function(){var e8;e7.__super__.before_show.call(this);e8=er("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(e8);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};e7.prototype.success_callback=function(e8){var e9;aa.success("User unsuspended");if((e9=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){e9.refresh_member_stats()}return this.hide()};e7.prototype.on_confirm_button_click=function(fa){var e8,e9;fa.preventDefault();e9=this.$modal_window.find(".dfe-unsuspend-modal")[0];e8=$(this.$modal_window.find(".confirm-button")[0]);return bN.ajax_submit(e9,false,this.success_callback,false,e8)};return e7})(dZ);d6=A.DfeRemoveOrDeactivateUserModal=(function(e7){cG(T,e7);function T(e8){this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.success_callback=dl(this.success_callback,this);this.on_show=dl(this.on_show,this);this.handle_change_action=dl(this.handle_change_action,this);this.switch_to_uninvite_mode=dl(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=dl(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=dl(this.switch_to_deactivation_mode,this);this.show_removal_content=dl(this.show_removal_content,this);this.show_deactivation_content=dl(this.show_deactivation_content,this);this.set_modal_class=dl(this.set_modal_class,this);T.__super__.constructor.call(this,e8,"input[name=transfer_files]","#transfer_files_on")}T.prototype.set_form_action_to_deactivate=function(){return by(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/deactivate_user")};T.prototype.set_form_action_to_remove=function(){return by(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};T.prototype.set_modal_class=function(fa){var e9,e8;e9="suspending deleting";e8=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal");e8.removeClass(e9);return e8.addClass(fa)};T.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};T.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};T.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};T.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};T.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};T.prototype.handle_change_action=function(e8){e8.preventDefault();if(by("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};T.prototype.on_show=function(e8){var e9;T.__super__.on_show.call(this);by("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){e9=er("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{e9=er("Remove %(user_name)s").format({user_name:this.user_name});by("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}this.$modal_window.find(".db-modal-title-text").text(e9);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};T.prototype.success_callback=function(e8){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}if(this.invited){aa.success(er("User uninvited"))}else{if(by("#deactivate_option").is(":checked")){aa.success(er("User suspended"))}else{aa.success(er("User deleted"))}}return this.hide()};T.prototype.on_confirm_button_click=function(fa){var e8,e9;fa.preventDefault();e9=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")[0];e8=$(this.$modal_window.find(".confirm-button")[0]);return bN.ajax_submit(e9,false,this.success_callback,this.handleAjaxFailure,e8)};return T})(bC);eN=A.DfeRemoveUserModal=(function(T){cG(e7,T);function e7(e8){this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.success_callback=dl(this.success_callback,this);this.on_show=dl(this.on_show,this);e7.__super__.constructor.call(this,e8,"input[name=transfer_files]","#transfer_files_on")}e7.prototype.on_show=function(e9){var e8,fa;e7.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){fa=er("Uninvite %(user_name)s").format({user_name:this.user_name})}else{fa=er("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(fa);if(this.num_api_apps){e8=a6("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(e8)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}if(this.hide_transfer_wipe){return this.$modal_window.find(".active_user_remove_setting").remove()}};e7.prototype.success_callback=function(fa){var e9,fb,e8;e9=JSON.parse(fa.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((fb=window.active_team_member_table)!=null){fb.remove_user(this.user_id)}if((e8=window.removed_team_member_table)!=null){e8.add_users(e9)}}if(this.invited){aa.success(er("User uninvited."))}else{aa.success(er("User removed."))}dL.decrement_used_licenses();return this.hide()};e7.prototype.on_confirm_button_click=function(fa){var e8,e9;fa.preventDefault();e9=this.$modal_window.find(".dfe-remove-user-modal")[0];e8=$(this.$modal_window.find(".confirm-button")[0]);return bN.ajax_submit(e9,false,this.success_callback,this.handleAjaxFailure,e8)};return e7})(bC);ez=A.ManageFilesModal=(function(e7){cG(T,e7);function T(e9,fa,e8){this.source_user_id=e9;this.source_user_name=fa;this.options=e8;this.on_confirm_button_click=dl(this.on_confirm_button_click,this);this.success_callback=dl(this.success_callback,this);T.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}T.prototype.get_form=function(){return this.$modal_window.find("form")[0]};T.prototype.on_show=function(){var e8;T.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);e8=er("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(e8);return this.get_form().on("submit",this.on_confirm_button_click)};T.prototype.success_callback=function(e9){var e8;e8=JSON.parse(e9.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(e8)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",e8)}}}if(by("#move-files").prop("checked")){aa.success(er("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{aa.success(er("Permanently deleted files"))}return this.hide()};T.prototype.on_confirm_button_click=function(fa){var e8,e9;fa.preventDefault();e9=this.get_form();e8=$(this.$modal_window.find(".confirm-button")[0]);return bN.ajax_submit(e9,false,this.success_callback,this.handleAjaxFailure,e8)};return T})(bC);ck=A.show_manage_files_modal=function(T,e7){var e8;e8=new ez(T,e7,{element_id:"manage-files-modal",focus:".new-collab-input"});return e8.show()};m=function(){var T;T=function(e9,e8){var e7,fa;by(e8).css("display","none");e7=by(e8).closest("#user_generate_liveops_pin");fa=e7.find(".user_generate_liveops_pin_value");fa.text(e9.pin);by(e8).addClass("liveops_pin_elem_invisible");return e7.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dL.get_pin_with_user_id(null,this,T);return false};by("#user_generate_liveops_pin_button").click(m);ba=function(){by("#help_callus_title").hide();by("#help_callus_details").show();return false};by("#help_callus_trigger").click(ba);var bx;bx=A.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var b1;b1=A.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var a0;a0=A.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(e7,e8){var T;if(e8==null){e8=null}T=Object.clone(e7);if(T.is_dir){T.ago="";T.ts=0}else{T.target_ns=false}T.sort_key=dX.decode_sort_key(T.sort_key);T.request_id=e8!=null?e8:null;return new cK(T)},filepreview_from_selected:function(fb,fa,e9,e8){var T,fc,e7;if(fa==null){fa=false}if(e9==null){e9=false}if(e8==null){e8=Constants.BROWSE_UNKNOWN}if(fb.bytes<0||fb.preview_type==="download"){window.open(fb.href,"_blank");return}e7=eu.get_url();fc=eu.deconstruct_url(e7);T=e7.indexOf("/s/")===0;k.show(fb,cl.active_user,{files:cl.files,file_view_mode:aQ.FileViewModeType.BROWSE,should_focus_comment_input:e9},e8);if(!(fa||T||fc.qargs.preview===fb.filename)){k.set_preview_url()}},profile_files:function(e7){var e8,e9,fb,T,fa;e9={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0,compressible_count:0,can_permanently_delete:0};for(fb=0,T=e7.length;fb<T;fb++){e8=e7[fb];if(e8.dir){e9.folders+=1}else{e9.files+=1}if(e8.is_sandbox()){e9.sandboxes+=1}if(e8.is_shared_folder()){e9.shared_folders+=1}if(e8.bytes===-1){e9.deleted+=1}if(e8.target_ns){e9.target_namespaces+=1}if(e8.fq_path.toLowerCase()==="/public"&&cl.public_folder_enabled){e9.public_folder=1}if(e8.in_root_coll){e9.in_root_coll+=1}if(e8.compressible){e9.compressible_count+=1}if(!((fa=cl.permanent_delete_is_disabled_by_ns_id)!=null?fa[e8.ns_id]:void 0)){e9.can_permanently_delete+=1}}return e9},profile_summary:function(e7){var e8,T;e8=a6("%d file","%d files",e7.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(e7.files);T=a6("%d folder","%d folders",e7.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(e7.folders);if(e7.files&&e7.folders){return er("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:e8,y_folders:T})}else{if(e7.files){return e8}else{if(e7.folders){return T}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var fd,fb,e8,e7,fc,fa,T,e9;fd=by("#browse");e8=fd.find("#browse-root-actions");e7=fd.find("#browse-sort");fb=fd.find("#browse-header-status");e9=this.SPECIAL_MODES;for(fa=0,T=e9.length;fa<T;fa++){fc=e9[fa];fd.removeClass(fc);e8.removeClass(fc);e7.removeClass(fc);fb.removeClass(fc)}if(b3.sparky_search_ui_enabled){b3.reset_fulltext_search(true);fd.removeClass("fulltext_search");e8.removeClass("fulltext_search");e7.removeClass("fulltext_search");fb.removeClass("fulltext_search");by("#fulltext-search-loading").hide();return by("#fulltext-search-all-link").hide()}},set_special_mode:function(fc){var e7,e8,fe,T,fb,e9,fd,fa;e7=by("#browse");fe=e7.find("#browse-root-actions");T=e7.find("#browse-sort");e8=e7.find("#browse-header-status");cC(this.SPECIAL_MODES.indexOf(fc)!==-1,"unknown mode");fa=this.SPECIAL_MODES;for(e9=0,fd=fa.length;e9<fd;e9++){fb=fa[e9];if(fb!==fc){e7.removeClass(fb);fe.removeClass(fb);T.removeClass(fb);e8.removeClass(fb)}}e7.addClass(fc);fe.addClass(fc);T.addClass(fc);e8.addClass(fc);if(fc===this.SEARCH_MODE){if(b3.sparky_search_ui_enabled){e7.addClass("fulltext_search");fe.addClass("fulltext_search");T.addClass("fulltext_search");return e8.addClass("fulltext_search")}}},get_mode:function(){var fa,T,e9,e7,e8;T=this.BROWSE_MODE;e8=this.SPECIAL_MODES;for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];if(by("#browse").hasClass(fa)){T=fa}}return T},load_visible_thumbs:function(){var fg,fj,e9,ff,fk,fl,fh,e8,fd,e7,fc,fb,fi,T,fe,fa;e8=this.get_files_in_view();fj=e8[1]-e8[0];fh=[Math.max(e8[0]-fj,0),e8[0]];fl=[Math.min(e8[1],cl.files.length),Math.min(e8[1]+fj,cl.files.length)];fg=[];fe=[e8,fl,fh];for(fc=0,fi=fe.length;fc<fi;fc++){fk=fe[fc];ff=fk[0],fd=fk[1];fa=cl.files.slice(ff,+fd+1||9000000000);for(fb=0,T=fa.length;fb<T;fb++){e9=fa[fb];if(e9.get_div()){fg.push(e9.get_div().down("img"))}}}e7=function(fm){if(!fm.src.endsWith(cp.SPACER)){fm.addClassName("thumbnail");return fm.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bm.batch_load_thumbs(fg,this.THUMBS_BATCH_SIZE,e7)},get_files_in_view:function(){var fc,e9,fe,fa,fb,e8,T,ff,fd,e7,fg;T=[0,cl.files.length-1];e7=y.viewport_dimensions().height;fg=y.scroll_offsets().top;e8=this._get_elm_height();if(!e8){return T}fc=by("#browse-files");fa=parseInt(fc.css("padding-top"),10);if(!fc.length||isNaN(fa)){return T}if(by("body").hasClass("absolutize")){e9=fc.offset().top+fa;fe=e9-fg;if(fe>0){ff=0;fb=e7-fe;fd=fb/e8}else{ff=Math.abs(fe/e8);fd=Math.abs(e7-fe)/e8}}else{ff=fg/e8;fb=e7-fa;fd=(fb+fg)/e8}ff=Math.max(Math.floor(ff),0);fd=Math.min(Math.floor(fd),cl.files.length-1);return[ff,fd]},_get_elm_height:function(){var e7,T;if(cl.files.length>=3&&cl.files[1].get_div()){e7=by(cl.files[1].get_div());T=e7.outerHeight()+parseInt(e7.css("margin-bottom"))+parseInt(e7.css("margin-top"));return T}else{return null}},append_ellipsis:function(T){return er("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:T})}};var bk;bk=A.Sort=(function(){var fc,T,e9,fb,fa,e8,e7;e9=function(fe){var fd;fd=fe?1:-1;return function(ff,fg){return fd*dX.sort_by_rank_or_key(ff,fg)}};fb=function(fe){var fd;fd=fe?1:-1;return function(ff,fg){if(ff.bytes>fg.bytes){return fd}else{if(ff.bytes<fg.bytes){return -fd}else{return fd*bk.FILES_BY_NAME(ff,fg)}}}};fc=function(fe){var fd;fd=fe?1:-1;return function(ff,fg){return fd*(ff.fq_path.toLowerCase()>fg.fq_path.toLowerCase()?1:-1)}};T=function(fe){var fd;fd=fe?1:-1;return function(fg,fh){var ff;ff=fg.ts===fh.ts?0:fg.ts>fh.ts?1:-1;return fd*ff}};e8=function(fd){return function(fg){var ff,fe;fe=fd(fg);ff=e9(true);return function(fh,fi){if(fh.dir^fi.dir){return(fh.dir?1:0)-(fi.dir?1:0)}else{return fe(fh,fi)||ff(fh,fi)}}}};fa=function(fd){return function(fg){var fe,ff;if(!bk.FOLDERS_FIRST){return fd(fg)}ff=fd(fg);fe=fg?1:-1;return function(fi,fj){var fh;if(fi.dir^fj.dir){fh=(fi.dir?0:1)-(fj.dir?0:1);return fe*fh}else{return ff(fi,fj)}}}};e7=function(fd){return function(fg){var fe,ff;ff=bk.FILES_BY_NAME(fg);fe=fg?1:-1;return function(fi,fj){var fh;if(fi.is_deleted^fj.is_deleted){return(fi.is_deleted?1:0)-(fj.is_deleted?1:0)}fh=0;if(fd){if(fi.get_category()!==fj.get_category()){fh=fi.get_category()<fj.get_category()?-1:1}else{if(fi.get_extension()!==fj.get_extension()){fh=fi.get_extension()<fj.get_extension()?-1:1}}}else{if(fi.get_extension()!==fj.get_extension()){fh=fi.get_extension()<fj.get_extension()?-1:1}else{if(fi.get_category()!==fj.get_category()){fh=fi.get_category()<fj.get_category()?-1:1}}}return(fe*fh)||ff(fi,fj)}}};return{FILES_BY_NAME:fa(e9),SHARED_WITH:fa(e9),FILES_BY_SIZE:e8(fb),FILES_BY_LOCATION:e8(fc),FILES_BY_KIND:e8(e7(true)),FILES_BY_EXTENSION:e8(e7(false)),FILES_BY_MODIFIED:e8(T),FOLDERS_FIRST:!dX.is_mac(),ALL_BY_MODIFIED:T}})();var dg,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};dg=A.FlexColumn=(function(){var fb,e7,fe,fa,fd,e8,T,e9,fc;fb=[{label:"FILES_BY_KIND",func:bk.FILES_BY_KIND,display:er("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bk.FILES_BY_EXTENSION,display:er("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bk.FILES_BY_SIZE,display:er("Size"),is_asc:false}];fd={label:"SHARED_WITH",func:bk.FILES_BY_NAME,display:er("Shared With"),is_asc:true};e7={};fe={};e8=[];fa=[];for(e9=0,fc=fb.length;e9<fc;e9++){T=fb[e9];e8.push(T.func);e7[T.label]=T.display;fe[T.label]=T.is_asc;fa.push(T.label)}fe[fd.label]=fd.is_asc;return{SORT_FUNCTIONS:e8,DISPLAY:e7,IS_ASC:fe,LABELS:fa,has_label:function(ff){return(bE.call(this.LABELS,ff)>=0)||ff===fd.label},has_sort:function(ff){return bE.call(this.SORT_FUNCTIONS,ff)>=0},next:function(fh,fg){var ff;if(fg==null){fg=false}ff=dg.LABELS.indexOf(fh)+1;if(ff===dg.LABELS.length){if(fg){return fd}else{ff=0}}return fb[ff]}}})();var b3,et;et=A.SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};b3=A.FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(fk,ff,fg,fl){var fj,e7,fi,fe,e8,fc,fb,fh,T,fd,fa,e9;this.sparky_search_ui_enabled=fk;this.firefly_enabled=ff;this.fulltext_search_enabled=fg;this.search_page_enabled=fl;if(this.sparky_search_ui_enabled){return}fe=$("browse-search");fi=$("browse-search-input");cb.add_interval_handler(fe,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(fm){return function(fn){fm.search();return Event.stop(fn)}})(this));$("exit-search-xclose").observe("click",(function(fm){return function(){return fm.exit_search()}})(this));key("/",cl.KEY_SCOPE,function(){if(L.is_active()){return}if(!fe.hasClassName("focused")){fi.focus();return false}});key("escape",cl.KEY_SCOPE,(function(fm){return function(){if(cl.in_search_mode()){fm.exit_search();return false}if(fi.getValue().strip()===""){fi.blur();return false}}})(this));key("tab",cl.KEY_SCOPE,(function(fm){return function(fn){if(document.activeElement===fi){fn.preventDefault();fi.blur();if(cl.files.length){eM.set_selected_files(cl.files[0])}else{if(cl.in_search_mode()){fm.toggle_advanced()}}return false}}})(this));e8="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",e8,this.toggle_advanced.bind(this));by(document).on(aB.RENAME,(function(fm){return function(){return fm.clear_cache()}})(this));fd=[aB.DELETE,aB.COPY,aB.MOVE,aB.PURGE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_LEAVE,aB.SF_UNSHARE,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE];for(fc=0,fh=fd.length;fc<fh;fc++){e7=fd[fc];fj=(function(fm){return function(fn){if(!cl.inside_dir){return fm.force_reload()}}})(this);document.observe(e7,fj);by(document).on(e7,fj)}fa=[bx.ADD,bx.MOVE,bx.REMOVE];e9=[];for(fb=0,T=fa.length;fb<T;fb++){e7=fa[fb];e9.push(document.observe(e7,(function(fm){return function(fn){return fm._update_number_results(cl.files.length)}})(this)))}return e9},get_state:function(){var fc,e8,fb,e7,fa,T,e9;fc=by("#browse-search");if(this.sparky_search_ui_enabled){fb={is_advanced:false}}else{fb={is_advanced:fc.length&&!fc.visible()}}if(fb.is_advanced){e9=["all_terms","any_terms","excluded_terms","exact"];for(fa=0,T=e9.length;fa<T;fa++){e8=e9[fa];e7=by("#"+e8).val();if(e7){fb[e8]=e7}}fb.include_files=by("#include_files").prop("checked");fb.include_folders=by("#include_folders").prop("checked");fb.include_deleted=!Constants.can_see_trash&&by("#include_deleted").prop("checked")}else{fb.query_unnormalized=this.get_basic_query();fb.query=fb.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.sparky_search_ui_enabled){fb.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return fb},set_state:function(fa){var e7,e9,T,e8;if(fa.is_advanced){e8=["all_terms","any_terms","excluded_terms","exact"];for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];if(fa[e7]){$(e7).setValue(fa[e7])}}by("#include_files").prop("checked",fa.include_files);by("#include_folders").prop("checked",fa.include_folders);if(!Constants.can_see_trash){by("#include_deleted").prop("checked",fa.include_deleted)}this.show_advanced();return this.search()}else{if(this.sparky_search_ui_enabled){this.last_fq_path=fa.last_fq_path!=null?fa.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";cl.inside_dir=this.scoped_search}this.set_basic_query(fa.query_unnormalized);this.show_basic();if(this.sparky_search_ui_enabled){if(this.search_page_enabled){return this.do_search(false,true)}else{return this.do_search(this.scoped_search,true)}}else{return this.search()}}},state_changed:function(){var e7,T;e7=this.get_state();T=this.last_state;if(this.sparky_search_ui_enabled){if(T===false){return !!e7.query}return(e7.is_advanced!==T.is_advanced)||(e7.query!==T.query)||(e7.last_fq_path!==T.last_fq_path)}else{if(T===false){return !!e7.query}return(e7.is_advanced!==T.is_advanced)||(e7.query!==T.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(T){if(T===this.get_basic_query()){return}this._get_browse_search_input().val(T);if(!this.sparky_search_ui_enabled){$("browse-search").show()}return $("advanced-search-link").__date(er("Advanced search"))},set_title:function(){var T,e7;T=this.get_state();e7=er("Search - Dropbox");if(T.query_unnormalized){e7=""+T.query_unnormalized+" - "+e7}return document.title=e7},_pending_search_q:"",search_with_delay:function(){var e7,e8,T;e8=this.search.bind(this);T=this.get_state();if(T.is_advanced){return}e7=T.query;if(e7.length===0&&cl.in_search_mode()){e8();return}if(e7.length<=this.SHORT_PREFIX_LEN){if(e7!==this._pending_search_q){this._pending_search_q=e7;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(e8,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return e8()}}},_set_scope_path_to_browse_location:function(){if(cl.inside_dir){return this.last_fq_path=cl.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(e8,T){var fa,fb,e9,e7;if(T==null){T=false}if(typeof cl.entered_search==="function"){cl.entered_search()}e7=!T&&!cl.in_search_mode();if(this.sparky_search_ui_enabled&&e7){this._set_scope_path_to_browse_location()}e9=this.get_state();fb=""===this.get_basic_query();if(!e9.is_advanced&&fb){if(cl.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=e9;this._clear_on_reload=true;if(!(cl.in_search_mode()&&!this.sparky_search_ui_enabled)){eM.deselect_all();cl.clear();a0.set_special_mode("search");if(!this.sparky_search_ui_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!T){fa=null;if(this.sparky_search_ui_enabled){if(this.search_page_enabled){eu.push_state("/search/"+cl.active_user.role,e9)}else{eu.push_state("/search",e9)}}else{eu.push_state("/search")}}}this._prune_cache();this.set_title();if(e9.is_advanced){this.ask_server_advanced()}else{if(this.sparky_search_ui_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();by("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",e8,0,this.MAX_RESULTS,false)}else{if(e9.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return ey("search")},build_search_url:function(T,e7){if(this.search_page_enabled){return eu.construct_url("/search/"+T.role,e7)}else{return eu.construct_url("/search",e7)}},search:function(T){if(T==null){T=false}if(T!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&T;if(this.sparky_search_ui_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var T;if(this.sparky_search_ui_enabled&&!this.end_of_results){T=this.search_pos;if(this.end_of_active_results){T=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,T,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var e8,e9,fb,fa,e7,T;e8=new Date();e9=[];for(fb in this._cache_ts){if(e8-this._cache_ts[fb]>this.CACHE_TIME){e9.push(fb)}}T=[];for(fa=0,e7=e9.length;fa<e7;fa++){fb=e9[fa];delete this._cache[fb];T.push(delete this._cache_ts[fb])}return T},update_empty:function(){var T;T=er("No results found");if(this.scoped_search&&this.sparky_search_ui_enabled){T=er("No results found in '%(path)s'").format({path:au.filename(this.last_fq_path)})}by("#noresults-header").text(T);by("#fulltext-search-all-link").hide();by("#noresults-directions").toggle(!(this.scoped_search&&this.sparky_search_ui_enabled));return by("#noresults-search-all-link").toggle(this.scoped_search&&this.sparky_search_ui_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(T){eM.deselect_all();cl.clear();cl.reset_state();cl.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=T;return by("#fulltext-search-all-link").hide()},exit_search:function(){var fa,e7,e9,T,e8;if(cl.in_search_mode()&&this.sparky_search_ui_enabled){if(this.search_page_enabled){fa=[cl.inside_deleted_dir,cl.inside_deleted_sandbox,cl.inside_deleted_shared_folder];if(!br.any(fa)){cl.deleted_shown=false}}else{cl.deleted_shown=false}}e8=$$("#advanced-search-box .sick-input input");for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];e7.setValue("");e7.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();if(this.search_page_enabled){return aY.set_path_url(null,this.last_fq_path,cl.deleted_shown)}else{cl.first_load=true;return cl.reload_fqpath(this.last_fq_path,true)}},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(e7,fc,e9,fa,fb,T,e8){if(e7==null){e7=null}if(fc==null){fc=null}if(e9==null){e9=null}if(fa==null){fa=null}if(fb==null){fb=null}if(T==null){T=null}if(e8==null){e8=null}if(e7==null){return}if(fc!=null){e7.request_id=fc}if(e9!=null){e7.latency=(new Date().getTime())-e9}if(fa!=null){e7.query_string=fa.query;if((T==null)||T===200){e7.displayed=this.last_state.query===fa.query?true:false}}if(fb!=null){e7.result_count=fb}if((T!=null)&&T!==200){e7.failure_type=T}if(e8!=null){e7.file_nsid=e8.ns_id;e7.file_sjid=e8.sjid}return e7},ask_server:function(e7,fc,e8,fd,fa){var fb,fg,fe,e9,ff,T;T=this.get_state();ff=null;if(this.sparky_search_ui_enabled){e9=new Date();if(fa){ff=et.DELETED}else{if(fc){ff=et.COMPLETION}else{ff=et.FULLTEXT}}}fb={firefly:this.firefly_enabled,infinite_scroll:e8>0?true:false,path_scoped:false,search_type:ff,query_string:T.query};a5.SearchClientActivityLogger.log("query_started",cl.active_user.id,fb);cC(!T.is_advanced,"expected to be in basic search mode");if(!e8){by("#web-search-results").html(er("Searching..."))}by("#browse").addClass("pending-search");fg={query:T.query};if(this.sparky_search_ui_enabled){if(e8){fg.start=e8}if(fd){fg.max_results=fd}if(fa){fg.deleted=fa}if(this.scoped_search){fg.fq_path=this.last_fq_path}if(!fc){this.last_fulltext_query=T.query}}if(fc){fg.filename_only=true}fe=false;return new Ajax.DBRequest(e7,{no_watch:true,evalJSON:false,parameters:fg,log_timing:true,onSuccess:(function(fh){return function(fj){var fk,fi,fm,fl;if(!cl.in_search_mode()){return}fm=fj.request.parameters.parent_request_id;fk=JSON.parse(fj.responseText);fl=fk.file_info.length;if(fh.sparky_search_ui_enabled){if(T.query===fh.last_fulltext_query&&e9>=fh.last_new_search_ts){fh.search_pos=fh.search_pos+fl;if(fh.end_of_active_results){fh.deleted_search_pos=fh.deleted_search_pos+fl}if(fl<fh.MAX_RESULTS){fh.end_of_results=true&&fh.end_of_active_results;fh.end_of_active_results=true;if(!fh.end_of_results){fe=true}else{by("#fulltext-search-loading").hide()}}fh.update_results(fk,fe,fm)}}else{fh._cache[T.query]=fk;fh._cache_ts[T.query]=new Date();if(!fh.last_state.is_advanced&&(fh.last_state.query===T.query)){fh.update_results(null,false,fm)}}if(fk.file_info.length>0){fi=fk.file_info[0]}else{fi=null}fb=fh.create_completion_log_dict(fb,fm,fj.request.start_time,T,fl,null,fi);return a5.SearchClientActivityLogger.log("query_completed",cl.active_user.id,fb)}})(this),onFailure:(function(fh){return function(fi){fb=fh.create_completion_log_dict(fb,fi.request.parameters.parent_request_id,fi.request.start_time,T,null,fi.status);return a5.SearchClientActivityLogger.log("query_failed",cl.active_user.id,fb)}})(this),cleanUp:(function(fh){return function(){if(fe){return fh.load_more_results()}else{return by("#browse").removeClass("pending-search")}}})(this),subject_user:cl.active_user})},ask_server_advanced:function(){var T,e7;e7=this.get_state();T={firefly:this.firefly_enabled,query_string:e7.query};a5.SearchClientActivityLogger.log("query_started",cl.active_user.id,T);cC(e7.is_advanced,"expected to be in advanced search mode");cC(!e7.query,"expected advanced search params only");delete e7.is_advanced;$("web-search-results").__date(er("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:e7,log_timing:true,onSuccess:(function(e8){return function(fa){var e9,fb;if(!cl.in_search_mode()){return}fb=fa.request.parameters.parent_request_id;e8.advanced_results=JSON.parse(fa.responseText);e8.update_results(null,false,fb);if(e8.advanced_results.file_info.length>0){e9=e8.advanced_results.file_info[0]}else{e9=null}T=e8.create_completion_log_dict(T,fa.request.parameters.parent_request_id,fa.request.start_time,e7,e8.advanced_results.file_info.length,null,e9);return a5.SearchClientActivityLogger.log("query_completed",cl.active_user.id,T)}})(this),onFailure:(function(e8){return function(e9){T=e8.create_completion_log_dict(T,e9.request.parameters.parent_request_id,e9.request.start_time,e7,null,e9.status);return a5.SearchClientActivityLogger.log("query_failed",cl.active_user.id,T)}})(this),cleanUp:function(e8){return $("browse").removeClassName("pending-search")},subject_user:cl.active_user})},attempt_cache_filter:function(){var T,e9,e7,fd,e8,fc,fb,fa;fc=this.get_state().query;fd=this._query_to_regex(fc);e7=function(fe){return fd.match(au.filename(fe.ns_path).toLowerCase())};if(fc.length<=1){return false}for(e8=fb=fa=fc.length-1;fa<=1?fb<=1:fb>=1;e8=fa<=1?++fb:--fb){e9=fc.substr(0,e8).strip();if(e9 in this._cache){if(this._cache[e9].file_info.length<this.MAX_RESULTS){T=Object.clone(this._cache[e9]);T.file_info=T.file_info.findAll(e7);this.update_results(T);return true}else{return false}}}return false},_query_to_regex:function(T){return new RegExp(RegExp.escape(T).split(new RegExp(" +")).join(".*"))},update_results:function(e7,T,fb){var fa,e9,e8;if(T==null){T=false}if(fb==null){fb=null}if(!this.sparky_search_ui_enabled){cl.reset_state();cl.reset_sort()}e8=this.get_state();if(!e7&&e8.is_advanced){e7=this.advanced_results}if(!e7){e9="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";cC(this.last_state&&!this.last_state.is_advanced,e9);cC(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(e7=this._cache[this.last_state.query]))}cl.update(e7,fb);cl.set_selection_from_fq_paths_or_index(b3);fa=e8.is_advanced?er("Basic search"):er("Advanced search");$("advanced-search-link").__date(fa);if(!T){if(this.sparky_search_ui_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(cl.files.length)}if(cl.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(e7){var T,e8;if(this.sparky_search_ui_enabled){if(e7===0){T=""}else{if(this.end_of_results){T=this.fulltext_search_enabled?a6("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",e7).format({num_results:e7}):a6("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",e7).format({num_results:e7})}else{T=this.fulltext_search_enabled?a6("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",e7).format({num_results:e7}):a6("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",e7).format({num_results:e7})}}}else{if(e7===0){T=er("No Results")}else{if(e7>=this.MAX_RESULTS){e7=e7+"+"}T=a6("%(num_results)s result","%(num_results)s results",e7).format({num_results:e7})}}e8=er("Search")+" - "+T;if(this.sparky_search_ui_enabled){cl.update_header_status(T);e8=er("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){e8=er("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:au.filename(this.last_fq_path+"'")})}}by("#web-search-results").text(e8);if(this.sparky_search_ui_enabled&&this.scoped_search){return by("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(er("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(T){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(er("Advanced search"));if($("browse-search")){$("browse-search").show();if(!T){return $("browse-search-input").focus()}}},toggle_advanced:function(){var T,e7;e7=$("advanced-search-link");e7.toggleClassName("selected");if(e7.hasClassName("selected")){by("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{T=by("#all_terms").val();if(T){this.set_basic_query(T);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(T,e9){var fa,e7,e8;e7=typeof this._get_browse_search_input().find("input").attr("value")==="string";e8=e7&&!this.is_loaded;if(this.sparky_search_ui_enabled&&e9){this.last_state=e9;this.last_state.is_advanced=false}if(!this.last_state){aY.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||e8){this.set_state(this.last_state)}if(!k.shown()){key.setScope(cl.KEY_SCOPE)}if(eM.get_selected_files().length){fa=eM.get_selected_files()[0].get_div();cl.scrollToWithPadding(fa,fa.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return by("#browse-search-input")}};var eg;eg=A.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var e8,T,e7;e7=this.advanced_dict;for(T in e7){e8=e7[T];key(e8.key,cl.KEY_SCOPE,e8.onPress)}this.customize_chart();if(dX.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(e9){return function(fa){if(fa.charCode===63&&!y.focus_in_input()){return e9.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var e9,e7,e8,T;e9=(dX.is_mac()?".key-windows":".key-macos");e8=0;e7=void 0;T=[];while(true){e7=$("keys-chart").down(e9,e8++);if(!e7){break}T.push(e7.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var T,e7;T=$("keys-chart");T.style.position="fixed";e7=$("browse-sort");if(b3.sparky_search_ui_enabled&&cl.in_search_mode()){e7=$("browse-header-wrapper")}else{if(e7.getStyle("display")==="none"){e7=$("browse-root-actions")}}by(T).clonePosition(by(e7),{setHeight:false});T.style.top=e7.cumulativeOffset()[1]+e7.getHeight()+"px";T.setOpacity(0.9);return T.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:er("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(e7,e8){var T;T=eM.get_selected_files();if(T.length){return T.first().edit()}}},"delete":{title:er("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(e9,fa){var T,e8,e7;Event.stop(e9);if(cl.inside_read_only_shared_folder){aa.warning(er("You don't have permission to delete files in this folder."))}e7=eM.get_selected_files();if(e7.length===1){T=e7.first();if(T.is_deleted){return du.show_purge(T.fq_path,T.dir)}else{return du.show_delete(cl.active_user,T.fq_path,T.dir)}}else{if(e7.length>1){e8=a0.profile_files(e7);if(e8.deleted===e7.length){return du.show_bulk_purge(e7)}else{if(e8.deleted===0){return du.show_bulk_delete(cl.active_user,e7)}}}}}},help:{title:er("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return eg.toggle_chart()}},close_help:{title:er("Hide keyboard shorcuts"),key:"escape",onPress:function(){return eg.hide_chart()}},up_dir:{title:er("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var T,e7;cl.keyboard_nav=true;if(!cl.reloading){if(cl.inside_dir){if(!cl.containing_ns_path()&&cl.containing_ns_id()!==Constants.root_ns){e7=Constants.root_ns;T=au.normalize(au.parent_dir(cl.containing_fq_path()))}else{e7=cl.containing_ns_id();T=au.normalize(au.parent_dir(cl.containing_ns_path()))}if(cl.containing_ns_path()!==T||cl.containing_ns_id()!==e7){cl.select_fq_paths=[cl.containing_fq_path()];return aY.set_path_url(e7,T)}else{return eM.flicker_selected()}}else{return eM.flicker_selected()}}}},open_file:{title:er("Open highlighted file"),key:"enter",onPress:function(){var T,e7;e7=eM.get_selected_files();if(e7.length===1){T=e7[0];cl.open_file(T,false,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN)}return false}},open_dir:{title:er("Open highlighted folder"),key:"right",onPress:function(){var T,e7;cl.keyboard_nav=true;e7=eM.get_selected_files();if(e7.length===1){T=e7[0];if(T.dir){cl.select_index=0;cl.open_folder(T)}else{eM.flicker_selected()}}return false}},undo:{title:er("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){S.perform_undo();return false}},search:{title:er("Search"),key:"/",onPress:function(){by(document).trigger("db:searchbar:focus");return false}}}};var ac;ac=A.BrowseSharedLink={store_shared_link_info:function(e8,T,e7){if(e8.charAt(0)==="/"){e8=e8.substring(1)}this._shared_link_fq_dir=e8;this._shared_link_file=e7;return this._shared_link_url=T},shared_link_handler:function(T,e7){if(ac._shared_link_url==="/s/"+T){aY.load_browse_view(void 0,encodeURIComponent(ac._shared_link_fq_dir));cl.open_preview(ac._shared_link_file)}else{if(ac._shared_link_url==="/sh/"+T||ac._shared_link_url==="/member_link/"+T){aY.load_browse_view(void 0,encodeURIComponent(ac._shared_link_fq_dir));if(ac._shared_link_file){cl.open_preview(ac._shared_link_file)}}else{location.reload()}}return ac.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return aY.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(cl.active_user.role===Constants.ROLE_WORK){by("#work-nav-item").addClass("selected");return by("#personal-nav-item").removeClass("selected")}else{by("#personal-nav-item").addClass("selected");return by("#work-nav-item").removeClass("selected")}}};var aY;aY=A.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(T){var e7;e7=eu.deconstruct_url().qargs;if(T in e7){return !!e7[T]}else{cC(T in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[T]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(T,e8){var e7;if(T!==cl.active_user.root_ns&&(!(T in cl.ns_id_to_mount_point))){T=cl.active_user.root_ns}if(T===cl.active_user.root_ns){return e8}else{e7=cl.ns_id_to_mount_point[T];return e7+e8}},_make_url:function(T,fb,fc){var fd,fa,e7,e9,e8;if(fc==null){fc={}}if(!T){T=cl.active_user.root_ns}cC(typeof T==="number","expected ns_id as a number");cC(typeof fb==="string","expected explicit ns_path string");fd=this.ns_to_fq_path(T,fb);e9=C({path:e4.get_browse_root(cl.active_user)+fd});e7=eu.deconstruct_url().qargs;for(fa in fc){e8=fc[fa];if(fa in this._DEFAULTS&&!!e8!==this._DEFAULTS[fa]){e7[fa]=e8}}for(fa in e7){if(!(fa in this._DEFAULTS)){delete e7[fa]}}return eu.construct_url(String(e9),e7)},set_path_url:function(T,fb,e9){var fa,e8,e7;if(!T){T=cl.active_user.root_ns}else{e8=parseInt(T,10);T=!isNaN(e8)?e8:Constants.root_ns}fb=au.normalize(fb);e7=e9!=null?this._make_url(T,fb,{d:e9?1:0}):this._make_url(T,fb);fa=eu.deconstruct_url(e7);return eu.push_state(fa.path,fa.qargs)},set_del_url:function(T){var e8,e9,e7;e7=eu.deconstruct_url();e8=e7.path;e9=e7.qargs;if(T){e9.d="1"}else{delete e9.d}return eu.push_state(e8,e9)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(T,e9,e7){var fa,fb,e8;if(e7==null){e7=false}key.setScope(cl.KEY_SCOPE);e9=au.normalize(e9);e8=false;if(!this._first_load){e8=(!cl.inside_dir)||(e9!==this._last_ns_dir)||(T!==this._last_ns_id)||(cl.in_search_mode()&&b3.sparky_search_ui_enabled)}fa=e7!==cl.deleted_shown;cl.deleted_shown=e7;if(this._first_load||e8||fa){cl.reload(T,e9,true)}b3.show_basic(true);this._first_load=false;this._last_ns_dir=e9;this._last_ns_id=T;if(eM.get_selected_files().length){fb=eM.get_selected_files()[0].get_div();if(fb){return cl.scrollToWithPadding(fb,fb.getHeight()*2)}}},history_change_handler:function(fa,fb){var e8,e9,T,e7;if(cl.show_inline_share){cl.reset_browse_exp()}T=fb.ns;e7=fb.d==="1";this.load_browse_view(T,fa,e7);if(fb.preview!=null){e9="/"+C.encode(fb.preview);if(!!fa){e9="/"+fa+e9}e8=cl.find_file(C.decode(e9));if(e8!=null){if(!(k.shown()&&k.file===e8)){return cl.open_preview(e8,Constants.OREF_CONSTANTS.BROWSE_UNKNOWN,true)}}else{a5.UserActivityLogger.log("web","browse_preview_does_not_exist");return eu.replace_state(e4.get_browse_root(cl.active_user))}}else{if(k.shown()){return k.hide()}}},parse_b2_hash:function(fa){var e8,e7,e9,T,fb;T=fa.split(":");if(T.length!==4){return false}e9=T[0];e8=T[2]==="1";e7=T[3];fb=!e7||dX.isNumber(e7);if(!fb){return false}e7=parseInt(e7,10)||Constants.root_ns;return{ns_id:e7,ns_path:e9,deleted:e8}}};var cK;cK=A.BrowseFile=Class.create({initialize:function(e8){var e7,e9,T,fa;e7=au.filename(e8.fq_path);this.icon=e8.icon;this.filename=e7;this.filename_highlights=(e9=e8.filename_highlights)!=null?e9:[];this.unresolved_comment_count=e8.unresolved_comment_count;this.unseen_comment_count=e8.unseen_comment_count;this.caption=bO.em_snippet(e7,this.get_caption_snippet_len());this.ns_id=e8.ns_id;this.ns_path=e8.ns_path;this.fq_path=e8.fq_path;this.mount_point=e8.mount_point;this.hash=e8.hash;this.href=e8.href;this.size=e8.size!=="None"?e8.size:"";this.bytes=e8.bytes;this.is_deleted=this.bytes===-1;this.ago=e8.ago;this.ts=e8.ts;this.dir=e8.is_dir?1:0;this.target_ns=e8.target_ns;this.sort_rank=e8.sort_rank;this.sort_key=e8.sort_key||[""];this.sjid=e8.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=e8.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=e8.large_thumbnail_url_tmpl;this.type=e8.type;this.preview_type=e8.preview_type;if(e8.last_modified_fname){this.last_modified_fname=bO.em_snippet(e8.last_modified_fname,cM)}this.htmlified_link=e8.htmlified_link;this.linkfile_link=e8.linkfile_link;this.doc_preview_status=e8.doc_preview_status;this.in_root_coll=e8.in_root_coll;this.compressible=e8.compressible;this.user_id=e8.user_id;this.sf_perm_role=e8.sf_perm_role;this.fulltext_search=e8.fulltext_search;this.read_only=e8.read_only?true:false;this.is_read_only_mount=e8.is_read_only_mount?true:false;this.request_id=(T=e8.request_id)!=null?T:null;return this.match_type=(fa=e8.match_type)!=null?fa:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cK._file_index)){cl.add_file(this);return cK._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===b1.SHARED_FOLDER},could_be_shared_folder:function(){var e8,e9,T,e7;e9=cl.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");e7=cl.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";T=this.target_ns;e8=this.ns_id!==Constants.root_ns;return this.type===b1.FOLDER&&!T&&!e9&&!e7&&!this.is_sandbox()&&(cl.golden_gate_enabled||!e8)},is_shared_single_file:function(){var T;T=this.ns_id!==Constants.root_ns;return this.type===b1.FILE&&T},could_be_shared_single_file:function(){var e7,e8,T;e8=cl.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");T=cl.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";e7=this.ns_id!==Constants.root_ns;return this.type===b1.FILE&&!(e7||e8||T)},is_sandbox:function(){return this.type===b1.SANDBOX},video_transcode_url:function(){return bn.video_transcode_url(this.fq_path,this.hash,cl.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(fa,fc,e8,e9,fb,fd){var fe,T,e7;T=this.fq_path;cl.pre_action_selection=[T];fe=cl.find_file(fa);if(fe){cl.remove_file(fe)}this.filename=au.filename(fa);this.caption=bO.em_snippet(this.filename,this.get_caption_snippet_len());this.fq_path=fa;this.ns_path=fc;this.htmlified_link=fd;this.hash=e8;this.sort_key=e9;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){e7=this.href.split("/");e7[e7.length-1]=dX.urlquote(this.filename)+("?w="+e8);this.href=e7.join("/");this.icon=fb}else{this.href="/home"+dX.urlquote(fa);if(this.target_ns){cl.ns_id_to_mount_point[this.target_ns]=fa}}if(cl.in_search_mode()&&b3.sparky_search_ui_enabled){this.filename_highlights=[]}cK._file_index[this.to_key()]=this;cl.update_file_pos(this);return by(document).trigger(aB.RENAME,{old_fq_path:T,file:this})},edit:function(){var e8,T,e9,e7,fa;this.editing=true;cl.selectable();fa=(function(fb){return function(fj){var fd,fc,fg,fl,fi,ff,fm,fk,fh,fe;fe=fj.responseText.evalJSON(true);cC(fe.new_browse_files.length===1,"No new file data returned.");fg=fe.new_browse_files.first();fl=fg.fq_path;fi=fg.hash;fh=dX.decode_sort_key(fg.sort_key);fm=fg.icon;fk=fg.ns_path;ff=fg.htmlified_link;fd=fe.changesets;fc=er("Rename complete.");S.notifyWithUndo(fc,fd,du.do_rollback);fb.rename(fl,fk,fi,fh,fm,ff);eM.set_selected_files([fb]);fb.get_div().smoothScrollIntoView();a0.load_visible_thumbs();return cl.fire_visible_change_callbacks()}})(this);T=C({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,cl.active_user).toString();e9=b3.sparky_search_ui_enabled&&cl.in_search_mode()?".filename-col":".filename-col a";e8=new Ajax.InPlaceEditor(this.get_div().down(e9),T,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(fb){return function(){return fb.editing=false}})(this),onFailure:function(){},savingText:er("Saving..."),ajaxOptions:{job:true,subject_user:cl.active_user,html_in_error_msg:true,progress_text:er("Renaming..."),method:"POST",onCreate:aa.clear,onSuccess:fa,onUninitialized:cl.unselectable},callback:(function(fb){return function(fc,fd){return{to_path:fd||"",folder:(fb.dir?"yes":"")}}})(this)});e8.enterEditMode();e7=this.get_div().down(".editor_field");if("selectionEnd" in e7&&this.filename.lastIndexOf(".")>-1){return e7.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var e7,T;if(this.dir){if(cl.inside_dir&&cl.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&cl.public_folder_enabled){e7="PUBLIC_FOLDER"}}if(e7==null){if(this.type===b1.FOLDER){e7="FOLDER"}else{if(this.type===b1.PACKAGE){e7="FOLDER"}else{if(this.type===b1.TEAM_SHARED_FOLDER){e7="TEAM_SHARED_FOLDER"}else{if(this.type===b1.SHARED_FOLDER){e7="SHARED_FOLDER"}else{if(this.type===b1.SANDBOX){e7="SANDBOX"}else{if(this.target_ns){e7="SHARED_FOLDER"}else{e7="FOLDER"}}}}}}}}if(e7==null){e7=cK.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}T=this.is_deleted?cK.CATEGORY_TO_DELETED_TRANSLATION[e7]:cK.CATEGORY_TO_TRANSLATION[e7];cC(T,"CATEGORY MISSING FOR "+e7);return T},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return au.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&cl.is_shmodelable_path(this.fq_path)},get_caption_snippet_len:function(){var T;T=cl.inside_dir?dd:ce;if(this.unresolved_comment_count>0){T-=aD}return T}});cK._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv dbxlink doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cK.EXTENSION_TO_CATEGORY={};cK.CATEGORY_TO_TRANSLATION={FILE:er("file"),FOLDER:er("folder"),SHARED_FOLDER:er("shared folder"),TEAM_SHARED_FOLDER:er("team folder"),PUBLIC_FOLDER:er("folder"),IMAGE:er("image"),VIDEO:er("video"),AUDIO:er("audio"),DOCUMENT:er("document"),COMPRESSED_FILE:er("archive"),CODE:er("code"),DISK_IMAGE:er("disk image"),EXECUTABLE:er("executable"),SHORTCUT:er("shortcut"),LINK:er("link"),FONT:er("font"),SANDBOX:er("app folder")};cK.CATEGORY_TO_DELETED_TRANSLATION={FILE:er("deleted file"),FOLDER:er("deleted folder"),SHARED_FOLDER:er("deleted shared folder"),TEAM_SHARED_FOLDER:er("deleted team folder"),PUBLIC_FOLDER:er("deleted folder"),IMAGE:er("deleted image"),VIDEO:er("deleted video"),AUDIO:er("deleted audio"),DOCUMENT:er("deleted document"),COMPRESSED_FILE:er("deleted archive"),CODE:er("deleted code"),DISK_IMAGE:er("deleted disk image"),EXECUTABLE:er("deleted executable"),SHORTCUT:er("deleted shortcut"),LINK:er("deleted link"),FONT:er("deleted font"),SANDBOX:er("deleted app folder")};(function(){var e8,fa,e7,e9,T;e9=cK._CATEGORIES;T=[];for(e8 in e9){e7=e9[e8];T.push((function(){var fe,fc,fb,fd;fb=e7.trim().split(" ");fd=[];for(fe=0,fc=fb.length;fe<fc;fe++){fa=fb[fe];fd.push(cK.EXTENSION_TO_CATEGORY[fa]=e8)}return fd})())}return T})();cK._file_index={};cK.from_key=function(T){return cK._file_index[T]};cK.from_elem=function(e7){var T;if(!e7){return}T=e7.readAttribute("data-identity");if(T){return cK.from_key(T)}else{return cK.from_elem(e7.up("[data-identity]"))}};var a,ex,ad,eW,bH,dy,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};a=INLINE_JS.BrowseActions=A.BrowseActions=Class.create({initialize:function(T){return this._set_files(T)},firefly_logging_helper:function(T){if(cl.in_search_mode()&&T){this._firefly_log_values.action_type=T;return a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var T;T=this.get_files();if(T.length<2){return this._get_actions_single(T.first())}else{return this._get_actions_multi(T)}},get_files:function(){return this._files},get_action_by_name:function(T){return this.evaluate_action(a.option_dict[T],T)},evaluate_action:function(e8,e7){var e9,fa,T;e9=(function(fb){return function(fd,fc){if((fc!=null)&&(fd==null)){return fc}if(by.isFunction(fd)){return fd.call(fb)}else{if(fd!=null){return fd}else{return fc}}}})(this);T={icon_href:e8.icon_href,target:e8.target,click_handler:e8.click_handler,type:e8.type,name:e7||e8.name,is_dropdown:!!e8.is_dropdown,icon:e9(e8.icon),text:e9(e8.text),detail_text:e9(e8.detail_text),href:e9(e8.href,""),kind:e9(e8.kind,"icon"),button_label:e9(e8.button_label,e8.text)};if(by.isFunction(e8.subactions)){T.subactions=e8.subactions.call(this)}else{if(by.isArray(e8.subactions)){T.subactions=(function(){var fe,fc,fd,fb;fd=e8.subactions;fb=[];for(fe=0,fc=fd.length;fe<fc;fe++){fa=fd[fe];fb.push(this.get_action_by_name(fa))}return fb}).call(this)}else{if(e8.subactions){cC(0,"subactions must be a function or an array of actions")}}}return T},_set_files:function(e7){var T;this._files=$A(e7);this._log_extras={};if(this.get_files().length>0){T=e7.first();this._log_extras={path:T.fq_path,ns_id:T.ns_id};return this._firefly_log_values={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:b3.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view"}}},_get_actions_single:function(fo){var fd,fh,fi,fl,e9,fg,fa,fq,fe,fk,fb,fc,fm,fn,fj,T,fp,ff,e8,e7;fh=[];if(!fo){return[]}fl=cl.public_folder_enabled&&fo.fq_path.toLowerCase().startsWith("/public/");fk=cl.public_folder_enabled&&fo.fq_path.toLowerCase()==="/public";fq=fo.target_ns;fi=fo.ns_id!==Constants.root_ns;fc=fo.type===b1.SHARED_FOLDER;fb=fo.type===b1.SANDBOX;fe=fo.type===b1.PACKAGE;fa=fo.in_root_coll;fg=fo.compressible;if(fo.is_deleted){fh=fh.concat(["restore"]);if(!((ff=cl.permanent_delete_is_disabled_by_ns_id)!=null?ff[fo.ns_id]:void 0)){fh.push("purge")}if(!fo.dir){fh.push("revisions")}}else{fj=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((e8=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e8.is_cached_and_locally_available(fo.ns_id,fo.ns_path):void 0);fm=fj?"open":"download";if(fo.dir){if(fb){fh.push("app_info")}else{if(cl.simple_sharing_enabled){fh.push("share_folder_and_token")}else{if(fc){fh.push("sharing_options")}else{if(!(fi||fq||fl||fk)){fh.push("share")}}}}if(fo.is_shmodelable()&&!cl.simple_sharing_enabled){fh.push("token_share")}fh.push(fm);if(!fk){fh=fh.concat(["delete","rename","move"]);if(!(fe||fq)){fh.push("copy")}}if(cl.can_use_photos_features){if(cl.can_use_photos_features){fh.push("album_from_folder")}}}else{if(fo.is_shmodelable()){fh.push("token_share")}if(fl||cl.public_app_token){fh.push("copy_url")}fh.push(fm);if(cl.can_show_preview(fo)&&cl.browser_supports_comments){fh.push("comment")}fh=fh.concat(["delete","rename","move","copy","revisions"]);if(fa&&cl.can_use_photos_features){if(cl.photos_experience==="carousel"){fh.push("view_in_carousel")}else{fh.push("view_in_photos")}}if(fg){fh.push("compress")}}if(!cl.simple_sharing_enabled){fn=false;e7=["sharing_options","share","token_share"];for(T=0,fp=e7.length;T<fp;T++){fd=e7[T];e9=fh.indexOf(fd);if(e9>-1){fh.splice(e9,1);fn=true}}if(fo.is_shared_folder()||fo.could_be_shared_folder()){fh.unshift("single_entry_share_dropdown_variant_menu")}else{fh.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return fh},_get_actions_multi:function(e8){var T,e7,e9;if(Constants.send_a_copy_enabled){T=["send_copy","download"]}else{T=["download"]}T=T.concat(["delete","move","copy","restore","purge"]);if(cl.photos_experience==="carousel"){T.push("view_in_carousel")}else{T.push("view_in_photos")}e7=a0.profile_files(e8);if(e7.deleted>0||e7.public_folder>0){T.removeItem("move");T.removeItem("copy");T.removeItem("delete")}if(e7.shared_folders>0){T.removeItem("copy")}if(e7.deleted>0){T.removeItem("send_copy");T.removeItem("delete");T.removeItem("download")}if(!cl.inside_dir){T.removeItem("download")}if(!(e7.deleted===e8.length&&(e7.shared_folders===0||((e7.shared_folders===(e9=e8.length)&&e9===1))))){T.removeItem("restore")}if(!(e7.deleted===e8.length&&e7.can_permanently_delete===e8.length)){T.removeItem("purge")}if(e7.in_root_coll!==e8.length||!cl.can_use_photos_features){T.removeItem("view_in_photos");T.removeItem("view_in_carousel")}return T},_show_appropriate_sharing_modals:function(e7,T){var e8;if(cl.simple_sharing_enabled&&e7.dir){if(dV.get_for_user(cl.active_user).verified_or_show()){ew.createAndShowInbandModalFromBrowseFile(cl.active_user,e7)}return}if(e7.is_shared_folder()){a5.ShmodelUILogger.log_with_target_file("sf_options",T,e7);return o.show_shared_folder_options_modal(e7.fq_path,cl.active_user)}else{if(e7.could_be_shared_folder()){a5.ShmodelUILogger.log_with_target_file("sf_invite",T,e7);return o.show_share_existing_modal(e7.fq_path,cl.active_user)}else{a5.ShmodelUILogger.log_with_target_file("token_share",T,e7);e8=e7.fq_path;cC(e8,"token_share: expected non-root fq_path");return dm.shmodel(e8,T+"_token_share")}}},get_disabled_action_names:function(){var T,e8,fa,e7,e9;T=false;e9=this.get_files();for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];T=true;if(!e8.read_only){T=false;break}}if(cl.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder","compress"]}else{return[]}},show_disabled_action_warning:function(T){if(cl.inside_read_only_shared_folder){if(T==="move"){return aa.warning(er("You don't have permission to move files in this folder."))}else{if(T==="rename"){return aa.warning(er("You don't have permission to rename files in this folder."))}else{if(T==="delete"){return aa.warning(er("You don't have permission to delete files in this folder."))}else{if(T==="restore"){return aa.warning(er("You don't have permission to restore files in this folder."))}else{if(T==="purge"){return aa.warning(er("You don't have permission to permanently delete files in this folder."))}else{if(T==="upload"){return aa.warning(er("You don't have permission to upload files into this folder."))}else{if(T==="new_folder"){return aa.warning(er("You don't have permission to create a new folder in this folder."))}else{if(T==="compress"){return aa.warning(er("You don't have permision to create a compressed file in this folder."))}else{return aa.warning(er("You only have permission to view this folder."))}}}}}}}}}else{return aa.warning(er("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(e7){var T,e8;eY.show(a0.append_ellipsis(er("Copy public link")),dj.fromElm("copy-public-url"),{wit_group:"copy_public_link"});eY.onHide=function(){$("flash_copy_container").remove();delete eY.onHide;return eY.hide()};T=p.clipboard_overlay(e7,by("#real_copy"),function(){aa.success(er("Link copied to clipboard!"));return eY.hide()});T.css({zIndex:1001});e8=$("modal-content").down("#public_url");cC(e8,"Text element not found for copy pulic link");e8.setValue(e7);return e8.select()},shortenPublicLink:function(){var T;dX.shorten_url($F("public_url"),a.updatePublicLink);T=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(T)},updatePublicLink:function(e7){var T;$("public_url").setValue(e7);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();T=p.clipboard_overlay(e7,by("#real_copy"),function(){aa.success(er("Link copied to clipboard!"));return eY.hide()});return T.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:er("New folder"),click_handler:function(T){return cl.new_folder()}},global_restore:{icon:"restore",text:function(){cC(cl.inside_deleted_dir,"Global restore from not a deleted dir");if(cl.inside_deleted_shared_folder){return a0.append_ellipsis(er("Rejoin shared folder"))}else{if(cl.inside_deleted_sandbox){return er("Restore app folder")}else{return er("Restore folder")}}},click_handler:function(){var e9,fa,e7,T,e8;e9=cl.containing_fq_path();e7=e9.toLowerCase();if(cl.inside_deleted_sandbox){cC(cl.old_path_to_ns_id[e7],"Deleted sandbox missing nsid");return bb.restore_sandbox(cl.active_user,e9,cl.old_path_to_ns_id[e7])}else{if(cl.inside_deleted_shared_folder){cC(cl.old_path_to_ns_id[e7],"Deleted shared folder missing nsid");return o.show_rejoin_modal(cl.active_user,e9,cl.old_path_to_ns_id[e7])}else{fa=C.parse(location.href).setFragment("").toString();T={prev:fa};T[Constants.UID_PARAM_NAME]=cl.active_user;e8=C({path:"/restore"+e9}).updateQuery(T);return window.location.href=String(e8)}}}},restore:{icon:"restore",text:function(){var e7,T;e7=this.get_files();T=a0.profile_files(e7);if(T.shared_folders===e7.length){return a0.append_ellipsis(a6("Rejoin shared folder","Rejoin shared folders",e7.length,{comment:"BUTTON"}))}else{return a0.append_ellipsis(er("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var e8,fb,e7,fc,fa,T,e9;fb=this.get_files();if(fb.length===0){}else{if(fb.length===1){e8=fb.first();if(!e8.is_deleted){return}fc=e8.fq_path;e7=fc.toLowerCase();if(e8.type===b1.SANDBOX){cC(cl.old_path_to_ns_id[e7],"Restore missing ns");bb.restore_sandbox(cl.active_user,fc,cl.old_path_to_ns_id[e7])}else{if(e8.type===b1.SHARED_FOLDER){cC(cl.old_path_to_ns_id[e7],"Rejoin missing ns");o.show_rejoin_modal(cl.active_user,fc,cl.old_path_to_ns_id[e7])}else{if(e8.dir){fa=C.parse(location.href).updateQuery({select:e8.filename});T={prev:String(fa)};T[Constants.UID_PARAM_NAME]=cl.active_user;e9=C({path:"/restore"+e8.fq_path}).updateQuery(T);window.location=String(e9)}else{du.show_undelete(e8)}}}}else{return du.show_bulk_restore(fb,cl.active_user)}}}},global_share:{icon:"rainbow_16",text:function(){if(cl.inside_shared_folder){return a0.append_ellipsis(er("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(cl.containing_fq_path()===""){return a0.append_ellipsis(er("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return a0.append_ellipsis(er("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(e8){var e7,T;e8.preventDefault();if(cl.containing_fq_path()===""){return o.start_wizard_for_user(cl.active_user)}else{if(cl.simple_sharing_enabled){if(dV.get_for_user(cl.active_user).verified_or_show()){e7=cl.inside_shared_folder&&!cl.containing_ns_path();T=e7?cl.containing_ns_id():void 0;return ew.createAndShowInbandModal(cl.active_user,cl.containing_fq_path(),true,T,e7,!cl.inside_shared_folder,cl.containing_sf_perm_role())}}else{if(cl.inside_shared_folder){return o.show_shared_folder_options_modal(cl.containing_mount_point(),cl.active_user)}else{return o.show_share_existing_modal(cl.containing_fq_path(),cl.active_user)}}}}},global_share_button:{icon:"rainbow_16",kind:"button",button_label:er("Share"),text:function(){return a0.append_ellipsis(er("Share a folder"))},click_handler:function(e7,T){e7.preventDefault();if(cl.containing_fq_path()===""){return o.start_wizard_for_user(cl.active_user)}else{if(cl.is_in_subfolder_of_shared_folder()){a5.ShmodelUILogger.log("via-single-entry-sharing-button");return dm.shmodel(cl.containing_fq_path(),T+"_global_share_button")}else{return o.show_shmodel_or_invite_modal(cl.containing_fq_path(),cl.inside_shared_folder,cl.active_user)}}}},sharing_options:{icon:"rainbow_16",text:a0.append_ellipsis(er("Shared folder options",{comment:"BUTTON"})),click_handler:function(e8,T){var e7;e7=this.get_files().first();a5.ShmodelUILogger.log_with_target_file("sf_options",T,e7);return o.show_shared_folder_options_modal(e7.fq_path,cl.active_user)}},share:{icon:"rainbow_16",text:a0.append_ellipsis(er("Invite to folder",{comment:"BUTTON"})),click_handler:function(e8,T){var e7;e7=this.get_files().first();a5.ShmodelUILogger.log_with_target_file("sf_invite",T,e7);return o.show_share_existing_modal(e7.fq_path,cl.active_user)}},share_folder_and_token:{icon:"rainbow_16",text:a0.append_ellipsis(er("Share",{comment:"BUTTON"})),click_handler:function(e8,T){var e7;e7=this.get_files().first();return this._show_appropriate_sharing_modals(e7,T)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=du.build_revisions_uri(this.get_files().first().fq_path,cl.active_user)},text:er("Previous versions",{comment:"BUTTON"})},token_share:{icon:"s_link",text:a0.append_ellipsis(er("Share link",{comment:"BUTTON"})),click_handler:function(e9,T){var e7,e8;e7=this.get_files().first();a5.ShmodelUILogger.log_with_target_file("token_share",T,e7);e8=e7.fq_path;cC(e8,"token_share: expected non-root fq_path");return dm.shmodel(e8,T+"_token_share")}},global_token_share:{icon:"s_link",text:a0.append_ellipsis(er("Share link",{comment:"BUTTON"})),click_handler:function(e7,T){a5.ShmodelUILogger.log("via-global-toolbar");return dm.shmodel(cl.containing_fq_path(),T+"_global_token_share")}},copy_url:{icon:"world_link",text:a0.append_ellipsis(er("Copy public link",{comment:"BUTTON"})),click_handler:function(e8){var e7,T;e7=this.get_files().first();if(cl.public_app_token){T="/spa/"+cl.public_app_token+e7.ns_path}else{T="/u/"+cl.active_user.id+e7.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new C({scheme:"https",authority:Constants.PUBSERVER,path:T})))}},download:{icon:"download",text:function(){return er("Download",{comment:"BUTTON"})},click_handler:function(){var e9,e8,T,fc,fe,fd,fa,e7,fb;T=this.get_files();if(T.length===1&&!T[0].dir){e8=T.first();fb=[Constants.protocol,Constants.BLOCK_CLUSTER,e8.fq_path,e8.hash],fd=fb[0],e9=fb[1],fe=fb[2],fc=fb[3];fa={w:fc,dl:1};e7=C({scheme:fd,authority:e9,path:"/get"+fe,query:fa});return window.location=String(e7.updateQuery(Constants.UID_PARAM_NAME,cl.active_user))}else{return du.do_bulk_download(T)}}},view:{href:function(){var fb,T,e9,e8,fa,e7;T=this.get_files().first();e7=[Constants.protocol,Constants.BLOCK_CLUSTER,dX.urlquote(T.fq_path),T.hash],fa=e7[0],fb=e7[1],e8=e7[2],e9=e7[3];return""+fa+"://"+fb+"/get"+e8+"?w="+e9},icon:"page_white_magnify",text:er("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return o.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:er("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(T){return cl.toggle_deleted()},icon:"trash-can",text:er("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(T){return cl.toggle_deleted()},icon:"trash-can-open",text:er("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:a0.append_ellipsis(er("Copy",{comment:"BUTTON"})),click_handler:function(e8){var T,e7;e7=this.get_files();if(e7.length===1){T=e7.first();return du.show_copy(T.fq_path,T.dir)}else{if(e7.length>1){return du.show_copy_bulk(e7)}}}},move:{icon:"move_16",text:a0.append_ellipsis(er("Move",{comment:"BUTTON"})),click_handler:function(e8){var T,e7;e7=this.get_files();if(e7.length===1){T=e7.first();return du.show_move(T.fq_path,T.dir)}else{if(e7.length>1){return du.show_move_bulk(e7)}}}},rename:{icon:"rename",text:er("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:a0.append_ellipsis(er("Delete",{comment:"BUTTON"})),click_handler:function(e8){var T,e7;e7=this.get_files();if(e7.length>1){return du.show_bulk_delete(cl.active_user,e7)}else{if(e7.length===1){T=e7.first();return du.show_delete(cl.active_user,T.fq_path,T.dir)}}}},global_purge:{icon:"cancel",text:a0.append_ellipsis(er("Permanently delete folder")),click_handler:function(){return du.show_purge(cl.containing_fq_path(),true)}},purge:{icon:"cancel",text:a0.append_ellipsis(er("Permanently delete",{comment:"BUTTON"})),click_handler:function(e8){var T,e7;e7=this.get_files();if(e7.length===1){T=e7.first();return du.show_purge(T.fq_path,T.dir)}else{return du.show_bulk_purge(e7)}}},upload:{icon:"upload_16",text:a0.append_ellipsis(er("Upload")),click_handler:function(T){return du.show_upload()}},app_info:{icon:"application_double",text:a0.append_ellipsis(er("Application info")),click_handler:function(T){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:er("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:er("More actions"),click_handler:function(){bH.show_secondary();return document.body.observe("click",bH.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return er("View in Photos")},click_handler:function(){var T;T=this.get_files();return du.do_bulk_photo_view(T,cl.photos_experience)}},compress:{icon:"s_photo",text:function(){return er("Compress (experimental)")},click_handler:function(){var T;T=this.get_files();return du.show_compress_bulk(cl.active_user,T)}},view_in_carousel:{icon:"s_carousel",text:function(){return er("View in Timeline")},click_handler:function(){var T;T=this.get_files();return du.do_bulk_photo_view(T,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return er("Create album")},click_handler:function(){var e7,T;e7=this.get_files();T=e7.first();return du.create_album_from_folder(T.fq_path,T.filename)}},open:{icon:"open",text:function(){return er("Open")},click_handler:function(){var T;T=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(T.ns_id,T.ns_path,T.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(e7){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return er("Comment",{comment:"BUTTON"})},click_handler:function(T){var e7;e7=this.get_files().first();return cl.open_preview(e7,T,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:a0.append_ellipsis(er("Share")),click_handler:function(e8,T){var e7;e7=this.get_files().first();a5.ShmodelUILogger.log_with_target_file("single_entry_share_click",T,e7);return dm.shmodel(e7.fq_path,T)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:a0.append_ellipsis(er("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(e8,T){var e7;e7=this.get_files().first();return a5.ShmodelUILogger.log_with_target_file("single_entry_share_hover",T,e7)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:a0.append_ellipsis(er("Invite people to collaborate")),click_handler:function(fb,T){var e8,e9,fa,e7;e8=this.get_files().first();if(e8.is_shared_folder()){if(dV.get_for_user(cl.active_user).verified_or_show()){a5.ShmodelUILogger.log_with_target_file("sf_options",T,e8);e9=new c7(cl.active_user,e8.fq_path);return e9.show()}}else{e7=cl.verify_email_after_share_experiment_variant;fa=e7&&e7==="VERIFY_LAST";if(fa){a5.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(e7){a5.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fa||dV.get_for_user(cl.active_user).verified_or_show()){a5.ShmodelUILogger.log_with_target_file("sf_invite",T,e8);e9=new ch(cl.active_user,{folder_name:e8.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+cl.active_user.id,must_check_verified:fa});return e9.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:a0.append_ellipsis(er("Send link")),click_handler:function(e8,T){var e7;e7=this.get_files().first();a5.ShmodelUILogger.log_with_target_file("token_share",T,e7);return dm.shmodel(e7.fq_path,T)}}}});ad=A.BrowseActionsContext=Class.create(a,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");by("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));by("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));by("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return by("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(e9,e7){var e8,T;e8=e7.readAttribute("data-value");if(bE.call(this.get_disabled_action_names(),e8)>=0){this.show_disabled_action_warning(e8);return false}this.firefly_logging_helper(e8);T=a.option_dict[e8];a5.BrowseActionsContextMenuLogger.log(this.get_files(),e8);if(!T.is_dropdown||e7.hasAttribute("submenu-index")){bh.hide()}e9.preventDefault();T.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_CONTEXTMENU,e9,"browse_actions_context");if(e8==="sharing_options"){a5.SharedFolderActivityLogger.log("web","browse_view_options",cl.active_user,this._log_extra,true)}if(e8==="share"){return a5.SharedFolderActivityLogger.log("web","browse_view_share_existing",cl.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return by("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(T){return by(T).removeClass("hover")},_enter:function(e9){var e8,T,e7;e8=by(e9.currentTarget).data("value");cC(e8);T=a.option_dict[e8];cC(T,"Action info is missing for "+e8);return(e7=T.hover_handler)!=null?e7.call(this,e9,"browse_actions_context"):void 0},_over:function(T){if(by(T.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return by(T.currentTarget).addClass("hover")}},_out:function(T){if(by(T.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(e7){return function(){return e7._reset_submenu(T.currentTarget)}})(this),300)}}});ex=A.BrowseActionsBasic=Class.create(a,{initialize:function($super){var T;T=eM.get_selected_files();$super(T);this._render();return this._listen()},_listen:function(){var T;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eM.UPDATED_EVT,this.bound_update);document.observe(bh.SHOW_EVT,this.bound_disable);document.observe(bh.HIDE_EVT,this.bound_enable);T=$("browse-root-actions");T.stopObserving("click");return T.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eM.UPDATED_EVT,this.bound_update);document.stopObserving(bh.SHOW_EVT,this.bound_disable);document.stopObserving(bh.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eM.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(e8){var e7,T;T="#browse-root-actions #"+e8+"_action_button";e7=by(T);e7.addClass("disabled");return e7.click((function(e9){return function(fa){e9.show_disabled_action_warning(e8);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fx,fq,fs,fi,fu,fy,fA,fp,fr,fl,T,fe,ff,fh,fg,ft,fd,fB,fn,fb,fk,fj,fm,fo,fc,fa,e8,e7,fv,fz,fw,e9;fe=this.get_files();fs=this.get_action_names();if(!cl.simple_sharing_enabled){fj=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(fa=0,fv=fj.length;fa<fv;fa++){fq=fj[fa];fg=fs.indexOf(fq);if(fg>-1){fs.splice(fg,1);break}}}fx=13.5;fr="";ff="";if(fe.length===1){fr=bO.em_snippet(fe[0].filename,fx);if(!fe[0].dir&&fe[0].bytes>=0){ff=fe[0].size}}else{if(1<fe.length){fb=a0.profile_files(fe);ft=[];if(fb.files){fd=a6("%d file","%d files",fb.files).format(fb.files);ft.push(fd)}if(fb.folders){fd=a6("%d folder","%d folders",fb.folders).format(fb.folders);ft.push(fd)}fr=dX.nice_list(ft)}}fy=$("browse-root-actions");fu=fy.getLayout().get("width");fh=fy.getStyle("font-size");cC(fh.endsWith("px"),"Invalid font size "+fh);fh=parseInt(fh,10);fl=new bO(fr).length*fh;fm=new bO(ff).length*fh;fu-=fl+fm;fo=[];fk=[];fu-=30;for(e8=0,fz=fs.length;e8<fz;e8++){fB=fs[e8];fq=this.get_action_by_name(fB);fc=new bO(fq.text).length*fh;fA=fc+16+8+10+9;if(fu>fA){fo.push(fB)}else{if(fk.length===0){fn=fo.pop();fk.push(fn)}fk.push(fB)}fu-=fA}if(fk.length){fo.push("more_actions")}fi=(function(){var fE,fC,fD;fD=[];for(fE=0,fC=fo.length;fE<fC;fE++){fB=fo[fE];fD.push(this.get_action_by_name(fB))}return fD}).call(this);if(fk.length){fi[fi.length-1].subactions=(function(){var fE,fC,fD;fD=[];for(fE=0,fC=fk.length;fE<fC;fE++){fB=fk[fE];fD.push(this.get_action_by_name(fB))}return fD}).call(this)}fp=e2.tmpl("actions_bar_tmpl",{context:this,description:fr,filesize:ff,has_actions:!!fs.length,actions:fi,_:er,Sprite:cp});$("browse-root-actions").__date(fp);T=this.get_disabled_action_names();e9=[];for(e7=0,fw=T.length;e7<fw;e7++){fq=T[e7];e9.push(this._disable_action(fq))}return e9},_click:function(e9,e7){var e8,T;e8=e7.readAttribute("data-value");cC(e8);this.firefly_logging_helper(e8);T=a.option_dict[e8];cC(T,"Action info is missing for "+e8);e9.preventDefault();T.click_handler.call(this,Constants.OREF_CONSTANTS.BROWSE_COMMENT_BUTTON,e9,"browse_actions_basic");if(e8==="sharing_options"){a5.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",cl.active_user,this._log_extras,true)}if(e8==="share"){return a5.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",cl.active_user,this._log_extras,true)}}});Object.extend(ex,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel","compress"]});eW=A.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var T;if(!cl.inside_dir){return[]}T=[];if(!cl.inside_deleted_dir){T=T.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){T.push("global_share")}if(this._should_show_share_link()){T.push("global_token_share")}if(this._should_show_single_entry_share()){T.push("global_share_button")}if(!Constants.can_see_trash){T.push((cl.deleted_shown?"hide_del":"show_del"))}}else{T=T.concat(["global_restore"])}return T},_should_show_shared_folder_options:function(){return !cl.is_in_subfolder_of_shared_folder()&&!cl.inside_sandbox&&!this._should_show_single_entry_share()},_should_show_share_link:function(){return cl.is_shmodelable_path(cl.containing_fq_path())&&!this._should_show_single_entry_share()},_should_show_single_entry_share:function(){return cl.single_share_entry_point&&cl.containing_fq_path()!==""}});bH=A.GlobalActionsBasic=Class.create(eW,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bh.SHOW_EVT,this._disable.bind(this));return document.observe(bh.HIDE_EVT,this._enable.bind(this))},_render:function(){var e9,fb,fd,fg,fi,T,e7,fc,ff,fe,fa,fh,e8;fb=this.get_action_names();fe=fb.intersect(bH.STANDARD_ACTIONS);fc=fb.without.apply(fb,bH.STANDARD_ACTIONS);if(fc.length===1){fe=fb;fc=[]}if(fc.length){fe.push("more_global_actions")}ff=(function(){var fl,fk,fj;fj=[];for(fl=0,fk=fe.length;fl<fk;fl++){T=fe[fl];fj.push(this.get_action_by_name(T))}return fj}).call(this);fd=(function(){var fl,fk,fj;fj=[];for(fl=0,fk=ff.length;fl<fk;fl++){e9=ff[fl];if(e9.kind==="button"){fj.push(e9)}}return fj})();e7=(function(){var fl,fk,fj;fj=[];for(fl=0,fk=ff.length;fl<fk;fl++){e9=ff[fl];if(e9.kind!=="button"){fj.push(e9)}}return fj})();fg=e2.tmpl("global_actions_tmpl",{context:this,standard_actions:fd.concat(e7),secondary_actions:(function(){var fl,fk,fj;fj=[];for(fl=0,fk=fc.length;fl<fk;fl++){T=fc[fl];fj.push(this.get_action_by_name(T))}return fj}).call(this),Sprite:cp});$("global-actions").__date(fg);by(document).trigger("db:browse:ga_rendered");fi=this.get_disabled_action_names();e8=[];for(fa=0,fh=fi.length;fa<fh;fa++){e9=fi[fa];e8.push(this._disable_action(e9))}return e8},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(e8){var e7,T;T="#global-actions #"+e8+"_button";e7=by(T);e7.addClass("disabled");return e7.click((function(e9){return function(fa){e9.show_disabled_action_warning(e8);return false}})(this))},_enable:function(){var e9,fa,e8,e7,T;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");fa=this.get_disabled_action_names();T=[];for(e8=0,e7=fa.length;e8<e7;e8++){e9=fa[e8];T.push(this._disable_action(e9))}return T},_click:function(e9,e7){var e8,T;e8=e7.readAttribute("data-value");cC(e8);T=a.option_dict[e8];cC(T,"Action info is missing for "+e8);bH.hide_secondary();eM.deselect_all();e9.preventDefault();T.click_handler.call(this,e9,"global_actions_basic");if(e8==="global_share"){if(this._log_extras.path===""){return a5.SharedFolderActivityLogger.log("web","browse_view_share_button",cl.active_user,this._log_extras,true)}else{return a5.SharedFolderActivityLogger.log("web","folder_view_share_button",cl.active_user,this._log_extras,true)}}}});Object.extend(bH,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge","global_share_button"],show_secondary:function(){var T,e7;e7=$("secondary-actions");T=$("more_global_actions_button");e7.show();return T.addClassName("down")},hide_secondary:function(){var T,e7;e7=$("secondary-actions");if(!e7){return}T=$("more_global_actions_button");e7.hide();return T.removeClassName("down")}});dy=A.GlobalActionsContext=Class.create(eW,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(e9,e7){var e8,T;e8=e7.readAttribute("data-value");if(bE.call(this.get_disabled_action_names(),e8)>=0){this.show_disabled_action_warning(e8);return false}this.firefly_logging_helper(e8);T=a.option_dict[e8];eM.deselect_all();if(!T.is_dropdown){bh.hide()}e9.preventDefault();T.click_handler.call(this,e9,"global_actions_context");if(e8==="global_share"){if(this._log_extras.path===""){return a5.SharedFolderActivityLogger.log("web","browse_view_right_click_share",cl.active_user,this._log_extras,true)}else{if(cl.inside_shared_folder){return a5.SharedFolderActivityLogger.log("web","folder_view_right_click_options",cl.active_user,this._log_extras,true)}else{return a5.SharedFolderActivityLogger.log("web","folder_view_right_click_share",cl.active_user,this._log_extras,true)}}}}});var v;v=A.BrowseClipboard=(function(){var fe,fb,e8,fc,fa,fg,fi,fd,e7,T,ff,e9,fh;fe=0;fb=1;fa=[];e8=null;fh=function(){var fl,fn,fk,fo,fm,fj;if(y.focus_in_input()){return}fk=eM.get_selected_files();if(fk&&fk.length){for(fm=0,fj=fk.length;fm<fj;fm++){fn=fk[fm];if(fn.bytes<0){aa.error(er("Deleted files cannot be added to the clipboard"));return false}else{if(fn.target_ns){fo=er("'%(filename)s' cannot be added to the clipboard");fo=fo.format({filename:fn.filename});aa.error(fo);return false}}}fa=fk;fl=fk.length;fo=a6("Added %d item to clipboard","Added %d items to clipboard",fl).format(fl);aa.success(fo);return true}};fg=function(){if(fh()){e8=fe;return false}};fi=function(){if(fh()){e8=fb;return false}};fd=function(fj){var fk;cC(typeof fj!=="undefined","BrowseClipboard _paste got an undefined path");if(fa.length){fk=e8===fe?du.do_bulk_copy:du.do_bulk_move;fk(fa,fj);return true}};e9=function(fj){var fk;if(y.focus_in_input()||cl.in_search_mode()||cl.inside_deleted_dir){return}fk=fd(cl.containing_fq_path());if(fk){return false}};fc=function(){return fa=[]};T=function(fq){var fp,fl,fn,fo,fm,fk,fj;fn=fq.memo.files;for(fo=0,fk=fn.length;fo<fk;fo++){fl=fn[fo];for(fm=0,fj=fa.length;fm<fj;fm++){fp=fa[fm];if(fp.fq_path===fl.fq_path||fp.fq_path.startsWith(fl.fq_path+"/")){fc();return}}}};e7=function(fj){cC((fj.memo.file!=null)&&(fj.memo.files==null));fj.memo.files=[fj.memo.file];return T(fj)};ff=function(){var fn,fj,fm,fk,fl;by(document).on(aB.RENAME,(function(fo){return function(fp,fq){fp.memo=fq;return e7(fp)}})(this));fl=[aB.DELETE,aB.MOVE];for(fm=0,fk=fl.length;fm<fk;fm++){fn=fl[fm];document.observe(fn,T)}fj=key.main_modifier();key(""+fj+"+c",cl.KEY_SCOPE,fg);key(""+fj+"+x",cl.KEY_SCOPE,fi);return key(""+fj+"+v",cl.KEY_SCOPE,e9)};return{init:function(){return ff()}}})();var eM,aT,ay;eM=A.BrowseSelection=(function(){var fa,fc,fs,fh,fv,T,fo,fg,fD,fl,fp,fd,fi,fq,fA,fz,fe,fj,e9,fr,fm,ft,fB,fb,fw,fu,fC,fy,fx,fn,fF,e8,fk,ff,e7,fE;fx=[];fh=null;fl=null;fg=null;T=[];ff=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eM.get_selected_files().invoke("get_div").findAll(function(fG){return fG}).invoke("addClassName","file-select");if(eM.get_selected_files().length===1){return eM.get_selected_files().invoke("get_div").findAll(function(fG){return fG}).invoke("addClassName","file-select-one")}};e7=function(){if(fg){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(cl.in_search_mode()&&b3.sparky_search_ui_enabled){return}return eM.get_selected_files().filter(function(fG){return !fG.editing}).invoke("get_div").findAll(function(fG){return fG}).invoke("writeAttribute","draggable","true")};fE=function(fG){fG.apply(null,$A(arguments).slice(1));return document.fire(eM.UPDATED_EVT)};fn=function(fI,fH){var fJ,fG;fG=fx.length;fx=(fI instanceof cK?[fI]:$A(fI));if(fx.length!==fG){ey("Selected",fx.length,"files")}fJ=fH||fx.last();cC(!fJ||fJ instanceof cK,"Invalid anchor type"+fJ);return fh=fJ};fn=fn.wrap(fE);fa=function(fH,fG){if(fH){fx.push(fH)}return fh=fG||fH};fa=fa.wrap(fE);fw=function(fG){var fH;fH=fx.indexOf(fG);if(fH===-1){return}return fx.splice(fH,1)};fw=fw.wrap(fE);fu=function(){return fx=[]};fu=fu.wrap(fE);fF=function(fG){T=fG;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fG.invoke("get_div").findAll(function(fH){return fH}).invoke("addClassName","context-select")};fj=function(fP){var fM,fK,fJ,fL,fS,fI,fR,fT,fG,fO,fQ,fN,fH;fN=$(fP.target);fT=fN.match("li.browse-file")?fN:fN.up("li.browse-file");fM=fN.match("a")?fN:fN.up("a");fJ=cK.from_elem(fT);if(fP.isRightClick()||!fT||fM||fT.hasClassName("unselectable")){return}cl.keyboard_nav=false;if(T.length){return}fI=dX.is_mac();if((fI&&fP.metaKey)||(!fI&&fP.ctrlKey)){if(fx.indexOf(fJ)===-1){return fa(fJ)}else{return fw(fJ)}}else{if(fP.shiftKey){fK=cl.files.indexOf(fh);fH=cl.files.indexOf(fJ);fR=cl.files.indexOf(fx.last());fO=fx.slice(0);fS=fR<fK?-1:1;fL=fK;while(fL!==fR){fL+=fS;fQ=fO.indexOf(cl.files[fL]);if(fQ!==-1){fO.splice(fQ,1)}}fS=fH<fK?-1:1;fL=fK;while(fL!==fH){fL+=fS;fG=fO.indexOf(cl.files[fL]);if(fG!==-1){fO.splice(fG,1)}fO.push(cl.files[fL])}return fn(fO,fh)}else{return fn(fJ)}}};e9=function(fL){var fP,fI,fO,fM,fH,fG,fK,fJ,fN;if(fL.isRightClick()||T.length||dX.in_scrollbar(fL.pointerX())){return}fM=$(fL.target);if(Element.match(fM,"object")){fM=fM.parentNode}fK=["browse-box","context-menu-container","modal","modal-overlay"];fH=false;for(fJ=0,fN=fK.length;fJ<fN;fJ++){fG=fK[fJ];if(fM.descendantOf(fG)||fM.match("#"+fG)){fH=true;break}}if(!fH){fn();return}fO=fM.match("li.browse-file")?fM:fM.up("li.browse-file");fI=cK.from_elem(fO);fP=fM.match("[draggable]")||fM.up("[draggable]");if(fI&&!fP){fl=fh;if(!fL.shiftKey){if(fI){fl=fI}else{if(fM.match("#browse-files")){fl=cl.files.last()}}}fg=[];if(fL.metaKey||fL.ctrlKey){return fg=eM.get_selected_files()}}};e8=function(fI){var fH,fG;fH=cK.from_elem(fz(fI));fI.preventDefault();if(!fH){return}fG="browse_file_row";a5.ShmodelUILogger.log_with_target_file("token_share",fG,fH);return dm.shmodel(fH.fq_path,fG)};fz=function(fH){var fG;fG=$(fH.target);if(fG.match("li.browse-file")){return fG}else{return fG.up("li.browse-file")}};fA=(function(fG){return function(fO){var fI,fH,fJ,fR,fQ,fN,fP,fL,fM,fK;fP=cl.sharing_single_file_collaboration&&cl.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";fR=fz(fO);fI=cK.from_elem(fR);fO.preventDefault();if(!fI){return}fQ="browse_file_row";fM=a5.ShmodelUILogger.get_target_item(fI);a5.ShmodelUILogger.log("single_entry_share",fQ,fM);fJ=cl.simple_sharing_enabled;fN=by(fR).find(".inline-share-button")[0];if(cl.show_shared_with&&!cl.show_inline_share&&!cl.in_search_mode()){fN=by(fR).find(".sharing .inline-share-button")[0]}fL=fI.dir&&(fI.is_shared_folder()||fI.could_be_shared_folder());if(fL){if(fJ){if(dV.get_for_user(cl.active_user).verified_or_show()){return ew.createAndShowInbandModalFromBrowseFile(cl.active_user,fI)}}else{return ay.open(fI.fq_path,fI.is_shared_folder(),fN,cl.active_user,fM)}}else{if(cl.simple_sharing_to_file_enabled&&((fK=__CONDITIONAL_JS__.OpenWith)!=null?fK.file_supported(fI):void 0)){if(dV.get_for_user(cl.active_user).verified_or_show()){return ew.createAndShowInbandModalFromBrowseFile(cl.active_user,fI)}}else{if(fP&&(fI.is_shared_single_file()||fI.could_be_shared_single_file())&&!fJ){return ay.open(fI.fq_path,fI.is_shared_single_file(),fN,cl.active_user,fM,fH=true,fI.mount_point)}else{eM.firefly_logging_helper(fI,"single_entry_share_button_file_link");return dm.shmodel(fI.fq_path,fQ)}}}}})(this);fb=(function(fG){return function(fJ){var fI,fH;fH=fz(fJ);fI=cK.from_elem(fH);return aT.recipients_click(fI,cl.active_user)}})(this);fe=(function(fG){return function(fJ){var fI,fH;fH=fz(fJ);fI=cK.from_elem(fH);return aT.link_click(fI,cl.active_user)}})(this);fv=function(fJ){var fH,fG,fI;fI=$(fJ.target);fG=fI.match("li.browse-file")?fI:fI.up("li.browse-file");fH=cK.from_elem(fG);if(fH){return fj(fJ)}};fq=null;fp=function(){var fG;clearInterval(fq);fG=function(){cl.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fq=setTimeout(fG,100)};fo=function(){if(!cl.keyboard_nav){cl.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fr=function(fM){var fJ,fI,fH,fL,fO,fG,fK,fN;fp();if(!eM.is_selecting()){return}fJ=cl.files.indexOf(fl);fG=cl.files.indexOf(cK.from_elem(fM.target));cC(fJ<cl.files.length&&fJ>=0,"anchor_index: "+fJ+" "+fl);cC(fG<cl.files.length&&fG>=0,"target_index: "+fG);fI=cl.files.slice(Math.min(fJ,fG),Math.max(fJ,fG)+1);fH=fg.slice(0);for(fK=0,fN=fI.length;fK<fN;fK++){fO=fI[fK];fL=fH.indexOf(fO);if(fL===-1){fH.push(fO)}else{fH.splice(fL,1)}}return fn(fH)};fD=function(fG){fl=null;return fg=null};fB=function(fI){var fG,fH;if(typeof L!=="undefined"&&L!==null){L.reset()}fo();if(fI){Event.extend(fI).preventDefault()}fH=fx.length?fx.last()===cl.files.first()?cl.files.first():(fG=cl.files.indexOf(fx.last())-1,cl.files[fG]):cl.files.last();fn(fH);if(fH){return cl.scrollTo(fH.get_div())}};fm=function(fI){var fG,fH;if(typeof L!=="undefined"&&L!==null){L.reset()}fo();if(fI){Event.extend(fI).preventDefault()}fH=fx.length?fx.last()===cl.files.last()?cl.files.last():(fG=cl.files.indexOf(fx.last())+1,cl.files[fG]):cl.files.first();fn(fH);if(fH){return cl.scrollTo(fH.get_div())}};fs=function(fO){var fG,fH,fM,fN,fJ,fK,fL,fI;if(typeof L!=="undefined"&&L!==null){L.reset()}fo();if(fO){Event.extend(fO).preventDefault()}if(fx.length>0){fN=cl.files.indexOf(fx.last());fG=cl.files.indexOf(fh);if(fh===fx.last()||fG>fN){if(fN>0){fI=[];for(fM=fK=fL=fN-1;fL<=0?fK<=0:fK>=0;fM=fL<=0?++fK:--fK){fH=cl.files[fM];fJ=fx.indexOf(fH);fa(fH,fh);if(fJ!==-1){fI.push(fx.splice(fJ,1))}else{cl.scrollTo(fH.get_div());break}}return fI}}else{fw(fx.last());return cl.scrollTo(fx.last().get_div())}}else{return fB()}};fc=function(fP){var fG,fH,fN,fO,fK,fL,fM,fJ,fI;if(typeof L!=="undefined"&&L!==null){L.reset()}fo();if(fP){Event.extend(fP).preventDefault()}if(fx.length>0){fO=cl.files.indexOf(fx.last());fG=cl.files.indexOf(fh);if(fh===fx.last()||fG<fO){fI=[];for(fN=fL=fM=fO+1,fJ=cl.files.length;fM<=fJ?fL<fJ:fL>fJ;fN=fM<=fJ?++fL:--fL){fH=cl.files[fN];fK=fx.indexOf(fH);fa(fH,fh);if(fK!==-1){fI.push(fx.splice(fK,1))}else{cl.scrollTo(fH.get_div());break}}return fI}else{fw(fx.last());return cl.scrollTo(fx.last().get_div())}}else{return fm()}};fC=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}fn(cl.files);return false};fy=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}return fn(null,null,null)};fi=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(ff,100)};ft=function(fG){return fG.memo.files.each(function(fH){var fI;fI=fx.indexOf(fH[0]);if(fI!==-1){fx.splice(fI,1);return fa(fH[1])}})};fd=function(fG,fH){var fI;if(cl.in_search_mode()&&fG&&fH){fI={file_nsid:fG.ns_id,file_sjid:fG.file_sjid,firefly:b3.firefly_enabled,match_type:fG.match_type,position:fG.sort_rank,request_id:fG.request_id,viewport:"full-view",action_type:fH};return a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,fI)}};fk=function(fH,fG,fI,fK,fO){var fN,fM,fL,fJ;fM="file_row_sharing_menu";if(fG){if(dV.get_for_user(fH).verified_or_show()){a5.ShmodelUILogger.log("sf_options",fM,fI);fd("single_entry_share_button_folder_options");fN=new c7(fH,fK);if(typeof fO==="function"){fO()}return fN.show()}}else{fJ=cl.verify_email_after_share_experiment_variant;fL=fJ&&fJ==="VERIFY_LAST";if(fL){a5.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fJ){a5.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fL||dV.get_for_user(fH).verified_or_show()){a5.ShmodelUILogger.log("sf_invite",fM,fI);fd("single_entry_share_button_folder_invite");fN=new ch(fH,{folder_name:fK,element_id:"invite-to-new-sf-wizard-modal-"+fH.id,must_check_verified:fL});if(typeof fO==="function"){fO()}return fN.show()}}};document.observe(bx.REMOVE,function(fG){return fG.memo.files.each(fw)});document.observe(bx.MOVE,ft);return{UPDATED_EVT:"db:select:updated",init:function(){var fG;document.observe("click",fv);document.observe("mousedown",e9);document.observe("mouseup",fD);document.observe("dragend",fD);document.observe("mouseup",e7);$("browse-files").on("mouseover","li.browse-file",fr);$("browse-files").on("click",".shmodel-file",e8);$("browse-files").on("click",".inline-share-button",fA);$("browse-files").on("click",".more-link",fA);document.observe(eM.UPDATED_EVT,ff);document.observe(eM.UPDATED_EVT,e7);document.observe(cl.RENDER_EVT,ff);document.observe(cl.RENDER_EVT,e7);document.observe(cl.UPDATE_EVT,fn.bind(null,null,null));fG=key.main_modifier();key("up",cl.KEY_SCOPE,fB);key("down",cl.KEY_SCOPE,fm);key(fG+"+a",cl.KEY_SCOPE,fC);key("escape",cl.KEY_SCOPE,fy);key("shift+up",cl.KEY_SCOPE,fs);return key("shift+down",cl.KEY_SCOPE,fc)},set_selected_files:function(fG){return fn(fG)},get_selected_files:function(){return fx.slice(0)},get_selected_fq_paths:function(){return fx.map(function(fG){return fG.fq_path})},has_selected_files:function(){return fx.length},is_selected:function(fG){return fx.indexOf(fG)!==-1},is_selecting:function(){return !!fl},deselect_all:fu,set_context_selected:function(fG){return fF(fG)},flicker_selected:fi,firefly_logging_helper:function(fG,fH){return fd(fG,fH)},show_share_modal_if_email_verified:fk,recipients_click:function(fG){return fb(fG)},link_click:function(fG){return fe(fG)}}})();ay=A.SharingGrowthExperimentsDropdown={open:function(fb,e8,e9,e7,fc,fd,fa){var T;this.fq_path=fb;this.existing_sf=e8;this.button=e9;this.user=e7;this.target_item=fc;this.is_file=fd;this.mount_point=fa;this.$menu=by("#sharing-growth-experiments-dropdown-menu");T=this.$button&&this.$button.length;if(T){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var T;this.$menu.show();this.$button=by(this.button);this.$button.addClass("pressed");if(cl.show_inline_share){this.$button.parent(".sharing-actions").addClass("pressed")}T={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};y.clone_position(this.$menu,this.$button,T);by("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(T){return T.stopPropagation()});by(document).on("mousedown",by.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",by.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",by.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");by(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",by.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",by.proxy(this._share_link_click,this))},_add_share_file_logging:function(e8,e9){var e7,T;T={path:this.fq_path};e7=this.existing_sf?e8:e9;return a5.SharedFolderActivityLogger.log("web",e7,this.user,T)},_sf_click:function(e7){var T;if(this.is_file){if(dV.get_for_user(this.user).verified_or_show()){this._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(this.existing_sf){T=new dY(this.user,{folder_name:au.filename(this.mount_point),folder_path:this.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{T=new ch(this.user,{folder_name:this.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+this.user.id})}this._hide();return T.show()}}else{return eM.show_share_modal_if_email_verified(this.user,this.existing_sf,this.target_item,this.fq_path,this._hide.bind(this))}},_share_link_click:function(e7){var T;T="file_row_sharing_menu";a5.ShmodelUILogger.log("token_share",T,this.target_item);this._firefly_logging_helper("single_entry_share_button_folder_link");dm.shmodel(this.fq_path,T);if(this.is_file){this._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}return this._hide()},_firefly_logging_helper:function(T){return eM.firefly_logging_helper(cl.find_file(this.fq_path),T)},_clicked:function(T,e7){return T.is(e7.target)||T.has(e7.target).length},_click_outside_menu_callback:function(T){if(!(this._clicked(this.$menu,T)||this._clicked(this.$button,T))){return this._hide()}},_hide:function(T){this._unlisten();by("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");if(cl.show_inline_share){this.$button.parent(".sharing-actions").removeClass("pressed")}return this.$button=null}};aT=A.SharingGrowthExperimentsAutocomplete={init:function(){return this.autocomplete=new Autocompleter.ContactsTokenizer(cl.active_user,"growth-browse-inline-new-collab-input","growth-browse-inline-new-whobulk","growth-browse-inline-hidden-input",{tokens:[",",";"],include_fb:false,include_team:false,hide_import_contacts:false,suggestions_disabled:true})},recipients_click:function(e7,T){var e8;this.file=e7;this.user=T;this.mode="recipients";this._activate();this.$sharing_actions.find(".get-link").hide();this.$sharing_actions.find(".send-button").show();e8=this._autocomplete_div();this.$sharing_actions.prepend(e8);e8.show();this.autocomplete.dynamically_resize_input();by(this.autocomplete.element).val("");this.autocomplete.clearTokens();by(this.autocomplete.get_entry_container()).hide();by(this.autocomplete.element).focus();return false},link_click:function(e8,e7){var T;this.file=e8;this.user=e7;if(!dV.get_for_user(this.user).verified_or_show(ek.SHMODAL)){return}T="file_row_sharing_menu";a5.ShmodelUILogger.log("token_share",T,this.target_item);return dm.shmodel(this.file.fq_path,T)},_activate:function(){this.$sharing_div=by(this.file.get_div()).find(".sharing");this.$sharing_actions=this.$sharing_div.find(".sharing-actions");this.$sharing_actions.find(".recipients").hide();this.$sharing_div.addClass("pressed");by("#browse-box").addClass("dropdown-menu-open");return this._listen()},_send:function(){var e7,fc,fd,ff,fi,e9,e8,fa,fe,fh,fb,T,fg;this.sharing_api=new bf(this.user);this.autocomplete.tokenize_emails_input(true);ff=this.emails=this.autocomplete.getEmails().split(", ");fi=this.file.fq_path;T={emails:ff};fd="";fc="";e7="";fa=this.file.target_ns;e8="";fg="";e7="";e9=false;this._hide();fh=(function(fj){return function(){return fj._complete(er("Sent!"),"success")}})(this);fe=(function(fj){return function(fo){var fn,fm,fl,fk;fk=fo.responseText.substr(4);if(fk[0]==="{"){fn=JSON.parse(fk);if(fn.emails){fm=fn.emails["message_text"]}if(fn.path){fm=fn.path["message_text"]}}else{fm=fk}if(!fm){fm="Unknown"}fl=er("Error: %(msg)s").format({msg:fm});return fj._complete(fl,"error")}})(this);if(!dV.get_for_user(this.user).verified_or_show(ek.SHMODAL)){return}fb=this.file.read_only||this.file.is_read_only_mount;if(this.file.is_shared_folder()&&!fb){return this.sharing_api.invite_more_to_folder(fa,T,fd,e7,fh,fe)}else{if(this.file.could_be_shared_folder()&&!fb){return this.sharing_api.share_folder(false,fi,T,fd,fc,e8,fg,e7,e9,fh,fe)}else{return this._get_shmodel_link(function(fk){var fj;fj=C.parse(fk);return cv.WebRequest({url:"/sm/share",data:{emails:ff,shmodel_path:fj.path},subject_user:cl.active_user.id,success:fh,error:fe})})}}},_get_shmodel_link:function(T){return cv.WebRequest({url:"/growth/find_or_create_shmodel_link",data:{path:this.file.fq_path},subject_user:cl.active_user.id,dataType:"json",success:(function(e7){return function(e8){if(e8.error!=null){return e7._complete(er("Error"),"error")}else{return T(e8.shmodel_link)}}})(this),error:(function(e7){return function(){return e7._complete(er("Error"),"error")}})(this)})},_complete:function(e7,fc){var T,fb,fd,fe,e9,fa,e8;this.$sharing_div.addClass("complete");T=this.$sharing_div.find(".sharers");if(fc==="success"&&this.emails){fa=a6("Sent to %(number)d person","Sent to %(number)d people",this.emails.length).format({number:this.emails.length});aa.success(fa);fb=T.text();if(fb==="--"){fb=""}if(fb.length===""||fb.length+this.emails.join(", ").length<28){fd=[];e8=0;e9=0;while(e9<this.emails.length&&e8+this.emails[e9].length<(30-fb.length)){fd.push(this.emails[e9]);e8+=this.emails[e9].length;e9++}if(this.emails.length>fd.length){fd.push("+"+(this.emails.length-fd.length))}if(fb!==""){fd.push(fb)}fe=fd.join(", ");T.text(fe)}}else{if(fc==="error"){aa.error(e7)}}return setTimeout(this._removeComplete,2000)},_removeComplete:function(){return by("div.sharing.complete").removeClass("complete")},_autocomplete_div:function(){return by("#browse-inline-autocomplete")},_listen:function(){if(this.mode==="recipients"){this._autocomplete_div().on("click dblclick",function(T){return T.stopPropagation()});this.$sharing_actions.find(".send-button").on("click",by.proxy(this._send,this))}return by(document).on("mousedown",by.proxy(this._click_outside_autocompleter_callback,this))},_unlisten:function(){if(this.mode==="recipients"){this._autocomplete_div().off("click dblclick");this.$sharing_actions.find(".send-button").off("click",by.proxy(this._send,this))}return by(document).off("mousedown",this._click_outside_autocompleter_callback)},_click_outside_autocompleter_callback:function(T){if(!(this.$sharing_actions.is(T.target)||by(T.target).parents(".sharing-actions").length)){return this._hide()}},_hide:function(T){var e7;this._unlisten();by("#browse-box").removeClass("dropdown-menu-open");this.$sharing_actions.find(".recipients, .get-link").show();this.$sharing_actions.find(".send-button, .link-field").hide();this.$sharing_div.removeClass("pressed");e7=this._autocomplete_div().hide();return by("#browse-sort").append(e7)}};var x;x=A.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(T,e7){this._exclude_move_event=T;if(e7!=null){return this._scroll_window=e7}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(e7){var T;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(e7):void 0){return this._mouse_y=0}else{T=e7.pointerY();return this._mouse_y=T-y.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var T;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}T=0;if(this._mouse_y<this._scroll_window){T=-1*this._scroll_amount}else{if(this._mouse_y>y.viewport_dimensions().height-this._scroll_window){T=this._scroll_amount}}if(T){return y.scroll_to(y.scroll_offsets().left,y.scroll_offsets().top+T)}}};var bL;bL=A.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var T;if(!Modernizr.draganddrop){return}this.listen();T=function(e8){var e7;e7=by(e8.target);return e7.closest("#browse-location").length||e7.attr("id")==="browse-location"};return x.init(T,by("#browse-header").height())},listen:function(){var T;T=$(document.body);document.observe(cl.UPDATE_EVT,this._update_body_data.bind(this));T.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));T.on("dragend",this._body_dragend.bind(this));T.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){T.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));T.on("mousedown",this._ie_start_drags.bind(this));T.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}T.observe("dragover",this._body_dragover.bind(this));T.observe("dragleave",this._body_dragleave.bind(this));T.observe("dragstart",this._body_dragstart.bind(this));T.observe("mousemove",this._body_mousemove.bind(this));T.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eM.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(cl.RENDER_EVT,this._build_selected_drag_icon.bind(this));T.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return T.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(e7){var T;if(!window.event||window.event.button!==1){return}T=e7.findElement("[draggable]");if(T&&T!==document&&T.dragDrop){T.dragDrop();return bL._ie_end_drags()}},_ie_start_drags:function(T,e7){if(e7.tagName!=="OBJECT"&&$(e7).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var e7,T;e7=cl.inside_dir?"copy move":false;T=cl.inside_dir?cl.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",e7);return $(document.documentElement).writeAttribute("data-fq_path",T)},_body_dragover:function(e7){var T;T=this._get_event_browse_files();if(T.length){return this._update_status_position(e7,T)}else{if(!this._drag_from_window&&this._can_drop_transfer(e7.dataTransfer)){return bj.show_drop_indicators(e7)}}},_body_dragleave:function(e8){var e7,T,e9;T=e8.x||e8.clientX;e9=e8.y||e8.clientY;e7=y.viewport_dimensions();if(!((0<T&&T<e7.width)&&(0<e9&&e9<e7.height))){return bj.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bj.hide_drop_indicators();x.end();return this._drag_from_window=false},_body_mousemove:function(){return bj.hide_drop_indicators()},_ie_mouseover:function(e7,T){if(!y.focus_in_input()){return T.focus()}},_dropzone_dragover:function(fb,T){var e7,e8,e9,fa;if(!cE.isFileDragEnabled()){return true}fb.preventDefault();e9=this._get_event_browse_files();fa=this._target_fq_path(T);if(!e9.pluck("fq_path").indexOf(fa===-1)){return}if(!this._can_drop(fb,T)){T.addClassName("drag_nodrop");return}try{e8=fb.dataTransfer.effectAllowed}catch(fc){}if(e8==="move"||e8==="copyMove"||e8==="linkMove"||e8==="all"){fb.dataTransfer.dropEffect="move"}else{fb.dataTransfer.dropEffect="copy"}fb.preventDefault();e7=$$(".dragover");e7.removeItem(T);e7.invoke("removeClassName","dragover");if(!dK.disabled){T.addClassName("dragover")}return bj.folder_dragover(fa)},_dropzone_dragleave:function(e7,T){return this._clear_hover_state(T)},_file_dragstart:function(fc,ff){var fg,T,fh,e7,fb,fa,e9,fd,e8;dX.clear_selected();if(eM.is_selecting()){return fc.preventDefault()}fc.dataTransfer.effectAllowed="copyMove";fc.dataTransfer.setData("URL","about:blank");fb=cK.from_elem(ff);this._set_event_browse_files(fb);fa=this._get_event_browse_files();if(fa.length<=1&&!fb.dir){e8=fb.href;e9=(fb.filename||er("file")).replace(/:/g,"-");fd="application/octet-stream";try{fc.dataTransfer.setData("DownloadURL",[fd,e9,e8].join(":"))}catch(fe){}}fh=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});fg=true;try{fc.dataTransfer.setDragImage(fh,150,150)}catch(fe){e7=fe;fg=dX.ie8}this._add_drop_indicators(fc);x.start();if(fg){this._update_status_position(fc,fa);T=$("drag-status");T.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(fa.length>1){T.addClassName("rotatein")}if(this._is_dragging_selection()){T.addClassName("selection")}return T.addClassName("fadein")}},_add_drop_indicators:function(fa){var fb,e9,e7,e8,T;$(document.body).addClassName(this._STATUS_CLASS);if(!dK.disabled){e8=$$('[dropzone="copy move"]');T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fb=e8[e9];if(this._can_drop(fa,fb)){T.push(fb.addClassName("can_drop"))}else{T.push(void 0)}}return T}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,e9,fe,e8,fc,ff,fd,e7,fa,fg,fb;e7=eM.get_selected_files();fe=new Element("div",{id:"drag-selection-status"});fb=e7.slice(0,4);for(fc=fa=0,fg=fb.length;fa<fg;fc=++fa){e9=fb[fc];T=e9.get_div();if(!T){continue}fd=T.down(".icon");fd.stopObserving("load");fd.observe.bind(fd).defer("load",bL._build_selected_drag_icon);ff=fd.cloneNode(false);Element.addClassName(ff,"icon icon"+fc);fe.__sert(ff)}e8=new Element("span",{className:"badge"});e8.__date(e7.length);fe.appendChild(e8);return $("drag-selection-status").replace(fe)},_build_file_drag_icon:function(fa,T){var e7,fb,e9,e8;e7=cK.from_elem(T);e8=e7.get_div().down(".icon").cloneNode(false);Element.addClassName(e8,"icon icon0");e9=new Element("span",{className:"badge"});e9.__date("1");fb=new Element("div",{id:"drag-file-status"});fb.__date(e8).__sert(e9);return $("drag-file-status").replace(fb)},_drop:function(fe,fi){var ff,fa,fl,fj,fm,fd,fk,fc,e9,e7,fg,T,e8,fb,fh;fa=this._get_event_browse_files();if(this._linkfile_drop_enabled()){fd=cE.getDraggedLink(fe.dataTransfer)}if(fd!=null){T=cE.buildUrlLinkfileContents(fd);fg=new Blob([T],{type:"text/plain"});e7=C.parse(fd).getAuthority();fg.name=cl.unused_filename(e7+".url");fg.overwrite=false;fk=[fg];a5.LinkfileActivityLogger.log("droplink","url",e7,true,"browse",{})}else{fk=fe.dataTransfer.files;fc=fe.dataTransfer.items}fe.preventDefault();if(fi.readAttribute("quicksend")){if(fk&&fk.length){fl=function(){return bj.upload(V.DEST_FOLDER,fk,fc)};V.get_folder_name(fl)}else{if(fa.length){for(fb=0,fh=fa.length;fb<fh;fb++){e9=fa[fb];e9.id=plupload.guid();V.add_dropbox_file(e9)}}}return}if(this._is_read_only(fi)){e8=er("You don't have permission to add to this folder.");aa.error(e8);return}fj=null;fm=cK.from_elem(fi);ff=fi.readAttribute("data-fq_path");if(fm){fj=fm.fq_path}else{if(ff||ff===""){fj=ff}}if(fk&&fk.length){if(!bj.supported()){aa.error(er("Drag and drop not supported. Please try the simple uploader."))}else{if(!bj.browse_indicators_enabled()&&!bj.modal_indicators_enabled()){if(ct.choose_button_id.startsWith("wizard-")){aa.error(er("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{aa.error(er("You can't drag and drop upload right now."))}}else{bj.upload(fj,fk,fc)}}}else{if(fa.length){if((fe.dataTransfer.dropEffect==="copy")||(fe.dataTransfer.effectAllowed==="copy")){du.do_bulk_copy(fa,fj)}else{if(!cl.inside_dir||cl.containing_fq_path()!==fj){du.do_bulk_move(fa,fj)}}}}this._remove_drop_indicators();return bj.hide_drop_indicators()},_set_event_browse_files:function(T){var e7;e7=eM.is_selected(T);return this._current_item_key=e7?this._SELECTION_CONST:T.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var e8,e7,T;try{T=this._current_item_key;if(this._is_dragging_selection()){return eM.get_selected_files()}else{if(T){e7=cK.from_key(T);return(e7?[e7]:[])}}}catch(e9){e8=e9;console.log(e8)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(T){if(T.readAttribute("read_only")){return true}if(T.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return at.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(e7){var T;T=["Files"];if(this._linkfile_drop_enabled()){T.push.apply(T,["text/x-moz-url","text/uri-list","Url"])}return br.intersection(e7!=null?e7.types:void 0,T).length>0},_can_drop:function(e9,e7){var T,e8;if(e7.readAttribute("quicksend")){return true}if(this._is_read_only(e7)){return false}T=this._target_fq_path(e7);e8=this._get_event_browse_files();if(e8.length){return !du.bulk_move_error(e8,T)}else{if(this._can_drop_transfer(e9.dataTransfer)){bj.supported();return true}else{return false}}},_target_fq_path:function(T){var e7;e7=cK.from_elem(T);if(e7){return e7.fq_path}else{return T.readAttribute("data-fq_path")}},_clear_hover_state:function(e7){var fa,e9,T,e8;e8=$$("#browse .dragover");for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];if(fa!==e7){fa.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(T){T=Event.extend(T);return dX.scry("drag-status").setStyle({left:(T.pointerX()-y.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(T.pointerY()-y.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var L;L=A.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(T){return T.charCodeAt(0)}),update:function(){var e8,fb,e7,fa,T,e9;if(!L._listening){L.listen();L._listening=true}e8=[];e9=cl.files;for(fa=0,T=e9.length;fa<T;fa++){e7=e9[fa];fb=L.to_codepoint_list(e7.filename);e8.push([fb,e7])}e8.sort(function(fd,fc){return L.cmp_codepoints(fd[0],fc[0])});return L._CODEPOINTS=e8},reset:function(){return L._active=""},is_active:function(){return L._active},jump:function(T){if(T){eM.set_selected_files([T]);return cl.scrollTo(T.get_div())}},listen:function(){var fa,e9,e7,e8,T;document.observe("keypress",function(fc){var fb;if(key.getScope()!==cl.KEY_SCOPE){return}if(y.focus_in_input()||fc.metaKey||fc.altKey||fc.altGraphKey||fc.ctrlKey){return}fb=fc.charCode||fc.keyCode;if(fb<32){return}if((33<=fb&&fb<=40)){return}if(fb===32){if(L._active){fc.preventDefault()}else{return}}if(L._BLACKLIST.indexOf(fb)!==-1){return}clearTimeout(L._RESET_TIMER_ID);L._active+=String.fromCharCode(fb).toLowerCase();L.jump(L.nearest_file(L._active));return L._RESET_TIMER_ID=setTimeout(L.reset,L._RESET_WAIT)});e8=[aB.DELETE,aB.COPY,aB.MOVE,aB.RENAME,aB.PURGE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_LEAVE,aB.SF_UNSHARE,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE,bx.ADD,bx.REMOVE,bx.MOVE];T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];document.observe(fa,function(fb){return L.update()});T.push(by(document).on(fa,function(fb){return L.update()}))}return T},nearest_file:function(fe){var fb,e7,T,fa,fd,fc,e9,e8;if((fc=L._CODEPOINTS)!=null?fc.length:void 0){fb=L.to_codepoint_list(fe);e9=L._CODEPOINTS;for(fa=0,fd=e9.length;fa<fd;fa++){e8=e9[fa],T=e8[0],e7=e8[1];if(L.cmp_codepoints(fb,T)<1){return e7}}L._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(fa,e9){var T,e8,e7;cC(fa.length>0&&e9.length>0,"bad input to cmp_codepoints");for(T=e8=0,e7=fa.length;0<=e7?e8<e7:e8>e7;T=0<=e7?++e8:--e8){if(e9[T]==null){return 1}if(fa[T]!==e9[T]){return(fa[T]<e9[T]?-1:1)}}if(e9.length>fa.length){return -1}else{return 0}},to_codepoint_list:function(e7){var e8,T,fa,e9;e7=e7.toLowerCase();T=[];for(e8=fa=0,e9=e7.length;0<=e9?fa<e9:fa>e9;e8=0<=e9?++fa:--fa){T.push(e7.charCodeAt(e8))}return T}};var bh;bh=A.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){by(document).click(this.hide_on_click);by(document).on(cl.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(T){return function(e7){return bh.hide()}})(this))},unlisten:function(){by(document).off("click",this.hide_on_click);return by(document).off(cl.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(T){if(!(T.which===3||by(T.target).parents("#context-menu").length)){return bh.hide()}},show_for_file:function(T,e9,e8){var fa,e7;cl.keyboard_nav=false;this.hide();fa=cK.from_elem(e8);e7=eM.is_selected(fa)?eM.get_selected_files():(eM.deselect_all(),[fa]);eM.set_context_selected(e7);return this._show(e9,new T(e7))},show_global:function(T,e7){this.hide();return this._show(e7,new T())},show_shmodel:function(fc){var fb,e7,T,e8,e9,fa;fb=["get_original"];e9=fc.findElement("img");if((e9.readAttribute("enable-download"))==="true"){e8=e9.readAttribute("data-original-href");e7=[]}else{e8="";e7=["get_original"]}this.hide();fa={get_original:{icon:"download",text:er("Download original"),href:e8}};T=Class.create({get_action_names:function(){return fb},get_disabled_action_names:function(){return e7},get_action_by_name:function(fd){var fe;fe=fa[fd];fe.name=fd;return fe}});return this._show(fc,new T())},show_for_lightbox:function(fd){var fc,e7,T,fa,e8,fb,e9;fc=["download","view_original"];this.hide();e8=fd.findElement("img");if((e8.readAttribute("enable-download"))==="false"){e7=["download","view_original"];fa="";e9=""}else{e7=[];fa=C.parse(e8.readAttribute("data-original-href")).updateQuery({dl:1}).toString();e9=e8.readAttribute("data-original-href")}fb={download:{icon:"download",text:er("Download"),href:fa},view_original:{icon:"view_original",text:a0.append_ellipsis(er("View original")),href:e9,target:"_blank"}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){var fe;fe=$("context-menu-container");fe.stopObserving("click");fe.stopObserving("contextmenu");fe.on("click",".action button",this._click.bind(this));return fe.on("contextmenu",".action button",this._click.bind(this))},_click:function(fi,ff){var fh,fe,fg;fh=ff.readAttribute("data-value");fe=fb[fh];bh.hide();fi.preventDefault();return(fg=fe.click_handler)!=null?fg.call(this,fi):void 0},get_action_names:function(){return fc},get_disabled_action_names:function(){return e7},get_action_by_name:function(fe){var ff;ff=fb[fe];ff.name=fe;return ff}});return this._show(fd,new T())},show_photos:function(fe,fi){var fh,e7,fb,e9,fg,ff,T,e8,fc,fd,fa;this.hide();e9={divider:{type:"divider"},choose_album:{icon:"album_16",text:a0.append_ellipsis(er("Add %(num_photos)s to album").format({num_photos:fi.length})),click_handler:function(fj){cz.show_add_to_album_modal(fj,fi);return g.log_interaction(ee.ADD_TO_OTHER_ALBUM,c3.PCM,{num_photos:fi.length})}},remove:{icon:"album_delete_16",text:er("Remove %(num_photos)s from album").format({num_photos:fi.length}),click_handler:function(){cz.show_remove_photos_modal(bK.get_current_collection(),fi);return g.log_interaction(ee.REMOVE,c3.PCM,{num_photos:fi.length})}},set_cover:{icon:"album_16",text:er("Set as cover"),click_handler:function(){bK.get_current_collection().set_cover(fi[0]);return g.log_interaction(ee.SET_AS_COVER,c3.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bK.show_timestamps_modal(fi)}}};if(bK.in_single_collection_view()){fh=["share","choose_album","remove"];if(fi.length===1){fh.unshift("divider");fh.unshift("set_cover")}}else{fh=["share","choose_album"];fh.push("divider");fh.push("delete");if(bK.timestamp_edit_enabled){fg=(function(){var fl,fk,fj;fj=[];for(fl=0,fk=fi.length;fl<fk;fl++){e8=fi[fl];if(e8.time_taken==null){fj.push(e8)}}return fj})();if(fg.length===0){fh.push("edit_timestamp")}else{if(fg.length===fi.length){e9.edit_timestamp.text="Set timestamp";fh.push("edit_timestamp")}}}}if(fi.length===1){fd=c0.categorize_files(fi),ff=fd[0],T=fd[1];if(ff){fc=a0.append_ellipsis(er("Share photo"))}else{fc=a0.append_ellipsis(er("Share video"))}Object.extend(e9,{share:{icon:"s_link",text:fc,click_handler:function(fj){eq.show(fi,false);return g.log_interaction(ee.SHARE,c3.PCM,{num_photos:1})}},"delete":{text:a0.append_ellipsis(er("Delete")),click_handler:function(){bK.show_delete_photos_modal(fi);return g.log_interaction(ee.DELETE,c3.PCM,{num_photos:1})}},show_in_folder:{text:a0.append_ellipsis(er("Show in folder")),click_handler:function(){bK.show_in_folder(fi[0]);return g.log_interaction(ee.SHOW_IN_FOLDER,c3.PCM,{num_photos:1})}}});if(bK.in_single_collection_view()){fh.push("divider")}fh.push("show_in_folder")}else{fa=c0.categorize_files(fi),ff=fa[0],T=fa[1];if(ff&&T){fc=a6("Share %(file_count)s item","Share %(file_count)s items",fi.length);fb=a6("Delete %(file_count)s item","Delete %(file_count)s items",fi.length)}else{if(ff){fc=a6("Share %(file_count)s photo","Share %(file_count)s photos",fi.length);fb=a6("Delete %(file_count)s photo","Delete %(file_count)s photos",fi.length)}else{fc=a6("Share %(file_count)s video","Share %(file_count)s videos",fi.length);fb=a6("Delete %(file_count)s video","Delete %(file_count)s videos",fi.length)}}fc=fc.format({file_count:fi.length});fb=fb.format({file_count:fi.length});Object.extend(e9,{share:{icon:"s_link",text:fc,click_handler:function(fj){bK._share_selected();return g.log_interaction(ee.SHARE,c3.PCM,{num_photos:fi.length})}},"delete":{text:fb,click_handler:function(fj){bK.show_delete_photos_modal(fi);return g.log_interaction(ee.DELETE,c3.PCM,{num_photos:fi.length})}}})}e7=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fm,fk){var fl,fj,fn;fl=fk.readAttribute("data-value");fj=e9[fl];if(fm.clientX===0&&fm.clientY===0){return}bh.hide();return(fn=fj.click_handler)!=null?fn.call(this,fm):void 0},get_action_names:function(){return fh},get_disabled_action_names:function(){return[]},get_action_by_name:function(fj){var fk;fk=e9[fj];fk.name=fj;return fk}});return this._show(fe,new e7())},show_photo_collection:function(e9,fa,fb){var e8,T,e7;this.hide();if(fa.is_anonymous){e8=["go_to_link","unshare"]}else{if(fa.is_creator){e8=["share","rename"];if(fa.share_tkey!=null){e8.push("unshare")}e8.push("delete")}else{e8=["share"]}}e7={share:{icon:"s_link",text:a0.append_ellipsis(er("Share album")),click_handler:function(fc){if(fa.num_items===0){aa.error(er("This album is empty. Add some photos before you share it!"));return}eq.show(fa,true);return g.log_interaction(ee.SHARE_ALBUM,c3.CCM,{num_photos:fa.num_photos})}},unshare:{icon:"lock",text:a0.append_ellipsis(fa.is_anonymous?er("Unshare"):er("Unshare album")),click_handler:function(fc){cz.show_unshare_modal(fa);return g.log_interaction(ee.UNSHARE_ALBUM,c3.CCM,{num_photos:fa.num_photos})}},rename:{icon:"pencil",text:er("Rename album"),click_handler:function(fc){fa.rename(fb.down(".collection-name"));return g.log_interaction(ee.RENAME_ALBUM,c3.CCM,{num_photos:fa.num_photos})}},"delete":{icon:"album_delete_16",text:a0.append_ellipsis(er("Delete album")),click_handler:function(fc){cz.show_delete_modal(fa);return g.log_interaction(ee.DELETE_ALBUM,c3.CCM,{num_photos:fa.num_photos})}},go_to_link:{icon:"s_link",text:er("Go to link"),click_handler:function(fc){cz.go_to_link(fa);return g.log_interaction(ee.GO_TO_ALBUM_LINK,c3.CCM,{num_photos:fa.num_photos})}}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(fg,fd){var ff,fc,fe;ff=fd.readAttribute("data-value");fc=e7[ff];bh.hide();return(fe=fc.click_handler)!=null?fe.call(this):void 0},get_action_names:function(){return e8},get_disabled_action_names:function(){return[]},get_action_by_name:function(fc){var fd;fd=e7[fc];fd.name=fc;return fd}});return this._show(e9,new T())},_show:function(fj,fd,fi){var fh,fa,fk,T,fg,ff,fm,fe,e8,e7,fl,fn,fc,fb,e9;if(fi==null){fi=false}fe=((fj!=null?(fc=fj.target)!=null?fc.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fj!=null?(fb=fj.target)!=null?fb.type.toUpperCase():void 0:void 0)==="TEXT")||((fj!=null?(e9=fj.target)!=null?e9.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");fg=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay",".waiting_for_items"];fm=$(fj.target);if(by(fm).parents("#context-menu").length){return}fh=by("#file-preview-modal");if(!(fh.find(fm).length&&by(fm).is("img"))){for(e8=0,fl=fg.length;e8<fl;e8++){T=fg[e8];fk=$$(T);if(fk){for(e7=0,fn=fk.length;e7<fn;e7++){fa=fk[e7];if(fm.descendantOf(fa)||fm.match(T)){return}}}}}if((fj!=null?fj.shiftKey:void 0)||fe){return}else{Event.stop(fj)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=e2.tmpl("context_menu_tmpl")}if(!fd.get_action_names().length){return}eJ.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:fd,actions:(function(){var fq,fo,fr,fp;fr=fd.get_action_names();fp=[];for(fq=0,fo=fr.length;fq<fo;fq++){ff=fr[fq];fp.push(fd.get_action_by_name(ff))}return fp})(),disabled_actions:fd.get_disabled_action_names(),big:fi,Sprite:cp}));this.position_at(fj.clientX,fj.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(e8,fb){var e7,T,e9,fa;fa=y.viewport_dimensions();T=parseInt($("context-menu").getStyle("width"),10);e7=parseInt($("context-menu").getStyle("height"),10);e9=15;if(e8+T>fa.width-e9){$("context-menu").setStyle({left:(fa.width-T-e9)+"px"})}else{$("context-menu").setStyle({left:e8+"px"})}if(fb+e7>fa.height-e9){return $("context-menu").setStyle({top:(fa.height-e7-e9)+"px"})}else{return $("context-menu").setStyle({top:fb+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eM.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var dd,cl,i,aD,ar,cM,ce,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};dd=A.BROWSE_SNIPPET_LEN=25;ce=A.SEARCH_SNIPPET_LEN=20;aD=A.COMMENT_COUNT_SNIPPET_LEN=3;cM=A.LAST_MODIFIED_FNAME_SNIPPET=4;ar=[bk.FILES_BY_NAME,true,"FILES_BY_NAME"];cl=INLINE_JS.Browse=A.Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",BEFORE_UPDATE_EVT:"db:browse:before_update",UPDATE_EVT:"db:browse:update",NEW_PAGE_EVT:"db:browse:new_page",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:ar,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(e7,fc,e9,fb,T,fa,e8){this.browse_actions_ctor=fc;this.global_actions_ctor=e9;this.browse_actions_context_ctor=fb;this.global_actions_context_ctor=T;this.ns_id_to_mount_point=fa;cC(typeof e8==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cD.get_viewer().get_user_by_id(e8);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cC(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();y.viewport_dimensions();if(bV.chrome){this.browser_supports_previews=e7&&dX.pdf_plugins().length}else{this.browser_supports_previews=e7}if(cD.get_viewer().is_paired){dw.set_role(this.active_user.role)}this.subscribe_sfj_callbacks={};this.compiled_search_tmpl=e2.tmpl("search_list_item_tmpl");this.add_visible_change_callback((function(fd){return function(){return fd.show_inline_sharing_on_browse_exp()}})(this));cv.AuthenticatedRequest({url:C({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(e7,fd){var fc,fb,fa,e9,T,e8;if(fd==null){fd=null}this.ns_id_to_mount_point=e7.ns_id_to_mount_point;this.old_path_to_ns_id=e7.old_path_to_ns_id;this.compiled_tmpl=e2.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=e7.containing_fq_path==="";this.inside_dir=e7.inside_dir;this.inside_deleted_dir=e7.inside_deleted_dir;this.inside_shared_folder=e7.inside_shared_folder;this.inside_read_only_shared_folder=e7.inside_read_only_shared_folder;this.inside_sandbox=e7.inside_sandbox;this.public_app_token=e7.public_app_token;this.public_folder_enabled=e7.public_folder_enabled;this.inside_deleted_sandbox=e7.inside_deleted_sandbox;this.inside_deleted_shared_folder=e7.inside_deleted_shared_folder;this.inside_team_folder=e7.inside_team_folder;this.golden_gate_enabled=e7.golden_gate_enabled;this.is_read_only=e7.is_read_only;this.ns_map=e7.ns_map;this.permanent_delete_is_disabled_by_ns_id=e7.permanent_delete_is_disabled_by_ns_id;this.contents_cache_key=e7.contents_cache_key;this._eventbus_darklaunch_enabled=e7.eventbus_darklaunch_enabled;this._eventbus_darklaunch_num_queues=e7.eventbus_darklaunch_num_queues;fb="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(fb)}else{$("browse").removeClassName(fb)}this.block_hash=e7.block_hash;this.block_hash_param=e7.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=e7.containing_ns_id;this._containing_ns_path=e7.containing_ns_path;this._containing_fq_path=e7.containing_fq_path;this._containing_mount_point=e7.containing_mount_point;this._containing_sf_perm_role=e7.containing_sf_perm_role;this.breadcrumb();e8=[this.browse_actions,this.global_actions];for(e9=0,T=e8.length;e9<T;e9++){fc=e8[e9];if(fc!=null){fc.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(e7.file_info||e7.paginated)){this.show_message(er('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(e7.paginated){this._start_pagination(e7.first_page)}else{this._push_files(e7.file_info,fd)}if(this._eventbus_darklaunch_enabled){fa=new __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch(cl.active_user.id,this._eventbus_darklaunch_num_queues);return fa.allocate_event_queues()}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(e7){var T;if(e7.unsupported_sort!=null){this.reset_sort()}this.paginating=true;T=cl.active_user.id;this.pagination_manager=new e6();this.pagination_manager.initialize(e7,"sjid","/browse_get_next",T,(function(e8){return function(e9,fa){return e8._new_data_available(e9,fa)}})(this));this.pagination_manager.startAutoFetching();by("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;by("#more-loading").hide();this.enable_sorting();return this._stop_waiting_for_items()},_new_data_available:function(e9,e7){var e8,T;if(!this.paginating){return}T=this._push_files(e7);if(!this.in_search_mode()){this.smartfill();a0.load_visible_thumbs();this.fire_visible_change_callbacks()}e8=e9.loadedPageCount()===1;if(!e8){if(this._is_item_selection_needed()){if(this._are_all_selected_items_fetched()||e9.areAllItemsReady()){this._stop_waiting_for_items();this.set_selection_from_fq_paths_or_index(cl)}}document.fire(this.NEW_PAGE_EVT,{page_files:T});by(document).trigger(this.NEW_PAGE_EVT,{page_files:T})}if(e9.areAllItemsReady()){return this._stop_pagination()}},_is_item_selection_needed:function(){return(this.select_fq_paths&&this.select_fq_paths.length>0)||(this.select_index>-1)},_are_all_selected_items_fetched:function(e7){var fd,ff,fc,e8,fa,e9,fe,T,fb;if(e7==null){e7=this.files}if(this.select_fq_paths&&this.select_fq_paths.length>0){fb=this.select_fq_paths;for(fa=0,fe=fb.length;fa<fe;fa++){fd=fb[fa];fc=false;e8=fd.toLowerCase();for(e9=0,T=e7.length;e9<T;e9++){ff=e7[e9];if(ff.fq_path.toLowerCase()===e8){fc=true;break}}if(!fc){return false}}return true}else{if(this.select_index>-1){return this.select_index<e7.length}}return cC(0,"Expected something to select (@select_index or @select_fq_paths)")},_wait_for_items:function(){by("#waiting-for-items").show();by("#global-actions").addClass("disabled");return by("body").addClass("waiting_for_items")},_stop_waiting_for_items:function(){by("body").removeClass("waiting_for_items");by("#global-actions").removeClass("disabled");return by("#waiting-for-items").hide()},_start_darklaunch_event_queues:function(){var T,e9,e8,e7;if(this._eventbus_darklaunch_num_queues<=0){return}e7=[];for(T=e9=1,e8=this._eventbus_darklaunch_num_queues;1<=e8?e9<=e8:e9>=e8;T=1<=e8?++e9:--e9){__CIRCULAR_DEPENDENCY__.UserQueue.get_user_queue(cl.active_user.id,this._eventbus_darklaunch_num_queues);e7.push(eventbus_dark_launch.allocate_event_queues())}return e7},_push_files:function(e8,fc){var fb,e7,e9,fa,T;if(fc==null){fc=null}e7=[];for(fa=0,T=e8.length;fa<T;fa++){e9=e8[fa];fb=a0.make_browsefile(e9,fc);fb.track_in_browse();e7.push(fb)}L.update();return e7},_get_helper:function(T){cC(this.inside_dir,"accessed "+T+", but not inside a directory");return cl[T]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fi,e9,fa,fd,fl,e7,fg,ff,fc,fj,e8,T,fk,fh,fe,fb;by("#fulltext-search-all-link").click(this.unscoped_search);by("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bh.show_for_file.bind(bh,this.browse_actions_context_ctor));this.enable_sorting();fd="#browse-sort a.sortable-column-header";dX.add_sort_arrow_mouseover($("name-sorter"),true,fd,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bh.show_global.bind(bh,this.global_actions_context_ctor));document.observe(eM.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aB.COPY,(function(fm){return function(fn){if(fm.inside_dir&&fn.memo.to_fq_path===fm.containing_fq_path()){return fm.force_reload()}}})(this));fh=[aB.MOVE,aB.RESTORE,aB.UPLOAD,aB.SF_NEW,aB.SF_REJOIN,aB.SF_IGNORE,aB.LINKS_REMOVE,aB.LINKS_ADD];for(fg=0,fj=fh.length;fg<fj;fg++){e9=fh[fg];fa=(function(fm){return function(fn){if(fm.inside_dir&&!(b3.sparky_search_ui_enabled&&cl.in_search_mode())){return fm.force_reload()}}})(this);document.observe(e9,fa);by(document).on(e9,fa)}fe=[aB.SF_LEAVE,aB.SF_UNSHARE];for(ff=0,e8=fe.length;ff<e8;ff++){e9=fe[ff];document.observe(e9,(function(fm){return function(fn){if(fm.inside_dir){if(fn.memo.target_ns_id===fm.containing_ns_id()){if(fn.memo.folder_deleted){return fm.reload_fqpath("")}else{return fm.reload_fqpath(fm.containing_fq_path())}}else{return fm.force_reload()}}}})(this))}fb=[aB.DELETE,aB.PURGE];for(fc=0,T=fb.length;fc<T;fc++){e9=fb[fc];document.observe(e9,(function(fm){return function(fv){var fs,fu,fo,ft,fn,fq,fr,fp;if(fm.inside_dir){if(fv.eventName===aB.PURGE||(fv.eventName===aB.DELETE&&!aY.get_del())){for(fu=ft=fr=fm.files.length-1;fr<=0?ft<=0:ft>=0;fu=fr<=0?++ft:--ft){if(fv.memo.files.indexOf(fm.files[fu])===-1){fo=fm.files[fu]}else{break}}eM.deselect_all();fp=fv.memo.files;for(fq=0,fn=fp.length;fq<fn;fq++){fs=fp[fq];fs.get_div().remove();fm.files.removeItem(fs)}if(fm.files.length){if(fo!=null){return eM.set_selected_files(fo)}else{return eM.set_selected_files(fm.files.last())}}else{return fm.show_empty()}}else{if(fm.keyboard_nav){fm.select_fq_paths=[fm.containing_fq_path()+"/"+fv.memo.files.last().filename]}return fm.force_reload()}}}})(this))}document.observe(bh.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bh.HIDE_EVT,this.enable_sorting.bind(this));fk=function(){var fn,fm;fn=$("browse-header");fm=fn.cumulativeOffset().top+fn.getHeight();return y.viewport_dimensions().height-fm};key("pagedown",this.KEY_SCOPE,function(fm){Event.extend(fm).preventDefault();return window.scrollBy(0,fk())});key("pageup",this.KEY_SCOPE,function(fm){Event.extend(fm).preventDefault();return window.scrollBy(0,-1*fk())});fl=function(){var fm;fm=cl.in_search_mode()?b3:cl;if(cl.files.length===0){return fm.show_empty()}else{return fm.hide_empty()}};document.observe(bx.ADD,(function(fm){return function(fp){var fo,fn,fr,fq;fq=fp.memo.files;for(fn=0,fr=fq.length;fn<fr;fn++){fo=fq[fn];fm.insert_file(fo,true)}return fl()}})(this));document.observe(bx.REMOVE,(function(fm){return function(fp){var fo,fn,fr,fq;fq=fp.memo.files;for(fn=0,fr=fq.length;fn<fr;fn++){fo=fq[fn];fm.remove_file(fo)}return fl()}})(this));document.observe(bx.MOVE,(function(fm){return function(fs){var fv,ft,fu,fw,fq,fn,fp,fo,fr;ft=fm.in_search_mode()&&b3.sparky_search_ui_enabled;fp=fs.memo.files;fr=[];for(fq=0,fn=fp.length;fq<fn;fq++){fo=fp[fq],fv=fo[0],fw=fo[1];if(ft){if(fv!=null){fu=fm.get_file_pos(fv)}else{continue}}fm.remove_file(fv);fm.insert_file(fw);if(ft&&fu>=0){fr.push(fm.update_file_pos(fw,fu))}else{fr.push(void 0)}}return fr}})(this));by(document).on(aB.COMPRESS,(function(fm){return function(fp,fo){var fn;fm.force_reload();if(fo.compressed_files.length===1&&fo.original_files.length===1){fn=a0.make_browsefile(fo.compressed_files.first());return fm.preview_compressed(fn,fo.original_files.first())}}})(this));fi=this.fire_visible_change_callbacks.bind(this);by(window).on("resize",fi);this._last_visible_change_timeout_id=null;e7=(function(fm){return function(fn){clearTimeout(fm._last_visible_change_timeout_id);return fm._last_visible_change_timeout_id=setTimeout(fi,250)}})(this);return by(window).on("scroll",e7)},add_subscribe_sfj_callback:function(T){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=T},remove_sfj_callback:function(T){return delete this.subscribe_sfj_callbacks[T]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(e8,fa){var T,e7,e9;T=by(e8.target);if(T.is("img.icon")||T.closest("a.filename-link").length>0||T.closest(".filename-col__comment-count-bubble").length>0){this._click(e8,fa)}if(T.is("a.parent-dir")){e7=cK.from_elem(fa);if(e7){e9={file_nsid:e7.ns_id,file_sjid:e7.sjid,firefly:b3.firefly_enabled,match_type:e7.match_type,position:e7.sort_rank,request_id:e7.request_id,viewport:"full-view",action_type:"click_path_link"};return a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,e9)}}},dblclick:function(T,e7){if($(T.target).match("a")){return}return this._click(T,e7)},open_file:function(e9,T,e8,e7){var fa,fb;if(e8==null){e8=false}if(e7==null){e7=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}fa={user_id:cl.active_user.id,context:aQ.FileViewContextType.PRIVATE,platform:aQ.FileViewPlatformType.WEB,ns_id:e9.ns_id,sjid:e9.sjid,ns_path:e9.ns_path,shared_link_url:null,extra:{mode:aQ.FileViewModeType.BROWSE,file_ext:au.file_extension_for_logging(e9.filename),file_bytes:e9.bytes,file_mtime:e9.ts}};fb={file_nsid:e9.ns_id,file_sjid:e9.sjid,firefly:b3.firefly_enabled,match_type:e9.match_type,position:e9.sort_rank,request_id:e9.request_id,viewport:e8?"dropdown-view":"full-view"};if(e9.dir){if(this.in_search_mode()||e8){fb.action_type="folder_open";a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,fb)}if(T){return this.open_folder_in_new_window(e9)}else{return this.open_folder(e9)}}else{if(!T&&this.can_show_preview(e9)){if(this.in_search_mode()||e8){fb.action_type="file_view";a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,fb)}return this.open_preview(e9,e7,e8)}else{if(this.in_search_mode()||e8){fb.action_type="file_view";a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,fb)}a5.FileViewLogger.log(fa);return window.open(e9.href,"_blank")}}},close_preview_callback:function(){by(document).off("db:filepreview:close",this.close_preview_callback);ac.close_shared_link_view();return cl.set_title()},preview_compressed:function(e7,T){return k.show(e7,cl.active_user,{files:[e7,T],file_view_mode:aQ.FileViewModeType.BROWSE,hide_comments:true})},open_preview:function(e8,T,e9,e7){if(T==null){T=Constants.OREF_CONSTANTS.BROWSE_UNKNOWN}if(e9==null){e9=false}if(e7==null){e7=false}if(this.can_show_preview(e8)){a0.filepreview_from_selected(e8,e9,e7,T);return by(document).on("db:filepreview:close",this.close_preview_callback)}},_click:function(e8,e9){var e7,T;this.keyboard_nav=false;e7=cK.from_elem(e9);if(e7.editing){return}T=(e8.which===2)||(dX.is_mac()&&e8.metaKey);cl.open_file(e7,T,false,Constants.OREF_CONSTANTS.BROWSE_FILE_OPEN);e8.preventDefault()},crumb_click:function(e9,T){var e8,e7;this.keyboard_nav=false;e9.preventDefault();e7=T.readAttribute("data-fq_path");e8=this.details_from_fq_path(e7);return aY.set_path_url(e8.ns_id,e8.ns_path)},parent_click:function(fa,e9){var e8,fb,T,e7;this.keyboard_nav=false;fa.preventDefault();e7=e9.readAttribute("data-parent_ns_path");T=parseInt(e9.readAttribute("data-parent_ns_id"),10);aY.set_path_url(T,e7);e8=cK.from_elem(e9);if(e8){fb={file_nsid:e8.ns_id,file_sjid:e8.sjid,firefly:b3.firefly_enabled,match_type:e8.match_type,position:e8.sort_rank,request_id:e8.request_id,viewport:"full-view",action_type:"click_path_link"};return a5.SearchClientActivityLogger.log("result_action",cl.active_user.id,fb)}},selection_handler:function(){if(eM.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var T,e7,e9,e8;if(b3.sparky_search_ui_enabled&&this.in_search_mode()&&!b3.end_of_results){e8=a0.get_files_in_view(),e9=e8[0],e7=e8[1];T=this.files.length-(e9+e7);if(T<=50&&!$("browse").hasClassName("pending-search")){b3.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(a0.load_visible_thumbs.bind(a0),this.POST_SCROLL_WAIT)},unscoped_search:function(){return b3.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var e7,T;this.last_sort=ar;T="#browse-sort a.sortable-column-header";e7=$$(T)[0];dX.add_sort_arrow_mouseover(e7,true,T,false);$("kind-sorter-label").__date(dg.DISPLAY.FILES_BY_KIND);return cp.src(e7.down("img"),"web","arrow-up-gray")},sort_handler:function(fd,e9,fc){var e7,fb,fa,T,e8;e9=$(e9);e9.blur();e8=e9.readAttribute("data-sort");if(fc!=null){}else{if(this.last_sort[0]===bk[e8]){fc=e9.readAttribute("data-ascending")==="false"}else{fc=e8!=="FILES_BY_MODIFIED"}}if(dg.has_label(e8)){if(dg.has_sort(this.last_sort[0])||this.show_shared_with){fa=dg.next(e8,this.show_shared_with);e7=this.show_shared_with?"sharing-sorter-label":"kind-sorter-label";$(e7).__date(fa.display);e8=fa.label}e9.writeAttribute("data-sort",e8);fc=dg.IS_ASC[e8]}else{e9.writeAttribute("data-ascending",(fc?"true":"false"))}T="#browse-sort a.sortable-column-header";dX.add_sort_arrow_mouseover(e9,fc,T,true);fb=bk[e8];this.sort(fb,fc,e8);if(fd){return fd.stop()}},toggle_deleted:function(){var T;T=!aY.get_del();return aY.set_del_url(T)},unused_filename:function(fh,fk){var e8,fl,e9,ff,fg,fb,fi,fa,fd,fc,fn,fj,T,fm,fe,e7;if(fk==null){fk=false}fj=au.filename_without_extension(fh);fn=au.file_extension(fh,e8=true);ff=[];fe=cl.files;for(T=0,fm=fe.length;T<fm;T++){fl=fe[T];fc=au.filename_without_extension(fl.filename);fd=au.file_extension(fl.filename,e8=true);fb=fc.toLowerCase().indexOf(fj.toLowerCase())===0;fg=fn.toLowerCase()===fd.toLowerCase();fa=!fk||fl.dir;if(fb&&fg&&fa){ff.push(fl.filename.toLowerCase())}}if(fn){fn="."+fn}else{fn=""}e9=fj+fn;fi=1;while(true){if(e7=e9.toLowerCase(),bE.call(ff,e7)<0){break}e9=""+fj+" ("+fi+")"+fn;fi++}return e9},new_folder:function(){var fh,e9,e8,fa,fe,T,e7,fc,ff,fg,fb,fd;if(this.reloading||this.creating_folder){return}if(cl.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){fe=new aW(cl.active_user,{element_id:"create-and-share-new-folder-modal-"+cl.active_user.id,destination_dir:this.containing_fq_path()});fe.show();return}this.hide_empty();this.selectable();e8=this.unused_filename(er("New folder"),ff=true);fd=e2.tmpl("new_folder_tmpl",{name:e8,Sprite:cp,_:er});fa=-1;if(this.files.length){fb=y.scroll_offsets();if(fb.top>0){fg=this.files[0].get_div().getLayout().get("margin-box-height");fa=Math.floor(fb.top/fg)}}if(fa>0){this.files[fa].get_div().__sert({after:fd})}else{$("browse-files").__sert({top:fd})}T=$$("#browse-files .browse-new-folder .name").first();cC(T!=null,"expected new_folder_name to be defined");fh=this.containing_fq_path();fc=(function(fi){return function(fl){var fk,fj,fm;fm=fl.responseText.evalJSON(true);cC(fm.new_browse_files.length===1,"No new file data returned.");fk=au.filename(fm.new_browse_files.first().fq_path);fj=er("Created folder '%(folder_name)s'");fj=fj.format({folder_name:bO.em_snippet(fk,25)});aa.success(fj);fi.select_fq_paths=[fm.new_browse_files.first().fq_path];return fi.force_reload()}})(this);e7=(function(fi){return function(fk){var fj;fj=$$("#browse-files li.browse-new-folder").first();if(fj){fj.remove()}return fi.creating_folder=false}})(this);e9=new Ajax.InPlaceEditor(T,"/cmd/new"+(dX.urlquote(fh)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:e7,savingText:er("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:fc,subject_user:cl.active_user},callback:(function(fi){return function(fj,fk){fi.creating_folder=true;return{to_path:fk||"",folder:"yes"}}})(this)});return e9.enterEditMode()},open_folder:function(e7){var e9,T,e8;cC(e7.dir,"Only open directories, not files");if(cl.inside_dir&&cl.containing_ns_path()===e7.ns_path&&!(this.in_search_mode()&&b3.sparky_search_ui_enabled)){return}if(!(eM.get_selected_files().length===1&&eM.get_selected_files().indexOf(e7)===0)){eM.deselect_all();e9=e7.get_div();if(e9){e9.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(fa){return function(){var fb;if(!fa.reloading){return}fb=er("Loading %(filename)s...");fb=fb.format({filename:bO.em_snippet(e7.filename,50)});return fa.folder_loading_notification=aa.success(fb,60,true)}})(this),1000);if(e7.target_ns){T=e7.target_ns;e8=""}else{T=e7.ns_id;e8=e7.ns_path}if(e7.is_deleted){return aY.set_path_url(T,e8,true)}else{return aY.set_path_url(T,e8)}},open_folder_in_new_window:function(T){return window.open(aY._make_url(T.ns_id,T.ns_path),"_blank")},show_message:function(e8){var e7,T;if((typeof e8)!==(typeof"string")){T=$("browse-files").down(".browse-message");if(T){T.show()}return}this.msg=e8;e7=new Element("div",{"class":"browse-message"});e7.__date(e8);return $("browse-files").__sert(e7)},sort:function(e7,fa,T,e9){var e8;if(!e9&&e7===this.last_sort[0]&&fa===this.last_sort[1]){return}this.last_sort=[e7,fa,T];e8=e7(fa);this.files.sort(e8);this.smartfill();a0.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var e9,T,e8,e7;T=this.last_sort;e8=T[0];e9=T[1];e7=T[2];return this.sort(e8,e9,e7,true)},in_search_mode:function(){return by("#browse").hasClass("search")},flex_column:function(){if(this.show_shared_with){return $("sharing-sorter").readAttribute("data-sort")}else{return $("kind-sorter").readAttribute("data-sort")}},smartfill:function(){var e7,fa,e8,fb,e9,fd,T,fc;e7=$("browse-files");e9=[];fb=this.in_search_mode();fc=this.files;for(fd=0,T=fc.length;fd<T;fd++){fa=fc[fd];e8=this.flex_column();e9.push(this.compiled_tmpl({file:fa,in_search_mode:fb,flex_column:e8,sharing_growth_experiments_variant:cl.sharing_growth_experiments_variant,Browse:cl,Sprite:cp,Constants:Constants,FilePath:au,Emstring:bO,GandalfUtil:at,_:er}))}e7.__date(e9);document.fire(this.RENDER_EVT);return by(document).trigger(this.RENDER_EVT)},search_smartfill:function(fe,e8){var T,fd,fb,e7,fa,e9,fc;if(e8==null){e8=null}fa=[];for(e9=0,fc=fe.length;e9<fc;e9++){fd=fe[e9];e7=a0.make_browsefile(fd,e8);e7.track_in_browse();fb=this.compiled_search_tmpl({file:e7,sharing_growth_experiments_variant:cl.sharing_growth_experiments_variant,BrowseInterface:e4,Browse:cl,Sprite:cp,Constants:Constants,_:er,searchHelpers:ai,HTML:e2,FilePath:au,Emstring:bO,Util:dX});T=by(fb.toHTML());fa.push(T)}by("#browse-files").append(fa);document.fire(this.RENDER_EVT);by(document).trigger(this.RENDER_EVT);a0.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(T){this.files.push(T);if(T.target_ns){cl.ns_id_to_mount_point[T.target_ns]=T.fq_path}if(T.bytes<0){return this.deleted_shown=true}},insert_file:function(e8,e7){var T;if(!e8){return}e7=e7||0;T=this.find_file(e8.fq_path);if(T&&T!==e8){this.remove_file(T)}cK._file_index[e8.to_key()]=e8;this.update_file_pos(e8);if(e7){e8.get_div().setStyle({display:"none"})}document.fire(this.RENDER_EVT);return by(document).trigger(this.RENDER_EVT)},add_files:function(T){return cl._push_files(T.file_info)},get_file_pos:function(T){var e7;e7=this.files.indexOf(T);cC(e7!==-1,"file not present in @files");cC(T.to_key() in cK._file_index,"file not present in BrowseFile._file_index");return e7},remove_file:function(T){var e8,e7;if(!T){return}e8=this.files.indexOf(T);if(e8!==-1){this.files.splice(e8,1);delete cK._file_index[T.to_key()];return(e7=T.get_div())!=null?e7.remove():void 0}},update_file_pos:function(fb,fd){var T,ff,e9,fa,fc,e8,e7,fe;if(fd==null){fd=-1}fe=this.files.indexOf(fb);if(fe!==-1){this.files.splice(fe,1)}delete fb.sort_rank;e8=this.last_sort[0];fc=this.last_sort[1];if(fd>=0){fe=fd}fa=this.in_search_mode()&&b3.sparky_search_ui_enabled?fe:dX.bsearch(this.files,fb,e8(fc),true);this.files.splice(fa,0,fb);e9=fb.get_div();T=$("browse-files");if(e9){e9.remove()}if(this.in_search_mode()&&b3.sparky_search_ui_enabled){e7=this.compiled_search_tmpl({file:fb,Browse:cl,BrowseInterface:e4,Constants:Constants,Emstring:bO,FilePath:au,HTML:e2,Search:__CIRCULAR_DEPENDENCY__.Search,Sprite:cp,Util:dX,_:er})}else{e7=this.compiled_tmpl({file:fb,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),sharing_growth_experiments_variant:cl.sharing_growth_experiments_variant,Browse:cl,Constants:Constants,Emstring:bO,FilePath:au,Sprite:cp,GandalfUtil:at,_:er})}ff=T.childElements();if(fa<ff.length){return T.childElements()[fa].__sert({before:e7})}else{return T.__sert(e7)}},find_file:function(T){return this.files.find(function(e7){return e7.fq_path.toLowerCase()===T.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cK._file_index={};return bL._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return b3.hide_empty()},show_empty:function(){var T;this.hide_empty();if(by("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){T="#browse-empty-team-folder"}else{T="#browse-empty"}by(""+T+" .drag-prompt").toggle(!this.is_read_only);if(!(cl.in_search_mode()&&b3.sparky_search_ui_enabled)){return by(T).show()}},hide_empty:function(){return by("#browse-empty, #browse-empty-team-folder").hide()},update:function(T,e7){if(e7==null){e7=null}$("browse-box").show();if(b3.sparky_search_ui_enabled&&this.in_search_mode()){return this.search_smartfill(T.file_info,e7)}else{this.clear();if(typeof T==="string"){T=JSON.parse(T)}this.setup(T,e7);this.resort();document.fire(this.UPDATE_EVT);return by(document).trigger(this.UPDATE_EVT)}},show_inline_sharing_on_browse_exp:function(){var e8,fb,e7,fa,T,e9;if(!cl.show_inline_share){return}if(this.in_search_mode()){by("#browse-box").removeClass("show-inline-share");return}by("#browse-box").addClass("show-inline-share");e9=cl.files;for(fa=0,T=e9.length;fa<T;fa++){e8=e9[fa];e7=by(e8.get_div()).find(".sharing");e7.find(".recipients").off().on("click",eM.recipients_click);if((e8.is_shared_folder()||e8.could_be_shared_folder())&&!(e8.read_only||e8.is_read_only_mount)){fb=er("Who do you want to collaborate on this folder with?")}else{if(e8.type===b1.FOLDER){fb=er("Who do you want to send this folder to?")}else{fb=er("Who do you want to send this file to?")}}e7.find(".recipients").attr("placeholder",fb);e7.find(".get-link").off().on("click",eM.link_click)}if(!this.show_sharing_init_done){this.show_sharing_init_done=true;return aT.init()}},reset_browse_exp:function(){var T;T=by("#browse-inline-autocomplete");T.hide().off();by("#browse-sort").append(T);return by("#browse-box").removeClass("dropdown-menu-open")},reload_fqpath:function(e7,T){return this.reload(null,dX.urlquote(e7),T)},force_reload:function(){return this.reload(this.containing_ns_id(),dX.urlquote(this.containing_ns_path()),true)},set_title:function(){var T;if(cl.in_search_mode()){b3.set_title();return}if(!cl.inside_dir){return}T=this.containing_fq_path();return document.title=T?au.filename(T)+" - Dropbox":cD.get_viewer().is_paired&&cl.active_user.role===Constants.ROLE_WORK?cD.get_viewer().team_name+" - Dropbox":cD.get_viewer().is_paired&&cl.active_user.role===Constants.ROLE_PERSONAL?er("Personal")+" - Dropbox":er("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(fe){var e8,e7,fc,fb,T,e9,fa,fd;T=fe.select_fq_paths;e9=fe.select_index;if(T||e9>-1){e7=[];if(T){for(fa=0,fd=T.length;fa<fd;fa++){fc=T[fa];fb=this.find_file(fc);if(fb){e7.push(fb)}}}if(!e7.length&&e9>-1){e8=this.files[e9];if(e8){e7.push(e8)}}if(e7.length){eM.set_selected_files(e7);this.scrollToWithPadding(e7.first().get_div(),100)}fe.select_fq_paths=false;return fe.select_index=-1}else{if(!b3.sparky_search_ui_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var e7,fd,fa,ff,fb,e9,fe,T,fc,e8;if(this.select_item_counters!=null){fa={};fc=this.select_item_counters;for(fb=0,fe=fc.length;fb<fe;fb++){fd=fc[fb];fa[fd]=true}ff=[];e8=this.files;for(e9=0,T=e8.length;e9<T;e9++){e7=e8[e9];if(e7.root_coll_item_counter in fa){ff.push(e7)}}eM.set_selected_files(ff);return this.select_item_counters=null}},reload:function(e9,fe,e7){var fg,fa,ff,e8,fc,fb,fd,T;e8="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+fe+")";cC(fe.search(eu.URL_ESCAPE_REGEX)===-1,e8);if(e9==null){e9=cl.active_user.root_ns}fe=au.normalize(fe);if(a0.get_mode()!==a0.BROWSE_MODE){this.clear();a0.set_browse_mode()}if(b3._clear_on_reload){b3.clear_searchbox()}if(!aj.uploading){cS.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&fe===this.containing_ns_path()&&e9===this.containing_ns_id()&&!e7){return}fd=this.first_load?Constants.referrer:"";ff=this.deleted_shown?"?show_deleted=yes":"";fb={ns_id:e9,referrer:fd,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bk.FOLDERS_FIRST};fb=Object.extend(fb,this.extra_reload_args);ey("Browse.reload:",fe);this.reloading=true;T="/browse"+fe+ff;fg=2;fa=["browse",e9,fe,ff,cl.active_user.id,fg];fc=(function(fh){return function(fi){fh.reset_state();fh.update(fi);(fh.files.length?fh.hide_empty.bind(fh):fh.show_empty.bind(fh))();clearTimeout(fh.folder_loading_timeout);if(aa.isShown()&&aa.current()===fh.folder_loading_notification){aa.clear()}y.scroll_clear_cache();if(fh._is_item_selection_needed()){if(fh.paginating&&!fh._are_all_selected_items_fetched()){fh._wait_for_items()}else{fh.set_selection_from_fq_paths_or_index(cl)}}if(!k.shown()){return fh.set_title()}}})(this);by(document).trigger(this.BEFORE_UPDATE_EVT,{ns_id:e9,ns_path:C.decode(fe)});new Ajax.DBRequest(T,{allow_retries:true,subject_user:cl.active_user,parameters:fb,log_timing:true,on304:function(fh){},onSuccess:(function(fh){return function(fn){var fl,fi,fq,fj,fm,fp,fk,fo;if(fh.in_search_mode()){return}fq=JSON.parse(fn.responseText);fp=null;fm=null;fc(fq);if(fp){fj=[];for(fk=0,fo=fp.length;fk<fo;fk++){fl=fp[fk];fj.push(cl.find_file(fl.fq_path))}eM.set_selected_files(fj);window.scrollTo(fm[0],fm[1])}else{cl.set_selection_from_item_counters()}if(cl.sharing_autoselect_first_file_enabled&&!eM.has_selected_files()){fi=fh.files[0];return eM.set_selected_files([fi])}}})(this),onFailure:(function(fh){return function(){if(fh.first_load){fh.reload.bind(fh).defer(Constants.root_ns,"")}return clearTimeout(fh.folder_loading_timeout)}})(this),cleanUp:(function(fh){return function(){fh.first_load=false;return fh.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return cl.inside_shared_folder&&cl.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return cl.inside_team_folder&&cl.containing_ns_path()},is_shmodelable_path:function(T){var e7;if(cl.public_app_token){return false}if(T===""){return false}if(cl.public_folder_enabled){e7=T.toLowerCase();if(e7.startsWith("/public/")){return false}}return true},can_show_preview:function(T){var e7;return this.browser_supports_previews||((e7=T.preview_type)==="photo"||e7==="video")},can_get_details_from_fq_path:function(e8){var e7,T;e7=this.containing_fq_path();T=this.containing_mount_point();return(T&&e8.startsWith(T))||e7.startsWith(e8)},details_from_fq_path:function(e9){var fa,e7,T,e8;cC(this.can_get_details_from_fq_path(e9));e7=this.containing_mount_point();if(e7&&e9.startsWith(e7)){T=this.containing_ns_id();e8=e9.slice(e7.length);fa=au.filename(e9,this._get_root_name())}else{T=Constants.root_ns;e8=e9;fa=au.filename(e9,this._get_root_name())}return{ns_id:T,ns_path:e8,fq_path:e9,folder_name:fa||this._get_root_name(),url:String(e4.browse_uri_for_fq_path(cl.active_user,e9)),icon:(e9.length?"folder_32":this._get_root_icon())}},update_header_status:function(T){return by("#browse-header-status").text(T)},update_header_height:function(){var e7,e9,e8,T;e9=by("#browse-header");e7=by("#browse-files");T=0;if(e9.css("position")==="fixed"){T=by(window).scrollTop()}if(!y.is_page_scrollable()){T=Math.abs(parseFloat(by("html").css("top"))||0)}e8=e9.offset().top+e9.height()-e7.offset().top-T;return e7.css("padding-top",e8)},_make_breadcrumbs_data:function(){var fb,fc,e7,fa,T,e9,e8;fc=this.containing_fq_path();fb=[];T=fc.split("/");for(e7=e9=0,e8=T.length;0<=e8?e9<e8:e9>e8;e7=0<=e8?++e9:--e9){fa=au.normalize(T.slice(0,e7+1).join("/"));fb.push(this.details_from_fq_path(fa))}return fb},_get_root_icon:function(){if(!cD.get_viewer().is_paired){return"glyph"}if(cl.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(cl.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cD.get_root_name(cl.active_user)},_get_max_breadcrumb_width:function(e9){var e7,e8,T;e8=e9?this._DROPDOWN_WIDTH:new bO(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){e7=by("#browse-rightmenu").width();T=by("#browse-global-actions-bar").width();return((T-e7)*this._FUDGE_FACTOR/this._PX_TO_EM)-e8}else{return this._MAX_BREADCRUMB_WIDTH-e8}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var ff,e7,e9,fg,fc,fe,T,fh,fd,e8,fa,fb;e7=this._make_breadcrumbs_data();e8=e7.collect(function(fi){return new bO(fi.fq_path?fi.folder_name:"").length});fd=0;e9=0;cC(e7.length>0,"expected at least one breadcrumb");fh=this._get_max_breadcrumb_width();for(fc=fa=fb=e7.length-1;fb<=0?fa<=0:fa>=0;fc=fb<=0?++fa:--fa){fd+=e8[fc];if(fd>fh){break}e9+=1;fd+=this._CONNECT_WIDTH}fg=e7.slice(0,e7.length-Math.max(1,e9));e7=e7.slice(fg.length,e7.length);if(!fg.length&&e7.length>1){e7.shift()}fe=e7.pop();ff=e2.tmpl("breadcrumb_tmpl",{breadcrumbs:e7,dropdown:fg,containing_fq_path:this.containing_fq_path(),url_root:e4.get_browse_root(cl.active_user),root_name:this._get_root_name(),Sprite:cp});T=fe.folder_name;if(fe.fq_path!==""){T=bO.em_snippet(T,this._get_max_breadcrumb_width(fg.length>1))}$("browse-location").__date(ff);$("browse-location").__sert(" "+T);if(fg.length>1){return this._render_breadcrumbs_dropdown(fg)}},_render_breadcrumbs_dropdown:function(fa){var T,e8,e7,e9;T=$("breadcrumbs-box");fa.reverse();e7=e2.tmpl("breadcrumb_li_tmpl",{breadcrumbs:fa,Sprite:cp,Emstring:bO});$("browse-location").__sert(e7);e8=$("breadcrumb-dropdown");e9=function(fc){var fb;fc.stopPropagation();e8.show();fb=by(T);return by(e8).clonePosition(fb,{setWidth:0,setHeight:0,offsetTop:fb[0].offsetHeight,offsetLeft:parseInt(fb.css("padding-left"),10)})};T.observe("click",e9);T.observe("dragover",e9);return document.observe("click",function(){T.removeClassName("down");return e8.hide()})},viewportOffset:function(){var T,e8,e7;if(!this.files.length){return}if(!this.div_parent){e8=this.files[0].get_div().offsetParent;if(!e8){return}this._viewportOffset={};this.div_parent=$(e8);this._cumulativeOffset=this.div_parent.cumulativeOffset()}T=dX.scrollLeft(this.div_parent);e7=dX.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==e7||this.scrollLeft!==T){this._viewportOffset.top=this._cumulativeOffset.top-e7;this._viewportOffset.left=this._cumulativeOffset.left-T;this.scrollLeft=T;this.scrollTop=e7}return this._viewportOffset},selectable:function(){return dX.enableSelection($("browse-files"))},unselectable:function(){return dX.disableSelection($("browse-files"))},_header_offset:(function(){var T;T=$("browse-header");return T.getHeight()+T.cumulativeOffset().top}).cached(1000),scrollTo:function(T){return this.scrollToWithPadding(T,3)},scrollToWithPadding:function(e9,fb){var e8,fc,e7,fa,T;if(!e9){return}fa=y.viewport_dimensions();T=y.scroll_offsets();fc=e9.cumulativeOffset().top-T.top;e8=e9.getHeight();e7=this._header_offset();if(fc<e7){y.scroll_to(0,T.top+fc-e7-fb)}else{if(fc+e8>fa.height){y.scroll_to(0,T.top+fc+e8-fa.height+fb)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return eY.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(T){this._visible_change_callbacks[this._next_visible_change_callback_id]=T;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(T){return delete this._visible_change_callbacks[T]},fire_visible_change_callbacks:function(){var e8,fc,e9,fb,fa,T,e7;if(!by.isEmptyObject(this._visible_change_callbacks)){fa=a0.get_files_in_view(),fb=fa[0],e8=fa[1];T=this._visible_change_callbacks;e7=[];for(e9 in T){fc=T[e9];e7.push(fc(this.files,this.active_user.id,fb,e8))}return e7}}};i=A.BrowseUpdate=(function(){var T,fd,fc,e9,fb,fa,e8,e7;e8=function(ff){var fg,fh,fe;if(!cl.inside_dir){return}fh=ff.parent_changes;if(fh.change_to_fq_path!=null){if(fh.change_type==="moved"){if(fh.is_changing_view){fg=er("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");fg=fg.format(fh.old_fq_path.escapeHTML(),dX.urlquote(fh.new_fq_path))}else{fg=er("This folder has been moved")}}else{if(fh.change_type==="renamed"){if(fh.is_changing_view){fg=er("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");fg=fg.format(fh.old_fq_path.escapeHTML(),dX.urlquote(fh.new_fq_path))}else{fg=er("This folder has been renamed to '%s'.");fe=fh.change_to_fq_path.split("/");fg=fg.format(fe[fe.length-1].escapeHTML())}}else{fg=er("The folder '%s' has been deleted.");fg=fg.format(fh.old_fq_path.escapeHTML())}}if(fh.is_changing_view){aa.error(new e2(fg))}else{if(fh.old_fq_path===cl.containing_fq_path()){aa.success(new e2(fg))}}cl.reload_fqpath(fh.change_to_fq_path);return}return fa(ff)};e7=function(fj){var ff,fm,fl,fe,fo,fk,fh,fn,fi,fg;fm=[];fk=[];if(!cl.in_search_mode()){return}b3.clear_cache();for(fe in cl.ns_id_to_mount_point){if(!(fe in fj.mount_points)){fj.mount_points[fe]=null}}fi=fj.mount_points;for(fe in fi){fl=fi[fe];fe=parseInt(fe,10);fo=cl.ns_id_to_mount_point[fe];if(fl===fo){continue}if(fl){cl.ns_id_to_mount_point[fe]=fl}else{delete cl.ns_id_to_mount_point[fe]}fg=cl.files;for(fh=0,fn=fg.length;fh<fn;fh++){ff=fg[fh];if(ff.fq_path.indexOf(fo)===0&&ff.target_ns!==fe){if(fl){ff.fq_path=fl+ff.fq_path.slice(fo.length);ff.href=e4.get_browse_root(cl.active_user)+fl+ff.href.slice(5+fo.length);fm.push([ff,ff])}else{fk.push(ff)}}}}return fa(fj,[],fk,fm)};fa=function(fB,fm,fv,fl){var fq,fk,fw,fr,fu,fn,ft,fs,fy,fo,fh,ff,fe,fx,fA,fz,fp,fj,fi,fg;if(fm==null){fm=[]}if(fv==null){fv=[]}if(fl==null){fl=[]}fp=fB.added;for(fh=0,fx=fp.length;fh<fx;fh++){fw=fp[fh];fk=au.normalize(au.parent_dir(fw.ns_path));if(cl.in_search_mode()||(fw.ns_id===cl.containing_ns_id()&&fk===cl.containing_ns_path())){fq=a0.make_browsefile(fw);fq.track_in_browse();fm.push(fq)}}fj=fB.removed;for(ff=0,fA=fj.length;ff<fA;ff++){fr=fj[ff];fv.push(cl.find_file(fr))}fi=fB.moved;for(fe=0,fz=fi.length;fe<fz;fe++){fg=fi[fe],fu=fg[0],fo=fg[1];fy=au.normalize(au.parent_dir(fo.ns_path));fs=null;ft=cl.in_search_mode()||(fo.ns_id===cl.containing_ns_id()&&fy===cl.containing_ns_path());fn=cl.in_search_mode()&&b3.sparky_search_ui_enabled;if(ft&&!(fn&&cl.find_file(fo.ns_path))){fs=a0.make_browsefile(fo);fs.track_in_browse()}fl.push([cl.find_file(fu),fs])}document.fire(bx.ADD,{files:fm});by(document).trigger(bx.ADD,{files:fm});document.fire(bx.MOVE,{files:fl});a0.load_visible_thumbs();cl.fire_visible_change_callbacks();return fb(fm,fv,fl)};T=function(fh,ff,fg,fe){fh.css("background","");by(document).trigger("db:browse:update_rendered");return document.fire(bx.REMOVE,{files:fg})};fb=function(fo,fn,fp){var fg,fr,fl,fs,fk,fj,fh,fq,ff,fe,fm,fi;fl=(fo.length+fn.length)<=10;for(fk=0,fq=fo.length;fk<fq;fk++){fg=fo[fk];if(!(fg&&fg.get_div())){continue}fd(fg,fl,fo,fn,fp)}for(fj=0,ff=fn.length;fj<ff;fj++){fg=fn[fj];if(!(fg&&fg.get_div())){continue}e9(fg,fl,fo,fn,fp)}fi=[];for(fh=0,fe=fp.length;fh<fe;fh++){fm=fp[fh],fr=fm[0],fs=fm[1];if(fr){e9(fr,fl,fo,fn,fp)}if(fs){fi.push(fd(fs,fl,fo,fn,fp))}else{fi.push(void 0)}}return fi};fc=function(fe){var ff;ff=eM.is_selected(fe)?"#83B8DC":"#CCEAFF";return by(fe.get_div()).css("background-color",ff)};e9=function(fe,fh,fg,fi,ff){var fj;fc(fe);fj=by(fe.get_div());if(fh){return fj.show().slideUp("normal",function(){return T(fj,fg,fi,ff)})}else{fj.hide();return T(fj,fg,fi,ff)}};fd=function(fe,fh,fg,fi,ff){var fj;fc(fe);fj=by(fe.get_div());if(fh){return fj.hide().slideDown("normal",function(){return T(fj,fg,fi,ff)})}else{fj.show();return T(fj,fg,fi,ff)}};return{init:function(){var ff,fe;fe=d0[cl.active_user.id];return ff=fe.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fo,fj,fl,fn,fk,fp,fi,fh,fg,fm;fp=cl.in_search_mode();fo=fp?e7:e8;fg=fp?"/update/list_search":"/update/list_dir";if(!(cl.inside_dir||fp)){fe.handler_failure(ff);return}if(fp){fh=b3.get_state();if(fh.is_advanced){fk=fh}else{fk={all_terms:fh.query}}}else{fk={fq_dir:cl.containing_fq_path(),show_deleted:cl.deleted_shown}}fk.ns_map=((function(){var fr,fq;fr=fe.get_ns_map();fq=[];for(fn in fr){fi=fr[fn];fq.push(""+fn+"_"+fi)}return fq})()).join(",");cC(cl.active_user,"No active_user was set before calling "+fg+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);fm=cl.subscribe_sfj_callbacks;for(fl in fm){fj=fm[fl];fj()}return new by.ajax(fg,{data:fk,dataType:"json",type:"POST",subject_user:cl.active_user,success:function(fq){fo(fq);return fe.handler_success(ff,{ns_map:fq.ns_map})},error:function(){return fe.handler_failure(ff)}})}})}}})();var aB;aB=A.FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",COMPRESS:"db:compress",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add",FILE_ACTIVITY_UPDATE:"db:file_activity_update"};var d4;d4=A.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(T,fa){var e9,e8,e7;if(T.async_task_id){if(!T.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}e8=T.async_task_id}else{e8=T.job_id}d4.job_info[e8]={};e9=d4.job_info[e8];e9.subject_user=T.subject_user||((e7=T.parameters)!=null?e7[Constants.UID_PARAM_NAME]:void 0);e9.req=T;e9.is_async_task=!!T.async_task_id;e9.poll_int=d4.INIT_POLL_INT;e9.poll_count=0;e9.int_id=setInterval(d4.update_for(e8),e9.poll_int);e9.failures=0;e9.start_time=bY.time();return e9.dont_hide=fa},update_for:function(T){return function(){return d4.update(T)}},backoff:function(e7){var T;T=d4.job_info[e7];clearInterval(T.int_id);T.poll_int=Math.min(Math.floor(T.poll_int*1.5),30000);return T.int_id=setInterval(d4.update_for(e7),T.poll_int)},update:function(e8){var T,e7;e7=d4.job_info[e8];if(db.peek(e8)){return d4.done(e8)}e7.poll_count++;if(e7.poll_count%10===0){d4.backoff(e8)}if(!e7.modaled&&bY.time()-e7.start_time>d4.MODAL_WAIT_MS){T=e7.req.options;es.show(T.progress_text);T.onProgress=es.update;if(T.on_modal_shown!=null){T.on_modal_shown()}e7.modaled=true}if(e7.is_async_task){return d4.get_async_task_status(e8)}else{return d4.get_job_status(e8)}},get_job_status:function(T){return new Ajax.DBRequest("/job_status/"+T,{method:"post",subject_user:d4.job_info[T].subject_user,onSuccess:function(e8){var e9,e7;e9=d4.job_info[T];e7=e8.responseText;if(e7.indexOf("err")===0){d4.done(T);if(e9.req.options.onFailure&&!db.handled(T)){e9.req.options.onFailure(e8)}return}if(e7.indexOf("done")===0){e9.req.options.job=false;if(!db.peek(T)){new Ajax.Request("/job_results/"+T,{method:"post",parameters:{t:bq.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(fb){if(db.handled(T)){return}ak.clearWorkingMessage();if(e9.req.options.onSuccess){return e9.req.options.onSuccess(fb)}},onFailure:function(fb){if(db.handled(T)){return}ak.clearWorkingMessage();if(e9.req.options.onFailure){return e9.req.options.onFailure(fb)}}})}return d4.done(T)}else{try{if(e9.req.options.onProgress){return e9.req.options.onProgress(e8.responseText)}}catch(fa){}}},onFailure:function(e7){var e8;e8=d4.job_info[T];e8.failures++;if(e8.failures>=d4.FAILS_MEAN_FAIL){if(e8.req.options.onFailure){e8.req.options.onFailure(e7,true)}ak.remove(e8.req);return d4.done(T)}}})},get_async_task_status:function(T){return new Ajax.DBRequest("/async_task_status/"+T,{method:"post",subject_user:d4.job_info[T].subject_user,onSuccess:function(e8){var e9,e7;e9=d4.job_info[T];e7=e8.responseText;if(e7.indexOf("done:")===0||e7.indexOf("err:")===0){db.handled(T);ak.clearWorkingMessage();if(e7.indexOf("done:")===0){e8.responseText=e7.substr(5)}if(e9.req.options.onSuccess){e9.req.options.onSuccess(e8)}if(e9.req.options.onComplete){e9.req.options.onComplete(e8)}return d4.done(T)}else{if(e7.indexOf("async_task_err:")===0){aa.error(new e2(e7.substr(15)));db.handled(T);ak.clearWorkingMessage();d4.done(T);return cl.force_reload()}else{try{if(e9.req.options.onProgress){return e9.req.options.onProgress(e8.responseText)}}catch(fa){}}}},onFailure:function(e7){var e8;e8=d4.job_info[T];e8.failures++;if(e8.failures>=d4.FAILS_MEAN_FAIL){try{if(e8.req.options.onFailure){e8.req.options.onFailure(e7,true)}}catch(e9){}ak.remove(e8.req);return d4.done(T)}}})},done:function(e7){var T;T=d4.job_info[e7];clearInterval(T.int_id);if(!T.dont_hide){delete d4.job_info[e7];if(!(T.req.async_task_id&&T.req.async_task_id!==e7)){return es.hide(e7)}}else{return es.update("1/1")}}};var di,bS,bw,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};bw=A.NamespaceEvents=(function(){function T(e7){this.ns_id=e7;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return T})();di=A.EventDatePicker=(function(){function T(e8){var e7,e9,fa;this.on_change=e8;by(document.body).on("click",(function(fb){return function(fc){return fb.hide_calendar(fc)}})(this));fa=new Element("div",{id:"cal_container"});by(fa).bind("click",function(fb){return fb.preventDefault()});by(document.body).append(fa);this.calendar=new E("cal_container",{onDateChange:(function(fb){return function(fc){return fb.on_change(fc)}})(this),disable_future:true});by(fa).css("position","fixed");e9=by("#cal_date");e7=by("#cal_container");e7.clonePosition(e9,{setWidth:false,setHeight:false,offsetTop:e9.height(),offsetLeft:e9.width()-e7.children().first()[0].offsetWidth});this.hide_calendar()}T.prototype.show_calendar=function(e7){if(this.shown){by("#cal_container").hide();this.shown=false;return}by("#cal_container").show();return this.shown=true};T.prototype.hide_calendar=function(e7){if(e7&&by(e7.target).closest("#cal_date").length>0){return}by("#cal_container").hide();this.shown=false;return true};return T})();bS=INLINE_JS.Events=A.Events={ns:null,role:"all",now:Number(new Date()),timestamp:dX.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(T,fb,fd,e8,fc){var e9,fa,e7;if(fc==null){fc=false}e7=eu.deconstruct_url();this.first_event_map=T;this.roles=fb;this.rss_data=fd;this.role_has_events=e8;this.deletions_only=fc;this.role_picker=y.controller(by("#role-selector"));if(this.roles.length===1){this.role=this.roles[0].role}else{if(e7.qargs.role){this.role=e7.qargs.role;this.role_picker.set_state(this.role)}else{if(this.deletions_only){this.role=this.roles[this.roles.length-1].role}}}this.date_picker=new di((function(fe){return function(ff){fe.change_date(ff);fe.set_url();return a5.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(fe){return function(){fe.role=fe.role_picker.get_state();if(fe.ns&&!br(fe.valid_roles()).any(function(ff){return ff.ns_ids.contains(fe.ns.ns_id)})){fe.ns=null;aK.set_selected_by_value(by("#namespace-list")[0],"false")}fe.set_url();return fe.get_more(true)}})(this);bI.set_during_login_callback((function(fe){return function(fg,ff){return window.location.reload()}})(this));by(window).bind("beforeunload",(function(fe){return function(){fe.user_navigated_away=true;return void 0}})(this));if(by("#namespace-list-container")[0]){by("#namespace-list-container")[0].observe("db:change",(function(fe){return function(ff){fe.ns=fe.namespaces[JSON.parse(ff.memo)];fe.set_url();fe.get_more(true);return a5.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}by(window).on("scroll",(function(fe){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-y.viewport_dimensions().height-10);return fe.get_more()}})(this));if(e7.qargs.ns){aK.set_selected_by_value(by("#namespace-list")[0],e7.qargs.ns);this.ns=this.namespaces[e7.qargs.ns]}if(e7.qargs.date){fa=e7.qargs.date.split("-").map(Number);e9=new Date(fa[2],fa[1]-1,fa[0]);this.date_picker.calendar.selected_date=e9;this.change_date(e9)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var e7,fa,fd,fb,e9,e8,fc,T;this.namespaces={};fc=br(this.roles).values();for(fd=0,e9=fc.length;fd<e9;fd++){fa=fc[fd];T=fa.ns_ids;for(fb=0,e8=T.length;fb<e8;fb++){e7=T[fb];this.namespaces[e7]=new bw(e7)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(T){this.timestamp=Number(T)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}by("#cur_date_text").text(K.localize(T));return this.get_more(true)},is_scrolled_down:function(){var T,e8,e7;e7=y.scroll_offsets().top;e8=y.viewport_dimensions().height;T=by("#events").height();return e7+e8+50>=T},get_more:function(e9){var T,e7,e8;if(this.request_in_flight){return}if(br(this.valid_nss()).all(function(fa){return fa.done})){this.render();return}if(!(e9||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();e7=(function(fa){return function(){return br(fa.valid_nss()).map(function(fb){return fb.ns_id}).join(",")}})(this);T=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));e8={page_size:25,ns_ids:e7(),timestamp:T};if(this.deletions_only){e8.deletions_only=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:e8,onSuccess:(function(fa){return function(fn){var fl,fc,fo,fe,fm,fj,fi,fg,fp,fd,fb,fk,fh,ff;fl=JSON.parse(fn.responseText);fa.request_in_flight=false;fk=fl.events;for(fj=0,fp=fk.length;fj<fp;fj++){fc=fk[fj];fc.html=by(fc.html)[0];fm=fc.pkey+" "+(fc.html.textContent||fc.html.innerText);fo=fa.namespaces[fc.ns_id];if(!fo.seen[fm]){fo.events.push(fc);fo.seen[fm]=true;fo.earliest=fc.timestamp}}if(fl.events.length>0){fh=fl.ns_ids;for(fi=0,fd=fh.length;fi<fd;fi++){fe=fh[fi];fa.namespaces[fe].earliest=br(fl.events).map(function(fq){return fq.timestamp}).min()}}fa.render();if(fl.events.last()){fa.get_more()}else{if(br(fl.ns_ids).join(",")!==e7()){fa.get_more()}else{ff=fl.ns_ids;for(fg=0,fb=ff.length;fg<fb;fg++){fe=ff[fg];fa.namespaces[fe].done=true}}}return al.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(fa){return function(){fa.request_in_flight=false;if(!fa.user_navigated_away){return aa.error(er("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return br(this.roles).filter((function(T){return function(e7){return e7.role===T.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return br(this.valid_roles()).map((function(T){return function(e7){return e7.ns_ids}})(this)).flatten().map((function(T){return function(e7){return T.namespaces[e7]}})(this)).uniq()}},earliest:function(){return br(this.valid_nss()).map((function(T){return function(e7){return e7.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=dX.start_of_day(new Date(br(this.valid_nss()).map((function(T){return function(e7){return T.first_event_map[e7.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=dX.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var e8,e9,e7,T;e7=new Date(this.timestamp-this.one_day);e9=this.now-this.timestamp>0;e8={};if(this.ns){e8.ns=this.ns.ns_id}if(this.role!=="all"){e8.role=this.role}if(e9){e8.date=""+(e7.getDate())+"-"+(e7.getMonth()+1)+"-"+(e7.getFullYear())}T=this.deletions_only?"/deleted_files":"/events";return eu.push_state(T,e8)},on_preview_open:function(e7){var T;T=cD.get_viewer().get_user_by_id(e7.user_id);by(document).on("db:filepreview:close",this.on_preview_close);k.show(e7,T);return false},on_preview_close:function(){by(document).off("db:filepreview:close",this.on_preview_close);return document.title=er("Recent events - Dropbox")},render:function(){var T,fm,fo,fn,fg,fp,ff,fs,fk,e8,fe,fi,fd,fj,fl,e7,fc,fa,e9,fq,fr,fh,fb;if(this.role_has_events[this.role]){this.update_calendar_first_day()}T=br(this.valid_nss()).map((function(ft){return function(fu){return fu.events}})(this)).flatten();fm=this.earliest();e7=br(T).sortBy(function(ft){return -ft.timestamp});fg=br(e7).filter((function(ft){return function(fu){return fu.timestamp>=fm&&fu.timestamp<ft.timestamp/1000&&(ft.ns!==null||!fu.is_dup)}})(this));if(this.role_has_events[this.role]){by("#event-table").empty();for(fa=0,fq=fg.length;fa<fq;fa++){fe=fg[fa];fo=by(fe.html);fi=br(this.valid_roles()).filter((function(ft){return function(fu){return fu.ns_ids.contains(fe.ns_id)}})(this)).map((function(ft){return function(fu){return fu.name}})(this)).join(" & ");if(this.deletions_only){fo.find("span.role-path").text(fi)}else{fo.find("span.role-label > span").text(fi)}by("#event-table").append(fo);if(fe.preview_jsinfo!=null){fn=fe.preview_jsinfo;ff=fo.find("#prev_link");ff.on("click",this.on_preview_open.bind(this,fn));fl=fo.find(".inline-button");fl.on("click",this._inline_share_button.bind(this,fn))}}by("#events-container").show();by("#events-sub-header").show();by("#events-sub-header").css("visibility","visible");by("#events-empty-state").hide();by(".empty-explanation").hide()}else{if(!this.request_in_flight){by("#events-container").hide();by("#events-sub-header").hide();by("#events-empty-state").show();by(".empty-explanation").show()}}if(!this.request_in_flight){by("#more-loading").hide()}else{by("#more-loading").show()}by("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fh=by("#namespace-list > li");for(e9=0,fr=fh.length;e9<fr;e9++){fp=fh[e9];e8=br(this.valid_roles()).map((function(ft){return function(fu){return fu.ns_ids}})(this)).flatten().any((function(ft){return function(fu){return fu===by(fp).data("value")}})(this));fk=by(fp).data("value")===false;fc=fk||e8;by(fp).css("display",fc?"":"none")}fj=bE.call((function(){var fw,fu,ft,fv;ft=this.valid_roles();fv=[];for(fw=0,fu=ft.length;fw<fu;fw++){fs=ft[fw];fv.push(fs.ns_ids.length>1)}return fv}).call(this),true)>=0;if(!this.request_in_flight){if(fj){by("#namespace-list-container").css("visibility","visible");by("#namespace-list-container").show()}else{by("#namespace-list-container").hide()}fd=this.rss_data[(fb=this.ns)!=null?fb.ns_id:void 0]||this.rss_data[this.role];if(fd&&this.role_has_events[this.role]){by("#rss-feed a").attr("data-title",fd.title);by("#rss_url").val(fd.url);by("#reset-rss-link").on("click",(function(ft){return function(fu){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:fd.ns_id},onSuccess:function(){aa.success(er("RSS feed url successfully reset."));return bV.redirect("/events")}});return false}})(this));by("#rss_url").focus();by("#rss-feed").show();return by("#rss-feed").css("visibility","visible")}else{return by("#rss-feed").hide()}}},show_rss_modal:function(){var T,e7;eY.show(er("Subscribe to this RSS feed"),by("#rss-modal")[0]);e7=by("#rss_url").val();T=p.clipboard_overlay(e7,by("#real_copy"),function(){aa.success(er("Link copied to clipboard!"));return eY.hide()},by(".modal-buttons"));return T.css({zIndex:1001})},_inline_share_button:function(e7,e9){var T,e8;e9.preventDefault();T="events_table_row";e8=a5.ShmodelUILogger.get_target_item(e7);a5.ShmodelUILogger.log("single_entry_share",T,e8);return new c8(e7.user_id,e7.fq_path,T).show()}};var K;K=A.DateUtil={fromSecondsSinceEpochUTC:function(T){var e7;e7=new Date(1970,0,1);e7.setSeconds(T);return e7},applyTimezoneOffset:function(e7,e9){var T,e8;T=parseInt(e9,10);e8=60*(e9-T);e7.setHours(e7.getHours()+T);return e7.setMinutes(e7.getMinutes()+e8)},contextualFormat:function(e7){var e9,fb,T,e8,fa;T=new Date(Date.now());e8=(T.getTime()-e7.getTime())/1000;e9=0;if(e8<8*3600){return bY.ago(e7)}this.applyTimezoneOffset(T,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(e7,Constants.TIMEZONE_OFFSET);fa=new Date(Date.now());this.applyTimezoneOffset(fa,Constants.TIMEZONE_OFFSET);fa.setDate(fa.getDate()-1);if(e7.getYear()===T.getYear()&&e7.getMonth()===T.getMonth()&&e7.getDate()===T.getDate()){fb=er("Today %(time)s");return fb.format({time:K.format(e7,Constants.time_format)})}else{if(e7.getYear()===fa.getYear()&&e7.getMonth()===fa.getMonth()&&e7.getDate()===fa.getDate()){fb=er("Yesterday %(time)s");return fb.format({time:K.format(e7,Constants.time_format)})}else{return K.format(e7,Constants.datetime_format)}}},toUTCDate:function(T){return new Date(T.getUTCFullYear(),T.getUTCMonth(),T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds(),T.getUTCMilliseconds())},differenceStr:function(e9,fc){var fe,fd,e7,e8,fa,T,fb;fa=(e9.getTime()-fc.getTime())/1000;if(fa<60){return a6("%d sec","%d secs",fa).format(fa)}else{if(fa<3600){e7=parseInt(fa/60,10);return a6("%d min","%d mins",e7).format(e7)}else{if(fa<86400){fd=parseInt(fa/3600,10);return a6("%d hour","%d hours",fd).format(fd)}else{if(fa<2592000){fe=parseInt(fa/(60*60*24),10);return a6("%d day","%d days",fe).format(fe)}else{if(fa<4838400){T=parseInt(fa/(60*60*24*7),10);return a6("%d week","%d weeks",T).format(T)}else{if(fa<31536000){e8=parseInt(fa/(60*60*24*30),10);return a6("%d month","%d months",e8).format(e8)}else{fb=parseInt(fa/(60*60*24*365),10);return a6("%d year","%d years",fb).format(fb)}}}}}}},localize:function(T){cC(Constants.date_format!=null,"Date format missing.");return K.format(T,Constants.date_format)},format:function(T,e7){var e8;cC(typeof e7==="string","Date format requires a format string");e8={yy:(function(e9){return function(){return T.getFullYear().toString().substring(2)}})(this),yyyy:(function(e9){return function(){return T.getFullYear().toString()}})(this),M:(function(e9){return function(){return(T.getMonth()+1).toString()}})(this),MM:(function(e9){return function(){return(T.getMonth()+1).toString().lpad(2)}})(this),d:(function(e9){return function(){return T.getDate().toString()}})(this),dd:(function(e9){return function(){return T.getDate().toString().lpad(2)}})(this),h:(function(e9){return function(){return(T.getHours()%12||12).toString()}})(this),H:(function(e9){return function(){return T.getHours().toString()}})(this),HH:(function(e9){return function(){return T.getHours().toString().lpad(2)}})(this),m:(function(e9){return function(){return T.getMinutes().toString()}})(this),mm:(function(e9){return function(){return T.getMinutes().toString().lpad(2)}})(this),a:(function(e9){return function(){if(T.getHours()>11){return er("PM",{comment:"PM as in evening"})}else{return er("AM",{comment:"AM as in morning"})}}})(this)};return e7.replace(/([a-zA-Z]+)/g,function(e9){if(e8[e9]!=null){return e8[e9]()}else{return e9}})}};var eG;eG=INLINE_JS.Timezone=A.Timezone={check_timezone:function(){var T;if(!cD.get_viewer().is_signed_in){return}T=eG.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==T){return eG.update(T)}},get_current_timezone:function(){var e9,e8,T,e7;e8=new Date();e8.setSeconds(0);e8.setMilliseconds(0);e7=e8.toGMTString();e9=new Date(e7.substring(0,e7.lastIndexOf(" ")));T=(e8-e9)/(1000*60*60);return T},update:function(T){cC(typeof T==="number","Timezone offset was not a number: "+T);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:T},noAutonotify:true})},update_timezones_dropdown:function(e7,e9){var e8,T;if(e9==null){e9=null}T=eG.timezones_by_country[e7];by("#timezone_id").empty();return by("#timezone_id").append((function(){var fc,fb,fa;fa=[];for(fc=0,fb=T.length;fc<fb;fc++){e8=T[fc];fa.push(by('<option value="'+e8.id+'">'+e8.name+"</option>").prop("selected",e8.id===e9))}return fa})())},auto:function(){var T;T=$F("timezone_auto");if(T){return by("#tz").hide()}else{if(eG.default_country){by("#timezone_country").val(eG.default_country);eG.update_timezones_dropdown(eG.default_country)}return by("#tz").show()}},load_data:function(e7,T){eG.timezones_by_country=e7;return eG.default_country=T}};var bb,bD;bD=A.CreateApp={init:function(e9,e7){var e8,fa,T;this.accepted_tos_by_uid=e9;this.form=e8=by("#create-app-form");this.email_verification=null;if(!cD.get_viewer().is_paired){T=cD.get_viewer().get_users()[0];this.select_user(T.id)}fa=(function(fb){return function(fc){var fd;fd=fc.target.name;return e8.find("input[name="+fd+"]").each(function(){by(this).parents("label").removeClass("active");return e8.removeClass(by(this).data("next"))})}})(this);e8.find("input[type=radio]").change(function(fb){fa(fb);by(fb.target).parents("label").addClass("active");return e8.addClass(by(this).data("next"))});e8.find("input[type=checkbox]").change(function(fb){var fc;if(by(this).filter("#accept-tos").length){return}by(fb.target).parents("label").toggleClass("active");fc=e8.find("input[name="+(by(this).attr("name"))+"]:checked");e8.toggleClass(by(this).data("next"),fc.length!==0)});e8.find(".role-choice input").change((function(fb){return function(fd){var fc,fe;fc=e8.find(".role-choice input:checked");fe=fc.val();if(!cD.get_viewer().is_uid_signed_in(fe)){fc.prop("checked",false);fa(fd);bI.show_modal({user_id:fe,on_success:function(){return fc.prop("checked",true).trigger("change")}});return false}else{return fb.select_user(fe)}}})(this));e8.find("input:checked").trigger("change");e8.find("input[name=tos_accept]").change((function(fb){return function(fc){return fb.update_submit_enabled()}})(this));e8.find("#send-verify-email, #resend-verify-email").click((function(fb){return function(fc){fb.email_verification.send_email(e7,function(){e8.addClass("verify-email-sent");fb.email_verification.flash_email_sent_notification();return fb.email_verification.ensure_polling(function(){if(!fb.email_verification.user.is_email_verified){return}e8.addClass("email-verified");e8.removeClass("verifiy-email-sent");return fb.update_submit_enabled()})});return false}})(this));return e8.submit(function(fb){e8=by(fb.target);bN.ajax_submit(e8[0],false,(function(fc){return window.location.href=fc.responseText}));return false})},select_user:function(T){this.email_verification=dV.get_for_user(cD.get_viewer().get_user_by_id(T));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[T]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var e7,T;T=this.email_verification.user;e7=this.accepted_tos_by_uid[T.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!e7)}};bb=INLINE_JS.Apps=A.Apps={init_apps:function(){return by("#show-disabled-apps").click(function(){by(this).parent().hide();by("#disabled-apps").show();return false})},init_app_info:function(e7,e8,T){this.user_email=T;by("#app-info .icon-container").each(function(fa,fb){var e9;e9=by(fb);return e9.append(Dropbox.createChooseButton({success:function(fc){e9.find(".icon").attr("src",fc[0].thumbnailLink);return e9.find("input[type=hidden]").val(fc[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=e2.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=e2.tmpl("webhook_info_row_tmpl");by("#domain-list").on("click",".img-container",function(e9){bb.remove_domain(e9.currentTarget.parentNode,e7)});by("#oauth-uri-list").on("click",".img-container",function(e9){bb.remove_oauth_uri(e9.currentTarget.parentNode,e7)});by("#webhook-list").on("click",".img-container",function(e9){bb.remove_webhook(e9.currentTarget.parentNode,e7)});by("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(e9){bb.update_webhook_url(e9.currentTarget,e7,false)});by("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(e9){bb.update_webhook_url(e9.currentTarget,e7,true)});by("#generate-token-button").on("click",function(e9){bb.generate_access_token(e7)});by("#delete-app-button").on("click",function(e9){bb.confirm_disable(e8,e7,0)});by("#webhook_url").on("click change paste focus",function(e9){by("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return by("#oauth2-allow-implicit-grant").on("change",function(e9){return bb.set_oauth2_allow_implicit_grant(e9.currentTarget,e7)})},init_app_info_add_redirect_uri:function(){var T,e7,e8,e9;e7=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!e7){return}e9=window.decodeURIComponent(e7[1]);T=by("#oauth-add-uri-form");by("input[name=oauth_uri]",T).val(e9);e8=by("#add-redirect-uri-modal")[0];by("#add-redirect-uri-modal-uri").text(e9);eY.show(er("Add OAuth redirect URI"),e8,{doit:function(){var fa;if(window.history&&window.history.replaceState){fa=window.location.href;fa=fa.substring(0,fa.indexOf("#"));window.history.replaceState({},document.title,fa)}else{window.location.hash=""}eY.hide();return bb.submit_new_oauth_uri(by("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(T){this.ds_info=T;if(cD.get_viewer().is_paired){this.role_picker=y.controller(by("#role-selector"));this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bI.set_during_login_callback((function(e7){return function(e9,e8){return e7.app_datastores_browse_reload_info(function(){return e8()},function(){e8("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(e7,T){by.ajax({url:"/developers/apps/datastores/info",success:(function(e8){return function(e9){e8.ds_info=e9;e8.app_datastores_browse_render();return typeof e7==="function"?e7():void 0}})(this),error:(function(e8){return function(e9){return typeof T==="function"?T(e9):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var e8,e7,T,e9;e7=by("#no_apps_container").empty();if(by("#apps_developed_container").children().length!==0||by("#apps_used_container").children().length!==0){return}e8=by("<div class='empty-state'></div>").appendTo(e7);switch((e9=this.role_picker)!=null?e9.get_state():void 0){case dT.PERSONAL:case dT.WORK:T=cD.get_viewer().get_user_by_role(this.role_picker.get_state());return e8.append("You don't have any datastores in your "+cD.get_role_title(T)+" Dropbox.");default:return e8.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(fd){var e7,fc,e9,fb,fa,e8,T;fb=this.app_datastores_browse_get_id_info(fd);fc=by(fd);fc.empty();e7="";for(e8=0,T=fb.length;e8<T;e8++){e9=fb[e8];if(this.app_datastores_should_render(e9.uid)){e7+=e9.html}}if(e7){fc.append(this.app_datastores_browse_get_id_header(fd));fa=by("<div class='app-list clearfix'/>").appendTo(fc);return fa.html(e7)}},app_datastores_should_render:function(e7){var T;if(this.role_picker!=null){T=cD.get_viewer().get_user_by_id(e7);return this.role_picker.is_role_visible(T.role)}else{return true}},app_datastores_browse_get_id_info:function(T){switch(T){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cC(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(T){switch(T){case"#apps_developed_container":return by("<h2>Apps you develop</h2>");case"#apps_used_container":return by("<h2>Apps you use</h2>");default:return cC(false,"invalid ds group id")}},generate_access_token:function(e7){var e9,e8,T;T=this;e9=by("#generate-token-button");e8=by("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");e9.replaceWith(e8);return by.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:e7},dataType:"json",success:function(fb){var fa;if(fb.status==="ok"){fa=by("<div>").append(by("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(fb.token));fa.append(by("<div>").addClass("detail-text").text(fb.warning))}else{if(fb.status==="error"){fa=by("<div>").addClass("detail-text").addClass("error").text(fb.msg)}}return e8.replaceWith(fa)},error:function(){return aa.error("Unable to complete your request.")}})},confirm_disable:function(e9,e8,e7){var fa,T;fa=(e7?er("Are you sure you want to disable '%(app_name)s'?"):er("Are you sure you want to delete '%(app_name)s'?"));dj.fillVal(fa.format({app_name:e9.escapeHTML()}),"app-disable-text");eY.show((e7?er("Confirm disable"):er("Confirm delete")),$("app-disable-modal"));T="/developers/disable_app/"+e8;$("app-disable-modal").down("form").action=T;return $("disable-app-button").setValue((e7?er("Disable"):er("Delete")))},enable_app:function(e7){var T;T="/developers/enable_app/"+e7;return window.location.href=T},show_uninstall:function(fb,fa,e8,e7,e9,T){var fc;if(fb){Event.stop(fb)}eY.vars={app_id:e8,user_id:T};fc=by("#delete-"+e7+"-app-confirm");if(e7==="sandbox"){if(!e9){bb.do_uninstall();return}by(".app_folder",fc).text(e9)}by(".app_name",fc).text(fa);eY.show(er("Remove %(app_name)s?").format({app_name:bO.em_snippet(fa,22)}),fc[0],eY.vars);return null},do_uninstall:function(){var T;T=eY.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eY.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(e7){var e8;aa.success(e7.responseText);e8=by(".apps-"+T);by("#inst-app-"+eY.vars.app_id+"-row",e8).hide().removeClass("active_app");if(by(".active_app",e8).length===0){e8.hide()}if(by(".active_app").length===0){by("#empty-explanation").text(er("You have no apps linked to your Dropbox."));return by("#applications-explanation",e8).remove()}},subject_user:T});return eY.hide()},enable_users_in_dev:function(T,e7){new Ajax.DBRequest("/developers/enable_users_in_dev/"+T,{onSuccess:function(e8){eY.show(er("Limit raised to %d users").format(e7),$("increased-dev-user-limit-modal"));by("#users-in-dev-none, #users-in-dev-some").hide();return by("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(T){eY.show(er("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+T,{onSuccess:function(e7){by("#current-app-users-1, #current-app-users-2").text("0");return eY.hide()}})}});return false},unlink_all_teams_in_dev:function(T){eY.show(er("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return by.ajax({url:"/developers/unlink_all_teams/"+T,type:"POST",success:function(e7){by("#current-app-teams").text("0");return eY.hide()}})}});return false},restore_sandbox:function(e7,e9,T){var fb,e8,fa;fb=by("#restore-sandbox")[0];eY.show(er("Restore app folder '%(filename)s'").format({filename:bO.em_snippet(au.filename(e9),17)}),fb);fa=by("#restore-sandbox-form")[0];e8={ns_id:T};e8[Constants.UID_PARAM_NAME]=e7.id;return bN.add_vars(fa,e8)},submit_restore_sandbox:function(e7){var T;T=$("restore-sandbox-form");bN.ajax_submit(T,false,(function(e8){eY.hide();aa.success(er("Restored app folder"));if(e8.responseText.length){return cl.reload_fqpath(e8.responseText)}else{return cl.reload("","",true)}}),false,e7.target);return false},submit_app_info:function(T){var e7;e7=by(T).find("input[name=name]").val();bN.clear_errors(T);return bN.ajax_submit(T,false,(function(){aa.success("App info updated.");if(e7){return by("#app-info h1").text(e7)}}))},submit_folder_name:function(T){var e7;e7=by(T).find("input[name=folder]").val();bN.clear_errors(T);return bN.ajax_submit(T,false,(function(){aa.success("App folder name updated.");by("#folder-name .text").text(e7);return bb.hide_folder_input()}))},submit_new_webhook:function(e7){var e8,fi,fg,fb,fe,fd,fh,ff,e9,T,fc,fa;fi=by(e7);fe=by("#webhook-list");fb=by("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");fg=fi.find("input[name=webhook_url]");e9=function(fk,fj){if(fj){fj.remove()}if(fe.find(".hoverable-url").length===0){fe.addClass("hide-status")}by("#webhook-form-error").text(fk);return by("#webhook-form").addClass("error")};fh=fg.val();if(fh===""){e9("Empty URI");return}ff=C.parse(fh);if((fc=ff.scheme)!=="http"&&fc!=="https"){e9("URI scheme must be http or https");return}if(!ff.authority){e9("Improperly formatted URI (typo maybe?)");return}if(((fa=ff.authority)==="localhost"||fa==="127.0.0.1")||ff.authority.indexOf("[::1]")===0){e9("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(fe.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){e9("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}e8=by(this._webhook_info_row_tmpl({url:fh,status:"Verifying"}).toHTML());e8.find(".status").append(fb);e8.find(".webhook-actions").removeClass("disabled").addClass("enabled");fe.append(e8);fe.removeClass("hide-status");by("#webhook-form").removeClass("error");fd=bN.collect_form_vars(e7);fg.val("");T=new Date().getTime();return by.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:fd,success:function(fl){var fj,fk;if(fl.status==="invalid"){e9(fl.failure_text,e8);return fg.val(fh)}else{fk=new Date().getTime()-T;fj=Math.max(0,1000-fk);return setTimeout((function(){if(fl.status==="ok"){return e8.find(".status").text("Enabled")}else{if(fl.status==="error"){e8.find("textarea").text(fl.failure_text);e8.find(".status").text(fl.status_text).addClass("error");e8.find(".timestamp").text("Just now");return e8.find(".webhook-failure-info").css("display","")}}}),fj)}},error:function(){aa.error("Unable to complete your request.");e8.remove();return fg.val(fh)}})},remove_webhook:function(e8,e7){var e9,T;by("#webhook-form").removeClass("error");T=by(e8).find(".value").text();e9=by("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");by(e8).find(".status").text("Removing").removeClass("error").append(e9);return by.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:e7,webhook_url:T},dataType:"json",success:function(fc){var fa,fb;fa=e8.parentNode;fb=fa.parentNode;fb.removeChild(fa);if(fb.getElementsByClassName("hoverable-url").length===0){by(fb).addClass("hide-status")}if(!by("#webhook_url").val()){return by("#webhook_url").val(T)}},error:function(){return aa.error("Unable to complete your request.")}})},update_webhook_url:function(fb,e9,e8){var fc,T,fa,fd,e7;e7=by(fb.parentNode.parentNode).find(".value").text();by("#webhook-form").removeClass("error");fa=fb.parentNode.parentNode.parentNode;fc=by("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");T=by(fa).find(".status").text();e8=T==="Disabled";fd=e8?"Enabling":"Disabling";by(fa).find(".status").text(fd).removeClass("error").append(fc);return by.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:e9,webhook_url:e7,enable:e8},dataType:"json",success:function(ff){var fe;T=by(fa).find(".status").text();fe=T==="Disabling"?"Disabled":"Enabled";by(fa).find(".status").text(fe).removeClass("error").removeClass("img");if(T==="Disabling"){return by(fa).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return by(fa).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(fe){return aa.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(e7,T){return by.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:T,allow:by(e7).val()},dataType:"json",success:function(e8){return aa.success("OAuth 2 allow implicit grant updated.")},error:function(){return aa.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(e7){var T;T=by(e7).find("input[name=oauth_uri]").val();bN.clear_errors(e7);return bN.ajax_submit(e7,false,(function(){aa.success("OAuth URI added.");bb.add_oauth_uri(T);return by(e7).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(e7){var T;T=by("#oauth-uri-list");T.append(this._hoverable_tmpl({value:e7}).toHTML());return T.show()},remove_oauth_uri:function(e7,T){var e9,e8;e9=by(e7).find(".value").text();e8=function(fb){var fa;aa.success("OAuth URI removed.");fa=e7.parentNode;fa.removeChild(e7);if(fa.getElementsByTagName("div").length===0){return fa.hide()}};return by.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:T,oauth_uri:e9},dataType:"json",success:e8,error:function(){return aa.error("Unable to complete your request.")}})},submit_new_domain:function(T){var e7;e7=by(T).find("input[name=domain_name]").val();bN.clear_errors(T);return bN.ajax_submit(T,false,(function(){aa.success("Domain added.");bb.add_domain(e7);return by(T).find("input[name=domain_name]").val("")}))},add_domain:function(e7){var T;T=by("#domain-list");T.append(this._hoverable_tmpl({value:e7}).toHTML());return T.show()},remove_domain:function(e7,T){var e9,e8;e9=by(e7).find(".value").text();e8=function(fb){var fa;aa.success("Domain removed.");fa=e7.parentNode;fa.removeChild(e7);if(fa.getElementsByTagName("div").length===0){return fa.hide()}};return by.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:T,domain_name:e9},dataType:"json",success:e8,error:function(){return aa.error("Unable to complete your request.")}})},show_need_users_modal:function(T){eY.show(er("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(T){return eY.show(er("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(T){eY.show(er("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(T){eY.show(er("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){by("#folder-name").show();return by("#folder-input").hide()},show_folder_input:function(){by("#folder-name").hide();by("#folder-input").show();return by("#folder-input input[name=folder]").focus()}};var cw,dx;dx=INLINE_JS.twitter_auth_complete=function(T){cC(T!=null,"user_id must be provided");if(cw.onLoginSuccessCallback){cw.onLoginSuccessCallback(T)}else{window.location.reload()}return false};cw=A.Twitter={is_authed:function(T){T=parseInt(T);if(cw._authed_users==null){cw._authed_users={}}return cw._authed_users[T]},set_is_authed:function(T,e7){T=parseInt(T);if(cw._authed_users==null){cw._authed_users={}}return cw._authed_users[T]=e7},get_progress_container:function(){var T;cC(cw.progress_container,"Twitter is missing progress_container");T=$(cw.progress_container);cC(T,"Missing progress_container elm");return T},follow_dropbox:function(e7,T){var e8;cC(T!=null,"user_id must be provided");if(e7.showWorking){e7.showWorking()}e8=function(){if(e7.onFailure){return e7.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(e9){if(!e9.responseText.startsWith("ok")){return e8()}else{if(e7.onSuccess){return e7.onSuccess()}}},onFailure:function(){return e8()},subject_user:T})},do_auth:function(e9,T){var e8,e7;cC(T!=null,"user_id must be provided");e7=C({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,T).toString();window.open(e7,"twitter_auth","width=800,height=400");e8=function(fa){cw.set_is_authed(fa,true);return typeof e9==="function"?e9(fa):void 0};return cw.onLoginSuccessCallback=e8},show_auth:function(T){if(T){cw.onLoginSuccessCallback=T}return dj.updateFromElm(cw.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(cw.should_hide_modal()){eY.hide()}return cw.get_progress_container().update(dj.fromElm("sharing-progress"))},show_complete:function(e7){var T;T=cw.get_progress_container();T.update(dj.fromElm("sharing-posted"));return cw.show_complete_into(e7,T)},show_complete_into:function(fc,T){var e9,fa,e8,fb,e7;e9="twitter";fb=er("View tweet");e7=void 0;if(fc.startsWith("ok")){e7="http://www.twitter.com/"}else{e7=fc}fa=T.down("#view-post");fa.href=e7;fa.update(fb);e8=cp.make("web",e9);return fa.__sert({top:e8})},post:function(e9,fb,e8,T){var fa,e7;cC(T!=null,"user_id must be provided");cC(e9,"Twitter message is empty");fa={message:e9,from_referrals:cw.from_referrals,from_getspace:cw.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:fa,onSuccess:function(fc){var fd,fe;if(fc.responseText==="login"){cw.onLoginSuccessCallback=function(){return cw.post(e9,null,null,T)};fd=cw.custom_show_auth||cw.show_auth;return fd()}else{if(cw.should_hide_modal()){eY.hide()}fe=cw.onPostSuccessCallback||cw.show_complete;return fe(fc.responseText)}},subject_user:T});e7=cw.custom_show_posting||cw.show_posting;return e7()},custom_post:function(e7,e8,T){cC(T!=null,"user_id must be provided");if(e8){cw.onPostSuccessCallback=e8}if(!e7){return}cC(e7,"Twitter message doesn't exist");if(!cD.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(e7))}else{return cw.post(e7,null,null,T)}},get_user_info:function(e7,T){cC(T!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(e8){return e7(JSON.parse(e8.responseText))},subject_user:T})},should_hide_modal:function(){if(typeof cw.hide_modal==="undefined"){return true}else{return cw.hide_modal}}};var dh,eP,dv,U,eI,am,bA,ah,u,ed,ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9},dl=function(T,e7){return function(){return T.apply(e7,arguments)}};dv=A.LightboxPreviewBase=(function(){function T(e7){this.link_hash=e7.link_hash;this.filename=e7.filename;this.fq_path=e7.fq_path;this.thumbnail_url_tmpl=e7.thumbnail_url_tmpl;this.dl_url=e7.dl_url;this.ns_id=e7.ns_id;this.ns_path=e7.ns_path;this.display_time=e7.display_time||null;this.more_actions_item_tmpl=e2.tmpl("lightbox_more_actions_item_tmpl")}T.prototype.shutdown=function(){};T.prototype.preload=function(){};T.prototype.render=function(){};T.prototype.image_size=function(){var e7;e7=document.viewport.getDimensions();return aA(e7.width,e7.height)};T.prototype.get_more_actions_above_divider=function(e8){var e9,e7;e7=[];e9=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:er("Download"),more_classes:"more-actions-item",Sprite:cp});e7.push(e9);return e7};T.prototype.get_more_actions_below_divider=function(e7){return[]};T.prototype.is_a_timeline_preview=function(){return this instanceof eI||this instanceof dh||this instanceof am||this instanceof eP};T.prototype.is_an_album_preview=function(){return this instanceof eI||this instanceof am};T.prototype.is_a_photo_preview=function(){return this instanceof U};T.prototype.is_a_video_preview=function(){return this instanceof bA};T.prototype.get_actions=function(e9){var fb,fd,fe,e8,fc,e7,fa;e8=[];if(!this.is_a_timeline_preview()&&e9.enable_sublinks){if(e9.share_button_experiment_variant==="WHITE_BUTTON"){fe=by("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){fa=(function(ff){return function(fg){a5.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(C.parse(ff.shmodel_link).updateQuery("m","1"))}})(this)}else{fa=(function(ff){return function(fg){fg.preventDefault();a5.ShmodelUILogger.log("via-browse-lightbox");return dm.shmodel(ff.fq_path,"browse_lightbox")}})(this)}}else{fe=by("<a />",{id:"lightbox_share_link","class":"title_bubble black"});fe.html(cp.make("web","link_white"));if(this.is_a_photo_preview()){fe.attr("title",er("Share link to photo"))}else{if(this.is_a_video_preview()){fe.attr("title",er("Share link to video"))}else{cC(false,"preview needs to be a photo or video")}}if(this.shmodel_link){fe.attr("href",C.parse(this.shmodel_link).updateQuery("m","1"));fe.attr("target","_blank");fa=(function(ff){return function(fg){return a5.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{fe.attr("href","#");fa=(function(ff){return function(fg){fg.preventDefault();a5.ShmodelUILogger.log("via-browse-lightbox");return dm.shmodel(ff.fq_path,"browse_lightbox")}})(this)}}fe.on("click",fa);e8.push(fe[0])}if(e9.include_delete){fc=bK.in_single_collection_view()?er("Remove"):er("Delete");if(e9.share_button_experiment_variant==="WHITE_BUTTON"){fb=by("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");fb.find(".sprite-text-inner").text(fc);fb.on("click",(function(ff){ff.preventDefault();return aE.delete_current()}))}else{fb=by("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:fc});fb.html(cp.make("web","lightbox_delete_16"));fb.on("click",(function(ff){ff.preventDefault();return aE.toggle_delete()}))}e8.push(fb[0])}if(e9.share_button_experiment_variant==="WHITE_BUTTON"){e7=(function(ff){return function(fg){fg.preventDefault();return aE.toggle_more_actions_menu()}})(this);fd=by("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",e7);e8.push(fd[0])}else{cC(aE.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");e8.push(aE.more_actions_button)}return e8};T.prototype.delete_pressed=function(){var e7;e7=er("Deleting...");if(this.is_a_timeline_preview()){if(bK.in_single_collection_view()){e7=er("Removing...");bK.get_current_collection().remove_photos([this.photo])}else{bK._delete_photos([this.photo])}}else{document.fire(aE.PHOTO_DELETE_EVT,this)}return aa.success(e7)};T.prototype.set_more_actions_event_handlers=function(e7){};T.prototype.replace_dl_action_with_open_action_if_file_available=function(){var e8,e9,e7,fa;if(__CONDITIONAL_JS__.UnityFeatures==null){return}e7=cl.active_user.id;e9=(function(fb){return function(fc,ff,fd){var fg,fe;fg=by("#lightbox_download_link");if(!(fg.data("ns-id")===fc&&fg.data("ns-path")===ff)){return}fe=by(fb.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:fc,_ns_path:ff,sprite_name:"lightbox_open",item_text:er("Open"),more_classes:"more-actions-item",Sprite:cp}).toHTML());fg.replaceWith(fe);return fe.on("click",function(fh){return __CONDITIONAL_JS__.UnityFeatures.open_file(fc,ff,fd,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fi){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((fa=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fa.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return e9(this.ns_id,this.ns_path,e7)}else{e8=(function(fb){return function(fc){if(fc.is_locally_available){return e9(fb.ns_id,fb.ns_path,e7)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,e7,e8)}};return T})();U=INLINE_JS.PhotoPreview=A.PhotoPreview=(function(e7){cG(T,e7);function T(e8){T.__super__.constructor.call(this,e8);this.original_url=String(C.parse(e8.original_url).updateQuery(Constants.UID_PARAM_NAME,cl.active_user));this.shmodel_link=e8.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=e8.enable_download}T.prototype.show_fail=function(e9){var e8;return e8=by(e9).find(".lightbox_fail_text").text(er("Unable to preview this item."))};T.prototype.fallback=function(e9){var e8,fa;e8=$(e9.target);e8.writeAttribute({src:this.fail_image_src,width:128,height:128});fa=e8.up("div.content-item");if(fa){return this.show_fail(fa)}};T.prototype.is_gif=function(){return"gif"===au.file_extension(this.filename).toLowerCase()};T.prototype.preload=function(fa){var e9,fb,e8;e8=C.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){e8=this.thumbnail_url_tmpl}fb=(function(fc){return function(){if(typeof fa==="function"){fa()}return fc.loaded=true}})(this);dX.preload_image(e8,this.fallback.bind(this),fb);e9=$(dX.preloaded_images[e8]);e9.writeAttribute("data-original-href",this.original_url);e9.setAttribute("enable-download",this.enable_download);e9.writeAttribute("class","thumbnail");return e9};T.prototype.render=function(fd,fa){var fb,e9,fc,e8,fe;if(this.loaded){fa()}e9=this.preload(fa);fe=by("<div />",{"class":"content-item"}).append(e9);fb=by("<div />",{"class":"lightbox_fail_text"});fe.append(fb);fc=e9.getAttribute("src").length;e8=e9.getAttribute("src").substring(fc-this.fail_image_src.length,fc);if(e8===this.fail_image_src){this.show_fail(fe)}fd.appendChild(fe[0]);return fe[0]};T.prototype.advance_on_click=true;T.prototype.get_more_actions_above_divider=function(fa){var e9,e8;e8=T.__super__.get_more_actions_above_divider.call(this,fa);e9=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:er("View original"),more_classes:"more-actions-item",Sprite:cp});e8.push(e9);return e8};return T})(dv);bA=A.VideoPreview=(function(T){cG(e7,T);function e7(e8){this._player_error=dl(this._player_error,this);this._player_ready=dl(this._player_ready,this);e7.__super__.constructor.call(this,e8);this.preview_url=e8.preview_url;this.shmodel_link=e8.shmodel_link;this.thumbnail_div=null;this.metadata_link=e8.metadata_link!=null?e8.metadata_link:void 0;this.metadata=null;this.player=null}e7.prototype.render_error=function(fb){var fd,e9,e8,fa,fc;e9=by("<div/>");e8=by("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});fa=by("<div/>",{"class":"video-preview-fail"});if(fb==="needflash"){fa.html(er('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{fa.text(er("Unable to preview this item.",fc="web",fd="preview means showing the item in the same browser window without downloading a copy."))}e9.append(e8,fa);return e9[0]};e7.prototype._player_ready=function(){var e8;e8=function(){by(".vjs-poster").show();by(".vjs-big-play-button").show();return by(".vjs-big-play-button").focus()};return e8.defer()};e7.prototype._onPlay=function(){by(".vjs-poster").hide();return by(".vjs-big-play-button").hide()};e7.prototype._onEnded=function(){by(".vjs-poster").show();by(".vjs-big-play-button").show();return by(".vjs-loading-spinner").hide()};e7.prototype._player_error=function(e8){this.shutdown();this.div=this.render_error(e8);return by("#file-preview-modal .content-item").html(this.div)};e7.prototype.preload=function(){};e7.prototype.render=function(e9,e8){this.div=this.render_video(e9);return this.div};e7.prototype.render_video=function(fe){var e8,fc,fa,e9,fd,fb;fb=new Element("div",{"class":"video-player content-item"});fd=this.image_size().split("x")[0]*0.8;e9=parseInt(fd*0.55,10);fc=false;fa=C.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();e8=(function(ff){return function(fg){return ff.metadata=fg}})(this);this.player=bn.embed(fb,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:fd,height:e9,controls:true,preload:"auto",poster:fa,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:e8});fe.appendChild(fb);by(".vjs-poster").hide();by(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return fb};e7.prototype.shutdown=function(){var e9,e8;by(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((e8=this.player.tech.sourceBuffer)!=null){e8.abort()}}this.player.dispose()}catch(fa){e9=fa}return this.player=null}};return e7})(dv);ah=function(e8){var T,e7;T=(function(fa){cG(e9,fa);function e9(fb){fb.ns_id=fb.photo.ns_id;fb.ns_path=fb.photo.ns_path;e9.__super__.constructor.call(this,fb);this.photo=fb.photo;bi.set_vertical_space(3);if(bK.in_single_collection_view()){by("#lightbox-delete-photo").val(er("Remove"))}else{by("#lightbox-delete-photo").val(er("Delete"))}}e9.prototype.get_more_actions_above_divider=function(fd){var fc,fb;fb=e9.__super__.get_more_actions_above_divider.call(this,fd);fc=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:er("Add to album"),more_classes:"more-actions-item",Sprite:cp});fb.push(fc);return fb};e9.prototype.toggle_select_button_off=function(fb){if(this.is_a_photo_preview()){fb.attr("title",er("Select photo"))}else{if(this.is_a_video_preview()){fb.attr("title",er("Select video"))}}fb.html(cp.make("web","lightbox_unselected"));fb.removeClass("selected");fb.addClass("elbboggiw");return setTimeout((function(){return fb.removeClass("elbboggiw")}),540)};e9.prototype.toggle_select_button_on=function(fb){if(this.is_a_photo_preview()){fb.attr("title",er("Un-select photo"))}else{if(this.is_a_video_preview()){fb.attr("title",er("Un-select video"))}}fb.html(cp.make("web","lightbox_selected"));fb.addClass("selected");fb.addClass("wiggobble");return setTimeout((function(){return fb.removeClass("wiggobble")}),540)};e9.prototype.toggle_select=function(fc){var fb;fc.preventDefault();fb=by("#lightbox-select-button");bi.hide_all();if(eL.contains(this.photo)){eL._remove(this.photo);return this.toggle_select_button_off(fb)}else{eL._add(this.photo);return this.toggle_select_button_on(fb)}};e9.prototype.get_actions=function(fd){var fc,fb,fe;fc=[];fe=by("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aE.update_share_button_text(null,by(fe));fe.on("click",((function(ff){return function(fh){var fg;fh.preventDefault();fg=eL.get();if(fg.length===0){return eq.show([ff.photo],false)}else{return eq.show(eL.get(),false)}}})(this)));fb=by("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:er("Select this photo")});if(eL.contains(this.photo)){fb.html(cp.make("web","lightbox_selected"))}else{fb.html(cp.make("web","lightbox_unselected"))}fb.on("click",this.toggle_select.bind(this));fc.push(fe[0]);fc.push(fb[0]);return fc.concat(e9.__super__.get_actions.call(this,fd))};e9.prototype.set_more_actions_event_handlers=function(fb){$("lightbox_add_to_album").observe("click",((function(fc){return function(fd){fd.preventDefault();return cz.show_add_to_album_modal(fd,[fc.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(fc){return function(fd){fd.preventDefault();return bK.show_in_folder(fc.photo)}})(this)));return e9.__super__.set_more_actions_event_handlers.call(this,fb)};e9.prototype.get_more_actions_below_divider=function(fd){var fc,fb;fc=[];fb=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:er("Show in folder"),more_classes:"more-actions-item",Sprite:cp});fc.push(fb);fc=fc.concat(e9.__super__.get_more_actions_below_divider.call(this,fd));return fc};return e9})(e8);e7=(function(fa){cG(e9,fa);function e9(){return e9.__super__.constructor.apply(this,arguments)}e9.prototype.get_more_actions_below_divider=function(fd){var fb,fc;fc=[];fb=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:er("Remove from album"),more_classes:"more-actions-item",Sprite:cp});fc.push(fb);fc=fc.concat(e9.__super__.get_more_actions_below_divider.call(this,fd));return fc};e9.prototype.set_more_actions_event_handlers=function(fb){$("lightbox_remove_from_album").observe("click",((function(fc){return function(fd){fd.preventDefault();return cz.show_remove_photos_modal(bK.get_current_collection(),[fc.photo])}})(this)));return e9.__super__.set_more_actions_event_handlers.call(this,fb)};return e9})(T);return[T,e7]};u=ah(U),dh=u[0],eI=u[1];ed=ah(bA),eP=ed[0],am=ed[1];var aE;aE=INLINE_JS.Lightbox=A.Lightbox=(function(){var fr,fp,fX,fW,fJ,ff,e7,fw,fF,f1,e9,fV,fe,fE,fQ,fm,fP,fB,fK,f0,fl,fC,fj,fO,fS,fd,fR,fc,fu,fU,fo,fD,fg,fx,fL,fy,fH,fa,fq,T,fG,fT,fZ,fN,fn,ft,fb,fs,fI,e8,fh,fM,fz,fA,fk,fv,fi,fY;fW=[];fr=0;fJ=false;fX=true;fz=void 0;e7=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;ff=false;fU=void 0;fQ=void 0;fI=-1;e8=null;fK=null;fC=false;T=false;fd=false;fj=null;fl=function(f2){return f2.complete!==false};fb=function(){var f2;if($$("#file-preview-modal .loading-image").length){return}f2=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(f2)};fB=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fy=function(){var f8,f7,f4,f2,f6,f5,f3;f7=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!f7||!fl(f7)){return}f2=$$("#file-preview-modal .preview").first().getDimensions();f8=void 0;if(!f7.naturalHeight){f8=f7.getDimensions();f7.naturalHeight=f8.height;f7.naturalWidth=f8.width}else{f8={width:f7.naturalWidth,height:f7.naturalHeight}}f4=f8.width/f2.width;f3=f8.height/f2.height;f5=Math.max(f4,f3);f7.style.visibility="";if(f5<1){f7.style.width="";f7.style.height=""}else{f7.style.width=Math.floor(f8.width/f5)+"px";f7.style.height=Math.floor(f8.height/f5)+"px"}f6=by("#file-preview-modal .paging-block").position().left-16;return by("#file-preview-modal .filename").css("max-width",f6)};fE=void 0;fR=function(){var f9,f4,f8,f7,f6,f3,f5,f2;f4=$("file-preview-modal");f7=f4.down(".menu");f8=f4.down(".header");f5=$$(".lightbox-not-important");f2=[];for(f6=0,f3=f5.length;f6<f3;f6++){f9=f5[f6];f2.push(f9.addClassName("opacity-zero"))}return f2};fs=function(){var f6,f5,f3,f4,f2;if(fE){clearTimeout(fE)}f4=$$(".lightbox-not-important");f2=[];for(f5=0,f3=f4.length;f5<f3;f5++){f6=f4[f5];f2.push(f6.removeClassName("opacity-zero"))}return f2};fH=function(f3){var f2;fs();f2=f3&&$(f3.target).descendantOf("file-preview-menu");if(fE!=null){clearTimeout(fE)}if(fX){if(!ff&&!f2){return fE=setTimeout(fR,3112)}}};fM=function(){if(fE!=null){clearTimeout(fE)}return fX=false};fh=function(){fX=true;return fH()};f0=function(f3){var f2;f2=fW.length;return(f2+(fr+f3)%f2)%f2};fD=function(f3){var f2,f4;if(fU.no_preload){return}f2=fn.bind(null,f3);return typeof(f4=fW[f3]).preload==="function"?f4.preload(f2):void 0};fg=function(){var f4,f6,f3,f5,f2;f5=[1,2,3,4,5,6,-1,-2];f2=[];for(f6=0,f3=f5.length;f6<f3;f6++){f4=f5[f6];if(Math.abs(f4)<fW.length){f2.push(fD(f0(f4)))}else{f2.push(void 0)}}return f2};fq=function(f2){if(!fU.filename_in_url){return}if(f2!=null){aX.replace_hash("lh",f2)}else{aX.replace_hash("")}return fj=f2};fL=function(){var f2,f3;f2=by("#file-preview-modal");f3=(fU!=null?fU.num_previews:void 0)||fW.length;if(fC&&T&&fd){f2.find(".lightbox-index-text-container").text(er("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fC){if(T){f2.find(".lightbox-index-text-container").text(er("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{f2.find(".lightbox-index-text-container").text("")}}else{f2.find(".lightbox-index-text-container").text(er("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fr+1,num_total_files:f3}))}}if(fW.length===1){f2.find(".prev").addClass("opacity-zero");return f2.find(".next").addClass("opacity-zero")}else{if(fr===0&&fU.no_wrap){f2.find(".prev").addClass("opacity-zero");return f2.find(".next").removeClass("opacity-zero")}else{if(fr===fW.length-1&&fU.no_wrap){f2.find(".prev").removeClass("opacity-zero");return f2.find(".next").addClass("opacity-zero")}else{f2.find(".prev").removeClass("opacity-zero");return f2.find(".next").removeClass("opacity-zero")}}}};e9=function(f6,f3,f5,f2,f4){var f7;f7={user_id:null,context:f3,platform:aQ.FileViewPlatformType.WEB,ns_id:f6.ns_id,sjid:null,ns_path:f6.ns_path,shared_link_url:f5,extra:{mode:f2,file_ext:f4}};return f7};fG=function(f4,gq){var gf,gg,gh,gm,gb,f5,gd,f6,f8,gi,f2,f9,gp,go,gl,gc,gk,ga,gj,gn,f3,gr,ge,f7;fI=bY.time();cC(fr<fW.length,"Invalid index "+fr);gj=fW[fr];if(typeof gj!=="object"){if(e8){clearTimeout(e8)}e8=setTimeout((function(){if((aE.shown!=null)&&aE.shown){return fG(f4,gq)}}),100);return}by("#file-preview-modal").trigger(aE.LIGHTBOX_SHOW_EVT,{preview:gj});f5=au.file_extension_for_logging(gj.filename);f6=aQ.FileViewModeType.PHOTOS_LIGHTBOX;gd=aQ.FileViewContextType.PRIVATE;f8=null;f9="lightbox";if(gj.fq_path!=null){f6=aQ.FileViewModeType.BROWSE_LIGHTBOX;gd=aQ.FileViewContextType.PRIVATE;f9="browse_lightbox"}else{if(gj.shmodel_link!=null){f6=aQ.FileViewModeType.SHARED_LINK_LIGHTBOX;gd=aQ.FileViewContextType.SHARED_LINK;f8=gj.shmodel_link;f9="shmodel_lightbox"}}gi=e9(gj,gd,f8,f6,f5);a5.FileViewLogger.log(gi);a5.WebLightboxLogger.log(a5.WebLightboxLogger.VIEW,{context:f9,file_ext:f5});go=by("#file-preview-modal");gn=go.find(".preview-content");ga=f4?fN:fn;gn.empty();gb=gj.render(gn[0],ga);go=go[0];if(!fK){fK=go.on("contextmenu","img.thumbnail",bh.show_for_lightbox.bind(bh))}fq(gj.link_hash);fL();if(gj.display_time){if(gj.filename.match(e7)){go.down(".filename").__date(gj.display_time)}else{go.down(".filename").__date(gj.display_time+" - "+gj.filename)}}else{go.down(".filename").__date(gj.filename)}go.down(".filename").writeAttribute("title",gj.filename);if(bK.in_single_collection_view()&&((ge=bK.get_current_collection().member_fnames)!=null?ge.length:void 0)>1&&(((f7=gj.photo)!=null?f7.item_owner_fname:void 0)!=null)){gm="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gm+=er("Added by %(fname)s").format({fname:bO.em_snippet(gj.photo.item_owner_fname,7)});go.down(".added-by").__date(new e2(gm));go.down(".added-by").show()}else{go.down(".added-by").hide()}gc=e2.tmpl("lightbox_more_actions_item_tmpl");gl=gj.get_more_actions_above_divider(fU);gh=gj.get_more_actions_below_divider(fU);if(gh.length){gl.push(gc({divider:true,Sprite:cp}));gl=gl.concat(gh)}$("lightbox-more-actions-list").__date(gl);gj.set_more_actions_event_handlers(fU);if(by(go).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){gj.replace_dl_action_with_open_action_if_file_available()}gg=gj.get_actions(fU);f2=document.createDocumentFragment();for(f3=0,gr=gg.length;f3<gr;f3++){gf=gg[f3];f2.appendChild(gf)}go.down(".actions").__date();go.down(".actions").appendChild(f2);if(fU.share_button_experiment_variant==="WHITE_BUTTON"){gk=by("#lightbox-more-actions-button .sprite-div").width();by("#lightbox-more-actions-menu").css("right",gk/2)}document.fire(aE.ACTIONS_ADDED);if(bK.in_single_collection_view()){go.down(".album-name").show().__date(bO.em_snippet(bK.get_current_collection().name,15,1));go.down(".filename").addClassName("faded")}else{go.down(".album-name").hide();go.down(".filename").removeClassName("faded")}gb=gb.down("img.thumbnail");if(gb){if(!fl(gb)){gb.hide();fb();gb.observe("load",function(){fB();gb.style.visibility="hidden";gb.show();return fy()})}else{gb.show();fy()}}gp={preview_obj:gj,index:fr,direction:gq};return document.fire(aE.PHOTO_CHANGE_EVT,gp)};fZ=function(f7){var f3,f4,f2,f5,f6;if(fI===-1){return}f6=bY.time()-fI;if(typeof g!=="undefined"&&g!==null){f3=g.get_current_view()}else{if(typeof af!=="undefined"&&af!==null?af.is_album:void 0){f3="album_shmodel"}else{f3="not_photos"}}f4={current_view:f3};f2=by("#file-preview-modal .content-item img.thumbnail")[0];if((f2!=null)&&(f2.src!=null)){f5=C.parse(f2.src).getQuery();if("size" in f5){f4.size=f5.size}}d9.log_ajax_transition(f6,f7,f4);fI=-1;return fg()};fN=function(){return fZ("file-preview-lightbox-load-initial")};fn=function(f2){var f3;if(typeof f2==="number"){if((f3=fW[f2])!=null){f3.loaded=true}if(f2===fr){return fZ("file-preview-lightbox-load")}}else{return fZ("file-preview-lightbox-load")}};fT=function(f2){var f3;f3=by("#lightbox-click-catcher");if(!f3.length){f3=by("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});f3.appendTo("#file-preview-modal .modal-preview-content");if(bV.msie_version_at_most(10)){f3.css("background","black");f3.fadeTo(0,0)}}f3.off("click");f3.on("click",(function(f4){f4.preventDefault();return f2()}));return f3.show()};fm=function(){return by("#lightbox-click-catcher").hide()};f1=function(){var f2;f2=by("#lightbox-more-actions-button");if(f2.hasClass("toggled")){fm();f2.removeClass("toggled");$("lightbox-more-actions-menu").hide();by(document).trigger("dropdownClosed",[1]);fh();return true}return false};fu=function(){var f2;f2=by("#lightbox-more-actions-button");if(!f2.hasClass("toggled")){fP();f2.addClass("toggled");bi.hide_all();by("#lightbox-more-actions-menu").show();by(document).trigger("dropdownOpened",[1]);fM();return fT(aE.close_more_actions_menu)}};fk=function(){if(by("#lightbox-more-actions-button").hasClass("toggled")){return f1()}else{return fu()}};fc=function(f3){var f2;if(fC){T=true;fL()}f1();if(f3){f3.preventDefault()}if(fr===fW.length-1&&fU.no_wrap){return}if((f2=fW[fr])!=null){f2.shutdown()}fr=f0(1);if(fr===0){fH()}return fG(null,aE.NEXT)};fx=function(f3){var f2;if(fC){T=true;fL()}f1();if(f3){f3.preventDefault()}if(fr===0&&fU.no_wrap){return}if((f2=fW[fr])!=null){f2.shutdown()}fr=f0(-1);return fG(null,aE.PREV)};fF=function(f2){if(f2){f2.preventDefault()}if(fW[fr].advance_on_click){if(f2.clientX<by(window).width()/10){return fx()}else{return fc()}}};fV=function(f8){var f5,f4,f7,f9,f6,f3,f2;f5=fW.dict_by("fq_path");f9=void 0;if(f8.memo.files){f9=f8.memo.files.collect(function(ga){return ga.fq_path})}else{f9=f8.memo.fq_paths}f2=[];for(f6=0,f3=f9.length;f6<f3;f6++){f7=f9[f6];if(f5[f7]){f4=fW.indexOf(f5[f7]);fW.splice(f4,1);if(fU.num_previews){fU.num_previews--}if(!fU.num_previews&&!fW.length){f2.push(fQ())}else{if(f4===fW.length){f2.push(fx())}else{f2.push(fG())}}}else{f2.push(void 0)}}return f2};fa=function(f2){if(fW[fr].is_a_timeline_preview()){return fW[fr].toggle_select(f2)}};fv=function(){Event.stopObserving(document,"mousemove",fH);Event.stopObserving(document,"click",fH);document.stopObserving(aE.PHOTO_DELETE_EVT,fo);document.stopObserving(aB.DELETE,fV);document.stopObserving(eL.CHANGE_EVT,fi);return clearInterval(fz)};fQ=function(f5){var f3,f4,f2,f6;if(f5){f5.preventDefault()}if(!aE.shown){return}if((f4=fW[fr])!=null){f4.shutdown()}f3=$("file-preview-modal");f3.hide();f3.down(".preview-content").__date();y.scroll_unlock_document();fv();fq();aE.shown=0;f3.stopObserving("click",aE.back);if((f2=$$(".preview-content"))!=null){if((f6=f2.first())!=null){f6.stopObserving("click")}}return by("#file-preview-modal").trigger(aE.LIGHTBOX_HIDE_EVT)};fp="db:filepreview:exitselect";fw=function(f3){var f2;if(fU.keep_url){fQ()}else{if((f2=fW[fr])!=null){f2.shutdown()}window.history.go(-1)}if(f3!=null){if(f3.originalEvent){f3=f3.originalEvent}Event.extend(f3).stop()}return document.fire(fp,fW[fr])};fo=function(f2){return du.do_delete(cl.active_user,f2.memo.fq_path)};fS=function(){var f2;if(!fJ){f2=by("#file-preview-modal");f2.on("click",".close",fw);key("esc",aE.KEY_SCOPE,(function(f3){if(by("#lightbox-more-actions-button").hasClass("toggled")){return f1()}else{if(ff){return fP()}else{return fw(f3)}}}));f2.on("click",".next",fc);f2.on("click",".prev",fx);f2.on("click",".preview-container",fF);key("left, k",aE.KEY_SCOPE,function(f3){return fx()});key("right, j",aE.KEY_SCOPE,function(f3){fc();return false});key("up, down",aE.KEY_SCOPE,function(f3){return false});key("x, s, space",aE.KEY_SCOPE,function(f3){fa(f3);return false});if(fU.include_delete&&fU.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aE.KEY_SCOPE,function(f3){Event.extend(f3).preventDefault();return aE.toggle_delete()});by("#lightbox-delete-photo").on("click",(function(f3){fA();return fW[fr].delete_pressed()}));by("#lightbox-delete-cancel").on("click",fP)}eu.add_exit_callback("/lightbox",function(){return fQ()});dX.disableSelection(f2.find(".preview-container")[0]);dX.disableSelection(f2.find(".header")[0]);fJ=true}Event.observe(document,"mousemove",fH);Event.observe(document,"click",fH);document.observe(aB.DELETE,fV);document.observe(aE.PHOTO_DELETE_EVT,fo);document.observe(eL.CHANGE_EVT,fi);key.setScope(aE.KEY_SCOPE);return fz=setInterval(fy,500)};fO=function(){var f4,f6,f5,f3,f2;if(!fj){return}f2=[];for(f4=f5=0,f3=fW.length;f5<f3;f4=++f5){f6=fW[f4];if(f6.link_hash&&f6.link_hash.toLowerCase()===fj.toLowerCase()){fr=f4;if(!aE.shown){f2.push(aE.show())}else{f2.push(fG())}}else{f2.push(void 0)}}return f2};fY=function(){return on_script_loaded(function(){aX.watch("lh",function(f2){fj=f2;return fO()});return aX.watch("f",function(f4){var f5,f7,f6,f3,f2;f2=[];for(f5=f6=0,f3=fW.length;f6<f3;f5=++f6){f7=fW[f5];if(f7.filename.toLowerCase()===f4.toLowerCase()){fr=f5;if(!aE.shown){f2.push(aE.show())}else{f2.push(fG())}}else{f2.push(void 0)}}return f2})})};fi=function(f6,f8){var f4,f7,f3,f5,f2;if(f8==null){f8=by("#lightbox_share")}f3=eL.get();f5=c0.categorize_files(f3),f4=f5[0],f7=f5[1];if(f3.length===0){f8.text(er("Share"));return(f2=fW[fr])!=null?f2.toggle_select_button_off(by("#lightbox-select-button")):void 0}else{if(f3.length===1){if(f4){return f8.text(er("Share 1 photo"))}else{return f8.text(er("Share 1 video"))}}else{if(f4&&f7){return f8.text(er("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:f3.length}))}else{if(f4){return f8.text(er("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:f3.length}))}else{return f8.text(er("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:f3.length}))}}}}};ft=function(){bi.hide_all();by("#file-preview-modal .delete-file-prompt").show();by(document).trigger("dropdownOpened",[1]);fs();ff=true;fT(aE.toggle_delete);return by("#lightbox-delete-photo").focus()};fP=function(){var f3,f2;if(ff){f3=by("#file-preview-modal .delete-file-prompt");f3.hide();by(document).trigger("dropdownClosed",[1]);if((f2=f3.find(":focus")[0])!=null){f2.blur()}fH();ff=false;return fm()}};fA=function(){f1();if(ff){return fP()}else{return ft()}};fe=function(){return fW[fr].delete_pressed()};return{init_from_preview_objs:function(f5,f9,f4){var f8,f7,f2,f6,f3;if(f4==null){f4=true}f2=[];for(f6=0,f3=f5.length;f6<f3;f6++){f8=f5[f6];if(f8.is_video){f7=new bA({filename:f8.filename,fq_path:f8.path,thumbnail_url_tmpl:f8.thumbnail_url,preview_url:f8.preview_url,dl_url:f8.dl_url,shmodel_link:f8.shmodel_link,ns_id:f8.ns_id,ns_path:f8.path,link_hash:f8.item_id+"-"+f8.filename,metadata_link:f8.metadata_link})}else{f7=new U({filename:f8.filename,fq_path:f8.path,thumbnail_url_tmpl:f8.thumbnail_url,dl_url:f8.dl_url,original_url:f8.orig_url,shmodel_link:f8.shmodel_link,ns_id:f8.ns_id,ns_path:f8.ns_path,link_hash:f8.item_id+"-"+f8.filename,enable_download:f8.enable_download})}f2.push(f7)}aE.init(f2,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:f4});return document.on(aE.EXIT_SELECT_EVT,function(gb){var ga;key.setScope("all");ga=by(f9)[f2.indexOf(gb.memo)];dX.scroll_to_thumb(ga);by(ga).addClass("wiggobble");return setTimeout((function(){return by(ga).removeClass("wiggobble")}),1000)})},init:function(f2,f3){if(aE.shown){return}aE.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:er("More actions")});aE.more_actions_button.observe("click",(function(f4){f4.preventDefault();return aE.toggle_more_actions_menu()}));aE.more_actions_button.__date(cp.make("web","lightbox_more"));f3=f3||{};fU={include_delete:f3.include_delete||false,keep_url:f3.keep_url||false,num_previews:f3.num_previews||null,filename_in_url:f3.filename_in_url||false,no_wrap:(f3.no_wrap||false)||true,no_preload:f3.no_preload||false,enable_sublinks:f3.enable_sublinks!=null?f3.enable_sublinks:true,share_button_experiment_variant:f3.share_button_experiment_variant||false};fC=f3.is_loading||false;cC(!fU.filename_in_url||fU.keep_url,"filename_in_url cannot be used with keep_url off");fW=f2;if(f3.start_index!=null){aE.show(f3.start_index)}if(fU.filename_in_url){fY()}return $(document.body).on("click",".more-actions-item",function(f4,f5){if(f5.down("a").getAttribute("href").length<2){f4.preventDefault()}return aE.close_more_actions_menu()})},update_previews:function(f2){return fW=f2},show:function(f2){var f3,f4;if(aE.shown){return}cC(fW&&fW.length,"Lightbox.show() requires file preview objects to show");fS();if(f2!=null){fr=f2}by("#file-preview-modal").trigger("lightbox-init-show",{preview:fW[fr]});if((f4=fW[fr])!=null?f4.enable_download:void 0){aE.more_actions_button.show()}else{aE.more_actions_button.hide()}cC(!aE.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();y.scroll_lock_document();fG(true);aE.shown=1;if(!fU.keep_url){f3=eu.deconstruct_url(eu.get_url());if(f3.path.indexOf("/lightbox/")!==0){eu.push_state("/lightbox"+f3.path,f3.qargs)}}return fH()},jump_to:function(f2){cC(aE.shown,"Lightbox should be showing");fr=f2;fG();return fH()},set_no_wrap:function(f2){return fU.no_wrap=f2},update_with_error:function(){fd=true;return fL()},num_previews:function(){return fU.num_previews||fW.length},get_previews:function(){return fW},current_index:function(){return fr},close_more_actions_menu:f1,toggle_more_actions_menu:fk,update_share_button_text:fi,toggle_delete:fA,delete_current:fe,back:fw,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fp,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bz;bz=A.Tour=(function(){var e9,e8,fb,fc,fg,fe,ff,fd,fa,fh,e7,T;e8=6;e9=0;e7=function(fi){var fr,fq,fp,fk,fj,fl,fn,fo,fm;$$(".page-end").each(Element.remove);fj=fi;fn=e8-fi-1;fr=document.createDocumentFragment();for(fq=fo=0;0<=fj?fo<fj:fo>fj;fq=0<=fj?++fo:--fo){fk=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fk.style.left=(28-fq*5)+"px";fk.style.zIndex=e8-fq;fr.appendChild(fk)}for(fp=fm=0;0<=fn?fm<fn:fm>fn;fp=0<=fn?++fm:--fm){fl=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fl.style.right=(31-fp*5)+"px";fl.style.zIndex=e8-fp;fr.appendChild(fl)}return $("book").appendChild(fr)};T=function(fi){(fi>0?Element.show:Element.hide)("tour-page-back");return(fi+1<e8?Element.show:Element.hide)("tour-page-forward")};fa=function(fi){$$(".pages").invoke("hide");return $("page-"+fi).show()};fb=function(fi){T(fi);e7(fi);fa(fi);return e9=fi};fd=function(fj){var fi;Event.extend(fj).preventDefault();fi=e9-1;if(fi<0){return}fb(fi);return eu.push_state("/tour/"+fi)};fe=function(fj){var fi;Event.extend(fj).preventDefault();fi=e9+1;if(fi>=e8){return}fb(fi);return eu.push_state("/tour/"+fi)};fh=function(fj,fk){var fi;fj.preventDefault();fi=parseInt(fk.href.split("/").last(),10);fb(fi);return eu.push_state("/tour/"+fi)};fg=function(){$("tour-page-back").observe("click",fd);$("tour-page-forward").observe("click",fe);key("right",fe);key("left",fd);return $("toc").on("click","a",fh)};fc=function(fj,fk){var fi;fi=parseInt(fj,10)||0;if(fi<0||fi>=e8){fi=0}return fb(fi)};ff=function(){var fm,fl,fj,fk,fi;fk=$$(".page-right img");fi=[];for(fl=0,fj=fk.length;fl<fj;fl++){fm=fk[fl];fi.push(dX.preload_image(fm.src))}return fi};return{setup:function(){return by(function(){eu.add_callback("/tour",fc);fg();return ff()})}}})();var bK,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};bK=INLINE_JS.Photos=A.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(fd,e8,fa,fh,fe,e9,e7,ff,fj,T){var fc,fg,fi,fb;this.event_metadata_cache=e7;this._root_collection_gid=T;this.initialized=true;this.disable_selection();dX.disable_ie_image_dragging();this._tmpl=e2.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=e2.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=fe!=null?fe.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=ff.include_shared_folders;this.show_hidden=ff.show_hidden;this.timestamp_edit_enabled=fj.timestamp_edit_enabled;this.undo_enabled=fj.undo_enabled;this.local_storage_enabled=fj.local_storage_enabled;fg=eu.deconstruct_url();fb="share" in fg.qargs;for(fi in fh){if(fh.hasOwnProperty(fi)){eL.inc_num_loading_events_before_select(fb)}}this._init_timeline(fd,e8,fa,fh);this._init_lightbox();fc=[];if(fe!=null){fc.push(new Y(fe,false))}cz.init(fc,e9);eL.drag_select_enabled=fj.drag_select_enabled;if(ff.show_photos_tour){aG.next()}delete fg.qargs.selr;delete fg.qargs.user_email;delete fg.qargs.uid;delete fg.qargs.share;delete fg.qargs.m;if("uuid" in fg.qargs){delete fg.qargs.uuid;delete fg.qargs.id}if(dD){eu.replace_state(fg.path,fg.qargs)}else{if(!C.parse(window.location.href).fragment){eu.push_state("/photos",fg.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aE.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aE.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aE.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aE.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bh.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eu.add_callback("/photos",this._history_change_handler.bind(this));document.observe(c4.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(c4.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(cc.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(cc.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));by("#photos-nav-item").on("click",this.show_all_photos.bind(this));by("#back-to-photos").on("click",this._back_to_photos.bind(this));by("#back-to-albums").on("click",this._back_to_albums.bind(this));by("#share-selected").on("click",this._share_selected.bind(this));by("#clear-selected").on("click",this._clear_selected.bind(this));by("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){by("#do-include-shared-folders").prop("checked",true)}else{by("#dont-include-shared-folders").prop("checked",true)}cz.listen();eL.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return by(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(fd){var e9,fc,e8,fb,e7,fa,T;fc=$(fd.target).up(".cu-month-header").identify().slice(2);e9=this.get_timeline().events.valueFromKey(fc);fa=e9.photos;T=[];for(fb=0,e7=fa.length;fb<e7;fb++){e8=fa[fb];T.push(eL._add(e8))}return T},_share_event:function(fc){var e8,fb,e7,fa,T,e9;fb=$(fc.target).up(".cu-month-header").identify().slice(2);e8=this.get_timeline().events.valueFromKey(fb);e9=e8.photos;for(fa=0,T=e9.length;fa<T;fa++){e7=e9[fa];eL._add(e7)}return this._share_selected()},_add_event_to_album:function(fc){var e8,fb,e7,fa,T,e9;fb=$(fc.target).up(".cu-month-header").identify().slice(2);e8=this.get_timeline().events.valueFromKey(fb);e9=e8.photos;for(fa=0,T=e9.length;fa<T;fa++){e7=e9[fa];eL._add(e7)}return cz.show_add_to_album_modal(fc,eL.get())},_init_timeline:function(fd,e8,e9,ff){var e7,fg,fe,T,fh,fc,fb,fa;if(!fd.length){this.show_empty_state();return}e7=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");fc=$("cu-view").cumulativeOffset().top+e7.getLayout().get("margin-top")+e7.getLayout().get("padding-top");if(by("#carousel-promo-banner").outerHeight()){fc+=by("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}fe=$("cu-view").cumulativeOffset().left+e7.getLayout().get("margin-left")+e7.getLayout().get("padding-left");fg={top_offset:fc,left_offset:fe,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};T={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fh=new cc(e7,null,fd,e8,e9,ff,this._tmpl,fg,T);if(this.in_single_collection_view()){if((fb=this._single_collection_timeline)!=null){fb.unlisten()}this._single_collection_timeline=fh}else{if((fa=this._all_photos_timeline)!=null){fa.unlisten()}this._all_photos_timeline=fh}return this.get_timeline().render()},_init_lightbox:function(){var e7,T;if(this.get_timeline()==null){return}if(aE.shown){T=this.get_timeline().get_preview_objs();if(T.length){aE.update_previews(T);e7=Math.min(aE.current_index(),T.length-1);return aE.jump_to(e7)}else{return aE.back()}}else{return aE.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(e7){var T;if((T=this.get_timeline())!=null){T.unlisten()}eL.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(e7);return window.scrollTo(0,0)},_refresh_photo_events:function(T){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(e7){return function(e8){var e9;e9=JSON.parse(e8.responseText);if(e9==="deleted_collection"){e7._current_collection_gid=null;cz.reload();e7.show_all_collections();aa.error(er("This album has been deleted!"));return}e7._init_timeline(e9.header_ids,e9.header_id_to_name,e9.header_id_to_num_photos,{});e7._init_lightbox();return typeof T==="function"?T():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(T){if(T.duplicates_info!=null){return this._show_duplicates_modal(T,false)}else{return window.open(this._get_browse_link(T),"_blank")}},_get_browse_link:function(e7){var T;T=e4.get_browse_root(cD.get_viewer().photos_user);return String(C({path:""+T+(au.normalize(au.parent_dir(e7.fq_path))),query:{select:e7.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cz.get(this._current_collection_gid)}else{return null}},get_current_collection_gid:function(){return this._current_collection_gid||this._root_collection_gid},enable_selection:function(){return dX.enableSelection($(document.body))},disable_selection:function(){return dX.disableSelection($(document.body))},show_collection:function(e8){var e7,T;g.log_transition_to(cf.SINGLE_COLLECTION_VIEW);T=eu.deconstruct_url();e7="/lightbox";if(T.path.indexOf(e7)===0){T.path=T.path.slice(e7.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(bE.call(T.path,"/album/")<0){if(T.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(e8!=null){T.path=cz.get(e8).url}return eu.push_state(T.path,T.qargs)},show_all_collections:function(){g.log_transition_to(cf.ALBUMS_VIEW);return eu.push_state("/photos/all_albums")},show_all_photos:function(e7){var T;e7.preventDefault();g.log_transition_to(cf.PHOTOS_VIEW);T=eu.deconstruct_url();if(T.path==="/photos"){return this._refresh_view()}else{eL.clear();return eu.push_state("/photos")}},_back_to_photos:function(T){eL.clear();return this.show_all_photos(T)},_back_to_albums:function(T){eL.clear();return this.show_all_collections()},get_thumb_click_event_data:function(e8,T){var e7;e7=e8.event;return{timeline_photo_index:T,event_photo_index:e7.photos.indexOf(e8),num_photos_in_event:e7.photos.length,event_index:this.get_timeline().events.list.indexOf(e7.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(e7){var T;T=this.get_timeline().get_photo_for_thumb_elm($(e7.target));if(eL._drag_drop.ignore_next_click){return eL._drag_drop.ignore_next_click=false}else{return eL.photo_click(e7,T)}},_thumb_double_click:function(e9){var e8,e7,T;e7=this.get_timeline().get_photo_for_thumb_elm($(e9.target));T=this.get_timeline().index_of_photo(e7);this._preview(T);e8=this.get_thumb_click_event_data(e7,T);return g.log_interaction(ee.OPEN_LIGHTBOX,c3.DBL_CLICK,e8)},_thumb_context_menu:function(fb){var e8,fc,fa,e7,e9,T;e8=this.get_timeline().get_photo_for_thumb_elm($(fb.target));if(fb.shiftKey){eL.photo_click(fb,e8);return}if(eL.contains(e8)){fc=eL.get()}else{fc=[e8]}bh.show_photos(fb,fc);T=[];for(fa=0,e7=fc.length;fa<e7;fa++){e8=fc[fa];T.push((e9=this.get_timeline().get_thumb_elm_for_photo(e8))!=null?e9.addClassName("context-selected"):void 0)}return T},_context_menu_hide:function(T){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(e7){var T;T=eL.get();if(!T.length){return}eq.show(T,false);return g.log_interaction(ee.SHARE,c3.SAH,{num_photos:T.length})},_clear_selected:function(e7){var T;T=eL.get().length;eL.clear();return g.log_interaction(ee.CLEAR_SELECTED,c3.SAH,{num_photos:T})},_share_collection:function(e7){var T;cC(this.in_single_collection_view(),"_share_collection can only happen in single collection view");T=this.get_current_collection();if(T.num_items===0){aa.error(er("This album is empty. Add some photos before you share it!"));return}eq.show(this.get_current_collection(),true);return g.log_interaction(ee.SHARE_ALBUM,c3.SCA)},toggle_mem_lane_settings:function(T){var e8,e7;if(T){Event.extend(T).preventDefault()}if(!by("#memory-lane-settings-menu").visible()){e7=by("#memory-lane-settings-menu");eJ.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));e8=function(e9){return e9.stopPropagation()};e7.off("mousedown");e7.off("click");e7.on("mousedown",e8);return e7.on("click",e8)}},show_delete_photos_modal:function(fe){var ff,fb,e8,fc,T,e7,e9,fd,fa;if(fe.length===1){e7=fe[0];if(e7.duplicates_info!=null){this._show_duplicates_modal(e7,true);return}}else{ff=[];for(e9=0,fd=fe.length;e9<fd;e9++){e7=fe[e9];if(e7.duplicates_info!=null){fb=e7.duplicates_info.slice(0);fb.push(e7);fb.sort(function(fh,fg){return fg.mtime-fh.mtime});ff=ff.concat(fb)}}if(ff.length){this._show_delete_multiple_duplicates_modal(fe,ff);return}}fa=c0.categorize_files(fe),fc=fa[0],T=fa[1];if(fc&&T){e8=a6("Delete %(file_count)s item?","Delete %(file_count)s items?",fe.length)}else{if(fc){e8=a6("Delete %(file_count)s photo?","Delete %(file_count)s photos?",fe.length)}else{e8=a6("Delete %(file_count)s video?","Delete %(file_count)s videos?",fe.length)}}return dE.show({title_text:e8.format({file_count:fe.length}),body_html:er("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:c0.file_desc(fe)}),confirm_text:er("Delete"),cancel_text:er("Cancel"),confirm_callback:(function(fg){return function(){return fg._delete_photos(fe)}})(this)})},_delete_photos:function(fl){var fh,ff,e9,fi,T,e7,fk,fe,fc,fb,fj,e8,fd,fa,fg;fl=fl.slice(0);fk=[];for(fc=0,fj=fl.length;fc<fj;fc++){e7=fl[fc];fk.push(e7.fq_path);if(e7.duplicates_info!=null){fd=e7.duplicates_info;for(fb=0,e8=fd.length;fb<e8;fb++){e9=fd[fb];fk.push(e9.fq_path)}}}fa=c0.categorize_files(fl),fi=fa[0],T=fa[1];if(fi&&T){ff=a6("Deleting file","Deleting files",fk.length);fh=a6("Deleted file.","Deleted files.",fk.length)}else{if(fi){ff=a6("Deleting photo","Deleting photos",fk.length);fh=a6("Deleted photo.","Deleted photos.",fk.length)}else{ff=a6("Deleting video","Deleting videos",fk.length);fh=a6("Deleted video.","Deleted videos.",fk.length)}}fg=function(fm){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(fm)},html_in_error_msg:true,progress_text:er("Undoing..."),onSuccess:function(fn){var fo;fo=er("Undo complete");aa.success(fo);return bK._all_photos_timeline.restore_removed_photos()},subject_user:cD.get_viewer().photos_user})};fe=(function(fm){return function(fn){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fk},job:fk.length>bK.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cD.get_viewer().photos_user,progress_text:ff,onSuccess:function(fq){var fo,fr,fp;fr=fq.responseText.evalJSON();fp=bK.undo_enabled&&(bK._all_photos_timeline!=null);fo=fp?fr.changesets:null;S.notifyWithUndo(ff,fo,fg);bK.get_timeline().remove_photos(fl);if(fn.length>0){return cz.refresh_album_views(fn)}},subject_user:cD.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fk)},onSuccess:(function(fm){return function(fp){var fo,fn,fq,fr;fn=JSON.parse(fp.responseText);fq=[];for(fr in fn){fo=fn[fr];fq=fq.concat(fo)}return fe(fq)}})(this)})},_preview:function(T){return aE.show(T)},_lightbox_delete:function(T){var e7;e7=T.memo.photo;g.log_interaction(ee.DELETE,c3.LIGHTBOX);return this.show_delete_photos_modal([e7])},_lightbox_remove:function(e7){var T;T=e7.memo.photo;this.get_current_collection().remove_photos([T]);return g.log_interaction(ee.REMOVE,c3.LIGHTBOX)},_show_duplicates_modal:function(e7,fm){var fe,fl,fc,fg,ff,e9,fi,e8,fd,fh,T,fk,fa,fj,fb;ff=e7.duplicates_info.slice(0);ff.push(e7);ff.sort(function(fo,fn){return fn.mtime-fo.mtime});fg=$("cu-duplicate-files");e9=[];for(fa=0,fj=ff.length;fa<fj;fa++){fc=ff[fa];fl="Dropbox"+au.normalize(au.parent_dir(fc.fq_path));e9.push(this._cu_duplicate_tmpl({thumbnail_url:fc.thumbnail_url,filename_snippet:bO.em_snippet(fc.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bO.em_snippet(fl,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fc)}))}fg.__date(e9);if(ff.length>=5){fg.addClassName("scroll")}else{fg.removeClassName("scroll")}fb=c0.categorize_files([e7]),fh=fb[0],T=fb[1];if(fh){e8=er("There are multiple copies of this photo.");fd=er("Delete all copies of this photo?")}else{e8=er("There are multiple copies of this video.");fd=er("Delete all copies of this video?")}if(fm){fi="delete_32";fk=fd;fe=e8+" "+er("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fi="folder_32";fk=er("Show in folder");fe=e8+" "+er("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}dj.fillVal(fe,"cu-duplicates-desc");return eY.show(fk,$("cu-duplicates-modal"),{action:this._delete_photos.curry([e7])})},_show_delete_multiple_duplicates_modal:function(fj,fe){var fi,fc,ff,e8,e7,fd,fb,fg,T,e9,fh,fa;ff=$("cu-multiple-duplicate-files");e8=[];for(e9=0,fh=fe.length;e9<fh;e9++){fc=fe[e9];fi="Dropbox"+au.normalize(au.parent_dir(fc.fq_path));e8.push(this._cu_duplicate_tmpl({thumbnail_url:fc.thumbnail_url,filename_snippet:bO.em_snippet(fc.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bO.em_snippet(fi,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(fc)}))}ff.__date(e8);if(fe.length>=5){ff.addClassName("scroll")}else{ff.removeClassName("scroll")}fa=c0.categorize_files(fj),fg=fa[0],T=fa[1];if(fg&&T){e7=er("Delete %(num_files)s files and all copies?").format({num_files:fj.length});fd=er("There are multiple copies of these files in your Dropbox.");fb=er("Show files with multiple copies")}else{if(fg){e7=er("Delete %(num_photos)s photos and all copies?").format({num_photos:fj.length});fd=er("There are multiple copies of these photos in your Dropbox.");fb=er("Show photos with multiple copies")}else{e7=er("Delete %(num_videos)s videos and all copies?").format({num_videos:fj.length});fd=er("There are multiple copies of these videos in your Dropbox.");fb=er("Show videos with multiple copies")}}dj.fillVal(fd,"cu-multiple-duplicates-desc");dj.fillVal(fb,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return eY.show(e7,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fj)})},show_timestamps_modal:function(fb){var e7,e8,e9,T,fa;fb.sort_by_key((function(fc){return fc.time_taken}),true);T=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=fb.length;fe<fd;fe++){e9=fb[fe];fc.push(e9.time_taken)}return fc})();e7=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=fb.length;fe<fd;fe++){e9=fb[fe];fc.push(e9.item_counter)}return fc})();e8=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=T.length;fe<fd;fe++){fa=T[fe];if(fa==null){fc.push(fa)}}return fc})();if(e8.length===T.length){return this._show_add_timestamps_modal(fb,T,e7)}else{if(e8.length===0){return this._show_edit_timestamps_modal(fb,T,e7)}else{return cC(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(T,e7){return this._refresh_photo_events((function(e8){return function(){var e9,fa;fa=("m_"+(e7.getFullYear()))+(""+(e7.getMonth()+1)).lpad(2);e9=e8.get_timeline().events.valueFromKey(fa);cC(e9!=null,"Event is missing after a timestamp edit!");es.update("2/3");e9.on_load_all_metadata=function(){e8.get_timeline().scroll_to_photo_with_key(T.uniqueness_key);es.hide();return aa.success("New timestamps have been saved!")};if(e9.has_loaded_metadata()){e9.on_load_all_metadata();return e9.on_load_all_metadata=null}else{return e9.load_metadata()}}})(this))},_show_add_timestamps_modal:function(fa,e7,T){var e9,e8;e8=by("#add-timestamp-modal");e9=new E("date_picker",{disable_future:true});return eY.show("Set Timestamps",e8[0],{action:(function(fb){return function(){var ff,fj,fh,fi,fd,fe,fg,fc;fh=dX.to_iso8601_date(e9.selected_date,false,true);fi=(function(){var fm,fl,fk;fk=[];for(fe=fm=0,fl=fa.length;0<=fl?fm<fl:fm>fl;fe=0<=fl?++fm:--fm){fk.push(fh)}return fk})();fd={};for(ff=fg=0,fc=T.length;fg<fc;ff=++fg){fj=T[ff];fd[fj]=fi[ff]}es.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fd)},onSuccess:function(fk){es.update("1/3");return fb._scroll_to_photo_after_timestamp_edit(fa[0],e9.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(fe,fd,e9){var T,fc,e8,fa,fb,e7;fc=by("#edit-timestamp-modal");T=(function(){var fh,fg,ff;ff=[];for(fh=0,fg=fd.length;fh<fg;fh++){fa=fd[fh];ff.push(K.toUTCDate(new Date(fa)))}return ff})();e8={year:0,month:0,day:0,hour:0};fb=function(ff){return er("%(date)s at %(time)s").format({date:K.localize(ff),time:K.format(ff,Constants.time_format)})};e7=function(ff,fj,fk,fi){var fh,fg;if(ff==null){ff=0}if(fj==null){fj=0}if(fk==null){fk=0}if(fi==null){fi=0}e8.year+=ff;e8.month+=fj;e8.day+=fk;e8.hour+=fi;fg=bY.increment_date(new Date(T[0]),e8.year,e8.month,e8.day,e8.hour,0);fh=bY.increment_date(new Date(T[T.length-1]),e8.year,e8.month,e8.day,e8.hour,0);if(fe.length===1){return fc.find("#timestamp-new").text(fb(fg))}else{fc.find("#timestamp-new-start").text(fb(fg));return fc.find("#timestamp-new-end").text(fb(fh))}};if(fe.length===1){fc.find("#edit-timestamp-single").show();fc.find("#edit-timestamp-multi").hide();fc.find("#timestamp-current").text(fb(T[0]))}else{fc.find("#edit-timestamp-single").hide();fc.find("#edit-timestamp-multi").show();fc.find("#timestamp-current-start").text(fb(T[0]));fc.find("#timestamp-current-end").text(fb(T[T.length-1]))}e7();by("#timestamp-year-plus").on("click",e7.curry(1,0,0,0));by("#timestamp-year-minus").on("click",e7.curry(-1,0,0,0));by("#timestamp-month-plus").on("click",e7.curry(0,1,0,0));by("#timestamp-month-minus").on("click",e7.curry(0,-1,0,0));by("#timestamp-day-plus").on("click",e7.curry(0,0,1,0));by("#timestamp-day-minus").on("click",e7.curry(0,0,-1,0));by("#timestamp-hour-plus").on("click",e7.curry(0,0,0,1));by("#timestamp-hour-minus").on("click",e7.curry(0,0,0,-1));eY.onHide=function(){var ff,fi,fg,fh;fh=["year","month","day","hour"];for(fi=0,fg=fh.length;fi<fg;fi++){ff=fh[fi];by("#timestamp-"+ff+"-plus").off("click");by("#timestamp-"+ff+"-minus").off("click")}eY.onHide=null;return eY.hide()};return eY.show("Edit Timestamps",fc[0],{action:(function(ff){return function(){var fp,fm,fg,fh,fn,fr,fo,fk,fq,fl,fj,fi;if((((e8.year===(fi=e8.month)&&fi===(fj=e8.day))&&fj===(fl=e8.hour))&&fl===0)){return}g.log_interaction(ee.EDIT_TIMESTAMP,c3.PCM,{num_photos:fe.length});fh=(function(){var fu,ft,fs;fs=[];for(fu=0,ft=T.length;fu<ft;fu++){fp=T[fu];fs.push(bY.increment_date(fp,e8.year,e8.month,e8.day,e8.hour,0))}return fs})();fn=(function(){var fu,ft,fs;fs=[];for(fu=0,ft=fh.length;fu<ft;fu++){fr=fh[fu];fs.push(dX.to_iso8601_date(fr,false,true))}return fs})();fo={};for(fm=fk=0,fq=e9.length;fk<fq;fm=++fk){fg=e9[fm];fo[fg]=fn[fm]}es.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fo)},job:fe.length>ff.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cD.get_viewer().photos_user,onSuccess:function(fs){es.update("1/3");return ff._scroll_to_photo_after_timestamp_edit(fe[0],fh[0])}})}})(this)})},_preload_file_previews:function(e9){var ff,fd,e8,T,fk,fj,fg,fe,fh,fc,fb,fi,e7,fa;fh=this.get_timeline().get_photos();if(e9[0]<=e9[e9.length-1]){fe=null;for(fc=0,fi=e9.length;fc<fi;fc++){fd=e9[fc];T=fh[fd];if(T.status!==G.PLACEHOLDER){continue}fk=T.event;if(fe==null){fe=fk;fg=T}if(fk===fe){continue}if(fe.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}fe.load_metadata();fe=fk;fg=T}if((fe!=null)&&!fe.has_loaded_metadata()){ff=fe.photos.indexOf(fg);e8=fe.photos.indexOf(T);if(fe.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return fe.load_metadata_range(ff,e8)}}else{fa=[];for(fb=0,e7=e9.length;fb<e7;fb++){fd=e9[fb];T=fh[fd];if(T.status!==G.PLACEHOLDER){continue}fk=T.event;fj=fk.photos.indexOf(T);fa.push(fk.load_metadata(fj))}return fa}},_lightbox_photo_change:function(fe){var T,fg,fb,ff,fc,fa,fd,e9,e8,e7;this._last_lightbox_photo=fe.memo.preview_obj.photo;T=fe.memo.index;fb=aE.num_previews();if(T===0||T===fb-1){return}if(fe.memo.direction===aE.NEXT||(fe.memo.direction==null)){fg=Math.min(T+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,fb-1);return this._preload_file_previews((function(){e8=[];for(var fh=fd=T+1;fd<=fg?fh<=fg:fh>=fg;fd<=fg?fh++:fh--){e8.push(fh)}return e8}).apply(this))}else{if(fe.memo.direction===aE.PREV){ff=Math.max(T-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){e7=[];for(var fh=e9=T-1;e9<=ff?fh<=ff:fh>=ff;e9<=ff?fh++:fh--){e7.push(fh)}return e7}).apply(this))}}},_lightbox_exit:function(T){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var e8,e7,e9,T;e7=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(by("#carousel-promo-banner").outerHeight()){e7+=by("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}e8=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((e9=this._all_photos_timeline)!=null){e9.update_offsets(e7,e8)}return(T=this._single_collection_timeline)!=null?T.update_offsets(e7,e8):void 0},_history_change_handler:function(fj,fi){var fe,ff,fg,fb,e9,fc,fh,fd,fa,e8,e7,T;if(this._init_finished){if(eY.shown()){eY.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((fd=this.get_timeline())!=null){fd.unlisten()}if(fj==="all_albums"){cz.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((fa=$("all-albums-sidebar"))!=null){fa.addClassName("selected")}eL.clear();document.title=er("Albums")+" - Dropbox";cz.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fj.startsWith("album/")){fe=cz.get_from_url("/photos/"+fj);e8=$$(".sidebar-album");for(fc=0,fh=e8.length;fc<fh;fc++){fg=e8[fc];if(fg.readAttribute("data-gid")===fe.gid){fg.addClassName("selected");break}}$("single-collection-title").__date(bO.em_snippet(fe.name,cz.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(fe.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",fe.shmodel_url);if(((e7=fe.member_fnames)!=null?e7.length:void 0)>1){ff=er("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:c0.album_desc(fe),album_members:dX.nice_list(fe.member_fnames)});$("single-collection-share-status").__date(ff)}else{$("single-collection-share-status").__date(er("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!fe.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+fe.name+" - Dropbox";cr.log_event("show_collection",fe.gid,fe.num_photos,fe.is_anonymous)}else{fe=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=er("Photos")+" - Dropbox"}fb=false;if(fe!=null){if(fe.gid!==this._current_collection_gid){fb=true}}else{if(this._all_photos_timeline==null){fb=true}}this._current_collection_gid=fe!=null?fe.gid:null;if(fb){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){e9=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(e9);if((T=$(e9))!=null){T.addClassName("wiggobble")}setTimeout((function(){return $(e9).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aG;aG=INLINE_JS.PhotosTour=A.PhotosTour={_frame:0,next:function(){var T;eY.show("",by("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);T=this._frame;g.log_interaction(a3.SHOW_MODAL,"",{frame:T});by("#modal-x").off("click");by("#modal-x").on("click",((function(e7){return function(){return g.log_interaction(a3.EXIT_MODAL,"",{frame:T})}})(this)));return this._frame=(this._frame+1)%4},hide:function(T){g.log_interaction(T,"");return eY.hide()}};var c0;c0=A.PhotosUtil={categorize_files:function(e7){var e8,T;e8=e7.filter(function(e9){return e9.preview_type==="photo"});T=e7.filter(function(e9){return e9.preview_type==="video"});return[e8.length,T.length]},file_desc:function(fb,e8,T){var e7,fa,e9;if(e8==null){e8=false}if(T==null){T=false}e9=this.categorize_files(fb),e7=e9[0],fa=e9[1];return this._photo_video_desc(e7,fa,e8,T)},album_desc:function(e8,e7,T){if(e7==null){e7=false}if(T==null){T=false}return this._photo_video_desc(e8.num_photos,e8.num_videos,e7,T)},_photo_video_desc:function(e7,fc,e8,T){var e9,fb,fa;fb=a6("%d photo","%d photos",e7,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(e7);fa=a6("%d video","%d videos",fc,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(fc);if(e7&&fc){if(e8){e9=e7+fc;return a6("%d item","%d items",e9).format(e9)}else{if(T){return new e2(""+fb+"<br/>"+fa)}else{return er("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:fb,num_videos:fa})}}}else{if(e7){return fb}else{if(fc){return fa}else{return""}}}}};var eL,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};eL=INLINE_JS.PhotosSelection=A.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(T){return function(e7){if(e7.keyCode===T.SHIFT_KEY_CODE&&T._last_mouseover&&!y.focus_in_input()){return T._highlight_range(T._last_selected,T._last_mouseover)}}})(this));$(document.body).on("keyup",(function(T){return function(e7){if(e7.keyCode===T.SHIFT_KEY_CODE&&!T._marquee.active){return T.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bK.KEY_SCOPE,(function(T){return function(e7){e7.preventDefault();if(bK.in_single_collection_view()){if(T._selected.length){return cz.show_remove_photos_modal(bK.get_current_collection(),T._selected)}}else{if(T._selected.length){return bK.show_delete_photos_modal(T._selected)}}}})(this));key("esc",bK.KEY_SCOPE,(function(T){return function(e8){var e7;if(typeof e8.preventDefault==="function"){e8.preventDefault()}if(T._drag_drop.active){T._drag_drop.active=false;if((e7=$("albums-sidebar-list"))!=null){e7.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{T.clear();return g.log_interaction(ee.CLEAR_SELECTED,c3.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return x.init(null,by("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(e7){var T,e9,e8;e9=(function(){var fd,fb,fc,fa;fc=this._selected;fa=[];for(fd=0,fb=fc.length;fd<fb;fd++){T=fc[fd];fa.push(T.uniqueness_key)}return fa}).call(this);return e8=e7.uniqueness_key,bE.call(e9,e8)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eJ.hide_all();return document.fire(eL.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(e7,T){if(e7.isRightClick()&&!e7.shiftKey){return}if(e7.shiftKey){return this._select_highlighted()}else{if(this.contains(T)){return this._remove(T)}else{return this._add(T)}}},num_selected:function(){return this._selected.length},refresh:function(e9){var fb,fc,e8,fd,fa,e7,T;fd=(function(){var fh,ff,fg,fe;fg=this._selected;fe=[];for(fh=0,ff=fg.length;fh<ff;fh++){e8=fg[fh];fe.push(e8.uniqueness_key)}return fe}).call(this);T=[];for(fa=0,e7=e9.length;fa<e7;fa++){fc=e9[fa];fb=fd.indexOf(fc.uniqueness_key);if(fb>=0){T.push(this._selected[fb]=fc)}else{T.push(void 0)}}return T},inc_num_loading_events_before_select:function(T){if(!this._show_share_after_loading_selected){es.show(er("Loading photos..."))}this._show_share_after_loading_selected=T;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;es.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){es.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bK._share_selected()}}}},_photo_mouseover:function(T){this._last_mouseover=bK.get_timeline().get_photo_for_thumb_elm($(T.target));if(T.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(T){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(e9){var T,e7,e8;if(bK.in_all_collections_view()||e9.isRightClick()||this._invalid_mouse_target($(e9.target))){return}bh.hide();eJ.hide_all();T=(e8=bK.get_timeline())!=null?e8.get_photo_for_thumb_elm($(e9.target)):void 0;if(T!=null){if(this.contains(T)||!eL.drag_select_enabled){e7=y.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=e9.clientX+e7.left;this._drag_drop.start_y=e9.clientY+e7.top;this._drag_drop.anchor=$(e9.target);this._drag_drop.single_photo=this.contains(T)?null:T;this._build_drag_status(T);this._update_drag_status_position(e9)}else{this._drag_select.active=true;this._drag_select.anchor=T}}else{e7=y.scroll_offsets();if((e9.clientX+e7.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=e9.clientX+e7.left;this._marquee.start_y=e9.clientY+e7.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return x.start()},_body_mousemove:function(e9){var e7,T,fa,e8;e7=y.scroll_offsets();T=e9.clientX+e7.left;fa=e9.clientY+e7.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(T-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fa-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=T;this._marquee.end_y=fa;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(T-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(fa-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(e9);$$(".sidebar-album").invoke("removeClassName","album-flash");if((e8=$("albums-sidebar-list"))!=null){e8.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(e8){var e7,T;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();e7=this._highlighted.length;this._select_highlighted();if(e7){g.log_interaction(ee.MARQUEE_SELECT,c3.DRAG,{num_selected:e7})}}if(this._drag_drop.active){if($(e8.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((T=$("albums-sidebar-list"))!=null){T.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return x.end()},_body_double_click:function(T){if(bK.get_timeline().get_photo_for_thumb_elm($(T.target))||this._invalid_mouse_target($(T.target))){return}this.clear();return g.log_interaction(ee.CLEAR_SELECTED,c3.DBL_CLICK)},_draw_marquee:function(){var T,fa,e9,e8,e7;e7=Math.abs(this._marquee.start_x-this._marquee.end_x);T=Math.abs(this._marquee.start_y-this._marquee.end_y);e9=Math.min(this._marquee.start_y,this._marquee.end_y);fa=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:e7+"px",height:T+"px",top:e9+"px",left:fa+"px"});$("marquee").show();e8=false;if(bK.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);e8=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);e8=true}if(e8){return this._update_marquee_highlight(e9,fa,e7,T)}}},_update_marquee_highlight:function(fh,e8,T,fj){var ff,fg,fd,e7,fc,fb,fi,fe,fa,e9;this.clear_highlighted();e7=[];fg=bK.get_timeline().grid.photo_col_offsets.length;fe=bK.get_timeline().grid.photo_col_offsets.slice(0,fg-1);for(ff=fc=0,fi=fe.length;fc<fi;ff=++fc){fd=fe[ff];if(fd<=e8+T&&bK.get_timeline().grid.photo_col_offsets[ff+1]>=e8){e7.push(ff)}}e9=[];for(ff=fb=0,fa=bK.get_timeline().events.length();0<=fa?fb<fa:fb>fa;ff=0<=fa?++fb:--fb){e9.push(bK.get_timeline().events.valueAtIndex(ff).marquee_highlight(fh,fh+fj,e7))}return e9},_update_marquee_x_bounds:function(T){var e9,fc,fd,fb,e8,fa,e7;fc=$(document.body).getWidth();if(T<bK.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bK.get_timeline().grid.photo_col_offsets.first()}else{if(T>bK.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bK.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=fc}else{fa=bK.get_timeline().grid.photo_col_offsets;e7=[];for(e9=fb=0,e8=fa.length;fb<e8;e9=++fb){fd=fa[e9];if(fd>T){this._marquee.x_min_boundary=bK.get_timeline().grid.photo_col_offsets[e9-1];this._marquee.x_max_boundary=fd;break}else{e7.push(void 0)}}return e7}}},_update_marquee_y_bounds:function(fd){var T,fa,e9,fc,e8,fb,e7;e9=$(document.body).getHeight();if(fd<bK.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bK.get_timeline().grid.photo_row_offsets.first()}else{if(fd>bK.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bK.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=e9}else{fb=bK.get_timeline().grid.photo_row_offsets;e7=[];for(fa=fc=0,e8=fb.length;fc<e8;fa=++fc){T=fb[fa];if(T>fd){this._marquee.y_min_boundary=bK.get_timeline().grid.photo_row_offsets[fa-1];this._marquee.y_max_boundary=T;break}else{e7.push(void 0)}}return e7}}},_build_drag_status:function(e9){var e8,T,e7;T=bK.get_timeline().get_thumb_elm_for_photo(e9);e7=T.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(e7);e8=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(c0.file_desc(e8,false,true))},_update_drag_status_position:function(T){return $("photos-drag-status").setStyle({left:(T.pointerX()-y.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(T.pointerY()-y.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fi,fh,e8){var fg,T,e9,fd,ff,fe,e7,fb,fc,fa;if(e8==null){e8=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fi;this._last_highlight_to_photo=fh;e9=bK.get_timeline().index_of_photo(fi);e7=bK.get_timeline().index_of_photo(fh);fg=!e8&&this.contains(fh)&&!this.contains(fi);fa=[];for(fd=fb=e9;e9<=e7?fb<=e7:fb>=e7;fd=e9<=e7?++fb:--fb){fe=bK.get_timeline().photo_at_index(fd);if(fe.status===G.PLACEHOLDER){if(fe.event!==ff){T=fe.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(fc=T.unique_id,bE.call(this._events_highlighting,fc)<0){this._events_highlighting.push(T.unique_id)}fa.push(ff=T)}else{fa.push(void 0)}}else{fa.push(void 0)}}else{if(this.contains(fe)){if(fg){fa.push(this._dehighlight(fe))}else{fa.push(void 0)}}else{if(!fg){fa.push(this._highlight(fe))}else{fa.push(void 0)}}}}return fa},_highlight_range_incremental:function(T){var fd,e8,fe,fa,fb,e7,fc,e9;fe=this._last_highlight_from_photo;fc=this._last_highlight_to_photo;if(!((fe!=null)&&(fc!=null))){return}e8=bK.get_timeline().index_of_photo(fe);e7=bK.get_timeline().index_of_photo(fc);for(fa=e9=e8;e8<=e7?e9<=e7:e9>=e7;fa=e8<=e7?++e9:--e9){fb=bK.get_timeline().photo_at_index(fa);if(fb.status!==G.PLACEHOLDER&&!this.contains(fb)&&this._highlighted.indexOf(fb)===-1){this._highlight(fb)}}fd=this._events_highlighting.indexOf(T.unique_id);if(fd>=0){this._events_highlighting.splice(fd,1)}if(this._select_highlighted_waiting){es.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(e9){var e8,fa,e7,T;this.clear_highlighted();T=[];for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];if(!this.contains(e8)){T.push(this._highlight(e8))}else{T.push(void 0)}}return T},_select_highlighted:function(){var e9,fc,fa,e8,e7,fb,T;if(this._events_highlighting.length>0){es.show(er("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}fb=this._highlighted;for(fc=0,e8=fb.length;fc<e8;fc++){e9=fb[fc];this._add(e9)}T=this._dehighlighted;for(fa=0,e7=T.length;fa<e7;fa++){e9=T[fa];this._remove(e9)}if(this._select_highlighted_waiting){es.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(e7){var T;this._highlighted.push(e7);T=bK.get_timeline().get_thumb_elm_for_photo(e7);return T!=null?T.addClassName("highlighted"):void 0},_dehighlight:function(e7){var T;this._dehighlighted.push(e7);T=bK.get_timeline().get_thumb_elm_for_photo(e7);return T!=null?T.addClassName("dehighlighted"):void 0},_add:function(e7){var T;cC(e7.status!==G.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);T=bK.get_timeline().get_thumb_elm_for_photo(e7);if(T!=null){T.addClassName("selected")}this._selected.push(e7);this._last_selected=e7;dj.fillVal(c0.file_desc(this._selected,true),"selected-desc");dj.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eL.CHANGE_EVT)},_remove:function(e8){var e7,T;T=bK.get_timeline().get_thumb_elm_for_photo(e8);if(T!=null){T.removeClassName("selected")}e7=this._selected.indexOf(e8);if(e7!==-1){this._selected.splice(e7,1);this._last_selected=e8;if(this._selected.length){dj.fillVal(c0.file_desc(this._selected,true),"selected-desc");dj.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eL.CHANGE_EVT)},_invalid_mouse_target:function(e9){var e7,e8,T;e7=e9.classNames().toArray().concat(e9.up().classNames().toArray());return(bE.call(e7,"freshbutton")>=0)||(bE.call(e7,"freshbutton-blue")>=0)||(bE.call(e7,"freshbutton-lightblue")>=0)||(bE.call(e7,"freshbutton-blue-on-gray")>=0)||(bE.call(e7,"timeline-elm")>=0)||(e9.up(".no-marquee")!=null)||(e9.up("#context-menu")!=null)||(e9.up(".freshdropdown-menu")!=null)||e9.nodeName==="A"||((e8=e9.tagName.toUpperCase())==="INPUT"||e8==="TEXTAREA"||e8==="SELECT")||eY.shown()||((T=$("modal-progress-content"))!=null?T.visible():void 0)||aE.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cz,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};cz=INLINE_JS.PhotosCollections=A.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new e2('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(e7,T){this._collections=e7;this._gid_to_collection=e7.dict_by("gid");this._url_to_collection=e7.dict_by("url");this._collection_list_item_tmpl=e2.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=e2.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var T;T=eu.deconstruct_url();if(T.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(T){if(this._num_loading_collections!==null&&(this._num_loading_collections<T||T===null)){this._num_loading_collections=T;return cv.WebRequest({url:"/collections",data:{limit:T},subject_user:cD.get_viewer().photos_user,success:(function(e7){return function(fe){var fd,fc,e9,fb,e8,fa;e9=JSON.parse(fe);for(fb=0,e8=e9.length;fb<e8;fb++){fc=e9[fb];if(!(fc.gid in e7._gid_to_collection)&&!(fa=fc.gid,bE.call(e7._removed_pre_load,fa)>=0)){fd=new Y(fc,false);e7._collections.push(fd);e7._gid_to_collection[fd.gid]=fd;e7._url_to_collection[fd.url]=fd}}if(T===null||e9.length<T){e7._all_collections_loaded=true;e7._sidebar_collections_loaded=true}if(T>=5){e7._sidebar_collections_loaded=true}return e7.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(T){return function(e7){if(!bK.get_current_collection().is_creator){return}T.header_rename();return g.log_interaction(ee.RENAME_ALBUM,c3.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bh.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(Y.CREATE_EVT,this._collection_created.bind(this));document.observe(Y.ADD_EVT,this._collection_photos_added.bind(this));document.observe(Y.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(Y.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(Y.RENAME_EVT,this._collection_renamed.bind(this));document.observe(Y.DELETE_EVT,this._collection_deleted.bind(this));document.observe(Y.SHARE_EVT,this._collection_shared.bind(this));document.observe(Y.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(Y.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var fa,e7,e9,T,e8;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}e7=[];e8=this._collections;for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];e7.push(this._collection_list_item_tmpl({collection:fa,additional_class:"albums-list-item show-collection-target",Sprite:cp,Emstring:bO}))}$("albums-list").__date(e7);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var fb,e7,e8,fa,T,e9;e7=[];e8={name:er("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};e7.push(this._collection_list_item_tmpl({collection:e8,additional_class:"create-album-target",hide_icons:true,Sprite:cp,Emstring:bO}));e9=this._collections;for(fa=0,T=e9.length;fa<T;fa++){fb=e9[fa];e7.push(this._collection_list_item_tmpl({collection:fb,additional_class:"add-to-album-target",Sprite:cp,Emstring:bO}))}$("add-to-album-modal-list").__date(e7);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var fc,fe,fa,fd,fb,e9,e7,T,e8;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();fe=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:er,Sprite:cp,PhotosCollections:cz});if((fb=$("albums-sidebar"))!=null){fb.__date(fe)}if((e9=$("all-albums-sidebar"))!=null){e9.observe("click",bK.show_all_collections)}if((e7=$("all-albums-sidebar"))!=null){e7.observe("mouseup",(function(ff){return function(fg){var fh;if(!eL._drag_drop.active){return}if(eL._drag_drop.single_photo!=null){fh=[eL._drag_drop.single_photo]}else{fh=eL.get()}ff.show_add_to_album_modal(fg,fh);return g.log_interaction(ee.ADD_TO_OTHER_ALBUM,c3.DROP_TARGET,{num_photos:eL.get().length})}})(this))}if(bK.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bK.in_single_collection_view()){T=$$(".sidebar-album");e8=[];for(fa=0,fd=T.length;fa<fd;fa++){fc=T[fa];if(fc.readAttribute("data-gid")===bK.get_current_collection().gid){fc.addClassName("selected");break}else{e8.push(void 0)}}return e8}}},refresh_album_views:function(e7){var T;if(e7==null){e7=null}T=(function(e8){return function(){e8.render_all_albums_view();e8.render_albums_sidebar();return e8.render_add_to_album_modal()}})(this);if(e7!=null?e7.length:void 0){return cv.WebRequest({url:"/collections",data:{collection_gids:JSON.stringify(e7.unique())},subject_user:cD.get_viewer().photos_user,success:(function(e8){return function(fc){var fi,fh,fa,fg,fe,fd,fj,e9,ff,fb;ff=JSON.parse(fc);for(fe=0,fj=ff.length;fe<fj;fe++){fa=ff[fe];fh=new Y(fa,false);e8._gid_to_collection[fh.gid]=fh;e8._url_to_collection[fh.url]=fh;fb=e8._collections;for(fg=fd=0,e9=fb.length;fd<e9;fg=++fd){fi=fb[fg];if(fi.gid===fh.gid){e8._collections[fg]=fh;break}}}return T()}})(this)})}else{return T()}},show_add_to_album_modal:function(T,e7){if(e7!==eL.get()&&(eL._drag_drop.single_photo==null)){eL._context_selected=e7}eY.onHide=function(){eL._context_selected=null;delete eY.onHide;return eY.hide()};eY.show(er("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(e8,fa,e7){var T,e9;if(e7==null){e7=true}e9=bK.get_current_collection_gid();T=fa.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;aa.success(er("Adding to album..."));return e8.add_photos(fa,e9,T,e7)},show_remove_photos_modal:function(e9,fb){var e8,T,fa,e7;e7=c0.categorize_files(fb),T=e7[0],fa=e7[1];if(T&&fa){e8=a6("Remove %(file_count)s item?","Remove %(file_count)s items?",fb.length)}else{if(T){e8=a6("Remove %(file_count)s photo?","Remove %(file_count)s photos?",fb.length)}else{e8=a6("Remove %(file_count)s video?","Remove %(file_count)s videos?",fb.length)}}e8=e8.format({file_count:fb.length});dj.fillVal(c0.file_desc(fb),"collection-remove-files");dj.fillVal(e9.name.escapeHTML(),"collection-remove-name");return eY.show(e8,dj.fromElm("collection-remove-modal"),{action:(function(fc){return function(){var fd;fb=fb.slice(0);fd=fb.length>fc.NUM_PHOTOS_LONG_RUNNING_REMOVES;return e9.remove_photos(fb,fd)}})(this)})},header_rename:function(){if(by("#single-collection-title-container").hasClass("editing")){return}by("#single-collection-title-container").addClass("editing");return bK.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(e7){var T;dj.fillVal(e7.name.escapeHTML(),"collection-delete-name");T=er("Delete album?");return eY.show(T,dj.fromElm("collection-delete-modal"),{action:function(){if(e7.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){aa.success(er("Deleting '%(collection_name)s'...").format({collection_name:e7.name}),100)}return e7["delete"]()}})},show_unshare_modal:function(e7){var T;dj.fillVal(e7.name.escapeHTML(),"collection-unshare-name");T=er("Unshare album?");return eY.show(T,dj.fromElm("collection-unshare-modal"),{action:function(){return e7.unshare()}})},create:function(fe,fd,fi,e7){var e9,fa,e8,fb,fg,fh,ff,T,fc;if(e7==null){e7=false}if(fe){Event.extend(fe).preventDefault();fc=$(fe.target);if(fc.hasClassName("inplaceeditor-form")||(fc.up(".inplaceeditor-form")!=null)){return}if(fc.up("#context-menu")){e9=true}else{if(fc.up(".freshdropdown-menu")){e8=true}}}bK.enable_selection();if(!fi){fi=eL.get()}fb=(function(){var fl,fk,fj;fj=[];for(fl=0,fk=fi.length;fl<fk;fl++){T=fi[fl];fj.push(T.item_counter)}return fj})();fi.sort_by_key(function(fj){return fj.time_taken});fg=fi.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ff=(function(fj){return function(fl){var fo,fm,fk,fn;fm=JSON.parse(fl.responseText);fo=new Y(fm);eL.clear();eJ.hide_all();bh.hide();eY.hide();bK.disable_selection();fn=er("Created '%(collection_name)s'");fk=fo.name.escapeHTML();fn=fn.format({collection_name:"<a data-gid='"+fo.gid+"' class='show-collection-target'>"+fk+"</a>"});aa.success(new e2(fn));return fj.flash_sidebar_album(fo.gid)}})(this);fh=function(){if(!e8){eJ.hide_all()}if(!e9){bh.hide()}cz.render_albums_sidebar();return bK.disable_selection()};fa=new Ajax.InPlaceEditor(fd,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:e7,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fh,onFailure:function(){},savingText:er("Creating..."),onLeaveEditMode:bK.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:ff,job:fg,job_user:cD.get_viewer().photos_user,progress_text:er("Creating album...")},callback:function(fj,fl){var fk;aa.success(er("Creating album..."));fk={collection_name:fl,item_counters:JSON.stringify(fb),source_collection_gid:bK.get_current_collection_gid()};return fk}});fa.enterEditMode();if(!e7){return fa._controls.editor.observe("blur",fh)}},toggle_more_selected_actions:function(T){if(T){Event.extend(T).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eJ.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(T){var e7;if(T){Event.extend(T).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bK.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(bV.msie_version_at_most(10)){e7=by("#more-collection-actions-menu");if(!e7.parent().is("body")){by(document.body).append(e7.remove())}}return eJ.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(T){var e7;e7=T.memo.collection;if(!e7.is_anonymous){this._collections.unshift(e7)}this._gid_to_collection[e7.gid]=e7;this._url_to_collection[e7.url]=e7;return this.refresh_album_views()},_collection_changed:function(T){this._collections.removeItem(T);this._collections.unshift(T);return this.refresh_album_views()},_collection_photos_added:function(fd){var fc,fa,e9,fe,ff,e8,T,e7,fg,fb;fc=fd.memo.collection;fg=fd.memo.photos;fe=fd.memo.num_items_added;e8=fd.memo.num_photos_added;e7=fd.memo.num_videos_added;if(fd.memo.promote_collection&&fe>0){this._collection_changed(fc)}else{this.refresh_album_views()}if(fg===eL.get()){eL.clear()}if(fe<1){fb=c0.categorize_files(fg),ff=fb[0],T=fb[1];if(ff&&T){e9=a6("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",fg.length)}else{if(ff){e9=a6("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",fg.length)}else{e9=a6("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",fg.length)}}}else{if(e8&&e7){e9=a6("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",fg.length)}else{if(e8){e9=a6("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",fg.length)}else{e9=a6("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",fg.length)}}}fa=fc.name.escapeHTML();e9=e9.format({collection_name:"<a data-gid='"+fc.gid+"' class='show-collection-target'>"+fa+"</a>"});return aa.success(new e2(e9))},_collection_photos_removed:function(e7){var e8,e9,T;e8=e7.memo.collection;e9=e7.memo.photos;T=bK.undo_enabled?e7.memo.undo_changeset:null;bK.get_timeline().remove_photos(e9);this._collection_changed(e8);return aa.success(er("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:c0.file_desc(e9),collection_name:e8.name}),null,null,T,(function(){return e8.undo_remove(T)}))},_collection_undid_remove:function(T){var e7;e7=T.memo.collection;bK.get_timeline().restore_removed_photos();cz.refresh_album_views([e7.gid]);return aa.success(er("Undo complete"))},_collection_renamed:function(e7){var e8,T;e8=e7.memo.collection;if(((T=bK.get_current_collection())!=null?T.gid:void 0)===e8.gid){by("#single-collection-title").text(bO.em_snippet(e8.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+e8.name+" - Dropbox"}this._collection_changed(e8);return aa.success(er("Renamed '%(collection_name)s'").format({collection_name:e8.name}))},_collection_deleted:function(e7){var e8,T;e8=e7.memo.collection;this._collections.removeItem(e8);if(!this._all_collections_loaded){this._removed_pre_load.push(e8.gid)}this.refresh_album_views();if(((T=bK.get_current_collection())!=null?T.gid:void 0)===e8.gid){bK.show_all_collections()}delete this._gid_to_collection[e8.gid];delete this._url_to_collection[e8.url];return aa.success(er("Deleted '%(collection_name)s'").format({collection_name:e8.name}))},_collection_shared:function(e7){var e8,T;e8=e7.memo.collection;this._collection_changed(e8);if(((T=bK.get_current_collection())!=null?T.gid:void 0)===e8.gid){by("#single-collection-share-status").text(er("Shared"));return by("#single-collection-share-status").attr("href",e8.shmodel_url)}},_collection_unshared:function(e7){var e8,T;e8=e7.memo.collection;if(((T=bK.get_current_collection())!=null?T.gid:void 0)===e8.gid){by("#single-collection-share-status").text("")}return aa.success(er("Unshared '%(collection_name)s'").format({collection_name:e8.name}))},_collection_cover_changed:function(T){var e8,e7;e8=T.memo.collection;this._collection_changed(e8);e7=er("Changed cover photo for '%(collection_name)s'");e7=e7.format({collection_name:e8.name.escapeHTML()});return aa.success(e7)},_albums_list_item_contextmenu:function(e7,T){bh.show_photo_collection(e7,this.get(T.readAttribute("data-gid")),T);T.removeClassName("album-flash");return T.addClassName("context-selected")},_show_collection_click:function(e8,T){var e7;e7=$(e8.target);if(e7.hasClassName("inplaceeditor-form")||(e7.up(".inplaceeditor-form")!=null)){return}return bK.show_collection(T.readAttribute("data-gid"))},_collection_shmodel_click:function(e7,T){return this.go_to_link(this.get(T.readAttribute("data-gid")))},_add_to_album_click:function(e7,T){if(eL._context_selected){this.add_photos(this.get(T.readAttribute("data-gid")),eL._context_selected);eL._context_selected=null}else{this.add_photos(this.get(T.readAttribute("data-gid")),eL.get())}delete eY.onHide;eY.hide();return g.log_interaction(ee.ADD_TO_RECENT_ALBUM,c3.SAH,{num_photos:eL.get().length})},_drop_target_mouseover:function(e7,T){if(eL._drag_drop.active){T.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(e7,T){if(eL._drag_drop.active){T.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(e7,T){var e8;if(T.hasClassName("hovered")){T.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eL._drag_drop.single_photo!=null){e8=[eL._drag_drop.single_photo]}else{e8=eL.get()}if(T.readAttribute("data-gid")!=null){this.add_photos(this.get(T.readAttribute("data-gid")),e8,false)}if(T.identify()==="add-to-album-sidebar-new"){return g.log_interaction(ee.ADD_TO_NEW_ALBUM,c3.DROP_TARGET,{num_photos:eL.get().length})}else{if(T.identify()==="all-albums-sidebar"){return g.log_interaction(ee.ADD_TO_OTHER_ALBUM,c3.DROP_TARGET,{num_photos:eL.get().length})}else{return g.log_interaction(ee.ADD_TO_RECENT_ALBUM,c3.DROP_TARGET,{num_photos:eL.get().length})}}}},_create_album_click:function(T,e7){if(eL._context_selected){this.create(T,e7.down(".collection-name"),eL._context_selected,true);return eL._context_selected=null}else{return this.create(T,e7.down(".collection-name"),eL.get(),true)}},_window_scroll:function(){if(bK.in_all_collections_view()){return this._all_albums_scroll_position=y.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(T){return this._url_to_collection[T]},get:function(T){return this._gid_to_collection[T]},go_to_link:function(T){return window.open(T.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(e8,e7){var T,fa,e9;T=bO.em_snippet(e8,e7,1);fa=T.lastIndexOf(" ");if(fa===-1){return T}else{T=T.slice(0,+fa+1||9000000000);e9=bO.em_snippet(e8.slice(fa+1),e7,1);return T+e9}},get_default_album_name:function(){var T;T=er("Untitled album");return this.increment_collection_name_until_valid(T)},collection_name_in_use:function(e7){var fa,e9,T,e8;e8=this.get_all();for(e9=0,T=e8.length;e9<T;e9++){fa=e8[e9];if(fa.name===e7.trim()){return true}}return false},increment_collection_name_until_valid:function(e7){var e8,T;e8=this.collection_name_in_use(e7);T=0;while(e8){T++;e8=this.collection_name_in_use(e7+(" ("+T+")"))}return(T===0?e7:e7+(" ("+T+")"))},flash_sidebar_album:function(fa){var fb,e9,e7,e8,T;e8=$$(".sidebar-album");T=[];for(e9=0,e7=e8.length;e9<e7;e9++){fb=e8[e9];if(fb.readAttribute("data-gid")===fa){fb.removeClassName("album-flash");fb.addClassName("album-flash");break}else{T.push(void 0)}}return T}};var cc;cc=A.PhotoTimeline=(function(){T.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";T.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";T.prototype.THUMB_SIZE=null;T.prototype.HEADER_HEIGHT=null;T.prototype.THUMBS_PER_ROW=4;T.prototype.RENDER_SCROLL_WAIT=100;T.prototype.RENDER_SCROLL_MAX_WAIT=750;T.prototype.HIDE_TIMELINE_NAV_DELAY=1500;T.prototype.THUMBS_BATCH_SIZE=12;T.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;T.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;T.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;T.prototype.TIMELINE_NAV_ELM_HEIGHT=20;T.prototype.TIMELINE_DOT_HTML=cp.html("web","timeline_dot");T.container;T.scroll_container;T.events;T.current_event;T.key_to_photo;T.preview_objs;T.tmpl;T.last_render_scroll_timeout;T.start_render_scroll_time;T.last_scroll_position;T.hide_timeline_nav_timeout;T.grid;T._skip_scroll_update;T.header_id_to_sel_items;T.event_remove_info;T.opts;function T(e8,e9,fc,fa,fb,fd,fe,ff,e7){this.container=e8;this.scroll_container=e9;this.tmpl=fe;this.opts=e7;this.THUMB_SIZE=ff.thumb_size;this.HEADER_HEIGHT=ff.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=fd;this.event_remove_info=[];this._init_events(fc,fa,fb);this.update_offsets(ff.top_offset,ff.left_offset);this.listen();dq.start_capture(this.scroll_container)}T.prototype._init_events=function(ff,e9,fb){var e8,fd,fi,fa,fc,fg,e7,fe,fh;if(ff.length<1){this.events=new aU([],{});return}fd=[];fc={};fi=false;for(fe=0,fh=ff.length;fe<fh;fe++){fa=ff[fe];fa=String(fa);e7=fa in this.header_id_to_sel_items?this.header_id_to_sel_items[fa]:[];fg=false;if(e7.length&&!fi){fi=true;fg=true}e8=new c4(this,fa,e9[fa],fb[fa],e7,fg);fd.push(fa);fc[fa]=e8}return this.events=new aU(fd,fc)};T.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(c4.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};T.prototype.unlisten=function(){var e8,e7,e9;if((e8=this._body_mousemove_handler)!=null){e8.stop()}if((e7=this._timeline_elm_click_handler)!=null){e7.stop()}if((e9=this._show_missing_timestamp_bucket_handler)!=null){e9.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(c4.EVENT_MISCOUNT_EVT)};T.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};T.prototype.update_offsets=function(e9,e8){var fa,fc,fb,e7;cC(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=e9;this.refresh_row_offsets();this.left_offset=e8;this.grid.photo_col_offsets=[];e7=[];for(fa=fc=0,fb=this.THUMBS_PER_ROW;0<=fb?fc<=fb:fc>=fb;fa=0<=fb?++fc:--fc){e7.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*fa))}return e7};T.prototype.refresh_row_offsets=function(){var fe,fb,e9,fd,fa,e8,fc,e7;this.grid.photo_row_offsets=[];fe=this.top_offset;fc=this.events.getValues();for(fd=0,e8=fc.length;fd<e8;fd++){fb=fc[fd];fb.top_offset=fe;fe+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(fe);for(e9=fa=0,e7=fb.get_num_rows();0<=e7?fa<e7:fa>e7;e9=0<=e7?++fa:--fa){fe+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(fe)}}};T.prototype._render_empty_grid=function(){var e8,fb,fa,e7,e9;this.container.__date();e9=this.events.getValues();for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];if(!(e8.is_missing_timestamp_bucket()&&this.events.length()>1)){e8.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){fb=by('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(er("Show photos with missing dates"));return by(this.container).append(fb)}};T.prototype._render_viewport=function(fa){var e8,fj,fb,fi,fl,fg,ff,fd,fk,e9,e7,fh,fe,fc;if(fa==null){fa=false}this.start_render_scroll_time=-1;fl=this.get_viewport_info();fj=[];fh=this.events.getValues();for(fg=0,fk=fh.length;fg<fk;fg++){e8=fh[fg];if(!(e8.has_loaded_metadata()||e8.loading_metadata||(e8.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(e8.in_current_viewport(fl,false)){fj.unshift(e8)}else{if(e8.in_current_viewport(fl,true)){fj.push(e8)}}}}for(ff=0,e9=fj.length;ff<e9;ff++){e8=fj[ff];fe=e8.get_photo_range_to_render(fl,true),fb=fe[0],fi=fe[1];e8.load_metadata_range(fb,fi)}if(fa){fl=this.get_viewport_info();fc=this.events.getValues();for(fd=0,e7=fc.length;fd<e7;fd++){e8=fc[fd];if(e8.in_current_viewport(fl,false)){e8.timing_stopped_scrolling_on_event=bY.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};T.prototype._load_metadata_for_sel_events=function(){var e9,fb,e7,fa,e8;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}fa=this.header_id_to_sel_items;e8=[];for(fb in fa){e7=fa[fb];e9=this.events.valueFromKey(fb);if(e9!=null){e9.load_metadata()}e8.push(cC(e9!=null,"Missing "+fb+" in list of events with selected photos"))}return e8};T.prototype._load_visible_photos=function(){var e9,fb,e8,fa,e7;fa=this.events.getValues();e7=[];for(fb=0,e8=fa.length;fb<e8;fb++){e9=fa[fb];if(!(e9.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){e7.push(e9.update_photo_divs())}else{e7.push(void 0)}}return e7};T.prototype._body_mousemove=function(e7){if(!this.opts.uses_timeline_nav){return}if((e7.clientX+y.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};T.prototype._timeline_elm_click=function(fa,e9){var e7,e8;e8=e9.readAttribute("data-event-id");if(e8){e7=this.events.valueFromKey(e8)}this._update_timeline_position(e7);if(e7.is_missing_timestamp_bucket()){g.log_interaction(cf.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(e7)};T.prototype._scroll_to_event=function(e9,e7){var e8;if(e7==null){e7=false}e8=e9.top_offset-this.top_offset;if(e9&&(y.scroll_offsets().top!==e8)){if(e7){return by("html, body").animate({scrollTop:e8},200)}else{this._skip_scroll_update=true;return window.scrollTo(y.scroll_offsets().left,e8)}}};T.prototype._window_scroll=function(){var fa,e9,fd,fc,e8,fb,e7;e9=bY.time();bm.clear_all_pending_batches();if(this.start_render_scroll_time===-1||e9-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=e9}fd=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),fd);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(fe){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=y.scroll_offsets().top;bK.scroll_count++;fb=this.events.getValues();e7=[];for(fc=0,e8=fb.length;fc<e8;fc++){fa=fb[fc];e7.push(fa.logged_thumbs_arrived=false)}return e7};T.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};T.prototype.init_timeline_nav=function(){var e8,fa,e7,e9;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();e9=this.events.getValues().reverse();for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];e8.add_to_timeline_nav(e8===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};T.prototype._resize_timeline_nav=function(){var e7;if(!this.opts.uses_timeline_nav){return}e7=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:e7+"px"})};T.prototype._update_timeline_position=function(fd){var fh,fe,e7,fg,fb,fa,ff,e8,fc,e9;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(fd==null){fg=this.get_viewport_info();if(this.scroll_container==null){fg.top=document.viewport.getScrollOffsets().top}fh=fg.top+fg.height/2;fc=this.events.getValues();for(fb=0,ff=fc.length;fb<ff;fb++){e7=fc[fb];if(e7.top_offset>fh){break}fd=e7}}if((fd==null)||fd===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");e9=$$(".timeline-elm");for(fa=0,e8=e9.length;fa<e8;fa++){fe=e9[fa];if(fe.readAttribute("data-event-id")===fd.unique_id){fe.addClassName("current");break}}return this.current_event=fd};T.prototype._show_hide_timeline_elms=function(){var fe,fb,e9,fa,fd,e8,fc,e7;if(!this.opts.uses_timeline_nav){return}e9=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();fb=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();fc=$$(".timeline-elm");e7=[];for(fd=0,e8=fc.length;fd<e8;fd++){fe=fc[fd];fe.show();fa=fe.cumulativeOffset();if(fa.top<fb&&fa.left<e9){e7.push(fe.hide())}else{e7.push(void 0)}}return e7};T.prototype._event_miscount=function(e7){this.refresh_row_offsets();return this._load_visible_photos()};T.prototype.remove_photos=function(fe){var fa,fc,fd,e9,e8,fb,e7;fe=fe.slice(0);this.event_remove_info=[];fd={};for(fb=0,e7=fe.length;fb<e7;fb++){e9=fe[fb];fc=e9.event.unique_id;if(fc in fd){fd[fc].push(e9)}else{fd[fc]=[e9]}}for(fc in fd){fe=fd[fc];fa=this.events.valueFromKey(fc);e8=fa.remove_photos(fe);this.event_remove_info.push({event:fa,remove_info:e8})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_REMOVED_EVT,this)};T.prototype.restore_removed_photos=function(){var e8,fm,fi,fl,fj,fa,fh,ff,fe,fc,fk,e9,e7,fg,fd,fb;eL.clear();fg=this.event_remove_info.reverse();for(ff=0,fk=fg.length;ff<fk;ff++){fm=fg[ff];e8=fm.event;fj=fm.remove_info;if(fj.removed_event_index!=null){this.events.insertAtIndex(fj.removed_event_index,e8.unique_id,e8);e8.restore()}e8.add_photos(fj.removed_photos_and_indexes.reverse());fd=fj.removed_photos_and_indexes;for(fe=0,e9=fd.length;fe<e9;fe++){fl=fd[fe];eL._add(fl.photo)}}fa=null;fh=null;fb=this.event_remove_info;for(fc=0,e7=fb.length;fc<e7;fc++){fm=fb[fc];e8=fm.event;fj=fm.remove_info;fi=this.events.indexOfKey(e8.unique_id);if((fa==null)||fa>fi){fa=fi;fh=fj.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fh!=null){this.scroll_to_photo_with_key(fh.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_ADDED_EVT,this)};T.prototype.get_photos=function(){var e8,fb,fa,e7,e9;fb=[];e9=this.events.getValues();for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];fb=fb.concat(e8.photos)}return fb};T.prototype.num_photos=function(){var e9,e8,fb,e7,fa;e8=0;fa=this.events.getValues();for(fb=0,e7=fa.length;fb<e7;fb++){e9=fa[fb];e8+=e9.photos.length}return e8};T.prototype.get_preview_objs=function(){var e7,e8,fe,fc,fb,ff,e9,fd,fa;fe=[];fd=this.events.getValues();for(fc=0,ff=fd.length;fc<ff;fc++){e7=fd[fc];fa=e7.photos;for(fb=0,e9=fa.length;fb<e9;fb++){e8=fa[fb];fe.push(e8.preview_obj)}}return fe};T.prototype.index_of_photo=function(e9){var fa,e8,fc,e7,fb;e8=0;fb=this.events.getValues();for(fc=0,e7=fb.length;fc<e7;fc++){fa=fb[fc];if(fa===e9.event){e8+=fa.photos.indexOf(e9);break}else{e8+=fa.photos.length}}return e8};T.prototype.photo_at_index=function(e9){var e7,fa,fc,e8,fb;e7=0;fb=this.events.getValues();for(fc=0,e8=fb.length;fc<e8;fc++){fa=fb[fc];if(e7+fa.photos.length>e9){return fa.photos[e9-e7]}else{e7+=fa.photos.length}}return null};T.prototype.get_thumb_elm_for_photo=function(e7){return $(e7.uniqueness_key)};T.prototype.get_photo_for_thumb_elm=function(e7){if(!e7.hasClassName("cu-thumb")){e7=e7.up(".cu-thumb")}if(e7){return this.key_to_photo[e7.identify()]}else{return null}};T.prototype.get_viewport_info=function(){var e7,e8;if(this.scroll_container!=null){e8=this.scroll_container.scrollTop;e7=this.scroll_container.getHeight()}else{e8=y.scroll_offsets().top;e7=y.viewport_dimensions().height}return{top:e8,height:e7,bottom:e8+e7}};T.prototype.scroll_to_photo_with_key=function(e8){var fc,e9,e7,fb,fa;y.scroll_unlock_document();fc=$(e8);if(fc!=null?fc.visible():void 0){dX.scroll_to_thumb(fc)}else{e7=this.key_to_photo[e8];e9=e7.event;if(e7.event!=null){fb=Math.floor(e9.photos.indexOf(e7)/this.THUMBS_PER_ROW);fa=this.get_viewport_info().height;y.scroll_to(0,e9.top_offset+this.HEADER_HEIGHT+fb*this.THUMB_SIZE-fa/2)}}return this._load_visible_photos()};T.prototype.restore_scroll_position=function(){y.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};T.prototype.visible_thumbs_loaded=function(){var e8,fa,e7,e9;e9=this.events.getValues();for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];if(!e8.visible_thumbs_loaded()){return false}}return true};T.prototype.has_missing_timestamp_bucket=function(){var e7;e7=this.events.getValues();return e7[e7.length-1].is_missing_timestamp_bucket()};T.prototype.is_missing_timestamp_bucket_shown=function(){var e7,e8;if(!this.has_missing_timestamp_bucket()){return false}e7=this.events.getValues();e8=e7[e7.length-1].unique_id;return by("#p-"+e8).length>0};T.prototype._show_missing_timestamp_bucket=function(e7,fa){var e9,e8;if(e7==null){e7=true}if(fa==null){fa=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}e8=this.events.getValues();e9=e8[e8.length-1];by("#show-missing-timestamps-button").hide();e9.add_html_elements_to(this.container);if(!fa){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(e9,e7);this._render_viewport()}return this.init_timeline_nav()};return T})();var c4;c4=A.PhotoEvent=(function(){T.EVENT_MISCOUNT_EVT="db:photoevent:miscount";T.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";T.prototype.MONTH_PREFIX="m_";T.prototype.COLLECTION_PREFIX="c_";T.prototype.EVENT_PREFIX="e_";T.prototype.MISSING_TIMESTAMP_PREFIX="a_";T.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;T.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;T.timeline;T.unique_id;T.name;T.init_num_photos;T.photos;T.header_html;T.placeholder_html;T.top_offset;T.loading_metadata;T.cursor;T.num_photos_loaded;T.prototype.LOADING_ORDER_NOT_DECIDED=-1;T.prototype.LOADING_ORDER_TOP_DOWN=0;T.prototype.LOADING_ORDER_BOTTOM_UP=1;T.loading_order;T.num_photos_to_load;T.on_load_all_metadata;T.init_sel_items;T.scroll_to_first_sel;T.num_to_select;T.logged_thumbs_arrived;T.timing_metadata_received;T.timing_stopped_scrolling_on_event;T.scroll_count;function T(ff,fc,e8,fd,e7,fb){var fa,fg,e9,fe;this.timeline=ff;this.unique_id=fc;this.name=e8;this.init_num_photos=fd;this.photos=(function(){var fi,fh;fh=[];for(fa=fi=0;0<=fd?fi<fd:fi>fd;fa=0<=fd?++fi:--fi){fh.push(new G(this))}return fh}).call(this);this.init_sel_items={};for(e9=0,fe=e7.length;e9<fe;e9++){fg=e7[e9];this.init_sel_items[fg]=true}this.num_to_select=e7.length;this.scroll_to_first_sel=fb;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(fd===0){$("single-album-empty").show()}}T.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};T.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};T.prototype.get_month=function(){var e7;cC(this.is_month(),"this must be a month event");e7=parseInt(this.unique_id.slice(6,8),10);cC(!isNaN(e7),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return e7};T.prototype.get_year=function(){var e7;cC(this.is_month(),"this must be a month event");e7=parseInt(this.unique_id.slice(2,6),10);cC(!isNaN(e7),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return e7};T.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};T.prototype.get_collection_gid=function(){cC(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};T.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};T.prototype._generate_container_html=function(){var fa,e8,fb,fd,e9,e7,fc;fd=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(fd);fa=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});fa.__date(cp.html("web","event_add_to_album"));this.header_html.__sert(fa);fc=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});fc.__date(cp.html("web","event_share"));this.header_html.__sert(fc);e7=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});e7.__date(cp.html("web","event_select"));this.header_html.__sert(e7)}else{this.header_html=new e2("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+fd+"</span></h1>")}e8=this.get_content_height();e9=this.photos.length%this.timeline.THUMBS_PER_ROW;fb=e9===0?0:(this.timeline.THUMBS_PER_ROW-e9)*this.timeline.THUMB_SIZE;return this.placeholder_html=new e2('<div style="height: '+e8+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+e8+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+fb+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};T.prototype.add_html_elements_to=function(e8){var e7;if(this.is_event()){e7=new Element("div",{"class":"photo-event"});e7.__sert(this.header_html);e7.__sert(this.placeholder_html);return e8.__sert(e7)}else{e8.__sert(this.header_html);return e8.__sert(this.placeholder_html)}};T.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};T.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};T.prototype.add_to_timeline_nav=function(fe){var e7,fc,ff,e8,fg,fb,fa,fd,e9;if(fe==null){fe=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}e9=this.timeline.get_viewport_info().height;fg=this.timeline.TIMELINE_NAV_ELM_HEIGHT;fb=$(document.body).getHeight();fa=this.top_offset/fb*100;if(this.is_event()){e8=this.name}else{if(this.is_missing_timestamp_bucket()){e8=er("Missing dates")}else{e8=bY.month_abbr_with_year(this.get_month()-1,this.get_year())}}ff=false;for(fd in this.timeline.grid.side_nav){e7=Math.abs(this.timeline.events.valueFromKey(fd).top_offset-this.top_offset);if(e7/fb*e9<fg){ff=true;if(fe){by("#timeline-nav-"+fd).remove()}}}fc=by("#timeline-nav-"+this.unique_id);if(!ff||fe){if(fc.length){fc.css("top",""+fa+"%")}else{fc=by("<div/>");fc.addClass("timeline-elm");fc.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});fc.css("top",""+fa+"%");fc.text(e8);by("#timeline-nav").append(fc)}return this.timeline.grid.side_nav[this.unique_id]=fa}else{if(fc.length){return fc.remove()}}};T.prototype.marquee_highlight=function(e7,fe,fb){var e9,ff,e8,fg,fi,fa,fd,fc,fh;if(this.top_offset>fe||this.top_offset+this.get_height()<e7){return}if(e7<this.top_offset){fe-=this.top_offset;if(fe<this.timeline.HEADER_HEIGHT){return}fa=0;fi=Math.floor((fe-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(fe>this.top_offset+this.get_height()){e7-=this.top_offset;fi=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(e7<this.timeline.HEADER_HEIGHT){fa=0}else{fa=Math.floor((e7-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{e7-=this.top_offset;fe-=this.top_offset;if(e7<this.timeline.HEADER_HEIGHT&&fe<this.timeline.HEADER_HEIGHT){return}else{if(e7<this.timeline.HEADER_HEIGHT){fa=0;fi=Math.floor((fe-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{fa=Math.floor((e7-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fi=Math.floor((fe-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(fg=fd=fa;fa<=fi?fd<=fi:fd>=fi;fg=fa<=fi?++fd:--fd){for(fc=0,fh=fb.length;fc<fh;fc++){e9=fb[fc];ff=this.timeline.THUMBS_PER_ROW*fg+e9;if(ff<this.photos.length){e8=this.photos[ff];if(e8.status!==G.PLACEHOLDER&&!eL.contains(e8)){eL._highlight(e8)}}}}};T.prototype.add_photos=function(fa){var e9,e8,fb,fc,e7;for(fc=0,e7=fa.length;fc<e7;fc++){fb=fa[fc];e8=fb.photo;e9=fb.index;cC(e9<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(e9,0,e8);if(e8.status>=G.LOADED){e8.status=G.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};T.prototype.remove_photos=function(ff){var fc,e7,fb,fd,e8,e9,fe,fa;fc=this.timeline.events.indexOfKey(this.unique_id);e8=[];for(e9=0,fe=ff.length;e9<fe;e9++){e7=ff[e9];fb=this.photos.indexOf(e7);cC(fb>-1,"Photo not found in the photos array!");this.photos.splice(fb,1);if(e7.status>=G.LOADED){this.num_photos_loaded--;if((fa=$(e7.uniqueness_key))!=null){fa.remove()}e7.status=G.LOADED}eL._remove(e7);e8.push({photo:e7,index:fb})}this._num_photos_changed();fd={removed_photos_and_indexes:e8};if(this.photos.length===0){fd.removed_event_index=fc}return fd};T.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};T.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};T.prototype._update_placeholder_container=function(){var e8,e7;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});e7=this.photos.length%this.timeline.THUMBS_PER_ROW;e8=e7!==0?(this.timeline.THUMBS_PER_ROW-e7)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+e8+"px"})};T.prototype.load_metadata=function(fe){var e9,e8,fd,e7,fb,fc,fa;e7=0;if((!this._is_valid_photo_index(fe))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}e7=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=fe*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}e7=this._is_loading_from_bottom()?this.photos.length-fe:fe+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,e7);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;fb={show_hidden:bK.show_hidden};if(this.cursor!=null){fb.cursor=this.cursor}if(this._is_loading_from_bottom()){fb.chron_order=true}fb.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(fb.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){fb.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){fc=this.unique_id.split("_");e9=fc[2];e8=fc[1];fb.filters=JSON.stringify({date_begin:e9,date_end:e8},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){fb.filters=JSON.stringify({other:true})}else{if(this.is_month()){fa=this.get_year();fd=this.get_month();e9=dX.to_iso8601_date(new Date(fa,fd-1,1,0,0,0,0),false,true);e8=dX.to_iso8601_date(new Date(fa,fd,1,0,0,0),false,true);fb.filters=JSON.stringify({date_begin:e9,date_end:e8},{year:fa,month:fd})}else{if(this.is_collection()){fb.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cC(false,"invalid photo event id: "+this.unique_id)}}}}return new cv.WebRequest({url:"/photos_event_metadata",data:fb,dataType:"json",success:(function(ff){return function(fg){ff.timing_metadata_received=bY.time();ff.cursor=fg.cursor;return ff._load_metadata_callback(fg.photos,fg.key_to_duplicates,(fg.more!=null)&&fg.more)}})(this)})};T.prototype.load_metadata_range=function(e8,e7){if(!(this._is_valid_photo_index(e8)&&this._is_valid_photo_index(e7))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=e8*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(e8)}else{return this.load_metadata(e7)}};T.prototype.load_cached_metadata=function(){var e7,e8;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((e8=bK.event_metadata_cache)!=null?e8[this.unique_id]:void 0)==null)){return false}e7=bK.event_metadata_cache[this.unique_id];this.cursor=e7.cursor;this._load_metadata_callback(e7.photos,e7.key_to_duplicates,e7.more);return true};T.prototype._load_metadata_callback=function(fj,fc,fd){var fi,fe,fo,ff,fp,e9,fg,fm,fb,fk,fa,fh,e8,e7,fl,fn;ff=[];fb=[];fh=false;for(fi=e8=0,fl=fj.length;e8<fl;fi=++e8){fg=fj[fi];if(this.has_loaded_metadata()){e9=new G(this);if(this._is_loading_from_bottom()){this.photos.unshift(e9)}else{this.photos.push(e9)}fh=true}else{if(this.num_photos_loaded<this.photos.length){fe=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;e9=this.photos[fe]}else{cC(false,"num_photos_loaded should never be greater than photos.length")}}e9.init_metadata(fg);if(e9.uniqueness_key in fc){e9.set_duplicates(fc[e9.uniqueness_key])}if(fi<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){fb.push(e9.preview_obj)}ff.push(e9)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var ft,fs,fr,fq;fq=[];for(fs=0,fr=fb.length;fs<fr;fs++){ft=fb[fs];fq.push(ft.preload())}return fq}),500)}eL.refresh(ff);for(e7=0,fn=ff.length;e7<fn;e7++){e9=ff[e7];if(e9.item_counter in this.init_sel_items){eL._add(e9);this.num_to_select--;if(this.num_to_select===0){eL.dec_num_loading_events_before_select()}delete this.init_sel_items[e9.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;fa=this.timeline;fo=e9.uniqueness_key;by(document).ready(function(){return fa.scroll_to_photo_with_key(fo)})}}}if(!fd){if(this.num_photos_loaded<this.photos.length){fp=this.photos.length-this.num_photos_loaded;fk=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fk,fp);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fh||fp){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(T.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){fm=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(fm)}};T.prototype._fix_photo_miscount=function(){var e9,e8,e7;e9=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);e8=this.get_num_rows()-e9;if(typeof g!=="undefined"&&g!==null){g.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}e7=y.scroll_offsets().top;if(this.top_offset+this.get_height()<e7){y.scroll_to(0,e7+e8*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(T.EVENT_MISCOUNT_EVT,this)};T.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};T.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};T.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};T.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};T.prototype.visible_thumbs_loaded=function(e9){var fd,fc,e8,e7,fb,fa;if(e9==null){e9=this.timeline.get_viewport_info()}fa=this.get_photo_range_to_render(e9,false),fd=fa[0],fc=fa[1];if(fd===null&&fc===null){return true}for(e7=fb=fd;fd<=fc?fb<=fc:fb>=fc;e7=fd<=fc?++fb:--fb){e8=this.photos[e7];if((e8==null)||!(e8.status>=G.RENDERED)){return false}}return true};T.prototype._is_loaded=function(e7){var e8,e9;if(this._is_loading_from_bottom()){e9=this.photos.length-this.num_photos_loaded;e8=this.photos.length-1}else{e9=0;e8=this.num_photos_loaded-1}return(e9<=e7&&e7<=e8)};T.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};T.prototype._is_valid_photo_index=function(e7){return(e7!=null)&&(e7>=0)&&(e7<=this.photos.length-1)};T.prototype.update_photo_divs=function(){var e9,e8,fo,fn,fs,fv,fp,fk,fe,fw,fm,ft,fi,ff,fc,fa,fx,fy,e7,fu,fl,fj,fh,fd,fb,fg,fr,fq;if(!this.num_photos_loaded){return}ft=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(ft)){return}fu=this.get_photo_range_to_render(ft),fo=fu[0],fn=fu[1];cC((fo!=null)&&(fn!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fo))||(!this._is_loaded(fn)))){this.load_metadata_range(fo,fn);if(this._is_loading_from_bottom()){fo=Math.max(fo,this.photos.length-this.num_photos_loaded)}else{fn=Math.min(fn,this.num_photos_loaded-1)}if(fo>fn){return}}fv=Math.floor(fo/this.timeline.THUMBS_PER_ROW);fm=fv*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:fm+"px"});fs=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fn/this.timeline.THUMBS_PER_ROW);e8=fs*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:e8+"px"});this._hide_photos((function(){fg=[];for(var fz=0;0<=fo?fz<fo:fz>fo;0<=fo?fz++:fz--){fg.push(fz)}return fg}).apply(this));this._hide_photos((function(){fr=[];for(var fz=fl=fn+1,fA=this.photos.length;fl<=fA?fz<fA:fz>fA;fl<=fA?fz++:fz--){fr.push(fz)}return fr}).apply(this));this._show_photos((function(){fq=[];for(var fz=fo;fo<=fn?fz<=fn:fz>=fn;fo<=fn?fz++:fz--){fq.push(fz)}return fq}).apply(this));fh=eL.get();for(fa=0,fx=fh.length;fa<fx;fa++){fk=fh[fa];if((fd=$(fk.uniqueness_key))!=null){fd.addClassName("selected")}}this.scroll_count=bK.scroll_count;e9=[];fb=this.get_thumb_indexes_to_load(ft);for(e7=0,fy=fb.length;e7<fy;e7++){fe=fb[e7];fk=this.photos[fe];if((fk!=null)&&fk.status>=G.RENDERED){fw=$(fk.uniqueness_key);if((fw!=null?fw.down("img"):void 0)!=null){e9.push(fw.down("img"))}}}fp=function(fz){return fz.up(".cu-thumb").addClassName("thumb-loaded")};return bm.batch_load_thumbs(e9,this.timeline.THUMBS_BATCH_SIZE,fp,this.log_thumb_load.bind(this))};T.prototype._hide_photos=function(fb){var e9,fa,e8,e7;e7=[];for(fa=0,e8=fb.length;fa<e8;fa++){e9=fb[fa];e7.push(this._hide_photo(e9))}return e7};T.prototype._hide_photo=function(e7){var e8;e8=this.photos[e7];if((e8==null)||!(e8.status===G.DISPLAYED)){return}$(e8.uniqueness_key).hide();return e8.status=G.RENDERED};T.prototype._show_photos=function(fn){var fj,fi,fm,fb,fk,fg,fa,fh,ff,fd,fc,fl,e9,e8,e7,fe;fb=[];for(fh=0,fl=fn.length;fh<fl;fh++){fi=fn[fh];fk=this._get_photo_insert_info(fi);if(!fk){continue}fm=fk[0],fa=fk[1];fg=false;for(ff=0,e9=fb.length;ff<e9;ff++){fj=fb[ff];if(fj.after===fm){fj.photos.push(fa);fg=true;break}}if(!fg){fb.push({after:fm,photos:[fa]})}}for(fd=0,e8=fb.length;fd<e8;fd++){fj=fb[fd];fj.after.__sert({after:fj.photos})}fe=[];for(fc=0,e7=fn.length;fc<e7;fc++){fi=fn[fc];fe.push(this.photos[fi].status=G.DISPLAYED)}return fe};T.prototype._get_photo_insert_info=function(e7){var fa,e8,e9,fe,fb,fd,fc;e9=this.photos[e7];if((e9==null)||e9.status===G.DISPLAYED){return}if(e9.status===G.RENDERED){$(e9.uniqueness_key).show()}else{e8=$("p-top-"+this.unique_id);if(e7!==0){for(fa=fd=fc=e7-1;fc<=0?fd<=0:fd>=0;fa=fc<=0?++fd:--fd){fe=this.photos[fa];if((fe!=null)&&fe.status>=G.RENDERED){fb=$(fe.uniqueness_key);cC(fb!=null,"photo "+fa+" was marked as rendered, but its thumb elm doesn't exist");e8=fb;break}}}return[e8,e9.thumb_html]}};T.prototype.in_y_range=function(e8,e7){return !(this.top_offset+this.timeline.HEADER_HEIGHT>e7||this.top_offset+this.get_height()<e8)};T.prototype.in_current_viewport=function(e9,fb){var e7,e8,fa;if(e9==null){e9=this.timeline.get_viewport_info()}if(fb==null){fb=true}e8=e9.top;e7=e9.top+e9.height;if(fb){fa=this._blur_range(e8,e7,e9),e8=fa[0],e7=fa[1]}return this.in_y_range(e8,e7)};T.prototype.hide_photos_if_not_in_current_viewport=function(fa){var e8,fc,e9,fb,e7,fd;if(!this.in_current_viewport(fa)){if(this._is_loading_from_bottom()){for(e8=fc=fb=this.photos.length-this.num_photos_loaded,e7=this.photos.length;fb<=e7?fc<e7:fc>e7;e8=fb<=e7?++fc:--fc){this._hide_photo(e8)}}else{for(e8=e9=0,fd=this.num_photos_loaded;0<=fd?e9<fd:e9>fd;e8=0<=fd?++e9:--e9){this._hide_photo(e8)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};T.prototype._blur_range=function(fa,e7,fc){var e9,e8,fb;if(fc==null){fc=this.timeline.get_viewport_info()}fb=dq.get();if(fb>=0){e8=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;e9=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(fb<0){e8=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;e9=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}fa-=e8*fc.height;e7+=e9*fc.height;return[fa,e7]};T.prototype.get_photo_range_to_render=function(ff,e9){var fd,e8,fc,fe,fb,e7,fa;if(e9==null){e9=true}e7=ff.top;fb=ff.bottom;if(e9){fa=this._blur_range(e7,fb,ff),e7=fa[0],fb=fa[1]}if(!this.in_y_range(e7,fb)){return[null,null]}fe=Math.floor((e7-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fd=Math.floor((fb-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);e8=Math.min(this.photos.length-1,fe*this.timeline.THUMBS_PER_ROW);fc=Math.min(this.photos.length-1,(fd+1)*this.timeline.THUMBS_PER_ROW-1);cC(!isNaN(fc),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+ff.bottom+" ")+("viewport_data.height="+ff.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+fd+" "),true,["photo_event_nan_limit"]);return[Math.max(0,e8),fc]};T.prototype.get_photo_range_to_render_with_blur=function(fa){var e8,fd,e9,fc,fb,e7;fb=this.get_photo_range_to_render(fa,true),fd=fb[0],fc=fb[1];e7=this.get_photo_range_to_render(fa,false),e8=e7[0],e9=e7[1];return[fd,e8,e9,fc]};T.prototype.get_thumb_indexes_to_load=function(fk){var fr,fh,ff,fe,fo,fq,fn,fp,fl,fb,e9,e8,e7,fm,fd,fc,fa,fj,fi,fg;fm=this.get_photo_range_to_render_with_blur(fk),fh=fm[0],fr=fm[1],ff=fm[2],fe=fm[3];if(fr==null){fo=(function(){fa=[];for(var fs=fh;fh<=fe?fs<=fe:fs>=fe;fh<=fe?fs++:fs--){fa.push(fs)}return fa}).apply(this);if(this.top_offset>fk.bottom){return fo}else{return fo.reverse()}}fp=(function(){fj=[];for(var fs=fr;fr<=ff?fs<=ff:fs>=ff;fr<=ff?fs++:fs--){fj.push(fs)}return fj}).apply(this);fq=[];fn=[];if(fh<fr){fq=(function(){fi=[];for(var fs=fd=fr-1;fd<=fh?fs<=fh:fs>=fh;fd<=fh?fs++:fs--){fi.push(fs)}return fi}).apply(this)}if(fe>ff){fn=(function(){fg=[];for(var fs=fc=ff+1;fc<=fe?fs<=fe:fs>=fe;fc<=fe?fs++:fs--){fg.push(fs)}return fg}).apply(this)}fl=dq.get();if(fl>=0){return fp.concat(fn).concat(fq)}else{return fp.concat(fq).concat(fn)}};T.prototype.log_thumb_load=function(e8,e9){var fb,e7,fa;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bK.scroll_count&&!this.logged_thumbs_arrived){if((e8+1)%this.timeline.THUMBS_PER_ROW===0||e8+1===e9){if(this.visible_thumbs_loaded()){e7=this.timeline.get_viewport_info();fb=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<e7.bottom&&e7.bottom<this.top_offset+this.get_height())||fb){if(bK.scroll_count<2&&((fa=g.get_current_view())===cf.PHOTOS_VIEW||fa===cf.CAMERA_VIEW)){this.log_timing_event(F.viewport_initial_load);bK.scroll_count+=2}else{this.log_timing_event(F.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};T.prototype.log_timing_event=function(fa){var e7,e8,fb,e9;e8=bY.time();e7={};if(fa===F.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(e9=performance.timing)!=null?e9.navigationStart:void 0:void 0)!=null){fb=bY.time()-performance.timing.navigationStart;e7={current_view:g.get_current_view()};d9.log_ajax_transition(fb,fa,e7,fa)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(fa===F.viewport_loaded){fb=e8-this.timing_stopped_scrolling_on_event}return d9.log_ajax_transition(fb,fa,e7,fa)};return T})();var G;G=A.Photo=(function(){T.PLACEHOLDER=0;T.LOADED=1;T.RENDERED=2;T.DISPLAYED=3;T.uniqueness_key;T.item_counter;T.filename;T.ns_id;T.ns_path;T.fq_path;T.href;T.thumbnail_url;T.large_thumbnail_url;T.time_taken;T.display_time_taken;T.preview_type;T.mtime;T.video_streaming_url;T.is_visible;T.user_id;T.event;T.status;T.thumb_html;T.preview_obj;T.duplicates_info;function T(e7){this.event=e7;this.status=T.PLACEHOLDER;this.preview_obj=e7.unique_id}T.prototype.init_metadata=function(e7){this.uniqueness_key=e7.uniqueness_key;this.item_counter=e7.item_counter;this.filename=e7.filename;this.ns_id=e7.ns_id;this.ns_path=e7.ns_path;this.fq_path=e7.path;this.href=e7.href;this.thumbnail_url=e7.thumbnail_url;this.large_thumbnail_url=e7.large_thumbnail_url;this.time_taken=e7.time_taken;this.display_time_taken=e7.display_time_taken;this.preview_type=e7.preview_type;this.mtime=e7.mtime;this.video_streaming_url=e7.video_streaming_url;this.is_visible=e7.is_visible;this.user_id=e7.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cp});this.preview_obj=this._get_preview_obj();this.status=T.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};T.prototype.set_duplicates=function(e9){var e8,fa,e7;for(fa=0,e7=e9.length;fa<e7;fa++){e8=e9[fa];e8.fq_path=e8.path}return this.duplicates_info=e9};T.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bK.in_single_collection_view()){return new eI({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dh({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bK.in_single_collection_view()){return new am({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new eP({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:C.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};T.prototype._get_display_date=function(){var e7;if(this.time_taken!=null){e7=new Date(this.time_taken);return bY.nice_date_with_month_name(e7,e7.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return T})();var Y;Y=A.PhotoCollection=(function(){T.CREATE_EVT="db:photocollection:create";T.ADD_EVT="db:photocollection:add";T.REMOVE_EVT="db:photocollection:remove";T.UNDO_REMOVE_EVT="db:photocollection:undo_remove";T.RENAME_EVT="db:photocollection:rename";T.DELETE_EVT="db:photocollection:delete";T.SHARE_EVT="db:photocollection:share";T.UNSHARE_EVT="db:photocollection:unshare";T.COVER_CHANGE_EVT="db:photocollection:cover_change";T.gid;T.name;T.num_items;T.num_photos;T.num_videos;T.thumbnail_url_32;T.thumbnail_url_256;T.is_anonymous;T.share_tkey;T.shmodel_url;T.short_url;T.is_creator;T.member_fnames;function T(e8,e7){if(e7==null){e7=true}cC((e8.gid!=null)&&(e8.url!=null)&&(e8.name!=null)&&(e8.num_items!=null)&&(e8.num_photos!=null)&&(e8.num_videos!=null),"missing required PhotoCollection params");this.gid=e8.gid;this.url=e8.url;this.name=e8.name;this.num_items=e8.num_items;this.num_photos=e8.num_photos;this.num_videos=e8.num_videos;this.thumbnail_url_32=e8.thumbnail_url_32||null;this.thumbnail_url_256=e8.thumbnail_url_256||null;this.is_anonymous=e8.is_anonymous!=null?e8.is_anonymous:false;this.share_tkey=e8.share_tkey||null;this.shmodel_url=e8.shmodel_url||null;this.short_url=e8.short_url||null;this.is_creator=e8.is_creator!=null?e8.is_creator:true;this.member_fnames=e8.member_fnames||[er("You")];if(e7){document.fire(T.CREATE_EVT,{collection:this})}}T.prototype.add_photos=function(fd,fc,e9,fb){var e7,fa,e8;if(e9==null){e9=false}if(fb==null){fb=true}e7=(function(){var fg,ff,fe;fe=[];for(fg=0,ff=fd.length;fg<ff;fg++){e8=fd[fg];fe.push(e8.item_counter)}return fe})();cC(e7.length,"Have to add at least one photo");fa={collection_gid:this.gid,item_counters:JSON.stringify(e7),source_collection_gid:fc};return new Ajax.DBRequest("/collection_add",{parameters:fa,job:e9,job_user:cD.get_viewer().photos_user,progress_text:er("Adding to album..."),onSuccess:(function(fe){return function(fh){var ff,fi,fg,fj;fj=JSON.parse(fh.responseText);fe.thumbnail_url_32=fj.thumbnail_url_32;fe.thumbnail_url_256=fj.thumbnail_url_256;fi=fj.new_num_photos-fe.num_photos;fg=fj.new_num_videos-fe.num_videos;ff=fj.new_num_items-fe.num_items;fe.num_photos=fj.new_num_photos;fe.num_videos=fj.new_num_videos;fe.num_items=fj.new_num_items;return document.fire(T.ADD_EVT,{collection:fe,photos:fd,num_items_added:ff,num_photos_added:fi,num_videos_added:fg,promote_collection:fb})}})(this)})};T.prototype.remove_photos=function(fa,e9){var e7,e8;if(e9==null){e9=false}e7=(function(){var fd,fc,fb;fb=[];for(fd=0,fc=fa.length;fd<fc;fd++){e8=fa[fd];fb.push(e8.item_counter)}return fb})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(e7),is_shared:this.share_tkey!=null,num_items:this.num_items},job:e9,job_user:cD.get_viewer().photos_user,progress_text:er("Removing from album..."),onSuccess:(function(fb){return function(fc){var fd;fd=JSON.parse(fc.responseText);fb.thumbnail_url_32=fd.thumbnail_url_32;fb.thumbnail_url_256=fd.thumbnail_url_256;fb.num_photos=fd.new_num_photos;fb.num_videos=fd.new_num_videos;fb.num_items=fd.new_num_items;return document.fire(T.REMOVE_EVT,{collection:fb,photos:fa,undo_changeset:fd.undo_changeset})}})(this)})};T.prototype.undo_remove=function(e7){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:e7},html_in_error_msg:true,progress_text:er("Undoing..."),onSuccess:(function(e8){return function(){return document.fire(T.UNDO_REMOVE_EVT,{collection:e8})}})(this)})};T.prototype.rename=function(e8){var e7;bK.enable_selection();e7=new Ajax.InPlaceEditor(e8,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return by("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:er("Saving..."),onLeaveEditMode:bK.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(e9){return function(fa){e9.name=fa.responseText;return document.fire(T.RENAME_EVT,{collection:e9})}})(this)},callback:(function(e9){return function(fa,fb){return{collection_gid:e9.gid,new_collection_name:fb,is_shared:e9.share_tkey!=null}}})(this)});return e7.enterEditMode()};T.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cD.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cD.get_viewer().photos_user,onSuccess:(function(e7){return function(){return document.fire(T.DELETE_EVT,{collection:e7})}})(this)})};T.prototype.attach_to_token=function(e9,fb,e8,fa,e7){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:e9,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(fc){return function(){fc.share_tkey=e9;fc.shmodel_url=fb;fc.short_url=e8;if(typeof fa==="function"){fa()}return document.fire(T.SHARE_EVT,{collection:fc})}})(this),onFailure:function(){return typeof e7==="function"?e7():void 0}})};T.prototype.send_link=function(e8,fa,fe,e9,fd,e7){var fc,fb;fc=(function(ff){return function(){ff.share_tkey=fa;ff.shmodel_url=fe;ff.short_url=e9;if(typeof fd==="function"){fd()}return document.fire(T.SHARE_EVT,{collection:ff})}})(this);fb={collection_gid:this.gid,share_tkey:fa,num_items:this.num_items};return bN.ajax_submit(e8,"/collection_share",fc,e7,e8.down(".tokenizer-submit-button"),fb)};T.prototype.unshare=function(){cC(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(e7){return function(){e7.share_tkey=null;e7.shmodel_url=null;e7.short_url=null;return document.fire(T.UNSHARE_EVT,{collection:e7})}})(this),subject_user:cD.get_viewer().photos_user})};T.prototype.set_cover=function(e7){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:e7.item_counter},onSuccess:(function(e8){return function(e9){var fa;fa=JSON.parse(e9.responseText);e8.thumbnail_url_32=fa.thumbnail_url_32;e8.thumbnail_url_256=fa.thumbnail_url_256;return document.fire(T.COVER_CHANGE_EVT,{collection:e8})}})(this)})};return T})();var bZ,j;bZ=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=A.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,_pdfLoader:new aq(),init_pdf:function(fb,fa,e8,T){var e7,e9;this._pdfLink=T;this.iframe_src=fa;this._log_pdf_render_time(fb);if(fb==="pdf-native"||fb==="pdf-embedded"||fb==="pdf-js"){window.addEventListener("message",j,false);by((function(fc){return function(){var fg,ff,fe,fd;fd=C.parse(fa);fg=by("#pdf-embed-container");if(fg.attr("data-docpreview-annotation-marker-enabled")==="True"){fd=fd.updateQuery("annotation_marker","1")}if(fg.attr("data-docpreview-annotation-highlight-enabled")==="True"){fd=fd.updateQuery("annotation_highlight","1")}if(fg.attr("data-docpreview-annotation-region-enabled")==="True"){fd=fd.updateQuery("annotation_region","1")}if(fb==="pdf-js"){fe=fd.getQuery();fc._pdfLoader.startListening();fc._pdfLoader.openFile(fe.file);delete fe.file;fd.setQuery(fe)}ff=by("#pdf-embed-iframe");ff.attr("src",String(fd));ff.attr("type","application/pdf");ff.attr("allowfullscreen","");ff.addClass("pdfjs");by("html, body").addClass("full_height");return fc._fire_pdf_render_event()}})(this));this.preview_status=e8;if(bV.chrome){e9=function(){var fc;fc=by('link[rel="shortcut icon"]').remove();return by("head").append(fc)};setTimeout(e9,1000)}e7=$$("#pdf-embed-container iframe");return window.setTimeout(((function(fc){return function(){return e7.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(T){window.addEventListener("message",j,false);return by("#pdf-embed-iframe").attr("src",T)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return by((function(T){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(T){return function(){if(!window.htmlified_height){return T.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var T;if((T=$("htmlified-loading"))!=null){T.remove()}if(by("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(fa,fc,e7,e9,T,e8,fb){return by((function(fd){return function(){var fg,fe,ff;ff=fb.width()*0.9;fe=ff*0.55;fg=fd._video_preview_failed;if(e9==="hls"){fd.player=bn.embed("#video",{src:e7,type:"application/vnd.apple.mpegurl",width:ff,height:fe,controls:true,poster:T,onError:fg,onReady:fd._player_ready,metadata_link:e8})}else{by("#video").empty();if(fa){if(fc){fd.player=bn.embed("#video",{src:e7,type:"video/mp4",width:ff,height:fe,controls:true,poster:T,onError:fg,onReady:fd._player_ready,metadata_link:e8})}else{fg()}}else{fd.player=bn.embed("#video",{src:e7,type:"video/flv",width:ff,height:fe,controls:true,poster:T,onError:fg,onReady:fd._player_ready,metadata_link:e8})}}by(".vjs-poster").hide();by(".vjs-big-play-button").hide();fd.player.on("play",fd._onPlay);return fd.player.on("ended",fd._onEnded)}})(this))},photo_loaded:function(e8){var e7,T;if((e7=window.performance)!=null?(T=e7.timing)!=null?T.navigationStart:void 0:void 0){e8=e8-window.performance.timing.navigationStart;return d9.log_ajax_transition(e8,"file-preview-photo")}},switch_preview:function(e7,fa,fd){var fc,fb,e9,e8,T;e9=INLINE_JS.URI.parse(this.iframe_src);T=INLINE_JS.URI.parse(e9.getQuery().file);e8=T.updateQuery({revision_id:e7}).toString();fb=C.parse(this.iframe_src).updateQuery({file:e8});if(fa){fb.updateQuery({annotation_marker:"1"});fb.updateQuery({annotation_highlight:"1"});fb.updateQuery({annotation_region:"1"})}else{fb.removeQuery("annotation_marker");fb.removeQuery("annotation_highlight");fb.removeQuery("annotation_region")}fc=by("#pdf-embed-iframe");fc.attr("src",fb.toString());fc.on("load",fd);return this._fire_pdf_render_event()},_player_ready:function(){var T;T=function(){by(".vjs-poster").show();by(".vjs-big-play-button").show();return by(".vjs-big-play-button").focus()};return T.defer()},_onPlay:function(){by(".vjs-poster").hide();return by(".vjs-big-play-button").hide()},_onEnded:function(){by(".vjs-poster").show();by(".vjs-big-play-button").show();return by(".vjs-loading-spinner").hide()},_video_preview_failed:function(T){if(T==="needflash"){by("#video-preview-flash-message").show()}return bZ.preview_failed()},preview_failed:function(){var T;T=by(document.body);if(T.hasClass("shmodel-body")){T.removeClass("file-preview-body")}aa.error(er("Preview failed."));return by(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var T;if(document.createEvent&&window.dispatchEvent){T=document.createEvent("UIEvents");T.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(T)}},_log_pdf_render_time:function(e7){var T;T=function(fb){var e9,fa,e8;if((fa=window.performance)!=null?(e8=fa.timing)!=null?e8.navigationStart:void 0:void 0){e9=bY.time()-window.performance.timing.navigationStart;return d9.log_ajax_transition(e9,fb)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return T(e7)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return T(""+e7+"-parse")})},_getEmbedContainer:function(){var T;T=by("#pdf-embed-container, #html-container, #htmlified-wrapper, #code-wrapper");if(T.length!==1){T=[]}return T},nativePdfPrint:function(){var T,e8,e7;if(!by("body").hasClass("file-preview-body")||by("#pdf-embed-iframe").length!==1||(this._pdfLink==null)){return false}e7=C.parse(bV.get_href());e7.setQuery({preview:1,force_no_progressive:1});T=C.parse(this._pdfLink).getAuthority();e8=bP.getNativePrintUrl(e7.toString(),T,by("#pdf-embed-container"));if(e8==null){return false}window.open(e8,"_blank");return true},enter_rams_fullscreen:function(){return bP.enter_rams_fullscreen(by(this._getEmbedContainer()))},exit_rams_fullscreen:function(){return bP.exit_rams_fullscreen(by(this._getEmbedContainer()))},is_rams_fullscreen_active:function(){return bP.is_rams_fullscreen_active(by(this._getEmbedContainer()))}};j=function(fa){var e9,e7,e8,T;e7={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true};e7["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;e7["https://"+Constants.PUBSERVER]=true;e7[Constants.WEB_STATIC_DROPBOX]=true;if(e7[fa.origin]){e8={};try{e8=JSON.parse(fa.data);e9=e8.action}catch(fb){T=fb;e9=fa.data}switch(e9){case"failed":return bZ.preview_failed()}}};var ax;ax=A.ClientDownload=(function(){function T(){}T.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(e7){var e8;e8=by("<div",{"class":"brodal-header",text:er("Install Dropbox")});return eY.show(e8[0],$("client-download"),{},false,450)},subject_user:cl.active_user})};return T})();var cr,ee,g,F,a3,c3,cf;cr=A.AlbumsLogger={log_share:function(e7,fa,e9,e8,T){return cr.log(e7,fa,true,e9,e8,T)},log_event:function(T,e9,e8,e7){return cr.log(T,e9,false,e8,e7)},log:function(e7,fc,e9,fb,fa,T){var e8;e8={evt:e7,collection_gid:fc,is_anonymous:fa};if(e9!=null){e8.share_event=e9}if(fb!=null){e8.num_items=fb}if(T!=null){e8.on_create=T}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:e8})}};ee=INLINE_JS.PhotosEvents=A.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a3=INLINE_JS.PhotosTourEvents=A.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};c3=INLINE_JS.PhotosTriggers=A.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cf=A.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};g=INLINE_JS.PhotosLogger=A.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var T,e8,e7;T=((e7=$("modal"))!=null?e7.visible():void 0)&&$("shmodal").visible();e8=T?"-foshmodal":"";if(bK.in_single_collection_view()){return cf.SINGLE_COLLECTION_VIEW+e8}else{if(bK.in_all_collections_view()){return cf.ALBUMS_VIEW+e8}else{if(bK.initialized){return cf.PHOTOS_VIEW+e8}else{return cf.NOT_PHOTOS}}}},log_interaction:function(T,e7,e8){return g.log(T,e7,null,g.get_current_view(),e8)},log_transition_to:function(T){return g.log(T,null,null,g.get_current_view(),null,true)},log:function(e7,e8,T,fc,fa,fb){var e9;e9={evt:e7,trigger:e8,view:T};if(fa!=null){e9.data=JSON.stringify(fa)}if(fc!=null){e9.start_view=fc}if(fb!=null){e9.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:e9})}};F=A.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dC,aI;aI=A.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(T){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:T,url:window.location.href}})},attachLogListener:function(T,e7){if(e7==null){return}return e7.observe("click",function(e8){aI.log(T);if(e7.href&&e7.href!=="#"&&e7.target!=="_blank"){Event.stop(e8);return(function(){return window.location.href=e7.href}).defer()}})}};dC=A.RegistrationLogger={log:function(T){var e7;e7=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:T,url:e7}})},attachLogListener:function(T,e7){if(e7==null){return}return e7.observe("click",function(e8){dC.log(T);if(e7.href&&e7.href!=="#"&&e7.target!=="_blank"){Event.stop(e8);return(function(){return window.location.href=e7.href}).defer()}})}};var d;d=A.ModalFlow=(function(){function T(ff,fd,fh,e9,e8,fc,fg){var e7,fa,fe,fb;this.title=ff;this.icon=fd;this.states=fh;this.next_state_table=e9;this.previous_state_table=e8;this.initial=fc;this.onStart=fg;this._state_map={};fb=this.states;for(fa=0,fe=fb.length;fa<fe;fa++){e7=fb[fa];this._state_map[e7.name]=e7}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}T.prototype.start=function(){var fa,e9,e7,e8;this.vars={};e8=this.states;for(e9=0,e7=e8.length;e9<e7;e9++){fa=e8[e9];fa.next=this._next.bind(this,fa);fa.back=this._back.bind(this,fa);if(fa.onSubmit){fa.onSubmitFn=(function(fb,fc){fb.onSubmit(this,fb,fc);return false}).bind(this,fa)}else{fa.onSubmitFn=((function(fb){return function(fc,fd){fc.next();return false}})(this)).bind(this,fa)}fa.contents.on("submit",fa.onSubmitFn);fa.contents.find(".backbutton").on("click",fa.back)}eY.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};T.prototype.to_state=function(e8){var e7;this.state=this._state_map[e8];e7=this.title;if(this.state.title!=null){e7=this.state.title}eY.show(e7,this.state.contents[0]);return this.state.enter(this)};T.prototype._next=function(e7){var e8;if(e7===this.state){e8=this.next_state_table[this.state.name](this);if(e8==="__exit__"){return this.exit()}else{return this.to_state(e8)}}};T.prototype._back=function(e7){var e8;if(e7===this.state){e8=this.previous_state_table[this.state.name](this);if(e8==="__cancel__"){return this.exit()}else{if(e8){return this.to_state(e8)}}}};T.prototype.exit=function(){return this._onExit()};T.prototype._onExit=function(fe){var e9,e7,fc,fb,ff,e8,fd,fa;fd=this.states;for(fc=0,ff=fd.length;fc<ff;fc++){e7=fd[fc];e7.contents.off("submit",e7.onSubmitFn)}this._cleanUpExitListeners();fa=this._exit_listeners;for(fb=0,e8=fa.length;fb<e8;fb++){e9=fa[fb];e9(fe)}eY.onHide=null;return eY.hide()};T.prototype.addExitListener=function(e7){return this._exit_listeners.push(e7)};T.prototype.removeExitListener=function(e7){return this._cleanup_queue.push(e7)};T.prototype._cleanUpExitListeners=function(){var fa,e9,fc,e8,fb,e7;fb=this._cleanup_queue;e7=[];for(fc=0,e8=fb.length;fc<e8;fc++){fa=fb[fc];e9=this._exit_listeners.indexOf(fa);e7.push(this._exit_listeners.splice(e9,1))}return e7};return T})();var cx;cx=A.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(T){this._user=cD.get_viewer().get_user_by_id(T);cC(this._user,""+T+" is invalid");return by("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){by("#resend-link").on("click",this.resend_phone_code.bind(this));return by("#code").focus()},init:function(e7,T){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();dX.async_load_script(e7);return dX.async_load_script(T)},account_listen:function(){var fg,fb,T,e8,e9,fc,fa,fj,fe,fd,fk,e7,fi,ff,fh;fi={name:"delivery_choice",enter:(function(fl){return function(fm){var fn;fl.hide_error();fn=0;by(".delivery-choice").each(function(){var fo;fo=by(this).height();return fn=Math.max(fo,fn)});by(".delivery-choice").height(fn);return by(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:by("#twofactor-delivery-choice"),onSubmit:(function(fl){return function(fm,fn,fo){fm.vars.sms=!!(by("#use-sms")[0].getValue()==="on");if(!fm.vars.sms){return fl.fetch_offline_key(fm,fn)}else{return fn.next()}}})(this)};ff={name:"enter_phone_number",enter:(function(fl){return function(fn){var fo,fm;fl.hide_error();fl._is_offline_setup=false;fl._phone_number=null;fo=$("twofactor-enter-phone");fm=fl.fill_phone_number_for_edit(fo,by("#twofactor-row-"+fl._user.role+" #twofactor-sms-number").text());return fm.focus()}})(this),contents:by("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};fh={name:"offline_setup",enter:(function(fl){return function(fm){fl.hide_error();fl._is_offline_setup=true;return fl._phone_number=null}})(this),contents:by("#twofactor-offline-setup")};e7={name:"confirm_phone",enter:(function(fl){return function(fm){var fn;fl._invalid_code_count=0;if(fl._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fn=fm.vars.phone_number;cC(fn,"expected a display_phone argument");$("phone-number-placeholder").__date(fn);$("twofactor-enable-confirm").removeClassName("offline")}fl.hide_error();$("phone-code").clear().focus();return fl.fill_delivery_choice(fn)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:by("#twofactor-enable-confirm")};fk={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:by("#twofactor-enter-backup-phone")};fc=new d(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:by("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fl){return function(fm,fn){fl.successfully_enabled=false;fm.vars.mode="ENABLE";fm.vars.passed_password=true;return fn.next()}})(this)),contents:by("#twofactor-enter-password")},fi,ff,fh,e7,fk,{name:"recovery_code",enter:(function(fl){return function(){fl.fill_backup_phone(fl._backup_phone);return fl.hide_error.bind(fl)}})(this),onSubmit:this.submit_finish.bind(this,false),contents:by("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:er("Congrats! You've enabled two-step verification!"),contents:by("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:(function(fl){if(fl.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fl){if(fl.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});fc.addExitListener((function(fl){return function(fm){if(fc.vars.passed_password&&fm&&!fl.successfully_enabled){return aa.error(er("Two-step verification is not enabled"))}}})(this));e9=new d(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fl){return function(fn,fo){var fm;fl.successfully_enabled=false;by(".delivery-choice").removeClass("selected");fm=!by("#twofactor-row").hasClass("with-sms");by(fm?"#app-choice":"#sms-choice").addClass("selected");by("#twofactor-recovery").addClass("edit-mode");fn.vars.passed_password=true;return fo.next()}})(this)),contents:by("#twofactor-enter-password")},fi,ff,fh,e7,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:by("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:(function(fl){if(fl.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fl){if(fl.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});e9.addExitListener((function(fl){return function(fm){if(e9.vars.passed_password&&fm&&!fl.successfully_enabled){return aa.error(er("Two-step verification has not been changed"))}}})(this));T=new d(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fl){return function(fm,fn){fl.successfully_disabled=false;fm.vars.passed_password=true;return fn.next()}})(this)),contents:by("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:by("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});T.addExitListener((function(fl){return function(fm){if(T.vars.passed_password&&fm&&!fl.successfully_disabled){return aa.error(er("Two-step verification is still enabled"))}}})(this));fg=new d(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fl,fm){return fm.next()}),contents:by("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:by("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");e8=new d(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fl,fm){return fm.next()}),contents:by("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:by("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fj=new d(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fl){return function(fm,fn){return new Ajax.DBRequest(fl.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fl._checkpoint_token},onSuccess:function(fo){var fp;fp=fo.responseText.strip();if(fp.startsWith("OK:")){fl.fill_recovery_code(fp.substr(3),"backup-code-div-edit");return fn.next()}else{switch(fp){case"EXPIRED":return fl.show_error_expired();case"ALREADY_DISABLED":by("#twofactor-row").removeClass("twofactor-enabled");aa.success(er("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eY.hide()}}},onFailure:fl.show_error500.bind(fl),cleanUp:fl.hide_loading.bind(fl),subject_user:fl._user})}})(this)),contents:by("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:by("#twofactor-recovery-edit"),onSubmit:(function(fl){return function(fm,fn){fl._checkpoint_token=null;return fn.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");fd=(function(fl){return function(fm){return new Ajax.DBRequest(fl.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fl._checkpoint_token,device_response:JSON.stringify(fm)},noAutonotify:true,onSuccess:function(fn){var fo;fo=fn.responseText.strip();fb.to_state("register_success");return by(document).trigger("security-key-manager:UPDATE_KEYS",fl._user.id)},onFailure:function(fp){var fn,fo;fn=JSON.parse(fp.responseText.substr(4));fo=fn.security_key_register!=null?fn.security_key_register["message_text"]:aa.DEFAULT_ERROR;by("#twofactor-security-key-register-error #error-msg").text(fo);return fb.to_state("register_error")},cleanUp:fl.hide_loading.bind(fl),subject_user:fl._user})}})(this);fa=(function(fl){return function(fm,fn){return new Ajax.DBRequest(fl.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fl._checkpoint_token},onSuccess:function(fo){var fp;fp=JSON.parse(fo.responseText);u2f.register(fp.registerRequests,fp.authenticateRequests,fd);return fn.next()},onFailure:fl.show_error500.bind(fl),cleanUp:fl.hide_loading.bind(fl),subject_user:fl._user})}})(this);fe=new d(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"unsupported_browser",enter:this.hide_error.bind(this),contents:by("#twofactor-security-key-unsupported-browser")}],{unsupported_browser:function(){return"__exit__"}},{},"unsupported_browser");fb=new d(this.ADD_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,function(fl,fm){return fm.next()}),contents:by("#twofactor-enter-password")},{name:"intro",enter:this.hide_error.bind(this),contents:by("#twofactor-security-key-intro")},{name:"prepare_register",enter:this.hide_error.bind(this),contents:by("#twofactor-security-key-prepare-register"),onSubmit:fa},{name:"register",enter:this.hide_error.bind(this),contents:by("#twofactor-security-key-register")},{name:"register_error",enter:this.hide_error.bind(this),contents:by("#twofactor-security-key-register-error"),onSubmit:fa},{name:"register_success",enter:(function(fl){return function(){fl.hide_error.bind(fl);return fl._checkpoint_token=null}})(this),onSubmit:function(fl,fm){aa.success(er("Successfully added security key."));return fm.next()},contents:by("#twofactor-security-key-register-success")}],{password:function(){return"intro"},intro:function(){return"prepare_register"},prepare_register:function(){return"register"},register:function(){return"register_success"},register_error:function(){return"register"},register_success:function(){return"__exit__"}},{},"password");this._bind_phone_input_to_save_button();this._register_skip_link_click_to_submit_finish();by(".enable-twofactor").on("click",(function(fl){return function(fm){return fl.start_flow(fm,fc)}})(this));by(".disable-twofactor").on("click",(function(fl){return function(fm){return fl.start_flow(fm,T)}})(this));by(".add-twofactor-backup-link").on("click",(function(fl){return function(fm){return fl.start_flow(fm,fg)}})(this));by(".edit-twofactor-backup").on("click",(function(fl){return function(fm){return fl.start_flow(fm,e8)}})(this));by(".edit-twofactor-recovery").on("click",(function(fl){return function(fm){return fl.start_flow(fm,fj)}})(this));by(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fl){return function(fm){return fl.start_flow(fm,e9)}})(this));by(document).on("twofactor:ADD_SECURITY_KEY",(function(fl){return function(fn,fm){if(by("#twofactor-security-key-unsupported-browser").length){return fl.start_flow(fn,fe,fm)}else{return fl.start_flow(fn,fb,fm)}}})(this));by("#generate-new-recovery-code").on("click",(function(fl){return function(fm){fl.show_loading();return new Ajax.DBRequest(fl.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fl._checkpoint_token},onSuccess:function(fn){var fo;fo=fn.responseText.strip();if(fo.startsWith("OK:")){return fl.fill_recovery_code(fo.substr(3),"backup-code-div-edit")}else{switch(fo){case"EXPIRED":fj.to_state("password");return fl.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");aa.success(er("Two-step verification is disabled. Did you maybe disable it in another window?"));return eY.hide()}}},onFailure:fl.show_error500.bind(fl),cleanUp:fl.hide_loading.bind(fl),subject_user:fl._user})}})(this));by("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));by("#resend-link").on("click",this.enable_resend_phone_code.bind(this));by("#twofactor-delivery-choice input").change(function(){by(".delivery-choice").removeClass("selected");return by(this).parents(".delivery-choice").addClass("selected")});by("#show-qr").on("click",function(fl){by("#twofactor-offline-setup").addClass("showing-qr");return false});by("#hide-qr").on("click",function(fl){by("#twofactor-offline-setup").removeClass("showing-qr");return false});if(window.location.hash==="#backup2fa"&&by("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(fg)}},_bind_phone_input_to_save_button:function(){this.$save_button=by("#twofactor-enter-backup-phone").find(".back-next").find(".savebutton");this.$phone_input=by("#twofactor-enter-backup-phone").find(".twofactor-backup-phone-number").find(".phone-text");this.$phone_input.on("keyup",(function(T){return function(e7){return T._toggle_save_phone_button(T.$phone_input,T.$save_button)}})(this));this.$phone_input.on("input",(function(T){return function(e7){return T._toggle_save_phone_button(T.$phone_input,T.$save_button)}})(this));return this._toggle_save_phone_button(this.$phone_input,this.$save_button)},_register_skip_link_click_to_submit_finish:function(){return by("#twofactor-enter-backup-phone").find(".back-next").find("#skipstep").on("click",(function(T){return function(){return T.submit_finish(true,T._current_flow,T._current_flow.state,null)}})(this))},_toggle_save_phone_button:function(T,e7){var e8;e8=by.trim(T.val())==="";return e7.prop("disabled",e8)},start_flow:function(e8,e7,T){if(T==null){T=null}e8.preventDefault();if(T==null){T=by(e8.target).data("uid")}cx.set_user(cD.get_viewer().get_user_by_id(T));this._current_flow=e7;e7.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return by("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(e7){var T;if(this.is_resending()){return}this.show_resending();T="/twofactor_resend";if(by("#twofactor-confirm").hasClass("backup")){T=C.parse(T).updateQuery({backup:true}).toString()}new Ajax.DBRequest(T,{onSuccess:(function(e8){return function(e9){switch(e9.responseText.strip()){case"OK":e8.hide_error();return e8.notify_resent();case"UNREACHABLE":return e8.show_error_unreachable(true);case"BADCARRIER":return e8.show_error_bad_carrier();case"INVALIDNUMBER":return e8.show_error_invalid_number();case"NOTAMOBILE":return e8.show_error_not_a_mobile();case"RATELIMIT":return aa.error(er("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(e7){return function(e8){switch(e8.responseText.strip()){case"OK":e7.hide_error();return e7.notify_resent();case"UNREACHABLE":return aa.error(error_unreachable(true));case"BADCARRIER":return aa.error(error_bad_carrier());case"INVALIDNUMBER":return e7.show_error_invalid_number();case"NOTAMOBILE":return aa.error(error_not_a_mobile());case"RATELIMIT":return aa.error(er("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(e7){return function(e8){return aa.error(e7.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(e7){return function(e8){switch(e8.responseText.strip()){case"OK":e7.hide_error();return e7.notify_resent();case"UNREACHABLE":return e7.show_error_unreachable();case"BADCARRIER":return e7.show_error_bad_carrier();case"INVALIDNUMBER":return e7.show_error_invalid_number();case"NOTAMOBILE":return e7.show_error_not_a_mobile();case"RATELIMIT":return aa.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":e7._current_flow.to_state("password");return e7.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:er("Enable two-step verification"),DEFAULT_EDIT_TITLE:er("Edit two-step verification"),DEFAULT_DISABLE_TITLE:er("Disable two-step verification"),ADD_BACKUP_TITLE:er("Add a backup phone number"),EDIT_BACKUP_TITLE:er("Edit backup phone number"),EDIT_RECOVERY_TITLE:er("View recovery code"),ADD_SECURITY_KEY_TITLE:er("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var T;this.hide_error();by("#twofactor-recovery").removeClass("edit-mode");T=$("twofactor-enter-password");by("#password",T).val("").focus();return false},submit_password:function(e8,fb,T,e9,fa){var e7;e7=$("password").getValue();if(!e7){this.show_error(er("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(e8,{parameters:{password:e7},onSuccess:(function(fc){return function(fd){var fe;fe=fd.responseText.strip();if(fe.startsWith("OK:")){fc._checkpoint_token=fe.substr(3);return fb(T,e9)}else{switch(fe){case"EXPIRED_PASSWORD":return fc.show_error_expired_password();case"INVALID":return fc.show_error(er("Invalid password"));case"RATELIMIT":return fc.show_error(er("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");aa.success(er("Two-step verification is already enabled. Did you maybe enable it in another window?"));return eY.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");aa.success(er("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eY.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(T,e7){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(e8){return function(e9){var fa;fa=e9.responseText.strip();if(fa.startsWith("OK:")){e8.fill_key(fa.substr(3));return e7.next()}else{switch(fa){case"EXPIRED":T.to_state("password");return e8.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(e7){var T,e9,e8;e7=e7.replace(new RegExp("=+$"),"");T=e7.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(T);$("qr-div").__date();e8=Constants.IS_PROD?"Dropbox":"DropboxDev";e9={text:"otpauth://totp/"+e8+":"+this._user.email+"?secret="+e7+"&issuer="+e8,width:200,height:200};if(!Modernizr.canvas){e9.render="table"}by("#qr-div").qrcode(e9);if(!Modernizr.canvas){return by("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(e7,e9,fa){var T,e8;T=by("#twofactor-enter-phone .twofactor-phone-number");if(!y.controller(T).validate_on_submit()){return}e8=T.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:e8},onSuccess:(function(fb){return function(fc){switch(fc.responseText.strip()){case"OK":fb._phone_number=e8;e7.vars.phone_number=e8;return e9.next();case"EXPIRED":e7.to_state("password");return fb.show_error_expired();case"UNREACHABLE":return fb.show_error_unreachable(T);case"BADCARRIER":return fb.show_error_bad_carrier(T);case"INVALIDNUMBER":return fb.show_error_invalid_number(T);case"NOTAMOBILE":return fb.show_error_not_a_mobile(T);case"RATELIMIT":return fb.show_error(er("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(T,e7,e9){var e8;e8=$("phone-code").getValue().strip();if(!e8){this.show_error(er("Please enter the security code"));return}if(e8.search(/^\d{6}$/)===-1){this.show_error(er("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:e8},onSuccess:(function(fa){return function(fb){var fd,fc;fc=fb.responseText.strip();if(fc.startsWith("OK:")){fa.fill_recovery_code(fc.substr(3),"backup-code-div");return e7.next()}else{switch(fc){case"INVALID":fa._invalid_code_count+=1;fd=fa._invalid_code_count<=2?er("Invalid code"):fa._is_offline_setup?er("Invalid code. Check the clock on your phone: it must be accurate to the minute."):er("Invalid code");return fa.show_error(fd);case"EXPIRED":T.to_state("password");return fa.show_error_expired();case"RATELIMIT":return fa.show_error(er("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(e9,e7){var e8,T;this.hide_error();e8=$("twofactor-enter-backup-phone");T=this.fill_phone_number_for_edit(e8,by("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());T.focus();if(e9==="back_next"){by("#twofactor-backup-back-next").show();by("#twofactor-backup-cancel-save").hide();return by("#twofactor-backup-back-save").hide()}else{if(e9==="cancel_save"){by("#twofactor-backup-back-next").hide();by("#twofactor-backup-cancel-save").show();return by("#twofactor-backup-back-save").hide()}else{if(e9==="back_save"){by("#twofactor-backup-back-next").hide();by("#twofactor-backup-cancel-save").hide();return by("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(fa,e9,e7,fb,fc){var T,e8;T=by("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!y.controller(T).validate_on_blur()){return}e8=T.val();if(e8){if(this.is_primary_number(e8)){y.controller(T).show_error(er("You can't use your primary phone as your backup",T));return}}else{if(fa){y.controller(T).show_error(er("Please enter phone number",T));return}}this._backup_phone=e8;if(e9==="save_backup_phone"){this.save_added_backup_phone(e7,fa,e8)}else{if(e9==="save_everything"){this.submit_finish(false,e7,fb,fc)}else{if(e9==="save_none"){return fb.next()}}}},is_same_phone_number:function(e7,T){if(!e7||!T){return false}return e7.replace(/\D+/g,"")===T.replace(/\D+/g,"")},is_primary_number:function(T){var e7;e7=by("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(T,e7.data("primary_phone"))){return true}if(this.is_same_phone_number(T,by("#twofactor-sms-number",e7).text())){return true}return false},save_added_backup_phone:function(T,e8,e7){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:e7},onSuccess:(function(e9){return function(fa){var fb;switch(fa.responseText.strip()){case"OK":e9.hide_error();fb="#twofactor-row-"+e9._user.role;by(""+fb+" #twofactor-backup-number").text(e7);by(fb).toggleClass("with-backup",!!e7);if(!e7){aa.success(er("Backup phone number removed"))}else{if(!e8){aa.success(er("Backup phone number updated"))}else{aa.success(er("Backup phone number added"))}}return eY.hide();case"EXPIRED":T.to_state("password");return e9.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(e9,fb){var fa,e7,e8,T;e7=by(".sick-input > input",e9);if(!fb){return e7.val("")}T=by('select[name="country_code"]',e9);fa=/^\+\d+/.exec(fb);fa=fa?fa[0]:"";e8=this.option_for_country_code(T,fa);if(e8!=null){e8.selected=true}e7.val(by.trim(fb.slice(fa.length)));if(e7.length){e7[0].select()}return e7},option_for_country_code:function(T,e8){var e7;if(e8){e7=by('option[value="'+e8+'"]',T);if(e7.length>1){e7=e7.filter("[selected]")}if(e7.length){return e7[0]}}return by("option[selected]",T)[0]},fill_delivery_choice:function(T){by("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!T);by("#twofactor-delivery-offline-label").toggle(!T);by("#confirm-phone-primary-number").text(T);return by("#twofactor-row-"+this._user.role).data("primary_phone",T)},fill_backup_phone:function(T){by("#confirm-phone-backup").toggle(!!T);return by("#confirm-phone-backup-number").text(T)},fill_recovery_code:function(e7,T){e7=e7.toLowerCase().replace(/(.{4})/g,"$1 ");return $(T).__date(e7)},submit_finish:function(e7,T,e8,e9){var fa;this.show_loading();fa={checkpoint_token:this._checkpoint_token};if(this._backup_phone&&!e7){fa.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:fa,onSuccess:(function(fb){return function(fc){switch(fc.responseText.strip()){case"OK":fb.successfully_enabled=true;if(T.vars.mode!=="ENABLE"){return fb.after_enabled(T,e8)}else{return e8.next()}break;case"EXPIRED":T.to_state("password");return fb.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(e7,e8){var T;this._checkpoint_token=null;this.hide_error();T=by("#twofactor-row-"+this._user.role);T.toggleClass("with-sms",!!this._phone_number);by("#twofactor-sms-number",T).text(this._phone_number||"");T.toggleClass("with-backup",!!this._backup_phone);by("#twofactor-backup-number",T).text(this._backup_phone||"");T.addClass("twofactor-enabled");by("tr[id^='session_row_']").slice(1).hide();if(e7.vars.mode!=="ENABLE"){aa.success(er("Two-step verification updated"));return e8!=null?e8.next():void 0}},disable_submit:function(T,e7){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(e8){return function(fa){var e9;switch(fa.responseText.strip()){case"OK":e8.successfully_disabled=true;e8._checkpoint_token=null;e9=by("#twofactor-row-"+e8._user.role);e9.removeClass("twofactor-enabled with-sms with-backup");by(document).trigger("security-key-manager:UPDATE_KEYS",e8._user.id);by("#twofactor-sms-number, #twofactor-backup-number",e9).text("");by("tr[id^='session_row_']").slice(1).hide();aa.success(er("Two-step verification is now disabled."));return e7.next();case"EXPIRED":T.to_state("password");return e8.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(e8,T){var e7;if(T){y.controller(T).show_error(e8);return}e7=$$(this._error_selector);if(e8===this.error_expired_password()||e8===this.error_unreachable(true)){e7.invoke("update",e8)}else{e7.invoke("__date",e8)}return e7.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(T){return this.show_error(this.error_bad_carrier(),T)},show_error_invalid_number:function(T){return this.show_error(this.error_invalid_number(),T)},show_error_not_a_mobile:function(T){return this.show_error(this.error_not_a_mobile(),T)},show_error_unreachable:function(T,e7){if(e7==null){e7=false}return this.show_error(this.error_unreachable(e7),T)},show_error_expired:function(T){return this.show_error(this.error_expired(),T)},show_error_expired_password:function(T){return this.show_error(this.error_expired_password(),T)},error_500:function(){return er("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return er("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return er("That is not a valid phone number.")},error_not_a_mobile:function(){return er("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(T){if(T==null){T=false}if(T){return er('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return er("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return er("Since it's been a while, please enter your password again.")},error_expired_password:function(){return er('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return aa.success(er("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(e7){var T,e8;T=e7.element();e8=by(".sick-input",T.form);by("input",e8).val("").focus();return this.fill_example_phone_number(T,e8)},fill_example_phone_number:function(T,e9){var e8,e7;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){e8=by(T).val().substr(1);e7=phone_helpers.get_example_mobile_number(e8);return by("label",e9).text(er("Example: ")+e7)}},reset_phone_field_and_backup_country:function(e7){var T;this.reset_phone_field(e7);if(by("#backup-phone-number").val()===""){T=by("#twofactor-enter-backup-phone #country-code");T.val(e7.element().getValue());return this.fill_example_phone_number(T,by(".sick-input",T[0].form))}}};var bP,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};bP=A.FileViewRamsCommon={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1000,_PDF_PREVIEW_DOMAINS:["dl-doc.dropbox.com","dl-web.dropbox.com","dl.dropboxusercontent.com","dl-doc.dropboxusercontent.com"],_DEV_DOMAIN_SUFFIX:".dev.corp.dropbox.com",enter_rams_fullscreen:function(T){T.addClass("rams-fullscreen").data("rams-fullscreen",true);return by(window).resize()},exit_rams_fullscreen:function(T){T.removeClass("rams-fullscreen").removeData("rams-fullscreen");return by(window).resize()},is_rams_fullscreen_active:function(e7){var T;T=e7.data("rams-fullscreen");return(T!=null)&&T},_isPdfPreviewDomain:function(T){T=T.toLowerCase();return bE.call(this._PDF_PREVIEW_DOMAINS,T)>=0||T.endsWith(this._DEV_DOMAIN_SUFFIX)},_supportsNativePrinting:function(T){return T.attr("data-docpreview-pdf-native-print-enabled")==="True"},getNativePrintUrl:function(e8,T,e7){var e9;if(!this._supportsNativePrinting(e7)){return null}if(!this._isPdfPreviewDomain(T)){console.warn("Blocked attempt to load pdf native print for unexpected domain");return null}e9=C.parse("https://"+T+"/nativeprint");e9.updateQuery({file:e8});return e9.toString()}};var k,bE=[].indexOf||function(e8){for(var e7=0,T=this.length;e7<T;e7++){if(e7 in this&&this[e7]===e8){return e7}}return -1};k=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=A.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,_non_fullscreen_vert_overflow:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,file_view_mode:aQ.FileViewModeType.UNKNOWN,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,_preview_flippable_component:null,active_user:null,_pdfLoader:new aq(),_is_browse_drag_enabled:null,_file_view_attempts:0,globalPreviewStateModel:new Backbone.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new Backbone.Model({state:"hidden",file_extension:null}),_get_extension:function(e7){var T;T=e7.lastIndexOf(".");return(T===-1?"":e7.substr(T+1))},_get_preview_type_from_extension:function(e8){var e7,T;e7=e8.substring(0,3);if(e7==="rtf"||e7==="odt"){T="doc"}else{if(e7==="pps"){T="ppt"}else{T=e7}}return T},_file_view_mode_is_browse:function(){var T;return T=this.file_view_mode,bE.call(aQ.FileViewModeCategories.BROWSE_FILE_VIEW_MODE_TYPES,T)>=0},_file_view_mode_is_shared_or_member_link:function(){var e7,e8,T;e7=aQ.FileViewModeCategories;return(e8=this.file_view_mode,bE.call(e7.SHARED_LINK_FILE_VIEW_MODE_TYPES,e8)>=0)||(T=this.file_view_mode,bE.call(e7.MEMBER_LINK_FILE_VIEW_MODE_TYPES,T)>=0)},show:function(e9,T,e8,e7){this._file_view_attempts=0;this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(fa,e7,e9,e8){var fb,T;if(e9==null){e9={}}e9=br.defaults(e9,{files:[],force_file_unlocked:true,file_view_mode:aQ.FileViewModeType.UNKNOWN,should_focus_comment_input:false,hide_comments:false});if(this._is_browse_drag_enabled==null){this._is_browse_drag_enabled=by.proxy((function(){return !this.shown()}),this)}T=by("#file-viewer");if(this.hiding){T.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{T.hide()}}fb=T.find(".file-viewer-comment-container");if(e9.hide_comments){fb.hide()}else{fb.show()}this.file=fa;this.active_user=e7;this.flippable_files=this._filterFlippableFiles(e9.files);this.file_view_mode=e9.file_view_mode;this.should_focus_comment_input=e9.should_focus_comment_input;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{y.scroll_lock_document();T.css("pointer-events","").fadeIn(this._FADE_MSEC);return this.load(this.file,e9.force_file_unlocked,e8)}},load:function(e8,fa,e7){var T,e9;if(fa==null){fa=false}this.file=e8;document.title=this.file.filename;T=by("#file-viewer");if(T.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(fa){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}this._render_viewer();e9=this.modal_type===this._MODAL_FILEINFO;return by("#file-viewer").trigger("db:filepreview:open",[this.file,this.file_view_mode,this.active_user.id,this.should_focus_comment_input,e9,e7])},_filterFlippableFiles:function(e7){var T;return(function(){var fa,e9,e8;e8=[];for(fa=0,e9=e7.length;fa<e9;fa++){T=e7[fa];if(dW.isFlippable(T.preview_type)){e8.push(T)}}return e8})()},currentFlippableFileIndex:function(){var e8,e7,fa,T,e9;e9=this.flippable_files;for(e7=fa=0,T=e9.length;fa<T;e7=++fa){e8=e9[e7];if(this.file.sjid===e8.sjid){return e7}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var e9,e8,fc,T,fd,fa,e7,fb;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;e9=0;T=this.active_user.id;fc=this.file.fq_path;e8=1000;fb=(function(fe){return function(){e9++;if(e9<fe.MAX_CHECK_LOCK_TRIES){if(e9===2){INLINE_JS.Notify.warning(er("Office Online is saving your file."))}else{if(e9===5){INLINE_JS.Notify.warning(er("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}fe.check_lock_timeout=setTimeout(fd,e8);return e8=e8*2}else{clearTimeout(fe.check_lock_timeout);fe.check_lock_request=null;fe.file_locked=false;return fe._render_preview(true,true)}}})(this);e7=(function(fe){return function(ff){ff=JSON.parse(ff);if(ff!=null?ff.has_lock:void 0){return fb()}else{fe.check_lock_request=null;fe.file_locked=false;return fe._render_preview(true,true)}}})(this);fa=function(fg,fe,ff){return fb()};fd=(function(fe){return function(){return fe.check_lock_request=cv.WebRequest({url:"/ow/msft/check_lock",data:{user_id:T,fq_path:fc},success:e7,error:fa})}})(this);return fd()},shown:function(){return by("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(T){return function(){return T.set_preview_url()}})(this),250)},set_preview_url:function(){var e8,e7,T;e8=C.parse(eu.get_url());e7=e8.getPath();T=e8.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eu.push_state(C.encode_parts(e7),T,{immediatelyRestoreState:false})},unset_preview_url:function(){var e8,e7,T;this.clear_preview_url_timer();e8=C.parse(eu.get_url());if(!this._file_view_mode_is_shared_or_member_link()&&(e8.getPath().match(/^\/s[h]?\/.+/)||!this._file_view_mode_is_browse())){return}if(!("preview" in e8.getQuery())){return}e7=e8.getPath();T=e8.removeQuery("select").removeQuery("preview").getQuery();return eu.push_state(C.encode_parts(e7),T)},render_file_failed:function(){var T,e7;e7=this.file;T=this.active_user;this._teardown_and_hide();e7.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(e7,T,{files:this.flippable_files,force_file_unlocked:!this.file_locked,file_view_mode:this.file_view_mode,should_focus_comment_input:this.should_focus_comment_input});by("#file-viewer").show();return by("#file-viewer").trigger("preview_failed")},_log_view:function(T,e7,e9){var e8;if(e9==null){e9=aQ.FileViewModeType.FILE_PREVIEW}this._file_view_attempts++;e8={user_id:this.active_user.id,context:aQ.FileViewContextType.PRIVATE,platform:aQ.FileViewPlatformType.WEB,ns_id:this.file.ns_id,sjid:this.file.sjid,ns_path:this.file.ns_path,shared_link_url:null,extra:{mode:e9,file_ext:au.file_extension_for_logging(this.file.filename),file_bytes:this.file.bytes,file_mtime:this.file.ts,preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:T,in_progress:e7,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,file_view_attempts:this._file_view_attempts}};return a5.FileViewLogger.log(e8)},preload_office_static:function(e7){var e9,e8,T;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}e8=this._get_extension(e7);if(e8 in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){e9=by("#file-viewer .open-with-static-content-container");T=by("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[e8]});return e9.html(T)}},unload_office_static:function(){var T;T=by("#file-viewer .open-with-static-content-container");return T.empty()},_render_viewer:function(){var fe,e7,fh,fi,e9,fk,T,fj,fg,fl,fd,e8,fa,ff,fc,fb;e7=by("#file-viewer");fe=e7.find(".download-button");fi=C.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);ff=(function(fm){return function(ft){var fp,fr,fo,fq,fs,fn;if(ft==null){ft=true}fo=bO.em_snippet(fm.file.filename,35);fp=e7.find(".title-bar .filename");fs={"class":"icon",alt:fm.file.caption};fq=cp.html("web",fm.file.icon,fs).toHTML();fr=by("<span />",{"class":"filename-text"}).text(fo);fp.html(fq).append(fr);e7.addClass("has-preview");if(fm.file.htmlified_link){e7.addClass("htmlified-preview")}else{if(fm.file.preview_type==="excel"){e7.addClass("html-preview");e7.find(".loading").css("z-index","-1")}else{e7.addClass(""+fm.file.preview_type+"-preview")}}if(ft){e7.find(".loading").show()}fe.on("click",function(fu){fu.preventDefault();return window.location.href=fi});if(fm.file.tkey===void 0&&k.active_user.is_email_verified){fn=function(fu){this.file.tkey=fu.tkey;return this._update_title_bar_buttons()};cv.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fm.file.fq_path},dataType:"json",subject_user:fm.active_user.id,success:fn.bind(fm)})}else{fm._update_title_bar_buttons()}fm.modal_type=fm._MODAL_PREVIEW;fm._first_render_completed=false;return fm._listen()}})(this);fk=(function(fm){return function(){e7.removeClass();e7.find(".loading").hide();return fm._unlisten()}})(this);fa=(function(fm){return function(fn,fs,fq,fp,fo){var fr;if(fn==null){fn=false}if(fs==null){fs=true}if(fq==null){fq=false}if(fp==null){fp=false}if(fo==null){fo=true}fm._log_view(Date.now()-fm._start_time,fp,aQ.FileViewModeType.FILE_PREVIEW);fr=fm._get_extension(fm.file.filename);if(fr==="doc"||fr==="docx"||fr==="odt"||fr==="ppt"||fr==="pptx"||fr==="xls"||fr==="xlsx"||fr==="pdf"||fr==="eps"||fr==="ai"||fr==="psd"||fr==="svg"||fr==="txt"||fr==="rtf"||fr==="pspimage"||fr==="tif"||fr==="tiff"||fr==="yuv"||fr==="url"||fr==="webloc"||fr==="website"){fm.globalPreviewStateModel.set({state:"open",file_obj:fm.file})}if(!fn){ff(fs);fm._update_title_bar_buttons()}fm._render_preview(fq,fo);return fm._initial_resize()}})(this);e8=(function(fm){return function(fo){var fn,fq,fr,fp;if(fo==null){fo=false}fn=fm.file.filename.indexOf(".");fq=fm.file.filename.substring(fn+1);if(fq==="key"&&fm.file.preview_type===null){fp="/static/images/icons128/"+(au.file_icon("_other"))+".png"}else{fp="/static/images/icons128/"+(au.file_icon(fm.file.filename))+".png"}fm.globalPreviewStateModel.set({state:"closed",file_obj:null});fr=bO.em_snippet(fm.file.filename,20);e7.find(".title-bar .filename").text(fr);e7.addClass("no-preview");e7.find(".file-thumbnail img").attr({src:fp});e7.find(".file-type").text(fr);e7.find(".file-size").text(fm.file.size);e7.find(".file-modified").text(fm.file.ago||"");fe.on("click",function(){return bV.unsafeRedirect(fi)});fm.modal_type=fm._MODAL_FILEINFO;fm._listen();fm._log_view(Date.now()-fm._start_time,fo,aQ.FileViewModeType.FILE_INFO);fm._update_title_bar_buttons();return fm._initial_resize()}})(this);e9=this._get_extension(this.file.filename);fl=((fb=this.file.preview_type)==="doc"||fb==="excel"||fb==="keynote"||fb==="adobecs"||fb==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||au.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!bV.msie_version_at_most(9);fd=this._is_saveas_experiment_enabled()&&au.file_extension(this.file.filename).toLowerCase()!=="pdf";this.has_preview=dW.isFlippable(this.file.preview_type)||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||((fl&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE)&&(!this.file_locked&&!fd));T=fl&&this._preview_progressive_try(e9)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||T){return fa(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fj=this.file_locked||(fl&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fj){return e8()}ff();fg=C({path:"/doc_preview_status"+this.file.fq_path}).toString();fc=Date.now();return(fh=(function(fm){return function(){var fn;fn=Date.now();if(fn-fc>=5000){setTimeout(by.proxy(fm.render_file_failed,fm),0);return}return fm.preview_status_request=by.ajax(fg,{success:function(fo){if(fm.file){return fm.file.doc_preview_status=parseInt(fo,10)}},complete:function(fo,fp){if(fp==="abort"){return}if(fm.file_locked){return}if(fm.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fm.has_preview=true;return fa(true,false,true,true)}else{if(fm.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fm.preview_status_timeout_obj=setTimeout(fh,1000)}else{fm.render_file_failed()}}},timeout:5000-(fn-fc),subject_user:fm.active_user})}})(this))()},switch_preview:function(e7,e9,fb){var fa,e8,T;if(e7!=null){if(this.file!=null){this.annotation_enabled_for_this_revision=e9;this.file.href=e7;e8=by("#file-viewer .preview-content-container");T="";e8.html(T);this._render_preview(false,true);fa=e8.find("iframe");if(fa.length>0){return fa.on("load",fb)}}}},_remove_loading:function(T){var e7;if(T==null){T=true}e7=by("#file-viewer .loading");e7.hide();e7.css("z-index","");return this.is_loaded=T},_render_blank:function(){var e7,T;e7=by("#file-viewer .preview-content-container");T=ds.createElement(D,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return ds.render(T,e7.get(0))},_render_linkfile:function(){var e7,T;e7=by("#file-viewer .preview-content-container");T=ds.createElement(O,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return ds.render(T,e7.get(0))},_update_title_bar_buttons:function(){var e9,e8,ff,fp,fl,fe,ft,fg,fh,fc,fa,T,fn,fd,fb,fr,fs,fk,fo,fq,fu,fj,fm,fi,e7;fe=by("#file-viewer");fl=fe.find(".share-button");if(this._file_view_mode_is_shared_or_member_link()){fl.remove()}e9=fe.find(".download-button");e8=fe.find(".split-button.openwith");fp=e8!=null?e8.find(".main-button"):void 0;ff=e8!=null?e8.find(".more-button"):void 0;ft=er("Open",{comment:"Open a file natively on the user's computer"});fm=function(){return fe.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};fj=(function(fv){return function(fx){var fy,fw;return fe.data("is-openwith-allowed")==="True"&&((fy=__CONDITIONAL_JS__.OpenWith)!=null?fy.get_open_handler_for(fx,fv.active_user):void 0)&&fx.bytes<((fw=__CONDITIONAL_JS__.OpenWith)!=null?fw.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fx.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fr=(function(fv){return function(fw){return __CONDITIONAL_JS__.UnityFeatures.open_file(fv.file.ns_id,fv.file.ns_path,fv.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fx){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)},fw)}})(this);fd=function(){return fr(false)};fb=function(){return fr(true)};fs=(function(fv){return function(){var fx,fw,fy;fx=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fv.file,fv.active_user);if(fx){if((fy=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fy.log_open_button_pressed(fv.active_user.id,au.file_extension(fv.file.filename).toLowerCase(),fv.file.ns_id,fv.file.ns_path)}fw=fx.uri+"?hpt_click_ts="+Date.now();return bV.redirect(fw)}}})(this);fu=(function(fv){return function(fD,fE,fw){var fA,fz,fF,fy,fx,fH,fB,fC,fG;fG=[];fB=fE!=null;if(fB&&(fE.can_open_directly||(fE.can_open_directly==null))){fA=fE.open_application_name||er("Open");fC=er("Desktop");if(__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fC=er("Open in %(app_name)s").format({app_name:fA})}fG.push({id:"ow_desktop",label:fC,icon:"ow_desktop",callback:fd})}if(fD){fH=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fv.file,fv.active_user);fG.push({id:"ow_web",label:fH.name,icon:fH.icon,callback:fs})}if(fB&&__CONDITIONAL_JS__.UnityFeatures.client_supports_open_in_file_browser()){fx=fE.file_browser_display_name||er("File Browser");fC=er("Show in %(file_browser)s").format({file_browser:fx});if(fB&&!fE.can_open_directly&&!fD){ft=fC}fG.push({id:"ow_folder",label:fC,icon:"ow_folder",callback:fb})}fk(ft,fG);if(!fD&&!fB){fF=false}else{if(fB){fF=false}else{fF=true}}if(!fF&&!fw){fv._hide_more_button()}else{fv._show_more_button(fw,fF)}fz=function(fI,fK,fL,fJ){if(fv._open_button_update_state_timeout){clearTimeout(fv._open_button_update_state_timeout)}return fv._open_button_update_state_timeout=setTimeout((function(){fv.globalOpenWithWebButtonStateModel.set({user_id:fI,state:fK,file_extension:fL,target_button:fJ});return fv._open_button_update_state_timeout=null}),200)};if(fD){fy=au.file_extension(fv.file.filename).toLowerCase();if(fB){return fz(fv.active_user.id,"visible",fy,ff)}else{return fz(fv.active_user.id,"visible",fy,fp)}}else{return fz(null,"hidden",null,null)}}})(this);fo=function(fv){if(e8!=null){e8.toggleClass("shown",fv)}return e9.toggle(!fv)};fk=function(fw,fv){if(!(fv instanceof Array)){fv=[fv]}if(fv.length===0){return fo(false)}else{if(fv.length===1){return fc(fw,fv[0].callback)}else{return fa(fw,fv)}}};fc=function(fv,fw){if((e8==null)&&(fp==null)){return}fo(true);e8.removeClass("split");fp.text(fv);return fp.off("click").on("click",fw)};fa=function(fz,fv){var fy,fx,fB,fA,fw;if((e8==null)&&(fp==null)&&(ff==null)){return}fo(true);e8.addClass("split");fp.text(fz);fy=fe.find(".openwith-dropdown");fp.off("click").on("click",function(fC){return fv[0].callback(fC)});ff.off("click").on("click",function(fD){var fC;fC=by(this).parent().siblings(".openwith-dropdown");if(fC.is(":visible")){return}fC.removeAttr("style");eJ.show(fC,this,null,true);return fD.stopPropagation()});fy.find("li").hide();fB=function(fC){var fD;fD=fy.find("."+fC.id);fD.find("a .sprite-text-inner").text(fC.label);cp.src(fD.find("a .sprite")[0],"web",fC.icon);fD.find("a").off("click").on("click",function(fE){fE.preventDefault();return fC.callback(fE)});return fD.show()};for(fA=0,fw=fv.length;fA<fw;fA++){fx=fv[fA];fB(fx)}return by("#file-viewer-container").off("click",eJ.hide_all).on("click",eJ.hide_all)};fq=!!fm();fg=!!fj(this.file);fh=!!this.file.tkey;fu(fg,null,fh);if(fq){T=function(fv){var fw;fw=function(fx){fv.file_browser_display_name=fx;return fu(fg,fv,fh)};return __CONDITIONAL_JS__.UnityFeatures.file_browser_display_name(fw,fw)};if((fi=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?fi.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return T((e7=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e7.get(this.file.ns_id,this.file.ns_path):void 0)}else{fn=function(fv){if(fv.is_locally_available){return T(fv)}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fn)}}},_show_more_button:function(fc,e7){var fa,fb,e8,e9,T;T=by("#file-viewer");fa=T.find(".more-options-button");fa.show();e8=T.find(".more-options-dropdown");fa.on("click",function(fd){if(e8.is(":visible")){return}eJ.show(e8,fa,null,true);return fd.stopPropagation()});by("#file-viewer-container").on("click",eJ.hide_all);e9=e8.find(".remove-link");e9.off("click");if(fc){e9.show();e9.on("click",(function(fd){return function(fe){eJ.hide_all();return af.confirm_remove(fd.file.filename,fd.file.tkey,0,0,0,fd.file.user_id)}})(this))}else{e9.hide()}fb=e8.find(".download-button");return fb.toggle(e7)},_hide_more_button:function(){var e7,T;T=by("#file-viewer");e7=T.find(".more-options-button");e7.off("click").hide();by("#file-viewer-container").off("click",eJ.hide_all);return T.find(".remove-link").off("click")},_initial_resize:function(){var T;if(this.is_loaded){return}T=function(){return by("window").trigger("resize")};return setTimeout(T,0)},_is_pptx_slim_enabled:function(){return at.getGandalfRule("docpreview-pptx-slim")},_get_progressive_url:function(fa,e9){var fb,T,e8,e7;e7=this.active_user;fa=this._get_preview_type_from_extension(fa);e8=C.parse(e9);T=false;if((fa==="doc"&&e7.progressive_previews_doc)||(fa==="key")||(fa==="keynote")||(fa==="adobecs")){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){e8=e8.updateQuery({post_message_on_failure:1})}}else{if(fa==="ppt"&&e7.progressive_previews_ppt&&!this._is_pptx_slim_enabled()){fb="private_progressive_viewer";T=true}else{if(fa==="xls"&&e7.progressive_previews_xls){if(e7.xls_edit){fb="xls/edit"}else{fb="xls/preview"}}}}if(fb){if(T){e8.setAuthority(Constants.WEBSERVER)}else{e8.setAuthority(e8.getAuthority().replace("dl-web","dl-doc"))}e8.setPath(e8.getPath().replace("/pri/get/","/get/"));e8.setPath(e8.getPath().replace("/get/","/"+fb+"/"))}e8=e8.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0,saveas:this._is_saveas_experiment_enabled()?1:0});return e8},_get_pdf_js_url:function(T){if(Constants.PDF_PREVIEW_MODE==="pdf-js"){T=C.parse(Constants.static_url_pdfjs_viewer)}return T},_preview_is_progressive:function(e7){var T;e7=this._get_preview_type_from_extension(e7);T=this.active_user;return(e7==="doc"&&T.progressive_previews_doc)||(e7==="ppt"&&T.progressive_previews_ppt)||(e7==="xls"&&T.progressive_previews_xls)||(e7==="key"||e7==="keynote")||(e7==="eps"||e7==="ai")},_preview_progressive_try:function(e7){var e8,T;if(!this._preview_is_progressive(e7)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}e7=this._get_preview_type_from_extension(e7);e8=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&((e7==="ppt"&&this.active_user.progressive_previews_ppt_try_failed)||(e7==="doc"&&this.active_user.progressive_previews_doc_try_failed)||(e7==="xls"&&this.active_user.progressive_previews_xls_try_failed)||(e7==="eps"||e7==="ai"));T=e7==="key"||e7==="keynote";return e8||T||this._is_saveas_experiment_enabled()},_set_previews_sandbox_params:function(e7,T){e7=this._get_preview_type_from_extension(e7);if(e7!=="xls"){return""}else{return null}},_prepare_annotation_url:function(T){if(this._is_annotation_marker_enabled()){T=T.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){T=T.updateQuery("annotation_highlight","1")}if(this._is_annotation_region_enabled()){T=T.updateQuery("annotation_region","1")}return T},_render_preview:function(fn,fl){var e7,fc,fm,fi,e8,fo,fe,fk,fd,fp,fr,fj,T,fh,fg,fb,e9,fq,ff,fa;if(fn==null){fn=false}if(fl==null){fl=true}if(fn){this._remove_loading(false)}fj=by("#file-viewer .preview-content-container");if(fj.find("iframe").length>0){return}if(this.file.htmlified_link){fe=by("<iframe/>",{src:this.file.htmlified_link});fj.append(fe);return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){fc=this._get_extension(this.file.filename);fb=this._get_progressive_url(fc,this.file.href);fc=this._get_preview_type_from_extension(fc);if(fc==="ppt"&&!this._is_pptx_slim_enabled()){fe=by("<iframe/>",{src:fb.toString(),allowfullscreen:"",type:"application/pdf"});fj.append(fe)}else{if(this.active_user.inline_commenting){by("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});fb.setAuthority(fb.getAuthority().replace("dl-web","dl-doc"));fb.setPath(fb.getPath().replace("/get/","/dochax_private_commentless_preview/"));fi=fb.toString();fb=C.parse(Constants.static_url_pdfjs_hack_viewer);fb.setQuery({file:fi})}else{if(!fl){fb=fb.updateQuery({generate_preview:1});fb.setAuthority(fb.getAuthority().replace("dl-web","dl-doc"))}fp=fc==="ppt"&&this._is_pptx_slim_enabled();this._pdfLoader.openFile(fb,{presentationMode:fp});fb=this._get_pdf_js_url()}fb=fb.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fb=this._prepare_annotation_url(fb);fe=by("<iframe/>",{src:String(fb),type:"application/pdf"});fe.addClass("pdfjs");fj.append(fe)}return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){fe=by("<iframe/>",{src:this.file.href,sandbox:""});fj.append(fe);return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){fb=this._get_progressive_url("xls",this.file.href);fe=by("<iframe/>",{src:fb,type:"application/pdf"});this._set_previews_sandbox_params("xls",fe);fj.append(fe);return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="keynote"){fb=this._get_progressive_url("html",this.file.href);fb=fb.updateQuery({generate_preview:1});fb=fb.updateQuery({post_message_on_failure:1});fe=by("<iframe/>",{src:fb,type:"text/html"});fj.append(fe);return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="adobecs"){fb=this._get_progressive_url("adobecs",this.file.href);fb=fb.updateQuery({generate_preview:1});this._pdfLoader.openFile(fb);fb=this._get_pdf_js_url();fb=fb.updateQuery(Constants.UID_PARAM_NAME,this.active_user);fb=this._prepare_annotation_url(fb);fe=by("<iframe/>",{src:String(fb),type:"application/pdf"});fe.addClass("pdfjs");fj.append(fe);return fe.on("load",this._remove_loading)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{e7=this.currentFlippableFileIndex();fm=this._get_extension(this.file.filename);if(dW.isFlippable(this.file.preview_type)){by("#file-viewer .loading").css("z-index","1");if(this.file.preview_type==="video"){fh=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?bn.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;fg=this.file.thumbnail_url_tmpl}else{if(this.file.preview_type==="photo"&&!(fm==="gif"&&this.file.bytes>Constants.MAX_GIF_FILE_SIZE_B)){if(fm==="gif"){fg=this.file.href}else{fg=this.file.thumbnail_url_tmpl}fk=[];ff=[1,2,3,4,5,6,-1,-2];for(e9=0,fq=ff.length;e9<fq;e9++){fo=ff[e9];fd=e7+fo;if(0<=fd&&fd<this.flippable_files.length){fk.push(this.flippable_files[fd].thumbnail_url_tmpl)}}}}e8={"preview-type":this.file.preview_type,"preview-url":fh,"thumbnail-url-tmpl":fg,"file-extension":fm,"file-meta":{filename:this.file.filename,mtime:this.file.ts,formattedSize:this.file.size},imagesToPreload:fk,index:e7,count:this.flippable_files.length,onPrevious:(function(fs){return function(){return fs.loadPreviousFlippable()}})(this),onNext:(function(fs){return function(){return fs.loadNextFlippable()}})(this),onLoad:(function(fs){return function(){fs._remove_loading()}})(this),onError:(function(fs){return function(){fs._remove_loading()}})(this)};if((fa=this._preview_flippable_component)!=null?fa.isMounted():void 0){fr=this._preview_flippable_component.props;return this._preview_flippable_component.setProps(e8)}else{T=ds.createElement(dW,e8);return this._preview_flippable_component=ds.render(T,fj.get(0))}}else{return this._render_blank()}}}}}}}}},post_preview_message:function(fe){var fd,fa,fb,ff,e7,T,e9,fc,e8;fb=by("#file-viewer .preview-content-container iframe");e8=[];for(e9=0,fc=fb.length;e9<fc;e9++){fa=fb[e9];T=fa.src;e7="://";ff=T.indexOf(e7);if(ff===-1){fd=T.indexOf("/")}else{fd=T.indexOf("/",ff+e7.length)}if(fd!==-1){T=T.substring(0,fd)}e8.push(fa.contentWindow.postMessage(fe,T))}return e8},notify_preview_sfj:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}return k.post_preview_message('{"action":"notify_sfj"}')},loadPreviousFlippable:function(){if(dW.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();return by("#file-viewer").trigger("db:filepreview:prev",[this.file,this.file_view_mode,this.active_user.id])}},loadNextFlippable:function(){if(dW.isFlippable(this.file.preview_type)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();return by("#file-viewer").trigger("db:filepreview:next",[this.file,this.file_view_mode,this.active_user.id])}},_listen:function(){var e7,T,e8;e7=by("#file-viewer");this._pdfLoader.startListening();cE.addFileDragEnabledCheck(this._is_browse_drag_enabled);e7.find(".js-close-button").on("click",by.proxy(this._on_close,this));if(this._file_view_mode_is_browse()){this.sfj_callback_handle=cl.add_subscribe_sfj_callback(k.notify_preview_sfj.bind(this))}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(e9){return function(fa){if(e9.is_rams_fullscreen_active()){return}return e9._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(e9){return function(fa){return e9.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(e9){return function(fa){return e9.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){e7.find(".share-button").on("click",by.proxy(this._share,this));e8=(function(e9){return function(fa){if(e9.file.fq_path.toLowerCase()===fa.memo.fq_path.toLowerCase()){e9.file.tkey=fa.memo.tkey;return e9._update_title_bar_buttons()}}})(this);T=(function(e9){return function(fa){if(e9.file.tkey===fa.memo.token){e9.file.tkey=null;return e9._update_title_bar_buttons()}}})(this);this.share_link_callback=e8.bind(this);this.remove_link_callback=T.bind(this);document.observe(aB.LINKS_ADD,this.share_link_callback);document.observe(aB.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){e7.find(".share-button").on("click",by.proxy(this._share,this))}}by(window).on("resize",by.proxy(this._resize,this));this.handleMessageFromChild=function(e9){switch(e9.action){case"failed":return k.render_file_failed();case"lock_preview":return k.preview_locked=true;case"unlock_preview":return k.preview_locked=false;case"toggle_preview_lock":return k.preview_locked=!k.preview_locked;case"hide_iframe":return k._teardown_and_hide();case"loaded":return k.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return k._handle_page_rendered(e9.parameters)}};this._frameMessenger=new em();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",by.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(e9){if(k.preview_locked){return""}else{return void 0}}},_unlisten:function(){var T;T=by("#file-viewer");this._pdfLoader.stopListening();T.off("click",by.proxy(this._teardown_and_hide,this));cE.removeFileDragEnabledCheck(this._is_browse_drag_enabled);T.find("#file-viewer-container").off("click",function(e7){return e7.stopPropagation()});T.find(".js-close-button").off("click",by.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){T.find(".share-button").off("click",by.proxy(this._share,this));T.find(".download-button").off("click");by(document).off("click",eJ.hide_all);document.stopObserving(aB.LINKS_ADD,this.share_link_callback);document.stopObserving(aB.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){T.find(".share-button").off("click",by.proxy(this._share,this))}}by(window).off("resize",by.proxy(this._resize,this));key.setScope(this.prev_scope);if(this._file_view_mode_is_browse()){cl.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(e8){var e7,T;if(!this._is_rams_ui()){e7=by("#file-viewer");T=e7.find("#file-viewer-container").height()-(e7.find(".title-bar").height()+1);e7.find(".preview").height(T);return e7.trigger("height-resize",{height:T})}},_share:function(T){a5.ShmodelUILogger.log("via-browse-file-viewer");T.preventDefault();return new c8(this.active_user.id,this.file.fq_path,"file_viewer").show()},_on_close:function(T){T.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var T;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this._file_view_mode_is_browse()){eM.set_selected_files(this.file)}if(this._file_view_mode_is_browse()||this._file_view_mode_is_shared_or_member_link()){k.unset_preview_url()}y.scroll_unlock_document();T=by("#file-viewer");return T.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(e7){return function(){var fa,e9,e8;if(e7.is_rams_fullscreen_active()){e7.exit_rams_fullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){e8=er("Download");fa=T.find(".download-button");fa.text(e8);fa.off("click")}e7._hide_more_button();T.removeClass("has-preview").removeClass("no-preview");e9=T.find(".preview-content-container");ds.unmountComponentAtNode(e9.get(0));e7._preview_flippable_component=null;e9.empty();T.find(".file-thumbnail img").attr({src:""});T.find(".title-bar .filename").text("");T.attr({"class":""});e7._unlisten();e7._remove_loading();document.title=e7._cached_browser_window_title;e7._cached_browser_window_title=null;e7.last_file=e7.file;e7.file=null;e7.preview_locked=false;window.removeEventListener("message",e7.preview_lock_listener);e7.is_loaded=false;e7.hiding=false;e7.cancel_check_lock();T.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(T){var e7,fc,ff,fd,fa,fb,e8,fe,e9;if(!this._first_render_completed){e7=au.file_extension_for_logging(this.file.filename);fb=T.stats;fd=((e9=this.file)!=null?e9.bytes:void 0)!=null?this.file.bytes:0;fc=by.extend(T.attributes,{total_time:Date.now()-this._start_time,file_ext:e7,source:"file-viewer",originalSize:fd,docPreviewStatus:this.file.doc_preview_status});for(e8=0,fe=fb.length;e8<fe;e8++){fa=fb[e8];ff=(function(){switch(fa.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();fc[ff]=fa.end-fa.start}a5.UserActivityLogger.log("web","file_view_first_page_rendered",fc);a5.PreviewActivityLogger.log("file_view_first_page_rendered",{file_ext:e7,extra:JSON.stringify(fc)});return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},nativePdfPrint:function(){var e7,e9,T,e8;if(this.file.doc_preview_status!==Constants.DOC_PREVIEW_AVAILABLE||((e8=this.file.preview_type)!=="doc"&&e8!=="ppt"&&e8!=="adobecs")){return false}T=this._get_progressive_url("doc",this.file.href);e7=C.parse(T).getAuthority();e9=bP.getNativePrintUrl(T,e7,by("#file-viewer"));if(e9==null){return false}window.open(e9,"_blank");return true},_is_annotation_marker_enabled:function(){return by("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return by("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_region_enabled:function(){return by("#file-viewer").attr("data-docpreview-annotation-region-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_saveas_experiment_enabled:function(){return by("#file-viewer").attr("data-docpreview-saveas-experiment")==="True"},_is_rams_ui:function(){return by("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"},enter_rams_fullscreen:function(){var T;bP.enter_rams_fullscreen(by(".preview"));T=by("html");this._non_fullscreen_vert_overflow=T.css("overflow-y");return T.css("overflow-y","hidden")},exit_rams_fullscreen:function(){bP.exit_rams_fullscreen(by(".preview"));by("html").css("overflow-y",this._non_fullscreen_vert_overflow);return this._non_fullscreen_vert_overflow=null},is_rams_fullscreen_active:function(){return bP.is_rams_fullscreen_active(by(".preview"))}};var dR;dR=A.Index2={init:function(fe,fa){var fc,ff,e7,fg,fb,T,e9,e8,fd;if(fa){by("#sign-in").on("click",function(fm){var fh,fk,fj,fi,fl;fm.preventDefault();fj=by("#sign-in-form");eY.show(er("Sign in"),fj[0],false,false,416,false,"sign-in-modal");fk=fj.find("#login_email");fk.focus();return new b0(fh=fk,fl=function(){fj.find("#password-field").hide();fj.find("#remember-me").hide();fj.find("#login_submit").val(er("Continue"));fj.find("#forgot_password_link").hide();return fj.find("#sso_description_footer").show()},fi=function(){fj.find("#password-field").show();fj.find("#remember-me").show();fj.find("#login_submit").val(er("Sign in"));fj.find("#forgot_password_link").show();return fj.find("#sso_description_footer").hide()})})}fc=function(){if(!by("#signup-container").hasClass("form_shown")){return by.when(by("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){by("#signup-container").addClass("form_shown");return by("#signup-container .text-input input:visible").first().focus()})}};if(!fe){by(".register").find(".login-button").on("click",function(fh){if(!by("#signup-container").hasClass("form_shown")){fh.preventDefault();return fc()}});dR.animate()}else{by(".photo").show()}ff=function(){if(!by("#signup-container").hasClass("form_shown")){return by(".register").find(".login-button").trigger("click")}};by(".buttons .freshbutton-blue").on("click",function(fh){fh.preventDefault();by("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:ff});return false});by("#learn-more").on("click",function(fh){fh.preventDefault();by("html, body").animate({scrollTop:by("#divider").offset().top},{queue:false,duration:500});return false});if(bq.are_enabled()){a5.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{aa.error(er("Please enable browser-cookies to use the Dropbox website."))}T=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];e9=function(fh){return by(fh).on("click",function(){return a5.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fh})})};for(e8=0,fd=T.length;e8<fd;e8++){e7=T[e8];e9(e7)}fb=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];fg={};return by(window).scroll(function(){var fn,fo,fm,fk,fj,fl,fi,fh;fh=[];for(fl=0,fi=fb.length;fl<fi;fl++){fm=fb[fl];if(by(fm).length&&!fg[fm]){fo=by(window).scrollTop();fn=fo+by(window).outerHeight();fj=by(fm).offset().top;fk=fj+by(fm).outerHeight();if(fk<=fn){a5.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:fm});fh.push(fg[fm]=true)}else{fh.push(void 0)}}else{fh.push(void 0)}}return fh})},_animate_points:function(fc,fd,fe,e7,fg,fb,T){var e9,e8,fa,ff;if(T==null){T=0}T=Math.min(Math.max(T,0),1);fa=fb(T);ff=[(function(){var fj,fi,fh;fh=[];for(e9=fj=0,fi=fd.length;0<=fi?fj<fi:fj>fi;e9=0<=fi?++fj:--fj){fh.push([(function(){var fl,fk;fk=[];for(e8=fl=0;fl<2;e8=++fl){fk.push(fd[e9][e8]+(fe[e9][e8]-fd[e9][e8])*fa)}return fk})()])}return fh})()];fc.attr("points",dR.points_array_to_str(ff));if(T>=1){return fg.resolve()}else{return setTimeout(function(){return dR._animate_points(fc,fd,fe,e7,fg,fb,T+(10/e7))},10)}},animate_points:function(e7,fc,fb,e8,fa,e9){var T;if(e9==null){e9=jQuery.easing.linear}T=by.Deferred();dR._animate_points(e7,fc,fb,e8,T,e9);return T.done(function(){return typeof fa==="function"?fa():void 0}).promise()},animate_hide_rects:function(e7,fb,fd){var T,e8,fc,fa,e9;T=by.Deferred().resolve().promise();fc=function(fe){var fj,fg,fi,ff,fh;ff=by(e7[fe]);fj=dR.points_str_to_array(ff.attr("points"));fh=[fj[1],fj[1],fj[2],fj[2]];fg=dR.inverse(jQuery.easing.linear);fi=fb*(fg((fe+1)/e7.length)-fg(fe/e7.length));return T=T.then(function(){return dR.animate_points(ff,fj,fh,fi)})};for(e8=fa=0,e9=e7.length;0<=e9?fa<e9:fa>e9;e8=0<=e9?++fa:--fa){fc(e8)}return T.done(function(){return typeof fd==="function"?fd():void 0}).promise()},animate_delay:function(e7){var T;T=by.Deferred();setTimeout(T.resolve,e7);return T.promise()},animate:function(){return by.Deferred().resolve().promise().then(function(){return dR.animate_docs()}).then(function(){return dR.animate_graphs()}).then(function(){return dR.animate_photos()})},inverse:function(e7,T){if(T==null){T=0.000001}return function(fb){var e9,fa,e8;fa=0;e9=1;while(e9-fa>T){e8=(fa+e9)/2;if(e7(e8)<fb){fa=e8}else{e9=e8}}return fa}},points_str_to_array:function(fc){var e8,fb,fa,e7,e9,T;e9=fc.split(" ");T=[];for(fa=0,e7=e9.length;fa<e7;fa++){fb=e9[fa];T.push((function(){var fg,fe,fd,ff;fd=fb.split(",");ff=[];for(fg=0,fe=fd.length;fg<fe;fg++){e8=fd[fg];ff.push(parseFloat(e8))}return ff})())}return T},points_array_to_str:function(e7){var T;return((function(){var fa,e9,e8;e8=[];for(fa=0,e9=e7.length;fa<e9;fa++){T=e7[fa];e8.push(T.join(","))}return e8})()).join(" ")},animate_docs:function(){var fc,T,e9,e8,fb,e7,fa;e7=[[5,6],[177,1],[184,157],[13,180]];T="";for(fb=fa=0.475;fa<=0.625;fb=fa+=0.05){fc=fb+0.05;e9=[[e7[0][0]+(e7[3][0]-e7[0][0])*fb,e7[0][1]+(e7[3][1]-e7[0][1])*fb],[e7[1][0]+(e7[2][0]-e7[1][0])*fb,e7[1][1]+(e7[2][1]-e7[1][1])*fb],[e7[1][0]+(e7[2][0]-e7[1][0])*fc,e7[1][1]+(e7[2][1]-e7[1][1])*fc],[e7[0][0]+(e7[3][0]-e7[0][0])*fc,e7[0][1]+(e7[3][1]-e7[0][1])*fc]];e9=dR.points_array_to_str(e9);T+="<polygon points='"+e9+"' style='fill:#f5f9fc;stroke:none;' />"}e8=by('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+T+"\n</svg>");return by.Deferred().resolve().promise().then(function(){by(".doc, .graph, .photo").hide();by(".comp.doc").append(e8);return by(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dR.animate_hide_rects(e8.find("polygon"),2500,function(){return e8.remove()})}).then(function(){return dR.animate_delay(500)}).then(function(){return by(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dR.animate_delay(1500)}).then(function(){return by(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var e7,T;e7=[[83,98],[158,37],[241,77],[171,145]];T=by('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');T.find("polygon").attr("points",dR.points_array_to_str(e7));return by.Deferred().resolve().promise().then(function(){by(".doc, .graph, .photo").hide();by(".tablet.graph .graph-grid").hide();by(".tablet.graph").append(T);return by(".tablet.graph").show("fade",{},500).promise()}).then(function(){var e8;e8=[e7[0],e7[1],e7[1],e7[0]];return dR.animate_points(T.find("polygon"),e7,e8,600,function(){return T.remove()})}).then(function(){if(!bV.msie_version_at_most(8)){return by(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dR.animate_delay(500)}).then(function(){return by(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dR.animate_delay(2000)}).then(function(){return by(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return by.Deferred().resolve().promise().then(function(){by(".doc, .graph, .photo").hide();by(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});by(".phone.photo").show();return by.when((function(){if(!bV.msie_version_at_most(8)){return by(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return by.Deferred().resolve().promise().then(function(){return by(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dR.animate_delay(750)}).then(function(){return by(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var dt,I,dl=function(T,e7){return function(){return T.apply(e7,arguments)}},ap={}.hasOwnProperty,cG=function(e9,e7){for(var T in e7){if(ap.call(e7,T)){e9[T]=e7[T]}}function e8(){this.constructor=e9}e8.prototype=e7.prototype;e9.prototype=new e8();e9.__super__=e7.prototype;return e9};I=INLINE_JS.UserNotifier=A.UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var e7,e8,T;this.refresh_feed();by("#event-feed-container").scroll(function(){if(I._has_more){if(I._scroller_within_offset_to_bottom(I.SCROLLING_OFFSET)){return I._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));by("#event-feed").on("click",this._mouseclick.bind(this));T=[];for(e8 in d0){e7=d0[e8];T.push(this._subscribe_user(e7))}return T},refresh_feed:function(T,e7){var e9,fa,e8;e8=(function(fb){return function(fd){var fg,fe,ff,fc;fb._unread_count=fd.unread_count;fb._notifications=fd.notifications;if(fd.meta_notification){fe=fd.meta_notification;ff=fb._identifier(fe);if(ff!==fb._get_last_acked_meta_not_id()){fb._unread_count++}fb._current_meta_not_id=ff;fb._notifications.push(fe)}fb._has_acked=false;fb._notifications.sort(fb._sort_key);fb._append_event_rows(true);fb.update_jewel_ui(fb._unread_count);if((T!=null)&&(e7!=null)){fc=T.get_user_id();fg=fd.latest_nid[fc];T.handler_success(e7,{nid:fd.latest_nid[fc]})}if(bT){return bT.refresh_inbox_counts()}}})(this);fa=(function(fb){return function(){return fb._is_retrieving_feed=false}})(this);e9=(function(fb){return function(){var fc;fb._is_retrieving_feed=true;fc={count:fb.MAX_ROWS_TO_RETRIEVE};return new by.ajax("/web/notifications/retrieve",{data:fc,dataType:"json",type:"POST",success:e8,error:function(){if((T!=null)&&(e7!=null)){return T.handler_failure(e7)}},complete:fa})}})(this);return e9()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new by.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(T){return function(e9){var fa,fc,fb,e8,e7;e7=[];for(fb=0,e8=e9.length;fb<e8;fb++){fc=e9[fb];fa=T._identifier(fc);T._acked_ids[fa]=true;e7.push(T._append_event_rows())}return e7}})(this)});return this._has_acked=true}},update_jewel_ui:function(T){by("#new-notification-count").text(T).toggleClass("show",T>0);if(T>0){by(".notifications-bell").addClass("shake")}return setTimeout((function(){return by(".notifications-bell").removeClass("shake")}),500)},scrolling:function(T){var e7;if(T.originalEvent){T=T.originalEvent}e7=T.detail?T.detail*(-40):T.wheelDelta;if(!this._has_more&&e7<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(T)}else{if(e7>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(T)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(T){if(typeof T.preventDefault==="function"){T.preventDefault()}return T.returnValue=false},_subscribe_user:function(T){var e7;return e7=T.subscribe_user({name:"NotificationFeedUpdater",handler:(function(e8){return function(){return e8.refresh_feed(T,e7)}})(this)})},_append_event_rows:function(ff){var T,fj,fm,e8,fh,fd,fg,fe,fc,fi,e7,fa,fl,e9,fk,fb;if(ff==null){ff=false}if(ff){by("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}fi=by(".feed-row").size();fj=[];fb=this._notifications;for(fg=e9=0,fk=fb.length;e9<fk;fg=++e9){fc=fb[fg];if(fi>=this._num_event_rows){break}fh=this._identifier(fc);if(fh in this._shown){continue}this._shown[fh]=true;fa=fc.status;e8=by(fc.notification_div);by("#event-feed").append(e8);fi++;fd=e8.find("img").get(0);if(fd){T=by(fd);fm=T.attr("data-src");if(fm){if(this._thumb_cache[fm]){fe=this._thumb_cache[fm];T.attr("src",fe);if(!fe.endsWith(cp.SPACER)){this._add_thumbnail_frame(T)}}else{if(!(fm in this._thumb_cache)){this._thumb_cache[fm]=false;fl=fc.user_id;T.data("uid",fl);T.data("not-identifier",fh);fj.push($(fd))}}}}if(!e8.hasClass("feed-row")){e8=e8.find(".feed-row")}if(fc.type_id===Constants.NOTIFICATION_TYPE_META){e8.addClass("meta-feed");if((!(fh in this._acked_ids))&&(fh===this._get_last_acked_meta_not_id())){e8.addClass("read")}}if(fa===this.USER_NOTIFICATION_STATUS_INVISIBLE){e8.addClass("invisible");if(fh in this._acked_ids){delete this._acked_ids[fh]}}if(fa===this.USER_NOTIFICATION_STATUS_READ){if(!(fh in this._acked_ids)){e8.addClass("read")}}}e7=(function(fn){return function(fr){var fp,fo,fq;if(!fr.src.endsWith(cp.SPACER)){fp=by(fr);fn._add_thumbnail_frame(fp);fh=fp.data("not-identifier");fq=fp.attr("data-src");fo=fp.attr("src");return fn._thumb_cache[fq]=fo}}})(this);bm.batch_load_thumbs(fj,this.THUMBS_BATCH_SIZE,e7);this._has_more=this._num_event_rows<this._notifications.length;if(by(".feed-row").length===0){return by("#event-feed-container").addClass("empty")}else{return by("#event-feed-container").removeClass("empty")}},_identifier:function(T){return""+T.user_id+" "+T.type_id+" "+T.target_object_key},_sort_key:function(e7,T){if(e7.sticky&&!T.sticky){return -1}if(T.sticky&&!e7.sticky){return 1}if(e7.status===I.USER_NOTIFICATION_STATUS_UNREAD&&T.status!==I.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(T.status===I.USER_NOTIFICATION_STATUS_UNREAD&&e7.status!==I.USER_NOTIFICATION_STATUS_UNREAD){return 1}return T.feed_time-e7.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(T){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,T)}},_add_thumbnail_frame:function(T){by(T).addClass("thumbnail");return by(T).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(e8){var e7,T;e7=by(e8.target);if(e7.is("a")){if(e7.hasClass("view")){e8.preventDefault();T=e7.attr("data-mount");window.open(T)}}if(e7.closest("a").hasClass("meta-notification-sign-in-needed")){e8.preventDefault();return bI.show_page_login_modal((function(e9){return function(){return e9.refresh_feed()}})(this))}},_scroller_within_offset_to_bottom:function(e7){var T;T=$("event-feed-container");return T.scrollTop+T.offsetHeight+e7>=T.scrollHeight}};dt=A.NotificationUIButton=(function(e7){cG(T,e7);T.prototype.selector=function(){return".notification-button"};function T(){this.clear=dl(this.clear,this);this.active=dl(this.active,this);this._clear_sticky_notification_on_popover_close=dl(this._clear_sticky_notification_on_popover_close,this);T.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}T.prototype._clear_sticky_notification_on_popover_close=function(){if(!by(this.selector())[0].hasClassName("active")){return I.clear_cached_client_states()}};T.prototype.active=function(e8,fa){var e9;e9=e8.target.hasClassName("feed-row")?e8.target:$(e8.target).up(".feed-row");if(e9){if(!e9.hasClassName("clickable")){return}}T.__super__.active.call(this,e8,fa);return this._clear_sticky_notification_on_popover_close()};T.prototype.clear=function(e8){T.__super__.clear.call(this,e8);return this._clear_sticky_notification_on_popover_close()};return T})(dN);var bv,cg,eE;eE=A.UnsupportedBrowser={init:function(){return by("#unsupported-browser-dismiss").on("click",function(T){T.preventDefault();eU.hide();return by.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};cg=A.ExpiredCCNotificationBar={init:function(T){return by(".expired-dismiss").on("click",function(e7){e7.preventDefault();eU.hide();return by.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:T}})})}};bv=A.BetaLocaleNotificationBar={init:function(T){return by(".beta-locale-dismiss").on("click",function(e7){e7.preventDefault();eU.hide();return by.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:T}})})}};var c;c=INLINE_JS.viewer=cD.get_viewer();require(["modules/dirty/eventbus_dark_launch"],function(T){return __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch=T});var H,b5,f,e,cH,cB,u,ed;if(!Constants.is_test){by(eG.check_timezone)}if(window._document_observe_listeners){u=window._document_observe_listeners;for(f=0,cH=u.length;f<cH;f++){b5=u[f];if(document.loaded){b5.func()}else{document.observe(b5.event,b5.func)}}}if(window._jquery_ready_handlers){ed=window._jquery_ready_handlers;for(e=0,cB=ed.length;e<cB;e++){H=ed[e];by(H)}}by(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});return A});