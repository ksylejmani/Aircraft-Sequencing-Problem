// Generated by CoffeeScript 1.7.1
define(['jquery', 'modules/clean/ajax', 'modules/clean/base64', 'modules/core/browser', 'modules/core/cookies', 'modules/core/uri'], function($j, ajax, base64, Browser, Cookies, URI) {
  var ThirdPartySignup;
  ThirdPartySignup = (function() {
    function ThirdPartySignup() {}

    ThirdPartySignup.init = function(picture_url, cont, extra_data) {
      return this.handle_picture_url(picture_url, cont, extra_data, true);
    };

    ThirdPartySignup.handle_picture_url = function(picture_url, cont, extra_data, should_redirect) {
      var image_blob, xhr;
      image_blob = null;
      if (picture_url) {
        try {
          xhr = new XMLHttpRequest();
          xhr.open('GET', picture_url, true);
          xhr.responseType = 'blob';
          xhr.onload = function() {
            var content_type;
            if (xhr.status === 200) {
              content_type = xhr.getResponseHeader("content-type") || "";
              image_blob = new Blob([xhr.response], {
                type: content_type
              });
              $j("#profile-picture img").attr("src", URL.createObjectURL(image_blob));
              return $j("#profile-picture").show();
            }
          };
          xhr.send();
        } catch (_error) {}
      }
      return $j(document).on("db:register:success", (function(_this) {
        return function(evt, resp) {
          var finish_signup;
          finish_signup = function() {
            var query, uri;
            if (should_redirect) {
              uri = URI.parse(resp.redirect_url || "/");
              if (cont) {
                uri = URI.parse(cont);
              }
              query = {
                success: true
              };
              if (extra_data) {
                query['extra_data'] = extra_data;
              }
              uri.setQuery(query);
              return Browser.unsafeRedirect(uri);
            }
          };
          if (image_blob != null) {
            return _this.upload_account_photo(resp.id, image_blob, finish_signup);
          } else {
            return finish_signup();
          }
        };
      })(this));
    };

    ThirdPartySignup.upload_account_photo = function(uid, image_blob, callback) {
      var data, url, xhr;
      url = URI({
        authority: Constants.BLOCK_CLUSTER,
        path: "/upload_account_photo",
        query: {
          t: Cookies.read(Constants.JS_CSRF_COOKIE),
          _subject_uid: uid
        }
      });
      data = new FormData();
      data.append("file", image_blob);
      xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.withCredentials = true;
      xhr.onload = function() {
        return callback();
      };
      xhr.onerror = function() {
        return callback();
      };
      return xhr.send(data);
    };

    return ThirdPartySignup;

  })();
  return ThirdPartySignup;
});

//# sourceMappingURL=third_party_signup.map
